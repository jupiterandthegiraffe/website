var Pinegrow=function(){this.supports_key_up=!0;function v(n,e,t,o){crsaGetRelativeDistanceForUrls(e,t,function(e,t){if(e<0){var r="";for(i=e;i<0;i++)r+="../";o&&o(r+n)}else if(0<e){r=t;for(i=0;i<e;i++)r="../"+r;o&&o(r)}else 0==e&&o&&o(t)})}function e(e){var t=!(r=$("#crsa-left-plane")).hasClass("closed"),r=r.find("i.hider");e!=t&&r.trigger("click")}var r={},a={},t=new PgDelayedTasks,c=(this.defaults={formatCss:"default",codeTheme:"Dark",font:"monospace",unsplashAppId:"d3d0ad950808c9d241e097130ea0c4ca0d06ead44e05e8fa39c5054db8dd5bd7",autoprefixer:"> 1%, Last 4 versions, Firefox ESR, Opera 12.1"},[]),u=this,n=(this.projectTemplates=[],this.sourceParser=!0,this.httpServer=null,!1),o=null,s=(this.ready=!1,this.cache_breaker=0,this.autoFormatHtml=!0,this.shouldHighlightElements=!0,this.stats=new PgStats,this.code_editors=new PgCodeEditors,this.insight=new PgInsight,this.event_conductor=new PgEventConductor,this.lock_css_media="(max-width:767px)",this.clipboard=new PgClipboard,this.getClipboard=function(){return this.clipboard},this.showWorkspace=function(e,t){window.pgDontSaveLayoutState=!1,pgCloseAllUIWindows();var r=null,r=(pgUIViewManager.getView("info")&&(r=!pinegrow.isHiddenUIPanel("info")),pinegrow.showUIPanel("info"),myLayout.restoreWorkspace(e),!1===r&&pinegrow.hideUIPanel("info"),"pg_layout_state");r+=pgf.layout_prefix,localStorage[r]="",pinegrow.saveSettingsOnBackend()&&(pinegrow.setSetting(r,""),setTimeout(function(){pinegrow.backend.savePendingUserSettings()},5e3)),pinegrow.dispatchEvent("on_panel_moved_in_another_window",null),setTimeout(function(){window.pgDontSaveLayoutState=!1,pinegrow.selectedElements.reselect(),t&&t()},1e3)},this.isContributorMode=function(){var e=crsaStorage.getValue("activatedProduct");return!!(e&&0<=e.indexOf("CMSUSER"))||"true"==pinegrow.getSetting("contributor-mode","false")},this.saveSettingsOnBackend=function(){if(!pgf.settings_on_backend)return!1;if(!1&&this.currentUser)return this.currentUser.isLoggedInAndActive();if(pgwpdata.user_settings){var e=Object.keys(pgwpdata.user_settings);if(1===e.length&&"dummy"===e[0])return!1}return!0},[]),l=(this.registerTreeView=function(e){s.indexOf(e)<0&&s.push(e)},this.unregisterTreeView=function(e){var t=s.indexOf(e);0<=t&&s.splice(t,1)},this.isOverTreeView=function(e,t){for(var r=0;r<s.length;r++){var n=s[r].isOverTree(e,t);if(n)return n.treeView=s[r],n}return null},this.getTreeViews=function(){return s},this.getTreeViewOfClass=function(e){for(var t=0;t<s.length;t++)if(s[t]instanceof e)return s[t];return null},this.updateStartScreen=function(){pinegrow.tutorialsManager&&pinegrow.tutorialsManager.updateStartScreen(null,!0)},this.openProject=function(e,t,r,n){var i=new CrsaProject;return n=n||{},$.each(n,function(e,t){i[e]=t}),isApp()?(crsaIsFileUrl(e)&&(e=crsaMakeFileFromUrl(e)),i.fromFolder(e,function(e){pinegrow.setCurrentProject(e),e.lesson||pinegrow.recentFiles.add(e.root.path,!0),crsaQuickMessage("Project was loaded."),pinegrow.openProjectPanelIfNoPageOpen(),t&&e.framework&&t.addFramework(e.framework),r&&r(i)},!0)):i.fromServer("project1",function(e){pinegrow.setCurrentProject(e),crsaQuickMessage("Project was loaded."),t&&e.framework&&t.addFramework(e.framework),r&&r(i)}),i},this.getSetting=function(e,t,r){void 0===r&&(r=!0),this.saveSettingsOnBackend()||(e="settings-"+e);var n=window.localStorage;return(n=this.saveSettingsOnBackend()&&pgwpdata&&pgwpdata.user_settings?pgwpdata.user_settings:n)&&e in n?(n=n[e],r||0!=n.length?n:t):void 0===t?null:t},this.setSetting=function(e,t,r){var n=e,i=(null==t&&(t=""),this.saveSettingsOnBackend()||(e="settings-"+e),window.localStorage);(i=pinegrow.saveSettingsOnBackend()&&pgwpdata&&pgwpdata.user_settings?pgwpdata.user_settings:i)[e]=t,this.saveSettingsOnBackend()&&pinegrow.currentUser&&pinegrow.currentUser.settingsChanged(r),pinegrow.dispatchEvent("on_setting_changed",null,n,t)},this.shouldStoreKeysInLocalStorage=function(){return!!isApp()||!(!pgf.always_store_keys_in_local_storage||"auto"===pgf.always_store_keys_in_local_storage&&pinegrow.currentUser.isAdmin())},this.storeKey=function(e,t){this.shouldStoreKeysInLocalStorage()?(e="settings-"+e,window.localStorage[e]=t):this.setSetting(e,t)},this.getKey=function(e){var t=this.getSetting(e);return t||this.shouldStoreKeysInLocalStorage()&&(e="settings-"+e,window.localStorage[e])||null},this.blockUntrustedJS=function(e){var i=pinegrow.getCurrentProject(),o=[],s=!1,a=["https://cdn.tailwindcss.com/"];return e.withoutEvents(function(){e.walkSelfAndChildren(function(e){if(e.isElement){if("script"===e.tagName){var t=e.getAttribute("src"),r=!1,n=e.getAttribute("data-pg-script-url");if(n&&(r=!0,t=n),t&&!i.isUrlMappedToDOMOrSource(t)&&a.indexOf(t)<0)return o.push(e),!0;if(!r&&e.content.trim().length){if(e.content.startsWith("/* Pinegrow Interactions")){n=pinegrow.findFrameworkByKey("pg.ia");if(n)return e.content=n.pgiaGetInteractionsHeadScript(),!0}o.push(e)}}e.getAttrList().forEach(function(e){e.name_lc.startsWith("on")&&(e.name_lc="data-disabled-"+e.name_lc,e.name="data-disabled-"+e.name,s=!0),e.value&&e.value.match(/^javascript\:/gi)&&(e.value="#",s=!0)})}return!0}),o.forEach(function(e){e.remove()})}),o.length||s},this.shouldBlockUntrustedJS=function(){var e;return pgf.block_untrusted_js&&(!(e=this.getCurrentProject())||!e.fsHandle)&&(!e||e.block_untrusted_js)||!1},this.openProjectBySelectingFolder=function(t){var r;canOpenProject()&&((r=new CrsaProject).openProjectBySelectingFolder(function(e){pinegrow.setCurrentProject(e),pinegrow.recentFiles.add(e.root.path,!0),crsaQuickMessage("Project was loaded."),pinegrow.openProjectPanelIfNoPageOpen(),t&&t(r)}),pinegrow.stats.using("app.openproject"))},this.setCurrentProject=function(e){o&&o!=e&&$("body").trigger("crsa-project-closed",o),(o=e)&&(e.showProjectExplorer($("#crsa-project")),u.callGlobalFrameworkHandler("on_project_loaded",o),pinegrow.devTools.unregisterServiceWorkers(),pinegrow.setShowDisplayHelpers(!0,!1),$(window).trigger("resize"),!e.framework)&&pgf.components&&(e.framework=pinegrow.loadProjectAsLibrary(e.getDir()))},this.getCurrentProject=function(){return o},this.closeCurrentProject=function(e,t,r){o?(o.is_closing_all_pages=!0,pinegrow.closeAllPages(function(e){var t;e&&((t=o).closeProjectExplorer($("#crsa-project")),pinegrow.setCurrentProject(null),u.callGlobalFrameworkHandler("on_project_closed",t),t.framework&&pinegrow.unloadFramework(t.framework),t.destroy(),$(window).trigger("resize"),pinegrow.setShowDisplayHelpers(!0,!1),r)&&r()},!0,t)):(e?(this.showQuickMessage("There is no open project. Closing all open pages instead..."),pinegrow.closeAllPages()):this.showQuickMessage("There is no open project."),r&&r())},this.refreshCurrentProject=function(e,t,r){var n;o&&(r||o.storeTags(),n=function(){r||o.restoreTags(),o.showProjectExplorer($("#crsa-project")),t||u.callGlobalFrameworkHandler("on_project_refreshed",o),e&&e()},isApp()?o.fromFolder(o.root.path,function(e){n()},!0):n())},this.refreshCurrentProjectAsync=function(t){const r=this;return new Promise(function(e){r.refreshCurrentProject(e,t)})},this.refreshCurrentProjectDelayed=function(e){t.run("refreshCurrentProjectDelayed",function(){u.refreshCurrentProject(null,e)},1e3)},this.getCurrentProjectInfo=function(e){var t;return o?o.getProjectInfo():(t=e||pinegrow.getSelectedPage())?t.getProjectInfo():null},this.refreshAllPages=function(){for(var e=this.getAllPages(),t=0;t<e.length;t++)e[t].refresh()},this.getComponent=function(e,t){e in r&&0?t(r[e]):r[e]=new PgComponent(e,t)},this.getProxyUrl=function(e,t){return this.sourceParser&&this.httpServer?this.httpServer.makeProxyUrl(e,t):e},this.hasInternalServer=function(){return this.httpServer&&this.httpServer.url},this.getOriginalUrl=function(e){return this.httpServer?this.httpServer.getOriginalUrl(e):e},this.getApiUrl=function(){return this.httpServer.url},this.saveRemoteImageToProject=async function(l,e){return new Promise(async function(i,n){var s,o,a;isApp()?crsaChooseFile(async function(e){!async function(e){var t=crsaMakeFileFromUrl(e);try{var r=await pgFetchRemoteContent(l);require("fs").writeFileSync(t,Buffer.from(r)),pinegrow.refreshCurrentProjectDelayed(!0),i(e)}catch(e){n(e)}}(e)},crsaGetNameFromUrl(l)):(s=pinegrow.getCurrentProject(),o=pinegrow.getMimeType(l)||"image/jpeg",(a=function(e,t){e||(e=crsaGetNameFromUrl(l),e="images/"+(e=crsaGetExtFromUrl(l)?e:e+"."+o.replace("image/","")));var r,n=t?`<div class="error alert alert-danger">${t}</div>`:"";pinegrow.showQuickDialog(`Save the remote image`,"Information",`<p>Enter the name for the local image, including the folder name. If the folder is not given <code>images/</code> is assumed.</p>`+n,{local_url:{name:"Image name",type:"text",value:e,placeholder:"for example: images/myimage.jpg",validate:function(e,t,r,n,i,o){return r?s.getFileForUrl(s.getAbsoluteUrl(r))?`A file with the name <code>${r}</code> already exists.`:null:`The ${what} name is required.`}}},"Cancel","Save",null,function(e){r=e.local_url,pinegrow.showQuickMessage("Saving the image..."),pinegrow.backend.saveRemoteImage(pinegrow.getCurrentProject(),l,r,function(e){var t=pinegrow.getCurrentProject();e.data&&(t.setContentOfUrl(r,`@mapurl:`+e.data.url),t.addSourceUrlToDOMUrlMap(r,e.data.url),pinegrow.refreshCurrentProjectDelayed(!0)),i(e.data.url)},function(e){a(r,e?.data?.error||e)})})})())})},this.getImageSrcForPgel=function(e){if("img"===e.tagName)return e.getAttribute("src")},this.displayOldWrapperNotice=function(){var e=pinegrow.getSelectedPage(),t=pinegrow.findFrameworkByKey("wordpress.pinegrow");t&&t.isWPEnabledForProject()?pinegrow.showAlert(`<p>Open in wrapper was replaced by a more powerful Live data and preview for WordPress. Use the Preview... dropdown on top of every page view to start using it.</p>`,"Wrappers are now Live data and preview","Close","Show me the Preview dropdown",function(){},function(){e?pgRevealElement(e.$page.find(".pg-button-toolbar-section.wp .pg-button-toolbar-item")):pinegrow.showQuickError("Open a page first.")}):pinegrow.showAlert(`<p>Wrappers were replaced by a much more powerful feature, but at the moment it is only available for WordPress projects.</p>`,"Wrappers are not available in non-WordPress projects",null,"Close")},this.openPageInWrapper=async function(i,o,s,e){return new Promise(function(t){var e,r=pinegrow.getCurrentProjectInfo(),n=o||r.getSettingForUrl(i,"wrapper_url"),r=s||r.getSettingForUrl(i,"wrapper_selector");n?(e=pinegrow.getCrsaPageByUrl(i))?(e.did_handle_wrapper_loading=!1,e.wrapper_url=n,e.wrapper_selector=r,e.refresh()):pinegrow.openPage(i,function(e){t(e)},!0,null,{open_with_wrapper:!0,wrapper_url:n,wrapper_selector:r}):pinegrow.showPageWrapperDialog(i,null,!0)})},this.openPageViewInWrapper=function(t,r,n,i){return new Promise(function(e){t.did_handle_wrapper_loading=!1,t.wrapper_node&&t.wrapper_node.removeWithoutEvents(),t.wrapper_node=null,t.wrapper_url=r,t.wrapper_selector=n,t.wrapper_data=i,t.getPage().view.rememberPageViews(),t.reloadPage(function(){e()},function(){e()},!0)})},null),h=(this.resetEditableFileTypes=function(){l=null},this.hideEditCode=function(){var e=pgPageCodeEditorsStack;return!!e.isEditorShown()&&(e.hide(),!0)},this.editCode=function(e,t,r){var n;return pinegrow.isContributorMode()?null:(n=pgPageCodeEditorsStack,e.codeEditor?n.isEditorShown(e.codeEditor)?t||n.hide():n.showEditor(e.codeEditor):(e.codeEditor=new PgInternalCodeEditorView(e,r),n.showEditor(e.codeEditor)),e.codeEditor)},this.editElementCode=function(e){e&&new PgQuickCodeEdit(e)},this.editCodeOfAllOpenPagesAndStylesheets=function(){if(pinegrow.isContributorMode())return null;var t=null,e=pgPageCodeEditorsStack,r=(pinegrow.getAllPages().forEach(function(e){e.codeEditor||(e.codeEditor=new PgInternalCodeEditorView(e,!1),t=t||e.codeEditor)}),pinegrow.getCurrentProject());pinegrow.getStylesheets().forEach(function(e){e.inline||e.url&&r&&r.isUrlInProject(e.url)&&pinegrow.stylesheets.editCode(e)}),e.isEditorShown()||e.show(),t&&pgPageCodeEditorsStack.showEditor(t)},this.revealCSSRuleInCodeEditor=function(e){pgf.kids&&this.editCodeOfAllOpenPagesAndStylesheets();var t,r=pgcssh.getStylesheetForNode(e);r.elementStyle||((t=pinegrow.codeEditors.isUrlOpen(r.url))?pgPageCodeEditorsStack.isEditorShown(t.view)||pgPageCodeEditorsStack.showEditor(t.view):t=pinegrow.stylesheets.editCode(r),t&&t.search(r.getSourceForRules(e)))},this.openFileInCodeEditor=function(e,t){var r=isApp()?crsaMakeUrlFromFile(e):e,n=pinegrow.getCrsaPageByUrl(r),i=crsaGetExtFromUrl(r),o=(t=t||r,null);if(n)o=this.editCode(n);else{if(0<=["jpg","jpeg","gif","png"].indexOf(i)||!pinegrow.isFileEditableOrInCodeEditor(r))return pinegrow.showQuickMessage("Images and other non-textual files can't be edited in the code editor.",4e3,!1,"error"),!1;if(o=pinegrow.codeEditors.isUrlOpen(r))return pinegrow.codeEditors.showEditor(o),!1;var i=!0,s=pinegrow.stylesheets.getByUrl(t,!0),r=(s&&(i=!1),(n=new CrsaPage).fromFile(e,!0,i),!1),i=(s&&s.loaded&&(s.compiledFile?s.getSourceToSave(function(e,t){n.setCode(s.filterSource(t=e?"":t))}):n.setCode(s.filterSource(s.getSource())),s.canEdit(!0)||(r=!0),n.codeEditForStylesheet=s),this.getCurrentProject());i&&i.addBackgroundPage(n),o=this.editCode(n,!1,r)}return o},this.isFileEditable=function(e){var t;if(null===l&&(t=(pinegrow.getSetting("file-types","")||"")+",.html,.htm",l=[],t=t.split(","),pinegrow.callGlobalFrameworkHandler("on_get_editable_file_types",t),$.each(t,function(e,t){try{(t=$.trim(t)).length&&(t.match(/^noext$/i)?(l.push(/^[^\.]+$/),l.push(/[\/\\][^\.]+$/)):l.push(new RegExp(escapeRegExp(t)+"$","i")))}catch(e){console.log("File type error: "+e)}})),!e.match(/functions\.php/))for(var r=0;r<l.length;r++)if(e.match(l[r]))return!0;return!1},{"application/javascript":!0,"application/json":!0}),g=(this.isFileEditableOrInCodeEditor=function(e){var t;return!!this.isFileEditable(e)||!(!(t=this.getMimeType(e))||!t.startsWith("text/")&&!h[t])},this.mimeTypes={".bmp":"image/bmp",".css":"text/css",".gif":"image/gif",".ico":"image/x-icon",".htm":"text/html",".html":"text/html",".php":"text/html",".php5":"text/html",".asp":"text/html",".aspx":"text/html",".cfm":"text/html",".cfml":"text/html",".cfc":"text/html",".shtml":"text/html",".pgml":"text/html",".jpg":"image/jpeg",".jpeg":"image/jpeg",".js":"application/javascript",".json":"application/json",".otf":"font/opentype",".woff":"application/font-woff",".woff2":"application/font-woff",".ttf":"application/x-font-ttf",".svg":"image/svg+xml",".png":"image/png",".webp":"image/webp",".avif":"image/avif",".heic":"image/heic",".text":"text/plain",".txt":"text/plain",".md":"text/plain",".mp3":"audio/mpeg",".mp4":"video/mp4",".webm":"video/webm",".ogv":"video/ogg",".ogg":"audio/ogg",".less":"text/x-less",".scss":"text/x-scss",default:null},this.getMimeType=function(e){var t,r;return e=crsaRemoveUrlParameters(e),pinegrow.isFileEditable(e)?"text/html":(t=-1===(t=e.lastIndexOf("."))?"default":e.substr(t),(r=this.mimeTypes)[t.toLowerCase()]||r["default"])},this.getSimpleMimeType=function(e){var t=this.getMimeType(e);if(t){if("image/x-icon"===t)return"icon";if(t.startsWith("image/"))return"image";if("application/javascript"===t)return"script";if("text/css"===t||"text/x-less"===t||"text/x-scss"===t)return"css";if("text/html"===t)return"html"}return t},this.getExtForMimeType=function(r){var n=null;return $.each(this.mimeTypes,function(e,t){if(t===r)return n=e,!1}),n},this.getPlaceholderImage=function(){return pgf.kids?`alien${getRand(1,15)}.png`:(isApp()&&0?crsaMakeUrlFromFile(crsaGetAppDir()+"placeholders/img"):"https://pinegrow.com/placeholders/img")+(Math.round(10*Math.random())+10)+".jpg"},this.getThumbnailForPlaceholderImage=function(e){return e.replace(".jpg","_thumb.jpg")},this.createProxyLinksForPlaceholderImagesInCode=function(e){return e.replace(/src="(https?:\/\/pinegrow\.com\/placeholders\/[^"]+)"/g,function(e,t,r,n){return'src="'+pinegrow.getProxyUrl(t)+'"'})},this.getPageForElement=function(e){var t=getIframeOfElement(e);return t?getCrsaPageForIframe(t):null},this.getStylesheets=function(){return pinegrow.stylesheets.getAllCrsaStylesheets()},this.getStylesheetByUrl=function(e){return pinegrow.stylesheets.getStylesheetByKey(e)},this.getStylesheetByFileName=function(t){for(var e=this.getStylesheets(),r=0;r<e.length;r++){var n=e[r],i=n;if(t==n.getDecodedLocalFileName())return n;if(n.sourceStylesheet){n=n.sourceStylesheet,i=n;if(t==n.getDecodedLocalFileName())return n}var o=null;if(i.forEachStylesheet(function(e){if(t==e.getDecodedLocalFileName())return o=e,!1},!0),o)return o}return null},this.addEditableAreaExtension=function(e){pinegrow.findFrameworkByKey("pg.components").getComponentType("pgc.edit").pgcAddExtension(e)},this.getCodeFromDefinition=function(e){return getCodeFromDefinition(e)},this.addFramework=function(e,t){void 0===t&&(t=0),a[e.key]=e,a[e.key].order=t,0<c.length&&(e.pluginUrl=c[c.length-1]),$("body").trigger("crsa-framework-loaded",e)},this.getFrameworks=function(){return a},this.getComponentType=function(e){},this.findFrameworkWithUrl=function(r){var n=null;return $.each(a,function(e,t){if(t.pluginUrl&&t.pluginUrl==r)return n=t,!1}),n},this.findFrameworkByKey=function(r){var n=null;return $.each(a,function(e,t){if(t.key==r)return n=t,!1}),n},this.findFrameworkByType=function(r){var n=null;return $.each(a,function(e,t){if(t.type==r)return n=t,!1}),n},this.loadAllFrameworksFromFile=function(){var o=pinegrow.getFrameworksListFromStorage(),s="",a=0,l=[],c=function(){if(a>=o.length){if(0<s.length&&showAlert(s,"Not all frameworks could be loaded"),l.length){for(var e=0;e<l.length;e++){var t=o.indexOf(l[e]);0<=t&&o.splice(t,1)}crsaStorage.setValue("frameworks",o)}}else{var r=o[a],n=crsaMakeFileFromUrl(r),i=crsaIsFileOrDir(n);"file"==i?u.loadFrameworkFromUrl(r,!0,function(e){e&&(s+="<p>Unable to load "+r+": "+e+"</p>","FILE_NOT_FOUND"==e)&&l.push(r),a++,c()}):"dir"==i&&pgf.components?pinegrow.loadProjectAsLibrary(n,function(){a++,c()}):(a++,c())}};c()},this.fileLoaded=function(){0<c.length&&c.pop()},this.addScriptToPage=function(e,t,r){var n,i=e.sourceNode.findOne("body");i&&(n=pgCreateNodeFromHtml("<script>\n    "+t+"\n<\/script>"),i.append(n),r)&&this.executeScriptInPage(e,t)},this.hasScriptCodeOnPage=function(e,t){var r=!1,n=/[\s\n]+/g;return t=t.replace(n,""),e.sourceNode.find("script").forEach(function(e){e.content&&0<=e.content.replace(n,"").indexOf(t)&&(r=!0)}),r},this.addScriptCodeToPageIfNeeded=function(e,t,r,n,i){r=r||"Code",this.hasScriptCodeOnPage(e,i||t)?pinegrow.showQuickMessage(r+" is already on the page."):(this.addScriptToPage(e,t,n),pinegrow.showQuickMessage(r+" was added to the page."))},{}),d=(this.askAboutAddingCodeToPage=function(e,t,r,n,i,o){var s;void 0===i&&(i=!0),g[t]||i&&this.hasScriptCodeOnPage(e,o||t)||(s="<p>"+n+"</p><pre>"+escapeHtmlCode(t)+"</pre>",s=pinegrow.showAlert(s,r,"Don't add","Add code to the page",null,function(){pinegrow.makeChanges(e,"Add code to the page",function(){pinegrow.addScriptToPage(e,t,!0)}),pinegrow.showQuickMessage("Code was added to the page.")}),this.addLeftButton(s,"Don't ask again during this session",function(){g[t]=!0}))},this.executeScriptInPage=function(e,t){e.javascriptEnabled&&e.sourceNode.findOne("body").executeScript(t)},null),f=(this.setJavascriptEnabled=function(t){void 0===t&&(t="1"==pinegrow.getSetting("javascript-enabled","1")),d=t,pinegrow.jsEnabledButton.setActive(t),pinegrow.setSetting("javascript-enabled",t?"1":"0"),pinegrow.getAllPages().forEach(function(e){e.setJavascriptEnabled(t)})},this.isJavascriptEnabled=function(){return d},this.loadFrameworkFromUrl=function(t,r,n){var i=null;if(isApp()){require("fs");if(crsaIsFileUrl(t)){var e=crsaMakeFileFromUrl(t);if("file"!=crsaIsFileOrDir(e))return n&&n("FILE_NOT_FOUND"),!1}try{var o=(new Date).getTime(),s='<script async="false" src="'+t+"?z="+o+'"><\/script>',a=$("body"),l=((s=document.createElement("script")).async=!1,$(s).on("load",function(e){$(function(){c.push(t);try{$("body").trigger("pinegrow-ready",pinegrow),pinegrow.fileLoaded(),n&&n()}catch(e){pinegrow.fileLoaded(),n&&n(e)}})}),s.setAttribute("src",t),a.get(0).appendChild(s),pinegrow.getFrameworksListFromStorage());l.indexOf(t)<0&&(l.push(t),crsaStorage.setValue("frameworks",l))}catch(e){i=e,r||showAlert("Unable to load "+t+". "+e,"Unable to load framework"),console.log(e),n&&n(e)}}return i},this.saveFrameworksList=function(){var r=[];$.each(a,function(e,t){t.pluginUrl&&r.push(t.pluginUrl)}),crsaStorage.setValue("frameworks",r)},this.getFrameworksListFromStorage=function(){for(var e=crsaStorage.hasValue("frameworks")?crsaStorage.getValue("frameworks"):[],t=0;t<e.length;t++)crsaIsAbsoluteUrl(e[t])||(e[t]=crsaMakeUrlFromFile(e[t]));return e},this.unloadFramework=function(r){var e=$.fn.crsapages("getAllPages"),e=($.each(e,function(e,t){t.removeFramework(r)}),r.key in a&&delete a[r.key],-1),t=pinegrow.getFrameworksListFromStorage();0<=(e=r.pluginUrl?t.indexOf(r.pluginUrl):e)&&t.splice(e,1),crsaStorage.setValue("frameworks",t)},this.hasUnsavedFrameworks=function(){var r=!1;return $.each(a,function(e,t){t.changed&&t.user_lib&&(r=!0)}),r},this.saveChangedFrameworks=function(e,t){var r,n=[];e?r=e.frameworks:(r=[],$.each(a,function(e,t){r.push(t)}));for(var i=0;i<r.length;i++){var o=r[i];o.user_lib&&o.changed&&n.push(o)}var s=function(){n.length?n.shift().save(null,function(){s()}):(pinegrow.frameworksChanged(),t&&t())};s()},this.addFrameworkResourcesToPageOrProject=function(e,t,r){function n(){s?e.addResourcesToProject(t,function(){o(e)},i.overwrite,i.same_project,i.only_add_to_page||!1,i.resources):!t.localFile&&isApp()?pinegrow.showAlert("<p>Please save the page before adding resources to it.</p><p>After saving the page go to <b>Components -&gt; Add / update resources from libraries</b> to copy and add resources to the page.</p>","New page is not saved yet"):e.addResourcesToPage(t,function(){pinegrow.refreshCurrentProjectDelayed(!0),o(e)},i.overwrite,i.same_project,i.resources)}var i=$.extend({overwrite:!1,same_project:!1,done:null,resources:null,only_add_to_page:null},r||{}),o=function(){i.done&&i.done(e)},s=t instanceof CrsaProject;e.on_add_resources?e.on_add_resources(s,function(e){e&&n()}):n()},this.activateFrameworkInCurrentContext=function(t,e,r){var n=pinegrow.getCurrentProject(),i=pinegrow.getSelectedPage();i?n&&n.isPageInProject(i)&&!r?(pinegrow.getAllPages().forEach(function(e){n.isPageInProject(e)&&e.addFramework(t,!0)}),pinegrow.frameworksChanged(),e&&e(n),pinegrow.showQuickMessage("<b>"+t.name+"</b> activated for <b>project "+n.getName()+"</b>")):(i.addFramework(t,null,function(){e&&e(i)}),pinegrow.showQuickMessage("<b>"+t.name+"</b> activated for <b>page "+i.name+"</b>")):(isApp()&&pinegrow.showAlert("<p>The library is loaded. Now open a page and <b>Activate "+t.name+"</b> in <b>Page -&gt; Manage libraries &amp; framewors</b>.</p>","Activate the library"),e&&e())},this.frameworksChanged=function(){$.each($.fn.crsapages("getAllPages"),function(e,t){t.frameworksChanged()}),pinegrow.dispatchEventDelayed("on_page_frameworks_changed",null)},this.getDragMenu=function(){return $.fn.crsa("getDragMenu")},this.drag_drop_options={force_parent:null},this.getChildOfForceParent=function(e,t,r,n){if(this.drag_drop_options.force_parent){var i=this.drag_drop_options.force_parent;if(!e.isDescendantOf(i))return!1!==r&&pinegrow.showQuickError(r||`In this mode you can only move elements within the ${i.getName({short:!0})} element.`),n?e:null;for(var o=!1;e.parent&&e.parent!==i;)e=e.parent,o=!0;t&&o&&t(e)}return e},null),m={},w=pgf.auto_focus&&"1"===this.getSetting("auto-focus",pgf.auto_focus?"1":"0"),_=(this.setAutoFocus=function(e){var t;w=e,this.setSetting("auto-focus",w?"1":"0"),w?((t=pinegrow.selectedElements.getLastSelected())&&pinegrow.autoFocusOnElementIfNeeded(t),pinegrow.selectedElements.reselect()):pinegrow.isolateElement(null)},this.getAutoFocus=function(){return w},this.autoFocusOnElementIfNeeded=function(e){var t;pinegrow.getAutoFocus()&&e&&((t=e.closest("header,footer,section"))?t!==pinegrow.getIsolatedElement()&&pinegrow.isolateElement(t,{},!0):(t=pinegrow.getIsolatedElement())&&!e.isDescendantOf(t)&&pinegrow.isolateElement(null,{},!0))},this.isolateElement=function(e,t,r){var n;f=e,m=$.extend({tree_hide_scripts:!0,drag_drop_only_top_level:pgf.focus_select_only_top_level},t),this.drag_drop_options.force_parent=m.drag_drop_only_top_level?e:null,pinegrow.dispatchEvent("on_element_isolated",e?e.getPage():null,e,m),r||(n=[],pinegrow.selectedElements.forEachElement(function(e){var t=!1;u.getChildOfForceParent(e,function(e){t=!0,n.push(e)},!1)&&!t&&n.push(e)}),e&&0===n.length&&n.push(e),pinegrow.selectedElements.selectIds(n.map(function(e){return e.getId()})))},this.getIsolatedElement=function(e){return f&&f.isDeleted?(this.isolateElement(null),null):e&&f&&f.document!==e.sourceNode?null:f},this.getIsolatedElementOptions=function(){return m},this.pageHasIsolatedElement=function(e){return f&&f.document===e.sourceNode},{}),y=(this.addEventHandler=function(e,t,r){if(_[e]||(_[e]=[]),r){for(var n=0,i=_[e],n=0;n<i.length;n++)if(i[n].priority<r)break;_[e].splice(n,0,{func:t,priority:r})}else _[e].push({func:t,priority:0})},this.removeEventHandler=function(e,t){if(_[e]){for(var r=0,n=_[e],r=0;r<n.length;r++)if(n[r].func==t)break;r<n.length&&_[e].splice(r,1)}},this.dispatchEvent=function(i,r,t,e,n,o,s){var a,l,c=r instanceof CrsaPage?r:null,u=!c&&Array.isArray(r)&&r.length&&r[0]instanceof CrsaPage?r:null,h=function(){var n=[];if(c)for(var e=0;e<r.frameworks.length;e++){var t=r.frameworks[e];t.hasOwnProperty(i)&&n.push({func:t[i],priority:1e3})}else u&&u.forEach(function(e){for(var t=0;t<e.frameworks.length;t++){var r=e.frameworks[t];r.hasOwnProperty(i)&&n.indexOf(r[i])<0&&n.push({func:r[i],priority:1e3})}});return n=_[i]?n.concat(_[i]):n}();if(!i.endsWith("_async")){c&&(c.currentFrameworkHandlerReturnValues[i]=null);var p=null;if(h.length)for(var g=0;g<h.length;g++)p=h[g].func(r,t,e,n,o,s),c&&(c.currentFrameworkHandlerReturnValues[i]=p);return c&&(c.currentFrameworkHandlerReturnValues[i]=null),p}h.length?(a=0,(l=function(){a<h.length?h[a].func(r,t,function(e){t=e,a++,l()}):e&&e(t)})()):e&&e(t)},{}),P=(this.dispatchEventDelayed=function(e,t,r,n,i,o,s){this.dispatchEventDelayedForObject(t||this,e,t,r,n,i,o,s)},this.dispatchEventDelayedForObject=function(e,t,r,n,i,o,s,a){e=e||this,y[t]||(y[t]=new WeakMap),y[t].has(e)&&clearTimeout(y[t].get(e));y[t].set(e,setTimeout(function(){y[t].delete(e),u.dispatchEvent(t,r,n,i,o,s,a)},750))},this.callGlobalFrameworkHandler=function(r,n,i,o,s,a,t,l){l=l||this.getSelectedPage();var c=null;return $.each(this.getFrameworks(),function(e,t){r in t&&t[r]&&(c=t[r](l,n,i,o,s,a,t))}),_[r]&&_[r].forEach(function(e){c=e.func(l,n,i,o,s,a,t)}),c},this.getCollection=function(e){return e?e instanceof PgCollection?e:new PgCollection(e):pinegrow.selectedElements.getCollection().clone()},this.getCollectionForElement=function(e){var t;return!e||pinegrow.selectedElements.isSelectedElement(e)?t=pinegrow.getCollection():(t=new PgCollection).add(e),t},this.showUpdateResourcesDialog=function(o,s,e){var t,r,n=[];if(s&&(n=s.getFrameworks(),r=s.getName(),t=s.getDir()),o){for(var i=0;i<o.frameworks.length;i++)n.indexOf(o.frameworks[i])<0&&n.push(o.frameworks[i]);r=o.name,t=o.localFile?require("path").dirname(o.localFile):null}var a=[],l=pinegrow.getCurrentProject(),c=null;l&&(c=l.getProjectInfo());for(i=0;i<n.length;i++)e&&e.indexOf(n[i])<0||n[i].resources.has()&&a.push(n[i]);var u=function(e){return!(!l||!e.project||l.getDir()!=e.project.getDir())||!(!c||c.getSetting("template_framework_id")!=e.type)},h=function(e){e.on_after_resources_added&&e.on_after_resources_added(),pinegrow.showQuickMessage("<b>"+(e.resources_name||e.name)+"</b> resources copied to <b>"+r+"</b>"),pinegrow.refreshCurrentProjectDelayed(!0)},p="",p=(0==a.length?p+="<div><p>No libraries or plugins that are activated on this page/project have any resources that can be copied to your page or project.</p></div>":p+="<div><p>The following libraries and plugins have resources (CSS &amp; JS files, images...) that can be copied to your page or project. These resources are often necessary for components to display and behave properly. <b>Note: You don't have to update resources if your documents already include the necessary files.</b></p></div>",$(p)),g=$("<ul/>").appendTo(p),d=$(`<hr><div><label><input type="checkbox">&nbsp;&nbsp;Overwrite resources, if they already exist. <b>Check this if you want to update framework files to the latest version.</b></label></div>`).appendTo(p).find("input"),f=(pinegrow.showAlert(p,"Update resources in page or project",null,"Close"),g);f.html("");for(var m=0;m<a.length;m++){for(var w=a[m],v=$('<li style="margin-bottom:15px;"><b>'+(w.resources_name||w.name)+"</b></li>"),_=(w.pluginUrl&&0&&v.append('<div><small class="text-muted">'+w.pluginUrl+"</small></div>"),w.resources.description&&v.append('<p class="text-muted" style="margin-bottom:0;">Resources: '+w.resources.description+"</p>"),u(w)),y=(t&&!_&&v.append('<p class="text-muted" style="margin-bottom:0;">Will be copied to: <b>./'+w.getResourceNamespace()+"</b></p>"),_&&v.append('<p style="margin-bottom:0;">These resources are already a part of the current project.</p>'),v.append('<div class="files-list-wrapper"></div>')),P=(_&&!1||(o&&y.append('<a href="#" class="copy btn btn-sm btn-primary">Add to or update '+o.name+"</a>"),s&&y.append('<a href="#" class="copy project btn btn-sm btn-primary" style="margin-left: 10px;">Add to or update all files in '+s.getName()+"</a>")),y.append('<a href="#" class="show-list btn btn-sm btn-link">Show files and folders</a>'),$("<ul/>",{class:"files-list"}).appendTo(v.find(".files-list-wrapper"))),b=0;b<w.resources.list.length;b++)w.resources.list[b].code||$("<li>"+(w.resources.list[b].relative_url||w.resources.list[b].url)+"</li>").appendTo(P);P.hide(),v.data("framework",w),f.append(v)}f.find("a.copy").on("click",function(e){e.preventDefault();var t=$(e.delegateTarget).closest("li").data("framework"),r=$(e.delegateTarget).hasClass("project"),n=u(t),i=d.is(":checked");pinegrow.addFrameworkResourcesToPageOrProject(t,r?s:o,{done:h,overwrite:i,same_project:n})}),f.find("a.show-list").on("click",function(e){e.preventDefault();var t=$(e.delegateTarget).closest("li"),t=(t.data("framework"),t.find("ul.files-list"));t.is(":visible")?(t.hide(),$(this).html("Show the list of files and folders")):(t.show(),$(this).html("Hide the list of files and folders"))})},this.goThroughAllForAttribute=function(e,t,r){for(var n=e.sourceNode.findIncludingSelf("["+t+"]"),i=0;i<n.length;i++){var o=n[i],s=o.getAttr(t);r&&r(o,t,s)}},this.goThroughAllLinkedResources=function(e,t){for(var r=["src","data-src","href","action"],n=0;n<r.length;n++)this.goThroughAllForAttribute(e,r[n],t)},this.copyMissingExternalFiles=function(e,l,c,t){e.sourceNode.walk(function(e){return e.isElement&&e.mapLinksToNewLocation(t,c,!0),!0});crsaIsRemoteUrl(l);this.goThroughAllLinkedResources(e,function(e,t,r){var n,i,o,s,a;"a"!=e.tagName&&r&&!crsaIsAbsoluteUrl(r)&&(n=crsaGetUrlToSmartCombine(c,r),n=crsaCombineUrlWith(c,n),i=require("fs"),s=crsaCombineUrlWith(l,r),o=crsaMakeFileFromUrl(n),crsaIsRemoteUrl(s)?!crsaIsFileExist(o)&&(pgCopyRemoteUrlToLocalPath(s,o),a=pinegrow.stylesheets.getByUrl(n))&&a.reload():(s=crsaMakeFileFromUrl(s),crsaIsFileExist(s)&&!crsaIsFileExist(o)&&(crsaCreateDirs(crsaGetFileDir(o),i),crsaCopyFileSync(i,s,o),a=pinegrow.stylesheets.getByUrl(n))&&a.reload()))})},this.fixLinks=function(g,i,d,f,o,m,e,t){var w={},s=(this.goThroughAllLinkedResources(i,function(r,n,i){if((i=crsaCleanUpUrl(i))&&!crsaIsAbsoluteUrl(i)){var e=crsaGetUrlToSmartCombine(f,i),t=crsaCombineUrlWith(f,e);if(g.getFileForUrl(t)||crsaIsFileOrDir(crsaMakeFileFromUrl(t)))e!=i&&r.setAttr(n,e);else{var o,s,a=crsaGetNameFromUrl(t),l=g.getFilesWithName(a);if(0<l.length)if(1==l.length)v(i,l[0].url,f,function(e){r.setAttr(n,e)});else{for(var c=[],u=!1,h=0;h<l.length&&(crsaGetRelativeDistanceForUrls(l[h].url,t,function(e,t){t=e<0?i:t,w[i]||(w[i]={urls:[]}),w[i]["name"]=a,w[i]["el"]=r,w[i]["attr"]=n,w[i]["urls"].push(l[h].path),c.push({distance:e,url:t}),l[h].url==crsaCombineUrlWith(d,i)&&(c=[{distance:e,url:t}],w[i]["urls"]=c,u=!0)}),!u);h++);var e=c.sort(function(e,t){return e.distance>t.distance?1:e.distance<t.distance||null==t.distance?-1:null==e.distance?1:void 0});if(e[0].distance<0||1==e.length){for(var p="",h=e[0].distance;h<0;h++)p+="../";e=p+e[0].url;r.setAttr(n,e),delete w[i]}}else!m||"a"==r.tagName&&"href"==n||(e=require("fs"),o=crsaCombineUrlWith(d,i),o=crsaMakeFileFromUrl(o),s=crsaMakeFileFromUrl(t),crsaIsFileExist(o)&&(crsaCreateDirs(crsaGetFileDir(s),e),crsaCopyFileSync(e,o,s)))}}}),!$.isEmptyObject(w));if(e)o&&o(s);else{var r=new CrsaMultiChooser;for(file in w)r.addItem("<b>"+file+"</b> missing. Use:",file,w[file].urls);r.show(null,function(e){if(e)for(var t in e){var r=e[t],n=w[t];v(null,crsaMakeUrlFromFile(r),i.url,function(e){n.el.setAttr(n.attr,e)})}o&&o(s)})}},this.addTemplateProject=function(e,t){null==t?this.projectTemplates.push(e):this.projectTemplates.splice(t,0,e),$.fn.crsa("addTemplateProject",e,t)},this.addTemplateProjectFromTemplateDefinition=function(e){var t=new CrsaProject;return t.fromSimpleTemplate(e),this.addTemplateProject(t,0),t},this.addTemplateProjectFromFolder=function(e,t,r,n){var i=new CrsaProject;i.templateBrowserIndex=r,i.fromFolder(e,function(e){e.sortItems(),n||u.addTemplateProject(e,r),t(e)})},this.openPage=function(r,n,e,t,i){var o,s,a=crsaGetUrlHash(r);r=(r=crsaRemoveUrlHash(r)).replace(/\'/g,"%27"),i=i||{},!1===e&&(i.skip_page_select=!0),pgf.use_page_wrappers&&(s=pinegrow.getCurrentProjectInfo(),i.open_with_wrapper)&&(o=i.wrapper_url||s.getSettingForUrl(r,"wrapper_url"),s=i.wrapper_selector||s.getSettingForUrl(r,"wrapper_selector"),o)&&(i.wrapper_url=o,i.wrapper_selector=s),crsaIsFileUrl(r)&&!this.isFileEditable(crsaMakeFileFromUrl(r))?pinegrow.showQuickMessage("Files of this type can not be edited in Pinegrow."):$.fn.crsa("openPage",r,function(e){var t;a&&e.scrollToHash(a),n&&n(e),i&&i.do_not_remember_page_open||(t=pinegrow.getCurrentProject())&&t.pageWasOpenedOrClosed(e,!0)},function(e){var t;crsaIsFileUrl(r)?e.setLocalFile(crsaMakeFileFromUrl(r)):(t=pinegrow.getMappedRemoteFileForUrl(r,"html"))&&(e.setLocalFile(t),e.mappedRemote=!0,e.mappedRemoteFirstSave=!crsaIsFileExist(t)),i&&i.on_source_loaded&&i.on_source_loaded(e)},null,null,i)},this.openOrShowPage=function(e,t,r,n,i){var o=crsaGetUrlHash(e),s=(e=crsaRemoveUrlHash(e),this.getCrsaPageByUrl(e));s?(0&&s.loading&&!s.sourceNode?pinegrow.showQuickError("The page is already in the process of being opened..."):(s.show(!0),o&&s.scrollToHash(o)),t&&t(s,!1)):($("body").trigger("crsa-page-changing"),this.openPage(e,function(e){t&&t(e,!0)},r,n,i))},this.showOpenUrlDialogAndOpenPage=function(n,e){pinegrow.showOpenUrlDialog(function(r){pinegrow.openOrShowPage(r,function(e){var t=pinegrow.getCurrentProject();t?t.addRemoteUrl(r):recentFiles.add(r),n&&n(e)})},e)},this.showPageWrapperDialog=function(t,e,n,r){var i=pinegrow.getCurrentProjectInfo(),o=(r=r||pinegrow.getCrsaPageByUrl(t),{url:{type:"text",name:"URL of the page",value:i.getSettingForUrl(t,"wrapper_url"),helptext:isApp()?`<p>Absolute URL of the wrapper page.</p>`:`<p>Absolute or relative URL of the wrapper page. The URL should be on the same domain or allow cross-domain access.</p>`,validate:function(e,t,r){if(n&&!r)return"Wrapper URL is required."}},selector:{type:"text",name:"CSS selector of the target element",value:i.getSettingForUrl(t,"wrapper_selector"),helptext:`<p>A CSS selector of the HTML element on the wrapper page where the document should be displayed.</p>`,validate:function(e,t,r){},placeholder:"default: article, main, body"}});pinegrow.showQuickDialog("Open in a wrapper","Wrapper page",(e||"")+`<p>Select the URL of the page that will be used as a wrapper for opening this document.</p>`,o,"Cancel","Save"+(n?" &amp; Open":""),function(){},function(e){return i.setSettingForUrl(t,"wrapper_url",e.url),i.setSettingForUrl(t,"wrapper_selector",e.selector),i.save(),n&&(r?r.askClose(function(){pinegrow.openOrShowPage(t,null,void 0,null,{open_with_wrapper:!0})}):pinegrow.openOrShowPage(t,null,void 0,null,{open_with_wrapper:!0})),!0},!0)},0),b=(this.openExample=function(e){var t=new PgFramework("pg.example."+P++,"Example"),r=pgMakeFileUrl(crsaGetBaseForUrl(window.location.href)+e);t.addTemplateProjectFromResourceFolder(crsaMakeFileFromUrl(crsaGetBaseForUrl(r)),function(t){pinegrow.openOrShowPage(r,function(e){e.setLocalFile(null),(e.crsaProjectTemplate=t).framework=null})},0,null,!0,!0)},this.duplicatePage=function(t){t.duplicate();$.fn.crsa("openPage",t.url,function(e){},function(e){},null,null,null,function(e){e.callFrameworkHandler("on_page_cloned",t)})},this.reloadPage=function(e){e.changed?showAlert("This page has unsaved changes. Are you sure you want to reload it?","Page has unsaved changes","Cancel","Reload",null,function(){$.fn.crsa("reloadPage",e,!1)}):$.fn.crsa("reloadPage",e,!1)},this.showPage=function(e){e.show(!0)},this.getAllPages=function(){return $.fn.crsapages("getAllPages")},this.getAllPageViews=function(){var t=[];return this.getAllPages().forEach(function(e){e.getPageViews().forEach(function(e){t.push(e)})}),t},this.getCrsaPageById=function(e){for(var t=$.fn.crsapages("getAllPages"),r=0;r<t.length;r++)if(t[r].uid==e)return t[r];return null},this.getPageViewById=function(e){for(var t=$.fn.crsapages("getAllPages"),r=0;r<t.length;r++){var n=t[r].getPageViewById(e);if(n)return n}return null},this.getCrsaPageByUrl=function(e){for(var t=$.fn.crsapages("getAllPages"),r=pgDecodeUrl(e),n=0;n<t.length;n++){if(t[n].url===e||t[n].url===r)return t[n];if(t[n].mappedRemote)if(pinegrow.getRemoteUrlFromMappedUrl(e)===t[n].url)return t[n]}return null},this.getSourceNodeOfUrl=function(e,t,r,n){n=n||{};function i(e){return r&&e.assignIdAndAddToCatalog(!0),e}var o=this.getCrsaPageByUrl(e);if(o&&o.sourceNode)return n.page=o,i(t?o.sourceNode.clone(!0):o.sourceNode);o=pinegrow.getCurrentProject();if(o){var s=o.getBackgroundPageForUrl(e);if(s)return s.onlyCode?((l=new pgParser).assignIds=r,l.parse(s.getCode()),l.rootNode):(n.page=s,i(t?s.sourceNode.clone():s.sourceNode))}if(isApp()){var a,l,s=crsaMakeFileFromUrl(e),c=require("fs");try{if(c.existsSync(s))return a=c.readFileSync(s).toString("utf8"),n.html=a,n.skip_parse_if_html_equal&&n.skip_parse_if_html_equal===a?(n.parse_skipped=!0,null):((l=new pgParser).assignIds=r,l.parse(a),pinegrow.dispatchEvent("on_got_source_node_of_url_from_file",null,l.rootNode,e),l.rootNode)}catch(e){}}else if(null!==(a=o.getContentOfUrlWithLookup(e)))return n.html=a,n.skip_parse_if_html_equal&&n.skip_parse_if_html_equal===a?(n.parse_skipped=!0,null):((l=new pgParser).assignIds=r,l.parse(a),l.rootNode);return null},this.getCrsaPageForUrl=function(e,t){var r=pinegrow.getCurrentProject(),n=this.getCrsaPageByUrl(e);return n||((n=new CrsaPage(!0)).fromFile(r&&r.loaded_from_backend?e:crsaMakeFileFromUrl(e)),t&&(r=pinegrow.getCurrentProject())&&r.addBackgroundPage(n)),n},this.getWorkingDir=function(){var e=pinegrow.getCurrentProject();return e?e.currentWorkingDir||e.getDir():(e=pinegrow.getSelectedPage())&&e.localFile?require("path").dirname(e.localFile):null},this.setWorkingDir=function(e){var t=pinegrow.getCurrentProject();t&&(t.currentWorkingDir=e)},this.getCrsaPageOfPgParserNode=function(e){for(var t=$.fn.crsapages("getAllPages"),r=0;r<t.length;r++)if(t[r].sourceNode==e.document)return t[r];return e.page||null},this.isElementLocked=function(e,t){return!!(t=t||this.getCrsaPageOfPgParserNode(e))&&t.callFrameworkHandler("on_is_element_locked",e)},this.willChangeDom=function(){crsaWillChangeDom()},this.showUIPanel=function(e,t,r,n,i){var o=pgUIViewManager.getView(e);return o&&(o.showInUI(t,r,i),n)&&pgRevealElement(o.getTab().element),o},this.isUIPanelVisible=function(e){var t=pgUIViewManager.getView(e);return!!t&&t.isVisible()},this.hideUIPanel=function(e){var t=pgUIViewManager.getView(e);t&&t.hideInUI()},this.isHiddenUIPanel=function(e){var t=pgUIViewManager.getView(e);return!t||t.isHiddenInUI()},this.undoShowUIPanel=function(e){var t=pgUIViewManager.getView(e);return t&&t.undoShowInUI(),t},this.setNeedsUpdate=function(e,t){$.fn.crsa("setNeedsUpdate",t,e)},this.updateTree=function(e){this.updateTreeMultiple([e])},this.updateTreeMultiple=function(e){},this.updateTreeLine=function(e){},this.repaintTree=function(){},null),S=(this.setSelectedPageTab=function(e){var t;(b=e)?(t=e.getPage()).$iframe&&pinegrow.setSelectedPage(t):pinegrow.setSelectedPage(null)},this.getSelectedPageTab=function(){return b},this.getSelectedPage=function(){return $.fn.crsa("getSelectedCrsaPage")},this.setSelectedPage=function(e){return $.fn.crsa("setSelectedPage",e)},this.isElementSelected=function(e){return e instanceof pgParserNode?this.selectedElements.isSelectedElement(e):(console.error("pgParserNode expected"),!1)},this.isDescendantSelected=function(e){return e instanceof pgParserNode?this.selectedElements.isDescendantSelected(e):(console.error("pgParserNode expected"),!1)},this.isElementOrDescendantSelected=function(e){return this.isElementSelected(e)||this.isDescendantSelected(e)},this.getUniqueSelectorOfPgel=function(e){return e.getAttr("data-pg-sel")},this.assignUniqueSelectorToPgel=function(e,t,r){var n,i,o="data-pg-sel",s=e.getAttr(o);return s&&!r?s:(s=e.getUniqueSelectors(0,9999,e.document,!0),n=s.length?s[0]:null,i=function(){e.setAttribute(o,n),e.setAttribute(o+"-auto",null)},n&&(t?pinegrow.makeChanges(e,"string"!=typeof t?"Auto selector":t,function(){i()}):i()),n)},this.assignNameToPgel=function(e,t){var r="data-pg-name",n=e.getAttr(r);if(n)return n;var i=null,n=e.getPage();if(!(i=n&&(n.callFrameworkHandler("on_get_name_for_element",e,l=[]),l.length)?l[0]:i)){e.tagName.match(/^h[1-6]$/i)&&(i=`Heading `+e.tagName.replace("h",""));for(var o=null,s=0,a=e.parent;a&&s<4;){if((h=a.getAttr(r))&&["body","html"].indexOf(a.tagName)<0){o=h;break}s++,a=e.parent}switch(e.tagName){case"html":i="HTML Element";break;case"body":i="BODY Element"}var l={img:"Image",p:"Paragraph",a:"Link"};if(!i){var c=l[e.tagName]||e.tagName.charAt(0).toUpperCase()+e.tagName.slice(1),n=n.getMainType(e),u=(n&&(c=l[c=(l=n.name_short||n.name)!==e.tagName?l:c]||c),o?a:e.document),s=1;do{var h=1<s?c+` `+s:c;if(!u.findOne(`[data-pg-name="${h}"]`)){i=h;break}}while(++s<100)}i=i||c,o&&(i=o+` - `+i),t?pinegrow.makeChanges(e,"string"!=typeof t?"Auto name":t,function(){e.setAttr(r,i)}):e.setAttr(r,i)}},this.clearSelectedElements=function(){this.selectedElements.clear()},this.getSelectedElement=function(){return this.selectedElements.getLastSelected()},this.getSelectedElementName=function(){var e=this.getSelectedElement();if(e)return e.getName()},this.selectElement=function(e,t,r,n,i,o){$.fn.crsa("selectElement",e,t,r,n,i,o)},this.reselectElement=function(){this.selectedElements.reselect()},this.getSelectedRule=function(){return $.fn.crsa("getSelectedRule")},this.isSelectedRule=function(e){return $.fn.crsa("isSelectedRule",e)},this.getSelectedRuleIndices=function(){return $.fn.crsa("getSelectedRuleIndices")},this.getSelectedRuleStylesheet=function(){return $.fn.crsa("getSelectedRuleStylesheet")},this.selectRule=function(e,t){return $.fn.crsa("selectRule",e,null,t)},this.autoSelectRule=function(e,t,r,n){var i=null,o=function(e){if(n&&e===pinegrow.getSelectedRule())return;$.fn.crsa("selectRule",e)},s=null;if(e){var a=e.getData("selectedCssRule");if("none"===a)return o(null),e.setData("selectedCssRule",null),!0;a&&!r&&(s=a.csurl?pgcssh.getNodeFromGlobalId(a):"inline")}if(!s){a=this.getSelectedRule();if(a&&0<=t.indexOf(a))return o(a),!0}function l(){1==t.length||t[0].nodes.length||pinegrow.activeElementStyleWasSelected||t[1].selector&&t[1].selector.startsWith("*")?o(t[0]):o(t[1])}return!!t.length&&("inline"===s?o(t[0]):s&&0<=t.indexOf(s)&&!s.selector.startsWith("*")?o(s):i&&(a=i.data||i,0<=t.indexOf(a))?o(a):l(),!0)},this.getSelectedRuleForPgel=function(n,i){var o,e=this.getSelectedRule();e?i(e):(o=this,pinegrow.pgActiveRules.clear(),pinegrow.pgActiveRules.setPgel(n),pinegrow.pgActiveRules.updateMatchedRules(!0,function(e){var t=pinegrow.pgActiveRules.getActiveNodes(),r=[];t.inline_rules.forEach(function(e){r.push(e)}),t.nodes_to_show.forEach(function(e){r.push(e.node)}),o.autoSelectRule(n,r,!1),i(o.getSelectedRule())}))},this.highlightElement=function(e,t,r){$.fn.crsa("highlightElement",e,t,r)},this.highlightElementInTree=function(t){pinegrow.getTreeViews().forEach(function(e){e.markInsertPositionInTree&&e.markInsertPositionInTree(t,"self")})},this.refreshPageChangedStatusForAllPages=function(t){this.getAllPages().forEach(function(e){e.refreshPageChangedStatus(t)})},this.showContextMenuForElement=function(e,t,r,n){var i,o,s;t.preventDefault(),t.stopPropagation(),e&&(r=r||$(t.delegateTarget),s=pinegrow.selectedElements.isSelectedElement(e),o=pinegrow.getCrsaPageOfPgParserNode(e))&&(t.shiftKey?i=new PgInsertLibElementMenu(e,s?null:e,!0).getActions():(i=$.fn.crsa("getActionsMenuFor",e,s,t),o.callFrameworkHandler("on_build_actions_menu",i,e,s)),o=e.get$DOMElement(),r&&(s=pgGetAppWindowForDOMElement(r.get(0)))&&s.window!==window&&(o=r,n=n||r.closest("body")),(s=new CrsaContextMenu(null,o)).actions=i,s.$target=o,s.targetPgel=e,s.$clicked=r,s.addSmartInput(),s.showAt(t.pageX,t.pageY,n||r.closest("body")),s.updatePosition())},this.showCSSRules=function(e,t,r){$.fn.crsa("showCSSRules",e,t,r)},this.scrollCanvasToElement=function(e){$.fn.crsa("scrollCanvasToElement",e)},this.scrollToElement=function(e){$.fn.crsa("scrollCanvasToElement",e)},this.addPageAction=function(e,t){$.fn.crsapages("addCustomPageAction",e,t)},this.openProjectPanelIfNoPageOpen=function(){setTimeout(function(){pinegrow.getCurrentProject()&&0===pinegrow.getAllPages().length&&pinegrow.showTab("project")},500)},this.showTab=function(e){var t=pgUIViewManager.getView(e);t&&t.showInUI()},this.formatHtml=function(e){var t=new pgParser;return t.assignIds=!1,t.parse(e),t.rootNode.toStringOriginal(!0,this.getFormatHtmlOptions())},this.getFormatHtmlOptions=function(){var e=new Array(parseInt(pinegrow.getSetting("html-indent-size","4"))+1).join(" ");return{indent:e="1"==pinegrow.getSetting("html-indent-tabs","0")?"\t":e}},null),k=(this.getQuickLibWindow=function(){return S},this.showQuickInsert=function(e,t,r,n){return e=e||pinegrow.selectedElements.getLastSelected(),S?(S.lib.setInsertInfo(e),S.show(!0,t)):S=new PgQuickPageLib(e,"append",t,r,n),S},this.populateCodeMirrorOptions=function(e){return e.theme=pinegrow.getSetting("code-theme-cm",pinegrow.defaults.codeTheme),e.indentUnit=parseInt(pinegrow.getSetting("html-indent-size","4")),e.tabSize=e.indentUnit,e.indentWithTabs="1"==pinegrow.getSetting("html-indent-tabs","0"),e.extraKeys={"Ctrl-Q":function(e){e.foldCode(e.getCursor())},"Ctrl-Space":"autocomplete","Ctrl-U":function(){},"Cmd-U":function(){},"Ctrl-Z":function(){},"Cmd-Z":function(){}},e.undoDepth=0,e},this.getCodeMirrorLintOptions=function(){return{options:{rules:{"tagname-lowercase":!0,"attr-lowercase":!0,"attr-value-double-quotes":!1,"doctype-first":!1,"tag-pair":!0,"spec-char-escape":!0,"id-unique":!0,"src-not-empty":!0,"attr-no-duplication":!0}}}},this.getHtmlIndentForLevel=function(e,t){t=t||this.getFormatHtmlOptions();for(var r="",n=0;n<e;n++)r+=t.indent;return r},this.setIgnoreClicks=function(e){n=e},this.getIgnoreClicks=function(){return n},this.getUniqueId=function(e){return getUniqueId(e)},this.showNotice=function(e,t,r,n,i,o,s,a,l,c,u){showNotice(e,t,r,n,i,o,s,a,l,c,u)},this.showAlert=function(e,t,r,n,i,o,s,a){return showAlert(e,t,r,n,i,o,s,a)},this.showAlertWithPromise=async function(t,r,n,i){return new Promise(function(e){u.showAlert(t,r,n,i,function(){e(!1)},function(){e(!0)})})},this.addLeftButton=function(t,e,r){$('<a href="#" class="btn pull-left">'+e+"</a>").appendTo(t.find(".modal-footer")).on("click",function(e){e.preventDefault(),t.modal("hide"),r()})},this.alert=function(e,t){return this.showAlert(e,t||"Alert",null,"OK").css("z-index",2e3)},this.showEnterUrlPrompt=function(r,e,t){return showPrompt("Page url:",e||"Open page from url",null,"https://pinegrow.com",null,function(e){var t;e&&(e.indexOf("://")<0&&(e="http://"+e),(t=document.createElement("a")).href=e,e=t.href,t=null,r(e))},null,null,t)},this.showOpenUrlDialog=function(r,e){var n=pinegrow.isPRO()||pinegrow.isProTrialActive(),t=showPrompt("URL of the remote page or your local web server:","Open URL",e||null,"https://pinegrow.com",null,function(e){if(!e)return pinegrow.showQuickError("Please enter a valid URL."),!1;e.indexOf("://")<0&&(e="http://"+e);var t=document.createElement("a");t.href=e,e=t.href,t=null;try{new URL(e);if(n&&!pinegrow.getCurrentProject())return pinegrow.showQuickError("Please select a folder for saving changed remote files."),!1;r(e)}catch(e){}},"Cancel","Open URL"),i=t.find(".modal-body"),o=$("<div></div>").appendTo(i),s=function(){var e,t,r=pinegrow.getCurrentProject();n?(t="",e=`<p>That means that:</p><ul>
<li>Changed HTML documents and CSS stylesheets will be saved to the project folder.</li>
<li>Any such files that have been previously saved to this project will be loaded from the project.</li>
</ul>
<p><a href="${pgf.docs.remote_url_help}" class="external"><b>Check out this guide</b></a> to learn more about how you can edit remote projects and web applications with Pinegrow Web Editor.</p>`,t=r?t+`<p>This remote page <b>will be mapped to the current project</b> <code>${r.getDir()}</code>.</p>`+e:(t+=`<p>Select a folder/project that you wish to use for mapping changed remote files:</p><p><button class="pg-button pg-button-primary select-folder">Select a folder for saving changed remote files...</button></p>`)+`<p>The remote document is mapped to a local folder/project, so that you can easily save and reload edited HTML document and CSS stylesheets.</p>`+e,o.html(t),o.find(".select-folder").on("click",function(e){e.preventDefault(),pinegrow.openProjectBySelectingFolder(function(){s()})})):o.html("<p>NOTE: <b>If you want to save changes</b> it is recommended to first save the page locally (for example, with &quot;Save as complete page&quot; in your browser) and then open it with <b>Open file</b>.</p>")};return s(),t},this.showHelpImage=function(e){return'<img class="help-image" src="images/help/'+e+'">'},this.showPrompt=function(e,t,r,n,i,o,s,a,l,c,u,h){showPrompt(e,t,r,n,i,o,s,a,l,c,u,h)},this.showQuickDialog=function(e,t,r,n,i,o,s,a,l,c){function u(e,t,r,n,i,o){return r?null:pinegrow.getValidationError(n.name,"req")}var h=new PgDialog(e),p=(h.values={},h.okButtonLabel=o||h.okButtonLabel,h.cancelButtonLabel=i||h.cancelButtonLabel,h.validate_on_submit=l||!1,h.non_modal=c||!1,"_none_"===i&&(h.cancelButtonLabel=null),"_none_"===o&&(h.okButtonLabel=null),h.before=r,h.sections={inputs:{name:t,is_closable:!1,fields:{}}},"inputs");return $.each(n,function(e,t){var r=$.extend({type:"text"},t);r.start_section&&(h.sections[r.start_section]={name:r.start_section,is_closable:!1,fields:{}},p=r.start_section),(h.sections[p].fields[e]=r).required&&(r.validate=u),"checkbox"===r.type?h.values[e]=t.default_value||null:h.values[e]=t.value||null}),h.onOK=function(e){if(a)return a(h.values,h,e)},h.onCancel=function(){s&&s()},h.show(),h},this.quickEditProperties=function(e,t,i,n){n=n||{};function r(e){$.each(e,function(e,t){$.each(t.fields,function(r,e){e.skip_did_change=!0,e.skip_page_changed=!0,e.show_if_on_input=!0,e.show_if_selector=".pg-grid","function"==typeof e.options&&(e.fill_list_on_open=!0),e.validate_on_global_change&&!e.show_if&&(e.show_if=!0),"image"===e.type&&(e.file_picker_use_image_menu=!0),e.required&&(e.validate=function(e,t,r,n,i,o){var s=!0;if("string"==typeof n.required&&(s=crsaEvaluateShowIfString(n.required,o,n,e)),(s="function"==typeof n.required?n.required(t,r,o,n):s)&&(null===r||""===r))return"Field is required"}),e.action="custom",e.get_value=function(e,t,r,n){return i[t]||null},e.set_value=function(e,t){return i[r]=t,n.onValueChanged&&n.onValueChanged(r,t),t}})})}var o=new PgComponentType("pg.quick.edit.props","Quick Edit Props",{selector:null,not_main_type:!0,sections:e}),s=pgCreate("<dummy></dummy>"),a=(r(e),PgQuickProperties(Object.values(e),s,n.target||null,t,n.height||500,!0,n.add_autosize||120,[o],!0));return a.setSections=function(e){r(e),o.sections=e,a.propertiesView.updateShowProps(Object.values(e),[o])},a.$element.addClass("pg-grid-force-show-section-titles"),a},this.openFindAndReplace=function(e){(new PgActionFind).editArgumentsAndRunAction(e)},{});this.showQuickMessage=function(e,t,r,n,i){if(i){var o=(new Date).getTime();if(k[e]&&o-k[e]<i)return;k[e]=o}return crsaQuickMessage(e,t,r,n)},this.showQuickError=function(e,t,r){return crsaQuickMessage(e,r||4e3,t,"error")},this.showMode=function(e,t){pinegrow.showQuickMessage(e+": "+(t?"ON":"OFF"))},this.showViewInDialog=function(e,t,r){var n=pinegrow.showAlert(t+'<div class="view-container"></div>',e,"Close",null,function(){r.destroy()});return n.find(".view-container").append(r.get$Element()),r.setAlwaysVisible(!0),n},this.showDialogMenu=function(e,t,r,n){var i=``,i=(t&&(i+=t),this.showAlert(i+=`<div class="illustrated-menu"></div>`,e,"Close",null));return i.addClass("pg-illustrated-menu-dialog"),this.showIllustratedMenu(i.find(".illustrated-menu"),r,i),n&&i.find(".modal-footer,button.close").remove(),i},this.showIllustratedMenu=function(e,r,n){var t=``;t+=`<ul class="pg-dialog-menu-list">`;for(var i=0;i<r.length;i++)r[i].url&&!isApp()&&(t+=`<a href="${r[i].url}" target="_blank" class="external">`),t=(t=(t+=`<li data-idx="${i}" class="${r[i].class||""} ${r[i].url&&!isApp()?"":"handle-click"}">`)+pgSVGIcons.pg_logo)+`${r[i].icon}<h4>${r[i].label}</h4><p>${r[i].desc}</p>`+`</li>`,r[i].url&&!isApp()&&(t+=`</a>`);e.html(t+=`</ul>`),e.on("click",".pg-dialog-menu-list li.handle-click",function(e){var t=r[parseInt(this.getAttribute("data-idx"))];if(t.url)return isApp()?(pinegrow.openExternalUrl(t.url),void e.preventDefault()):void 0;e.preventDefault(),t.action(function(e){!1!==e&&n&&n.modal("hide")})})},this.isClassTreeSupported=function(){var e=pinegrow.getSelectedPage();return e&&e.findFrameworkOfType("tailwind")},this.showClassTree=function(e){var t=pinegrow.getSelectedPage().findFrameworkOfType("tailwind");t&&(e?new PgQuickClassTree:t.twSwitchToClassTree())},this.showVisualControlsInPropsPanel=function(e){var t=(e=e||pinegrow.selectedElements.getLastSelected()).getPage().findFrameworkOfType("tailwind");t&&(pinegrow.selectedElements.isSelectedElement(e)?t.twSwitchToVisualControls():(t.twSwitchToVisualControls(!0),pinegrow.selectElement(e)))},this.quitPinegrow=function(){require("nw.gui").Window.get().close()},this.restartPinegrow=function(e){var t,r;e?(r=``+("string"==typeof e?e:"<p>Please reload Pinegrow to continue.</p>"),t="Reload now",crsaHasChanges()&&(r+=`<p>Please note that the editor <b>contains unsaved changes that will be lost</b> if you reload it now.</p>`,t="Reload now and lose unsaved changes"),pinegrow.showAlert(r,"Reload is needed","Later",t,function(){},function(){pinegrow.restartPinegrow()})):(r=function(){pinegrow.getAllPages().forEach(function(e){e.allowReload=!0}),(isApp()?nw.Window.get():location).reload()},isApp()&&pinegrow.devTools?pinegrow.devTools.detach(r):r())},this.showCreateCssRule=function(e){this.showUIPanel("style"),pinegrow.activeCSSView.showCreateCssRule(e)};function F(e,r){var n;return r?(n=[],e.forEach(function(e){var t;switch(r){case"previous":t=e.prev()||e.parent.last();case"next":t=e.next()||e.parent.first();break;case"first":t=e.parent.first();break;case"last":t=e.parent.last()}n.indexOf(t)<0&&n.push(t)}),n):e}this.showLeftPanel=function(){e(!0)},this.hideLeftPanel=function(){e(!1)},this.evaluateUserVars=function(e,t){var r,n,i=[];return e&&(r=null,n=e.replace(/\$\{(.*)\}/g,function(e,t){if(null===r&&(r={},pinegrow.getSetting("user-vars","").split("\n").forEach(function(e){var t=(e=$.trim(e)).split("=");2==t.length&&(r[t[0].trim()]=t[1].trim())})),t in r)return r[t];i.push(t)}),i.length&&!t?(pinegrow.showAlert(`<p>The following user variables are not defined: ${i.join(", ")}.</p><p><b>Use Support -&gt; Settings -&gt; Define user variables</b> to define these variables.</p>`,"Missing user variables"),null):n)},this.openExternalUrl=function(e){require("nw.gui").Shell.openExternal(e)},this.addActionToElementForPreview=function(e,t,r){$.fn.crsa("addActionToElementForPreview",e,t,r)},this.hasElementAction=function(e,t){$.fn.crsa("hasElementAction",e,t)},this.showPreview=function(e,t,r,n,i){$.fn.crsa("showPreview",e,t,r,n,i)},this.hidePreview=function(){$.fn.crsa("hidePreview")},this.getValidationError=function(e,t){return"req"!==t?e+" has invalid value":e+" is required."},this.validateField=function(e,t,r,n,i,o){var s,a;return!n||!n.validate||(s=n.validate(e,t,r,n,i,o),i&&(a=i.data("error_msg"),s?(a||(a=i.find("> p.error-message"),i.data("error_msg",a)),a.get(0).innerHTML===s&&a.pgIsVisible||fastdom.mutate(function(){a.get(0).innerHTML=s,a.pgIsVisible||(i.addClass("error"),pg$Show(a),a.pgIsVisible=!0),i.hasClass("has-error")||i.addClass("has-error")})):(i.hasClass("has-error")&&i.removeClass("has-error"),a&&a.pgIsVisible&&fastdom.mutate(function(){i.removeClass("error"),pg$Hide(a),a.pgIsVisible=!1,i.hasClass("has-error")&&i.removeClass("has-error")}))),null==s)||""===s},this.validateAllFields=function(e,o,s,a){var l=!0;return e.find(".crsa-field").each(function(e,t){var r=$(t),n=r.data("crsa-field"),i=r.data("crsa-field-def");a&&!1===a(n,i)||(l=l&&pinegrow.validateField(o,n,s.hasOwnProperty(n)?s[n]:null,i,r,s))}),l},this.getPgelFromSelector=function(e,t,r,n){var i=this.getPgelFromSelectorMultiple(e,t,!0,n);return i.length?i[0]:r},this.getPgelFromSelectorMultiple=function(e,t,r,n){if(t&&e){var i=t.split("->");i[1];if("this"===(t=i[0]))return F([e]);var o,s,i=e;if(t.startsWith("$"))i=e.document,t=t.substr(1);else if(t.startsWith("^"))return o=t.substr(1).split("|"),(s=e.closest(o[0].trim()))?F(1===o.length?[s]:this.getPgelFromSelectorMultiple(s,o[1].trim(),r,n)):[];if(n){var a=[];try{(i===e.document?e.getPage().get$Html():i.get$DOMElement()).find(t).each(function(e,t){var r=getDomElementPgNode(t);r&&a.push(r)})}catch(e){}}else{a=r?i.findOne(t):i.find(t);r&&(a=a?[a]:[])}return F(a)}return[]},this.getSelectorFieldOptions=function(o,s,a,l){s=$.extend({max_depth:9999,multiple:!1,parents:!1},s||{});var c=[{key:null,label:"Not set",action:a,check:null===l||""===l}];if(s.parents){for(;p.parent&&p.parent.isElement;)p=p.parent,parents.push({label:p.getName({short:!0}),pgel:p,action:select,on_mouseleave:on_mouseleave,on_mouseenter:on_mouseenter});parents.length&&parents.unshift({type:"header",label:"Parents"})}var u=null,h=[];return l&&(u=pinegrow.getPgelFromSelector(o,l),h=s.multiple?pinegrow.getPgelFromSelectorMultiple(o,l):[u]),o.walkSelfAndChildren(function(e,t){var r,n,i;return!(t>s.max_depth||s.must_contain_or_be&&!e.isSelector(s.must_contain_or_be)&&!e.findOne(s.must_contain_or_be)||(!e.isElement||s.filter&&!s.filter(e)||(e.getPlainTextName({short:!1}),r=e.getName({short:!1}),(n=e.getAttr("data-pg-name"))&&(r=n+" | "+r),n=e===o?"this":null,i=null,s.multiple&&"this"!==n&&((i=[]).push({type:"header",label:"Select all elements with:"}),i.push({label:e.tagName,key:e.tagName,action:a,check:e.tagName===l}),e.getClasses().forEach(function(e){var t;"pg-empty-placeholder"!==e&&i.push({label:t="."+e,key:t,action:a,check:t===l})})),c.push({key:n,pgel_node:e,label:e===o?"current element":`<span style="width:${15*t}px;display:inline-block;"></span>`+r,action:function(){var e;this.key||(e=this.pgel_node.getUniqueSelectors(0,9999,o,!0)).length&&(this.key=e[0]),a.call(this)},check:u===e&&1===h.length,submenu:i})),0))}),c},this.willMakeChange=function(e,t,r){willMakeChange(e.$iframe,t?r+" / "+getElementName(t):r)},this.makeChanges=function(e,t,r,n){r(),e instanceof CrsaPage||e instanceof PgEmulatePageForUndo?pinegrow.changeManager.didChangePage(e,t,n):pinegrow.changeManager.didChange(e,t,n)},this.getDefaultStylesheet=function(e,t,r,n){var i,o,s=pgcssh.getUrlOfStylesheetForOverrides(e),a=!1;return(s=s&&!(i=pinegrow.stylesheets.getByUrl(s))?null:s)||(e=e||pinegrow.getSelectedPage())&&(o=e.getAttachedStylesheets({loaded:!0,ignored:!1,imported:!1,inline:!1,remote:!1})).length&&(s=o[o.length-1].url,a=!0),s?(i=i||pinegrow.stylesheets.getByUrl(s))?i.loaded||n?t(i,a):(i.ignore=!1,i.load(i.url,function(){t(i,a)},!0)):(r&&pinegrow.showAlert("Default stylesheet with "+csurl+" not found or not loaded!","Error"),t(null)):t(null),i},this.setDefaultStylesheet=function(e,t){t&&(pgcssh.setUrlOfStylesheetForOverrides(t.url,e),pinegrow.dispatchEvent("on_default_stylesheet_selected",e,t))};var C=[],E=(this.addPluginControlToTopbar=function(e,t,r,n){var i=$(".main-menu .insert-custom-here"),i=(t.insertBefore(i),C.push({framework:e,control:t,show_always:r,func:n}),!!n&&n());r||i||t.hide()},this.updatePluginControlsForSelectedPage=function(e){E(e)},function(e){for(var t=!1,r=0;r<C.length;r++)C[r].show_always||(C[r].func&&C[r].func(),C[r].func?C[r].func()?C[r].control.css("display",""):C[r].control.css("display","none"):e&&e.hasFramework(C[r].framework)?C[r].control.css("display",""):C[r].control.css("display","none"),t=!0);t&&arrangeTopBarSizes()}),U=($("body").on("crsa-page-selected crsa-frameworks-changed",function(e,t){t=t||pinegrow.getSelectedPage(),E(t)}),this.showBuyProductScreen=function(e){$.fn.crsa("showIntroScreen",e)},this.takePhotoOfUI=function(c,u,e){var t=require("nw.gui");e=e||t.Window.get(),setTimeout(function(){var a=$(window).width(),l=$(window).height();e.capturePage(function(t){try{var r=new window.Image,n=$(window).width(),i=$(window).height(),o=document.createElement("canvas"),s=(o.setAttribute("width",n),o.setAttribute("height",i),o.getContext("2d"));r.addEventListener("load",function(){s.drawImage(r,0,0,n,i);var e=null;u&&(e=s.getImageData(0,0,a,l).data),c&&c(o,e,t)},!1),r.src=t}catch(e){}},{format:"png",datatype:"datauri"})},100)},this.takePhotoOfPage=function(t,d,f,e,m){var r,n,i,o,s,w;t.$page?(r=require("nw.gui").Window.get(),n=t.$page.find(">.content"),i=n.find("> iframe, > webview"),o=n.offset(),i.css("z-index",10),s=window.innerWidth/document.body.clientWidth,t.removeCrsaStyles(),(w=$("body")).addClass("hide-quick-messages"),setTimeout(function(){var c=o.left*s,u=o.top*s,h=n.width()*s,p=n.height()*s,g=e&&e<h?1*e/h:1;r.capturePage(function(e){try{w.removeClass("hide-quick-messages");t.addCrsaStyles();var s=document.createElement("canvas"),a=(s.setAttribute("width",h),s.setAttribute("height",p),s.getContext("2d")),l=new window.Image;l.addEventListener("load",function(){var e,t,r,n,i,o;e=l,t=function(e){a.drawImage(e,c,u,h,p,0,0,h,p);var t=g<1?downScaleCanvas(s,g):s,r=(d&&(crsaCreateDirs(crsaGetDir(d)),r=(r=t.toDataURL("image/png")).replace("data:image/png;base64,",""),r=new Buffer(r,"base64"),require("fs").writeFileSync(d,r)),null);m&&(r=a.getImageData(0,0,h,p).data),f&&f(t,r)},i=$(window).width(),o=$(window).height(),i<e.width?((r=document.createElement("canvas")).setAttribute("width",i),r.setAttribute("height",o),r.getContext("2d").drawImage(e,0,0,e.width,e.height,0,0,i,o),(n=new window.Image).addEventListener("load",function(){t&&t(n)},!1),n.src=r.toDataURL("image/png")):t&&t(e)},!1),l.src=e}catch(e){f&&f(null)}i.css("z-index","")},{format:"png",datatype:"datauri"})},100)):f&&f(null)},this.takePhotoOfElement=function(e,t,d,f){var r=require("nw.gui").Window.get(),n=getIframeOfElement(e),i=(n.closest(".page"),n.css("z-index",10),crsaScrollToElementInIframe(n,e),getElementPositionOnScreen(e,n)),o=getCrsaPageForIframe(n),s=window.innerWidth/document.body.clientWidth;o.removeCrsaStyles(),setTimeout(function(){var c=i.left*s,u=i.top*s,h=i.width*s,p=i.height*s,g=t&&t<h?1*t/h:1;r.capturePage(function(e){try{o.addCrsaStyles();var s=document.createElement("canvas"),a=(s.setAttribute("width",h),s.setAttribute("height",p),s.getContext("2d")),l=new window.Image;l.addEventListener("load",function(){var e,t,r,n,i,o;e=l,t=function(e){a.drawImage(e,c,u,h,p,0,0,h,p);var t,r=g<1?downScaleCanvas(s,g):s;d&&(t=(t=r.toDataURL("image/png")).replace("data:image/png;base64,",""),t=new Buffer(t,"base64"),require("fs").writeFileSync(d,t)),f&&f(r)},i=$(window).width(),o=$(window).height(),i<e.width?((r=document.createElement("canvas")).setAttribute("width",i),r.setAttribute("height",o),r.getContext("2d").drawImage(e,0,0,e.width,e.height,0,0,i,o),(n=new window.Image).addEventListener("load",function(){t&&t(n)},!1),n.src=r.toDataURL("image/png")):t&&t(e)},!1),l.src=e}catch(e){}n.css("z-index","")},{format:"png",datatype:"datauri"})},250)},null),T=null,A=(this.setWorkspaceTheme=function(t,e){if(!pgf.kids){var r,n,i,o,s,a,l;if("WPPLUGIN"===pgf.product)return pinegrow.startScreenManager&&pinegrow.startScreenManager.isVisible()&&(t="light",e=!0),e&&U===t?void 0:(r=function(e,t){e.sheet?t(e.sheet):$(e).on("load",function(){e.sheet&&t(e.sheet)})},T||(i="1",pgwpdata.version&&(i=pgwpdata.version),o=$("head"),(n=$('<link href="lib/crsa/edit.theme.light.css?v='+i+'" rel="stylesheet" class="pg-light-theme">')).appendTo(o),(i=$('<link href="lib/crsa/edit.theme.gray.css?v='+i+'" rel="stylesheet" class="pg-gray-theme">')).appendTo(o),T={light:n.get(0),gray:i.get(0)}),r((o=T).light,function(e){e.disabled="light"!==t}),r(o.gray,function(e){e.disabled="light"===t}),(s=$(".pg-splash-screen")).length&&((a=$(".pg-splash-screen-sensor")).length?l=setInterval(function(){a.is(":visible")&&(clearInterval(l),s.css("opacity",0),setTimeout(function(){arrangeTopBarSizes(),s.remove()},300))},200):$(".pg-splash-screen").remove()),void(e||this.setSetting("workspace-theme",t)));this.setSetting("workspace-theme",t),pgGetAppWindows().forEach(function(e){u.activateCurrentWorkspaceThemeInWindow(e)}),"WPPLUGIN"!==pgf.product&&pinegrow.updateStartScreen()}},this.activateCurrentWorkspaceThemeInWindow=function(e){var t,r,n,i="workspacetheme",o="lib/crsa/edit.theme."+this.getWorkspaceTheme()+".css",s=$(e.window.document).find("body"),a=s.find("."+i);a.attr("href")!==o?($('<link href="'+o+'" rel="stylesheet" class="'+i+'">').appendTo(s),t=$(".pg-splash-screen"),(r=$(".pg-splash-screen-sensor")).length?n=setInterval(function(){r.is(":visible")&&(clearInterval(n),t.css("opacity",0),setTimeout(function(){arrangeTopBarSizes(),t.remove()},300))},200):$(".pg-splash-screen").remove(),setTimeout(function(){a.remove(),$(e.window).trigger("resize")},2e3)):$(".pg-splash-screen").remove()},this.getWorkspaceTheme=function(){var e=this.getSetting("workspace-theme",pgf.default_theme||"gray");return e="high.contrast"===e?"gray":e},!1),I=(this.getShowDisplayHelpers=function(){return A},this.setShowDisplayHelpers=function(e,t){A=e,pinegrow.dispatchEvent("on_show_display_helpers_changed",null,e),pinegrow.helpersToolbarItem.toolbarItem.setActive(e),pinegrow.selectedElements.reselect(),t&&pinegrow.showMode("Show display helpers",e)},this.showPhotoBrowser=function(e){pgShowQuickImageBrowser(e)},this.getPhotoBrowserSearchTerm=function(){return pgQuickImageBrowserSearchTerm},this.getMappedRemoteFileForUrl=function(e,t){if(isApp()&&crsaIsRemoteUrl(e)){var r=pinegrow.getCurrentProject();if(r){var n="data.bin";switch(t){case"html":n="index_default.html";break;case"css":n="style.css"}try{var i=new URL(e),o=i.pathname;return""===o||"/"===o?o=n:o.endsWith("/")&&(o+=n),path.join(r.getDir(),"mapped_urls",i.hostname,decodeURI(o))}catch(e){}}}return null},this.getRemoteUrlFromMappedUrl=function(e){var t=pinegrow.getCurrentProject();if(t){t=t.getUrl()+"/mapped_urls/";if(e.startsWith(t))return e=(e=e.replace(t,"http://")).replace("index_default.html","")}return null},this.getMappedRemoteBaseDirForUrl=function(e){var t=pinegrow.getCurrentProject();if(t)try{var r=new URL(e);return path.join(t.getDir(),"mapped_urls",r.hostname)}catch(e){}return null},null),j="1"===this.getSetting("prop-device-size-sync","0");this.getSyncCurrentDeviceSizeWithPageView=function(){return j},this.setSyncCurrentDeviceSizeWithPageView=function(e){j=e,this.setSetting("prop-device-size-sync",e?"1":"0")},this.setCurrentDeviceSize=function(e,t,r,n){(n||t===this.getSelectedPage()&&r===t.activeView)&&(I=e,this.dispatchEvent("on_current_device_size_changed",t,e))},this.getCurrentDeviceSize=function(){return I},this.getDeviceSizeDefByName=function(e){var t=pinegrow.getSelectedPage().activeView.getDeviceSizes();e=e.toLowerCase();for(var r=0;r<t.length;r++)if(t[r].name.toLowerCase()===e)return t[r]},this.setPseudoStatesForCollection=function(e,t,r){var n=["hover","active","focus","visited"],i=[];t.forEach(function(e){0<=n.indexOf(e)&&i.push(e)});e.forEachElementAsync(function(e,t){pinegrow.devTools.forcePseudoStates(e,i,t),e.get$DOMElements().forEach(function(r){n.forEach(function(e){var t=`pg-state-`+e;0<=i.indexOf(e)?r.addClass(t):r.removeClass(t)})})},function(e){pinegrow.dispatchEvent("on_current_pseudo_state_changed",pinegrow.getSelectedPage(),t),r&&r()})},this.getCurrentClassStyle=function(e){return this.classStyles?this.classStyles.getCurrentStyle():null},this.requireProject=function(e){var t;pinegrow.isPRO()||pinegrow.isProTrialActive()?(t=pinegrow.getCurrentProject())?e(t):pinegrow.showAlert("<p>This feature works with <b>Projects</b>. To use it, open the folder where your pages are located with <b>File -&gt; Open project</b>.</p>","Project is required"):pinegrow.showProductUpgradeMessage("PRO","Pinegrow PRO","Your edition of Pinegrow does not include Pinegrow PRO features. Please upgrade to the PRO edition to continue using projects, master pages and components.")},this.requireProjectDB=function(r){var e=null;return this.requireProject(function(t){e=t.requireDB(function(e){r(e,t)})}),e}},PgFramework=function(e,t){this.key=e,this.name=t,this.show_in_action_tab="ACT",this.detect=null,this.component_types={},this.default=!1,this.lib_sections=[],this.actions_sections=[],this.ignore_css_files=[],this.type=e,this.allow_single_type=!1,this.pluginUrl=null,this.on_get_source=null,this.user_lib=!1,this.changed=!1,this.not_main_types=!1,this.product=null,this.trial=!1,this.trial_start_message="7 day trial was started.",this.trial_expired_message="The trial expired. Please purchase the product to continue using it.",this.common_sections={},this.script_url=null,this.description=null,this.author=null,this.author_link=null,this.has_actions=!1,this.info_badge=null,this.auto_updatable=!1,this.order=0,this.page_libs=[],this.quick_actions=[],this.required_frameworks=[],this.show_in_manager=!0,this.preview_images_base="images",this.resources=new PgResourcesList,this.resources_name=null,this.customResourceNamespace=null,this.loading_components=!1;function l(){if(!s){o.sort(function(e,t){return e.priority-t.priority}),s=!0;for(var e,t,r={tags:{},check_all:[]},n=(c=r,/^([a-z0-9]*)?(\.[a-z0-9\-\_]*)?(\[[a-z\-]*\])?(\[[a-z\-]*="(.*)"\])?$/i),i=0;i<o.length;i++)o[i].selector||o[i].selector_new?(e={index:i,def:o[i]},u.no_type_maps||"function"==typeof o[i].selector||o[i].selector_new?(r.check_all.push(e),0):((t=o[i].selector.match(n))&&(t=t[1])?(r.tags[t]||(r.tags[t]=[]),r.tags[t]):r.check_all).push(e)):0;o.length}}var o=[],s=!1,c=null,r=[],u=(this.has_types_that_filter_tree=!1,this.componentFiltersTree=function(e){r.push(e),this.has_types_that_filter_tree=!0},this.getTypeThatFiltersTree=function(e){for(var t=0;t<r.length;t++)if(h(r[t],null,e,!0))return r[t];return null},this),h=(this.addPageLib=function(e){this.page_libs.push(e)},this.getPageLibs=function(){return this.page_libs},this.addQuickAction=function(e){this.quick_actions.push(e)},this.getQuickActions=function(){return this.quick_actions},this.removeAllComponents=function(){this.component_types={},this.lib_sections=[],this.actions_sections=[],s=!1,o=[]},this.isTrialActive=function(e){return!!pinegrow.isTrial()||(e||pinegrow.showProductUpgradeMessage(this.product,this.name,this.trial_expired_message),!1)},this.addComponentType=function(r){r.selector&&"string"==typeof r.selector&&r.selector.match(/^[a-z]+$/i)&&(r.selector_tag=r.selector.toUpperCase()),(this.component_types[r.type]=r).priority||(r.priority=1e3),(r.framework=this).common_sections&&(r.sections||(r.sections={}),$.each(this.common_sections,function(e,t){r.sections[e]=t})),o.push(r),s=!1},this.removeComponentType=function(e){if(e.type in this.component_types){delete this.component_types[e.type];var t=o.indexOf(e);0<=t&&o.splice(t,1),s=!1;for(var r=0;r<this.lib_sections.length;r++)0<=(t=(n=this.lib_sections[r]).components.indexOf(e))&&n.components.splice(t,1);for(var n,r=0;r<this.actions_sections.length;r++)0<=(t=(n=this.actions_sections[r]).components.indexOf(e))&&n.components.splice(t,1)}},this.replaceComponent=function(e,t){this.component_types[e.type]=t;var r=o.indexOf(e);0<=r&&(o[r]=t);for(var n=0;n<this.lib_sections.length;n++)0<=(r=(i=this.lib_sections[n]).components.indexOf(e))&&(i.components[r]=t);for(var i,n=0;n<this.actions_sections.length;n++)0<=(r=(i=this.actions_sections[n]).components.indexOf(e))&&(i.components[r]=t);t.framework=this},function(e,t,r,n){var i=!1;return(!n||!e.action)&&(e.selector_new?i=e.selector_new(r):"function"==typeof e.selector?i=e.selector(r):e.selector?i=r.isSelector(e.selector):e.selector_tag&&(i=r.tagName===e.selector_tag),i)});this.isType=function(e,t,r,n){return h(e,t,r,n)};this.getType=function(e,t,r){l();for(var n=this.getTypes(e,t,r,!0),i=0;i<n.length;i++)if(!n[i].not_main_type)return n[i];return null},this.getTypes=function(e,t,r,n){l(),void 0===n&&(n=!1);var i=[],o=[],s=t?t.tagName:e[0].tagName.toLowerCase();if(s&&c.tags[s])for(var a=0;a<c.tags[s].length&&(!h(c.tags[s][a].def,e,t,r)||(o.push(c.tags[s][a]),!n));a++);for(a=0;a<c.check_all.length&&(!h(c.check_all[a].def,e,t,r)||(o.push(c.check_all[a]),!n));a++);o.sort(function(e,t){return e.index-t.index});for(a=0;a<o.length&&(i.push(o[a].def),!o[a].def.last_type);a++);return i},this.getComponentTypes=function(){return this.component_types},this.getComponentType=function(e){return this.component_types[e]||null},this.addLibSection=function(e){this.lib_sections.push(e),e.framework=this},this.getLibSections=function(){return this.lib_sections},this.getLibSection=function(e){for(var t in this.lib_sections)if(this.lib_sections[t].key==e)return this.lib_sections[t];return null},this.addActionsSection=function(e){this.actions_sections.push(e),e.framework=this},this.getActionsSections=function(){return this.actions_sections},this.getAutoId=function(e){for(var t,r=0;(t=e+(0<++r?r:""))in this.component_types;);return{count:r,type:t}},this.getFileName=function(){return this.pluginUrl?getPageName(this.pluginUrl):this.name.replace(/\s/gi,"")+".js"},this.getImagePreviewBaseUrl=function(){return this.getBaseUrl()+"/"+this.preview_images_base+"/"},this.getBaseUrl=function(){return this.project?crsaMakeUrlFromFile(this.project.getDir()):crsaGetBaseForUrl(this.pluginUrl||this.script_url)},this.getResourceUrl=function(e){return(this.getBaseUrl()+"/"+e).replace(/\/\.\//g,"/")},this.getResourceFile=function(e){return crsaMakeFileFromUrl(this.getResourceUrl(e))},this.setScriptFileByScriptTagId=function(e,t){var r=$("#"+e);(r=0===r.length&&!isApp()&&t?$(`script[src*="${t}"]`):r).length?isApp()?this.script_url=pgMakeFileUrl(r.get(0).src):this.script_url=r.get(0).src:t&&isApp()&&(pgIsLive()?this.script_url=t:(r=require("path"),this.script_url=crsaMakeUrlFromFile(r.join(process.cwd(),t))))},this.addTemplateProjectFromResourceFolder=function(e,r,t,n,i,o){var s,a;isApp()&&(a=require("path"),(s=this.getBaseUrl())||o)&&(a=o?e:a.join(crsaMakeFileFromUrl(s),e),pinegrow.addTemplateProjectFromFolder(a,function(t){t.name=u.name,t.description=u.description,t.author=u.author,t.author_link=u.author_link,t.info_badge=u.info_badge||null,t.framework=u,t.not_popular=u.not_popular||!1,t.root.walkThroughFiles(function(e){return"screenshots"!=e.name&&(0<=e.name.indexOf(".html")?(e.tag="page",e.image=t.root.url+"/screenshots"+"/"+e.name.replace("html","jpg")):e.required=!0,n?n(e,t):void 0)}),r&&r(t)},t,i))},this.addTemplateProjectFromDefinition=function(e){var t=pinegrow.addTemplateProjectFromTemplateDefinition(e);t.name=u.name,t.description=u.description,t.author=u.author,t.author_link=u.author_link,t.info_badge=u.info_badge||null,t.not_popular=u.not_popular||!1,t.framework=u},this.save=function(t,r){t=t||this.pluginUrl;var n=this;if(t){t!=this.pluginUrl&&(this.name=getPageName(t).replace(/\.js$/i,""),this.key=this.name);var i="",o=[],e=($.each(this.component_types,function(e,t){var r="comp_"+t.type.replace(/-/g,"_");i+=t.toJSCode(r),o.push(r)}),'$(function() {\n\n    //Wait for Pinegrow to wake-up\n    $("body").one("pinegrow-ready", function(e, pinegrow) {\n\n        //Create new Pinegrow framework object\n        var f = new PgFramework("'+this.key+'", "'+this.name+'");\n\n        //This will prevent activating multiple versions of this framework being loaded\n        f.type = "'+this.key+'";\n        f.allow_single_type = true;\n        f.user_lib = '+(this.user_lib?"true":"false")+"\n"+i+'\n        //Tell Pinegrow about the framework\n        pinegrow.addFramework(f);\n            \n        var section = new PgFrameworkLibSection("'+this.key+'_lib", "Components");\n        //Pass components in array\n        section.setComponentTypes(['+o.join(", ")+"]);\n\n        f.addLibSection(section);\n   });\n});");try{var s=crsaMakeFileFromUrl(t),a=require("fs");crsaWriteFileWithBackup(a,s,e,"utf8"),this.pluginUrl=t,pinegrow.saveFrameworksList(),this.changed=!1,pinegrow.showQuickMessage("Snippet library "+this.name+" saved.")}catch(e){showAlert("File "+t+" could not be saved. "+e,"Error")}r&&r()}else crsaChooseFile(function(e,t){t&&n.save(t,r)},n.getFileName())},this.getActionTypes=function(e){return this.getTypes(null,e)},this.getActionTag=function(e){var t=this.getActionTypes(e);if(t.length){for(var r="",n=0;n<t.length;n++){var i=t[n].get_action_tag?t[n].get_action_tag(e,t[n]):t[n].short_name||t[n].name;r+=(r.length?", ":"")+i}return r}return null},this.textForExample=function(e){return"for example, "+e},this.textDefaultValue=function(e){return"default, "+e},this.textUse=function(e){return"use "+e},this.fieldIsRequired=function(e,t,r,n,i,o){return r?null:pinegrow.getValidationError(n.name,"req")},this.fieldIsValidFile=function(e,t,r){if(r){var n=pinegrow.getCurrentProject(),i=!0;if(isApp()?i=crsaIsFileExist(n.getAbsolutePath(r)):n&&(i=n.getFileForUrl(r)),!i)return"The file does not exist."}},this.setCSSProperty=function(e,t,r,n,i){},this.requireSelectedElement=function(e){var t,r=pinegrow.getSelectedPage();r?(t=pinegrow.getSelectedElement())?e(r,t):pinegrow.showQuickMessage("An element must be selected."):pinegrow.showQuickMessage("A page must be open for this to work.")},this.requireSelectedPage=function(e){var t=pinegrow.getSelectedPage();t?e(t):pinegrow.showQuickMessage("A page must be open for this to work.")},this.on_element_inserted=function(e,t,r,n){if(n.framework&&n.framework==this&&n.framework.resources.has()){var i=e.getResourceNamespaceForFramework(n.framework);if(i)for(var o=require("fs"),s=["src","data-src","href","action"],a=0;a<s.length;a++)for(var l=s[a],c=t.findIncludingSelf("["+l+"]"),u=0;u<c.length;u++){var h,p=c[u],g=p.getAttr(l);g&&!crsaIsAbsoluteUrl(g)&&(g=i+g,h=crsaMakeFileFromUrl(e.makeAbsoluteUrl(g)),"file"==crsaIsFileOrDir(h,o))&&p.setAttr(l,g)}}},this.addResourcesToPage=function(t,r,e,n,i){function o(){t.setPageChanged(!0),pinegrow.changeManager.didChangePage(t,"Add resources",{source:"add_resources"})}var s=require("path"),a=pinegrow.getCurrentProject(),l=null;t.localFile&&(a&&a.isFileInProject(t.localFile)?l=a.getDir():t.localFile&&(l=s.dirname(t.localFile))),i=i||this.resources,l?(a=this.getResourceNamespacePath(),n||(l=s.join(l,a)),i.copyFilesToFolder(l,function(e){i.addToPage(t,l)&&(o(),0),r&&r()},e)):(i.addToPage(t)&&o(),r&&r())},this.addResourcesToProject=function(t,r,e,n,i,o){var s=require("path"),a=t.getDir(),l=this.getResourceNamespacePath();n?a+=s.sep:a=a+s.sep+l,(o=o||this.resources).copyFilesToFolder(a,function(e){i?(i instanceof CrsaPage&&o.addToPage(i,a),r&&r(),pinegrow.refreshCurrentProjectDelayed(!0)):t.forEachEditableFile(function(e,t,r){o.addToPage(e,a)&&(r.changed=!0,r.skip_refresh=!0),t(e,r)},function(){r&&r(),pinegrow.refreshCurrentProjectDelayed(!0)},"Updating resources...")},e)},this.getResourceNamespace=function(){return null!==this.customResourceNamespace?this.customResourceNamespace:"components/"+(this.type||this.key)+"/"},this.getResourceNamespacePath=function(){return this.getResourceNamespace().replace(/\//g,require("path").sep)},this.addResource=function(e,t,r,n){return this.resources.createAndAdd(e,this,t,r,n)}},PgFrameworkLibSection=function(e,t,r){this.key=e,this.name=t,this.components=[],this.framework=null,this.small_name=r,this.addComponentType=function(e){this.components.push(e)},this.setComponentTypes=function(e){this.components=e},this.getComponentTypes=function(){return this.components}},PgComponentTypeResource=function(e,t,r){var u=this;this.type=r||pinegrow.getMimeType(e),this.url=e,this.code=t,this.detect=null,this.footer=!1,this.project=null,this.isFolder=!1,this.source=null,this.relative_url=null,this.replace=!1,this.place_before_user_style=!1,this.force_overwrite=null,this.copy_only=!1,this.detectAttrInPage=function(e){if(!this.detect)return!1;if(this.code)r=null,e.sourceNode.walk(function(e){return!(e.isElement&&"script"===e.tagName&&e.content&&e.content.match(u.detect)&&(r=e,1))});else for(var t={name:"",attr:""},r=("text/css"==this.type?(t.name="link",t.attr="href"):"application/javascript"==this.type&&(t.name="script",t.attr="src"),!1),n=e.sourceNode.findIncludingSelf(t.name),i=0;i<n.length;i++){var o=n[i],s=o.getAttr(t.attr);if(s){s=s.match(this.detect);if(s&&0<s.length){r=o;break}}}return r},this.isEqual=function(e){return this.url==e.url||this.code&&this.code==e.code},this.isCss=function(){return"text/css"==this.type},this.addToPage=function(e,t){if(!this.copy_only){var r,n,i,o=this.code?"http://dummy":this.url;if(this.relative_url&&!crsaIsAbsoluteUrl(this.relative_url)&&this.relative_url&&t&&(o=isApp()?crsaMakeUrlFromFile(require("path").join(t,this.relative_url)):t+this.relative_url),"text/css"==this.type)return i=!1,(n=this.detectAttrInPage(e))&&(i="function"==typeof this.replace?this.replace(e,n):this.replace),!n||i?(r=this.place_before_user_style?"style.css":null,e.addStylesheet(o,!1,null,n,r)):null;if("application/javascript"==this.type)return i=!1,(n=this.detectAttrInPage(e))&&(i="function"==typeof this.replace?this.replace(e,n):this.replace),!n||i?e.addScript(o,this.footer,n,this.code):null;this.isFolder}return!1},this.copyFilesToPage=function(e,t){this.copyFilesToFolder(require("path").dirname(e.localFile),t)},this.copyFilesToProject=function(e,t,r){this.copyFilesToFolder(e.getDir(),t,r)},this.copyFilesToFolder=function(e,t,r){var n=require("path");if(null!==this.force_overwrite&&(r=this.force_overwrite),this.relative_url)if(crsaIsAbsoluteUrl(this.relative_url||this.url))t&&t();else if(isApp()){var i=crsaMakeFileFromUrl(this.relative_url),o=n.join(e,i),s=require("fs"),i=!1;try{i=s.statSync(o).isFile()}catch(e){i=!1}var a,l="function"==typeof r?r(this.relative_url):r;i&&!l?t&&t():crsaIsRemoteUrl(this.url)?(a=function(e){try{crsaCreateDirs(n.dirname(o),s),s.writeFileSync(o,u.remoteData),console.log("Save remote file "+u.url+" -> "+o)}catch(e){console.log("Could not save "+o,e)}},u.remoteDataFetchedAt&&(new Date).getTime()-u.remoteDataFetchedAt>60*1e3&&(u.remoteData=null),u.remoteData?(a(),t&&t()):pgFetchRemoteContent(this.url).catch(function(e){console.log("Error getting remote file "+u.url,e),t&&t()}).then(function(e){try{if(void 0===e)throw"Error getting remote file "+u.url;u.remoteData=new Buffer(e),u.remoteDataFetchedAt=(new Date).getTime(),a()}catch(e){console.log("Error getting remote file "+u.url,e)}t&&t()})):crsaMakeFileFromUrl(this.url)==o?t&&t():this.copy(o,t,r)}else{var c=pinegrow.getCurrentProject();if(c){var l="function"==typeof r?r(this.relative_url):r;if(l=!1,(i=c.hasContentForUrl(this.relative_url))&&!l)return void(t&&t());if(c.mapSourceUrlToDOMUrl(this.relative_url,!1))return void(t&&t());pgFetchRemoteContent(this.url).catch(function(e){console.log("Error getting file "+u.url,e),t&&t()}).then(function(e){try{if(void 0===e)throw"Error getting remote file "+u.url;c.setContentOfUrl(u.relative_url,(new TextDecoder).decode(e),t),c.settingsFileIsChanged(u.relative_url)}catch(e){console.log("Error getting remote file "+u.url,e),t&&t()}})}}else t&&t()},this.copy=function(e,t,r,n){var i=require("path"),o=require("fs");try{console.log("RESOURCES - COPY "+this.source+" -> "+e),crsaCreateDirs(i.dirname(e),o);var s=crsaIsFileOrDir(crsaMakeFileFromUrl(this.source),o);if("dir"==s)crsaCopyFolder(crsaMakeFileFromUrl(this.source),e,function(e){t&&t(e)},!0,r);else if("file"==s){var a=!1;try{o.statSync(e);a=o.statSync(crsaMakeFileFromUrl(this.source)).isFile()}catch(e){a=!1}var l="function"==typeof r?r(this.relative_url):r;a&&!l||(n?n.copyFile(e,crsaMakeFileFromUrl(this.source)):crsaCopyFileSync(o,crsaMakeFileFromUrl(this.source),e)),t&&t()}else t&&t(crsaMakeFileFromUrl(this.source)+" does not exist.")}catch(e){console.log("COPY ERROR "+e),t&&t(e)}}},PgResourcesList=function(){this.list=[];var a=this;this.clear=function(){this.list=[]},this.has=function(){return 0<this.list.length},this.add=function(e){for(var t=0;t<this.list.length;t++)if(this.list[t].isEqual(e))return;this.list.push(e)},this.createAndAdd=function(e,t,r,n,i){"object"==typeof r&&(i=r,r=null),i=$.extend({resources_dir:"template",detect:r||!1,always:n||!1,replace:!0,remote_source:null,place_before_user_style:!1,force_overwrite:null,copy_only:!1},i||{});var o=null,s=null;return crsaIsAbsoluteUrl(e)||(o=e,s=e=t?t.getResourceUrl(i.resources_dir+"/"+e):null),(res=new PgComponentTypeResource(i.remote_source||e)).relative_url=o,res.source=s,res.detect=i.detect,res.replace=i.replace,res.footer="application/javascript"==res.type,res.place_before_user_style=i.place_before_user_style,res.force_overwrite=i.force_overwrite,res.copy_only=i.copy_only,this.add(res),res},this.detectRequiredResources=function(i,o){var s=[];return i.sourceNode.goThroughAllUrls(function(e,t,r){var n;return e.startsWith("#")||crsaIsAbsoluteUrl(e)||e.startsWith("javascript:")||(n=new URL(e,i.remote_template_url||i.url).toString(),a.createAndAdd(e,o,{resources_dir:"required_resources_dir"in o?o.required_resources_dir:"pagelib",remote_source:n,copy_only:r.hasAttribute("pg-require-copy-only")||!1}),"pg-require"===r.getAttribute("rel")&&s.push(r)),e},!1,!0),s.forEach(function(e){e.removeWithoutEvents()}),0<s.length},this.addToPage=function(e,t,r){for(var n=!1,i=!1,o=0;o<this.list.length;o++)this.list[o].on_add_resource_filter&&!this.list[o].on_add_resource_filter(this.list[o])||this.list[o].addToPage(e,t)&&(n=!0,this.list[o].isCss())&&(i=!0);return r&&r(e,this),e.openedInEditor&&n&&(i?e.refreshWithUpdateStylesheets():e.refresh()),n&&(e.setPageChanged(!0),pinegrow.changeManager.didChangePage(e,"Add resources",{source:"add_resources"})),n},this.copyFilesToFolder=function(e,t,r){var n=0,i=function(){n==a.list.length?t&&t():n<a.list.length&&(a.list[n].on_add_resource_filter&&!a.list[n].on_add_resource_filter(a.list[n])?(n++,i()):a.list[n].copyFilesToFolder(e,function(e){n++,i()},r))};i()}},PgComponentType=function(e,t,r){var n;this.type=e,this.name=t,this.short_name=t,this.selector=null,this.code=null,this.preview=null,this.sections=null,this.priority=1e3,this.attribute=null,this.attribute_default=null,this.parameter_attributes=[],this.parent_selector=null,this.inherit_from=null,this.empty_placeholder=null,this.display_name=null,this.live_update=!0,this.framework=null,this.set_value=null,this.resources=null,r&&(n=this,$.each(r,function(e,t){n[e]=t}))},PgPropertiesSection=(PgComponentType.prototype.addPrefix=function(n){this.type=n+"."+this.type;var i={};$.each(this.sections,function(e,t){var r;t.fields&&(r={},$.each(t.fields,function(e,t){r[n+"."+e]=t}),t.fields=r),i[n+"."+e]=t}),this.sections=i},PgComponentType.prototype.toJSCode=function(e){function t(e){return(e=e.replace(/\r\n|\r|\n/g,"\\\n")).replace(/'/g,"\\'")}return"\n        var "+e+" = new PgComponentType('"+this.type+"', '"+t(this.name)+"');\n        "+e+".code = '"+t(this.code)+"';\n        "+e+".parent_selector = "+(this.parent_selector?"'"+this.parent_selector+"'":"null")+";\n        f.addComponentType("+e+");\n        "},PgComponentType.prototype.addResource=function(e){null===this.resources&&(this.resources=new PgResourcesList),this.resources.add(e)},PgComponentType.prototype.addResources=function(e){for(var t=0;t<e.length;t++)this.addResource(e[t])},PgComponentType.prototype.addRequireCSS=function(e){this.require_css.indexOf(e)<0&&this.require_css.push(e)},PgComponentType.prototype.getActionParameters=function(){var r;return this.action_parameter_list||(r=[],$.each(this.sections,function(e,t){t.fields&&$.each(t.fields,function(e,t){t.attribute&&r.push({name:t.attribute,default:t.default||null,def:t})})}),this.action_parameter_list=r)},PgComponentType.prototype.getActionValuesForPgel=function(t){var r={};return this.attribute&&(r[this.attribute]=t.getAttribute(this.attribute)),this.getActionParameters().forEach(function(e){t.hasAttribute(e.name)&&(r[e.name]=t.getAttribute(e.name))}),r},PgComponentType.prototype.hasAction=function(e){return this.has_action?this.has_action(e):this.attribute&&e.hasAttr(this.attribute)},PgComponentType.prototype.addEventHandler=function(e,t){this[e]?(Array.isArray(this[e])||(this[e]=[this[e]]),this[e].push(t)):this[e]=[t]},function(e,t){this.key=e,this.name=t,this.fields={},this.addProperty=function(e,t){t=t||e.key,this.fields[e.key]=e}}),PgProperty=function(e,t){this.name=t,this.key=e,this.type=null,this.action=null,this.get_value=null,this.set_value=null,this.value=null,this.show_empty=null,this.attribute=null,this.options=null},PgComponent=function(e,t){this.html=null,this.error=null,this.url=null;var r=this;if(this.url="components/"+e+".html",isApp()){var n=require("fs");try{this.html=n.readFileSync(crsaMakeFileFromUrl(this.url),{encoding:"utf8"}),t&&t(this)}catch(e){this.error=e,t&&t(this)}}else $.ajax({url:this.url,data:null,dataType:"text"}).done(function(e){r.html=e,t&&t(r)}).fail(function(e){r.error=e,t&&t(r)})},PgStats=function(){var i=[],t={},o=!0,e=this,s=crsaStorage.getValue("install_id"),a=(s||(s="id"+(new Date).getTime()+Math.round(1e5*Math.random()),crsaStorage.setValue("install_id",s)),setInterval(function(){e.send()},1e3*60*10),crsaGetVersion()),l=parseInt(localStorage.app_run||"0");this.event=function(e,t,r){var n;pinegrow&&"1"==pinegrow.getSetting("disable-stats","0")&&!r||((n={}).event=e,n.data=t||"",n.time=parseInt((new Date).getTime()/1e3),(r=n).trialEmail=crsaStorage.getValue("userEmail"),r.userEmail=crsaStorage.getValue("activatedUserEmail"),r.serial=crsaStorage.getValue("activatedSerial"),r.version=a,r.product=crsaStorage.getValue("activatedProduct"),r.appRun=l,r.installId=s,i.push(n),o&&this.send())},this.using=function(e){e in t||(t[e]=0),t[e]++,0};this.send=function(e){e&&e()}};