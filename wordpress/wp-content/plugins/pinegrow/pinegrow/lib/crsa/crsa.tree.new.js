var CrsaTreeForPage=function(e){function i(){var e=o.val(),a=0<e.length?new RegExp(escapeRegExp(e),"i"):null,r=(s=0<l.length&&0==e.indexOf(l)&&e!=l&&!m,s=!1),t=e,n=(e.startsWith("$")&&(e=e.substr(1),r=!0),{});try{p.currentCrsaPage.get$Html().find(e).each(function(e,t){var a=t.getAttribute("data-pg-tree-id");a&&(n[a]=!0)}),m=!1}catch(e){m=!0}""==l&&0<e.length&&setTimeout(function(){},2500),!s&&0<l.length&&u.find("li").removeClass("not-found found child-found"),a&&u.find(">li").each(function(e,t){f($(t),a,n,r)}),(l=t).length}var h,d,n,c=$('#crsa-tree">'),p=(this.$dest=c,this.$iframe=null,this.onSortStart=null,this.onSortStop=null,this.onSortReceive=null,this.currentCrsaPage=e,this.ready=!1,this),l="",s=!1,o=null,u=null,g=null,f=function(e,r,n,l){var t,i=!1,a=(e.find(">ul").find(">li").each(function(e,t){var a=$(t);s&&!a.hasClass("child-found")&&!a.hasClass("found")||(a=f(a,r,n,l),i=i||a)}),t=i,e.get(0).getAttribute("data-pg-tree-id"));return!l&&e.find(">div").text().match(r)||a&&a in n?(e.removeClass("not-found").addClass("found"),i=!0):(e.removeClass("found").addClass("not-found"),t?e.addClass("child-found"):e.removeClass("child-found")),i},m=!1,v=(this.getElementOfTreeNode=function(e){return v(e)},function(e,t){var a=e.attr("data-pg-tree-id");return a?(t=t||p.currentCrsaPage.get$Html()).is('[data-pg-tree-id="'+a+'"]')?t:0==(a=t.find('[data-pg-tree-id="'+a+'"]')).length?e.data("crsa-element"):a.length?a:null:null}),C=function(e,t){var a,r=e.getAttribute("data-pg-tree-id");if(r&&t){if(t.getAttribute("data-pg-tree-id")==r)return t;a=t.querySelector('[data-pg-tree-id="'+r+'"]')}return a},T=!0,P=(this.initUI=function(){this.$dest.html(""),h=0;function t(){g=g||u.find("li");var e=0,t=(r=d.scrollTop())+d.height(),a=19,r=Math.floor(r/a),n=Math.ceil(t/a);if(p.currentCrsaPage){var l=p.currentCrsaPage.get$Html().get(0);if(l){var i=g;if(r<i.length-1){n>=i.length&&(n=i.length-1);for(var s=r;s<=n;s++){var o=i.get(s);o.getAttribute("data-li-populated")||(w(o,l),o.setAttribute("data-li-populated","true"),e++)}}}return e}}var e=$("<div/>",{class:"header"}).appendTo(c),a=((o=$("<input/>",{placeholder:"find text or selector",class:"form-control filter-form"}).appendTo(e).on("input",i)).on("focus",function(){o.attr("placeholder","find text or selector ($... to force sel)")}),o.on("blur",function(){o.attr("placeholder","find text or selector")}),o.tooltip({container:"body",placement:"left",title:"Tree Drag & Drop is disabled when filter is set.",trigger:"manual"}),crsaAddCancelSearch(o,"top: 11px;right:18px;"),d=$("<div/>",{class:"tree-container"}).appendTo(this.$dest),null),r=null,n=function(e){void 0===e&&(e=0);var t=(new Date).getTime();g=g||u.find("li");if(p.currentCrsaPage){for(var a=p.currentCrsaPage.get$Html().get(0),r=g,n=e;n<r.length;n++){var l=r.get(n);if(e++,!l.getAttribute("data-li-populated"))if(w(l,a),l.setAttribute("data-li-populated","true"),n%10==0)if(50<(new Date).getTime()-t)break}return e<r.length?e:-1}},l=function(e){void 0===e&&(e=0),a&&clearTimeout(a),a=setTimeout(function(){a=null,0<=(e=n(e))?l(e):i()},75)};return d.on("treeUpdated",function(e){t(),l()}),d.on("scroll",function(e){0<t()&&(r&&clearTimeout(r),r=setTimeout(function(){u.hide().show(0),r=null},100))}),!1},0),w=(this.getTreeNodeId=function(){return++P},this.assignTreeNodeToElement=function(e,t,a){var r=this.getTreeNodeId();t.attr("data-pg-tree-id",r),e.attr("data-pg-tree-id",r),a&&e.data("crsa-element",t)},function(e,t){var a,r,n,l,i=C(e,t);i&&(i=$(i),r=(a=e.childNodes[0]).childNodes[2],l=getType(i,!1,!1,p.currentCrsaPage))&&(n=p.currentCrsaPage.getActionTag(i),i=getElementName(i,l,!0,!1,!0,!1,n,p.currentCrsaPage),r.innerHTML=i,l.tags)&&(a.className+=" tag-"+l.tags)}),A=function(e,t,a){h<(a=a||0)&&(h=a);var r="",r="",n=e.childNodes;if(0<n.length)for(var l=0;l<n.length;l++){var i=n.item(l);1==i.nodeType&&"BR"!=i.tagName&&(r+=A(i,!1,a+1))}if(t)return r;var s="sort",o=("BODY"!=e.tagName&&"HEAD"!=e.tagName&&"HTML"!=e.tagName||(s="no-sort"),""),d="fa-eye",c="",u=e.tagName;if("STYLE"==u&&"crsa-inline-styles"==e.id)return"";E(e)&&(s+=" crsa-tree-node-hidden",d="fa-eye-slash");var g=++P,g=(e.setAttribute("data-pg-tree-id",g),'data-pg-tree-id="'+g+'"'),f=e.getAttribute("data-pg-id"),f=(f?g+=' data-pg-id="'+f+'" ':s+=" dyn","");return b(e)?(c="fa-angle-right",s+=" collapsed",f=" crsa-tree-node-closed"):c="fa-angle-down",r.length&&(r='<ul class="crsa-tree-branch'+f+'">'+r+"</ul>",s+=" has-children"),"HTML"==u&&(u=p.currentCrsaPage.name,o+=" tag-block",c="fa-file-o",d+=" hide",g+=' aadata-li-populated="true"',s+=" doc-root"),"<li "+g+'class="'+s+'"><div class="crsa-tree-node-name'+o+'"><i title="ALT + Click to collapse / uncollapse the whole level." class="crsa-collapse fa fa-fw '+c+'"></i><i class="crsa-visible fa fa-fw '+d+'"></i><name>'+u+"</name></div>"+r+"</li>"},b=function(e){return"HEAD"==e.tagName?!p.currentCrsaPage.show_head_in_tree:""==e.getAttribute("data-pg-collapsed")},E=function(e){return""==e.getAttribute("data-pg-hidden")},N=null,r=(this.show=function(e){var t=this.currentCrsaPage.$iframe,t=getCrsaPageForIframe(t);activateTreeForCrsaPage(t),t.treeRepaintOnShow&&!e&&(this.paintTree(t.$iframe,!0===t.treeRepaintOnShow?getTreeRootForElement(null,t.$iframe):t.treeRepaintOnShow),t.treeRepaintOnShow=null),g=null},this.close=function(){this.currentCrsaPage.treeTop.remove(),N&&(window.cancelAnimationFrame(N),N=null),this.currentCrsaPage=null,this.$iframe=null,u=null,this.currentCrsaPage.treeTop=null,this.currentCrsaPage.treeCurrentRoot=null,this.currentCrsaPage.treeRepaintOnShow=null,g=null},this.updateTreeAfterPainting=function(){var e=20*h+150;u.css("min-width",(e=e<300?300:e)+"px"),r(),o.val(l),i(),d.trigger("treeUpdated")},this.paintTree=function(e,t,a){var r,n=this.currentCrsaPage.$iframe,l=n&&e?getTreeRootForElement(e,n):null,i=(this.currentCrsaPage.treeCurrentRoot=l,this.$iframe=n,i=i||u,u),s=!1,o=h,n=(h=0,e||l),d=new CrsaProfile(!0);n.each(function(e,t){r=$(t);var a=getTreeNodeForElement(r,u),a=(!a||r.get(0)==l.get(0)||N||0==u.get(0).childNodes.length?(r=l,i=u):0<(i=a.closest("ul.crsa-tree-branch")).length?(s=!0,r=r.parent(),a.data("menu-level"),h=o):(i=u,r=l),0==r.length&&(r=l,i=u,s=!1),A(r.get(0),s)),a=(d.show("simple tree 1"),i.get(0).innerHTML=a,d.show("simple tree 2"),i.find("li"));(t=a).on("contextmenu",function(e){e.preventDefault();var t=$(e.delegateTarget).closest("li"),a=v(t),r=getElementPgNode(a),n=$.fn.crsa("getActionsMenuFor",a),r=(p.currentCrsaPage.callFrameworkHandler("on_build_actions_menu",n,r,a),new CrsaContextMenu);return r.actions=n,r.$target=a,r.$clicked=t.find("> div"),r.showAt(e.pageX,e.pageY,$(".tree-container")),!1}).on("mouseover",function(e){var t=$(e.delegateTarget),a=t.closest("ul"),a=(T&&(c.find("ul.hl").removeClass("hl"),a.addClass("hl")),v(t));$.fn.crsa("highlightElement",a),e.stopImmediatePropagation()}).on("mouseout",function(e){var t=$(e.delegateTarget),a=t.closest("ul");T&&a.removeClass("hl"),v(t);$.fn.crsa("highlightElement",null),e.stopImmediatePropagation()}).on("click",function(e){var t=$(e.delegateTarget).closest("li"),t=(t.find("> div"),v(t));t&&($.fn.crsa("selectElement",t,"tree"),$.fn.crsa("scrollCanvasToElement",t)),e.stopImmediatePropagation(),e.preventDefault(),$("body").trigger("click")}),t.find("> div > i.crsa-collapse").on("click",function(e){var t=$(e.delegateTarget).closest("li"),t=(t.find("> ul"),v(t)),a=$.fn.crsa("isCollapsed",t);e.altKey?$.fn.crsa("collapseChildren",t.parent(),!a):$.fn.crsa("collapseElement",t,!a),e.preventDefault(),e.stopPropagation()}),t.find("> div > i.crsa-visible").on("click",function(e){var t=$(e.delegateTarget),a=t.closest("li"),r=(a.find("> ul"),v(a)),n=!1,t=(a.hasClass("crsa-tree-node-hidden")?(a.removeClass("crsa-tree-node-hidden"),t.addClass("fa-eye").removeClass("fa-eye-slash"),r.data("crsa-tree-hidden",null)):(a.addClass("crsa-tree-node-hidden"),t.addClass("fa-eye-slash").removeClass("fa-eye"),r.data("crsa-tree-hidden",!0),n=!0),getElementPgNode(r));n?(r.attr("data-pg-hidden",""),t&&t.setAttr("data-pg-hidden",null)):(r.removeAttr("data-pg-hidden"),t&&t.removeAttr("data-pg-hidden")),pinegrow.getSelectedPage().setPageChanged(!0),e.preventDefault(),a.redraw()}),g=null,d.show("simple tree 3")}),a||this.updateTreeAfterPainting(),t&&t()},function(){var e,t,a,r;n&&(e=getTreeNodeForElement(n))&&(e.addClass("crsa-tree-node-selected"),e=e.position(),r=(t=$("#crsa-tree > div.tree-container")).height(),a=t.scrollTop(),0<=e.top&&e.top<r-20||(r=e.top+a-100,t.animate({scrollTop:r=r<0?0:r},150)))});this.setSelectedElement=function(e,t){var a;u.find("li.crsa-tree-node-selected").removeClass("crsa-tree-node-selected"),n&&(a=getTreeNodeForElement(n))&&a.removeClass("crsa-tree-node-selected"),n=e,t||p.$dest.hasClass("closed")||r()},this.initUI(),this.ready=!0};