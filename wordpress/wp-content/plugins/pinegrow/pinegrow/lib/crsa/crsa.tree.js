var CrsaTree=function(i){this.$dest=i,this.$iframe=null,this.onSortStart=null,this.onSortStop=null,this.onSortReceive=null,this.currentCrsaPage=null,this.ready=!1;function s(){var r,e=h.val(),n=0<e.length?new RegExp(escapeRegExp(e),"i"):null,a=(f=0<u.length&&0==e.indexOf(u)&&e!=u&&!v,f=!1),t=e,o=(e.startsWith("$")&&(e=e.substr(1),a=!0),{}),i={},s={selected_ids:i,changed:!1},s=(c.currentCrsaPage.callFrameworkHandler("on_custom_tree_filter",s),s.changed);if(e)try{c.currentCrsaPage.get$Html().find(e).each(function(e,t){var r=t.getAttribute("data-pg-tree-id");r&&(o[r]=!0)}),v=!1}catch(e){v=!0}!a&&n&&g.find("li").each(function(e,t){var r;$(t).find(">div").text().match(n)&&(r=t.getAttribute("data-pg-tree-id"))&&(o[r]=!0)}),s&&(o=e?(r={},$.each(i,function(e,t){e in o&&(r[e]=!0)}),r):i),!f&&(0<u.length||s)&&g.find("li").removeClass("not-found found child-found has-no-child-found"),(n||s)&&g.find(">li").each(function(e,t){m($(t),n,o,a)}),u=t}function n(){return c.$dest.hasClass("closed")}function a(e){var l,t=!1;e.treeTop||(e.treeTop=$("<ul/>").addClass("crsa-tree-branch"),e.treeRepaintOnShow=!0,t=!0),c.currentCrsaPage!=e&&(g&&g.detach(),g=e.treeTop,d.append(g),t&&(l=e.treeTop).nestedSortable({forcePlaceholderSize:!0,helper:"clone",placeholder:"tree-placeholder",handle:"div",tabSize:20,tolerance:"pointer",isTree:!0,items:"li.sort",listType:"ul",toleranceElement:"> div"}).on("sortreceive",function(e,t){console.log("received "+t.item.text());var r=(r=C(t.item))||t.item.data("crsa-element"),n=t.item.parent().closest("li"),a=(n.length||(t.item=l.find("i.crsa-inline-menu-move"),n=t.item.parent().closest("li")),C(n)),n=n.find("> ul > li, > ul > .crsa-inline-menu-move").index(t.item);r&&a&&c.onSortReceive&&c.onSortReceive(r,a,n,t)}).on("sortupdate",function(e,t){}).on("sortstop",function(e,t){0;var r=t.item.parent().closest("li"),n=C(t.item),a=C(r),r=r.find("> ul > li").index(t.item),o=!1,i=l.closest(".tree-container"),s=i.offset();e.pageX>=s.left&&e.pageX<=s.left+i.outerWidth()&&e.pageY>=s.top&&e.pageY<=s.top+i.outerHeight()&&(o=!0),n&&a&&c.onSortStop&&c.onSortStop(n,a,r,t,o)}).on("sortstart",function(e,t){0;var r=C(t.item);r&&c.onSortStart&&c.onSortStart(r)}).on("sort",function(e,t){c.onSortMove&&c.onSortMove(e,t)}),c.currentCrsaPage=e,d.trigger("treeUpdated"))}var d,o,l,c=this,u="",f=!1,h=null,g=null,r=300,p=null,m=function(e,n,a,o){var i=!1,t=e.find(">ul"),s=!1,r=(t.find(">li").each(function(e,t){var r=$(t);(!f||r.hasClass("child-found")||r.hasClass("found"))&&(r=m(r,n,a,o),i=i||r,r)&&(s=!0)}),t=i,e.get(0).getAttribute("data-pg-tree-id"));return r&&r in a?(e.removeClass("not-found").addClass("found"),i=!0):(e.removeClass("found").addClass("not-found"),t?e.addClass("child-found").removeClass("no-child-found"):e.removeClass("child-found").addClass("no-child-found")),s?e.removeClass("has-no-child-found"):e.addClass("has-no-child-found"),i},v=!1,C=(this.getElementOfTreeNode=function(e){return C(e)},function(e,t){var r=e.attr("data-pg-tree-id");return r?(t=t||c.currentCrsaPage.get$Html()).is('[data-pg-tree-id="'+r+'"]')?t:0==(r=t.find('[data-pg-tree-id="'+r+'"]')).length?e.data("crsa-element"):r.length?r:null:null}),T="fa-minus",w="fa-plus",e=(this.hideTree=function(){var e=i.find("> div.tree-container");r=c.$dest.width(),c.$dest.addClass("closed"),c.$dest.animate({width:30},150,function(){l.removeClass(T).addClass(w),e.hide(),i.css("overflow","hidden"),$(window).trigger("resize")})},this.showTree=function(e){var t=i.find("> div.tree-container");r<300&&(r=300),c.$dest.removeClass("closed"),t.show(),e?(l.addClass(T).removeClass(w),i.css("overflow","auto"),c.currentCrsaPage&&c.currentCrsaPage.treeRepaintOnShow&&c.showTreeForIframe(c.currentCrsaPage.$iframe)):c.$dest.animate({width:r},150,function(){l.addClass(T).removeClass(w),i.css("overflow","auto"),$(window).trigger("resize"),c.currentCrsaPage&&c.currentCrsaPage.treeRepaintOnShow&&c.showTreeForIframe(c.currentCrsaPage.$iframe)})},this.initUI=function(){this.$dest.html(""),0;function t(){!p&&g&&(p=g.find("li"));var e=0,t=(n=d.scrollTop())+d.height(),r=19,n=Math.floor(n/r),a=Math.ceil(t/r);if(c.currentCrsaPage){var o=c.currentCrsaPage.get$Html().get(0);if(o){var i=p;if(n<i.length-1){a>=i.length&&(a=i.length-1);for(var s=n;s<=a;s++){var l=i.get(s);l.getAttribute("data-li-populated")||(S(l,o),l.setAttribute("data-li-populated","true"),e++)}}}return e}}var e=$("<div/>",{class:"header"}).html('<i class="hider fa '+T+'"></i>').appendTo(i),r=((h=$("<input/>",{placeholder:"find text or selector",class:"form-control filter-form"}).appendTo(e).on("input",s)).on("focus",function(){h.attr("placeholder","find text or selector ($... to force sel)")}),h.on("blur",function(){h.attr("placeholder","find text or selector")}),h.tooltip({container:"body",placement:"left",title:"Tree Drag & Drop is disabled when filter is set.",trigger:"manual"}),crsaAddCancelSearch(h,"top: 11px;right:18px;"),l=e.find("i.hider").on("click",function(e){c.$dest.width();c.$dest.hasClass("closed")?c.showTree():c.hideTree(),e.preventDefault()}),addTooltip(l,"Hide / show the panel"),d=$("<div/>",{class:"tree-container"}).appendTo(this.$dest),null),n=null,a=function(e){void 0===e&&(e=0);var t=(new Date).getTime();!p&&g&&(p=g.find("li"));if(c.currentCrsaPage){for(var r=c.currentCrsaPage.get$Html().get(0),n=p,a=e;a<n.length;a++){var o=n.get(a);if(e++,!o.getAttribute("data-li-populated"))if(S(o,r),o.setAttribute("data-li-populated","true"),a%10==0)if(50<(new Date).getTime()-t)break}return e<n.length?e:-1}},o=function(e){void 0===e&&(e=0),r&&clearTimeout(r),r=setTimeout(function(){r=null,0<=(e=a(e))?o(e):s()},75)};d.on("treeUpdated",function(e){t(),o()}),d.on("scroll",function(e){0<t()&&(n&&clearTimeout(n),n=setTimeout(function(){g.hide().show(0),n=null},100))}),$("<div/>",{class:"tree-resizer"}).appendTo(this.$dest).on("mousedown",function(e){e.preventDefault(),$.fn.crsapages("showOverlays"),$("body").on("mousemove.tree",function(e){var t=c.$dest.hasClass("left-side")?e.pageX-c.$dest.offset().left:c.$dest.offset().left+c.$dest.width()-e.pageX;t<=30?(t=30,c.$dest.hasClass("closed")||c.hideTree()):c.$dest.hasClass("closed")&&c.showTree(!0),c.$dest.css("width",t+"px")}).on("mouseup.tree",function(e){e.preventDefault(),$("body").off(".tree"),$.fn.crsapages("showOverlays",!0),$(window).trigger("resize")})});return!1},0),S=(this.getTreeNodeId=function(){return++e},this.assignTreeNodeToElement=function(e,t,r){var n=this.getTreeNodeId();t.attr("data-pg-tree-id",n),e.attr("data-pg-tree-id",n),r&&e.data("crsa-element",t)},this.populateLineForElement=function(e){var t=getTreeNodeForElement(e),r=e.closest("html");t&&r.length&&S(t.get(0),r.get(0))},function(e,t){var r,n,a,o,i=function(e,t){t=t||page.get$Html().get(0);var r,n=e.getAttribute("data-pg-tree-id");if(n&&t){if(t.getAttribute("data-pg-tree-id")==n)return t;r=t.querySelector('[data-pg-tree-id="'+n+'"]')}return r}(e,t);i&&(i=$(i),n=(r=e.childNodes[0]).childNodes[2])&&(o=getType(i,!1,!1,c.currentCrsaPage))&&(a=c.currentCrsaPage.getActionTag(i),i=getElementName(i,o,!0,!0,!0,!1,a,c.currentCrsaPage),n.innerHTML=i,o.tags)&&(r.className+=" tag-"+o.tags)}),t=null,P=(this.showTreeForIframe=function(e,t){var r;e?(r=getCrsaPageForIframe(e),a(r),r.treeRepaintOnShow&&!t&&(this.paintTree(r.$iframe,!0===r.treeRepaintOnShow?getTreeRootForElement(null,r.$iframe):r.treeRepaintOnShow),r.treeRepaintOnShow=null)):(g&&g.detach(),this.currentCrsaPage=null),p=null},this.closeTreeForPage=function(e){e==this.currentCrsaPage&&(e.treeTop.remove(),t&&(window.cancelAnimationFrame(t),t=null),this.currentCrsaPage=null,this.$iframe=null,g=null),e.treeTop=null,e.treeCurrentRoot=null,e.treeRepaintOnShow=null,p=null},this.updateTreeAfterPainting=function(){},this.paintTree=function(e,t,r,n){},function(){var e,t,r,n;o&&(e=getTreeNodeForElement(o,g))&&(e.addClass("crsa-tree-node-selected"),e=e.position(),n=(t=$("#crsa-tree > div.tree-container")).height(),r=t.scrollTop(),0<=e.top&&e.top<n-20||(n=e.top+r-100,t.animate({scrollTop:n=n<0?0:n},150)))});this.setSelectedElement=function(e,t){var r;g.find("li.crsa-tree-node-selected").removeClass("crsa-tree-node-selected"),o&&(r=getTreeNodeForElement(o,g))&&r.removeClass("crsa-tree-node-selected"),o=e,t||n()||P()},this.initUI(),this.ready=!0};