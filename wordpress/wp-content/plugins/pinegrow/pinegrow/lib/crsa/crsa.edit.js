var PgApiCodeEditorConnector=function(){function a(e){var t=pinegrow.getCrsaPageByUrl(e);return t}var l=null,c=!pgf.kids;this.codeChangedInEditor=function(e,t,n,o){e=pgDecodeUrl(e);var r,i,s=a(e);s?pgf.kids?((i=new pgParser).assignIds=!0,i.parse(t),rootNode=i.rootNode,i=s.sourceNode.toStringWithIds(!0),s.sourceNode.removeWithoutEvents(),s.sourceNode=rootNode,i=new PgNodeEvent(s.sourceNode,"setCode",null,{oldValue:i},s),i=new PgUndoEvent(i),pinegrow.undoManager.getHistoryForPage(s).addEvent(i),pinegrow.changeManager.didChange(s.sourceNode,"Code edit",{source:n,undoCombineKey:"code_edit",undoSourceId:e,undoData:o}),s.refresh(null,!0)):(i=s.applyChangesToSource(t,c,!1,!1,"editor"),l&&(clearTimeout(l),l=null),i.errors.length&&c?"external_editor"==n?l=setTimeout(function(){pinegrow.showQuickMessage("Code modified in external editor has syntax errors.",3e3,!0),l=null},3e3):n.setErrors(i.errors):(i.errors.length,i.replace_selected.forEach(function(e){pinegrow.selectedElements.replace(e.old_pgel,e.new_pgel)}),pinegrow.changeManager.didChange(s.sourceNode,"Code edit",{source:n,undoCombineKey:"code_edit",undoSourceId:e,undoData:o}),!i.updated&&i.whole_changed?i.stylesheets_changed?s.refreshWithUpdateStylesheets():s.refresh():i.stylesheets_changed&&s.updateStylesheetsList(),n&&n.setErrors&&n.setErrors(null))):(r=null,(r=crsaIsFileUrl(e)?(i=crsaMakeFileFromUrl(e),pinegrow.getStylesheetByFileName(i)):pinegrow.stylesheets.getByUrl(e,!0))?r.sourceStylesheet?pinegrow.showQuickMessage("This is a compiled stylesheets. Please edit its SASS or LESS source file."):(r.setNeedFormatting(!0),r.setSource(t,function(){r.loaded=!0,pinegrow.dispatchEvent("on_css_source_changed",null,{list:[r],eventType:"editor",editor:n}),$("body").trigger("crsa-stylesheets-properties-changed"),pinegrow.selectedElements.repositionMenus()})):(s=pinegrow.getCurrentProject())&&(i=s.getBackgroundPageForUrl(e))&&i.onlyCode&&(i.setCode(t),i.setPageChanged(!0,!0)))},this.elementSelectedInEditor=function(e,n){e=pgDecodeUrl(e),pinegrow.isFileEditable(crsaMakeFileFromUrl(e))&&pinegrow.openOrShowPage(e,function(e){var t=e.sourceNode.getNodeFromPath(n,!0);t&&(t.scrollTo(),pinegrow.selectElement(t))},!0,!0)},this.fileSavedInEditor=function(e,t){e=pgDecodeUrl(e);var n,o=a(e);o?(o.changed=!1,o.refreshPageChangedStatus(!0),pinegrow.showQuickMessage("<b>"+o.name+"</b> was saved in external editor."),pinegrow.dispatchEvent("on_page_loaded_from_external",o)):(n=pinegrow.getStylesheetByFileName(crsaMakeFileFromUrl(e)))&&(n.lastSavedAt=(new Date).getTime(),n.fileSavedInEditor(),pinegrow.getAllPages().forEach(function(e){e.refreshPageChangedStatus(!0)}),pinegrow.showQuickMessage("<b>"+n.name+"</b> was saved in external editor."),pinegrow.dispatchEvent("on_css_loaded_from_external",pinegrow.stylesheets.getPagesForStylesheet(n),n)),pinegrow.dispatchEvent("on_file_saved_in_external_editor",o,e,t)},this.refreshPage=function(e){e=pgDecodeUrl(e);var t=a(e);t&&t.openedInEditor&&t.refresh()}},PgApiCodeEditors=function(c){function d(){s=!0,e&&clearTimeout(e),e=setTimeout(function(){s=!1,e=null},2e3)}function u(t){return crsaIsFileUrl(t)&&(t=crsaRemoveUrlParameters(t)),g.filter(function(e){return pgDecodeUrl(e.url)==pgDecodeUrl(t)})}function t(){function n(e){e.getAllImportedFiles(function(e){return!!e.localFile&&(o.push(crsaMakeUrlFromFile(e.getLocalFileName())),!0)})}var o=[];pinegrow.getAllPages().forEach(function(e){e.url&&o.push(e.url)}),pinegrow.getStylesheets().forEach(function(e){var t;e.localFile&&o.push(crsaMakeUrlFromFile(e.getLocalFileName())),e.sourceStylesheet?((t=e.sourceStylesheet).localFile&&o.push(crsaMakeUrlFromFile(t.getLocalFileName())),n(t)):n(e)}),l&&l.emit("listOfOpenFiles",{list:o.map(function(e){return pgDecodeUrl(e)})})}function n(e,t){!t||t.eventType&&"editor"==t.eventType||!t.list||t.list.forEach(function(e){e&&e.localFile&&i.codeChanged(crsaMakeUrlFromFile(e.getLocalFileName()),e.getFilteredSource())})}var g=[],h=0,i=this,s=!1,e=null,f=(this.isUrlOpen=function(e){var t=!1;return u(e).forEach(function(e){t=e}),t},this.showEditor=function(e){var t=pgPageCodeEditorsStack;t.isEditorShown(e.view)||t.showEditor(e.view)},{}),p=(this.ignoreCodeForUrl=function(e){e&&(f[e]=!0)},this.getCodeForUrl=function(e){var t;return f[e]?(delete f[e],null):(t=null,u(e).forEach(function(e){t=e.getCode()}),t)},this.closeEditor=function(e){var t=g.indexOf(e);0<=t&&g.splice(t,1)},this.open=function(e,o,t,n,r,i,s){f[e]&&delete f[e];var a=u(e),a=new PgInternalCodeEditor(++h,e,a.length?a[0]:null,n,r,i),l=(a.view=s,g.push(a),!0);return a.onChange=function(e,t){var n=e.getCode();l&&n===o||(l=!1,d(),c.codeChangedInEditor(e.url,n,e,t),m[e.url]={code:n},p(e.url,n,e),e.view&&e.view.setModified(!0))},a.onElementSelectedInEditor=function(e,t){c.elementSelectedInEditor(e.url,t)},a.setCode(o),t&&t(a.id),a},this.getFocusedEditor=function(){for(var e=0;e<g.length;e++)if(g[e].isFocused&&g[e].isFocused())return g[e];return null},function(e,t,n){u(e).forEach(function(e){e!=n&&e.setCode(t)})}),m={},a=(this.isCodeForUrlSameInExternalEditor=function(e,t,n){setTimeout(function(){e in m?n(m[e].code===t):n(!1)},0<o&&m[e]&&m[e].external?1e3:0)},this.show=function(e,t){},this.setCode=function(e,t){m[e]={code:t}},this.codeChanged=function(e,t,n,o,r){u(e).forEach(function(e){e!==n&&("function"==typeof t&&(t=t()),e.setCode(t,r,!0))}),l&&"external_editor"!==n&&("function"==typeof t&&(t=t()),l.emit("codeChanged",{url:e,code:t}),m[e]={code:t}),o&&o()},this.cssCodeChanged=function(e,t,n,o,r){u(e).forEach(function(e){e!==n&&("function"==typeof t&&(t=t()),e.setCode(t,o,!0),e.view)&&r&&e.view.setModified(r.changed)}),l&&"external_editor"!==n&&("function"==typeof t&&(t=t()),l.emit("codeChanged",{url:pgDecodeUrl(e),code:t}),m[e]={code:t})},this.onPageSaved=function(e){l&&l.emit("codeSaved",{url:pgDecodeUrl(e)})},this.onCssSaved=function(e){l&&l.emit("codeSaved",{url:pgDecodeUrl(e)})},{}),l=(this.elementWasSelectedInPreview=function(e,t,n){u(e).forEach(function(e){e.elementWasSelectedInPreview(t)});var o=n&&n.source?n.source:null;l&&"external_editor"!=o&&((a[e]||null)!=t&&l.emit("elementSelectedInPreview",{url:pgDecodeUrl(e),path:t}),a[e]=null)},this.close=function(e,t){},null),o=0;$("body").one("pinegrow-ready",function(e,r){r.codeEditors=codeEditors,r.addEventHandler("on_api_server_created",function(e){pgf.editor_sync&&(l=e.addEndPoint("editor",function(n){n.on("elementSelectedInEditor",function(e){d();var t=pgDecodeUrl(e.url);a[t]=e.path,c.elementSelectedInEditor(t,e.path)}),n.on("codeChangedInEditor",function(e){var t=pgDecodeUrl(e.url);p(t,e.code),m[t]={code:e.code,external:!0},c.codeChangedInEditor(t,e.code,"external_editor")}),n.on("fileSavedInEditor",function(e){var t=pgDecodeUrl(e.url);c.fileSavedInEditor(t)}),n.on("requestParserModule",function(){var e,t;pgIsLive()?fetch("lib/crsa/pg-parser.js").then(e=>{if(e.ok)return e.text();throw new Error("Network response was not OK")}).then(e=>{n.emit("parserModule",{code:e})}).catch(e=>{console.error("requestParserModule: Unable to get pg-parser.js",e)}):(t=require("fs"),e=crsaMakeFileFromUrl(pgMakeFileUrl(crsaGetBaseForUrl(window.location.href)+"/lib/crsa/pg-parser.js")),t=t.readFileSync(e,{encoding:"utf8"}),n.emit("parserModule",{code:t}))}),n.on("openFile",function(e){d();var t=pgDecodeUrl(e.url);r.openOrShowPage(t,function(e){},!0,!0)}),n.on("refreshPage",function(e){d();var t=pgDecodeUrl(e.url);c.refreshPage(t)}),n.on("disconnect",function(e,t){o--,r.showQuickMessage("External code editor disconnected.")}),n.on("error",function(e,t,n){console.log(e,t,n)}),t(),o++,r.showQuickMessage("External code editor connected.")}))}),r.addEventHandler("on_css_loaded",function(e,t){t.url&&i.cssCodeChanged(t.url,function(){return t.filterSource(t.getSource())},null,null,t)}),r.addEventHandler("on_imported_css_loaded",function(e,t){t.url&&i.cssCodeChanged(t.url,function(){return t.filterSource(t.getSource())},null,null,t)}),r.addEventHandler("on_page_loaded_from_external",function(e){e.url&&i.codeChanged(e.url,function(){return e.getSource()},"external_editor")}),r.addEventHandler("on_css_stylesheet_locked_changed",function(e,t,n){t.url&&u(t.url).forEach(function(e){e.setReadOnly&&e.setReadOnly(n)})}),r.addEventHandler("on_page_changes_done",function(e,t){var n=t&&t.source?t.source:null;i.codeChanged(e.url,function(){return e.getSource()},n,null,t)}),r.addEventHandler("on_elements_collapsed_expanded",function(e){i.codeChanged(e.url,function(){return e.getSource()},null,null,{})}),r.addEventHandler("on_css_stylesheet_changed",function(e,t,n){var o,r;t.inline&&t.inlineSheetPgel&&(o=t.inlineSheetPgel.getPage())&&(r=n&&n.source?n.source:null,i.codeChanged(o.url,function(){return o.getSource()},r,null,{}))}),r.addEventHandler("on_css_file_saved",function(e,t){t.url&&(i.onCssSaved(t.url),u(t.url).forEach(function(e){e.view&&e.view.setModified(!1)}))}),r.addEventHandler("on_page_saved",function(e){i.onPageSaved(e.url)}),r.addEventHandler("on_selected_elements_changed",function(e,t,n){var o;n?.sourceType&&"undo"===n?.sourceType||(o=r.selectedElements.getLastSelected())&&!s&&(e=o.getPage())&&o&&i.elementWasSelectedInPreview(e.url,o.getPath(),n)}),r.addEventHandler("on_css_source_changed",n),$("body").on("crsa-rule-selected",function(e,t){!pgf.kids&&pgPageCodeEditorsStack.highlight_css_rule&&pgPageCodeEditorsStack.isEditorShown()&&t.rule&&t.rule.selector&&t.source&&t.source instanceof PgStylesPane&&r.revealCSSRuleInCodeEditor(t.rule)})}),$("body").on("crsa-variables-changed crsa-stylesheets-changed crsa-rule-changed-in-editor",n).on("crsa-page-closed crsa-page-loaded crsa-page-saved-as crsa-stylesheets-changed",function(){t()})},codeEditors=new PgApiCodeEditors(new PgApiCodeEditorConnector),CrsaCodeEdit=function(){this.currentPage=null,this.currentCrsaPage=null,this.currentCodePage=null;var c,d,u,g,s=null,n=null,h=null,f=$("#textedit_wrapper"),p=$("#textedit"),m=$("#textedit_bar"),w=m.find("select.edit-css-select"),a=m.find(".live-update"),l=(a.tooltip({container:"body",placement:"bottom",title:"Auto refresh page view. If disabled - or if the code has syntax errors - click on Refresh! (CMD + R) to refresh page view.",trigger:"hover"}),!0),v=null,C=("1"==pinegrow.getSetting("code-live-update","1")&&a.attr("checked","checked"),function(){return l&&a.is(":checked")}),E=0,P=function(e,t,n){var o=!0;switch(t){case"page":r="Can't auto refresh. Whole page changed.";break;case"error":var r="Can't auto refresh. Code has syntax errors.",i=(new Date).getTime();30*1e3<i-E?E=i:o=!1;break;case"slow":r="Auto refresh takes too long.",o=!1;break;default:r=""}e?(a.parent().removeClass("manual"),v=null):((l||n)&&o&&crsaQuickMessage(" "+r+" <b>Refresh (CMD + R)</b> manually.",3e3),a.parent().addClass("manual"),v&&"page"!=t||(v=t)),l=e},t=(this.refreshBeforeSaveIfNeeded=function(){"html"==g&&this.isInEdit(this.currentPage)&&(x||"page"==v)&&(this.refreshPreview(),x=!1)},a.on("change",function(){pinegrow.setSetting("code-live-update",C()?"1":"0"),C()?crsaQuickMessage("Auto refresh is enabled."):(crsaQuickMessage("Auto refresh is disabled."),showNotice("Click on <b>Refresh!</b> or press <b>CMD + R</b> to manually refresh page view after you make changes.","Auto update is disabled","auto-refresh"))}),m.find(".wrap")),S=(t.on("change",function(){var e=t.is(":checked");pinegrow.setSetting("code-wrap",e?"1":"0"),u.setOption("lineWrapping",e)}),"1"==pinegrow.getSetting("code-wrap","1")&&t.attr("checked","checked"),!1),y=null,_=!1,x=!1,b=this,F=!1,r={},I=function(e){g=e,m.find(".mode-button").removeClass("active-mode"),m.find(".edit-"+e).addClass("active-mode"),"js"==e?(m.find(".mode-button").hide(),m.find(".edit-refresh").hide()):(m.find(".mode-button").show(),m.find(".edit-refresh").show())},k=(I("html"),this.findAndHideIds=function(e,t){for(var n=[],o=/data-pg-id="([0-9]+)"/g,r=e.getDoc(),i=r.lineCount(),s=0;s<i;s++){var a,l=r.getLine(s);if(l)for(o.lastIndex=0;null!==(a=o.exec(l));){var c=o.lastIndex-a[0].length-1,d=a[1]+"";n.push({line:s,ch:c,id:d,len:a[0].length+1})}}try{t&&$.each(t,function(e,t){t.clear()})}catch(e){}t={};for(s=0;s<n.length;s++)t[n[s].id]=r.markText({line:n[s].line,ch:n[s].ch},{line:n[s].line,ch:n[s].ch+n[s].len},{collapsed:!0,inclusiveLeft:!1,inclusiveRight:!0});return t},this.findAndHideCollapsed=function(e){for(var t=[],n=/data-pg-collapsed/g,o=e.getDoc(),r=o.lineCount(),i=0;i<r;i++){var s,a=o.getLine(i);if(a)for(n.lastIndex=0;null!==(s=n.exec(a));){var l=n.lastIndex-s[0].length-1,c=s[1]+"";t.push({line:i,ch:l,id:c,len:s[0].length+1})}}for(i=0;i<t.length;i++)o.markText({line:t[i].line,ch:t[i].ch},{line:t[i].line,ch:t[i].ch+t[i].len},{collapsed:!0,inclusiveLeft:!1,inclusiveRight:!0})},!0),T=(this.editorSizeChanged=function(){u&&u.refresh()},this.selectElementInCodeMirror=function(e,t,n){var o=getElementPgNode(e);if(o){var r=o.getId(),o=o.toStringWithIds(!0,pinegrow.getFormatHtmlOptions()).split("\n");if(n[r+=""]){var i=n[r].find(),s=t.getDoc(),a=0;if(i){for(var l=i.from.line,c=i.from.line,d=i.from.ch;0<=c;){var u=s.getLine(c);if(u&&u.length){c!=i.from.line&&(d=u.length-1);u=u.lastIndexOf("<",d);if(0<=u){a=u,l=c;break}}c--}s.setSelection({line:l,ch:a},{line:i.from.line+o.length-1,ch:o[o.length-1].length+(o.length,a)},{scroll:k})}}}},this.selectElementInEditor=function(e){var t;"html"==g&&(F&&(x?F=!1:(t=u.getScrollInfo(),O(),u.scrollTo(t.left,t.top))),this.selectElementInCodeMirror(e,u,r)),k=!0},pinegrow.addEventHandler("on_element_selected",function(e,t,n){n&&n.sourceType&&"undo"==n.sourceType||b.currentPage&&t&&setTimeout(function(){var e=t.get$DOMElement();b.selectElementInEditor(e)},100)}),0),M=0,D=function(e){var t,n,o,r,i;!S&&u&&(t=getCrsaPageForIframe(b.currentPage),n=u.getDoc().getValue(),r=(new Date).getTime(),x=!0,"html"==g?C()||_||"error"==v||"page"==v?(o=S,r=(new Date).getTime(),S=!0,i=t.applyChangesToSource(n,!_),S=o,150<(new Date).getTime()-r&&P(!1,"slow"),F=!0,i.updated?(C()||"error"!=v||(P(!0),t.setSyntaxErrorIndicator(!1)),(i.stylesheets_changed||i.scripts_changed)&&1e4<r-T&&(crsaQuickMessage("<b>Refresh (CMD + R)</b> to update scripts and stylesheets list."),T=r),x=!1):i.changes&&!i.update?(P(!1,"page"),x=!1):i.errors&&!i.update&&(P(!1,"error",1e4<r-M),t.setSyntaxErrorIndicator(!0),M=r)):"slow"==v&&(s&&clearTimeout(s),s=setTimeout(function(){s=null,P(!0),D()},1e3)):("js"==g?b.currentCodePage&&(b.currentCodePage.applyChangesToSource(n),N()):"css"==g&&y&&(s&&(clearTimeout(s),s=null),s=setTimeout(function(){x=!1,y.forgetSourceErrors(),y.setSource(n,function(){var e=y.getError();d=e?(console.log(e),!0):d&&!1,$("body").trigger("crsa-stylesheets-changed")})},750)),0))},H=function(e){var t=e.match(/<body[^>]*>([\s\S]*)<\/body>/im);return t?t[1]:null},R=function(){var e,n;return b.currentPage?(e=getCrsaPageStylesForPage(b.currentPage),n=[],e&&$.each(e.getAllCrsaStylesheets(),function(e,t){!t.inline&&t.loaded&&n.push(t)}),n):[]},j=function(){I("css");function n(e){function o(e){for(var t=0;t<e.length;t++){var n=e[t];if(n.name==r&&(y=n),0<n.importedFiles.length)return o(n.importedFiles)}}o(e.importedFiles)}var r=w.val(),e=(g="css",R());$.each(e,function(e,t){if((t=t.compiledFile?t.sourceStylesheet:t).name==r)return y=t,!1;n(t)}),y&&O()},i=(w.on("change",function(e){setTimeout(function(){j()},10)}),this.pageChanged=function(e,t){S||setTimeout(function(){var e=u.getScrollInfo();O("html"==g?t:null),u.scrollTo(e.left,e.top)},1)},null),U=function(e){m.find(".file-name").html(e)},N=function(){b.currentCodePage&&U(b.currentCodePage.name+(b.currentCodePage.hasChanges()?" *":""))},O=function(e){i&&(clearTimeout(i),i=null),S=!0;var n,t="";switch(g){case"css":var t=y?y.filterSource(y.getSource(),!0):"",o="text/css";y&&("scss"==y.fileType?o="text/x-scss":"less"==y.fileType&&(o="text/x-less")),u.setOption("mode",o),u.getDoc().setValue(t),S=!1,U(y?crsaGetNameFromUrl(y.url):"- none -");break;case"js":b.currentCodePage&&(n=crsaGetExtFromUrl(b.currentCodePage.url),o=null,pinegrow.isFileEditable(b.currentCodePage.localFile)&&(o="application/x-httpd-php"),$.each({"php,php5":"application/x-httpd-php",js:"text/javascript",json:"application/json","css,less,scss":"text/css"},function(e,t){if(0<=e.split(",").indexOf(n))return o=t,!1}),u)&&u.setOption("mode",o),u.getDoc().setValue(b.currentCodePage?b.currentCodePage.code:""),S=!1,N();break;default:U(b.currentCrsaPage.tab_name),t=e||getCrsaPageForIframe(b.currentPage).sourceNode.toStringWithIds(!0,pinegrow.getFormatHtmlOptions()),F=!1,H(t),u.operation(function(){u.setOption("mode","application/x-httpd-php"),u.getDoc().setValue(t),r=b.findAndHideIds(u,r),i=setTimeout(function(){S=!1,i=null},100)})}},A=($("body").on("crsa-page-selected",function(e,t){u&&"js"!=g&&t&&t!=b.currentCrsaPage&&(b.exitEdit(!1,!0),b.editCode(t.$iframe,null,b.currentCodePage))}),this.exitEdit=function(e,t){this.refreshBeforeSaveIfNeeded(),W&&!t&&W.hide();this.currentPage;this.currentPage=null,this.currentCrsaPage=null,this.currentCodePage=null,$("body").append(f),f.hide(),p.html(""),pinegrow.code_editors.unregister(u),u=null,n&&(clearTimeout(n),n=null),e&&"js"!=g&&$("body").trigger("crsa-stylesheets-changed"),$.fn.crsa("resizeChrome")},this.isInEdit=function(e){return e&&!e instanceof CrsaPage?(console.log("isInEdit page not CP"),!1):this.currentCrsaPage==e||!(!this.currentCodePage||e)},this.getExternalWindow=function(){return W},this.refreshPreview=function(){x?(_=!0,D(null),_=!1,crsaQuickMessage("Page view was refreshed.")):(this.currentCrsaPage.refresh(),P(!0))},0),W=(m.find("a, button").on("click",function(e){var t=$(e.delegateTarget);if(t.hasClass("edit-win")){b.showInExternalWindow=!b.showInExternalWindow,t.find("i").removeClass("fa-expand fa-compress").addClass(b.showInExternalWindow?"fa-compress":"fa-expand");var n=b.currentCrsaPage,o=b.currentCodePage;b.exitEdit(),b.editCode(n?n.$iframe:null,null,o),!b.showInExternalWindow&&W&&(W.close(!0),W=null)}else if(t.hasClass("edit-done"))b.exitEdit(!0);else if(t.hasClass("edit-refresh")){if(e.target==a.get(0))return;b.refreshPreview()}else b.refreshBeforeSaveIfNeeded(),t.hasClass("edit-html")?I("html"):t.hasClass("edit-js")?I("js"):t.hasClass("edit-css")&&j(),O();A=0,e.preventDefault()}),this.selectClickedElement=function(e,t){var n=e.coordsChar({left:t.pageX,top:t.pageY},"page");this.selectElementAtCursorPosition(e,n)},this.selectElementAtCursorPosition=function(e,t){if(console.log(t),t){var n,o,r=null,i={};do{(o=function(e,t,n){for(var o=e.getDoc(),r=null,i=null,s={line:t.line,ch:t.ch};0<=s.line&&!i;){i=CodeMirror.findMatchingTag(e,s,0);s.ch--,s.ch<0&&(s.line--,0<=s.line)&&(c=o.getLine(s.line).length,s.ch=c.length?c.length-1:0)}if(i&&i.open)for(var a=i.open.from.line,l=i.open.from.ch,c=o.getLine(a);"string"==typeof c;){var d=c.indexOf("data-pg-id",l);if(d<0)a++,c=o.getLine(a),l=0;else{d=(c=c.substr(d)).match(/data\-pg\-id="([0-9]+)"/);if(d){r=d[1],n&&(n.line=s.line,n.ch=s.ch,n.tag=i);break}}}return r}(e,t,i))&&(r=getPgNodeByPgId(o),t.line=i.line,t.ch=i.ch-1,t.ch<0)&&(t.line--,0<t.line)&&((n=e.getDoc().getLine(t.line))&&n.length?t.ch=n.length-1:t.ch=0)}while(o&&0<=i.line&&r&&"br"==r.tagName);r&&setTimeout(function(){k=!1,pinegrow.selectElement(r,"code_click"),r.scrollTo()},10)}},this.setFontSize=function(t,n,e){pinegrow.code_editors.forEachEditor(function(e){e.updateOptions({fontSize:t}),e.updateOptions({fontFamily:""==n?"monospace":n})})},null),L=(this.showInExternalWindow=!1,this.editCode=function(e,t,n){var o;this.showInExternalWindow?(pinegrow.stats.using("edit.pagecodewin"),W?(this.showEditor(e,W,n),W.show(),W.focus(),t&&t()):(o=require("nw.gui"),W=o.Window.open("empty.html",{focus:!0,toolbar:!1,title:"Pinegrow - Edit code"}),new pgWindowManager(W,"editCode",function(e){}),W.on("close",function(){b.exitEdit(!0),W.close(!0),W=null}),W.on("loaded",function(){b.setFontSize(pinegrow.getSetting("code-size","12px"),pinegrow.getSetting("code-font","")),b.showEditor(e,W,n),$(W.window.document).on("keydown",function(e){return $.fn.crsa("processKeydownEvent",e)}),t&&t()}),(o=o.Window.get()).on("focus",function(){W&&W.setAlwaysOnTop(!0)}),o.on("blur",function(){W&&W.setAlwaysOnTop(!1)}))):(this.showEditor(e,null,n),t&&t())},this.closeExternalWindow=function(){W&&(W.close(!0),W=null)},!1);this.isEditingCodeOnlyPage=function(e){return this.currentCodePage&&"js"==g&&(!e||e==this.currentCodePage.url)},this.isEditorFocused=function(){return!!$(document.activeElement).closest("#textedit").length},pinegrow.addEventHandler("on_page_saved",function(e){"js"==g&&b.currentCodePage==e&&N()}),this.showEditor=function(e,t,n){if(pinegrow.stats.using("edit.pagecode"),u&&this.exitEdit(!0),this.currentPage=e,this.currentCrsaPage=getCrsaPageForIframe(e),this.currentCodePage=n,e){getIframeBody(this.currentPage[0]);if(c=getIframeDocument(this.currentPage[0]),h=$(c).find("> html"),!canMakeChange(getElementPgNode(h),"edit_code"))return}else h=c=null;function o(e){function o(e){for(var t=0;t<e.length;t++){var n=e[t];l(n),0<n.importedFiles.length&&o(n.importedFiles)}}o(e.importedFiles)}t?(i=$(t.window.document.body),f.css("height","auto").css("width","auto").css("top",0).css("right",0).css("left",0).css("bottom",0).appendTo(i.find("#win-content"))):$("body").append(f);var r=null,i=(I(n?"js":"html"),0),s=(this.editorHandlesUndo=!1,{"Ctrl-Q":function(e){e.foldCode(e.getCursor())},"Ctrl-Space":"autocomplete"}),a=("js"!=g?s["Ctrl-Z"]=function(e){}:(i=100,this.editorHandlesUndo=!0),u=CodeMirror(function(e){p.append($(e).css("height","100%")),r=$(e)},{pgWindow:W?W.window:window,mode:"text/html",autoFocus:!0,theme:pinegrow.getSetting("code-theme-cm",pinegrow.defaults.codeTheme),indentUnit:parseInt(pinegrow.getSetting("html-indent-size","4")),tabSize:parseInt(pinegrow.getSetting("html-indent-size","4")),lineWrapping:"1"==pinegrow.getSetting("code-wrap","1"),lineNumbers:!0,matchBrackets:!0,autoCloseBrackets:!0,autoCloseTags:!0,matchTags:!0,undoDepth:i,extraKeys:s,foldGutter:!0,gutters:["CodeMirror-linenumbers","CodeMirror-foldgutter"],profile:"xhtml",hintOptions:{completeSingle:!1}}),setTimeout(function(){u.focus()},100),setLightDarkClassForEditor(r,pinegrow.getSetting("code-theme-cm",pinegrow.defaults.codeTheme)),showAutoCompleteOnInput(u),pinegrow.code_editors.register(u),r.attr("data-has-codemirror","").data("codeMirrorInstance",u),"true"===pinegrow.getSetting("editor-emmet",pgf.default_emmet_setting)&&emmetCodeMirror(u),isApp()&&r.on("copy",function(){var t=u.getDoc().getSelection();t&&t.length&&setTimeout(function(){var e=require("nw.gui").Clipboard.get();t=pgRemovePgIdsFromCode(t),e.set(t,"text")},50)}),u.on("contextmenu",function(e,t){return b.selectClickedElement(u,t,b.currentCrsaPage),!1}),null),i=(u.on("change",function(e,t){a&&clearTimeout(a),"js"==g||"css"==g&&S?D(t):a=setTimeout(function(){D(t),a=null},200)}),A=0,u.on("beforeChange",function(e,t){if(!S&&"html"==g){if(t.text&&t.update){for(var n=[],o=0;o<t.text.length;o++)t.text[o].length,n.push(t.text[o].replace(/\sdata-pg-id="[0-9]+"/g,""));t.update(null,null,n);var r=(new Date).getTime();5e3<r-A&&(A=r,willMakeChange(b.currentPage,"Edit code"))}t.update||console.log("UNDO in edit code")}}),f.show(),f.find(".tree-resizer").remove(),$("<div/>",{class:"tree-resizer"}).appendTo(f).on("mousedown",function(e){p.position().left,p.width(),e.preventDefault(),$.fn.crsapages("showOverlays"),m.height();$("body").on("mousemove.editResizer",function(e){var t=e.pageY,n=$(window).height(),t=n-t,n=n-(t=n-80<(t=t<80?80:t)?n-80:t);f.css("top",n+"px").css("height",t+"px"),localStorage.crsaCodeEditHeight=t}).on("mouseup.editResizer",function(e){e.preventDefault(),$("body").off(".editResizer"),$.fn.crsapages("showOverlays",!0),$(window).trigger("resize")})})),s=(t?i.hide():i.show(),$.fn.crsa("resizeChrome"),d=!1,R()),l=(w.html(""),function(e){$("<option/>",{value:e.name}).html(e.name).appendTo(w)});$.each(s,function(e,t){t.compiledFile&&(t=t.sourceStylesheet),l(t),o(t)}),y&&w.val(y.name),n&&I("js"),O(),L||(showNotice('<p><b>New in Pinegrow: Open code editor in external window!</b><p>Click on the <i style="color:#333;" class="fa fa-expand"></i> icon in the code editor toolbar to open the editor in an external window. That\'s especially useful if you have multiple screens.</p><p><b>Code view and Page view are in sync</b></p><p>When you select an element on the page it gets highlighted in the code. When you make a change on the page the code gets updated.</p><p><b>Right click</b> on the element in the code to select the element on the page.</p><p>Use <b>Page -&gt; Refresh (CMD + R)</b> to refresh the view if it gets messed up during editing. No need to save the page first.</p>',"A note about code view","code-view-4"),L=!0),C()||crsaQuickMessage("Auto refresh is disabled. Press <b>CMD + R</b> to refresh.",3e3),"html"==g&&(i=pinegrow.getSelectedElement())&&this.selectElementInEditor(i.get$DOMElement()),0}};