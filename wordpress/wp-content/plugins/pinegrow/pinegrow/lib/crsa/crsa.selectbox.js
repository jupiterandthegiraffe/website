var CrsaSelectBox=function(f,c){function e(e){var t,s;if(u&&(r.startSelect(),h))return t=Math.abs(o.left-e.pageX),s=Math.abs(o.top-e.pageY),v.css({width:t,height:s}),e.pageX<=o.left&&e.pageY>=o.top?v.css({left:e.pageX}):e.pageY<=o.top&&e.pageX>=o.left?v.css({top:e.pageY}):e.pageY<o.top&&e.pageX<o.left&&v.css({left:e.pageX,top:e.pageY}),t="",o.top>e.pageY?t="up":o.top<e.pageY&&(t="down"),(s=$(e.target).closest("li")).hasClass(c.itemClass)||(s=[]),e.metaKey||e.shiftKey||C(),y(l,s,t),!1}function t(e){var t;3!=e.which&&(d=$(e.target),!c.isAllowed||c.isAllowed(d))&&(u=!0,l=d.is(f)?d:d.closest("li"),o={left:e.pageX,top:e.pageY},v.css(o),parseInt(f.css("width"),10),parseInt(f.css("height"),10),e.metaKey||e.shiftKey?(t=$(e.target).closest("li")).hasClass(c.itemClass)&&(t.hasClass(g)?t.removeClass(g):t.parent().closest("."+c.itemClass).hasClass(g)||t.addClass(g)):C())}function s(e){!c.isDraggableElm||c.isDraggableElm(d)||(r.startSelect(),(i=this.cloneNode(!0)).style.visibility="hidden",document.body.appendChild(i),e.dataTransfer.setDragImage(i,0,0),e.dataTransfer.effectAllowed="none")}function a(e){w(e),i&&c.isDraggableElm&&(document.body.removeChild(i),d=i=null)}var g="selected-item",n=!1,r=this,o={left:0,top:0},i=null,l=null,d=null,h=(parseInt(f.css("width"),10),parseInt(f.css("height"),10),!1),u=!1,v=$('<div class="select-box"></div>').appendTo($("body")),p=($("#crsa-dummy-field"),[]),m=function(e,t){var s=e.offset().top,a=(e.offset().left,parseInt(e.css("height"),10)),n=t.offset().top,r=(t.offset().left,parseInt(t.css("height"),10));return s<n&&n<s+a||n<=s&&s<n+r},C=function(){f.find("."+g).removeClass(g)},b=function(){for(var e=0;e<p.length;e++)p[e].removeClass(g);p=[]},y=function(e,l,t){function s(a,e,n,t){var s=!1;if(d.is(f)){var r=f.find("> ."+c.overParentClassName);if(!(d=e(r))||0==d.length)return;s=!0}d.hasClass(c.itemClass)||(r=d.closest("."+c.overParentClassName),0<(r=t||s?r:a(r)).length&&(d=r.find(c.selectorToFindChild+":"+n+"-child")));for(var o=!1;0<d.length;){if(d.hasClass(c.itemClass)){if(!m(d,v))break;p.push(d),d.parent().closest("."+c.itemClass).hasClass(g)||d.addClass(g)}var i=a(d);if(0==i.length&&(i=function(e){for(;1;){var t=e.closest("."+c.overParentClassName),t=a(t);if(!(0<t.length))return[];var s=t.find(c.selectorToFindChild+":"+n+"-child");if(0<s.length)return s;e=t}}(d)),d=i,o)break;d[0]==l[0]&&(o=!0)}}var d=e;b();"up"==t?s(function(e){return e.prev()},function(e){for(var t=e.length-1;0<=t;t--){var s=$(e[t]);if(m(s,v))return s}},"last"):"down"==t&&s(function(e){return e.next()},function(e){for(var t=0;t<e.length;t++){var s=$(e[t]);if(m(s,v))return s}},"first",!0)},E=function(e){null!=E&&C()},w=function(e){if(p=[],u=!1,h)return v.css({display:"none",width:0,height:0}),h=!1};n&&(f.get(0).addEventListener("mousedown",t),document.body.addEventListener("mousemove",e),document.body.addEventListener("mouseup",w),f.get(0).addEventListener("dragstart",s,!0),f.get(0).addEventListener("dragover",e,!0),f.get(0).addEventListener("dragend",a,!0),$("body").on("crsa-page-changing",E)),this.remove=function(){n&&(document.body.removeEventListener("mousemove",e),document.body.removeEventListener("mouseup",w),f.get(0).removeEventListener("mousedown",t),f.get(0).removeEventListener("dragstart",s,!0),f.get(0).removeEventListener("dragover",e,!0),f.get(0).removeEventListener("dragend",a,!0),$("body").off("crsa-page-changing",E)),E=null},this.startSelect=function(){h=!0,v.show()}};