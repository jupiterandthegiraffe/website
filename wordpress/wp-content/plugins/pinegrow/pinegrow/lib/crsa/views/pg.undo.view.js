var PgQuickUndoView=function(){var e=new PgUndoView,n=new PgQuickWindow("Undo stack",e,"quickUndo",300,520),a=((e.quickWin=n).showFor$El($("body")),pinegrow.getSelectedPage());a&&e.show(a),n.onDestroy=function(){}},PgUndoView=function(){function e(e){p||t.show(e)}function n(e,n){s.selectTab(null==e?r:l)}var p=!1,u=$('<div class="pg-undo-view"></div>'),a=new PgUIView(u,"history"),t=(a.tabIcon="icon-undo",this.view=a,this),w=[],h=null,o=new PgButtonToolbar,s=(u.append(o.$element.addClass("pg-tabs-toolbar")),new PgToolbarTabButtons(o,"tabs")),i=s.addTab(pgf.edit_html?"Combined history":"History",pgf.edit_html?"Combined history for all pages and stylesheets.":"Undo history for all pages",null,pinegrow.undoManager.getUseCombined()),l=(i.setClosable(!1),s.addTab("HTML","Selected page HTML history",null,!pinegrow.undoManager.getCssActive())),r=(l.setClosable(!1),s.addTab("CSS","CSS Stylesheets history",null,pinegrow.undoManager.getCssActive())),o=(r.setClosable(!1),s.onTabSelected=function(e){pinegrow.undoManager.setCssActive(e==r),t.show()},o.addSection("icons"),new PgButtonToolbarItem("icon-down","History options.")),d=(pgf.edit_html&&0&&(o.onClick=function(){new CrsaContextMenu([{label:"Separate histories for pages and CSS",check:function(){return!pinegrow.undoManager.getUseCombined()},action:function(){var e=!pinegrow.undoManager.getUseCombined();pinegrow.showAlert("<p>Changing the history mode will erase undo histories for all pages and stylesheets.</p><p>Are you ok with that?</p>","This action will purge all undo histories","Cancel","Yes",null,function(){d(e),pinegrow.undoManager.setUseCombined(e),pinegrow.showMode("Separate histories",!e)})}}]).showForElement(this.$element)}),function(e){e?(l.hide(),r.hide(),i.show(),i.setActive(!0)):(l.show(),l.setActive(!pinegrow.undoManager.getCssActive()),r.show(),r.setActive(pinegrow.undoManager.getCssActive()),i.hide())}),o=(d(pinegrow.undoManager.getUseCombined()),$('<div class="pg-panel-tab-content"></div>').appendTo(u)),m=$('<ul class="pg-assign-classes-list"></ul>').appendTo(o);this.show=function(e){a.whenVisible(function(){h=pinegrow.undoManager.getActiveHistory();var t=pinegrow.undoManager.getUseCombined(),o=(pinegrow.getSelectedPage(),p=h.css,m.empty(),h.getInfo()),s="",i=!0,l=null,r=!1,d=null,g=!1,e=(w=o.states,"<span>Start<span>"),c=(o.start_state&&(e="<span>"+o.start_state.name+"<span>"),null===o.current_state?(i=!1,s+='<li class="active">'+e+"</li>"):s+='<li class="start">'+e+"</li>",0),e=(w.forEach(function(e){var n="",a=(e==o.current_state?(n="active",i=!1):i||(n="after"),"");e.element_names&&"Project"!==(e.page_name||"")&&(a=e.element_names,n+=" with-name"),s+='<li class="'+n+'" data-state-id="'+c+'">',t&&(e.page_name&&(s+='<span class="undo-page-name">'+e.page_name+(1<e.pages.length?` +${e.pages.length-1} more`:"")+"</span>",null!==l&&l!==e.page_name?r=!0:l=e.page_name),e.cs_name)&&(s+='<span class="undo-cs-name">'+e.cs_name+"</span>",null!==d&&d!==e.cs_name?g=!0:d=e.cs_name),s+="<span>"+e.name+"</span>"+a+"</li>",c++}),m.html(s),r?m.addClass("show-page-names"):m.removeClass("show-page-names"),g?m.addClass("show-cs-names"):m.removeClass("show-cs-names"),m.find("> .active").position().top),n=u.height(),a=u.scrollTop();(e-30<a||a+n-30<e)&&u.scrollTop(e-Math.floor(n/2))})},m.on("click","li",function(e){e.preventDefault();var n=$(this),n=(n=parseInt(n.attr("data-state-id")))<w.length?w[n]:null;h.restoreState(n)}),a.onResize=function(){};pinegrow.addEventHandler("on_undo_state_added",n),pinegrow.addEventHandler("on_undo_redo",n),pinegrow.addEventHandler("on_page_selected",e),a.onDestroy=function(){pinegrow.removeEventHandler("on_page_selected",e),pinegrow.removeEventHandler("on_undo_state_added",n),pinegrow.removeEventHandler("on_undo_redo",n)}};