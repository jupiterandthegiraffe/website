var PgSnapView=function(e,t){function s(o,i,r){var s=pinegrow.getSelectedPage();s.activeView.getHTMLSnapshot(function(e,t){var n=m.join(h.getDir(),o+".html"),n=(f.writeFileSync(n,e,{encoding:"utf8"}),m.join(h.getDir(),"originals")),n=(crsaCreateDirs(n,f),m.join(n,o+".html")),n=(f.writeFileSync(n,e,{encoding:"utf8"}),m.join(h.getDir(),"thumbnails")),a=(crsaCreateDirs(n,f),m.join(n,o+".png"));c.addcustomcss&&(n=m.join(h.getDir(),"custom.css"),crsaIsFileExist(n)||f.writeFileSync(n,``,{encoding:"utf8"})),pinegrow.takePhotoOfPage(s,a,function(){pinegrow.showQuickMessage("Snapshot was saved!"),void 0===r?l.push({name:o,url:i,version:0}):(l[r].url=i,l[r].version++),v(),w(),pinegrow.thumbnailMaker.setProjectThumbnail(h,a),pinegrow.dispatchEvent("on_thumbnail_generated",null,h.getDir())},400)},c)}function o(e){return l[parseInt(e.currentTarget.getAttribute("data-idx"))]}function p(e){return h.getUrl()+"/"+e.name+".html"}var n=$('<div class="pg-snap"></div>'),a=new PgUIView(n,"snap","Snap"),l=((this.view=a).tabIcon=null,[]),i=[],c={},r=$(`<div class="pg-snap-controls"></div>`).appendTo(n),u=$(`<button class="pg-button pg-button-primary pg-take-snap">Take a snapshot</button>`).appendTo(r),d=$(`<button class="pg-button">Open url...</button>`).appendTo(r),r=$(`<button class="pg-button pg-options-button">Options...</button>`).appendTo(r),g=($(`<h3>Snapshots</h3>`).appendTo(n),$(`<div class="pg-snap-snaps"></div>`).appendTo(n)),h=null,m=require("path"),f=require("fs"),w=(r.on("click",function(e){e.preventDefault();for(var t=new PgDialog("Snapshot options"),n=(t.values=$.extend({},c),t.okButtonLabel="OK",t.before=`<p>How do you like your snapshots?</p>`,t.sections={snapoptions:{name:"Options",is_closable:!1,fields:{formathtml:{type:"checkbox",name:"Format HTML",value:"true",helptext:`<p>Format the HTML code to make it more readable. In some cases this can introduce layout errors because of extra spacings.</p>`},removejs:{type:"checkbox",name:"Remove all Javascript code",value:"true",helptext:`<p>Removing scripts ensures that the HTML snapshot is trully a static representation of the current page state. But any interactive elements that are powered by Javascript code will not work.</p>`},addcustomcss:{type:"checkbox",name:"Add custom.css",value:"true",helptext:`<p>Link custom.css stylesheet to the snapshot. Useful for overriding stylesheet styles.</p>`}}},appendcode:{name:"Add code",fields:{addtohead:{type:"text",textarea:!0,name:"Append this HTML code to the &lt;head&gt; element:",validate:function(e,t,n,a,o,i){if(n){var r=new pgParser;if(r.assignIds=null,r.parse(n),r.rootNode.validateTree().length)return"Should be a valid HTML. Are tags closed?"}},helptext:`<p>Add this code to the HEAD element. Useful for linking development stylesheets. Should be a valid HTML code.</p>`}}},snapmaps:{name:"URL Mapping",is_closable:!0,fields:{}}},5),a=!1,o=1;o<=n;o++)!function(r){t.sections.snapmaps.fields[`map${r}_label`]={type:"label",name:"Map "+r,action:"element_attribute",class:"pg-action-info-label"},t.sections.snapmaps.fields[`map${r}_search`]={type:"text",name:`If URL contains`,helptext:`<p>Enter the string to search for or regular expression in the form /.../.</p>`,validate:function(e,t,n,a,o,i){if(i[`map${r}_re`]&&n&&(!n.endsWith("/")||!n.startsWith("/")||n.length<3))return"Regular expression should start and end with /, without flags (ig is assumed)."}},t.sections.snapmaps.fields[`map${r}_replace`]={type:"text",name:`Replace the URL with`,helptext:`<p>Enter the new URL or the regular expression replace pattern.</p>`},t.sections.snapmaps.fields[`map${r}_re`]={type:"checkbox",name:"Use regular expression",value:"true",helptext:"<p>If checked, Search should be a regular expression in the form /.../ and Replace should be a regular expression replace pattern.</p>"},a=a||t.values[`map${r}_search`]||t.values[`map${r}_replace`]}(o);a||(t.sections.snapmaps.closed=!0,t.sections.appendcode.closed=!0),t.onOK=function(){var e=pinegrow.getCurrentProjectInfo();e.setSetting("snap-options",t.values),e.save(),c=t.values};var i=t.show();i.find(".pg-ui-section:first-child h2").hide(),i.find(".pg-ui-section:first-child").css({paddingTop:0,marginTop:0})}),d.on("click",function(e){e.preventDefault(),pinegrow.showEnterUrlPrompt(function(e){e.startsWith("file://")?pinegrow.showQuickError("file:// urls are not supported. Please open the page from the server."):(b(e),pinegrow.openPage(e,function(e){},!0))},null,i)}),u.on("click",function(e){e.preventDefault();var i=pinegrow.getSelectedPage();i?pinegrow.showPrompt(`<p>The snapshot will be saved as {name}.html.</p>`,"Give the new snapshot a name","","dashboard",null,function(e){if(e){for(var t=(e=e.endsWith(".html")?e.replace(/\.html$/,""):e).toLowerCase(),n=null,a=0;a<l.length;a++)if(l[a].name.toLowerCase()===t){n=a;break}var o=m.join(h.getDir(),e+".html"),o=crsaIsFileExist(o);null!==n||o?(o=null===n&&o?`File <b>${e}.html</b> already exists in the project folder. Do you want to overwrite it? `:`<p>Snapshot <b>${e}.html</b> already exists. Do you want to overwrite it?</p>`,pinegrow.showAlert(o,"Overwrite "+e+"?","Cancel","Yes, overwrite it",null,function(){null!==n?s(e,i.activeView.getViewUrl(),n):s(e,i.activeView.getViewUrl()),b(i.activeView.getViewUrl())})):(s(e,i.activeView.getViewUrl()),b(i.activeView.getViewUrl()))}else pinegrow.showQuickError("The name is required.")}):pinegrow.showQuickError("Please open a url first.")}),function(){g.empty();var n="",a=0;l.forEach(function(e){var t=crsaMakeUrlFromFile(m.join(h.getDir(),"thumbnails",e.name+".png?v="+e.version));n+=`<div class="pg-snap-snaps-snap" data-idx="${a}"><img src="${t}" /><p>${e.name}.html</p></div>`,a++}),g.html(n)}),v=(g.on("aaaclick",".pg-snap-snaps-snap",function(e){e.preventDefault();var t=o(e);pinegrow.openExternalUrl(p(t))}),g.on("click contextmenu",".pg-snap-snaps-snap",function(e){e.preventDefault();var i=o(e),r=parseInt(e.currentTarget.getAttribute("data-idx")),t=pinegrow.getSelectedPage(),n=t?t.activeView.getViewUrl():null,a=[];return t&&(a.push({label:"Update the snapshot",action:function(){s(i.name,n,r)}}),a.push({type:"divider"})),a=a.concat([{label:"Edit the snapshot in Pinegrow Web Editor",action:function(){pinegrow.showAlert(`<p>Sorry, the feature of automatically opening the HTML snapshot in Pinegrow Web Editor is not implemented yet.</p><p>Instead, <b>run Pinegrow Web Editor and open your whole project  or just this snapshot there</b>.</p><p>You can edit both HTML and CSS in Pinegrow Web Editor.</p>`,"Open the snapshot in Pinegrow Web Editor")}},{type:"divider"},{label:"Open URL "+crsaGetSummaryStr(i.url||"",45),action:function(){pinegrow.openOrShowPage(i.url,null,!0),b(i.url)}},{label:"Open the snapshot in external browser",action:function(){pinegrow.openExternalUrl(p(i))}},{type:"divider"},{label:"Delete...",action:function(){pinegrow.showAlert(`<p>Are you sure you want to delete this amazing snapshot?</p>`,"Are you sure?","No, I want to keep it","Yes, throw it away",null,function(){try{var e=m.join(h.getDir(),i.name+".html"),t=(f.unlinkSync(e),m.join(h.getDir(),"originals")),n=m.join(t,i.name+".html"),a=(f.unlinkSync(n),m.join(h.getDir(),"thumbnails")),o=m.join(a,i.name+".png");f.unlinkSync(o)}catch(e){pinegrow.showAlert(`<p>Could not delete snapshot or its thumbnail.</p><p>${e}</p>`,"Files are not deleted")}l.splice(r,1),v(),w(),pinegrow.showQuickMessage(i.name+` deleted.`)})}},{type:"divider"},{label:"Compare...",action:function(){var e=m.join(h.getDir(),i.name+".html"),t=m.join(h.getDir(),"originals"),t=m.join(t,i.name+".html"),e=f.readFileSync(e,{encoding:"utf8"}),t=f.readFileSync(t,{encoding:"utf8"});console.log(pgFindChangedNodesInPage(t,e))}}]),new CrsaContextMenu(a,$(e.target)).showAt(e.pageX,e.pageY),!1}),function(){var e=pinegrow.getCurrentProjectInfo();e.setSetting("snap-snaps",l),e.save()}),b=function(e){var t=i.indexOf(e);0<=t&&i.splice(t,1),i.unshift(e),10<i.length&&i.splice(10,i.length-10),y()},y=function(){var e=pinegrow.getCurrentProjectInfo();e.setSetting("snap-recent",i),e.save()};pinegrow.addEventHandler("on_project_loaded",function(e,t){h=t;var n=pinegrow.getCurrentProjectInfo(),a=n.getSetting("snap-options");c=a?$.extend({},a):{removejs:"true",addcustomcss:"true",formathtml:"true"},l=n.getSetting("snap-snaps")||[],i=n.getSetting("snap-recent")||[],w()}),pinegrow.addEventHandler("on_key_pressed",function(e,t,n){"s"==n.key&&n.ctrl&&(u.trigger("click"),n.done=!0)}),a.onAddedToLayout=function(e){},a.onResize=function(){},a.onDestroy=function(){}};