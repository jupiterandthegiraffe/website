var PgPageTreeManager=function(){var e=new PgEventHandler;e.on_event=function(e){e.page.tree&&e.page.tree.handleEvent(e)},e.start(),this.destroy=function(){e.destroy()}},PgTreeView=function(){pinegrow.registerTreeView(this);function F(e,n){var i=!0,a=!1,o=0,t=null;_(e,function(e){(t=pinegrow.getCollection(e)).forEachElement(function(e){o++;var t=e[n]();i=i&&t,a=a||t})}),i||(1==o?pinegrow.showQuickMessage("The element could not be moved."):pinegrow.showQuickMessage("Some elements could not be moved.")),a&&pinegrow.changeManager.didChange(t,"Level "+n)}var t,n,g,i,a,p,o=$("<div/>",{id:"pg-tree",class:"pg-tree"}),L=$("<div/>",{class:"pg-tree-container"}).appendTo(o),e=new PgSearchBox({toolbar_on:!pgf.kids}),l=(pgf.kids||(e.addIcon({icon:"icon-130",label:"Select search results",func:function(){V("select")}}),e.addIcon({icon:"icon-137",label:"Add search results to selection",func:function(){V("add")}}),e.addIcon({icon:"icon-138",label:"Deselect search results",func:function(){V("deselect")}})),this.toolbar=e.getToolbar()),s=(pgf.kids?e.$element.css({"margin-right":"10px"}):l.addSection("settings").$element,new PgButtonToolbarItem("icon-filter","Select what kind of elements to show in the tree.")),r=(pgf.kids||l.addItem("settings",s),{styles:{label:"Inline styles",desc:"Show only the elements with inline styles"},images:{label:"Images",desc:"Show only images"},links:{label:"Links",desc:"Show only links"},texts:{label:"Texts",desc:"Show only the elements with textual content"},components:{label:"Components &amp; Editable",desc:"Show only components and editable areas"}}),d=((pinegrow.hasActivatedProduct("WP")||pinegrow.isTrial())&&(r.wp={label:"WordPress actions",desc:"Show only the elements with WordPress actions"}),(pinegrow.hasActivatedProduct("WC")||pinegrow.isTrial())&&(r.wc={label:"WooCommerce actions",desc:"Show only the elements with WooCommerce actions"}),!1),W=((pinegrow.hasActivatedProduct("IA")||pinegrow.isTrial())&&(r.ia={label:"Interactions",desc:"Show only the elements with Interactions"},d="1"===pinegrow.getSetting("pgia-show-in-tree","1")),pgf.components||delete r.components,{}),c=($.each(r,function(e,t){W[e]=!1}),W),u=(s.onClick=function(){var n=new CrsaContextMenu(null,this.$element);n.add({type:"header",label:"Filter (show el. with):"}),$.each(r,function(t,e){n.add({label:e.label,action:function(){var e=!(!0===c[t]);w.setFilterOption(e?t:null)},check:!0===c[t]})}),n.add({type:"divider"}),n.add({label:"Clear filter",action:function(){w.setFilterOption(null)}}),n.add({type:"divider"}),n.add({type:"header",label:"Settings"}),(pinegrow.hasActivatedProduct("IA")||pinegrow.isTrial())&&n.add({label:"Show interactions",action:function(){d=!d,pinegrow.setSetting("pgia-show-in-tree",d?"1":"0"),i.tree.setShowInteractions(d),i.tree.create(),C(i)},check:!0===d}),n.showForElement(this.$element,null,8)},this.canHandleDragType=function(e){return"html"===e},this.setFilterOption=function(e,t){var n;c=$.extend({},W),e?(n=r[e],c[e]=!0,s.setActive(!0),pinegrow.showMode(n.desc,!0),G(n.label)):(s.setActive(!1),G()),i.tree.setFilterOptions(c),t||g&&g.tree.research(!0)},new PgButtonToolbarItem("icon-down","Tree options (Source or DOM, auto collapse...)")),h=(pgf.kids||l.addItem("settings",u),"1"===pinegrow.getSetting("tree-dom-mode","0")),f=parseInt(pinegrow.getSetting("tree-auto-collapse",(isApp(),0))),B=(u.onClick=function(){var e=[{type:"header",label:"Show"},{label:"Source code structure",help:"Show the page structure as defined in the source code.",check:!h,action:function(){h=!1,pinegrow.showMode("Show source code structure",!0),pinegrow.setSetting("tree-dom-mode",h?"1":"0"),i.tree.setDomMode(h),i.tree.create(),C(i)}},{label:"DOM structure",help:"Show the current DOM browser structure.",check:h,action:function(){h=!0,pinegrow.showMode("Show DOM structure",!0),pinegrow.setSetting("tree-dom-mode","1"),i.tree.setDomMode(h),i.tree.create(),C(i)}},{type:"divider"},{type:"header",label:"Options"},{label:"Auto collapse",check:0<f,submenu:[0,"Off",1,2,3,4,5].map(function(e){return 0===e?{type:"header",label:"Collapse from level"}:{label:e,action:function(){f="Off"===e?0:e,pinegrow.setSetting("tree-auto-collapse",f),i.tree.setAutoCollapse(f),i.tree.create(),C(i),pinegrow.showMode("Auto collapse tree","Off"!==e)},check:f===("Off"===e?0:e)}})}];return new CrsaContextMenu(e,u.$element).showForElement(u.$element),!1},e.$element.find(".pg-button-toolbar-section.icons")),V=(pgf.kids||(e.$element.appendTo(o),(new PgSearchBoxSpacer).$element.appendTo(o)),e.onSearch=function(e){var t=new CrsaProfile;g&&g.tree.search(e),e.length?pg$Show(B,"inline-block"):pg$Hide(B),t.show("SEARCH")},pg$Hide(B),function(e){var n=new PgCollection;I.data.forEach(function(e){var t;1===e.search&&(t=w.getPgel(e))&&n.add(t)});"select"==e&&pinegrow.selectedElements.clear(),"deselect"==e?pinegrow.selectedElements.deselectMany(n):pinegrow.selectedElements.selectMany(n)}),m=$('<div class="pg-tree-filter-msg"><div>Show only: <span></span><i class="close icon icon-close"></i></div></div>').appendTo(o),G=(pg$Hide(m),m.on("click",function(e){e.preventDefault(),w.setFilterOption(null)}),function(e){e?(m.find("span").html(e),pg$Show(m,"flex"),o.addClass("with-filter-msg")):(pg$Hide(m),o.removeClass("with-filter-msg"))}),v=(pgf.auto_focus&&((t=$('<div class="pg-tree-filter-msg"><div>Focus on: <span></span><i class="icon icon-down"></i></div><label><input type="checkbox" name="checkbox" value="1"'+(pinegrow.getAutoFocus()?" checked":"")+">Auto-focus on sections</label></div>").appendTo(o)).find("> div").on("click",function(e){e.preventDefault();var t,n=$(this),i=pinegrow.getSelectedPage();return i?(t=[],pinegrow.getIsolatedElement(i)&&(t.push({label:"Show whole page",action:function(){pinegrow.isolateElement(null)}}),t.push({type:"divider"})),t.push({type:"header",label:"Focus on:"}),t.push({label:"Page structure",action:function(){pinegrow.isolateElement(i.sourceNode.findOne("body"),{tree_hide_scripts:!0,drag_drop_only_top_level:!0})}}),i.sourceNode.find("header,footer,section").forEach(function(e){t.push({label:e.getName({short:!0}),action:function(){pinegrow.isolateElement(e,{},!0),pinegrow.selectElement(e),e.scrollTo()}})}),new CrsaContextMenu(t,n).showForElement(n)):pinegrow.showQuickError("Please open a page first"),!1}),t.find("input").on("change",function(e){var t=$(this).is(":checked");pinegrow.setAutoFocus(t)}),n=function(e){e?(t.find("> div").html(`Focus on <span>${e}</span><i class="icon icon-down"></i>`),t.removeClass("inactive")):(t.find("> div").html(`Whole page is displayed<i class="icon icon-down"></i>`),t.addClass("inactive"))}),o.find(".editor"),this.view=new PgUIView(o,"tree","Tree")),w=(v.classForContainer="pg-tree-panel-container",this),j=(v.tabIcon="icon-Pin11",new PgPageTreeManager),_=(v.onShow=function(){g&&g?.tree.scrollToSelected&&(I.scrollToDelayed(g.tree.scrollToSelected),g.tree.scrollToSelected=null)},function(e,t,n){var i=w.getPgelOfDataItem(e);i&&(pinegrow.selectedElements.isSelectedElement(i)&&!n?t(pinegrow.selectedElements.getCollection()):t(i))}),R=function(e){_(e,function(e){var t=e instanceof pgParserNode?e:e.getFirst();t.isHidden()?pinegrow.getCollection(e).forEachElement(function(e){e.show()}):(t.scrollTo(),setTimeout(function(){pinegrow.highlightElement(t.get$DOMElement())},50))})},Y=function(e,t){"svg"===e.tagName?t?e.removeAttr("data-pg-collapsed"):e.setAttr("data-pg-collapsed","false"):t?e.setAttr("data-pg-collapsed"):e.removeAttr("data-pg-collapsed"),pinegrow.dispatchEventDelayed("on_elements_collapsed_expanded",e.getPage())},l=[],e=!0,b=(pgf.edit_html&&e&&(l.push({icon:"icon-bin",name:"Delete",func:function(e){_(e,function(e){(new PgApi).removeElements(e)})},show:function(e,t){var n=t.pgel||w.getPgelOfDataItem(e);return(t.pgel=n)&&n.canDelete()}}),l.push({icon:"icon-duplicate",name:"Duplicate",func:function(e){_(e,function(e){(new PgApi).duplicateElements(e)})},show:function(e,t){var n=t.pgel||w.getPgelOfDataItem(e);return(t.pgel=n)&&n.canDuplicate()}})),e&&!pgf.kids&&l.push({icon:"icon-hide",name:"Hide / show in Pinegrow",key:"hide",func:function(e,i){_(e,function(e){var t=pinegrow.getCollection(e),n=i.find("i").hasClass("icon-hide");t.forEachElement(function(e){n?e.hide():e.show()}),i.find("i").removeClass("icon-hide icon-see").addClass(n?"icon-see":"icon-hide")})}}),pgf.edit_html&&!pgf.kids&&(l.push({icon:"icon-up",name:"Move up",func:function(e){var t=new PgApi;_(e,function(e){t.moveUp(e)})},show:function(e,t){var n=t.pgel||w.getPgelOfDataItem(e);return(t.pgel=n)&&n.canMove()}}),l.push({icon:"icon-down",name:"Move down",func:function(e){var t=new PgApi;_(e,function(e){t.moveDown(e)})},show:function(e,t){var n=t.pgel||w.getPgelOfDataItem(e);return(t.pgel=n)&&n.canMove()}}),l.push({icon:"icon-131",name:"Indent one level",func:function(e){F(e,"indent")},show:function(e,t){var n=t.pgel||w.getPgelOfDataItem(e);return(t.pgel=n)&&n.canMove()}}),l.push({icon:"icon-132",name:"Outdent one level",func:function(e){F(e,"outdent")},show:function(e,t){var n=t.pgel||w.getPgelOfDataItem(e);return(t.pgel=n)&&n.canMove()}}),l.push({icon:'<i class="icon icon-Ins_before"><span class="path1"></span><span class="path2"></span></i>',name:"Insert before",func:function(e){E(e,"insertBefore")},show:function(e,t){var n=t.pgel||w.getPgelOfDataItem(e);return(t.pgel=n)&&n.canHaveSiblings()}}),l.push({icon:'<i class="icon icon-Ins_after"><span class="path1"></span><span class="path2"></span></i>',name:"Insert after",func:function(e){E(e,"insertAfter")},show:function(e,t){var n=t.pgel||w.getPgelOfDataItem(e);return(t.pgel=n)&&n.canHaveSiblings()}}),l.push({icon:'<i class="icon icon-Append"><span class="path1"></span><span class="path2"></span></i>',name:"Insert into at beginning (prepend)",func:function(e){E(e,"prepend")},show:function(e,t){var n=t.pgel||w.getPgelOfDataItem(e);return(t.pgel=n)&&n.canHaveChildren()}}),l.push({icon:'<i class="icon icon-Prepend"><span class="path1"></span><span class="path2"></span></i>',name:"Insert into at end (append)",func:function(e){E(e,"append")},show:function(e,t){var n=t.pgel||w.getPgelOfDataItem(e);return(t.pgel=n)&&n.canHaveChildren()}})),pgf.kids||l.push({icon:"icon-right",name:"Collapse / Expand all",func:function(e){var n,t=!w.getPgelOfDataItem(e).isCollapsed();n=t,I.forEachDataAndDescendants(e,function(e){e.collapsed=n;var t=w.getPgel(e);t&&Y(t,e.collapsed)}),I.refresh()}}),new PgTreeNodeMenu(l)),I=(b.hide(),this.setPage=function(e){i=e},new PgTableGrid),D=(pgf.kids&&I.$element.css("top",0),I.draggable=pgf.edit_html,null),q=(this.getPgel=function(e){return this.getPgelOfDataItem(e)},I.onScroll=function(){D&&D.updatePosition(),N()},L.append(I.$element),b.$element.appendTo(o),I.setTemplate('<div><i data-element="icon" class="collapse-icon icon-down"></i><name data-element="name"></name><i data-element="hidden" class="icon icon-hide show-hide"></i></div>'),I.setTemplate('<div><i data-element="icon" class="collapse-icon icon-113"></i><name data-element="name"></name><div data-element="progress" class="pgia-progress"></div></div>',"interaction"),I.setTemplate('<div><i data-element="icon" class="collapse-icon icon-Scene_Scroll"></i><name data-element="name"></name><div data-element="progress" class="pgia-progress"></div></div>',"scrollscene"),I.onSetDataToCell=function(e,t){w.populateDataItem(e),"interaction"===t.type||"scrollscene"===t.type?(t.setHtml("name",e.name),t.getElement("progress").style.width="0",pgInteractionsTreeCellManager.register(e.pgia.id,t),n=t.getElement("name"),e.pgia.desc?(n.setAttribute("title",e.pgia.desc),n.classList.add("has-desc")):(n.removeAttribute("title"),n.classList.remove("has-desc"))):(t.setHtml("name",e.name),(e.selected||!1)!==(t.isSelected||!1)&&(e.selected?t.$element.addClass("selected"):t.$element.removeClass("selected"),t.isSelected=e.selected),n=null,I.hasChildren(e)?e.collapsed?(n="icon-right",t.$element.addClass("collapsed")):(n="icon-down",t.$element.removeClass("collapsed")):(n=e.icon||"icon-minus",t.$element.removeClass("collapsed")),n!==(t.icon_cls||"icon-down")&&(t.removeClass("icon",t.icon_cls||"icon-down"),t.addClass("icon",n),t.icon_cls=n),e.hide_in_pg?(t.getElement("hidden").style.display="block",t.$element.addClass("hide-in-pg")):e.hide_in_pg_child?(t.getElement("hidden").style.display="none",t.$element.addClass("hide-in-pg")):(t.getElement("hidden").style.display="none",t.$element.removeClass("hide-in-pg")),e.pgel?t.$element.removeClass("dyn"):t.$element.addClass("dyn"),pgf.focus_in_tree||(e.focused?t.$element.addClass("focused"):t.$element.removeClass("focused")));var n=e.search||0;t.$element.removeClass("search-1 search-2 search-0").addClass("search-"+n)},I.onRepaint=function(){b.setBottom(I.getHScrollBarSize()),b.setRight(I.getVScrollBarSize()),N()},this.getPgelOfDataItem=function(e){if(e.pgid)return getPgNodeByPgId(e.pgid);if(e.dyn_element){var t=getElementPgNode($(e.dyn_element));if(t)return e.pgid=t.getId(),g&&g.tree&&(g.tree.treeData_PgIdMap[e.pgid]=e),t}return null},null),z=-1,P=(this.populateDataItem=function(e,t,n){var i,a,o;e.populated||(e.populated=!0,(n=n||e.pgel||w.getPgelOfDataItem(e))?((a=g.getMainType(null,n))&&(o=g.getActionTag(n),(o={def:a,num_classes:0<=z?z:o?1:2,action_tag:o,classes_filter:q}).name=n.getAttr("data-pg-name"),n.parent&&n.parent.rootNode&&!n.dynamic&&(i=n.getPage())&&(o.name=o.name?"<pagename>"+i.getName()+"</pagename> / "+o.name:"<pagename>"+i.getName()+"</pagename>"),e.name=n.getName(o),e.search_string=o.search_string||"",a.tags,i=g.getActionTag(n,!0))&&(e.search_string+=":"+i),n.getAttribute("style")&&!pgf.kids&&(e.name+=' <icons><i class="inline-styles icon icon-Pin15" title="Inline style is set. Click to edit it in the Style panel."></i></icons>'),e.pgel=n,e.hide_in_pg=n.hasAttr("data-pg-hidden")):(a=U(e))&&(o={},e.name=pgGetDOMElementName(a,!0,!0,o),e.search_string=o.search_string))},null),y=null,E=(this.markInsertPositionInTree=function(e,t,n){var i,a,o,l;e instanceof pgParserNode?g==e.getPage()&&(i=g.tree.getTreeDataItemForPgId(e.getId()),t=function(e){switch(e){case"left":case"top":return"insertBefore";case"right":case"bottom":return"insertAfter";case"inside-top":case"inside-left":return"prepend";case"inside-bottom":case"inside-right":return"append"}return e}(t)):i=e,i&&!i.hidden?(l=0,"insertBefore"==t?(a=i.visible_idx,o=i.level):"insertAfter"==t?(a=i.visible_idx+1+I.getNumberOfDescendants(i.visible_idx,I.visibleData),o=i.level):"prepend"==t?(a=i.visible_idx+1,o=i.level+1,l=1):"append"==t&&(a=i.visible_idx+1+I.getNumberOfDescendants(i.visible_idx,I.visibleData),o=i.level+1,l=1),"self"===t?(I.showInsertionLineAt(-1),I.setEmptyLineAt(-1)):(I.showInsertionLineAt(a,o),I.setEmptyLineAt(a)),I.borderItem(i,l),n||I.scrollTo(i)):(I.showInsertionLineAt(-1),I.setEmptyLineAt(-1),I.borderItem(null))},this.markRangeInTree=function(e,t){var n,i,a;return e&&t&&g==e.getPage()&&(n=g.tree.getTreeDataItemForPgId(e.getId()),i=g.tree.getTreeDataItemForPgId(t.getId())),n&&!n.hidden&&i&&!i.hidden?(a=1+I.getNumberOfDescendants(n.visible_idx,I.visibleData),e!=t&&(a=i.visible_idx-n.visible_idx+I.getNumberOfDescendants(i.visible_idx,I.visibleData)+1),I.scrollTo(n),I.borderItem(n,!1,a)):(I.borderItem(null),!1)},function(e,t){if(!e)return!1;var n=w.getPgel(e);if(!n)return!1;P=t;function i(){w.markInsertPositionInTree(e,P)}function a(e){e==g&&(I.updateDataIndexes(),i(),D.updatePosition())}pgQuickWindowManager.close("quickInsert"),y=e,i(),I.quickInsertLine.hide();var o=new PgQuickInsert(n,t,!1,I.$insertionLine);(D=new PgConnector).$from=I.$insertionLine,D.toOffset=0,D.$to=o.getWindow().$element,pinegrow.connectors.add(D),o.getWindow().onMoveDrag=o.getWindow().onMove=o.getWindow().onResize=function(){D.updatePosition()};pinegrow.addEventHandler("on_page_changes_done",a),o.getLib().onBeforeInserted=function(){"prepend"!=P&&"append"!=P||!e.collapsed||(e.collapsed=!1,n.removeAttr("data-pg-collapsed"))},o.getWindow().onDestroy=function(){D.destroy(),D=null,I.setEmptyLineAt(-1),I.showInsertionLineAt(-1),I.borderItem(null),y=null,pinegrow.removeEventHandler("on_page_changes_done",a)}}),S=function(e){var t=$(e.currentTarget).closest("div");return I.visibleData[parseInt(t.attr("data-visible-idx"))]},Q=function(e){var t=S(e);return w.getPgelOfDataItem(t)},U=function(e,t){t=t||g.get$Html().get(0);var n,i=e.treeId;if(i&&t){if(t.getAttribute("data-pg-tree-id")==i)return t;n=t.querySelector('[data-pg-tree-id="'+i+'"]')}if(e.pgid){if(t.getAttribute("data-pg-id")==e.pgid)return t;n=t.querySelector('[data-pg-id="'+e.pgid+'"]')}return n},k=(this.isOverTree=function(e,t){return(!t||"html"===t.dragType)&&v.getWindow()===e.view&&v.isVisible()&&e.pageX>=a.left&&e.pageX<=a.right-(b.isHidden()?0:b.width+I.getVScrollBarSize())&&e.pageY>=a.top&&e.pageY<=a.bottom?{left:e.pageX-a.left,top:e.pageY-a.top}:null},this.getDropPositionInfo=function(e,t,n){var i,a,o=I.dragOver(n);if(o)if(o.data.pgid){if(o.target_pgel=getPgNodeByPgId(o.data.pgid),!o.target_pgel)return null;o.$e=o.target_pgel.get$DOMElement()}else o.invalid="Dyn element","bottom"==o.position?(i=o.data.visible_idx,(a=I.visibleData.length>i?I.visibleData[i]:null)&&a.level==o.data.level&&a.pgid?(o.data=a,o.position="top",o.invalid=!1):a&&a.level<o.data.level&&(a=I.getParentWithLevel(i,o.data.level-1))&&a.pgid&&(o.data=a,o.position="inside-bottom",o.invalid=!1)):"top"==o.position&&((a=0<=(i=o.data.visible_idx)-1?I.visibleData[i-1]:null)&&a.level==o.data.level&&a.pgid?(o.data=a,o.position="bottom",o.invalid=!1):a&&a.level<o.data.level&&a.pgid&&(o.data=a,o.position="inside-top",o.invalid=!1)),o.data.pgid&&(o.target_pgel=getPgNodeByPgId(o.data.pgid),o.$e=o.target_pgel.get$DOMElement());return I.showInsertionPoint(o),o},I.$container.on("contextmenu",".pg-table-grid-cell",function(e){var t,n;return e.preventDefault(),e.stopPropagation(),pgf.kids||(t=S(e),n=Q(e),t&&"interaction"===t.template_type)||(n?pinegrow.showContextMenuForElement(n,e,$(this),I.$container.closest(".pg-tree-container")):pgDynElementMessage("Can't edit dynamic elements.")),!1}).on("mouseover",".pg-table-grid-cell",function(e){var t;I.inScroll||(t=S(e),pinegrow.getDragMenu())||(t=w.getPgelOfDataItem(t))&&pinegrow.highlightElement(t.get$DOMElement()),e.stopImmediatePropagation()}).on("mouseout",".pg-table-grid-cell",function(e){I.inScroll||pinegrow.getDragMenu()||pinegrow.highlightElement(null),e.stopImmediatePropagation()}).on("click","i.collapse-icon",function(e){var n=S(e),t=w.getPgelOfDataItem(n);n.collapsed=!(n.collapsed||0),t&&(Y(t,n.collapsed),"head"==t.tagName)&&(t.getPage().show_head_in_tree=!n.collapsed),e.altKey&&I.forEachVisibleSibling(n,function(e){e.collapsed=n.collapsed;var t=w.getPgel(e);t&&Y(t,e.collapsed)}),I.refresh(),e.preventDefault(),e.stopPropagation()}).on("click","i.icon-hide",function(e){var t=S(e);R(t),e.preventDefault(),e.stopPropagation()}).on("click",".pg-table-grid-cell",function(e){var t=Q(e),n=S(e);if($("#crsa-dummy-field").get(0).focus(),t)if(M)E(n,M);else{var i=!1,a={stop:!1,multi:crsaIsCmdPressed(e),source:"tree",event:e,tree_data:n};if(pinegrow.dispatchEvent("on_element_clicked",g,t,null,a),a.stop)i=!0;else if(e.shiftKey){var o=!1,a=pinegrow.selectedElements.getLastSelectedOnPage(g);if(a){for(var l,s=g.tree.getTreeDataItemForPgId(a.getId()),r=s.visible_idx>n.visible_idx?-1:1,d=new PgCollection,c=s.visible_idx+r;c!==n.visible_idx+r;c+=r)I.visibleData[c].level==s.level&&(l=w.getPgelOfDataItem(I.visibleData[c]))&&(d.add(l),o=!0);t.scrollTo(),o&&pinegrow.selectedElements.selectMany(d),i=!0,o||pinegrow.showQuickMessage("SHIFT + Click can only select elements on the same level.")}}i||(pinegrow.selectElement(t,"tree",crsaIsCmdPressed(e)),t.scrollTo(),$(e.target).is(".inline-styles")&&(pinegrow.showUIPanel("style",!1),pinegrow.activeCSSView.updateRulesDisplayOnElementSelect(!0)))}else pgDynElementMessage(M?"Can't edit dynamic elements.":"Can't select a dynamic element.");e.stopImmediatePropagation(),e.preventDefault(),$("body").trigger("click")}),new PgDragHelper(o,".pg-table-grid-cell",null,!0)),X=(k.onGetDragImage=function(){return"none"},k.onBefore=function(e){return!!pgf.edit_html&&!g.tree.getDataFor$Element(e).no_sort},k.on("dragStart",function(e,t,n){$.fn.crsapages("showOverlays");for(var i=g.tree.getDataFor$Element(k.movedElement),a=i.pgid,a=getPgNodeByPgId(a),o=g.getMainType(null,a),l=(p=new PgDragMenu(o,!0,!0,null,a),$('<div class="pg-tree-drag-container with-tree"></div>')),s=I.getNumberOfDescendants(i.idx,I.data)+1,r=i.level,d=0;d<s&&4!=d;d++){var c=I.createCellForData(I.data[i.idx+d]);c.setData(I.data[i.idx+d]),I.onSetDataToCell(I.data[i.idx+d],c),c.showAt((c.data.level-r)*I.levelPadding,d*I.cellHeight,l)}4<s&&$('<div class="pg-table-grid-cell"><name>+ '+(s-4)+" more</name></div>").appendTo(l).css({top:4*I.cellHeight+"px",left:(I.data[i.idx+4].level+1-r)*I.levelPadding+"px"}),l.css("height",Math.min(s,5)*I.cellHeight),p.addElement(l),p.movedPgel=a,p.pgel=a,I.dragStarted(i),p.handleMoveEvent(n,p),b.hide()},this),k.on("drag",function(e,t,n){p.handleMoveEvent(n,p)},this),k.on("dragStop",async function(e,t){$.fn.crsapages("showOverlays",!0),I.dragStopped(),await p.insertAsync(),p.destroy(),p=null,crsaFuncs.showInsertionLine(null),pinegrow.highlightElement(null),I.showInsertionPoint(null)},this),function(){a=I.$element.get(0).getBoundingClientRect()}),J=(v.onResize=function(){X(),I.onRepaint(),I.show(),b.updateLayout()},v.onDestroy=function(){pinegrow.unregisterTreeView(w),pinegrow.removeEventHandler("on_page_changed",J),pinegrow.removeEventHandler("on_page_loaded",T),pinegrow.removeEventHandler("on_page_refreshed",T),pinegrow.removeEventHandler("on_page_selected",Z),pinegrow.removeEventHandler("on_drag_drop_operation_done",ee),pinegrow.removeEventHandler("on_page_frameworks_changed",x),pinegrow.removeEventHandler("on_element_isolated",K),pinegrow.removeEventHandler("on_class_styles_changed",oe),pinegrow.removeEventHandler("on_projectdb_changed",le),j.destroy(),o.off("mousemove",ne),o.off("mouseleave",ie),o.off("mouseenter",ae)},function(e,t,n){}),C=function(e){var t;(g=e)?(q=e.tree.options.classes_filter,z=e.tree.options.num_classes,pinegrow.pageHasIsolatedElement(e)?(u.hide(),pgf.focus_in_tree&&(t=pinegrow.getIsolatedElement(),n(t.getName({short:!0})))):(pgf.focus_in_tree&&n(null),u.show()),e.tree.setShowInteractions(d),e.tree.setFilterOptions(c),h!==e.tree.getDomMode()?(e.tree.setDomMode(h),e.tree.setAutoCollapse(f),e.tree.create(),e.tree.setTreeView(w),e.tree.setTableGrid(I)):(e.tree.setTreeView(w),e.tree.setTableGrid(I),(t=pinegrow.selectedElements.getLastSelectedOnPage(e))?(A=e.tree.getTreeDataItemForPgId(t.getId()),b.show(),N()):(A=null,b.hide()))):(A=null,I.setData([]),b.hide()),w.setPage(e),b.updateLayout()},T=function(e){e.tree.setShowInteractions(d),e.tree.setDomMode(h),e.tree.setAutoCollapse(f),e.tree.create(),e===g&&C(e)},x=function(e){e&&e.tree&&e.tree.create(),(e&&e===g||null===e&&g)&&g&&g.tree&&C(g)},K=function(e,t){(e=e||g)&&e.tree&&(e.tree.create(),C(e))},Z=function(e){v.whenVisible(function(){X(),C(e)})},ee=function(e,t){I&&I.dragStopped()},A=null,O=null,te=new PgMouseSpeed,M=null,H=null,ne=function(e){var t,n,i,a,o,l,s,r,d=w.isOverTree(e);te.track(e),A&&b.isHidden()&&b.show(),M=null,I.quickInsertLine.show(null),H&&(clearTimeout(H),H=null),d&&g&&(n=(t=I).getScrollOffset(),d.top+=n.top,d.left+=n.left,-2==(i=t.getVisibleDataIndexForY(d.top))&&(i=t.getVisibleDataIndexForY(d.top-t.cellHeight)),s=t.visibleData[i],o=Math.max(0,Math.floor(d.left/t.levelPadding)-1),r=I.getDragPos(),p&&r||(t.highlightLevel(i,o),!pgf.edit_html)||pgf.kids||!s||pinegrow.getDragMenu()||s.no_insert||(r=4,a=null,o=s.level,l=t.getYForVisibleDataIndex(i),d.top<=l+r?a="insertBefore":d.top>=l+t.cellHeight-r&&(!(l=t.visibleData.length>s.visible_idx+1?t.visibleData[s.visible_idx+1]:null)||l.level<=s.level?a="insertAfter":(a="prepend",o=s.level+1)),!a)||y&&(y==s&&P==a||y.visible_idx==s.visible_idx+1&&"insertBefore"==P&&("insertAfter"==a||"prepend"==a)||y.visible_idx==s.visible_idx-1&&("insertAfter"==P||"prepend"==P)&&"insertBefore"==a)||(H=setTimeout(function(){M=a,t.quickInsertLine.show(s,o,"insertBefore"==a?"top":"bottom")},450)),p||(s=t.visibleData[i],t.getYForVisibleDataIndex(i),n.top,r=t.getCellForData(s),O!=r&&b.isOverMenu(d)))},ie=function(e){I.highlightLevel(-1),I.quickInsertLine.hide(),H&&(clearTimeout(H),H=null),b.hide(),O&&O.$element.removeClass("hovered"),O=null},ae=function(e){A&&b.show()},oe=(o.on("mousemove",ne),o.on("mouseleave",ie),o.on("mouseenter",ae),function(e,t){var n=pinegrow.getSelectedPage();if(n)for(var i=0;i<t.length;i++)t[i].component&&x(n)}),le=function(e,t,n){var i,a=!1;n&&"undo"===n.source&&t.forEachElement(function(e){"classstyle"===e.tagName&&(a=!0)}),a&&(i=pinegrow.getSelectedPage())&&x(i)},N=(pinegrow.addEventHandler("on_page_changed",J),pinegrow.addEventHandler("on_page_loaded",T),pinegrow.addEventHandler("on_page_refreshed",T),pinegrow.addEventHandler("on_page_selected",Z),pinegrow.addEventHandler("on_drag_drop_operation_done",ee),pinegrow.addEventHandler("on_element_isolated",K),pinegrow.addEventHandler("on_page_frameworks_changed",x),pinegrow.addEventHandler("on_class_styles_changed",oe),pinegrow.addEventHandler("on_projectdb_changed",le),function(){var e;A&&(e=I.getScrollOffset(),e=I.getYForVisibleDataIndex(A.visible_idx)-e.top,b.showFor(e,e+I.cellHeight,A.selected||!1,A))});this.onSelected=function(e){A=e;var t,n,i,a,o=this.getPgel(e);o&&(t=b.find("hide"),n=t.data("icon")||t.get(0).querySelector("i"),t.data("icon",n),a=o.isHidden()?(i="icon-see","icon-hide"):(i="icon-hide","icon-see"),!n.classList.contains(a)&&n.classList.contains(i)||fastdom.mutate(function(){n.classList.remove(a),n.classList.add(i)})),N()},this.onDeselected=function(e){pinegrow.selectedElements.hasSelection()||(A=null,b.hide())}},PgPageTree=function(f){function c(e){u.withDataAndChildren(e,D)}function g(e){var t=P(e);if(t){for(var n=[t],i=t.idx+u.getNumberOfDescendants(t.idx,_),a=t.idx+1;a<=i;a++)n.push(_[a]);return n}return null}function p(){nextFrame.do("refreshGrid",function(){e.research(),I&&(I.refresh(),h)&&!h.view.isVisible()&&h.view.whenVisible(function(){I.show()})})}var s,u,h,e=this,m=0,o=!1,n=0,v={styles:!1,images:!1},w=!1,_=[],b=this.treeData_PgIdMap={},I=(this.getDomMode=function(){return o},this.setDomMode=function(e){o=e},this.setAutoCollapse=function(e){n=e},this.setShowInteractions=function(e){s=e},this.setFilterOptions=function(e){var t=w;w=!1,$.each(e,function(e,t){if(t)return w=!0}),v=e,x=t!==w},this.setTreeView=function(e){h=e},null),D=(this.setTableGrid=function(e){I=e,this.$element=I.$element,e.setData(_),x&&this.research()},$("<div/>").addClass("crsa-tree-branch pg-tree-ul"),this.$element=null,this.highlightOnMouseOver=!0,this.destroy=function(){nextFrame.cancelAll(),h=I=null,u&&u.destroy(),_=u=null,b=this.treeData_PgIdMap=null,e=null},this.getDataFor$Element=function(e){return I.getDataFor$Element(e)},this.updatePgIdMap=function(){var e=new CrsaProfile;b=this.treeData_PgIdMap={__update:!0},_.forEach(function(e){e.pgid&&(b[e.pgid]=e)}),e.show("updatePgIdMap")},function(e){e&&e.pgid&&delete b[e.pgid]}),P=function(e){return b[e]||null},y=(this.getTreeDataItemForPgId=function(e){return P(e)},function(e,t){var n,i=[];return o?(n=e.get$DOMElement())&&M(i,n?n.get(0):null,!1,t):N(i,e,!1,t),i});const E=1,S=3,k=2;function C(e){e&&(e.populated=!1,e.def=null)}function T(e,t){Array.isArray(e)?e.forEach(function(e){e.force_search=t}):e&&(e.force_search=t)}var i=null,x=(this.research=function(e){var t={selected_ids:{},changed:!1};f.callFrameworkHandler("on_custom_tree_filter",t),(i||t.changed||w||e)&&this.search(i,!0,t)},!1),A=(this.search=function(e,a,t){if(h){x=!1;var n,o,l=0<(e=null===e?"":e).length?new RegExp(escapeRegExp(e),"i"):null,s=!1,r=(e.startsWith("$")&&(e=e.substr(1),s=!0),{}),d=(i=e,t?n=t:f.callFrameworkHandler("on_custom_tree_filter",n={selected_ids:{},changed:!1}),n.selected_ids),c=n.changed;if(e||c||w){if(e)try{f.get$Html().find(e).each(function(e,t){var n=t.getAttribute("data-pg-id");n&&(r[n]=!0)}),0}catch(e){0}u&&(o=f.get$Html().get(0),_.forEach(function(e){e.search=0,e.peek_in&&(e.collapsed=!0,e.peek_in=!1)}),u.forEachWithParents(function(e,t){h.populateDataItem(e,o);var n=!1;if((n=!(s||l&&!e.search_string.match(l))||r[e.pgid]?!0:n)&&c&&(n=d[e.pgid]||!1),w&&e.pgel&&(v.styles?n=!!e.pgel.getAttribute("style")&&n&&!0:v.images?n=n&&"img"===e.pgel.tagName:v.links?n=n&&"a"===e.pgel.tagName:v.components?n=n&&0<e.pgel.findAttributesStartingWith("data-pgc").length:v.wp?n=n&&(0<e.pgel.findAttributesStartingWith("wp-").length||0<e.pgel.findAttributesStartingWith("cms-").length):v.wc?n=n&&0<e.pgel.findAttributesStartingWith("wc-").length:v.ia?n=n&&0<e.pgel.findAttributesStartingWith("data-pg-ia").length:v.texts&&(n=n&&0<e.pgel.text(null,!0).trim().length)),n){e.search=E;for(var i=t.length-1;0<=i&&t[i].search===S;i--)t[i].search=k,t[i].collapsed&&(t[i].peek_in=!0),t[i].collapsed=!1}else if(0&&e.force_search&&a)for(i=t.length-1;0<=i&&t[i].search===S;i--)t[i].search=k;else e.search=S}),I.refresh())}else _.forEach(function(e){e.search=0,e.force_search=!1,e.peek_in&&(e.collapsed=!0,e.peek_in=!1)}),I.refresh()}else x=!0},this.scrollToSelected=null,this.handleEvent=function(e){var t,n,i,a=e.getPgel(),o=P(e.pgId);try{switch(e.operation){case"selected":o&&(this.scrollToSelected=null,o.selected=!0,u.peek(o)?(u.reindexData(0,!0),p()):I&&I.updateItem(o),I&&I.scrollToDelayed(o),this.scrollToSelected=o,h)&&h.onSelected(o);break;case"deselected":o&&(o.selected=!1,this.scrollToSelected==o&&(this.scrollToSelected=null),u.unpeek(o)?(u.reindexData(0,!0),p()):I&&I.updateItem(o),h)&&h.onDeselected(o);break;case"show":o.hide_in_pg=!1,o.hide_in_pg_child=!1,u.withChildren(o,function(e){if(e.hide_in_pg)return!1;e.hide_in_pg_child=!1}),u.reindexData(),p();break;case"hide":o.hide_in_pg=!0,u.withChildren(o,function(e){if(e.hide_in_pg)return!1;e.hide_in_pg_child=!0}),u.reindexData(),p();break;case"remove":case"detach":o&&(u.removeItem(o,D),u.reindexData(),p());break;case"insertAfter":case"insertBefore":var l=P(e.objectId),s=g(e.pgId)||y(a);T(s,!0),u[e.operation](l,s),u.reindexData(),p();break;case"insertAtIndex":var l=P(e.objectId),s=g(e.pgId)||y(a),r=getPgNodeByPgId(e.objectId).getChildPos(a,!0);u.insertAtIndex(l,s,r),T(s,!0),u.reindexData(),p();break;case"appendPrepend":l=P(e.objectId);e.pgId?(s=g(e.pgId)||y(a),e.data.prepend?u.prepend(l,s):u.append(l,s),T(s,!0),u.reindexData(),p()):(C(l),I&&I.updateItem(l));break;case"removeAllChildren":u.withChildren(o,D),u.removeDescendants(o),u.reindexData(),p();break;case"detag":D(o),u.delevel(o),T(o,!0),u.reindexData(),p();break;case"replaceContentWithElement":u.withChildren(o,D);s=g(e.objectId)||y(getPgNodeByPgId(e.objectId));u.replaceContentWith(o,s),T(s,!0),u.reindexData(),p();break;case"replaceContentWithContentOf":u.withChildren(o,D),1<(s=g(e.objectId)||y(getPgNodeByPgId(e.objectId))).length&&(s.shift(),u.replaceContentWith(o,s),T(s,!0),u.reindexData(),p());break;case"replaceWith":c(o);s=g(e.objectId)||y(getPgNodeByPgId(e.objectId));u.replaceWith(o,s),s[0].selected=o.selected||!1,T(s,!0),u.reindexData(),p();break;case"removeAttr":case"setAttr":case"removeClass":case"addClass":case"replaceTag":var d=!1;if(e.data.attr&&e.data.attr.startsWith("data-pg-ia")){if(e.data.info&&e.data.info.pgia_animation)break;d=!0}if(!d){C(o),T(o,!0),I&&I.updateItem(o);break}case"update":case"updateInner":case"html":o||e.data&&e.data.domPgId&&(o=P(e.data.domPgId)),o&&(c(o),t=a,void 0===(n=o)&&(n=P(t.getId())),i=y(t),u.replaceWith(n,i),T(o,!0),u.reindexData(),pinegrow.selectedElements.forEachElement(function(e){var t=P(e.getId());t&&(t.selected=!0)}),p())}}catch(e){console.log("treeError",e)}},!1),O=null,M=(this.options={num_classes:-1,classes_filter:null},this.create=function(){_=[],b=this.treeData_PgIdMap={__create:!0},this.options={num_classes:-1,classes_filter:null},f.callFrameworkHandler("on_get_tree_options",this.options),0;var e=!1,t=f.get$Html(),n=pinegrow.getIsolatedElement(f),t=t.get(0),i=f.sourceNode.findOne("html")||f.sourceNode.children[0],a=(A=!1,O=null,n&&(t=(i=n).get$DOMElement().get(0),a=pinegrow.getIsolatedElementOptions(),A=a.tree_hide_scripts,O=a.drag_drop_only_top_level?n:null,o=!1),new CrsaProfile(!0));o?M(_,t,e):i&&N(_,i,e),a.show("create tree data items"),(u=new PgTreeDataHelper(_)).reindexData(),this.research()},function(e,t,n,i){i=i||0;var a="sort",o=(("BODY"==t.tagName&&0<$(t).children().length||"HEAD"==t.tagName||"HTML"==t.tagName)&&(a="no-sort"),""),l=t.tagName,s=null;if("STYLE"==l&&"crsa-inline-styles"==t.id)return"";F(t)&&(a+=" crsa-tree-node-hidden");var r=++m,d=(t.setAttribute("data-pg-tree-id",r),t.getAttribute("data-pg-id")),o=(d?0:(a+=" dyn",s=t),"HTML"==l&&(l=f.name,o+=" tag-block",a+=" doc-root"),{level:i,tags:o,classes:a,name:l,pgid:d,treeId:r,shown:!0,collapsed:W(t,i),dyn_element:s}),c=(e.push(o),d&&(b[d]=o),d&&H(e,t,d,i),t.childNodes);if(0<c.length&&"aaaSVG"!==t.tagName)for(var g=0;g<c.length;g++){var p=c.item(g);1==p.nodeType?pgIsNodePageUI(p)||A&&"SCRIPT"===p.tagName||M(e,p,!1,i+1):p.nodeType}}),H=function(n,e,i,a){if(s){var o,l,t=e.getAttribute("data-pg-ia");if(t)try{(o=JSON.parse(t)).l&&(l=0,o.l.forEach(function(e){var t=e.name||"Interaction "+(l+1);if(e.on)switch(e.on){case"mobile":t+=" [SM]";break;case"desktop":t+=" [LG]";break;case"off":t+=" [OFF]"}e.nopg&&(t+=" [NOPG]"),n.push({level:a+1,name:t,pgid:i,populated:!0,shown:!0,collapsed:!1,no_sort:!0,no_insert:!0,icon:"icon-113",template_type:"interaction",search_string:t,pgia:{type:"a",action:"i",id:i+":animation_"+l,idx_zero:l++,desc:e.a&&e.a.desc?e.a.desc:null}})}))}catch(e){}if(t=e.getAttribute("data-pg-ia-scene"))try{(o=JSON.parse(t)).l&&(l=0,o.l.forEach(function(e){var t=e.name||"Scroll scene"+(1<o.length?" "+(l+1):"");if(e.on)switch(e.on){case"mobile":t+=" [SM]";break;case"desktop":t+=" [LG]";break;case"off":t+=" [OFF]"}e.nopg&&(t+=" [NOPG]"),n.push({level:a+1,name:t,pgid:i,populated:!0,shown:!0,collapsed:!1,no_sort:!0,no_insert:!0,template_type:"scrollscene",search_string:t,pgia:{type:"a",action:"s",id:i+":scene_item_"+l,idx_zero:l++,desc:e.a&&e.a.desc?e.a.desc:null}})}))}catch(e){}}},N=function(e,t,n,i){i=i||0;var a="sort",o=!1,l=f.getTypeThatFiltersTree(t),s=(("body"==t.tagName&&0<t.children.length||"head"==t.tagName||"html"==t.tagName)&&(a="no-sort",o=!0),!1),r=!1,d=(O&&(t===O?(a="no-sort",r=o=!0):t.isDescendantOf(O)&&(s=!0)),""),c=t.tagName,g=(L(t)&&(a+=" crsa-tree-node-hidden",0),t.getId()),d=(g?0:a+=" dyn","html"==c&&(c=f.name,d+=" tag-block",a+=" doc-root"),{level:i,tags:d,classes:a,name:c,pgid:g,pgel:t,treeId:0,shown:!0,collapsed:B(t,i)||s,no_sort:o,focused:r}),p=(e.push(d),g&&(b[g]=d),1&&H(e,t,g,i),t.children);if(0<(p=l&&l.on_filter_tree_children?l.on_filter_tree_children(t):p).length&&"aaasvg"!==t.tagName)for(var u=0;u<p.length;u++){var h=p[u];!h.isElementOrScript||A&&"script"===h.tagName||N(e,h,!1,i+1)}},F=function(e){return""==e.getAttribute("data-pg-hidden")},L=function(e){return e.hasAttribute("data-pg-hidden")},W=function(e,t){return!pgf.kids&&(0<n&&n<=t||("HEAD"==e.tagName?!f.show_head_in_tree:e.hasAttribute("data-pg-collapsed")?"false"!==e.getAttribute("data-pg-collapsed"):"SVG"===e.tagName||"svg"===e.tagName))},B=function(e,t){return!pgf.kids&&(0<n&&n<=t||e.isCollapsed())}};