class PgSmartInput{constructor(e,t){var s,r=this;this.$element=$('<div class="pg-smart-input"></div>'),this.$results=$('<div class="pg-smart-input-results"></div>'),this.results=[],this.menu=null,this.field=new PgInputField("value",{type:"text",show_empty:!1,name:"Search",without_text:!0,auto_resize:!1,placeholder:e,with_clear_icon:!0,no_auto_complete:!0}),this.field.appendTo(this.$element),this.$results.appendTo(this.$element),this.field.on("input",this.onValueInput.bind(this)),this.field.on("focus",this.onFocus.bind(this)),this.field.on("keydown",this.onKeyDown.bind(this)),this.$results.on("click",".result",function(e){var t=parseInt(this.getAttribute("data-idx"));r.onResultSelected(r.results[t])}),t||((s=this.mover=new PgArrowsMover(this.field.$input,this.$results,"> .result")).select_first=!0,s.onEnter=function(e){var t;e&&e.length?(t=parseInt(e.attr("data-idx")),r.onResultSelected(r.results[t])):(t=r.handleUnknownValue())?r.onResultSelected(t):r.results.length?r.onResultSelected(r.results[0]):pinegrow.showQuickError("Please enter a valid value.")},s.onSelected=function(e){var t;e?(t=parseInt(e.attr("data-idx")),r.onResultPreview(r.results[t])):r.onResultPreview(null)})}handleUnknownValue(){return null}onKeyDown(e){var t;"Tab"===e.key&&(e.preventDefault(),e.stopPropagation(),this.results.length)&&(t=this.mover.get$Item())&&(t=t.attr("data-idx"),this.field.setValue(this.results[t].full_value),this.focus(!0))}addToMenu(e,t){this.menu=e,t.append(this.$element)}focus(e){this.field.focus(e)}setValue(e){this.field.setValue(e),this.onValueInput(null,e)}showResults(e){for(var t=10,s="",r=((this.results=e).length&&(s+=`<div class="info">${pgShowKbd("DOWN")} ${pgShowKbd("UP")} ${pgShowKbd("ENTER")} ${pgShowKbd("TAB")}</div>`),0),r=0;r<e.length&&(s+=`<div class="result" data-idx="${r}">${e[r].html}</div>`,r!==t);r++);this.$results.get(0).innerHTML=s,this.mover.update("data-idx")}async onValueInput(e,t){var s=e?e.target.value:t,s=await this.getResultsForShorthand(s);this.showResults(s),this.onUpdated(),this.menu&&this.menu.closeSubmenus()}onUpdated(){}onFocus(e){this.menu&&this.menu.closeSubmenus()}onResultSelected(e){this.menu}onResultPreview(e){}async getResultsForShorthand(e){return[]}destroy(){this.mover&&this.mover.destroy()}}class PgSmartInputForCSS extends PgSmartInput{constructor(e){super("Example: mt10"),this.matcher=new PgSmartCSSPropsMatcher,this.currentMatchedProps=[],this.props={"border-top":""},this.stylePreview=e}getResult(e,t){return{html:`<span class="prop">${e}</span>: <span class="value">${t}</span>`,prop:e,value:t,full_value:e+(t.length?" "+t.trim():"")}}onResultPreview(e){this.stylePreview&&(e?this.stylePreview.setStyle(e.prop,e.value):this.stylePreview.restore())}async getResultsForShorthand(e){var t=this;return pinegrow.highlightElement(null),this.matcher.matchProps(e,pinegrow.devTools.getCSSPropertiesOptions()).map(function(e){return t.getResult(e.key,e.value||"")})}onResultSelected(e){super.onResultSelected(e),!1!==this.onPropSelected(e.prop,e.value)&&(this.field.setValue(""),this.onValueInput(null,""))}onPropSelected(e,t){}handleUnknownValue(){var e,t=this.field.getValue().trim();return t.length?(e={prop:(t=t.split(/[\: ]+/))[0]},1<t.length&&(t.shift(),e.value=t.join(" ")),e):null}}class PgSmartCSSPropsMatcher{constructor(){this.force={m:"margin",mb:"margin-bottom",mt:"margin-top",ml:"margin-left",mr:"margin-right",p:"padding",pb:"padding-bottom",pt:"padding-top",pl:"padding-left",pr:"padding-right",c:"color",bgc:"background-color"}}test(e){console.log(`Match ${e}:`);var t=pinegrow.devTools.getCSSPropertiesOptions();this.matchProps(e,t).slice(0,10).forEach(function(e){console.log(`${e.key} ${e.value} `+e.distance)})}matchProps(p,e,d){var g=this,m=p.charAt(0),f=p.split(""),v=p,b=/^(margin|padding)/,S=["background","background-image","background-repeat","line-height","flex-grow","flex-shrink","flex","z-index","opacity","font-weight","flex-size","order","grid-row","grid-column","grid-row-start","grid-row-end","grid-column-start","grid-column-end","columns","column-rule"],P=[];return e.forEach(function(e){var t=d?e:e.key;if(t.charAt(0)===m){for(var s="",r=!1,n=0,a=1,l=1;l<f.length;l++){var i=!1;if(!r)for(var o=n+1;o<t.length;o++)if(f[l]===t.charAt(o)){if("-"===f[l]&&l+1<f.length&&f[l+1]!==t.charAt(o+1))return;n=o,i=!0,"-"===t.charAt(o-1)?a+=o/2:a+=o,v=p;break}if(i||d){if(!i&&!r)return}else if(r||":"!==f[l]&&" "!==f[l]){if(f[l].match(/[0-9]/))r=!0,v=p.substr(0,l);else if(e.values){var u,h,c=p.substr(l),c=g.matchProps(c,e.values,!0);if(c.length)return""!==s&&(u="",s.endsWith(" ")&&(s=s.trimEnd(),u=" "),"value"!==(h=pgParseCSSValue(s)).type||h.unit||S.indexOf(t)<0&&(s+="px"),s+=u),s.length&&!s.endsWith(" ")&&(s+=" "),void c.forEach(function(e){P.push({key:t,prop:t,value:s+e.key,distance:a+100})})}if(!r)return;s+=f[l]}else r=!0,v=p.substr(0,l)}""!==s&&(a+=100,s=s.trimEnd(),"value"!==(h=pgParseCSSValue(s)).type||h.unit||S.indexOf(t)<0&&(s+="px")),g.force[v]&&t===g.force[v]&&(a=0),t.match(b)&&(a/=2),P.push({key:t,prop:t,value:s,distance:a})}}),P.sort(function(e,t){return e.distance<t.distance?-1:e.distance===t.distance?e.prop.length<t.prop.length?-1:e.prop.length===t.prop.length?0:1:1}),P}runTests(){this.test("dii")}}class PgSmartInputForClassProps extends PgSmartInput{constructor(e,t){super("Example: mt10"),this.matcher=new PgSmartClassPropsMatcher,this.currentMatchedProps=[],this.props={"border-top":""},this.classPreview=e}getResult(e,t){return{html:`<span class="prop">${e}</span>: <span class="value">${t}</span>`,prop:e,value:t,full_value:e+(t.length?" "+t.trim():"")}}onResultPreview(e){this.classPreview&&(e?this.classPreview.setClass(e.value,e.values):this.classPreview.restore())}async getResultsForShorthand(e){var t=this;return pinegrow.highlightElement(null),this.matcher.matchProps(e,pinegrow.devTools.getCSSPropertiesOptions()).map(function(e){return t.getResult(e.key,e.value||"")})}onResultSelected(e){super.onResultSelected(e),!1!==this.onPropSelected(e.prop,e.value)&&(this.field.setValue(""),this.onValueInput(null,""))}onPropSelected(e,t){}}class PgSmartClassPropsMatcher{constructor(){this.force={m:"margin",mb:"margin-bottom",mt:"margin-top",ml:"margin-left",mr:"margin-right",p:"padding",pb:"padding-bottom",pt:"padding-top",pl:"padding-left",pr:"padding-right",c:"color",bgc:"background-color"}}test(e){console.log(`Match ${e}:`);var t=pinegrow.devTools.getCSSPropertiesOptions();this.matchProps(e,t).slice(0,10).forEach(function(e){console.log(`${e.key} ${e.value} `+e.distance)})}matchProps(p,e,d){var g=this,m=p.charAt(0),f=p.split(""),v=p,b=/^(margin|padding)/,S=["background","background-image","background-repeat","line-height","flex-grow","flex-shrink","flex","z-index","opacity","font-weight","flex-size","order","grid-row","grid-column","grid-row-start","grid-row-end","grid-column-start","grid-column-end","columns","column-rule"],P=[];return e.forEach(function(e){var t=d?e:e.key;if(t.charAt(0)===m){for(var s="",r=!1,n=0,a=1,l=1;l<f.length;l++){var i=!1;if(!r)for(var o=n+1;o<t.length;o++)if(f[l]===t.charAt(o)){if("-"===f[l]&&l+1<f.length&&f[l+1]!==t.charAt(o+1))return;n=o,i=!0,"-"===t.charAt(o-1)?a+=o/2:a+=o,v=p;break}if(i||d){if(!i&&!r)return}else if(r||":"!==f[l]&&" "!==f[l]){if(f[l].match(/[0-9]/))r=!0,v=p.substr(0,l);else if(e.values){var u,h,c=p.substr(l),c=g.matchProps(c,e.values,!0);if(c.length)return""!==s&&(u="",s.endsWith(" ")&&(s=s.trimEnd(),u=" "),"value"!==(h=pgParseCSSValue(s)).type||h.unit||S.indexOf(t)<0&&(s+="px"),s+=u),s.length&&!s.endsWith(" ")&&(s+=" "),void c.forEach(function(e){P.push({key:t,prop:t,value:s+e.key,distance:a+100})})}if(!r)return;s+=f[l]}else r=!0,v=p.substr(0,l)}""!==s&&(a+=100,s=s.trimEnd(),"value"!==(h=pgParseCSSValue(s)).type||h.unit||S.indexOf(t)<0&&(s+="px")),g.force[v]&&t===g.force[v]&&(a=0),t.match(b)&&(a/=2),P.push({key:t,prop:t,value:s,distance:a})}}),P.sort(function(e,t){return e.distance<t.distance?-1:e.distance===t.distance?e.prop.length<t.prop.length?-1:e.prop.length===t.prop.length?0:1:1}),P}runTests(){this.test("dii")}}class PgSmartSimpleMatcher{constructor(){}sortByDistance(e){e.sort(function(e,t){return e.distance<t.distance?-1:e.distance===t.distance?e.prop&&t.prop?e.prop.length<t.prop.length?-1:e.prop.length===t.prop.length?0:1:0:1})}matchProps(e,t){e=e.toLowerCase();for(var s=[],r=0;r<t.length;r++){var n=t[r],a=(n.search||n.label).toLowerCase().indexOf(e);0<=a&&(s.push(n),n.distance=a)}return s.slice(0,20)}}class PgSmartGeneralMatcher extends PgSmartSimpleMatcher{constructor(){super()}test(){var e=[{label:"Insert: Layout: div",key:null},{label:"Padding top: 10",key:"pt-10"},{label:"Size: 5"}];console.log(this.matchProps("i d",e)),console.log(this.matchProps("si",e)),console.log(this.matchProps("si 5",e))}matchProps(e,t){for(var s=(e=e.toLowerCase()).charAt(0),o=e.split(""),r=function(e){for(var t=!1,s=0,r=1,n=1;n<o.length;n++){var a=!1;if(!t)for(var l=s+1;l<e.length;l++)if(o[n]===e.charAt(l)){var i="-"===o[n]||" "===o[n]||":"===o[n];if(i&&n+1<o.length&&o[n+1]!==e.charAt(l+1)){if("-"!==o[n])continue;return-1}s=l,a=!0,r+=i?l/2:l,0;break}if(!a)return-1}return r},n=[],a=0;a<t.length;a++){var l,i,u=t[a],h=(h=u.search||u.label).toLowerCase(),c=-1;if(h.charAt(0)===s&&(c=r(h),l=-1),u.key&&((i=u.key.charAt(0).toLowerCase())===s?0<=(l=r(u.key.toLowerCase()))&&(l<c||c<0)&&(c=l):1<u.key.length&&"-"===i&&u.key.charAt(1).toLowerCase()===s&&0<=(l=r(u.key.substr(1).toLowerCase()))&&(l<c||c<0)&&(c=l)),0<=(c=c<0?h.indexOf(e):c)&&n.push({key:h,prop:h,distance:c,data:u}),e.length<2&&100===n.length)break}this.sortByDistance(n);for(var p=20,t=[],a=0;a<n.length&&(t.push(n[a].data),a!==p);a++);return t}}class PgSmartInputForMenu extends PgSmartInput{constructor(e){super("",!0),this.currentMatchedProps=[],this.actions=null,this.only_match_action_names=!1,this.allow_custom_value=!1,this.matcher=null;const s=this;e&&$.each(e,function(e,t){s[e]=t})}addToMenu(e,t){super.addToMenu(e,t)}showResults(e){this.menu.showActions(e)}getFlatMenuActions(){var l,i,o,u;return null===this.actions&&(this.menu.actions.shift(),this.menu.actions.shift(),l=[],i='<span style="margin-right:4px;">:</span>',o=": ",(u=function(e,n,a){Array.isArray(e)&&e.forEach(function(e){var t,s,r;e.label&&e.action&&!e.no_search?(n&&!e.search_only_action_name?(t=e.full_name||e.label,e.label=n+i+t,e.search=a+o+(e.label_plain_text||t)):e.search=e.label_plain_text||e.full_name||e.label,e.key&&(e.label+='<small style="text-transform: none;">'+e.key+"</small>"),e.force_search_label&&(e.label=e.force_search_label),l.push(e)):(s=(n?n+i:"")+(e.full_name||e.label||""),r=(a?a+o:"")+(e.label_plain_text||e.full_name||e.label||"")),e.submenu&&u("function"==typeof e.submenu?e.submenu():e.submenu,s||e.label,r||e.search),e.buttons&&u("function"==typeof e.buttons?e.buttons():e.buttons,s||e.label,r||e.search)})})(this.menu.actions),this.actions=l),this.actions}onCustomValueSelected(){}async getResultsForShorthand(e){var t=this,s=[];if(this.menu.resetCloseTimer(6e5),0===e.length)return this.menu.actions;if(this.getFlatMenuActions(),this.matcher||(this.matcher=new PgSmartGeneralMatcher),s=this.matcher.matchProps(e,this.actions),this.allow_custom_value){for(var r=!1,n=0;n<s.length;n++)if(s[n]?.key===e){r=!0;break}r||s.push({label:e,key:e,action:function(){t.onCustomValueSelected(e)}})}return s}}