var PgPageLib=function(){var i=this,o=(this.url=null,this.sourceNode=null,this.originalSourceNode=null,this.pageLib=!0,this.javascriptEnabled=!0,this.parsedStatus=null,this.parsedError=null,this.destroy=function(){this.sourceNode&&this.sourceNode.withoutEvents(function(){i.sourceNode.remove()}),this.originalSourceNode&&this.originalSourceNode.withoutEvents(function(){i.originalSourceNode.remove()})},this.handleWrapperOnPageLoad=function(e){e("done")},this.getHTMLNodeForBrowserWithSupportForWrapper=function(t){return new Promise(function(e){e(t)})},[]);this.whenParsed=function(e,t,n){"done"==this.parsedStatus?t(this):"error"==!this.parsedStatus?n(this,i.parsedError):null===this.parsedStatus?(i.parsedStatus="progress",o.push({doFunc:t,errorFunc:n}),e(this,function(t,e){var n;i.parsedStatus=t,i.parsedError=e,i.sourceNode&&(n=i.sourceNode.findOne("html"))&&n.addClass("pg-page-lib-view"),o.forEach(function(e){("done"==t?e.doFunc:e.errorFunc)(i,i.parsedError)}),o=[]})):(this.parsedStatus="progress")&&o.push({doFunc:t,errorFunc:n})},this.callGlobalFrameworkHandler=function(){}},PgPageLibManager=function(){var n={};this.add=function(e,t){n[e]=t},this.get=function(e){return n[e]||null},this.remove=function(e){var t=this.get(e);t&&(t.destroy(),delete n[e])}},PgPageLibsTabbedView=function(o){function e(){var e,t=[],n=pinegrow.getSelectedPage(),i={},o=(n&&(t=n.getPageLibs()).forEach(function(e){"auto_open_tab"in e&&!e.auto_open_tab||(s[e.url]||b(e),i[e.url]=!0)}),f.getTabs().forEach(function(e){e.data&&e.data instanceof PgPageLibView&&(e.data.item.framework&&!i[e.data.item.url]?f.hideTab(e):f.showTab(e))}),f.getActiveTab());o&&!f.isTabVisible(o)&&(o=!1,n&&n.currentPageLibUrl&&(e=f.findTabWithFilter(function(e){return!(!e.data||!e.data.item||e.data.item.url!=n.currentPageLibUrl)}))&&(f.selectTab(e),o=!0),o||f.selectTab(f.getTabs()[0])),t.length?(m.addClass("with-page-libs"),m.removeClass("without-page-libs")):(m.removeClass("with-page-libs"),m.addClass("without-page-libs"))}var a=this,t=[],n=pinegrow.getSelectedPage(),i=((t=(t=n?n.getPageLibs():t).length?t:[]).unshift({lib:!0}),null),r=[],s={},l=[],c=(localStorage.pg_custom_page_libs&&(l=JSON.parse(localStorage.pg_custom_page_libs)),function(e){for(var t=0;t<l.length;t++)if(l[t].url===e)return t;return-1}),p=this.addCustom=function(e){var t=c(e.url);t<0?l.push(e):l[t]=e,d()},d=function(){localStorage.pg_custom_page_libs=JSON.stringify(l)},g=null,u=function(e){e!==g&&(g&&pg$Hide(g.view.get$Element()),pg$Show(e.view.get$Element(),"block"),g=e,pgUIViewManager.updateVisibilityInArea(h))},m=$('<div class="pg-page-lib-tabs"><div class="pg-page-lib-tabs-content"></div></div>'),n=this.view=new PgUIView(m,o?null:"library","Library"),h=(n.tabIcon="icon-import",n.onResize=function(){i&&i.view.whenVisible(function(){i.view.onResize()},"resize"),r.forEach(function(e){e.updateSize()})},m.find(".pg-page-lib-tabs-content")),t=(n.on("crsa-page-selected",e),n.on("crsa-frameworks-changed",e),new PgButtonToolbar),f=(m.prepend(t.$element.addClass("pg-tabs-toolbar")),new PgToolbarTabButtons(t,"tabs")),b=(f.onTabSelected=function(e){var t,n=e.data;u(n),n instanceof PgPageLibView?(t=pinegrow.getSelectedPage())&&(t.currentPageLibUrl=n.item.url):n instanceof PgImageBrowserView&&(n.images_shown||n.onShown())},f.onTabClosed=function(e){var t=e.data;t.view.destroy(),delete s[t.item.url]},function(e,t){var n,i;s[e.url]?f.selectTab(f.findTabWithData(s[e.url])):((n=new PgPageLibView(e,a)).quickWin=o,h.append(n.view.get$Element()),n.view.whenVisible(function(){n.open(e)},"openLib"),s[e.url]=n,pg$Hide(n.view.get$Element()),t&&u(n),i=f.addTab(e.tab_name||e.name||"Tab",e.url,n,t).setClosable(!0),n.pageLibTab=i,r.push(n))}),w=(t.addSection("icons"),new PgButtonToolbarItem("icon-plus","Open a page as library...")),v=(pgf.kids||t.addItem("icons",w),w.onClick=function(){var t,n=[],e=[],i=pinegrow.getSelectedPage(),o=(i&&(e=i.getPageLibs(),t=null,e.forEach(function(e){e.framework&&t!=e.framework.name&&(n.push({type:"header",label:e.framework.name}),t=e.framework.name),n.push({label:e.name,action:function(){b(e,!0)}})})),l.length&&(n.push({type:"divider"}),n.push({type:"header",label:"Custom"}),l.forEach(function(i){n.push({label:i.name||crsaGetSummaryStr(i.url,40,!1),action:function(){b(i,!0)},check:'<i class="icon icon-close"></i>',check_action:function(e){var t,n;n=i.url,0<=(t=c(n))&&l.splice(t,1),d(),n=i.url,s[n]&&f.removeTab(f.findTabWithData(s[n])),e.preventDefault(),e.stopPropagation(),o.close()},check_tooltip:"Remove from the list"})}),n.push({type:"divider"})),isApp()&&(n.push({type:"header",label:"Load custom page library"}),n.push({label:"Open...",action:function(){v(null,function(e){b(e,!0),p(e)})}})),0===n.length&&(i?pinegrow.showQuickError("No page libraries are available."):pinegrow.showQuickError("Please open a page first.")),new CrsaContextMenu(n,w.$element));o.showForElement(w.$element,null,8)},this.addOrEditPageLibItem=function(e,t){var n=e,i=e?cloneObject(e):{},o=new PgDialog(n?`Edit page library `+crsaGetNameFromUrl(e.url):"Add a new page library");o.values=i,o.okButtonLabel=n?"Save changes":"Add",o.before=`<p>Page libraries let you open a local file or URL and use it as a component library from where you can drag components to the page. <a href="https://pinegrow.com/docs/master-pinegrow/page-libraries/" class="external">Learn more about Page libraries.</a></p>`,o.sections={url:{name:"Page Library information",is_closable:!1,fields:{url:{type:"text",name:"URL or local file",file_picker:!0,file_picker_no_url:!1,validate:function(e,t,n,i,o,a){if(!n)return pinegrow.getValidationError(i.name,"req")},disabled:n||!1,placeholder:"for example, https://pinegrow.com/buttons.html",helptext:`<p>Select the local file or enter a URL you want to use as a page library.</p>`},name:{type:"text",name:"Library name",placeholder:"default, URL name",helptext:`<p>Give the page library a name, for example &quot;Cool Buttons&quot; File or URL name is used by default.</p>`},selector:{type:"text",name:"Components selector",placeholder:"default, *",helptext:`<p>A CSS selector for selecting HTML elements that can be dragged to the page, for example <code>section, header, .component</code>. By default, all elements (<code>*</code>) are draggable.</p>`},navigation_selector:{type:"text",name:"Navigation selector",placeholder:"default, none",helptext:`<p>A CSS selector for navigation areas where Pinegrow should let the page handle the clicks even if test clicks is off.</p>`}}}},o.onOK=function(){var e=o.values;e.name=e.name||crsaGetNameFromUrl(e.url),e.selector=e.selector||"*",e.direct=!crsaIsFileUrl(e.url),t(e)},o.show()}),_=i=this.lib=new PgLibraryView(!0,o);_.quickWin=o,h.append(_.view.get$Element()),_.view.whenVisible(function(){_.show()}),pgQuickInsertLastFilter&&_.setFilter(pgQuickInsertLastFilter),u(_),f.addTab(pgf.kids?"Elements":"List",pgf.kids?"HTML elements that you can insert on the page.":"Elements and components from all active frameworks.",_,!0).setClosable(!1),pgf.insert_in_top_menu&&(n=new PgImageBrowserView,f.addTab("Images","Insert images to the page.",n,!1).setClosable(!1),h.append(n.view.get$Element()),pg$Hide(n.view.get$Element())),e()},PgPageLibView=function(_,t){function o(){0<L?l.$element.removeClass("disabled"):l.$element.addClass("disabled"),L<P.length-1?c.$element.removeClass("disabled"):c.$element.addClass("disabled")}function n(e){var t=e||g.get(0).contentWindow.location.href,t=pinegrow.getOriginalUrl(t);t=pgRemoveUrlParameter(t,"pgz"),pinegrow.pageLibManager.get(t)&&pinegrow.pageLibManager.remove(t),A(t,!0)}function a(){var e,a,r;m.isVisible(!0)&&(e=u.getDocument().scrollingElement,u.currentScrollTop=e.scrollTop),_.pages_toc||(e=$(u.getDocument().scrollingElement),a=e.scrollTop(),r=e.height(),e.find(".pg-lib-section").each(function(e,t){var n=$(t),i=n.position(),o=n.height();if(!(i.top+o<a||i.top>r+a))return f.toolbarItem.$element.find("topic").html(n.find(".pg-lib-section-title").html()||"No title"),!1}))}function d(t){try{for(var e=t.getBoundingClientRect(),n=t,i=t,o=4;1;){var a=n.getBoundingClientRect();if(Math.abs(a.left-e.left)>=o||Math.abs(a.top-e.top)>=o||Math.abs(a.right-e.right)>=o||2e3<a.height)break;if("BODY"==n.tagName)break;n=(i=n).parentNode}return i}catch(e){return t}}var g,r,s,i,l,c,p,u=this,y=(this.item=_,this.currentScrollTop=0,_.framework||(_.framework=new PgFramework(_.name,_.name),_.framework.pluginUrl=_.url,_.framework.customResourceNamespace=""),_.resources_dir||(_.resources_dir=""),$('<div class="pg-page-lib"></div>')),m=this.view=new PgUIView(y),e="translate3d(20px, 20px, 0px) rotate3d(0,0,0, 30deg) !important;",k="    .pg-lib-item, .pg-lib-item-temp-draggable {        cursor: grab !important;        position: relative;    }    html:not(.pg-lib-no-transforms) .pg-lib-item, html:not(.pg-lib-no-transforms) .pg-lib-item-temp-draggable {        transition:all 0.1s !important;    }    html:not(.pg-lib-no-transforms) .pg-lib-item:hover, html:not(.pg-lib-no-transforms) .pg-lib-item-temp-draggable:hover {        transform:translate(2px, 2px) !important;        box-shadow:-2px -2px 8px 0px rgba(0,0,0,0.5) !important;    }    html.pg-lib-no-transforms .pg-lib-item:hover, html.pg-lib-no-transforms .pg-lib-item-temp-draggable:hover {        outline:4px solid #0098cc;    }    .pg-lib-item-spread {        //perspective:600px;        box-shadow:0 0 2px #039dff;        z-index:1;        margin-bottom:80px;    }    .pg-lib-item-spread * {        transform:"+e+"        box-shadow:0 0 2px #039dff;    }    .pg-lib-item-spread *:hover {        transform:"+e+"        box-shadow:0 0 2px #039dff;    }    [pg-draggable] *{        cursor: grab !important;    }    html body .pg-lib-item-locked {        //outline:4px solid #33add6 !important;        //outline-offset: -4px;        transform: translate(5px, 5px) !important;        box-shadow: -6px -6px 0px 0px #33add6 !important;    }    html body .pg-lib-item-locked:hover {        transform: translate(10px, 10px) !important;        box-shadow: -6px -6px 0px 0px #33add6, -2px -2px 8px 0px rgba(0,0,0,0.5) !important;    }        ",h=(k+=`
.pg-lib-hide {
    display: none;
}

.pg-lib-hover-menu {
    position: absolute;
    right:-5px;
    top:-20px;
    height:20px;
    background-color: #33add6;
    z-index:999;
    white-space: nowrap;
    font-size: 11px;
    transform: scale(var(--pg-scale-to-100));
    transform-origin: 100% 100%;
    cursor: pointer !important;
    text-transform: uppercase;
    padding-top: 3px;
    padding: 3px 4px;
}

.pg-lib-hover-menu a {
    color: #ffffff;
    text-decoration: none;
}

.pg-empty-placeholder {
    min-height: 100px;
    box-shadow: 0 0 0 1px rgba(0,0,0,0.15);
    background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAQAAAAECAYAAACp8Z5+AAAADklEQVQIW2NgQAXGZHAAGioAza6+Hk0AAAAASUVORK5CYII=);
}
`,[]),f=null,b=null,P=[],L=-1,E=null,I=!1,C="*"===_.selector,H=function(e){return e=u.item.direct?e:pinegrow.getProxyUrl(e)},A=(this.reload=n,function(i,o,a){function n(){var e=E=i;if(i=H(i),o&&u.item.direct&&(i=crsaAppendQueryToUrl(i,[`pgz=`+(new Date).getTime()])),isApp()||u.item.direct?g.attr("src",i):g.get(0).srcdoc=r,_.pages_toc&&f){for(var t=null,n=0;n<_.pages_toc.length;n++)if(_.pages_toc[n].url===e){t=_.pages_toc[n].name;break}f.toolbarItem.$element.find("topic").html(t||"Index")}a&&a()}var r="";if(U.appendTo(p),!u.item.direct){var s=pinegrow.pageLibManager.get(i);if(s)return isApp()||(r=s.sourceNode.toStringWithIds(!0)),void n();if((s=new PgPageLib).name="PageLib",s.url=i,s.forceReload=o,s.forcePgIds=!0,pinegrow.pageLibManager.add(i,s),!isApp())return void $.ajax({url:i,data:null,dataType:"text"}).done(function(e){var t=new pgParser,t=(t.assignIds=!0,t.parse(e),s.sourceNode=t.rootNode,pgCreate(`<base href="${i}"/>`));s.sourceNode.findOne("head").prepend(t),r=s.sourceNode.toStringWithIds(!0),n()}).fail(function(e){})}n()}),N=(this.initToc=function(){s=$('<div class="pg-page-lib-tabs-toc"></div>').prependTo(y),i=new PgButtonToolbar,s.append(i.$element),i.addSection("nav"),i.addSection("cmd"),i.addSection("zoom"),f=new PgButtonToolbarItemWithDropdown("<span><topic>"+(_.pages_toc?_.name:"")+'</topic><i class="icon icon-down"></i></span>',"Jump to content section"),i.addItem("nav",f.toolbarItem),(l=new PgButtonToolbarItem("icon-left","Navigate back.")).onClick=function(){0<L?A(P[--L].url):pinegrow.showQuickMessage("You are at the beginning of the history.")},(c=new PgButtonToolbarItem("icon-right","Navigate forward.")).onClick=function(){L<P.length-1?A(P[++L].url):pinegrow.showQuickMessage("You are at the end of the history.")},_.no_history||(i.addItem("nav",l),i.addItem("nav",c)),o(),b=new PgButtonToolbarItemWithDropdown('<span><i class="icon icon-zoom"></i><topic></topic></span>',"Zoom view"),[100,75,50,25].forEach(function(e){b.addAction({label:e+`%`,action:function(){u.zoomView(e)},check:function(){return e==S}})}),i.addItem("zoom",b.toolbarItem),this.zoomView(parseInt(pinegrow.getSetting("page-lib-zoom",100)));var e=new PgButtonToolbarItem("icon-touch","Let the page handle the clicks. Useful for navigation and interaction with the page."),e=(e.$element.addClass("page-lib-test-clicks-control"),i.addItem("cmd",e),e.onClick=function(){I=!this.getActive(),this.setActive(I)},i.addSection("options"),new PgButtonToolbarItem("icon-down","Page library options"));i.addItem("icons",e),e.onClick=function(){var e=[{type:"header",label:"Load"},{label:"Through internal web server",check:function(){return!_.direct},action:function(){_.direct=!1,n(),pinegrow.showQuickMessage("Loading the page through the internal web server...")}},{label:"Directly",check:function(){return _.direct},action:function(){crsaIsFileUrl(_.url)?pinegrow.showQuickError("Local page libraries can't be loaded directly."):(_.direct=!0,n(),pinegrow.showQuickMessage("Loading the page directly..."))}},{type:"divider"},{type:"header",label:"Pick elements"},{label:"Any",check:function(){return C},action:function(){C=!0,R(),pinegrow.showQuickMessage("Drag any element from the page. Click to select, double-click to break apart.")}}];return(e=[]).push({type:"header",label:"Page library"}),e.push({label:"Settings...",action:function(){_.dynamic?pinegrow.showQuickError(`This page library is defined by ${_.framework?_.framework.name:"a plugin"} and can't be edited.`):t.addOrEditPageLibItem(_,function(e){t.addCustom(e),u.item=_=e,u.pageLibTab.setLabel(_.tab_name||_.name),n(_.url)})}}),e.push({type:"divider"}),e.push({label:"Reload",action:function(){n()}}),_.on_page_lib_menu&&_.on_page_lib_menu(e,u),new CrsaContextMenu(e,this.$element).showForElement(this.$element),!1},(r=$('<ul class="pg-page-lib-crumbs"></ul>')).appendTo(y),r.on("click","li",function(e){r.find(".locked").removeClass("locked");var t,n=$(this),i=n.attr("data-pg-id"),o=w||u.getDocument();i?t=$(o.body).find('[data-pg-id="'+i+'"]'):(i=n.attr("data-pg-dyn-id"))&&(t=$(o.body).find('[data-pg-dyn-id="'+i+'"]')),t&&t.length&&(u.elementLocked==t.get(0)?(u.selectElement(null),T()):(u.selectElement(t,w),n.addClass("locked")))}),T()},0),R=function(){T(),F()},w=null,T=function(e){var t="";if(e)for(;e&&e.length&&!e.is("body");){var n,i,o=e.attr("data-pg-id");o?(n=getPgNodeByPgId(o))&&(t='<li class="divider"><i class="icon icon-right"></i></li><li data-pg-id="'+o+'" class="'+(i=e.get(0)==u.elementLocked?"locked":"")+'">'+n.getName({short:!0})+"</li>"+t):(i=e.get(0)==u.elementLocked?"locked":"",o="did_"+N++,e.attr("data-pg-dyn-id",o),t='<li class="divider"><i class="icon icon-right"></i></li><li data-pg-dyn-id="'+o+'" class="'+i+'">'+getElementName(e,{display_name:"tag"},!0,!0)+"</li>"+t),e=e.parent()}else t=C?'<li class="instructions"><b>Drag</b> elements to the page. <b>Click</b> to show element selection path. <b>Double-click</b> to break an element apart.</li>':'<li class="instructions"><b>Drag</b> components to the page. <b>Click</b> to break components apart.</li>';r.html(t),u.updateSize()},S=(this.elementLocked=null,this.selectElement=function(e,t){t=t||u.getDocument(),$(t.body).find(".pg-lib-item").removeAttr("pg-draggable").removeAttr("draggable").removeClass("pg-lib-item"),$(t.body).find(".pg-lib-item-locked").removeClass("pg-lib-item-locked"),w=e?(e.attr("pg-draggable","true").attr("draggable","true").addClass("pg-lib-item"),this.elementLocked=e.get(0),e.addClass("pg-lib-item-locked"),t):(this.elementLocked=null,null)},100),x=(this.zoomView=function(e){S=e,b.toolbarItem.$element.find("topic").html(e+`%`),g.css({transformOrigin:"0 0",transform:`scale(${e/100})`,width:100*100/e+`%`,height:100*100/e+`%`}),pinegrow.setSetting("page-lib-zoom",e);try{u.getDocument().body.style.setProperty("--pg-scale-to-100",1/(e/100))}catch(e){}},this.getDocument=function(){return g.get(0).contentDocument},m.onShow=function(){var e,t=u.getDocument().scrollingElement;0<u.currentScrollTop?t.scrollTop=u.currentScrollTop-1:(e=(t=$(t)).scrollTop(),t.scrollTop(e-1))},m.onHide=function(){x&&(clearTimeout(x),x=null)},null),M=!1,D=[],F=(this.whenLoaded=function(e){M?e():D.push(e)},function(e){e=e||u.getDocument();var t=_.selector||"*";C="*"===_.selector,$(e.body).find("*").removeAttr("draggable"),$(e.body).find("[pg-draggable]").removeAttr("pg-draggable"),$(e.body).find("[pg-lib-item-temp-draggable]").removeAttr("pg-lib-item-temp-draggable"),C||$(e.body).find(t).attr("pg-draggable","true").attr("draggable","true").addClass("pg-lib-item"),_.navigation_selector&&$(e.body).find(`${_.navigation_selector}, ${_.navigation_selector} *`).removeAttr("pg-draggable").removeAttr("draggable").removeClass("pg-lib-item"),$(e.body).find("a.pg-lib-link, .pg-lib-link img").attr("draggable","false"),$(e.body).find("a.pg-lib-link").attr("title","Click to open.")}),U=null,v=(this.open=function(){function e(){function s(e){(e=e.closest(v)).length&&(e.addClass("pg-lib-item-spread"),e.find("*").each(function(e,t){var n=$(t);n.attr("pg-draggable","true"),n.attr("draggable","true"),n.addClass("pg-lib-item-temp-draggable")}))}function l(e){(e=e||u.getDocument()).querySelectorAll(".pg-lib-item-spread").forEach(function(e){e.classList.remove("pg-lib-item-spread")}),e.querySelectorAll(".pg-lib-item-temp-draggable").forEach(function(e){e.classList.remove("pg-lib-item-temp-draggable"),e.removeAttribute("pg-draggable"),e.removeAttribute("draggable")})}function t(a){$(a.body).find("[target]").attr("target",""),_.no_spreading&&a.documentElement.classList.add("pg-lib-no-transforms"),F(a),$(a.head).append("<style>"+k+"</style>"),a.addEventListener("contextmenu",function(e){return e.preventDefault(),e.stopPropagation(),!1},!0,!1);var r=new PgPluginBuilder,n=_.show_hover_menu||!0,c=[{label:"Replace",helptext:"Replace the selected element",action:function(e){var t=pinegrow.selectedElements.getLastSelected();t?(new PgApi).transformElement(t,e.pgel):pinegrow.showQuickError("Please select an element first.")}}],i=(pinegrow.dispatchEvent("on_page_lib_get_hover_menu_actions",null,c),$(`<div class="pg-lib-hover-menu"></div>`)),p=(1===c.length?(i.html(`<a href="#">${c[0].label}</a>`),i.find("a").on("click",function(e){var t;e.preventDefault(),p&&(t=h(p),c[0].action(t))})):(i.html(`<a href="#">Actions <i class="icon icon-down"></i></a>`),i.find("a").on("click",function(e){var t,n,i,o,a,r,s,l;if(e.preventDefault(),p)return t=h(p),n=[],c.forEach(function(e){n.push({...e,action:function(){e.action(t)}})}),i=new CrsaContextMenu(n,g),o=e.pageX,e=e.pageY,a=g.contents(),r=a.scrollLeft(),a=a.scrollTop(),s=g.offset(),r={left:o*(l=S/100)+s.left-r*l,top:e*l+s.top-a*l},i.showAt(r.left,r.top),!1})),null),h=(i.find(".replace").on("click",function(e){e.preventDefault(),p&&h(p)}),a.addEventListener("mouseover",function(e){var t,n;I||(t=e.target,n=$(t),_.navigation_selector&&n.closest(_.navigation_selector).length)||C&&(e.preventDefault(),u.elementLocked||n.closest(".pg-lib-item-spread").length||($(a.body).find(".pg-lib-item").removeAttr("pg-draggable").removeAttr("draggable").removeClass("pg-lib-item"),(n=$(d(t))).attr("pg-draggable","true").attr("draggable","true").addClass("pg-lib-item")))}),n&&($(a).on("mouseenter",".pg-lib-item",function(){var e=$(this),t=pinegrow.selectedElements.getLastSelected();n&&t&&t.canDelete()&&e.length&&!i.parent().is(e)&&(i.prependTo(e),p=e)}),$(a).on("mouseleave",".pg-lib-item",function(){var e=$(this);n&&e.length&&i.parent().is(e)&&(i.detach(),p=null)})),a.addEventListener("click",function(e){if(I)highlightUIElement($(".page-lib-test-clicks-control"),"show-click");else{var t,n,i=e.target,o=$(i);if(!o.closest(".pg-lib-hover-menu").length){if(_.no_spreading||_.navigation_selector&&0<o.closest(_.navigation_selector).length)return(n=i.closest("a"))&&n.hasAttribute("data-pg-lib-template")?(t=new URL(n.getAttribute("data-pg-lib-template"),pinegrow.getOriginalUrl(g.get(0).contentWindow.location.href)).toString(),e.preventDefault(),pinegrow.openOrShowPage(t,function(e){e.localFile=null,e.pageIsRemoteTemplate=crsaIsRemoteUrl(t),e.source_framework=_.framework}),!1):!_.direct&&n&&(n=n.getAttribute("href"))&&!n.startsWith("#")?(n=(isApp()?new URL(n,g.get(0).contentWindow.location.href):new URL(n,E)).toString(),A(pinegrow.getOriginalUrl(n)),e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation(),!1):void 0;if(C||!_.selector||0!==o.closest(_.selector).length){if(e.preventDefault(),!e.altKey)return o.is(".pg-lib-item-spread")||0<o.closest(".pg-lib-item-spread").length?(l(a),!1):void(C?(o=$(d(i)),u.elementLocked&&o.get(0)==u.elementLocked?(u.selectElement(null,a),T(null)):(u.selectElement(o,a),T(o))):s(o));o.is("a")&&(n=i.href,g.attr("src",n))}}}}),_.no_spread||a.addEventListener("dblclick",function(e){var t,n;I?highlightUIElement($(".page-lib-test-clicks-control"),"show-click"):(e.preventDefault(),t=e.target,n=(t=$(t)).is(".pg-lib-item-spread")||0<t.closest(".pg-lib-item-spread").length,l(a),n||s(t))}),function(e){var t,n=(e=e.hasClass("pg-lib-svg-wrapper")?e.find("svg"):e).attr("data-pg-id"),i=[];if(_.get_code)try{var o=pgCreateNodeFromHtml(_.get_code(e,C),!0,!0);o&&(o=o.filter(function(e){return e.isElementOrScript})).length&&(t=o.shift(),i=o)}catch(e){console.warn("Unable to create Lib element",e)}else n?(t=getPgNodeByPgId(n))&&(t.parent,(t=t.clone()).walkSelfAndChildren(function(e){e.clearData()})):(o=(t=pgCreate(e.get(0).outerHTML)).findOne(".pg-lib-hover-menu"))&&o.remove();function a(e){collapseNewPgelIfNeeded(e),_.on_pgel_created&&_.on_pgel_created(e);var i,t=e.hasClass("pg-lib-item-skip-replace-images"),o=[];_.removeClasses&&(o=o.concat(_.removeClasses)),e.walkSelfAndChildren(function(n){return n.getClasses().slice(0).forEach(function(e){if(e.startsWith("pg-lib-item"))n.removeClass(e);else for(var t=0;t<o.length;t++)"string"!=typeof o[t]||e!==o[t]&&!e.match(o[t])||n.removeClass(e)}),_.removeAttributes&&_.removeAttributes.forEach(function(e){n.removeAttribute(e)}),n.removeAttribute("draggable"),n.removeAttribute("pg-draggable"),n.removeAttribute("data-pg-require"),n.removeAttribute("data-pg-require-plugins"),_.remove_class_styles&&(n.removeAttribute("data-pg-class-style"),n.removeAttribute("data-pg-class-style-inline")),!0}),t||r.replaceHolderImages(e),_.make_all_urls_absolute&&(i=_.direct?g.get(0).contentWindow.location.href:E,i=pinegrow.getOriginalUrl(i),e.goThroughAllUrls(function(e,t,n){if(!crsaIsAbsoluteUrl(e))try{e=new URL(e,i).toString()}catch(e){}return e},!1,!0))}return t&&a(t),i&&i.forEach(a),{pgel:t,rest:i}}),f=new PgDragHelper($(a.body),"[pg-draggable]",null,!0);f._oAnotherDocument=$(document),f.onGetDragImage=function(e){return 200<e.height()||800<e.width()?"none":null},f.on("dragStart",function(e,t,n){$.fn.crsapages("showOverlays"),w&&(clearTimeout(w),w=null),n.pageX,n.pageY;function i(e){(e.attr("data-pg-require")||"").split(",").forEach(function(e){(e=e.trim()).length&&r.indexOf(e)<0&&r.push(e)}),(e.attr("data-pg-require-plugins")||"").split(",").forEach(function(e){(e=e.trim()).length&&l.indexOf(e)<0&&l.push(e)})}for(var o=f.dragTarget,a=null,r=[],s=[],l=[],c=o;c.length&&(i(c),!c.is("html"));)c=c.parent();o.find("[data-pg-require],[data-pg-require-plugins]").each(function(e,t){i($(t))});o.closest("html").find("[data-pg-require-code]").each(function(e,t){t=$(t),s.push({code:t.html(),detect:t.attr("data-pg-require-code"),footer:0===t.closest("head").length})});var p,d,g,u=h(o),m=u.pgel,u=u.rest;_.copy_images&&m.goThroughAllUrls(function(e,t,n){return!e||"image"!==pinegrow.getSimpleMimeType(e)&&"img"!==n.tagName||crsaIsAbsoluteUrl(e)||r.indexOf(e)<0&&r.push(e),e},!1,!0),m&&(_.get_required_resources&&_.get_required_resources(m,o).forEach(function(e){r.indexOf(e)<0&&r.push(e)}),o=null,o=(o=(p=pinegrow.getSelectedPage())?p.getMainType(null,m):o)||{name:"Element"},r&&(d={name:o.name,framework:_.framework,resources:new PgResourcesList,on_inserted:_.on_inserted||null,required_plugins:l},r.forEach(function(e){var t=new URL(e,_.url).toString(),n={resources_dir:"string"==typeof _.resources_dir?_.resources_dir:"pagelib",remote_source:t,place_before_user_style:!0,replace:!0};_.resource_options&&$.each(_.resource_options,function(e,t){n[e]=t}),d.resources.add(_.framework.addResource(e,n))}),g=new PgPluginBuilder(_.framework),s.forEach(function(e){g.addResourceCode(e.code,e.detect?new RegExp(pgParserEscapeRegExp(e.detect)):null,e.footer,d.resources)}),o=d),a&&"*"==v&&!a.getAttribute("id")&&(a.getClasses().length?a.getClasses().map(function(e){return"."+e}).join(","):0<=["body","main","header","footer","nav","section"].indexOf(a.tagName)&&a.tagName),(b=new PgDragMenu(o||{name:"Element"},!1,!0,null,m)).pgel=m,b.selectNew=!0,b.formatHtml=!0,u&&u.length&&(b.morePgels=u),b.handleMoveEvent(n,b),b.onInsert=function(e){if(_.require_saved_page){var t=this.positionPgel.getPage();if(!t||t.isNew())return pinegrow.showQuickError("Please save the page first."),!0}}),y.trigger("pg-drag-start")},this),f.on("drag",function(e,t,n){b&&b.handleMoveEvent(n,b)},this),f.on("dragStop",async function(e,t){$.fn.crsapages("showOverlays",!0),b&&(await b.insertAsync(),b.destroy()),b=null,crsaFuncs.showInsertionLine(null),pinegrow.highlightElement(null),y.trigger("pg-drag-stop")},this),_.no_drag_image&&(f.onGetDragImage=function(){return"none"}),a.addEventListener("keydown",function(e){$.fn.crsa("processKeydownEvent",e)},!0),a.addEventListener("keyup",function(e){$.fn.crsa("processKeyupEvent",e)},!0)}function n(e){t(e.contentDocument),$(e).on("load",function(e){t(e.target.contentDocument)})}U.detach(),e=g.get(0).contentWindow.location.href,e=pinegrow.getOriginalUrl(e),P.length&&P[L].url===e||(P.length&&P.splice(L+1,P.length-L-1),P.push({url:e}),L=P.length-1),o(),u.zoomView(S),i||$(g.get(0).contentWindow).on("focus",function(){pgAppWindowHasFocus(pgGetAppWindowForDOMElement(g.get(0)))}).on("blur",function(){pgAppWindowLostFocus(pgGetAppWindowForDOMElement(g.get(0)))});var b=null,w=null,e=(_.direct,u.getDocument());crsaHandleExternalLinks($(e.body)),_.direct||$(e.body).find("a").each(function(e,t){t.getAttribute("aahref")&&(t.removeAttribute("onclick"),t.setAttribute("href",t.getAttribute("aahref")),t.removeAttribute("aahref"));var n=t.getAttribute("href");n&&crsaIsAbsoluteUrl(n)&&!t.classList.contains("external")&&t.setAttribute("href",pinegrow.getProxyUrl(pinegrow.getOriginalUrl(n)))}),t(u.getDocument()),$(e.body).find("iframe").each(function(e,t){n(t)}),u.iframe_observer&&u.iframe_observer.disconnect(),u.iframe_observer=new MutationObserver(function(e){e.forEach(function(e){"childList"===e.type&&e.addedNodes.forEach(function(e){if("iframe"===e.nodeName.toLowerCase())n(e);else{var t=e.querySelectorAll?e.querySelectorAll("iframe"):null;if(t)for(let e=0;e<t.length;e++)n(t[e])}})})}),u.iframe_observer.observe(e.body,{childList:!0,subtree:!0}),u.getDocument().addEventListener("scroll",function(){x&&clearTimeout(x),x=setTimeout(function(){a()},300)}),M=!0,D.forEach(function(e){e()}),D=[],a(),_.on_page_lib_loaded&&_.on_page_lib_loaded(e,u)}var t=(_=this.item).url,v=_.selector,n=navigator.userAgent+" PinegrowInternal PinegrowPageLib",i=(p=$("<div/>",{class:"page-lib"}).html('<div class="content"><iframe class="content-iframe" frameborder="0" nwfaketop nwdisable nwUserAgent="'+n+'"></iframe></div>'),U=$('<div class="iframe-loading-overlay"><div><i class="icon-REFRESH icon-spin"></i>Loading, please wait...</div></div>').appendTo(p),g=p.find(".content-iframe"),p.appendTo(y),!1);g.on("load",function(){_.load_delay?setTimeout(e,_.load_delay):e()}),A(t),this.initToc(),f&&f.toolbarItem.hide(),u.whenLoaded(function(){s.find("ul");u.getTocHtml()&&(f.clearActions(),h.forEach(function(e){f.addAction(e.name,function(){_.pages_toc?A(e.id):u.scrollToTopic(e.id)})}),f)&&f.toolbarItem.show(),u.updateSize()})},this.getTocHtml=function(){var o="",a="pglibtoc_";return h=[],_.pages_toc?_.pages_toc.forEach(function(e){o+='<li data-toc-target="'+e.url+'">'+e.name+"</li>",h.push({name:e.name,id:e.url})}):$(u.getDocument()).find(".pg-lib-section").each(function(e,t){var n=$(t),i=n.find(".pg-lib-section-title").html();i&&(n.attr("id",n=a+e),o+='<li data-toc-target="'+n+'">'+i+"</li>",h.push({name:i,id:n}))}),o},this.scrollToTopic=function(e){var t=$(u.getDocument()),n=t.find("#"+e),t=(0==n.length&&(this.getTocHtml(),n=t.find("#"+e)),n.position());$(u.getDocument().scrollingElement).scrollTop(t.top)},current_th=0);this.updateSize=function(){m.whenVisible(function(){var n;r&&(n=m.getFastdomTasks().create("resizePageLib"+m.getId()),r.css("height","auto"),n.measure(function(){var e=r.outerHeight(),t=s.is(":visible")?s.height()+10+"px":"10px";v==e&&current_th==t||(n.mutate(function(){r.css("height",e+"px"),p.css({bottom:e+"px"})}),v=e,current_th=t)}))},"resizeView")},m.onResize=function(){},m.onDestroy=function(){m.getFastdomTasks().stopAll("resizePageLib"+m.getId()),u.iframe_observer&&(u.iframe_observer.disconnect(),u.iframe_observer=null),g&&g.remove(),pinegrow.pageLibManager.remove(u.item.url),x&&(clearTimeout(x),x=null)}},PgCombinedLibView=function(){var e=new PgLibraryView(!0),t=new PgPageLibsTabbedView(this),n=new PgCombinedPanelView("combined-lib",e.view,t.view,"lib","icon-import");this.view=n.view;t.initToc(),e.show()},PgQuickPageLib=function(e,t,n,i,o){var a,r=this,s=new PgPageLibsTabbedView(this),l=this.lib=s.lib,c=this.win=new PgQuickWindow("Insert element",s,"quickPageLib",400,600,!1,null,o),p=(o&&(l.keep_open_on_drag="1"===pinegrow.getSetting("lib-keep-open-on-drag","0"),(a=c.addIconToHeader("icon-Pin","Keep the insert window open",function(e){l.keep_open_on_drag=!l.keep_open_on_drag,pinegrow.setSetting("lib-keep-open-on-drag",l.keep_open_on_drag?"1":"0"),a.css("opacity",l.keep_open_on_drag?1:.5),pinegrow.showMode("Keep insert window open",l.keep_open_on_drag)})).css("opacity",l.keep_open_on_drag?1:.5)),c.$element.addClass("pg-lib-quick-win"),c.hideOnClose=!0,c.noRightEdge(),pinegrow.selectedElements.isSelectedElement(e),l.setInsertInfo(e,t),l.showPreviews=!0,l.onInsertPositionChanged=function(e){switch(e){case"append":0;break;case"prepend":0;break;case"insertBefore":0;break;case"insertAfter":0}var t=l.getInsertPgel();t&&t.getName({short:!0})},l.onInsertPositionChanged(t),"cover_left"===i?c.showCover(i):n?c.showFor$El(n,!1,pgf.insert_in_top_menu?0:80,i):e?c.showForPgel(e):c.showFor$El($("body"),!1,0),null);c.$element.on("pg-drag-start",function(){p=setTimeout(function(){r.hide()},100)}),c.$element.on("pg-drag-stop",function(){p&&(clearTimeout(p),p=null),pgf.insert_in_top_menu?l.keep_open_on_drag?r.show():r.win.visible&&r.hide():setTimeout(function(){r.show()},100)}),c.onDestroy=function(){},c.onHide=function(){pinegrow.dispatchEvent("on_quick_lib_window_hidden",null,r)},this.hide=function(){pgPreview.hide(),c.hide()},this.show=function(e){c.show(!0),pgQuickWindowManager.focus(c)}},PgLibraryView=function(e,a){function r(n){var e,t,i;return n.key in T||(t=e=null,n.framework&&!pgf.kids&&(e=n.framework.name,n.framework.user_lib)&&(e="<libname>"+e+"</libname> <changed>*</changed>",t="user-lib"),pgf.kids&&(n.is_closable=!1),e=new PgUISection(n.name,e,n),t&&e.$element.addClass(t),n.framework&&n.framework.user_lib&&e.$title.find("small").on("click contextmenu",function(e){pgPreview.hide();var t=new CrsaContextMenu(null,$(this));return t.add("Add as HTML snippet",null,function(){pinegrow.selectedElements.hasSelection()?pinegrow.getCollection().forEachElement(function(e){addAsComponent(e,n.framework)}):showAlert("First select the element on the page than add it to the snippet library.")}),t.add("Save",null,function(){n.framework.save(n.framework.pluginUrl,function(){pinegrow.frameworksChanged()})}),t.add("Save as...",null,function(){n.framework.pluginUrl?n.framework.save(n.framework.pluginUrl,function(){pinegrow.frameworksChanged()}):crsaChooseFile(function(e,t){n.framework.save(t,function(){pinegrow.frameworksChanged()})},n.framework.getFileName())}),t.showAt(e.pageX,e.pageY),!1}),t=e.$content,i=$("<div/>",{class:"pg-lib-section-content"}).appendTo(t),$.each(n.getComponentTypes(),function(e,t){x(t).appendTo(i)}),T[n.key]=e),T[n.key]}function s(e,t,n,i){i=i||t.getComponentTypes();var o=pg$FindAll(e.$content,".crsa-factory-element"),a=t&&n?t.name.match(n):t||!1,r=!0;return $.each(i,function(e,t){!n||a||t.name.match(n)?(pgShow(o[e]),r=!1):pgHide(o[e])}),!r}function t(){var e=pgLibraryLastUsed.getList(),t=(I.$content.empty(),$("<div/>",{class:"pg-lib-section-content"}).appendTo(I.$content));e.forEach(function(e){x(e).appendTo(t).addClass("pg-lib-recent-item")}),I.parent||M(m)}function n(){var e,t,n,o,i=!1;g.handleSelectedElements&&((e=pinegrow.selectedElements.getLastSelected())?(t=(u=e.getPage()).getAllTypes(null,e),n=[],$.each(t,function(e,t){t.action_menu&&t.action_menu.add&&n.push(t.action_menu)}),n.length&&(L.$content.empty(),o=$("<div/>",{class:"pg-lib-section-content"}).appendTo(L.$content),$.each(n,function(e,i){$.each(i.add,function(e,t){var n=u.getTypeDefinition(t);n&&((n=x(n,!0,!0)).data("action-menu",i),n.addClass("crsa-factory-element-link"),n.appendTo(o))})}),i=!0),c&&(g.setInsertInfo(e),w.getToolbar().getSection("icons").$element.show())):c&&w.getToolbar().getSection("icons").$element.hide(),i!=E)&&(E=i,M(m))}function i(){S(),M()}function o(e,t,n){"ai-smart-insert"===t&&M()}var l,c=(e=void 0===e?!0:e)&&a,p=(pgf.kids&&(c=!1),$('<div class="aacrsa-panel pg-lib"></div>')),d=new PgUIView(p,a?null:"librarylist"),g=((this.view=d).tabIcon="icon-import",this.showPreviews=!0,this.handleSelectedElements=e,this),u=pinegrow.getSelectedPage(),m=null,h=null,f=(this.onInserted=function(){},this.onBeforeInserted=function(){},null),b="append",w=(this.setInsertInfo=function(e,t){e&&(u=(f=e).getPage()),b=t||b,this.onInsertPositionChanged&&this.onInsertPositionChanged(b);for(var n=0;n<v.length;n++)if(v[n].data.position==b){_(v[n]);break}},this.getInsertPgel=function(){return f},this.onInsertPositionChanged=null,this.getFilter=function(){return h},this.setFilter=function(e){w.setValue(e)},new PgSearchBox({placeholder:"search",placeholder_active:null,toolbar_on:!0})),v=[],_=function(t){v.forEach(function(e){e.setActive(e===t),e===t&&(b=t.data.position,g.onInsertPositionChanged)&&g.onInsertPositionChanged(b)})},y=(c&&(v.push(w.addIcon({icon:'<i class="icon icon-Prepend"><span class="path1"></span><span class="path2"></span></i>',label:"Append to the selected element(s).",position:"append",func:_})),v.push(w.addIcon({icon:'<i class="icon icon-Append"><span class="path1"></span><span class="path2"></span></i>',label:"Prepend to the selected element(s).",position:"prepend",func:_})),v.push(w.addIcon({icon:'<i class="icon icon-Ins_before"><span class="path1"></span><span class="path2"></span></i>',label:"Insert before the selected element(s).",position:"insertBefore",func:_})),v.push(w.addIcon({icon:'<i class="icon icon-Ins_after"><span class="path1"></span><span class="path2"></span></i>',label:"Insert after the selected element(s).",position:"insertAfter",func:_}))),a||((k=w.getToolbar()).addSection("settings"),l=new PgButtonToolbarItem("icon-tools","Manage frameworks and plugins."),k.addItem("settings",l),l.onClick=function(){$.fn.crsacss("showFrameworkManager",pinegrow.getSelectedPage())}),new PgUISectionGrid),k=(pgf.kids||w.$element.appendTo(p),w.onSearch=function(e){h=e,g.show(m,e)},new PgSearchBoxSpacer),P=(y.$element.addClass("pg-search-box-results"),pgf.kids?y.$element.css({top:0}):k.$element.appendTo(p),this.focusSearch=function(){w.focus()},p.append(y.$element),y.$element),L=new PgUISection("Insert into selected",""),E=!1,I=new PgUISection("Recently used",""),C=new PgUISection(`Insert code <small>HTML or <a href="#" class="pug-info">${isApp()?"PUG":"SIMPLE"}</a></small>`,"",null,pgf.kids),A=new PgLibraryCodeInsert(a&&!pgf.kids),T=(C.onOpenClosed=function(){A&&A.resized()},C.$content.append(A.$element),C.$title.find(".pug-info").on("click",function(e){e.preventDefault(),e.stopPropagation();var t=`<p>Use the format <code>tag#id.class1.class2 Text</code> to describe the HTML structure. Each element should be in a separate line. Use indents to nest the elements.</p><p>Example:</p>
<pre>
div#hero.text-left.text-primary.bg-white
  h1 Hello
  p.lead How are you?
  ul
    li Item 1
    li Item 2
  div.content
  | Just text
</pre>`;return isApp()?t+=`<p>Pinegrow uses <a href="https://pugjs.org/language/tags.html" class="external">Pug</a> to translate the description to HTML.</p>`:t+=`<p>Although this is similar to Pug syntax, Pinegrow in the browser uses a simplified converter that only supports tags, ids, classes and text.</p>`,pinegrow.showAlert(t,"About the simplified HTML syntax"),!1}),this.updateLayout=function(){y.updateLayout()},{}),S=function(){T={}},x=function(e,t,n){n=t=!1;var i,o,a=t?pinegrow.repeater.showLiveRepeatCount():"",r=n?' <i class="icon icon-right-arrow"></i>':"";return(o=(e.button_image?(o=e.framework.getImagePreviewBaseUrl()+e.button_image+"?z="+pinegrow.cache_breaker,i=e.no_lib_label?"":"<name>"+e.name+r+"</name>",$("<div/>",{class:"crsa-factory-element-image crsa-factory-element crsa-factory-element-type-"+e.type}).html('<figure><img alt="'+e.name+'" src="'+o+'"/></figure>'+i+a)):$("<div/>",{class:"crsa-factory-element crsa-factory-element-text crsa-factory-element-type-"+e.type}).html("<name>"+e.name+a+r+"</name>")).data("crsa-factory-def",e)).attr("draggable","true"),o},M=(this.show=function(e,t){var n=new CrsaProfile,o=t&&0<t.length?new RegExp(escapeRegExp(t),"i"):null,i=P.scrollTop();y.clear(),u?(y.$element,e=e||u.getLibSections(),m=e,E&&this.handleSelectedElements&&!pgf.kids&&y.addSection(L),!pgf.kids&&pgLibraryLastUsed.getList().length&&s(I,null,o,pgLibraryLastUsed.getList())&&y.addSection(I),pgf.kids||(A||(A=new PgLibraryCodeInsert(a),C.$content.append(A.$element)),y.addSection(C)),$.each(e,function(e,t){var n,i=r(t);if(t.framework.user_lib&&(i.$title.find("libname").text(t.framework.name),n=i.$title.find("changed"),t.framework.changed?pg$Show(n,"inline"):pg$Hide(n)),t.show_if&&!t.show_if())return!0;s(i,t,o)&&y.addSection(i)}),n.show("showLib"),y.updateLayout(),A&&A.resized(),P.scrollTop(i)):(m=null,A&&A.destroy(),A=null)},function(e){d.whenVisible(function(){g.show(e,h)})}),D=(t(),n(),d.onResize=function(){A&&A.resized(),y.updateLayout()},d.on("crsa-frameworks-changed",i),d.on("crsa-page-selected",function(e,t){var n=null,i=!1;if(u=t){if(n=t.getLibSections(),null==m||null==n)i=!0;else if(m.length!=n.length)i=!0;else for(var o=0;o<n.length;o++)if(n[o]!=m[o]){i=!0;break}}else i=!0;i&&M(n)}),d.on("crsa-update-lib-display",i),pinegrow.addEventHandler("on_lib_last_used_changed",t),pinegrow.addEventHandler("on_selected_elements_changed",n),pinegrow.addEventHandler("on_setting_changed",o),new PgDelayedTasks),F=(d.onDestroy=function(){g.show(null),A&&A.destroy(),pinegrow.removeEventHandler("on_lib_last_used_changed",t),pinegrow.removeEventHandler("on_selected_elements_changed",n),pinegrow.removeEventHandler("on_setting_changed",o),D.destroy(),pgPreview.hide()},!1);!function(){p.on("click",".crsa-factory-element",function(e){e.preventDefault(),pgPreview.hide();var t,n,i=$(this),o=i.data("action-menu"),a=i.data("crsa-factory-def");o&&!pgf.kids?(f||pinegrow.selectedElements.hasSelection())&&crsaFuncs.insertThroughActionMenu(o,pinegrow.getCollectionForElement(f),a,!1):f&&!pgf.kids?(o=new PgApi,(t=createPgElFromDefinitionMultiple(a))&&(n=pinegrow.selectedElements.isSelectedElement(f)?pinegrow.selectedElements.getCollection():f,g.onBeforeInserted(t.collection,n,b),o.insertElements(t.collection,n,b,{highlight:!0,scroll:!0,repeater:!0,format_html:!0}),pgLibraryLastUsed.add(a),pinegrow.showQuickMessage(a.name+" inserted."),g.onInserted(t.collection,n,b))):F||(o=pgf.kids?"Structure panel":"Tree panel",i.tooltip({container:"body",trigger:"manual",title:`Drag & Drop me on the page or to the ${o}. Right click to insert into the selected element.`}),a=i.closest("body"),i.data("bs.tooltip").options.container=a.length?a:"body",i.tooltip("show"),setTimeout(function(){i.tooltip("destroy"),F=!1},4e3),F=!0)}),p.on("contextmenu",".crsa-factory-element",function(e){e.preventDefault();var t=$(this),n=t.data("crsa-factory-def"),i=n.framework||null,o=(pgPreview.hide(),new PgContextMenuHelpers(null,null)),a=new CrsaContextMenu(null,t),r=(pinegrow.selectedElements.hasSelection()&&o.addInsertActions(a,n),i.user_lib&&!t.hasClass("pg-lib-recent-item")&&(a.add("",null,null,"divider"),a.add("HTML Snippet",null,null,"header"),a.add("Rename...",null,function(){showPrompt("Enter the new name for the component:","Rename component",n.name,null,null,function(e){e&&n.name!=e&&(n.name=e,i.changed=!0,pinegrow.frameworksChanged())})}),a.add("Update",null,function(){var e=pinegrow.selectedElements.getLastSelected();e?showAlert("Do you want to update component <b>"+n.name+"</b> with the content of element <b>"+e.getName()+"</b>?","Confirm update","Cancel","Update it",null,function(){copyElementToDef(e,n,e.getPage(),!1),i.changed=!0,pinegrow.frameworksChanged(),crsaQuickMessage("Component updated")}):showAlert("First select the element on the page that you'll use to update the component with.")}),a.add("Delete",null,function(){showAlert("Are you sure? Deleting component <b>"+n.name+"</b> can't be undone.","Confirm delete","Cancel","Delete it",null,function(){i.removeComponentType(n),i.changed=!0,pinegrow.frameworksChanged()})})),a.add("",null,null,"divider"),a.add("Copy code",null,function(){var e=getCodeFromDefinition(n);copyCodeToClipboard(e)}),[]);u.callFrameworkHandler("on_build_lib_actions_menu",r,n);for(var s=0;s<r.length;s++)a.add(r[s].label,null,r[s].action);return a.showAt(e.pageX,e.pageY,y.$element),!1}),p.on("mouseenter",".crsa-factory-element",function(e){var n;!pgGetDragMenu()&&g.showPreviews&&(n=$(this),D.run("showPreview",function(){var e,t;pgGetAppWindowUnderMouse()===pgGetAppWindowForDOMElement(p.get(0))&&(e=n.data("crsa-factory-def"),(t=crsaFuncs.createPreviewElementFromDefinition(e))&&e.framework&&!e.preview_image&&e.framework.on_lib_show_preview&&e.framework.on_lib_show_preview(null,e,t,pgPreview),n.get(0).ownerDocument===document)&&pgPreview.show(n,t,e.preview_image?"with-image":null,removeCrsaClassesFromHtml(getCodeFromDefinition(e)))},300))}),p.on("mouseleave",".crsa-factory-element",function(e){D.cancel("showPreview"),pgPreview.hide()});var o,a,r=new PgDragHelper(p,".crsa-factory-element",null,!0);r.on("dragStart",function(e,t,n){$.fn.crsapages("showOverlays");var i=r.dragTarget.data("crsa-factory-def"),i=(pgPreview.hide(),a=i,(o=new PgDragMenu(i,!1,!0)).formatHtml=!0,createPgElFromDefinitionMultiple(i));i&&(o.pgel=i.pgel,o.morePgels=i.rest,o.handleMoveEvent(n,o)),p.trigger("pg-drag-start")},this),r.onSetDragData=function(e){},r.on("drag",function(e,t,n){o.handleMoveEvent(n,o)},this),r.on("dragStop",async function(e,t){$.fn.crsapages("showOverlays",!0),await o.insertAsync()&&pgLibraryLastUsed.add(a),o.destroy(),a=o=null,crsaFuncs.showInsertionLine(null),pinegrow.highlightElement(null),p.trigger("pg-drag-stop")},this)}(),this.setInsertInfo()},PgLibraryCodeInsert=function(e){var r,s=null,s=isApp()?require("pug"):new PgSimplePug,l="",c=this,t=(this.$element=$('<div class="pg-code-insert"><div class="pg-code-insert-editor"></div></div>'),this.view=new PgUIView(this.$element,"code_insert")),n=(this.$editor=this.$element.find("> .pg-code-insert-editor"),this.$item=$("<div/>",{class:"crsa-factory-element crsa-factory-element-text"}).html("<name>"+"Code bibo"+'</name><i class="clear icon icon-close"></i>').data("crsa-factory-def",null),this.$item.attr("draggable","true"),this.$item.find(".clear")),i=(n.on("click",function(e){return r&&r.setValue(""),!1}),addTooltip(n,"Clear code in the text editor."),$('<p class="pg-code-insert-editor-error"></p>').appendTo(this.$element)),o="",p=function(e){e!==o&&(e?(i.html(e),o||(pg$Show(i),pg$Hide(c.$item))):o&&pg$Hide(i),o=e),!e&&l&&pg$Show(c.$item),e||0!==l.length||pg$Hide(c.$item)},d=(p(null),pg$Hide(this.$item),addTooltip(this.$item,e?"Click to insert to the page":"Drag me to the page!",{placement:"bottom",trigger:"hover"}),this.$item.find("name"));this.$item.appendTo(this.$element);let g="pug",a=async function(e){if(0===(e=$.trim(e)).length)p(null),pg$Hide(c.$item),l=e;else{l.length;var t=l,n=(l=e,r.getPosition()),i=!!s&&(1<n.lineNumber?e.indexOf("<")<0:!e.match(/(\w+(>|{))|((^<\w+)|(^\s+<\w+))/is));if(i&&"pug"!=g)try{await h("pug"),a=s.render(e,{}),r.setPosition(n),g="pug"}catch(o){return void p("PUG Syntax error: "+o.msg)}else if(i||"html"==g)try{a=i?s.render(e,{}):e}catch(o){return void p("PUG Syntax error: "+o.msg)}else await h("html"),a=e,r.setPosition(n),g="html";var o,i={name:"Bibo",code:a,original_code:e},a=(c.$item.data("crsa-factory-def",i),createPgElFromDefinitionMultiple(i,!1,!1));a?(o=null,(o=!(o=a.text_nodes?"Inserting text outside of tags is not supported. Use inline editing or edit code.":o)&&a.syntax_errors?"Syntax error. Maybe tags or attributes are not closed?":o)?p(o):(i.name=a.pgel.getName({max_text_len:10}),a.rest.length&&(i.name+=" + "+a.rest.length),d.html(i.name),p(null),0==t.length&&(c.$item.tooltip("show"),setTimeout(function(){c.$item.tooltip("hide")},2e3)))):r.getModel().getLineContent(n.lineNumber).match(/\w+(>|{)/is)||p("Syntax error")}};function u(){var e=c.$editor.get(0).ownerDocument.defaultView;r=monacoInstance.openEditor(null,null,e,c.$element.children(),!0),pinegrow.code_editors.register(r),r.updateOptions({wordWrap:"on"}),r.onDidChangeModelContent(async function(){await a(r.getValue({preserveBOM:!0}))}),r.onDidFocusEditorText(function(){pgEditorAttributeIntellisense.focusedUrl=pinegrow.getSelectedPage().url}),h("pug")}var m=null,h=function(e){if(e!==m){var t=null;switch(e){case"jade":case"pug":t=monaco.editor.createModel(r.getValue(),"pug");break;default:t=monaco.editor.createModel(r.getValue(),"html")}m=e,t&&r.setModel(t)}};u(),this.destroy=function(){pinegrow.code_editors.unregister(r),r.dispose(),r=null,this.$element.remove()},t.onBeforeMovedToAnotherWindow=function(){pinegrow.code_editors.unregister(r),r.dispose(),r=null,c.$element.find(".pg-code-insert-editor").empty()},t.onMovedToAnotherWindow=function(e){null===r&&u(),r.layout()},this.resized=function(){r&&r.getModel()||(r&&r.dispose(),u()),r&&r.layout()}},pgQuickInsertLastFilter=null,PgQuickInsert=function(e,t,n,i){function o(){var e;r&&(e=pinegrow.selectedElements.getLastSelected())&&a.setInsertInfo(e)}var a=new PgLibraryView(n=void 0===n?!0:n,!0),r=pinegrow.selectedElements.isSelectedElement(e),s=(a.setInsertInfo(e,t),a.showPreviews=!0,a.onInsertPositionChanged=function(e){var t;switch(e){case"append":t="Append to";break;case"prepend":t="Prepend to";break;case"insertBefore":t="Insert before";break;case"insertAfter":t="Insert after"}var n=a.getInsertPgel();n&&(t+=" "+n.getName({short:!0})),s.setTitle(t)},new PgQuickWindow("Quick insert",a,"quickInsert",570,360));a.onInsertPositionChanged(t),s.noRightEdge(),n||s.$element.addClass("pg-quick-insert-no-selected"),i?s.showFor$El(i,!1,80):s.showForPgel(e),a.show(),pgQuickInsertLastFilter&&a.setFilter(pgQuickInsertLastFilter),a.focusSearch();pinegrow.addEventHandler("on_selected_elements_changed",o),s.onDestroy=function(){pgQuickInsertLastFilter=a.getFilter(),pinegrow.removeEventHandler("on_selected_elements_changed",o)},this.getWindow=function(){return s},this.getLib=function(){return a}},PgLibraryLastUsed=function(){function o(){pinegrow.dispatchEvent("on_lib_last_used_changed",null,this)}var a=[],e=this;this.add=function(e){for(var t=-1,n=0;n<a.length;n++)if(a[n]===e||a[n].code===e.code){t=n;break}0<=t&&a.splice(t,1),a.unshift(e);var i=10;a.length>i&&a.splice(i,a.length-i),o()},this.clear=function(){a=[],o()},this.getList=function(){return a},pinegrow.addEventHandler("on_project_or_all_pages_closed",function(){e.clear()})},pgInsertLibMenuCurrentPosition="insertAfter",PgContextMenuHelpers=function(n,i){var o=null;this.getPlacementIcons=function(){var e=!n||n.canHaveChildren(),t=`<span class="pg-lib-menu-place-icons">`;return n.canHaveSiblings()&&(t+=`<i data-pos="insertBefore" class="icon icon-Ins_before ${"insertBefore"===i?"active":""}" title="Insert before"><span class="path1"></span><span class="path2"></span></i><i data-pos="insertAfter" class="icon icon-Ins_after ${"insertAfter"===i?"active":""}" title="Insert after"><span class="path1"></span><span class="path2"></span></i>`),e&&(t+=`<i data-pos="prepend" class="icon icon-Append ${"prepend"===i?"active":""}" title="Insert inside on the top"><span class="path1"></span><span class="path2"></span></i><i data-pos="append" class="icon icon-Prepend ${"append"===i?"active":""}" title="Insert inside at the end"><span class="path1"></span><span class="path2"></span></i>`),o=t+=`</span>`},this.getPlacementFromEvent=function(e){return $(e.target).closest("[data-pos]").attr("data-pos")},this.getMenuItemWithPlacement=function(e){return{label:'<span class="name">'+e+"</span>"+(o=o||this.getPlacementIcons()),class:"pg-lib-menu-item",label_plain_text:e}},this.getMenuItemWithoutPlacement=function(e){return{label:'<span class="name">'+e+"</span>",class:"pg-lib-menu-item"}},this.getMenuFixedSizeClass=function(e){return"pg-menu-fixed-size-"+(e=e||"md")},this.addInsertActions=function(e,t){var n=crsaFuncs.findActionMenuForInsertingDefIntoEl(t,pinegrow.selectedElements.getLastSelected()),i=pinegrow.selectedElements.getName();e.add("",null,null,"divider"),e.add("Insert",null,null,"header"),e.add("Prepend to <b>"+i+"</b>"+pinegrow.repeater.showLiveRepeatCount(),null,function(){crsaFuncs.insertThroughActionMenu(n,null,t,!1,!0)}),e.add("Append to <b>"+i+"</b>"+pinegrow.repeater.showLiveRepeatCount(),null,function(){crsaFuncs.insertThroughActionMenu(n,null,t,!1,!1)}),e.add("Insert before <b>"+i+"</b>"+pinegrow.repeater.showLiveRepeatCount(),null,function(){crsaFuncs.insertBeforeOrAfter(null,t,!1,!1)}),e.add("Insert after <b>"+i+"</b>"+pinegrow.repeater.showLiveRepeatCount(),null,function(){crsaFuncs.insertBeforeOrAfter(null,t,!1,!0)}),e.add("Replace <b>"+i+"</b>"+pinegrow.repeater.showLiveRepeatCount(),null,function(){crsaFuncs.replaceElement(null,t)})}},PgInsertLibElementMenu=function(r,i,e,a,s){void 0===i&&(i=r);function l(e){function n(e){crsaFuncs.showInsertionLine(p,y($(e.target).closest("[data-pos]").attr("data-pos")))}function i(e){crsaFuncs.showInsertionLine(p,y(f))}e.on_mouseenter=function(e,t){h&&_(this.def,e),v.cancel("cancelTransparent"),crsaFuncs.showInsertionLine(p,y(f)),pgMakeParentContextMenusTransparent(!0),e.on("mouseenter","[data-pos]",n),e.on("mouseleave","[data-pos]",i)},e.on_mouseleave=function(e){h&&(pgPreview.hide(),v.cancel("showPreview")),crsaFuncs.showInsertionLine(null),e.off("mouseenter","[data-pos]",n),e.off("mouseleave","[data-pos]",i),v.run("cancelTransparent",function(){pgMakeParentContextMenusTransparent(!1)},500)}}var o,n,c=r.getPage(),t=c.getMainType(null,r),p=r.get$DOMElement(),d=[],g=c.getLibSections(),u=null,m=!1,h="1"===pinegrow.getSetting("lib-insert-menu-show-previews","0"),f=a||pgInsertLibMenuCurrentPosition,b=r.canHaveChildren(),w=(!b&&0<=["prepend","append"].indexOf(f)&&(f="insertAfter"),!r.canHaveSiblings()&&0<=["insertAfter","insertBefore"].indexOf(f)&&(f=b?"append":null),new PgContextMenuHelpers(r,f)),v=new PgDelayedTasks,_=function(t,n){v.run("showPreview",function(){var e=crsaFuncs.createPreviewElementFromDefinition(t);e&&t.framework&&!t.preview_image&&t.framework.on_lib_show_preview&&t.framework.on_lib_show_preview(null,t,e,pgPreview),n.get(0).ownerDocument===document&&pgPreview.show(n,e,t.preview_image?"with-image":null,removeCrsaClassesFromHtml(getCodeFromDefinition(t)))},300)},y=function(e){switch(e){case"insertBefore":return"top";case"insertAfter":return"bottom";case"prepend":return"inside-top";case"append":return"inside-bottom"}},k=function(e,t){var n,i,o=this.def,a=w.getPlacementFromEvent(t);a&&(pgInsertLibMenuCurrentPosition=f=a),f?(a=new PgApi,(n=createPgElFromDefinitionMultiple(o))&&(i=pinegrow.getCollectionForElement(r),a.insertElements(n.collection,i,f,{highlight:!0,scroll:!0,repeater:!0,format_html:!0,insert_operation:"menu_insert"}),pgLibraryLastUsed.add(o),pinegrow.showQuickMessage(o.name+" inserted."))):pinegrow.showQuickError(`Can't insert the element here.`)},P=(w.getPlacementIcons(),d.unshift({label:`Insert into ${t.name}:`,type:"header"}),t.action_menu&&t.action_menu.add&&(o={},t.action_menu.on_add&&(o.on_add=t.action_menu.on_add),$.each(t.action_menu.add,function(e,t){var n=c.getTypeDefinition(t);n&&d.push({label:n.name+pinegrow.repeater.showLiveRepeatCount(),label_plain_text:n.name,action:function(){crsaFuncs.insertThroughActionMenu(o,i,n,!1)}})})),r.canHaveChildren()&&d.push({label:"Lorem Ipsum text",action:function(){var e=pinegrow.getCollection(i);e.forEachElement(function(e,t,n){var i,o=e.getPage(),a=o.getMainType(null,e);canMakeChange(e,"edit_content")&&(willMakeChange(o,"Insert Lorem Ipsum to / "+e),o="Lorem ipsum dolor sit amet, consectetur adipiscing elit. Phasellus pulvinar faucibus neque, nec rhoncus nunc ultrices sit amet. Curabitur ac sagittis neque, vel egestas est. Aenean elementum, erat at aliquet hendrerit, elit nisl posuere tortor, id suscipit diam dui sed nisi. Morbi sollicitudin massa vel tortor consequat, eget semper nisl fringilla. Maecenas at hendrerit odio. Sed in mi eu quam suscipit bibendum quis at orci. Pellentesque fermentum nisl purus, et iaculis lectus pharetra sit amet.",i=e.html(),0<=["h1","h2","h3","h4","h5","h6","a","button","li","dd","dt"].indexOf(e.tagName)&&(o="Lorem ipsum dolor sit amet"),(a=createElementFromDefinition(a))&&a.html()==i||0<i.length&&(o=" "+o),e.append(pgCreateNodeFromHtml(o)))}),pinegrow.changeManager.didChange(e,"Add Lorem Ipsum")}}),pgLibraryLastUsed.getList().length&&(n=[],d.push({type:"divider"}),d.push({label:"Recently used",submenu:n,submenu_class:"pg-lib-menu-items"}),pgLibraryLastUsed.getList().forEach(function(e){var t=w.getMenuItemWithPlacement(e.name);t.def=e,t.action=k,l(t),n.push(t)}),n.unshift({type:"header",label:`Click to insert:`})),[]);$.each(g,function(e,t){u!==t.framework&&(m=!0,u=t.framework);var i=[],n={label:t.name,submenu:i,submenu_class:"pg-lib-menu-items"},o=f.startsWith("insert")?r.parent:r;$.each(t.getComponentTypes(),function(e,t){var n=a?w.getMenuItemWithoutPlacement(t.name):w.getMenuItemWithPlacement(t.name);n.def=t,n.action=k,l(n),i.push(n),s&&t.on_can_insert_into&&t.on_can_insert_into(o,t)&&((n=a?w.getMenuItemWithoutPlacement(t.name):w.getMenuItemWithPlacement(t.name)).def=t,n.action=k,l(n),P.push(n))}),i.length&&(i.unshift({type:"header",label:`Click to insert:`}),m&&(d.push({type:"divider"}),d.push({type:"header",label:u.name}),m=!1),d.push(n))}),P.length&&(P.push({type:"divider"}),P.push({label:"More",submenu:d}),d=P),a&&d.unshift({type:"header",label:function(){switch(f){case"insertBefore":return"insert before";case"insertAfter":return"insert after";case"prepend":return"prepend";case"append":return"append"}}()+" "+r.getName({short:!0})}),d.push({type:"divider"}),d.push({type:"header",label:"Options"}),d.push({label:"Show previews",check:h,action:function(){h=!h,pinegrow.setSetting("lib-insert-menu-show-previews",h?"1":"0")}}),e||d.push({type:"html",html:`<p class="pg-menu-hint">Use ${pgShowKbdCombo("SHIFT+Right-click")} to<br>open this menu directly.</p>`}),this.getActions=function(){return d}},PgPlacementOptionsMenu=function(n,i,o,e){o=o||"insertAfter";var a=e.canHaveChildren(),t=[],r=(t.push({type:"header",label:`Choose position:`}),[]);[{pos:"insertBefore",name:"Before"},{pos:"prepend",name:"Prepend",fertile:!0},{pos:"append",name:"Append",fertile:!0},{pos:"insertAfter",name:"After"}].forEach(function(e){var t;e.fertile&&e.fertile!==a||(t={action:function(){n.call(this,e.pos)},label:e.name,class:`pg-lib-menu-place-button pg-lib-menu-place-${e.pos} `+(e.pos===o?"active":"")},i&&i(t),r.push(t))}),t.push({buttons:r,html:`<div class="pg-lib-menu-place"><div class="pg-lib-menu-place-dest">${e.getName({short:!0})}</div></div>`}),this.getActions=function(){return t}},PgSelectMenu=function(e,t){function n(){pinegrow.selectElement(this.pgel),this.pgel.scrollTo()}function i(){pinegrow.highlightElement(this.pgel.get$DOMElement())}function o(){pinegrow.highlightElement(null)}var a,r=[],s=e;if(!t){for(;s.parent&&s.parent.isElement;)s=s.parent,r.push({label:s.getName({short:!0}),label_plain_text:s.tagName,pgel:s,action:n,on_mouseleave:o,on_mouseenter:i});r.length&&r.unshift({type:"header",label:"Parents"})}var l=[];e.getChildren().forEach(function(e){var t={label:e.getName({short:!0}),pgel:e,action:n,on_mouseleave:o,on_mouseenter:i};l.length<100&&(l.push(t),e.getChildren().length)&&(t.submenu=function(){return new PgSelectMenu(e,!0).getActions()})}),l.length&&(l.unshift({type:"header",label:"Children"}),r.length)&&l.unshift({type:"divider"}),a=r.concat(l),this.getActions=function(){return a}};$("body").one("pinegrow-ready",function(e,i){pgf.kids||i.addEventHandler("on_key_pressed",function(e,t,n){"+"!==t.key||n.input||n.edit||n.ctrl||(n.done=!0,pgf.insert_in_top_menu?showTopMenuInsertLibrary(!0):i.showQuickInsert())})});