var editor_y=100,PgInternalCodeEditor=function(e,i,t,n,o,r){this.id=e,this.url=i;var a=null,s=null,l=this,d=(this.page=null,null),c="1"===pinegrow.getSetting("edit-page-html-wrap","1"),u="1"===pinegrow.getSetting("edit-page-html-lint","1"),g=$('<div class="pg-page-code-editor"></div>'),p=(this.isFocued=function(){return $(document.activeElement).closest(".pg-page-code-editor").is(g)},this.appendTo=function(e){g=e,d?.css("height",""),a.render(!0),a.layout()},this.resize=function(){d?.get(0)?.ownerDocument&&a.layout()},this.setWrap=function(e){c=e,pinegrow.setSetting("edit-page-html-wrap",c?"1":"0"),a&&(a.updateOptions({wordWrap:e?"on":"off"}),a.layout())},this.setAutocomplete=function(e){a&&(a.updateOptions({quickSuggestions:e}),a.layout())},!1),a=(this.setReadOnly=function(e){p=e,a&&a.updateOptions({readOnly:p})},this.search=function(e){a._pgSearchQuery=e;var t=a.getModel(),n=t.getEOL();let o=e.split(n),i=t.findMatches(o[0]);n=t.findMatches(o[o.length-1]);0!==e.length&&Array.from(n).find((e,t)=>{e.range.endLineNumber==i[0].range.startLineNumber+o.length-1&&(a.setSelection({startColumn:i[0].range.startColumn,startLineNumber:i[0].range.startLineNumber,endColumn:e.range.endColumn,endLineNumber:e.range.endLineNumber}),a.revealLineInCenter(i[0].range.startLineNumber))})},this.focus=function(){a.focus()},this.setLint=function(e){u=e,a.pgCheckForErrors=u},monacoInstance.openEditor(i,e,o,null,r)),h=(this.setWrap(c),this.setAutocomplete("1"===pinegrow.getSetting("code-autocomplete","1")),a.pgCheckForErrors=u,p&&a.updateOptions({readOnly:p}),pinegrow.code_editors.register(a),null);let m,w;function f(){var n,e=a.getModel(),t=(new CrsaProfile,m??w);t&&(n=e.getOffsetAt(t),T(function(e){var t=e.findNodeAtSourceIndex(n);t&&(h=t.getPath(),l.onElementSelectedInEditor(l,h))}),w=m=null)}switch(a.getModel().getLanguageId()){case"html":case"php":monacoInstance.actions["domSelector"]="pinegrow.editor.selectDom",a.addAction({id:monacoInstance.actions.domSelector,label:"Select on the page",keybindings:[monaco.KeyMod.Alt|monaco.KeyCode.KEY_S],precondition:null,keybindingContext:null,contextMenuGroupId:"navi",contextMenuOrder:100,run:e=>{f()}}),monacoInstance.actions["browserPreview"]="pinegrow.editor.action.browserPreviewer",a.addAction({id:monacoInstance.actions.browserPreview,label:"Preview In Browser",keybindings:[monaco.KeyMod.CtrlCmd|monaco.KeyCode.KEY_B],precondition:null,keybindingContext:null,contextMenuGroupId:"navi",contextMenuOrder:98,run:e=>{l.page.openInBrowser()}})}a.onMouseDown(e=>{m=e.target.position,e.event.altKey&&e.event.leftButton&&f()}),a.onDidChangeCursorPosition(e=>{L(),3===e.reason&&(I=a.getPosition())});function v(){var e=(new Date).getTime(),t=pinegrow.getCrsaPageByUrl(i),n=a.getModel(),n=(s=n.getValue(),b=A=null,a.getPosition()),o=(l.onChange&&(o={cursorPosition:I,cursorPositionAfter:n},l.onChange(l,o)),I=n,S&&(clearTimeout(S),S=null),t?.applyChangesToSource(s,!0,!1,!1,"editor")),n=(o?.errors?.length?(S=setTimeout(function(){pinegrow.showQuickMessage("The document has syntax errors.",3e3,!0),S=null},3e3),l.setErrors(o.errors)):l.setErrors(null),(new Date).getTime()-e);E=n<E?Math.max(n,300):Math.min(n,1e3)}function y(e){var t=myLayout.root.getItemsByFilter(function(e){if(e.config.pages)return!0})[0];e?t.header.element.addClass("code-editor-active"):t.header.element.removeClass("code-editor-active")}var C=0,b=null,E=500,S=null,I=(a.onDidChangeModelContent(e=>{0<C?C--:(b&&(clearTimeout(b),b=null),b=setTimeout(function(){v()},E))}),null);this.tabWasActivated=function(){pinegrow.lastActivePage.setPage(l.page,function(){l.page&&l.view.tab.tab.element.removeClass("active-editor"),y(!1)}),l.view.tab.tab.element.parent().find(".active-editor").removeClass("active-editor"),l.view.tab.tab.element.addClass("active-editor"),y(!0)},a.onDidFocusEditorText(()=>{l.tabWasActivated(),pgEditorAttributeIntellisense.focusedUrl=i}),a.onKeyDown(e=>{p&&pinegrow.showQuickError("The stylesheet is locked.",!0)}),this.dispose=function(){a.dispose()},this.destroy=function(){b&&(clearTimeout(b),b=null,v()),k&&(clearTimeout(k),k=!1),this.page=null,pinegrow.code_editors.unregister(a),g.remove(),this.dispose()};let P=!1;this.setCode=function(n,o,e){this.view.view.whenVisible(async function(){a.getModel();var e,t=a.hasWidgetFocus();null!==(s=n)&&s.length&&C++,A=null,o&&o.undoData&&o.undoOrRedo&&("undo"===o.undoOrRedo?o.undoData.cursorPosition&&(e=o.undoData.cursorPosition):o.undoData.cursorPositionAfter&&(e=o.undoData.cursorPositionAfter),l.setErrors(null)),e=e||a.getPosition(),a.setValue(s),t&&a.focus(),e&&a.setPosition(e),I=e,n.match(/<\?php/gim)&&!P&&(a.setModel(monaco.editor.createModel(a.getValue(),"php")),await pgEditorAttributeIntellisense.setHtmlCompletion(i,null,"php"),P=!0)},"setCode")},this.getCode=function(){return s},this.getDoc=function(){return a.getValue()},this.elementWasSelectedInPreview=function(n){T(function(e){var t=e.getNodeFromPath(n);t&&_(t,h!=n)})},this.onChange=null,this.onElementSelectedInEditor=null;var A=null,T=function(e){var t;A?e(A):((t=new pgParser).assignIds=!1,t.parse(s,function(){A=t.rootNode,e(A)}))},_=function(e,t){var n=e.getPositionInSource(),o=a.getModel(),i=o.getPositionAt(n.start),o=o.getPositionAt(n.end),n={startColumn:i.column,startLineNumber:i.lineNumber,endColumn:o.column,endLineNumber:o.lineNumber};a.revealRangeInCenter(n),a.setSelection(n)},M=(this.highlightRange=function(e){e instanceof monaco.Range||(e=new monaco.Range(e.start.line,e.start.ch,e.end.line,e.end.ch)),a.revealRangeInCenter(e),a.setSelection(e)},null),k=null,x=null,L=(this.forceApplyChanges=function(){x&&pinegrow.showAlert("<p>Are you sure you want to apply code with syntax error to the page?</p><p>This can cause serious problems. Only proceed if you are sure you know what you are doing.</p>","Are you sure?","Cancel","Proceed",null,function(){var e=a.getValue();l.page.setCode(e,{action:"Apply page code"}),l.page.refresh(),l.setErrors(null)})},this.setErrors=async function(e){((x=e)||M)&&(M||((M=new PgCodePanelNotice).hideOnEmpty=!0,M.get$Element().appendTo(g.parent()),M.get$Element().on("click","button.apply-changes",function(e){e.preventDefault(),l.forceApplyChanges()})),k&&(clearTimeout(k),k=!1),e&&e.length?k=setTimeout(function(){L('The code has syntax errors. Changes have not been applied to the page. <button class="pg-button apply-changes">Apply changes</button>'),k=null},750):M.setMessage(""))},function(e){var t;M&&(e=void 0===e?M.getMessage():e)&&(a.getScrollLeft(),t=a.getScrollTop(),t=a.getContentHeight()-2*t<60,M.setMessage(e,t))});pgEditorAttributeIntellisense.setHtmlCompletion(i,null,a.getModel().getLanguageId())},PgInternalCodeEditorView=function(n,i,e){var o=this,r=null,t=$('<div class="pg-page-code"></div>'),a=new PgUIView(t,null,"Edit code"),s=(this.view=a,"1"===pinegrow.getSetting("edit-page-html-wrap","1")),l=new PgSearchBox({placeholder:"search",placeholder_active:null,toolbar_on:!0}),d=l.getToolbar().addSection("settings").$element,c=new PgCheckbox(d,"Wrap","1"),u=(c.show(),c.get$input().on("change",function(e){r.setWrap(c.getValue())}),c.setValue(s?"1":"0"),l.onSearch=function(e){r.search(e)},new PgSearchBoxSpacer,$('<div class="pg-page-code-content"></div>').appendTo(t));this.search=function(e){r.search(e)},this.getEditor=function(){return r},this.setWrap=function(e){r.setWrap(e)},this.setAutocomplete=function(e){r.setAutocomplete(e)},this.setLint=function(e){r.setLint(e)},this.setReadOnly=function(e){r.setReadOnly(e)},this.show=function(e){var t=!pinegrow.isFileEditable(e.url)&&!crsaIsRemoteUrl(e.url)&&!e.url.endsWith(".php"),n=$('<div class="pg-page-code-editor"></div>').appendTo(u),o=!1;e.openedInEditor||pinegrow.stylesheets.getByUrl(e.url,!0)||(o=!0),(r=pinegrow.codeEditors.open(e.url,e.getSource(),null,t,u.get(0).ownerDocument.defaultView,o,this)).page=e,r.appendTo(n),r.setReadOnly(i),r.focus()};a.onResize=function(){r&&r.resize()},a.onDestroy=function(){pinegrow.codeEditors.closeEditor(r),r.destroy(),o.tab.pgEditorView=null,o.tab=null,n.codeEditor=null,n.onlyCode&&n.close(),pgPageCodeEditorsStack.unregisterEditor(o),pgPageCodeEditorsStack.hideIfNoEditors()},a.onBeforeMovedToAnotherWindow=function(e,t){r&&(monacoInstance.editorsArr.push(n.url),pgEditorAttributeIntellisense.Context[n.url]?.htmlIntellisense.dispose(),r.destroy(),o.closeTab(),r=null)},this.getPage=function(){return n},this.getUrl=function(){return r.url},this.setModified=function(e){e?this.tab.tab.element.addClass("pg-modified"):this.tab.tab.element.removeClass("pg-modified")},pgPageCodeEditorsStack.addTab(this),this.show(n),pgPageCodeEditorsStack.registerEditor(this),this.closeTab=function(){pgPageCodeEditorsStack.closeTab(this)},this.updateTitle=function(){this.tab.tab.element.find(".lm_title").text(n.getName())},this.pageWasRenamed=function(){r.url=n.url,this.updateTitle()}},PgPageCodeEditorsStack=function(){function n(){try{return t=t||myLayout.root.getItemsByFilter(function(e){if(e.config.codeEditors)return!0})[0]}catch(e){}return null}var t=null,i=this,o=(this.auto=!0,this.getStack=n,this.setStack=function(e){t=e,this.isShown?this.show():this.hide(),n(),r&&t.header.element.append(r.$element)},this.beforeDestroy=function(){r&&r.$element.detach()},this.isShown=!1,this.showEditor=function(e){this.show(),e.nextContentItemChangedIsNotInteractive=!0,n().setActiveContentItem(e.tab)},this.isEditorShown=function(e){return this.isShown&&(!e||n().getActiveContentItem().pgEditorView==e)},this.show=function(){var e=n(),e=(e.config.isHidden=!0,e.showStack(),this.isShown=!0,pinegrow.editCodeButton.setActive(!0),pgGetAppWindowForDOMElement(e.element.get(0)));e.window!==window&&(e.show(),pgUpdateAppWindowTitle(e))},this.hide=function(){var e=n(),t=(e.hideStack(),this.isShown=!1,pinegrow.editCodeButton&&pinegrow.editCodeButton.setActive(!1),pgGetAppWindowForDOMElement(e.element.get(0)));t.window!==window&&1===e.element.closest("body").find(".lm_stack").length&&t.hide(),myLayout.root.getItemsByFilter(function(e){if(e.config.pages)return!0})[0].header.element.removeClass("code-editor-active")},this.addTab=function(e){var t=myLayout._$normalizeContentItem({title:e.getPage().name,type:"component",componentName:"code_editor",componentState:{}});return t.pgEditorView=e,n().addChild(t),t.tab.element.addClass("file-name-tab"),$("<modified>*</modified>").insertAfter(t.tab.element.find(".lm_title")),$('<div class="pg-selected-page-line"></div>').insertAfter(t.tab.element.find(".lm_title")),t.container.getElement().append(e.view.get$Element()),e.view.addedToLayout(t.container),this.show(),e.tab=t},this.closeTab=function(e){var t=n();e.tab.remove(),0==t.contentItems.length&&this.hide()},[]),r=(this.registerEditor=function(e){o.push(e)},this.unregisterEditor=function(e){var t=o.indexOf(e);0<=t&&o.splice(t,1)},this.hideIfNoEditors=function(){0==o.length&&this.hide()},null),a=null;this.getCurrentEditor=function(){return a},$("body").one("pinegrow-ready",function(){pinegrow.addEventHandler("on_panel_open_in_floating_window",function(e,t,n,o){n&&1===n.contentItems.length&&n.contentItems[0].config.codeEditors&&(o.show=i.isShown)})}),$("body").one("pinegrow-layout-ready",function(){var e,t;pgf.edit_page_code&&(pinegrow.addEventHandler("on_page_selected",function(e){i.auto&&i.isShown&&e&&(e.codeEditor?i.isEditorShown(e.codeEditor)||i.showEditor(e.codeEditor):e.codeEditor=new PgInternalCodeEditorView(e))}),i.auto="1"===pinegrow.getSetting("edit-page-code-auto","1"),i.wrap="1"===pinegrow.getSetting("edit-page-html-wrap","1"),i.lint="1"===pinegrow.getSetting("edit-page-html-lint","1"),i.highlight_css_rule="1"===pinegrow.getSetting("edit-page-css-rule","1"),i.autocomplete="1"===pinegrow.getSetting("code-autocomplete","1"),(e=n())?(e.on("activeContentItemChanged",function(e){var t;e?(a=e.pgEditorView).nextContentItemChangedIsNotInteractive?a.nextContentItemChangedIsNotInteractive=!1:(t=a.getEditor())&&t.tabWasActivated():a=null}),e.on("activeContentItemClicked",function(e){var t;e&&(t=(a=e.pgEditorView).getEditor())&&t.tabWasActivated()}),(r=new PgButtonToolbar).addSection("icons"),t=new PgButtonToolbarItem("icon-down","Code editor options"),r.addItem("icons",t),t.onClick=function(){var e=[{type:"header",label:"General options"},{label:"Wrap lines",check:function(){return i.wrap},action:function(){i.wrap=!i.wrap,o.forEach(function(e){e.setWrap(i.wrap)}),pinegrow.showMode("Wrap lines",i.wrap)}},{label:"Show autocomplete",action:function(){i.autocomplete=!i.autocomplete,o.forEach(function(e){e.setAutocomplete(i.autocomplete)}),pinegrow.setSetting("code-autocomplete",i.autocomplete?"1":"0"),pinegrow.showMode("Autocomplete",i.autocomplete)},check:i.autocomplete},{type:"divider"},{type:"header",label:"HTML pages"},{label:"Show code for the selected page",check:function(){return i.auto},action:function(){i.auto=!i.auto,pinegrow.setSetting("edit-page-code-auto",i.auto?"1":"0"),pinegrow.showMode("Show code for selected page",i.auto)}},{label:"Display HTML errors and warnings",check:function(){return i.lint},action:function(){i.lint=!i.lint,o.forEach(function(e){e.setLint(i.lint)}),pinegrow.setSetting("edit-page-html-lint",i.lint?"1":"0"),pinegrow.showMode("Display HTML errors and warnings",i.lint)}},{type:"divider"},{type:"header",label:"CSS stylesheets"},{label:'Search for the selected CSS rule<br><span style="opacity:0.7;font-size:11px;">(if the stylesheet is open in the code editor)</span><br><span style="opacity:0.7;font-size:11px;">Use '+pgShowKbdCombo("CMD+G")+" to move between search hits.</span>",check:function(){return i.highlight_css_rule},action:function(){i.highlight_css_rule=!i.highlight_css_rule,pinegrow.setSetting("edit-page-css-rule",i.highlight_css_rule?"1":"0"),pinegrow.showMode("Search for the selected CSS rule",i.highlight_css_rule)}}];return new CrsaContextMenu(e,this.$element).showForElement(this.$element),!1},e.header.element.append(r.$element),i.hide()):(pinegrow.showAlert("<p>Please restart Pinegrow. The workspace will be restored to the default layout.</p>","Ups... There is a problem with the workspace"),delete localStorage["pg_layout_state"+pgf.layout_prefix],pinegrow.saveSettingsOnBackend()&&pinegrow.setSetting("pg_layout_state"+pgf.layout_prefix,"")))})},pgPageCodeEditorsStack=new PgPageCodeEditorsStack;