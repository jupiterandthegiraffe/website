var PgQuickCodeEdit=function(e,t){var n={winId:"quickCodeEdit",pin:pgf.edit_html,focus:!0,title:!1,copy:!0,$target:null},i=(t=$.extend(n,t||{}),this.editors=new PgCodeEditorsView(t)),o=(i.handleSelected=!1,!t.title&&e&&(t.title=e.getName({short:!0})+(` | `+(pgf.edit_html?"Edit code":"View code"))),i.quickWin=!0,this.win=new PgQuickWindow(t.title,i,t.winId,570,260,null,!0));i.quickWin=o,t.pin&&o.addIconToHeader("icon-Pin","Pin to CODE panel",function(){var e=pinegrow.codeEditorsView.getEditorForPgel(i.getEditor(0).getAllNodes()[0]);e?(pinegrow.showQuickMessage("Code of this element is already edited in the Code panel.",4e3),pinegrow.showTab("element_code_panel"),e.view.setPinned(!0),e.view.flash(),o.destroy()):(pinegrow.showTab("element_code_panel"),pinegrow.codeEditorsView.editCode(i.getEditor(0).getAllNodes()),o.destroy(),pinegrow.showQuickMessage("Pinned to CODE panel."))}),t.$target?o.showFor$El(t.$target):e?o.showForPgel(e):o.showAtPosition(300,300),i.editCode(e),t.focus&&i.focus(),this.setCustomCode=function(e){i.setCustomCode(e||"")},o.onDestroy=function(){}},PgCodeEditorsView=function(o){var e={key:"element-code",jade:isApp(),lint:!0,editable:pgf.edit_html,copy:!1,handleSelect:!0,custom:!1,mode:"application/x-httpd-php",view_name:"element_code"},t=(o=$.extend(e,o||{}),$('<div class="pg-element-code-editors"></div>')),l=new PgUIView(t,e.view_name,"Element code"),s=(this.view=l,this.quickWin=!1,l.tabIcon="icon-KODA",this.handleSelected=o.handleSelect,this),d=[],r=o.jade&&"1"===pinegrow.getSetting(o.key+"-jade","0"),a="1"===pinegrow.getSetting(o.key+"-html","1"),c=o.lint&&"1"===pinegrow.getSetting(o.key+"-html-lint","1"),e=new PgSearchBox({placeholder:"search",placeholder_active:null,toolbar_on:!0}),n=this.toolbar=e.getToolbar(),i=(n.addSection("settings").$element,o.jade&&(i=new PgButtonToolbarItem("icon-270","Use simplified (Pug, ex-Jade) syntax."),n.addItem("settings",i),i.onClick=function(){r=!this.getActive(),this.setActive(r),r=r,pinegrow.setSetting(o.key+"-jade",r?"1":"0"),d.forEach(function(e){e.view.setUseJade(r)}),pinegrow.showMode("Use simplified Pug syntax",r)},i.setActive(r)),new PgButtonToolbarItem("icon-266","Wrap lines."));n.addItem("settings",i),i.onClick=function(){var e=!this.getActive();this.setActive(e),a=e,pinegrow.setSetting(o.key+"-html",a?"1":"0"),d.forEach(function(e){e.view.setWrap(a)}),pinegrow.showMode("Wrap lines",e)},i.setActive(a),o.lint&&(i=new PgButtonToolbarItem("icon-269","Display HTML errors and warnings (in HTML mode only)."),n.addItem("settings",i),i.onClick=function(){c=!this.getActive(),this.setActive(c),c=c,pinegrow.setSetting(o.key+"-html-lint",c?"1":"0"),d.forEach(function(e){e.view.setLint(c)}),pinegrow.showQuickMessage("Display HTML errors and warnings: "+(c?"ON":"OFF"))},i.setActive(c)),o.copy&&(n.addSection("tools"),i=new PgButtonToolbarItem("icon-273","Copy code to clipboard."),n.addItem("tools",i),i.onClick=function(){var e;d.length&&(e=d[0].view.getCode(),o.filter_copy&&(e=o.filter_copy(e)),copyCodeToClipboard(e,!0))}),e.$element.appendTo(t),e.onSearch=function(e){s.search(e)};function u(e,t,n){var i,o=pinegrow.selectedElements.getLastSelected();if(!(n&&n.source&&n.source instanceof PgCodeEditView))if(o){if(n&&n.undoSourceId)for(var r=0;r<d.length;r++)if(d[r].view.view.getId()==n.undoSourceId){if(d[r].view.handleUndoSelect(o,n))return;break}s.handleSelected&&l.whenVisible(function(){var e=v(o);e&&e.view.pinned?e.view.flash():(e=E())?e.view.show(o):w(o)})}else(i=E())&&s.closeEditor(i)}function g(e){for(var t=[],n=0;n<d.length;n++)e===d[n].view.getPage()&&t.push(d[n]);t.forEach(function(e){s.closeEditor(e)})}function h(e,t,n){if(t)for(var i,o,r=0;r<d.length;r++)d[r].view.invalid||n&&n.source&&n.source==d[r].view||n&&n.undoSourceId&&n.undoSourceId==d[r].view.view.getId()||(n&&n.source&&n.source instanceof PgCodeEditView&&n.removedIds?d[r].view.isTopId(n.removedIds)?d[r].view.invalidate():d[r].view.isIdInList(n.removedIds)&&d[r].view.updateEditor():d[r].view.checkIfEditedElementWasDeleted()?s.closeEditor(d[r]):(i=t.next(),o=t.prev(),(d[r].view.isPgElBeingEdited(t)||i&&d[r].view.isPgElBeingEdited(i)||o&&d[r].view.isPgElBeingEdited(o))&&d[r].view.updateEditor()))}(new PgSearchBoxSpacer).$element.appendTo(t),this.search=function(t){d.forEach(function(e){e.view.search(t)})};var p=new PgPanelNotice,f=(p.$element.appendTo(t),new PgUISectionGrid),w=(f.fit=!0,f.onGetNumberOfColumns=function(e,t,n,i){var o=500;return 2<e/o?i=Math.round(e/o):140<t/n&&(i=1),i=n<i&&0<n?n:i},t.append(f.$element),this.focus=function(){d.length&&d[0].view.focus()},this.editCode=function(t){l.whenVisible(function(){var e=v(t);e&&e.view.pinned?e.view.flash():w(t)})},this.setCustomCode=function(e){l.whenVisible(function(){d[0].view.setCustomCode(e)},"setCustomCode",1)},function(e){var t={pinnable:!0};if(t.section=new PgUISection("Editor",null,t),t.view=new PgCodeEditView(null,o,f.$element),t.view.section=t.section,t.section.appendTo(t.view.view.get$Element()),t.view.view.alwaysVisible=!0,t.view.view.updateVisibility(),t.view.setWrap(a),t.view.setUseJade(r),t.view.setLint(c),t.view.show(e),t.view.view.onResizeOriginal=t.view.view.onResize,t.view.view.onResize=null,addTooltip(t.section.$title.find(".icon-Pin").css("top",0),"Show this editor even if element is not selected."),t.section.onLayoutChanged=function(){t.view.view.onResizeOriginal()},t.section.onPin=function(e){t.view.setPinned(!0)},t.section.onClose=function(e){s.closeEditor(t)},t.view.pinned){for(var n=-1,i=0;i<d.length;i++)if(!d[i].view.pinned){n=i;break}0<=n?d.splice(n,0,t):d.push(t)}else d.push(t);m()}),m=(this.closeEditor=function(e){var t=d.indexOf(e);0<=t&&(d.splice(t,1),e.view.view.destroy(),m()),0==d.length&&this.quickWin&&this.quickWin.destroy()},this.getEditor=function(e){return d[e].view},function(){f.clear(),0==d.length?(p.show("Element is not selected."),f.$element.hide()):(p.show(),f.$element.show(),d.forEach(function(e){f.addSection(e.section)}),f.updateLayout())}),v=(m(),this.getEditorForPgel=function(e){if(e)for(var t=0;t<d.length;t++)if(d[t].view.isPgElBeingEdited(e))return d[t];return null}),E=function(){for(var e=0;e<d.length;e++)if(!d[e].view.pinned)return d[e];return null};l.onResize=function(){f.updateLayout()},l.onShow=function(){d.forEach(function(e){e.view.view.onShow()})},o.custom||(pinegrow.addEventHandler("on_selected_elements_changed",u),pinegrow.addEventHandler("on_page_changed",h),pinegrow.addEventHandler("on_page_closed",g)),l.onDestroy=function(){pinegrow.removeEventHandler("on_selected_elements_changed",u),pinegrow.removeEventHandler("on_page_changed",h),pinegrow.removeEventHandler("on_page_closed",g)}},PgCodeEditView=function(S,r,L){var y,_,e=$('<div class=""><div class="pg-element-code-editor"></div>'),n=e.find(".pg-element-code-editor"),o=(this.setPinned=function(e){(this.pinned=e)?this.section.$title.addClass("pinned"):this.section.$title.removeClass("pinned"),C()},new PgCodePanelNotice),I=(o.hideOnEmpty=!0,o.get$Element().appendTo(e),this.view=new PgUIView(e)),b=this,F=(this.pinned=!1,this.isSelected=!1,require("pug")),l=(r.key,null),T=!1,i=!1,s=!0,d=!0,a=null,V=S,k=1,c=!1,M=[],O=null,N=null,u=[],g=null,h=null,A=(this.getAllNodes=function(){return M},this.checkIfEditedElementWasDeleted=function(){return!(!M.length||!M[0].isDeleted)},function(){u=[],M.forEach(function(e){e.walkSelfAndChildren(function(e){var t=e.getId();return t&&u.push(t),!0})}),u.sort(),g=M[0].getPath(),h=1<M.length?M[M.length-1].getPath():null,O=M[0].getPage(),N=M[M.length-1].next()}),W=(this.isTopId=function(e){for(var t=0;t<M.length;t++){var n=M[t].getId();if(n&&0<=e.indexOf(n))return!0}return!1},this.isIdInList=function(e){for(var t=0,n=0;t<e.length&&n<u.length;){if(e[t]===u[n])return!0;e[t]<u[n]?t++:n++}return!1},I.onResize=function(){l&&(R?.get(0).ownerDocument&&_.layout(),l.CodeEditorVsc.layout())},I.onShow=function(){l&&l.CodeEditorVsc.layout()},I.onDestroy=function(){l&&(l.CodeEditorVsc.dispose(),l=null),pinegrow.code_editors.unregister(_),pinegrow.removeEventHandler("on_page_changed",t),m&&clearTimeout(m),p&&clearTimeout(p),H("")},I.onMovedToAnotherWindow=function(e){l&&(l.CodeEditorVsc.dispose(),l=null),b.show(V)},function(e,t){(t=t||{}).msg="This element can not be edited here.";var n=new pgParserSourceProblem(V);return e||n.add("element",e.getName(),"find"),!!n.ok()&&(canMakeChange(e,"edit_code",null,!0)?"body"!=e.tagName&&"head"!=e.tagName&&!e.find("body").length||(t.msg="Can not edit HEAD and BODY elements. Please use Page -> Edit code to edit the whole page.",!1):(t.msg="Can not edit this element because it is locked.",!1))}),p=(this.show=function(e){var t;r.custom?I.whenVisible(function(){l=l||z()}):(t={pgel:e},e.getPage().callFrameworkHandler("on_before_element_code",t),V=e=t.pgel,this.isSelected=pinegrow.selectedElements.isElementOrDescendantSelected(e),I.whenVisible(function(){l=l||z(),G(e)}))},this.setCustomCode=function(e){e.match(/<\?php/gim)&&_.setModel(monaco.editor.createModel(_.getValue(),"php")),l.CodeEditorVsc.setValue(e)},this.getCode=function(){return l.CodeEditorVsc.getValue()},this.isPgElBeingEdited=function(e){for(var t=0;t<M.length;t++)if(e==M[t])return!0;return!1},null),t=function(e,t,n){r.custom||n&&n.source&&n.source==b||b.invalid||t&&!b.isPgElBeingEdited(t)||(p&&clearTimeout(p),p=setTimeout(function(){Q(),original_source=P(),E(original_source,n),p=null},50))},f=(this.updateEditor=function(e){t(null,null,e)},this.handleUndoSelect=function(e,t){return this.invalidate(t),!0},pinegrow.addEventHandler("on_page_changed",t),null),H=function(e){f&&(clearTimeout(f),f=!1),e?f=setTimeout(function(){w(e),f=null},750):o.setMessage("")},w=function(e){var t,n,i;o&&(e=void 0===e?o.getMessage():e)&&(n=_.getPosition(),_.getScrollLeft(),t=_.getScrollTop(),i=_.$el.clientHeight,n=_.getTopForPosition(n.lineNumber,n.column),i=i-(n-=t)<60,o.setMessage(e,i))},U=function(){if(r.on_change&&r.on_change(l.CodeEditorVsc.getValue()),!r.custom)return B(l.CodeEditorVsc.getValue()),i},x=null,B=function(e,t){if(!T){e=$.trim(e);try{y&&(e=F.render(e,{}));for(var n=pgCreateNodeFromHtml(e,!1,!0),i=(pgCurrentRequestContext.setCurrentRequestContext(O.url,O.sourceNode),null),o=null,r=0,l=[],s=[],d=0;d<n.length;d++){i=n[d],o=o||i,i.isElementOrScript||0;var a=i.toStringOriginal(!0,pinegrow.getFormatHtmlOptions(),function(e,t,n){return pgCurrentRequestContext.createProxyUrlNodeOutputFilter(e,t,n)});if(0!==a.length){r++,l.push(i);var c="HTML syntax error (open tags, invalid nesting of elements...)";if(i.isElement&&!i.closed)throw"Tag "+i.tagName+" is not closed.";if(i.validateTree().length&&!t)throw c;var u=$(getIframeDocument(V.getPage().$iframe.get(0)).createElement("div")).append(a).contents();if(1!==u.length&&!t)throw c;u.get(0).nodeType,i.assignIdAndAddToCatalog(!0),s.push(i.toJade())}}var g=1<r||1<k,h=g?V.parent:o,p=(g?h:V).getId(),f=V.parent,w=f.html(null,!0),m=[],v=[],E=D(),C=(h.withoutEvents(function(){V.replaceWith(o,!0),v.push(V),V.remove(!1,m);for(var e=o.next(!0),t=1;t<k;t++)if(e){if(e===N)break;var n=e.next(!0);e.isElementOrScript&&v.push(e),e.remove(!1,m),e=n}for(var i=o,t=1;t<l.length;t++)l[t].insertAfter(i),i=l[t]}),pinegrow.undoManager.getHistoryForPage(O).ignore(function(){h.update(null,p)}),{cursorPosition:x}),P=new PgNodeEvent(f,"updateInner",null,{oldValue:w},O),S=new PgUndoEvent(P);return pinegrow.undoManager.getHistoryForPage(O).addEvent(S),b.pinned||pinegrow.undoManager.getHistoryForPage(O).setSelectedElementsAtStart(E.map(function(e){return e.getId()})),M=l,A(),V=o,k=n.length,H(""),b.pinned||pinegrow.undoManager.getHistoryForPage(O).setSelectedElementsAtEnd(D().map(function(e){return e.getId()})),v.forEach(function(e){pinegrow.selectedElements.remove(e,{source:b})}),q(),m.sort(),x=_.getPosition(),pinegrow.changeManager.didChange(V,"Edit code",{source:b,removedIds:m,undoCombineKey:"edit_code",undoSourceId:I.getId(),undoData:C}),last_good_source=e,!0}catch(e){e instanceof pgParserException?H("Only one element can be edited.","text-danger"):H(e.msg||e.toString(),"text-danger"),0}}return!1},m=null,D=function(){var e=[];if(M[0].isElementOrScript&&e.push(M[0]),c)for(var t=1;t<M.length;t++)M[t].isElementOrScript&&e.push(M[t]);return e},q=function(){m&&(clearTimeout(m),m=null),b.pinned&&!b.isSelected||(m=setTimeout(function(){var e=D();e.forEach(function(e){pinegrow.selectedElements.add(e,{source:b})}),pinegrow.selectedElements.triggerElementSelectedEvent(e[0],{source:b}),m=null},750))},R=(this.setWrap=function(e){d=e,_&&_.updateOptions({wordWrap:e?"on":"off"})},this.setUseJade=function(e,t){s=e,_&&(e?_.setModel(monaco.editor.createModel(_.getValue(),"pug")):_.setModel(monaco.editor.createModel(_.getValue(),"html")),t||(p&&(clearTimeout(p),p=null),original_source=P(),E(original_source)))},null),J="1"===pinegrow.getSetting(r.key+"-html-lint","1");this.setLint=function(e,t){if(pinegrow.setSetting(r.key+"-html-lint",e?"1":"0"),_){var n=e,i=!1;if(t)for(var o=0;o<t.length;o++)if(t[o].containsServerSideScripts()){i=!0;break}_.pgCheckForErrors=n=e&&i?!1:n}J=e},this.focus=function(){_&&_.focus()};let v;var z=function(){var e=(L||n).get(0).ownerDocument.defaultView,e=(_=monacoInstance.openEditor(null,null,e,n,!1,"html")).getModel(),t=(pinegrow.code_editors.register(_),v=pinegrow.getSelectedPage().url,pgEditorAttributeIntellisense.setHtmlCompletion(v,null,e.getLanguageId()),b.setWrap(d),r.editable||_.updateOptions({readOnly:!0}),_.onDidChangeModelContent(function(){b.invalid||(U(),t&&pinegrow.highlightElement(null))}),!1);return _.onDidFocusEditorText(function(){var n;pgEditorAttributeIntellisense.focusedUrl=pinegrow.getSelectedPage().url,b.invalid||r.custom||b.pinned&&(n=[],M.forEach(function(e){var t=e.get$DOMElement();t&&n.push(t.get(0))}),n.length)&&(n=$(n),pinegrow.highlightElement(n),t=!0)}),_.onDidChangeCursorPosition(function(){w(),x=_.getPosition()}),_.onContextMenu(function(e){return e.event.preventDefault(),!1}),{CodeEditorVsc:_,editor_el:null,close:function(){close()}}};this.invalidate=function(e){var t,n=O.sourceNode.getNodeFromPath(g);n&&(M=[n],V=n,h&&(t=O.sourceNode.getNodeFromPath(h))!=n&&t.parent==n.parent&&M.push(t),this.updateEditor(e))};let j=!1;var E=async function(e,t){(e=removeCrsaClassesFromHtml(e)).match(/<\?php/gim)&&!j&&(_.setModel(monaco.editor.createModel(_.getValue(),"php")),await pgEditorAttributeIntellisense.setHtmlCompletion(v,null,"php"),j=!0),T=!0,a&&(clearTimeout(a),a=null),i=!1,H(""),a=setTimeout(function(){_.setValue(e),T=!1,a=null},100)},Q=(this.search=function(e){var t=_.getModel().findMatches(e,!0,!1,!0,null,!0);let n=[];0!==e.length?(Array.from(t).forEach(e=>{var t=e.range;n.push({positionColumn:t.endColumn,positionLineNumber:t.endLineNumber,selectionStartColumn:t.startColumn,selectionStartLineNumber:t.startLineNumber})}),0<n.length&&_.setSelections(n)):_.setSelection({startColumn:0,startLineNumber:0,endColumn:0,endLineNumber:0})},function(){if(1<M.length){for(var e=null,t=null,n=null,i=0;i<M.length;i++){var o=M[i].parent.getChildPos(M[i]);null===e?(e=M[i],n=t=o):e.parent==M[i].parent&&(o<t&&(t=o),n<o)&&(n=o)}for(var r=[],i=t;i<=n;i++)r.push(e.parent.children[i]);k=(M=r).length,V=M[0]}A()}),C=function(){r.custom||(V?b.pinned?b.section.setTitle(V.getName({short:!0})+" | Pinned"):b.section.setTitle(V.getName({short:!0})+" | Selected element"):b.section.setTitle("Can't edit this element"))},G=function(e){pinegrow.stats.using("edit.elementcode");var t=null,n=(c=!1,e||((n=pinegrow.selectedElements.getRange())?(t=n.all,e=n.first,k=n.count,c=1<k):(k=1,e=pinegrow.selectedElements.getLastSelected())),e&&Array.isArray(e)&&(e=(t=e)[0]),l.CodeEditorVsc),i={};if(!e||!W(e,i))return b.invalid=!0,n.updateOptions({readOnly:!0}),n.setValue(i.msg||""),C(),!1;b.invalid=!1,n.updateOptions({readOnly:!r.editable}),M=t=t||[e],A(),V=e,C();pinegrow.getCrsaPageOfPgParserNode(V);b.setLint(J,M);i=P();pinegrow.codeEditor;E(i)},K=function(){for(var e=0;e<M.length;e++)if(!M[e].canConvertToJade())return!1;return!0},P=function(){var n="";return(y=s)&&!K()&&(y=!1),M.forEach(function(e){var t;y?null!==(t=e.toJade())&&(n.length&&(n+="\n"),n+=t):(n.length&&(n+="\n"),(t=pinegrow.getFormatHtmlOptions()).remove_collapsed=!0,t.remove_hidden=!0,n+=e.toStringOriginal(!0,t))}),n};this.flash=function(){pg$Flash(n)},this.getPage=function(){return O}};