var PgQuickCSSRuleCodeEdit=function(e,n){var t=new PgCSSRuleCodeEditView(e),o=pgStylesheetHelper.getStylesheetFromNode(e),o=(o.canEdit(!0)||t.setReadOnly(!0),new PgQuickWindow(o.filterSource(e.selector)||" | Edit CSS code",t,"quickCSSRuleCodeEdit",570,260));t.setWindow(o),o.$element.addClass("pg-css-rule-code-editor"),o.showFor$El(n),t.show(),o.onDestroy=function(){}},PgCSSRuleCodeEditView=function(e){function n(e,n){_||(updateRuleIndices(f,n,1,"added"),E(n))}function t(e,n){E(n)}function o(e,n){_||(updateRuleIndices(f,n,-1,"deleted"),E(n,!0))}function i(e,n,t){g===n&&u.setReadOnly(t)}var d,s=$('<div class=""><div class="pg-element-code-editor"></div><div class="pg-element-code-editor-controls"></div></div>'),r=s.find(".pg-element-code-editor"),l=new PgCodePanelNotice,c=(l.hideOnEmpty=!0,l.get$Element().appendTo(s),this.view=new PgUIView(s)),u=this,a=null,g=pgStylesheetHelper.getStylesheetFromNode(e),p=e,f={pgStylesheet:g,node:e,nodeIndices:pinegrow.pgPostCSSHelper.getNodeIndices(e)},w=!1,_=!1,h=!0,v=null,S=!1,m=!1,y=(this.win=null,function(){return pinegrow.pgPostCSSHelper.getNodeByIndices(f.pgStylesheet.getRootNode(),f.nodeIndices)}),E=function(e,n){var t,o,i=y();pinegrow.pgPostCSSHelper.isNodeEqualOrChildOf(i,e.node)&&(n&&(t=i.nodes.indexOf(e.node),(o=i.clone()).nodes.splice(t,1),i=o),W(i))},C=(pinegrow.addEventHandler("on_css_node_added",n),pinegrow.addEventHandler("on_css_node_updated",t),pinegrow.addEventHandler("on_css_before_node_deleted",o),c.onResize=function(){a&&a.mirror.layout()},!1),H=(pinegrow.addEventHandler("on_css_source_changed",function(e,n){n&&n.list&&n.eventType&&"editor"==n.eventType&&"external_editor"==n.editor&&0<=n.list.indexOf(g)&&(pinegrow.showQuickMessage("Stylesheet was modified in external editor."),0),0<=n.list.indexOf(g)&&(C=!0)}),pinegrow.addEventHandler("on_css_stylesheet_locked_changed",i),c.onDestroy=function(){P&&(clearTimeout(P),C||T()),pinegrow.code_editors.unregister(d),pinegrow.removeEventHandler("on_css_node_added",n),pinegrow.removeEventHandler("on_css_node_updated",t),pinegrow.removeEventHandler("on_css_before_node_deleted",o),pinegrow.removeEventHandler("on_css_stylesheet_locked_changed",i),H&&(clearTimeout(H),H=!1),R("")},this.setWindow=function(e){this.win=e},this.show=function(){c.whenVisible(function(){a=a||V(),x()})},null),R=function(n){H&&(clearTimeout(H),H=!1),n?H=setTimeout(function(){d.getPosition(),d.getScrollLeft();var e=d.getScrollTop(),e=d.getContentHeight()-2*e<60;l.setMessage(n,e),H=null},750):l.setMessage("")},O=function(){I(a.mirror.getValue())},N=function(){var e=f.pgStylesheet,n=y();m&&(pinegrow.dispatchEvent("on_css_node_replaced",null,{oldNode:p,node:n,stylesheet:e}),pinegrow.selectRule(n)),m=!1},P=null,T=function(){var e,t;M||(S?S=!1:(e=d.getValue(),e=$.trim(e),t=pinegrow.pgPostCSSHelper.getNodeByIndices(g.getRootNode(),f.nodeIndices),g.updateNodeStylesheetWithSource(t,e,function(e){m=!0,e&&(t=e);var n=g.getError();P=null,n?l.setMessage(n):l.setMessage(""),$("body").trigger("crsa-rule-changed-in-editor",{list:[g]}),pinegrow.dispatchEvent("on_css_rule_changed_in_code_editor",null,{list:[g],node:t})})))},I=function(){if(w)return!1;P&&clearTimeout(P),P=setTimeout(T,300)},M=(this.setWrap=function(e){h=e,d&&d.updateOptions({wordWrap:e?"on":"off"})},!1),V=(this.setReadOnly=function(e){M=e,d&&d.updateOptions({readOnly:M})},pinegrow.getSetting("edit-element-css-lint","1"),function(){var e=r.get(0).ownerDocument.defaultView;(d=monacoInstance.openEditor(null,null,e,r,!0,g.getEditorMode())).getModel();return d.updateOptions({contextmenu:!1}),pinegrow.code_editors.register(d),d.onContextMenu(function(e){return e.event.preventDefault(),!1}),u.setWrap(h),u.setReadOnly(M),setTimeout(function(){d.focus()},100),d.onDidChangeModelContent(function(){O()}),d.onDidBlurEditorWidget(function(){N()}),{mirror:d,editor_el:null,close:function(){}}}),W=(this.invalidate=function(){},function(e){var n="",t="off"!=pinegrow.autoFormatCss,n=(n=t?n:e.raws.before)+g.getSourceForRules(e,!1,t),n=g.filterSource(n,!0);S=!0,d.setValue(n),g.setNeedFormatting(!0)}),x=function(){W(p)};this.flash=function(){pg$Flash(r)}};