class PgClassProperties{constructor(){}init(){this.cats=[],this.cats_map={}}getCat(e){return this.cats_map[e]}addProperty(e,s,t,n){var a=new PgAddClassContextMenuProperty(s,t,n);this.getCat(e).add(a)}}class PgAddClassContextMenuItem{constructor(e){this.key=e,this.menu=null}setMenu(e){this.menu=e}}class PgAddClassContextMenuCategory extends PgAddClassContextMenuItem{constructor(e,s){super(e),this.name=s,this.items=[]}add(e){this.items.push(e)}getAction(t,n){this.setMenu(t);var a=[];return this.items.forEach(function(e){var s=e.getAction(t,n);a.push(s),s.with_divider&&a.push({type:"divider"})}),{label:this.name,submenu:a}}}class PgAddClassContextMenuProperty extends PgAddClassContextMenuItem{constructor(e,s,t,n){super(e),this.name=s,this.values=t,this.full_name=null,this.fdef=n}setValue(e){this.menu.setClass(this,e)}getAction(e,s){function t(){o.setValue(this.key)}function n(){s.setClass(this.key,o.values)}function a(){s.restore()}var l,i,o=this;this.setMenu(e);return this.fdef&&"color"===this.fdef.type?(i={},this.values.forEach(function(e){var s=e.key.split("-"),t=s.pop(),s=s.join("-");e.base=s,e.suf=t,i[s]?i[s].push(e):i[s]=[e]}),l=[],$.each(i,function(e,s){1===s.length?l.push({label:s[0].suf+`<color><colorbox style="margin-left:8px;background-color:${s[0].color}"></colorbox></color>`,label_plain_text:s[0].suf,key:s[0].key,action:t,on_mouseenter:n,on_mouseleave:a}):l.push({label:e,submenu:s.map(function(e){return{label:e.suf+`<color><colorbox style="margin-left:8px;background-color:${e.color}"></colorbox></color>`,label_plain_text:e.suf,key:e.key,action:t,on_mouseenter:n,on_mouseleave:a}})})})):l=this.values.map(function(e){return{label:e.name,key:e.key,action:t,on_mouseenter:n,on_mouseleave:a}}),{label:this.name,full_name:this.full_name,submenu:l}}}class PgAddClassContextMenuButtonProperty extends PgAddClassContextMenuItem{constructor(e,s,t,n){super(e),this.name=s,this.full_name=null,this.fdef=t,this.divider=n}getAction(e,s){var t=this;return this.setMenu(e),{label:this.name,full_name:this.full_name,action:function(){t.fdef.func(null,e.get$MenuElement())},with_divider:this.divider}}}class PgSmartInputForAddClassMenu extends PgSmartInputForMenu{constructor(e){super(),this.add_class_action=e,this.matcher=new PgSmartGeneralMatcher}async getResultsForShorthand(e){var s=await super.getResultsForShorthand(e);if(e){for(var t=!1,n=0;n<s.length;n++)if(s[n].key===e){t=!0;break}t||s.push({label:`Add class <small style="text-transform: none;">${e}</small>`,key:e,action:this.add_class_action})}return s}}class PgAddClassContextMenu{constructor(e,s,t){this.pgel=e,this.page=e?e.getPage():pinegrow.getSelectedPage(),this.class_style=s,this.prefix=t||"",this.source=null,this.onClassSet=function(){},this.list=[],pinegrow.dispatchEvent("on_get_classes_menu",this.page,this.pgel,this.list)}setClass(e,s){var t=this,n=s,a=this.class_style;this.classPreview&&this.classPreview.restore();a=(new PgApi).setClassProperty(pinegrow.getCollectionForElement(this.pgel),this.prefix+n,e.values.map(function(e){return{key:t.prefix+e.key}}),a,{source:this.source});return a&&this.onClassSet(n),this.classPreview&&this.classPreview.remember(),a}getMenu(e){var t=this,n=[],s=(this.pgel?this.classPreview=new PgFastDOMClassPreviewForPgel(this.pgel,this.prefix):this.class_style&&(this.class_style.component?this.classPreview=new PgFastDOMClassPreviewForSelector(this.class_style.getSelector(),this.prefix):(s=pinegrow.selectedElements.getLastSelected())&&this.class_style.doesPgelHasThisStyle(s)&&(this.classPreview=new PgFastDOMClassPreviewForPgel(s,this.prefix))),this.list.forEach(function(e){var s=e.getAction(t,t.classPreview);n.push(s),s.with_divider&&n.push({type:"divider"})}),n.push({type:"divider"}),n.push({label:"Keep the menu open",helptext:"Enable to keep the menu open after a class is selected. Useful for adding multiple classes quickly. Use ESC key to close the menu.",check:"1"===pinegrow.getSetting("add-class-menu-keep-open","0"),action:function(){var e=!("1"===pinegrow.getSetting("add-class-menu-keep-open","0"));pinegrow.setSetting("add-class-menu-keep-open",e?"1":"0"),pinegrow.showMode("Keep the menu open",e)}}),new CrsaContextMenu(n,e)),a=(s.class_key="menu_item_class",new PgSmartInputForAddClassMenu(async function(){await(new PgApi).canAddClass(null,this.key,t.class_style)&&t.setClass({values:[]},this.key)}));return s.addSmartInput(a),s.keepOpenOnClick="1"===pinegrow.getSetting("add-class-menu-keep-open","0"),s.ignore_mouseenter_on_show=!0,s.onClosed=function(){t.classPreview&&t.classPreview.destroy()},this.menu=s}showFor$el(e){this.getMenu(e).showForElement(e)}showForPgel(e){this.getMenu($("body")).showAtPgel(e)}showForEvent(e){this.getMenu($(e.target)).showAt(e.pageX,e.pageY)}get$MenuElement(){return this.menu.get$MenuElement()}}var PgQuickAssignClass=function(e,s){var t,n,a=e?e:null;(e=e||pinegrow.selectedElements.getLastSelected())?(t=new PgAssignClassView,n=e?e.getName({short:!0}):pinegrow.selectedElements.getName(),(n=new PgQuickWindow("Add classes to "+n,t,"quickAssignClasses",640,320,null,!0)).noRightEdge(),t.quickWin=n,t.target_pgel=a,s?n.showFor$El(s):n.showForPgel(e),t.onShown(),t.show(e),n.onDestroy=function(){}):pinegrow.showQuickMessage("Please, first select an element.")},pgAssignClassLastSearchTerm=null,pgAssignClassLastVariants="",PgAssignClassView=function(){function e(){var e={variants:[]};return pinegrow.getSelectedPage().callFrameworkHandler("on_get_all_available_class_variants",e),e.variants}async function s(e,s){void 0===s&&(s=!1);var t,n=f(e||h);n.length&&(t=s&&r.hasClass(g(n[0])),n=n.map(function(e){return g(e)}),t?i.removeClass(l.target_pgel,n,{event_type:"change"}):(i.addClass(l.target_pgel,n,{event_type:"change"}),n.forEach(function(e){F(e)})),R())}var t,n=$('<div class="pg-assign-classes"></div>'),a=new PgUIView(n),l=(this.view=a,this.target_pgel=null,this),i=new PgApi,r=null,c=100,o=!1,u=":",g=((o=e().length?!0:o)&&(n.addClass("with-variants"),(t=new PgInputField("variants",{type:"text",name:"Variants",without_text:!0,placeholder:"dark:md:hover...",options:e,append_autocomplete_delimiter:u,append_autocomplete_value:!0})).on("change input",function(e){pgAssignClassLastVariants=t.getValue()}),t.setValue(pgAssignClassLastVariants),t.appendTo(n)),function(e){var s=t?.getValue().trim()||"";return s&&!s.endsWith(u)&&(s+=u),s+e}),p=new PgSearchBox({placeholder:"Create or search... Use ↑, ↓ and ENTER keys.",placeholder_active:null,toolbar_on:!1}),d=(p.getToolbar(),p.$element.appendTo(n),null),h=null,f=(p.onSearch=function(e){try{pgAssignClassLastSearchTerm=h=e,d=e.length?new RegExp(f(e).join("|"),"i"):null,E(),R()}catch(e){}},this.onShown=function(){p.focus()},function(e,s){var t=splitBracketsAware(e,","),n=splitBracketsAware(e," "),n=!(1<t.length)&&1<n.length?n:t,a=[];return n.forEach(function(e){(e=$.trim(e)).length&&(s&&(e=escapeRegExp(e)),a.push(e))}),a});(new PgSearchBoxSpacer).$element.appendTo(n);function m(e){new PgClassButtonHelper(e)}async function v(e,s){e.preventDefault();var t,n,a=$(e.currentTarget);a.hasClass("show-more")?k():(t=a.attr("data-class"),r&&(s||(t=g(t)),n=!0,r.hasClass(t)?(i.removeClass(l.target_pgel,t,{source:l}),n=!1):await i.canAddClass(l.target_pgel,t)&&(i.addClass(l.target_pgel,t,{source:l}),F(t),s||R()),x(t,n,a),T()))}function w(e,s,t){var n=pinegrow.selectedElements.getLastSelected();l.show(n),l.quickWin.setTitle("Add classes to "+pinegrow.selectedElements.getName())}function C(e,s,t){s!=r||t.source&&t.source==l||(T(),b())}$('<button class="btn btn-primary">Add class</button>').appendTo(p.$element).on("click",function(e){e.preventDefault(),s(null,!1)});var o=$('<div class="pg-assign-classes-c"></div>').appendTo(n),n=$('<div class="pg-assign-classes-all pg-list"><p>All</p></div>').appendTo(o),_=$('<div class="pg-assign-classes-assigned"><p>Assigned</p></div>').appendTo(o),o=$('<div class="pg-assign-classes-recent pg-list"><p>Recent <button class="pg-button" style="padding: 0 5px;margin-left: 4px;">Clear...</button></p></div>').appendTo(o),P=$('<ul class="pg-assign-classes-list"></ul>').appendTo(n),y=$('<ul class=""></ul>').appendTo(_),A=$('<ul class="pg-assign-classes-list"></ul>').appendTo(o),S=(o.find("button").on("click",function(e){pinegrow.showAlert(`<p>Are you sure you want to clear the list of recent classes?</p>`,"Please confirm","Cancel","Yes, clear the list",null,function(){pinegrow.recentClasses.clear(),R()})}),new PgArrowsMover(p.getInput(),P,"> li")),k=(S.onEnter=function(e){e?e.hasClass("show-more")?k():s(e.attr("data-class"),!0):s()},function(){c=9999999,E()}),x=(P.on("click","li",function(e){v(e,!1)}),A.on("click","li",function(e){v(e,!0)}),function(e,s,t){t=t||P.add(A).find('[data-class="'+e+'"]'),s?t.addClass("has-class"):t.removeClass("has-class")}),b=function(){var s;P.add(A).find(".has-class").removeClass("has-class"),r&&(s=[],r.getClasses().forEach(function(e){s.push('[data-class="'+e+'"]')}),s.length)&&P.add(A).find(s.join(",")).addClass("has-class")},M=(y.on("click","li",async function(e){e.preventDefault(),e.stopPropagation();var s=$(this),t=s.attr("data-class"),t=g(t);r&&(r.hasClass(t)?(i.removeClass(l.target_pgel,t,{source:l}),s.addClass("class-off"),x(t,!1)):await i.canAddClass(l.target_pgel,t)&&(i.addClass(l.target_pgel,t,{source:l}),s.removeClass("class-off"),F(t,!0)&&R(),x(t,!0)))}),y.on("click",".crsa-input-rule-remove",function(e){var s=$(this).parent().attr("data-class"),s=g(s);r&&(i.removeClass(l.target_pgel,s),e.preventDefault(),e.stopPropagation())}),m(P),m(y),m(A),function(e){return e.startsWith("<span")?e:escapeHtmlCode(e)}),E=function(){var e=r?r.getPage():null,s=r?pinegrow.insight.getClassesForPage(e):pinegrow.insight.getClasses(),t={classes:[]};e&&e.callFrameworkHandler("on_get_all_available_classes",t);for(var n=0===(n=t.classes).length?s:Array.from(new Set(s.concat(n))),a="",l=0,i=0;i<n.length;i++)if(!d||n[i].key.match(d)){l++;var o=r&&r.hasClass(n[i].key);if(a+='<li class="'+(o?"has-class":"")+'" data-class="'+n[i].key+'" data-id="'+n[i].id+'">'+M(n[i].html||n[i].name)+"</li>",c===l){a+='<li class="show-more">'+c+" results shown. Show all.</li>";break}}S.update("data-id",function(){P.get(0).innerHTML=a})},T=function(){var e="";if(r)for(var s=r.getClasses(),t=0;t<s.length;t++)e+='<li class="pg-button pg-class-button" data-class="'+s[t]+'">'+M(s[t])+'<i class="icon icon-close crsa-input-rule-remove"></i></li>';y.get(0).innerHTML=e},F=function(e,s){return pinegrow.recentClasses.add(e,s)},R=function(){for(var e="",s=pinegrow.recentClasses.getRecent(),t=0;t<s.length;t++)s[t]&&(e+='<li class="'+(r&&r.hasClass(s[t])?"has-class":"")+'" data-class="'+s[t]+'">'+M(s[t])+"</li>");A.get(0).innerHTML=e,0};this.show=function(e){r=e,0&&pgAssignClassLastSearchTerm&&pgAssignClassLastSearchTerm!=h?p.setValue(pgAssignClassLastSearchTerm):(E(),R()),T()};a.onResize=function(){},pinegrow.addEventHandler("on_selected_elements_changed",w),pinegrow.addEventHandler("on_page_changed",C),a.onDestroy=function(){pinegrow.removeEventHandler("on_selected_elements_changed",w),pinegrow.removeEventHandler("on_page_changed",C)}},PgRecentClasses=function(){var t=this,a=null,l=100;this.add=function(e,s){if(!e)return!1;this.getRecent();var t=!1,n=a.indexOf(e);return 0<=n?s||(a.splice(n,1),t=!0):s=!1,s||(a.unshift(e),t=!0),a.length>l&&(a.splice(l,a.length-l),t=!0),t&&this.save(),t},this.getRecent=function(){if(null===a){var e=pinegrow.getCurrentProject();if(e){e=e.getProjectInfo();a=e.getSetting("recent-classes")||[]}else if(a=[],localStorage.pgRecentClasses)try{a=JSON.parse(localStorage.pgRecentClasses)}catch(e){}}return a},this.save=function(){var e=pinegrow.getCurrentProject();e?((e=e.getProjectInfo()).setSetting("recent-classes",a),e.save()):localStorage.pgRecentClasses=JSON.stringify(a)},this.clear=function(){a=[],this.save()},pinegrow.addEventHandler("on_project_loaded",function(e,s){a=null,t.getRecent()}),pinegrow.addEventHandler("on_project_closed",function(e,s){a=null})},PgClassButtonHelper=function(e,a,l){e.on("contextmenu","li",function(e){var s,t=$(this),n=t.attr("data-class");return n&&(s=new CrsaContextMenu(null,$(this)),pgf.edit_html&&a&&(s.add("Toggle",null,async function(){var e=new PgApi;a.hasClass(n)?(e.removeClass(null,n,{source:l}),t.addClass("class-off")):await e.canAddClass(null,n)&&(e.addClass(null,n,{source:l}),t.removeClass("class-off"))}),a.hasClass(n))&&s.add("Remove",null,function(){(new PgApi).removeClass(null,n,{source:l}),t.addClass("class-off")}),pgf.edit_css&&(s.add("Create CSS rule...",null,function(){i(n)}),s.add("Explore CSS rules...",null,function(){o(n)}),pinegrow.isClassTreeSupported())&&(s.add({type:"divider"}),(new PgApi).twGetMenuActionsFor(a,pinegrow.classStyles.getPgelStyleWithClass(a,n),n,null).forEach(function(e){s.add(e)})),s.showAt(e.pageX,e.pageY)),!1});var i=function(e){pinegrow.showUIPanel("style"),pinegrow.activeCSSView.openCreateNewRuleDialog("."+e,null,null,e)},o=function(e){pinegrow.showUIPanel("style"),pinegrow.activeCSSView.show(null,"."+e)}};