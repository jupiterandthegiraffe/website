var PgElementSelectorHelper=function(){function g(){return pinegrow.getCurrentProject().db}function u(e,t){e instanceof pgParserNode&&(e=e.getPage()),pinegrow.undoManager.getHistoryForPage(e).ignore(t)}function p(e,t){var n=new PgCollection;return u(t,function(){t&&m.removeElementActionsFromPgel(e,t),e.removeAttribute("selector"),e.removeAttribute("desc"),e.setAttr("status","unused"),n.add(e)}),n}function h(e,t){var n,o;t?(o="ok",0===(n=t.sourceNode.find(e.getAttr("selector"),!1,!1,function(e){return!(!e.hasAttr("wp-preview")||e.hasAttr("data-pg-sel"))},null)).length?o="none":1<n.length&&(o="multiple"),e.setAttr("status",o)):e.setAttr("status","ok")}function a(e){return e.replace(/\s/g,"")}var m=this;this.verifySelectorsOnPage=function(n){var o=[];return n.sourceNode.walk(function(e){var t;return e.isElement&&(t=e.getAttr("data-pg-sel"))&&n.sourceNode.findOne(t)!==e&&o.push(e),!0}),o},this.getSelectorBadnessScore=function(e){var t=0;return(t+=5*(e.match(/\>/g)||[]).length)+10*(e.match(/nth-of-type/g)||[]).length},this.isThereABetterAutoSelector=function(e,t){var n=e.getUniqueSelectors(0,9999,e.document,!0),n=n.length?n[0]:null;return n&&n!==t&&this.getSelectorBadnessScore(n)<this.getSelectorBadnessScore(t)?n:null},this.getSelectorHtml=function(e){for(var t=(e=e.replace(/\> /g,">")).split(" "),n=0;n<t.length;n++)t[n]=t[n].replace(/(>)?([^#.]+)?(#[^.]+)?(\..+)?/g,function(e,t,n,o,a){var i="";return t&&(i+=`<child>&gt; </child>`),n&&(i+=`<nametag>${n}</nametag>`),o&&(i+=`<nameid>${o}</nameid>`),a&&(i+=`<nameclass>${a}</nameclass>`),i});return`<span class="pg-selector">${t.join(" ")}</span>`},this.getActionSetName=function(e){var t=e.getAttr("name")||"&lt;no name&gt;",n=e.getAttr("selector"),n=(n&&(t+=" - "+n),e.find("action"));return n.length&&(t+=" - "+n[0].getAttr("name"),1<n.length)&&(t+=` +`+(n.length-1)),t},this.getActionsForMenu=function(e,s){var l=[],t=e.getUniqueSelectors(0,100);return t.length&&t.forEach(function(e){for(var t=e,n=(e=e.replace(/\> /g,">")).split(" "),o="",a="",i=0;i<n.length;i++)o+=`<span class="pg-sel-menu-path-part" data-sel="${a+=(a?" ":"")+n[0]}">${m.getSelectorHtml(n[i])}</span>`;l.push({selector:t,label:o,action:function(){s(e)}})}),l},this.displayIssuesNotice=function(e){pinegrow.showAlert(`<p>The project has ${e} unresolved issue${1<e?"s":""} with selectors mapping WordPress actions to their respective HTML elements.</p><p><a href="https://pinegrow.com/docs/wordpress/selectors/" class="external">Learn how to resolve mapping issues.</a></p>`,"Action sets mapping issues",`I'll deal with it later`,"Go to Action mappings panel",null,function(){pinegrow.showUIPanel("db_tree"),pinegrow.projectDBTreeView.setFilterOption("issues")})},this.mapDBElementToPgel=function(e,t,n,o){u(t,function(){n&&!o||(n=pinegrow.assignUniqueSelectorToPgel(t,!1,o)),m.replaceElementSelector(e,n,!0,!0)}),t.getPage().setPageChanged(!0),pinegrow.selectedElements.reselect()},this.changeActionSetName=function(t,n){var e=this.getOpenPageForElement(t),o=new PgCollection;u(e,function(){var e=m.getMappedPgel(t);e&&(e.removeAttr("data-pg-name"),n)&&e.setAttr("data-pg-name",n),t.removeAttr("name"),n&&t.setAttr("name",n)}),e.setPageChanged(!0),g().changed(o),pinegrow.selectedElements.reselect()},this.unmapDBElementFromPgel=function(e,t){var n=p(e,t),o=(t?t.getPage():this.getOpenPageForElement(e))||pinegrow.getSelectedPage();u(o,function(){t?pinegrow.changeManager.didChange(t,"Remove action"):pinegrow.changeManager.didChangePage(o,"Remove action")}),o.setPageChanged(!0),g().changed(n),pinegrow.selectedElements.reselect()},this.unmapOneDBElementFromPgelAndMapAnother=function(e,t,n,o){var a=new PgCollection;a.add(e),a.add(t),p(e,n),this.mapDBElementToPgel(t,n,o),g().changed(a)},this.makeElementUnused=function(e){var t=this.getMappedPgel(e);this.unmapDBElementFromPgel(e,t)},this.deleteElement=function(t){var e=this.getOpenPageForElement(t);u(e,function(){var e=m.getMappedPgel(t);e&&p(t,e),t.remove()}),e.setPageChanged(!0),g().changed()},this.addElementActionsToPgel=function(e,t){t.removeAttrIfStartsWith("wp-"),t.removeAttrIfStartsWith("cms-"),e.find("action").forEach(function(e){e.getAttrList().forEach(function(e){"id"!==e.name&&"name"!==e.name&&t.setAttribute(e.name,e.value,!0,e.quote)})})},this.removeElementActionsFromPgel=function(e,t){e.find("action").forEach(function(e){e.getAttrList().forEach(function(e){t.hasAttr(e.name)&&t.removeAttribute(e.name)})})},this.replaceElementSelector=function(a,i,e,s){var l=a.getAttr("selector"),t=a.closest("document"),n=a.getAttr("name"),c=new PgCollection,r=pinegrow.getCrsaPageByUrl(pinegrow.getCurrentProject().getAbsoluteUrl(t.getAttr("url"))),d=new PgCollection;u(r,function(){var e;r&&(l&&(e=m.getMappedPgel(a))&&(e.removeAttr("data-pg-sel"),e.removeAttr("data-pg-name"),m.removeElementActionsFromPgel(a,e),c.add(e)),e=r.sourceNode.findOne(i)),a.setAttr("selector",i),h(a,r),e&&(e.setAttr("data-pg-sel",i),n&&e.setAttr("data-pg-name",n),s&&m.addElementActionsToPgel(a,e),c.add(e)),d.add(a),l&&t.find("element").forEach(function(e){var t,n,o=e.getAttr("selector");o&&o.startsWith(l+" ")&&(t=o.replace(l+" ",i+" "),e.setAttr("selector",t),e.setAttr("status","ok"),d.add(e),r&&((o=r.sourceNode.findOne(o))&&((n=g().getElementNodeForPgel(o,r))&&(p(n,o),d.add(n)),o.removeAttr("data-pg-sel"),m.removeElementActionsFromPgel(e,o),c.add(o)),n=r.sourceNode.findOne(t))&&(n.setAttr("data-pg-sel",t),(o=e.getAttr("name"))&&n.setAttr("data-pg-name",o),c.add(n),s)&&m.addElementActionsToPgel(e,n),h(a,r))}),0<c.getLength()&&pinegrow.changeManager.didChange(c,"Replace selector")}),g().changed(d)},this.openDocument=function(e,t){var n=pinegrow.getCurrentProject().getAbsoluteUrl(e.getAttr("url"));pinegrow.openOrShowPage(n,function(e){t&&t(e)},!0)},this.getOpenPageForElement=function(e){var t=e.closest("document"),t=pinegrow.getCurrentProject().getAbsoluteUrl(t.getAttr("url"));return pinegrow.getCrsaPageByUrl(t)};this.getMappedPgel=function(e){var t=this.getOpenPageForElement(e),n=e.getAttr("selector"),o=null;return n&&(n=a(n),t.sourceNode.walk(function(e){if(e.isElement){var t=e.getAttr("data-pg-sel");if(t&&n===a(t))return o=e,!1}return!0})),o},this.getPgelTargetedBySelector=function(e){var t=this.getOpenPageForElement(e),n=e.getAttr("selector");return n?t.sourceNode.findOne(n):null},this.selectMappedPgel=function(a,i){var e=a.closest("document");this.openDocument(e,function(e){e=e,t=null,(n=a.getAttr("selector"))&&e.sourceNode.walk(function(e){return!e.isElement||e.getAttr("data-pg-sel")!==n||(t=e,!1)});var t,n,o=t?(pinegrow.selectElement(t),t.scrollTo(),t):(pinegrow.showQuickError("The action set is not used on the page."),null);i&&i(o)})},this.selectMatchedPgels=function(i,n){var e=i.closest("document");this.openDocument(e,function(e){var t=function(e){var t=i.getAttr("selector"),n=t?e.sourceNode.find(t):[];if(n.length){for(var o=new PgCollection,a=0;a<n.length;a++){if(5===a){pinegrow.showQuickMessage(`...and ${n.length-a} more elements.`);break}o.add(n[a])}return pinegrow.selectedElements.selectMany(o,!0),o.getFirst().scrollTo(),n}return pinegrow.showQuickError("The action set is not used on the page."),null}(e);n&&n(t)})},this.selectAction=function(e,t){var n=e.closest("element");this.selectMappedPgel(n,function(e){e&&pinegrow.showUIPanel("cms"),t&&t(e)})},this.isAutoSelectorOn=function(){return"1"===pinegrow.getSetting("actions-auto-selector","1")}},PgElementSelectorBox=function(e){function n(e){(e?(t.html(e),pg$Show):pg$Hide)(t)}var o=this,a=(this.selector_value=null,this.auto_selector="1"===pinegrow.getSetting("actions-auto-selector","1"),this.show_hints="1"===pinegrow.getSetting("actions-selector-show-hints","1"),new PgElementSelectorHelper),i=(this.onChanged=function(e){},this.$element=$("<div></div>",{class:"pg-element-selector-box"}),$(`<div class="pg-element-selector"></div>`).appendTo(this.$element)),t=$(`<div class="pg-element-selector-hint"></div>`).appendTo(this.$element),s=(crsaHandleExternalLinks(t),pg$Hide(t),i.on("click contextmenu",function(e){e.preventDefault();var t=a.getActionsForMenu(pinegrow.selectedElements.getLastSelected(),function(e){o.setSelectorValue(e)}),n=(t.forEach(function(e){e.check=e.selector===o.selector_value}),t.push({type:"divider"}),t.push({type:"header",label:"Options"}),t.push({label:"Automatically add selector",check:o.auto_selector,action:function(){o.auto_selector=!o.auto_selector,pinegrow.setSetting("actions-auto-selector",o.auto_selector?"1":"0"),pinegrow.showMode("Auto add selector",o.auto_selector),pinegrow.selectedElements.reselect()}}),t.push({label:"Show hints",check:o.show_hints,action:function(){o.show_hints=!o.show_hints,pinegrow.setSetting("actions-selector-show-hints",o.show_hints?"1":"0"),pinegrow.showMode("Show hints",o.show_hints),pinegrow.selectedElements.reselect()}}),new CrsaContextMenu(t,i));return n.onBeforeMenuShown=function(){n.$menu_ul.addClass("pg-element-selector-menu")},n.showForElement(i,null,8),!1}),new PgInputField("name",{type:"text",show_empty:!1,name:"Name",without_text:!0,slider_def_unit:"",placeholder:"Element name",validate:function(e,t,n){if(!n&&o.show_hints)return"HINT: name the element."}})),l=(s.$field.addClass("blue-error"),s.appendTo(this.$element),s.$input.on("contextmenu",function(e){return new CrsaContextMenu([{label:"Guess a name",action:function(){var e=pinegrow.selectedElements.getLastSelected();e&&(pinegrow.assignNameToPgel(e,!0),pinegrow.selectedElements.reselect())}}],s.$input).showForElement(s.$input),!1}),new PgPanelNotice(!0,!0)),c=(l.$element.appendTo(this.$element).css("margin-right","0px"),s.on("change",function(e){o.onNameChanged(s.getValue())}),s.on("keydown",function(e){13==e.which&&o.onNameChanged(s.getValue())}),this.focus=function(){s.$input.get(0).focus()},this.setSelectorValue=function(e,t){i.html(e?a.getSelectorHtml(e):"Choose a selector&hellip;"),this.selector_value=e,t||o.onSelectorChanged(e),e||this.auto_selector?l.show(null):l.show(`Element needs a selector before you can add WordPress actions. Giving it a name is also a good idea.`),e&&15<a.getSelectorBadnessScore(e)&&o.show_hints?n('HINT: Use element ids for stronger selectors. <a href="https://pinegrow.com/docs/wordpress/selectors/" class="external"><i class="icon icon-271"></i> More info&hellip;</a>'):n(null)},this.setNameValue=function(e,t){term=e,s.setValue(e),t||s.$input.trigger("input")},this.getValue=function(){return s.getValue()},this.getInput=function(){return input},!0);this.show=function(){c||(this.$element.show(),c=!0)},this.hide=function(){c&&(this.$element.hide(),c=!1)},this.destroy=function(){delayTimer&&(clearTimeout(delayTimer),delayTimer=null)}},PgActionsToPgelMap=function(){function a(e){var t=new CrsaProfile;return actions_to_pgels=new WeakMap,e&&e.sourceNode.walk(function(n){return n.isElement&&e.getAllActionTypes(n).forEach(function(e){var t=actions_to_pgels.get(e);t||(t=[],actions_to_pgels.set(e,t)),t.indexOf(n)<0&&t.push(n)}),!0}),i.set(e,actions_to_pgels),t.show("buildActionsToPgelsMap"),actions_to_pgels}var i=new WeakMap;this.getPgelsForAction=function(e,t){return(i.get(t)||a(t)).get(e)||[]},this.getListForAction=function(e,t){var n=i.get(t);return n?n.get(e):null},this.actionAdded=function(e,t){var n=t.getPage(),o=this.getListForAction(e,n);o||(i.get(n)||a(n),o=[],i.get(n).set(e,o)),o.indexOf(t)<0&&o.push(t)},this.actionRemoved=function(e,t){var n,o=t.getPage(),o=this.getListForAction(e,o);o&&0<=(n=o.indexOf(t))&&o.splice(n,1)}},PgQuickAddActions=function(e){void 0===n&&(n=Math.floor(.75*$("body").height()));var t=new PgActionsView(e,!1),n=this.win=new PgQuickWindow("Quick Add Actions",t,"quickAddActions",400,n,!1),o=pinegrow.selectedElements.getLastSelected();o?n.showForPgel(o):n.showAtRandomPosition(),t.show(),n.onDestroy=function(){}},PgCombinedActionsView=function(e,t){var n=$('<div class="crsa-panel"></div>'),o=new PgUIView(n,e.toLowerCase(),"CMS"==e?"WP":"Actions"),a=((this.view=o).combinedActionsView=this,o.tabIcon=t,this.assignedActionsView=new PgActionsView(e,!0)),i=new PgActionsView(e,!1),s=(i.assignedActionsView=a,"All actions");switch(e){case"CMS":s="All WordPress Actions";break;case"ANIMATIONS":s="All Interactions"}var l=new PgCombinedPanelView("actionsCombo"+e,a.view,i.view,s,50);a.combo=l,n.append(l.view.get$Element()),o.onAddedToLayout=function(e){l.onAddedToLayout()},o.onResize=function(){l.view.onResize(),a.updateLayout(),i.updateLayout()}},PgActionsView=function(o,r,O){function V(e,t,n){T.showAssignedActions&&S(),T.updateUsage(),T.showAssignedActions&&L(n)}function U(e,t,n){T.showAssignedActions&&S(),T.updateUsage()}function D(e,t,n){n.source!=T&&L(t)}function B(){y(g=null)}var e,t,n=$('<div class="crsa-panel pg-lib pg-actions"></div>'),a=new PgUIView(n,o.toLowerCase()+(r?"_assigned":"_list")),s=(this.view=a,this.panel_type=o,a.tabIcon=O,this.pluginActivated=!0,"Action"),R=pgf.use_selectors,l=null,c="data-pg-sel",j=!1,W=("CMS"==o?s="WordPress Action":"ANIMATIONS"===o&&(s="Interaction"),s+"s for"),C=(this.showAssignedActions=r,{}),k=[],i=function(){k.forEach(function(e){e.destroy()}),k=[]},Q=(r?(n.addClass("pg-actions-assigned"),e=$('<div class="pg-show-properties-name"></div>').prependTo(n),pg$Hide(e),e.on("click","i.copy-actions",function(e){e.preventDefault();var o=[];n.find("li.crsa-action.crsa-action-on").each(function(e,t){var n=N($(t));o.push({def:n,values:n.getActionValuesForPgel(d)})}),o.length&&pinegrow.clipboard.copySpecial("actions",o)})):n.addClass("pg-actions-list"),function(){a.whenVisible(function(){e&&(pinegrow.selectedElements.hasSelection()?(e.get(0).innerHTML="<span>"+W+"</span><name>"+pinegrow.selectedElements.getName({short:!0,def:null,num_classes:-1})+'</name><i class="cmd icon icon-273 copy-actions" title="Copy all actions to clipboard"></i>',pg$Show):pg$Hide)(e)},"showName")}),q=function(){R&&!l.auto_selector&&d&&(d.getAttr(c)?T.combo.showSecondPanel():T.combo.hideSecondPanel())},d=null,g=(this.getSelectedPgel=function(){return d},null),u=null,p=null,h=null,G=[],m=[],z=o,T=this,f=("1"==pinegrow.getSetting("actions-show-help-text","0")&&n.addClass("show-help-text"),this.setShowHelp=function(e){e?n.addClass("show-help-text"):n.removeClass("show-help-text")},this.showAssignedActions?R&&(n.addClass("pg-actions-with-selectors"),(l=new PgElementSelectorBox).onSelectorChanged=function(e){pinegrow.makeChanges(d,"Set selector",function(){d.setAttribute(c,e),d.removeAttribute(c+"-auto")}),y()},l.onNameChanged=function(e){pinegrow.makeChanges(d,"Set name",function(){e?d.setAttribute("data-pg-name",e):d.removeAttribute("data-pg-name")})},l.$element.appendTo(n)):((t=new PgSearchBox({placeholder:"search",placeholder_active:null,toolbar_on:!0})).addIcon({icon:"icon-tools",label:"Settings &amp; tools",func:function(e){var t=[{label:"Show help texts",action:function(){var e=!("1"===pinegrow.getSetting("actions-show-help-text","0"));e?(n.addClass("show-help-text"),pinegrow.setSetting("actions-show-help-text","1")):(n.removeClass("show-help-text"),pinegrow.setSetting("actions-show-help-text","0")),T.assignedActionsView&&T.assignedActionsView.setShowHelp(e),pinegrow.showMode("Show help text",e)},check:"1"===pinegrow.getSetting("actions-show-help-text","0")}];pinegrow.dispatchEvent("on_actions_panel_help_menu",g,T,t),new CrsaContextMenu(t,e.$element).showForElement(e.$element)}}),t.$element.appendTo(n),t.onSearch=function(e){p=e,T.show(),T.updateUsage()},(new PgSearchBoxSpacer).$element.appendTo(n),this.focusSearch=function(){t.focus()}),$('<div class="alert alert-info"></div>').appendTo(n).hide(),new PgPanelNotice),w=(f.$element.appendTo(n),f.$element.on("click",".activate-wp",function(e){e.preventDefault();var t=pinegrow.findFrameworkByKey("wordpress.pinegrow");t&&pinegrow.activateFrameworkInCurrentContext(t,function(){t.showWordPressSiteSetupDialog(),pinegrow.selectedElements.reselect()})}),function(e){var t;e?(f.show(e),v.$element.hide(),T.combo&&(d||T.combo.isStatic())&&(t=f.$element.position(),T.combo.enterStaticMode(t.top+f.$element.height()+60))):(f.show(),v.$element.show(),T.combo&&T.combo.exitStaticMode())}),v=new PgUISectionGrid,_=(n.append(v.$element),crsaHandleExternalLinks(v.$element),[]),A=(a.onResize=function(){v.updateLayout()},this.updateLayout=function(){v.updateLayout()},null),P=null,b=(this.showAssignedActions&&(A=new PgUISection("All assigned actions",null,{},null,!0)),this.show=function(t,n){i(),a.whenVisible(function(){g=pinegrow.getSelectedPage(),d=pinegrow.selectedElements.getLastSelected(),j&&g&&!d&&(d=g.sourceNode.findOne("html")),Q(),J(function(){if(pgRemoveMultiselects(v.$element),v.clear(),T.pluginActivated=!0,"CMS"===o){var e=pinegrow.findFrameworkByKey("wordpress.pinegrow");if(e&&!e.default&&g&&!g.hasFramework(e))return T.pluginActivated=!1,T.showAssignedActions&&w('<p>WordPress Theme Builder is not activated on this page.</p><p class="buttons"><button class="pg-button activate-wp">Activate WordPress</button></p>'),void(n&&n(!1))}if(T.showAssignedActions){e={panel:T,show_actions:!0,show_selector:!0,show_assigned_with_message:!1,message:null,on_after:null,pgel:d,page:g};if(d&&g||(e.message="Click on any element on the page to edit its actions or to add new HTML elements to the page.",e.show_actions=!1,e.show_selector=!1),g?g.callFrameworkHandler("on_assigned_actions_shown",e):pinegrow.dispatchEvent("on_assigned_actions_shown",null,e),e.show_actions?T.combo.showSecondPanel():T.combo.hideSecondPanel(),e.message?w(e.message):w(),l&&(e.show_selector?l.show():l.hide()),e.on_after&&e.on_after(),e.message&&!e.show_assigned_with_message)return void(n&&n(!1))}h=p&&0<p.length?new RegExp(escapeRegExp(p),"i"):null,g&&(t=t||g.getActionsSections(),e=u=t,_=[],T.showAssignedActions?(v.addSection(A),_.push(A),P&&(v.addSection(P),_.push(P))):$.each(e,function(e,t){var n,o,a;t.framework.show_in_action_tab!=z||t.show_if&&!t.show_if(g)||(n=!0,h&&(n=t.name.match(h)),G.push(t),o="",$.each(t.getComponentTypes(),function(e,t){t&&(o+=K(t,n))}),o.length&&((a=new PgUISection(t.name,t.small_name||t.framework.name,t,null,h,{tooltip:t.tooltip||null})).$content.get(0).innerHTML="<ul>"+o+"</ul>",v.addSection(a),_.push(a),addTooltip(a.$content.find("name span[title]"),"dummy",{use_title_attr:!0})))}),v.updateLayout(),n)&&n(!0)})})},this.updateUsage=function(){i(),a.whenVisible(function(){b()},"updateUsage",2)},function(){i();v.$element;x=[],F={},_.forEach(function(e){var a=!1;e.$content.find("li.crsa-action").each(function(e,t){var n=$(t),o=N(n);T.showAssignedActions&&(pgRemoveMultiselects(n),n.find(".action-fields").remove()),d?M(d,o)||o.action_is_default_action?(n.addClass("crsa-action-on"),T.showAssignedActions&&I(d,o,n,v.$element),a=!0):(n.removeClass("crsa-action-on"),T.showAssignedActions&&H(n)):n.removeClass("crsa-action-on")}),e.setHasData(a)})}),S=function(){a.whenVisible(function(){if(T.showAssignedActions&&d&&T.pluginActivated){var e=d.getPage();if(e){l&&(t=d.getAttribute(c),l.auto_selector,l.setSelectorValue(t,!0),l.setNameValue(d.getAttribute("data-pg-name"),!0),q());var t,n=e.getAllActionTypes(d),o="<ul>",a=!1;if(0===n.length&&pinegrow.dispatchEvent("on_get_default_actions",e,d,T,n),n.length)for(var i=0;i<n.length;i++)n[i].framework.show_in_action_tab==z&&(o+=K(n[i],!1),a=!0);!a&&(!l||t)?w(`<p>Click on one or more ${s}s in the list below to add them to the selected element.</p>`):w(),pgRemoveMultiselects(A.$content),J(function(){A.$content.get(0).innerHTML=o+"</ul>"}),addTooltip(A.$content.find("name span[title]"),"dummy",{use_title_attr:!0})}}},"updateAssigned",1)},E=function(e,t){var n=null,o=!1,a=d;if((d=e?pinegrow.selectedElements.getLastSelectedOnPage(e):null)!=a&&(o=!0),g=e){if(!o)if(n=e.getActionsSections(),null==u||null==n)o=!0;else if(u.length!=n.length)o=!0;else for(var i=0;i<n.length;i++)if(n[i]!=u[i]){o=!0;break}}else o=!0;(o=f&&f.isShown()?!0:o)||t?T.show(n,function(e){e&&(S(),d)&&T.updateUsage()}):(S(),T.updateUsage())},y=function(e,t){var n=pinegrow.selectedElements.getLastSelected(),o=pinegrow.getSelectedPage(),a=(j&&o&&!n&&(n=o.sourceNode.findOne("html")),null==d);d=n,g!=o?E(o):T.pluginActivated&&!T.showAssignedActions&&!a&&null!=u&&0!==u.length&&d&&_&&0!==_.length?(S(),T.updateUsage()):T.show(null,function(e){e&&(S(),T.updateUsage())}),Q()},M=(pinegrow.addEventHandler("on_selected_elements_changed",y),pinegrow.addEventHandler("on_page_selected",function(e){E(e)}),pinegrow.addEventHandler("on_project_loaded",B),pinegrow.addEventHandler("on_action_added",V),pinegrow.addEventHandler("on_action_removed",U),pinegrow.addEventHandler("on_action_clicked",D),this.refreshPanel=function(){g=null;var e=pinegrow.getSelectedPage();T.showAssignedActions||E(e,!0),y(g)},pinegrow.addEventHandler("on_action_panel_should_be_refreshed",this.refreshPanel),a.on("crsa-frameworks-changed",function(){T.refreshPanel()}),function(e,t){return t.has_action?t.has_action(e):t.attribute&&e.hasAttr(t.attribute)}),K=function(e,t){var n="",o="",a="",i="",s="";if(s="",e.framework&&e.framework.get_preview_for_action&&T.showAssignedActions&&(e.on_show_live_data&&(s+='<i class="icon icon-WP action-magic only-active" title="Import live WordPress data for this element."></i>'),s+='<i class="icon icon-KODA show-code" title="Preview the PHP code."></i>'),e.on_get_action_icons&&T.showAssignedActions&&e.on_get_action_icons(e).forEach(function(e){s=`<i class="icon ${e.icon} action-icon" title="${e.title}"></i>`+s}),s+='<i title="Remove action from the element" class="icon icon-bin remove-action only-active" title="Remove the action from the element."></i>',r&&(s='<i title="Copy action to clipboard" class="icon icon-273 copy-action"></i>'+s,e.meta)&&e.meta.helplink&&(l='<i title="Learn how to use this action..." class="icon icon-271 help-action"></i>',isApp()||(l=`<a href="${e.meta.helplink}" target="_blank" style="text-decoration: none;margin-right: 8px;">${l}</a>`),s=l+s),s="<icons>"+s+"</icons>",e.meta&&(o=e.meta.extra_name?"<small> / "+e.meta.extra_name+"</small>":"",a=e.meta.helptext||"",e.meta.helplink&&(a+='<a href="'+e.meta.helplink+'" class="external" target="_blank"><i class="icon icon-271"></i></a>'),e.meta.tags)&&e.meta.tags.length&&(i=e.meta.tags.join(" ")),h&&!t&&!e.name.match(h)&&!o.match(h))return"";m.push(e);var l=e.name,c=(!T.showAssignedActions&&e.short_name&&(l=e.short_name),"");e.meta&&e.meta.helptext&&(c=` title="`+e.meta.helptext.replace(/"/g,"'"),c+=r?"":"<br><br>Click to add to the selected element.",e.on_show_live_data&&(c+="<br><br>Supports Live data."),c+='"'),n+='<li data-action-index="'+(m.length-1)+'" data-action="'+e.type+'" class="crsa-action"><name>'+"<span"+c+">"+l+"</span>"+o+s+"</name>";return d&&M(d,e)&&0,i.length,a.length&&(n+='<p class="help-text">'+a+"</p>"),n+="</li>"},X=function(e,t,n,o){var a,i,s;t.parent();n?e.addClass("has-value"):e.removeClass("has-value"),e.hasClass("crsa-field-color")&&(a=e.find(".color-value-placeholder"),i=getStylePropWithoutImportant(n),(s=t.data("color-input"))&&0<s.length&&s.spectrum("set",i,!1),a.css("background-color","black").css("background-color",i)),"image"!=o.type&&!o.file_picker||t.trigger("pg-on-value-updated"),o.rich&&t.siblings(".crsa-select-val").data("crsa-select").paintVal()},x=[],F={};function I(_,A,a,P,b){b=b||0;function S(e){return e===_?F:getValuesForObject(e,x)}var e=A.sections?Object.values(A.sections):[],t=(A.on_before_show_fields&&A.on_before_show_fields(g,e,_,A),e.forEach(function(e){x.indexOf(e)<0&&x.push(e)}),$.each(x,function(e,o){$.each(o.fields,function(e,t){var n;"custom"===t.type&&t.control&&!t.control_defined&&(n=t.control(),o.component_definition||(o.component_definition={}),(n=n.define(o.component_definition))&&x.push(n),t.control_defined=!0)})}),_?getValuesForObject(_,e):{}),i=($.each(t,function(e,t){F[e]=t}),T.refreshValuesForSelectedElement=function(){var e;_&&(e=getValuesForObject(_,x),$.each(e,function(e,t){F[e]=t}))},A.on_action_after_get_values&&A.on_action_after_get_values(_,A,F),$("<div/>",{class:"action-fields"})),E=(e.length,[]);$.each(e,function(e,t){if(t.hasOwnProperty("show")&&!t.show||!t.name)return!0;0<e&&!t.no_section_label&&$('<div class="crsa-field crsa-field-label"><label>'+t.name+"</label></div>").appendTo(i);function n(e){var c,r=f,d=null,g=!1,u=!1,p=null,h=null,m=0;$.each(e,function(e,a){var i,s,t,n=null;if(a.start_repeat_item){if(A.max_repeat_items&&b<m&&h&&!h.hasClass("has-value"))return!1;a.add_repeat_item_label&&(v=a.add_repeat_item_label),m++,r=$('<div class="pg-action-repeat-item" data-repeat-item="'+m+'"><h5>'+a.start_repeat_item+"</h5></div>").appendTo(f),w=!0,a.reorder_repeat_items&&$(`<div class="reorder-repeat-item">
<i class="icon icon-up repeat-item-move up"></i><i class="icon icon-down repeat-item-move down"></i>
</div>`).appendTo(r.find("h5")),(1<m||a.delete_first_repeat_item)&&$('<i class="icon icon-bin remove-repeat-item"></i>').appendTo(r),c=[],r.data("repeat-item-fields",c),r.data("repeat-item-fdef",a),a.repeat_item_class&&r.addClass(a.repeat_item_class),m<=b&&r.addClass("has-value"),h=r,g=!1}a.end_section&&(r=d,g=!1),a.start_section&&(d=r,t=e+`.`+a.start_section,n=$(`<div class="pg-action-section ${C[t]?"open":""}"><h6><i class="icon icon-right"></i><i class="icon icon-down"></i> ${a.start_section}</h6><div class="fields"></div></div>`).appendTo(r),r=n.find(".fields"),g=!0,u=!1,n.on("click","h6",function(e){e.preventDefault(),n.hasClass("open")?(n.removeClass("open"),C[t]=!1):(n.addClass("open"),C[t]=!0)}),p=n),s=g,"custom"===a.type?a.control?((o=a.control()).actionsView=T,o.setObject(_),o.setValues(F,{}),o.show(P),r.append(o.$element),i=o.$element,k.push(o)):i=a.show(r,_,e,a,F):i=$.fn.crsa("addInputField",r,_,e,a,S,!1,P);var o=i.find(".crsa-input"),l=(a.on_fields_created&&E.push({func:a.on_fields_created,obj:_,field:i,def:a,name:e,default_value:a.default_value||null}),c&&c.push(e),F.hasOwnProperty(e)?F[e]:null);pinegrow.validateField(_,e,l,a,i,F),null!==l&&""!==l&&(r.addClass("has-value"),s)&&!u&&p&&(p.addClass("has-value"),u=!0),a.show_if&&(("function"==typeof a.show_if?a.show_if(F,_,i):crsaEvaluateShowIfString(a.show_if,F,a,_))?pg$Show(i,"flex"):pg$Hide(i)),X(i,o,l,a),o.on("input change",function(e){var t,n,o;"value"in e.target&&(t=e.target.value,o=$(e.target),"checkbox"===e.target.type&&(t=o.is(":checked")),X(i,o,t,a),s)&&(n=!1,(o=i.closest(".pg-action-section")).find(".crsa-field").each(function(e,t){t.classList.contains("has-value")&&(n=!0)}),n?o.addClass("has-value"):o.removeClass("has-value"))})})}var f=$("<div/>").appendTo(i),w=!1,v="Add field",o=(n(t.fields),{});g.callFrameworkHandler("on_show_action_fields",o,A,_),n(o),w&&(f.on("click",".remove-repeat-item",function(e){var t=$(this).closest(".pg-action-repeat-item"),n=t.attr("data-repeat-item"),o=t.data("repeat-item-fdef");o.on_repeat_item_removed?o.on_repeat_item_removed(T,t,o,n,F):Z(t)}),$(`<div class="pg-action-repeat-item-add"><button class="pg-button"><i class="icon icon-plus"></i> ${v}</button></div>`).appendTo(f).on("click","button",function(e){e.preventDefault();var t,n=f.find(".pg-action-repeat-item").not('.has-value,[data-repeat-item="1"]');n.length?n.first().addClass("has-value"):(t=f.find(".pg-action-repeat-item").length,!A.max_repeat_items||A.max_repeat_items<=t?pinegrow.showQuickError("Sorry, no more items are available."):J(function(){H(a),I(_,A,a,P,t+1)}))})),f.on("click",".repeat-item-move",function(e){var t=$(this).closest(".pg-action-repeat-item"),n=parseInt(t.attr("data-repeat-item")),o=this.classList.contains("up")?n-1:n+1;ee(t,n,o)})});for(var n=0;n<E.length;n++){var o=F.hasOwnProperty(E[n].name)?F[E[n].name]:null;null===o&&E[n].default_value&&(o=E[n].default_value),E[n].func(E[n].obj,E[n].name,o,E[n].def,E[n].field,F)}E=null,i.insertAfter(a.find(">name"))}var H=function(e){e.find(">.action-fields").remove()},N=function(e){return m[parseInt(e.attr("data-action-index"))]},L=function(o){n.find("li.crsa-action").each(function(e,t){var n=$(t);if(o==N(n))return pgScrollToItemInContainer(n,v.$element,!1,!1,null,-10),pg$Flash(n,"orange_border_flash"),(n=n.find("input")).length&&n.get(0).focus(),!1})},Y=(this.highlightAction=L,v.$element.on("contextmenu","name",function(e){e.stopPropagation(),e.preventDefault();var t,n=$(this).closest("li"),o=N(n),n=new CrsaContextMenu(null,n),a=d.getName(),i="<b>"+o.name+"</b>";return d?(M(d,o)?(n.add("Remove action from selected element",null,null,"header"),n.add("Remove "+i+" from <b>"+a+"</b>",null,function(){Y($(this))})):(n.add("Add action to selected element",null,null,"header"),n.add("Add "+i+" to <b>"+a+"</b>",null,function(){$(this).closest("name").click()}),o.not_placeable&&pgf.edit_html&&(n.add("",null,null,"divider"),n.add("Can't create new HTML element: "+o.not_placeable,null,null,"header"))),!o.not_placeable&&o.code&&pgf.edit_html&&(t=crsaFuncs.findActionMenuForInsertingDefIntoEl(o,d),n.add("",null,null,"divider"),n.add("Create new HTML element with this action",null,null,"header"),n.add("Prepend to <b>"+a+"</b>",null,function(){crsaFuncs.insertThroughActionMenu(t,null,o,!1,!0)}),n.add("Append to <b>"+a+"</b>",null,function(){crsaFuncs.insertThroughActionMenu(t,null,o,!1,!1)}),n.add("Insert before <b>"+a+"</b>",null,function(){crsaFuncs.insertBeforeOrAfter(null,o,!1,!1)}),n.add("Insert after <b>"+a+"</b>",null,function(){crsaFuncs.insertBeforeOrAfter(null,o,!1,!0)}),n.add("Replace <b>"+a+"</b>",null,function(){crsaFuncs.replaceElement(null,o)}))):pgf.edit_html&&n.add("First select an existing element on the page and then use the right click to place the new element.",null,function(){},"header"),n.showAt(e.pageX,e.pageY,v.$element),!1}),v.$element.on("click","i.show-code",function(e){var t,n;d&&(t=$(this).closest("li"),n=N(t),pinegrow.hidePreview(),e.preventDefault(),e.stopImmediatePropagation(),d.getPage().callFrameworkHandler("on_action_show_code_clicked",d,n,t))}),v.$element.on("click","i.remove-action",function(e){Y($(this),null,null,!0),e.preventDefault(),e.stopImmediatePropagation()}),v.$element.on("click","i.copy-action",function(e){e.preventDefault(),e.stopImmediatePropagation();var t=$(this).closest("li"),t=N(t);pinegrow.clipboard.copySpecial("actions",[{def:t,values:t.getActionValuesForPgel(d)}])}),isApp()&&v.$element.on("click","i.help-action",function(e){e.preventDefault(),e.stopImmediatePropagation();var t=$(this).closest("li"),t=N(t);pinegrow.openExternalUrl(t.meta.helplink)}),v.$element.on("click","i.action-magic",function(e){var t,n,o;d&&(t=d.getPage(),n=$(this).closest("li"),o=N(n),e.preventDefault(),e.stopImmediatePropagation(),d&&M(d,o)?t.callFrameworkHandler("on_action_magic_clicked",d,o,n):t.callFrameworkHandler("on_action_magic_preview_clicked",d,o,function(e){e&&pgPreview.show(n,e,"actions-preview",300)}))}),v.$element.on("click","i.action-icon",function(e){var t,n,o;return d&&(t=$(this),n=t.closest("li"),(o=N(n)).on_get_action_icons)&&o.on_get_action_icons(o).forEach(function(e){t.hasClass(e.icon)&&e.func(d,o,n)}),!1}),v.$element.on("click","name",function(e){var t,n;"I"!==e.target.tagName&&"A"!==e.target.tagName&&(e.preventDefault(),e.stopImmediatePropagation(),d?(n=(t=$(this)).closest("li"),(n=N(n)).on_before_add_action&&n.on_before_add_action(d,n),Y(t,!0,n)):pinegrow.showQuickError("Please select an element on the page first, then assign action to it."))}),function(e,r,t,d){var g,u,p=e.closest("li"),h=t||N(p),m=(p.position().top,pinegrow.getCollection()),f=new PgCollection,w={};m.forEachElement(function(e,t,n){var o,a,i,s,l,c;e&&(o=e.getName(),a=new pgParserSourceProblem(e,null,!!h.ignore_lock),i=e.getPage(),e||a.add("element",o,"change"),a.ok()?M(e,h)?r?0==t&&(T.showAssignedActions?pinegrow.showQuickMessage('Use <i class="icon icon-bin"></i> icon to remove the action from the element.',4e3,!1,"error"):i.callFrameworkHandler("on_action_clicked",h,{source:T})):canMakeChange(e,"remove_action",h)&&(willMakeChange(i,"Remove action / "+h.name),u="Remove action / "+o,w.action_removed=h,c=$.fn.crsa("removeActionFromElement",e,h,i),g=g||"Action <b>"+h.name+"</b> was removed from <b>"+m.getName()+"</b>",c!=e&&!1||(T.showAssignedActions&&H(p),p.removeClass("crsa-action-on")),f.add(e)):d||(s=!0,(s=!h.on_can_add_action||h.on_can_add_action(e,i,h)?s:!1)&&(i.callFrameworkHandler("on_can_add_action",e,h,l={can_add:!0}),s=l.can_add),s&&(w.action_added=h,canMakeChange(e,"add_action",h))&&(willMakeChange(i,"Add action / "+o),u="Add action / "+h.name,g=g||"Action <b>"+h.name+"</b> was added to <b>"+m.getName()+"</b>",(c=$.fn.crsa("addActionToElement",e,h,i))!=e&&!1||(T.showAssignedActions&&I(e,h,p,p.closest(".content")),p.addClass("crsa-action-on")),f.add(e),pinegrow.stats.using("action."+h.type||"unknown"))):showAlert(a.toString(),"Can't edit this element"))}),0<f.getLength()&&pinegrow.changeManager.didChange(m,u,w),g&&pinegrow.showQuickMessage(g)}),J=function(e){var t=v.$element,n=t.scrollTop();e(),t.scrollTop(n)},Z=(this.scrollTo=function(e){(e="string"==typeof e?v.$element.get(0).querySelector(e):e)&&pgScrollToItemInContainer($(e),v.$element,!1,!0)},function(e){var d,g=e.closest("li"),u=N(g),t=g.position().top,p=(e.attr("data-repeat-item"),e.data("repeat-item-fields")),h=10,n=(u.max_repeat_items&&(h=u.max_repeat_items),pinegrow.getCollection()),m=new PgCollection,f=!1,o=(n.forEachElement(function(t,e,n){var o=t.getName(),a=(new pgParserSourceProblem(t,null,!!u.ignore_lock),t.getPage()),i=!0;if((i=!u.on_can_add_action||u.on_can_add_action(t,a,u)?i:!1)&&canMakeChange(t,"add_action",u)){willMakeChange(a,"Edit action / "+o),d="Edit action / "+u.name,p.forEach(function(e){t.removeAttribute(e)});function s(e,t){return 1===t?e:e+"-"+t}var l=!1;for(u.delete_first_repeat_item;1;){for(var l=!1,c=1;c<h;c++){var r=!1;p.forEach(function(e){e=e.replace(/-[0-9]+$/,""),t.hasAttribute(s(e,c))&&(f=r=!0)}),r||p.forEach(function(e){e=e.replace(/-[0-9]+$/,""),t.hasAttribute(s(e,c+1))&&(t.setAttribute(s(e,c),t.getAttribute(s(e,c+1))),t.removeAttribute(s(e,c+1)),l=!0)})}if(!l)break}f?I(t,u,g,g.closest(".content")):pinegrow.selectedElements.reselect(),m.add(t)}}),T.showAssignedActions&&(g.closest(".assigned-actions").length?S:b)(),g.position().top),a=v.$element,i=a.scrollTop();a.scrollTop(i-=t-o),0<m.getLength()&&pinegrow.changeManager.didChange(n,d)}),ee=function(e,l,c){var r,d,t,n,o,g=e.closest("li"),u=N(g),a=g.position().top,p=e.data("repeat-item-fields"),i=pinegrow.getCollection(),h=new PgCollection;c<0?pinegrow.showQuickError("The item is already at the top."):(d=function(e,t){return 1===t?e:e+"-"+t},i.forEachElement(function(o,e,t){var n,a=o.getName(),i=(new pgParserSourceProblem(o,null,!!u.ignore_lock),o.getPage()),s=!0;(s=!u.on_can_add_action||u.on_can_add_action(o,i,u)?s:!1)&&canMakeChange(o,"add_action",u)&&(willMakeChange(i,"Reorder action / "+a),r="Reorder action / "+u.name,n=!1,p.forEach(function(e){e=e.replace(/-[0-9]+$/,""),o.hasAttribute(d(e,c))&&(n=!0)}),n?((s=function(t,n){p.forEach(function(e){e=e.replace(/-[0-9]+$/,""),o.hasAttribute(d(e,t))&&(o.setAttribute(d(e,n),o.getAttribute(d(e,t))),o.removeAttribute(d(e,t)))})})(l,999),s(c,l),s(999,c),I(o,u,g,g.closest(".content")),h.add(o)):pinegrow.showQuickError("The item is already at the bottom."))}),T.showAssignedActions&&(g.closest(".assigned-actions").length?S:b)(),t=g.position().top,o=(n=v.$element).scrollTop(),n.scrollTop(o-=a-t),0<h.getLength()&&pinegrow.changeManager.didChange(i,r))};a.onDestroy=function(){T.show(null),pinegrow.removeEventHandler("on_action_added",V),pinegrow.removeEventHandler("on_action_removed",U),pinegrow.removeEventHandler("on_action_clicked",D),pinegrow.removeEventHandler("on_project_loaded",B)}};