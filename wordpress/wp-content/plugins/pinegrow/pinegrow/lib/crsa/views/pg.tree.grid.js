var PgTableGrid=function(t){function i(t){for(var e=0;e<c.length;e++)if(c[e].data===t){c[e].data=null;break}}function a(t){var a,s,l,n=t?-1:1;S!==n&&(s=a=null,O=B,S=n,l=function(t){var e,i;s=a?(e=d.getScrollOffset(),i=(O=Math.min(O*(1+.75*((t-s)/1e3)),N))*(t-s)/1e3,d.$element.scrollTop(e.top+i*n),t):a=t,L=requestAnimationFrame(l)},L=requestAnimationFrame(l))}var h,r,l,d=this,c=(t=$.extend({},{highlightLevels:!0},t),[]),u="default",Y=1,g=(this.data=[],this.visibleData=[],this.delayedTasks=new PgDelayedTasks,this.draggable=!0,0),v=0,s=0,n=0,o=(this.cellHeight=26,this.variableHeight=!1,this.levelPadding=18,this.inlineRowGap=4,this.$element=$('<div class="pg-table-grid"></div>'),this.$container=$('<div class="pg-table-grid-container"></div>').appendTo(this.$element),{}),p=(this.setTemplate=function(t,e){o[e||u]=t},$('<div class="pg-table-grid-item-border"></div>')),f=null,D=(t.highlightLevels&&(f=$('<div class="pg-table-grid-level-border"></div>').appendTo(this.$container)),-1),m=null,b=0,e=(this.onRepaint=null,this.getContentWidth=function(){return s},this.getVScrollBarSize=function(){var t=this.$element.get(0);return t.scrollHeight>t.clientHeight?10:0},this.getHScrollBarSize=function(){var t=this.$element.get(0);return t.scrollWidth>t.clientWidth?10:0},this.highlightChildren=function(t){var e;f&&(t?(e=t.level+1,f.css({left:e*this.levelPadding+"px",top:this.getYForVisibleDataIndex(t.visible_idx)+this.cellHeight+"px",height:(this.getVisualHeightOfData(t)-1)*this.cellHeight+"px"})):f.css({left:"-8px",top:"0px",height:"0px"}))},this.highlightLevel=function(t,e){if(f)if(t<0||t>=this.visibleData.length)f.css({left:"-8px",top:"0px",height:"0px"});else{var i=this.visibleData[t],i=(e>=i.level&&(e=i.level-1),this.getParentWithLevel(t,Math.max(0,e)));if(!i)return this.highlightLevel(-1);f.css({left:(i.level+1)*this.levelPadding+"px",top:this.getYForVisibleDataIndex(i.visible_idx)+this.cellHeight+"px",height:(this.getVisualHeightOfData(i)-1)*this.cellHeight+"px"})}},this.borderItem=function(t,e,i){return e=e||!1,m&&!t?p.detach():t&&!m&&p.appendTo(this.$container),(m=t)&&"visible_idx"in t&&(void 0!==i?b=i:(b=1+l.getNumberOfDescendants(t.visible_idx,this.visibleData),e?D>=t.visible_idx&&D<=t.visible_idx+b&&b++:D>t.visible_idx&&D<t.visible_idx+b&&b++),this.updateBorder()),p},this.updateBorder=function(){var t,e,i,a;m&&(e=(t=this.getYForVisibleDataIndex(m.visible_idx))+b*this.cellHeight,i=m.level*this.levelPadding,a=s,t<h&&(t=h-10),r<e&&(e=r+10),p.css({left:i+"px",top:t+"px",width:a-i+"px",height:e-t+1+"px"}))},this.quickInsertLine=new function(s){var l,n,o,h=$('<div class="pg-tree-quick-insert-line"></div>');h.appendTo(s.$container),pg$Hide(h);this.show=function(t,e,i){var a;l!=t&&(l=t,o=e,n=i,a=this,fastdom.mutate(function(){(l?pg$Show:pg$Hide)(h),a.update()}))},this.hide=function(){this.show(null)},this.update=function(){var t,e,i,a;l&&l.visible_idx<s.visibleData.length&&(t=o*s.levelPadding,e=s.getYForVisibleDataIndex(l.visible_idx),i=1,a=s.getContentWidth()-t,"bottom"===n?e+=s.cellHeight:"right"===n&&(a=2,i=s.getCellHeightForData(l),t=s.getXForVisibleData(l),t+=s.getCellWidthForData(l)),h.css({left:t+"px",top:e+"px",width:a+"px",height:i+"px"}))}}(this),null),_=(this.getScrollOffset=function(){return e=null===e?{top:this.$element.scrollTop(),left:this.$element.scrollLeft()}:e},this.updateDataIndexes=function(t){for(var e=0,i=(this.visibleData=[],0),a=0,s=t=void 0===t?0:t;s<this.data.length;s++){this.data[s].idx=s;var l=!1;0<e&&(this.data[s].level>=e?l=!0:e=0),0===e&&this.data[s].collapsed&&(e=this.data[s].level+1),(l=3===(this.data[s].search||1)?!0:l)||(this.visibleData.push(this.data[s]),this.data[s].visible_idx=i++,this.data[s].level>a&&(a=this.data[s].level)),this.data[s].hidden=l}n=a},this.onSetDataToCell=function(t,e){},null),x=(this.$element.on("scroll",function(t){h=d.$element.scrollTop(),e=null,d.showCells(),_?clearTimeout(_):d.inScroll=!0,_=setTimeout(function(){d.inScroll=!1,_=null},500),d.onScroll&&d.onScroll()}),this.getHelper=function(){return l},this.setData=function(t){c.forEach(function(t){t.setData(null)}),this.data=t,l=new PgTreeDataHelper(this.data),this.updateDataIndexes(),this.variableHeight&&this.calculatePositionsForVisibleCells(),this.onSetData&&this.onSetData(this),this.borderItem(null),this.show(),this.highlightLevel(-1),this.onRepaint&&this.onRepaint()},this.getContainerHeight=function(){if(this.variableHeight){let t=0;return 0<this.visibleData.length&&(t=this.getYForVisibleDataIndex(this.visibleData.length-1)+this.getCellHeightForData(this.visibleData[this.visibleData.length-1])),0<=D&&(t+=this.cellHeight),t}return(this.visibleData.length+(0<=D?1:0))*this.cellHeight},this.updateContainerSize=function(){this.$container.css({height:this.getContainerHeight()+"px",width:s+"px"})},this.refresh=function(){var t=this.getScrollOffset(),e=m;this.setData(this.data),this.borderItem(e),this.$element.scrollTop(t.top),this.$element.scrollLeft(t.left),0<t.top&&this.showCells()},this.show=function(){this.updateLayout(),this.updateContainerSize(),this.showCells()},this.updateLayout=function(){g=this.$element.innerWidth(),v=this.$element.innerHeight();var t=this.getContainerHeight();s=Math.max(g-(v<t?10:0),n*this.levelPadding+g),h=this.$element.scrollTop()},this.getCellForData=function(t){for(var e=0;e<c.length;e++)if(c[e].data===t)return c[e];return null},this.createCellForData=function(t){var e=t.template_type||u,e="function"==typeof o[e]?new o[e](e,!this.draggable):new PgTableGridCell(o[e],e,!this.draggable);return e.tableGrid=this,e},this.forEachCellOfDataAndDescendants=function(t,e){for(var i=l.getNumberOfDescendants(t.visible_idx,this.visibleData)+t.visible_idx+1,a=t.visible_idx;a<i;a++){var s=this.getCellForData(this.visibleData[a]);s&&e(s)}},this.forEachDataAndDescendants=function(t,e){for(var i=l.getNumberOfDescendants(t.idx,this.data)+t.idx+1,a=t.idx;a<i;a++)e(this.data[a])},this.forEachVisibleChild=function(t,e){for(var i=t.visible_idx+1;i<this.visibleData.length&&!(this.visibleData[i].level<=t.level);i++)this.visibleData[i].level===t.level+1&&e(this.visibleData[i])},this.hasChildren=function(t){return t.idx+1<this.data.length&&this.data[t.idx+1].level===t.level+1},this.forEachVisibleSibling=function(t,e){var i=this.getVisibleParent(t);if(i)this.forEachVisibleChild(i,e);else for(var a=0;a<this.visibleData.length;a++)0===this.visibleData[a].level&&this.visibleData[a]!==t&&e(this.visibleData[a])},this.getXForVisibleData=function(t){return d.variableHeight?t.pos_x:t.level*d.levelPadding}),k=(this.showCells=function(){r=h+v/Y;var t,e,i,a={},s={},l=(c.forEach(function(t){t.data&&!t.data.hidden&&d.isDataIndexVisible(t.visible_data_idx)?(t.showAt(x(t.data),d.getYForVisibleDataIndex(t.visible_data_idx),d.$container,t.data.cellWidth||0,t.data.cellHeight||0),s[t.visible_data_idx]=!0):(a[t.type]||(a[t.type]=[]),a[t.type].push(t))}),this.getVisibleDataIndexForY(Math.max(h-this.cellHeight,0)));let n=Math.min(this.getVisibleDataIndexForY(r),this.visibleData.length-1);(0<=n||0<=l)&&(n<l||n<0)&&(n=this.visibleData.length-1);for(let o=l;o<=n;o++)0<=o?(o in s||(i=(t=this.visibleData[o]).template_type||u,a[i]&&a[i].length?e=a[i].pop():(e=this.createCellForData(t),c.push(e)),i=this.getYForVisibleDataIndex(o),function(t,e){e.getFastDomTask().mutate(function(){d.onSetDataToCell(t,e)})}(t,e),e.$element.attr("data-visible-idx",o),e.setData(t),e.visible_data_idx=o,e.showAt(x(t),i,this.$container,e.data.cellWidth||0,e.data.cellHeight||0)),this.getCellHeightForData(t||this.visibleData[o])):this.cellHeight;$.each(a,function(t,e){e.forEach(function(t){t.hide(),t.onHidden&&t.onHidden(t)})}),this.updateBorder(),this.quickInsertLine.update()},this.getCellWidthForData=function(){return 0},this.getCellHeightForData=function(){return this.cellHeight},this.cellSizeForDataChanged=function(t){var e=this.visibleData.indexOf(t);if(0<=e){for(var i=e;i<this.visibleData.length;i++)this.visibleData[i].has_pos=!1;this.calculatePositionsForVisibleCells(e)}},this.calculatePositionsForVisibleCells=function(t,e){var i=new CrsaProfile("calculatePositionsForVisibleCells");void 0===e&&(e=this.visibleData.length-1);let a=0,s=0,l=0,n=!1;var o,h=g-20;if(0<(t=void 0===t?0:t)){for(;0<t&&!this.visibleData[t-1].has_pos;)t--;0<t&&(o=this.visibleData[t-1],a=o.pos_y+this.getCellHeightForData(o),s=o.pos_x+this.getCellWidthForData(o))}for(let u=t;u<=e;u++){var r=this.visibleData[u],d=this.getCellWidthForData(r),c=this.getCellHeightForData(r);0===d||s+d>h?(a+=l,s=r.level*this.levelPadding,l=c,r.pos_x=s,r.pos_y=a,n=0!==d,s+=d+this.inlineRowGap):(n||(a+=l,s=r.level*this.levelPadding),r.pos_x=s,r.pos_y=a,s+=d+this.inlineRowGap,l=c,n=!0),last_w=d,r.has_pos=!0}i.show("done")},this.getVisibleDataIndexForY=function(i,a){if(this.variableHeight){let t=-1;for(let e=0;e<this.visibleData.length;e++){var s=this.visibleData[e];if(s.pos_y<=i&&s.pos_y+this.getCellHeightForData(s)>=i){if(t=e,a)return e}else if(s.pos_y>i&&0<=t)return t}return t}var t=Math.floor(i/this.cellHeight);if(0<=D){if(D===t)return-2;D<t&&t--}return t<this.visibleData.length?t:-1},this.getYForVisibleDataIndex=function(t){return this.variableHeight?this.visibleData[t].pos_y:(0<=D&&D<=t&&t++,t*this.cellHeight)},this.getDataFor$Element=function(t){var e=t.attr("data-visible-idx");return null!==e&&e<this.visibleData.length?this.visibleData[e]:null},this.getVisibleParent=function(t){for(var e=t.visible_idx-1;0<=e;){if(this.visibleData[e].level<t.level)return this.visibleData[e];e--}return null},this.isDataIndexVisible=function(t,e){var i,a,s,l;return null!==t&&(i=e?-1:1,a=this.getYForVisibleDataIndex(t),this.variableHeight?(s=this.getVisibleDataIndexForY(h-this.cellHeight*i),l=this.getVisibleDataIndexForY(r+i*this.cellHeight),s<=t&&(-1===l||t<=l)):a>h-i*this.cellHeight&&a<r+i*this.cellHeight)},this.scrollTo=function(t){this.delayedTasks.cancel("scrollToDelayed"),this.isDataIndexVisible(t.visible_idx,!0)||(e=this.getYForVisibleDataIndex(t.visible_idx),this.$element.scrollTop(Math.round(e-.2*v)));var e=this.$element.width(),i=this.$element.scrollLeft(),a=t.level*this.levelPadding,s=Math.floor(e/2),l=3*this.levelPadding;(i+e-s<a||a<i)&&this.$element.scrollLeft(a-l)},this.updateItem=function(t){i(t),this.isDataIndexVisible(t?.visible_idx)&&this.showCells()},this.updateItems=function(t){var e=!1;t.forEach(function(t){i(t),e=e||d.isDataIndexVisible(t.visible_idx)}),e&&this.showCells()},this.refreshDelayed=function(){nextFrame.do("tree-refresh",this.refresh)},this.scrollToDelayed=function(t){G(),this.delayedTasks.run("scrollToDelayed",function(){d.scrollTo(t)},1)},this.getNumberOfDescendants=function(t,e){var i=0,a=e[t].level;for(t++;t<e.length&&e[t].level>a;)i++,t++;return i},this.getVisualHeightOfData=function(t){var e=l.getNumberOfDescendants(t.visible_idx,this.visibleData),i=e+1;return D>t.visible_idx&&D<=t.visible_idx+e&&i++,i},this.getParentWithMinLevel=function(t,e){this.visibleData[t].level;for(var i=null;1<=t&&!(this.visibleData[--t].level<e);)(!i||i.level>this.visibleData[t].level)&&(i=this.visibleData[t]);return i},this.getParentWithLevel=function(t,e){for(;1<=t;)if(this.visibleData[--t].level===e)return this.visibleData[t];return null},0),y=null,T=(this.dragStarted=function(t){y=t,this.forEachCellOfDataAndDescendants(t,function(t){t.setOpacity(.5)})},this.dragStopped=function(){y&&this.forEachCellOfDataAndDescendants(y,function(t){t.setOpacity(1)}),w=y=null,this.setEmptyLineAt(-1),this.showInsertionLineAt(-1),this.borderItem(null),G()},null),w=null,V=(this.getDragPos=function(){return w},this.getDragInfo=function(i){function t(){var t,e;return w?(e={level_offset:t=Math.round((i.left-k)/d.levelPadding)},!l.force_parent&&M(y,w.idx,w.orig_level+t,e)?w.level=w.orig_level+t:"ok_level"in e&&(w.level=e.ok_level),V(w)):null}var e,a,s,l={force_parent:null},n=(0&&pinegrow.keyState.shift,this.getVisibleDataIndexForY(i.top));if(-2==n&&T&&(e=T.data,T.position,0),0<=n){if((e=this.visibleData[n]).no_sort)return null;if(l.force_parent){if(!e.pgel)return null;if(!e.pgel.isDescendantOf(l.force_parent))return null;if(!e.pgel.isChildOf(l.force_parent))return null}var o=this.getYForVisibleDataIndex(n);this.lineHeight;if(e!==y&&o+this.getCellHeightForData(e)/2<i.top){if(this.visibleData.length===n+1)return w&&w.idx===n+1?t():(w={data:e,idx:n+1,level:e.level,orig_level:e.level,on_self:!1,position:"bottom"},e.pgel&&"body"===e.pgel.tagName&&(w.position="inside-bottom",w.level++,w.orig_level++),w);e=this.visibleData[++n]}}else if(-1===n)return n=this.visibleData.length-1,w&&w.idx===n?t():((e=this.visibleData[n]).pgel&&"body"!==e.pgel.tagName&&(e=this.getVisibleParent(e)),w={data:e,idx:n+1,level:e.level+1,orig_level:e.level+1,on_self:!1,position:"inside-bottom"});if(e)return 0<=n?w&&w.idx===n?t():(o=this.visibleData.length>n?this.visibleData[e.visible_idx]:null,s=0<=n-1?this.visibleData[n-1]:null,k=i.left,e==y?(w={idx:n,level:e.level,orig_level:e.level,on_self:!0},V(w)):o==y||s==y?T:(w={idx:n,level:e.level,orig_level:e.level},s&&(!o||o.level<=s.level)?(a={data:s,position:"bottom"},w.level=s.level,w.orig_level=s.level):a={data:e,position:"top"},a)):-2==n?t():null},this.canChangeLevel=function(t,e){var i=y,a=M(y=t,t.visible_idx,e,{});return y=i,a},function(t){var e,i,a;return t&&(e=C(t.idx),a={},(i=0<=t.idx-1?d.visibleData[t.idx-1]:null)&&i.level==t.level?(a.data=i,a.position="bottom"):e&&e.level==t.level?(a.data=e,a.position="top"):i&&i.level+1==t.level?(a.data=i,a.position="inside-top"):(!e||e&&e.level<t.level)&&(a.data=d.getParentWithLevel(t.idx,t.level),a.position="bottom"),a.data)?a:null}),M=function(t,e,i,a){var s=C(e),l=0<=e-1?d.visibleData[e-1]:null;return!((!l||i!=l.level+1)&&(l&&i==l.level?s&&s.level>i:l&&i>l.level+1?(a.ok_level=l.level+1,1):s&&!(s.level<=i)&&(a.ok_level=s.level,1)))},C=function(t,e){e=e||y;var i,a=d.visibleData.length>t?d.visibleData[t]:null;for(a&&e==a&&(i=l.getNumberOfDescendants(e.visible_idx,d.visibleData),a=d.visibleData.length>t+1+i?d.visibleData[t+1+i]:null);a&&e&&e.selected&&a.level==e.level&&a.selected;)a=C(a.visible_idx,a);return a},H=(this.setEmptyLineAt=function(t){D!=t&&(D=t,this.showCells())},this.$insertionLine=$('<div class="pg-table-grid-insertion-line"></div>')),P=!1,A=-1,I=0,E=0,X=(this.showInsertionLineAt=function(t,e,i){return void 0===i&&(i=0),A===t&&e===I&&E===i||(A=t,I=e,E=1,this.updateInsertionLine()),H},this.getYForInsertionLine=function(){return 0!==A&&0<A?this.getYForVisibleDataIndex(A-1)+this.getCellHeightForData(this.visibleData[A-1]):0},this.updateInsertionLine=function(){A<0?P&&(H.detach(),P=!1):(P||(P=!0,H.appendTo(this.$container)),H.css({top:this.getYForInsertionLine()+"px",left:I*this.levelPadding+"px",width:s-I*this.levelPadding+"px",height:(E?E*this.cellHeight:1)+"px"}))},this.showInsertionPoint=function(t){var e;t?"level_change"in t?this.showInsertionLineAt(t.dragged_data.visible_idx,t.dragged_data.level+t.level_change,1):((e="inside-top"!=t.position&&"inside-bottom"!=t.position&&this.getVisibleParent(t.data)||t.data).level,X(t),w.on_self?this.setEmptyLineAt(-1):this.setEmptyLineAt(w.idx),this.showInsertionLineAt(w.idx,w.level),this.highlightChildren(e)):(this.showInsertionLineAt(-1,0),this.borderItem(null))},function(t){var e=-1;switch(t.position){case"inside-top":e=t.data.visible_idx+1;break;case"inside-bottom":e=t.data.visible_idx+1+l.getNumberOfDescendants(t.data.visible_idx,d.visibleData);break;case"left":case"top":e=t.data.visible_idx;break;case"bottom":case"right":e=t.data.visible_idx+1+l.getNumberOfDescendants(t.data.visible_idx,d.visibleData)}return e}),F=null,W=50,B=100,N=500,O=100,L=null,S=null,G=this.stopAutoScroll=function(){L&&(cancelAnimationFrame(L),S=L=null),F&&(clearTimeout(F),F=null)};this.dragOver=function(t){var e=this.getScrollOffset(),i=1e3,i=(F&&(clearTimeout(F),F=null,G()),0<e.top&&t.top<W?F=setTimeout(function(){a(!0)},i):t.top>v-W&&(F=setTimeout(function(){a()},i)),t.top+=e.top,t.left+=e.left,this.getDragInfo(t));return(T=i)||null},this.destroy=function(){c.forEach(function(t){t.destory()}),c=[]}},pgTableGridCellCount=0,PgTableGridCell=function(t,e,i){t&&this.init(t,e,i)},PgMouseSpeed=(PgTableGridCell.prototype.init=function(t,e,i){this.type=e,this.data=null,this.data_idx=0,this.visible_data_idx=0,this.opacity=1,this.tableGrid=null,this.fastDomTaskId="gridCell"+pgTableGridCellCount++,this.$element=$(t).addClass("pg-table-grid-cell pg-table-grid-cell-"+e),i||this.$element.attr("draggable","true"),this.dataElements={},this.shown=!1;var a=this;this.$element.find("[data-element]").add(this.$element).each(function(t,e){a.dataElements[e.getAttribute("data-element")]=e}),this.eventHandlers=[],this.tooltips=[],this.cache={}},PgTableGridCell.prototype.update=function(){this.tableGrid.updateItem(this.data)},PgTableGridCell.prototype.on=function(t,e,i){this.dataElements[t].addEventListener(e,i),this.eventHandlers.push({key:t,event:e,handler:i})},PgTableGridCell.prototype.tooltip=function(t,e){this.tooltips.indexOf(t)<0&&(addTooltip($(this.dataElements[t]),e,{use_title_attr:"data-pg-title"}),this.tooltips.push(t)),this.setAttribute(t,"data-pg-title",e)},PgTableGridCell.prototype.getFastDomTask=function(){return pgFastdomTasks.create(this.fastDomTaskId)},PgTableGridCell.prototype.setData=function(t){this.data=t,this.setOpacity(1)},PgTableGridCell.prototype.onPopulate=function(){},PgTableGridCell.prototype.showAt=function(t,e,i,a,s){this.shown||(this.$element.appendTo(i),this.shown=!0);var l=this.$element.get(0);pgPositionAt(l,t,e),a&&(l.style.width=a+"px"),s&&(l.style.height=s+"px")},PgTableGridCell.prototype.hide=function(){this.setData(null),this.shown&&(this.$element.detach(),this.shown=!1)},PgTableGridCell.prototype.setText=function(t,e){var i=t+"__text";i in this.cache&&this.cache[i]===e||(this.dataElements[t].textContent=e,this.cache[i]=e)},PgTableGridCell.prototype.setHtml=function(t,e){var i=t+"__html";i in this.cache&&this.cache[i]===e||(this.dataElements[t].innerHTML=e,this.cache[i]=e)},PgTableGridCell.prototype.invalidateHtml=function(t){delete this.cache[t+"__html"]},PgTableGridCell.prototype.addClass=function(t,e,i,a,s){this.dataElements[t]&&this.dataElements[t].classList.add(e,i,a,s)},PgTableGridCell.prototype.removeClass=function(t,e,i,a,s){this.dataElements[t]&&this.dataElements[t].classList.remove(e,i,a,s)},PgTableGridCell.prototype.setAttribute=function(t,e,i){var a=t+"__attr_"+e;a in this.cache&&this.cache[a]===i||(this.dataElements[t].setAttribute(e,i),this.cache[a]=i)},PgTableGridCell.prototype.getElement=function(t){return this.dataElements[t]},PgTableGridCell.prototype.showElement=function(t,e){var i=t+"__vis";i in this.cache&&!0===this.cache[i]||(pgShow(this.dataElements[t],e||"block"),this.cache[i]=!0)},PgTableGridCell.prototype.hideElement=function(t){var e=t+"__vis";e in this.cache&&!1===this.cache[e]||(pgHide(this.dataElements[t]),this.cache[e]=!1)},PgTableGridCell.prototype.setOpacity=function(t){this.opacity!==t&&this.$element.css("opacity",t),this.opacity=t},PgTableGridCell.prototype.destroy=function(){const e=this;this.eventHandlers.forEach(function(t){e.dataElements[t.key].removeEventListener(t.event,t.handler)}),this.eventHandlers=null,this.tooltips.forEach(function(t){$(e.dataElements[t]).tooltip("destroy")}),this.tooltips=null,this.data=null,this.$element.remove(),this.$element=null,this.dataElements=null},function(){var a,s=null,l=null,n=null,o=(this.speedX=0,this.speedY=0,this);this.track=function(t){a&&clearTimeout(a);var e,i=(new Date).getTime();(null===n||0<(e=(i-n)/1e3)&&(this.speedX=(t.pageX-s)/e,this.speedY=(t.pageY-l)/e,1<e))&&(n=i,s=t.pageX,l=t.pageY),a=setTimeout(function(){n=a=null,o.speedX=0,o.speedY=0},200)},this.getSpeedX=function(){var t="";return 0<this.speedX?t="right":this.speedX<0&&(t="left"),20<Math.abs(this.speedX)&&(t+="-fast"),console.log(this.speedX,t),t}}),PgNextFrame=function(){var i={};this.do=function(t,e){i[t]&&cancelAnimationFrame(i[t]),i[t]=requestAnimationFrame(function(){delete i[t],e()})},this.cancel=function(t){i[t]&&(cancelAnimationFrame(i[t]),delete i[t])},this.cancelAll=this.destory=function(){$.each(i,function(t,e){cancelAnimationFrame(e)}),i={}}},PgTreeDataHelper=(window.nextFrame=new PgNextFrame,function(t){this.data=t}),pgDragHelperObjectId=(PgTreeDataHelper.prototype.removeItem=function(t,e){var i=this.getNumberOfDescendants(t.idx,this.data)+1;if(e)for(var a=Math.min(this.data.length,t.idx+i),s=t.idx;s<a;s++)e(this.data[s]);this.data.splice(t.idx,i)},PgTreeDataHelper.prototype.getNumberOfDescendants=function(t,e){var i=0,a=(e=e||this.data)[t].level;for(t++;t<e.length&&e[t].level>a;)i++,t++;return i},PgTreeDataHelper.prototype.removeIfAlreadyInData=function(t,e){var i=this.data.indexOf(t[0]);return 0<=i&&(this.data.splice(i,t.length),i<e)&&(e-=t.length),e},PgTreeDataHelper.prototype.updateLevels=function(t,e){var i=t[0].level;t.forEach(function(t){t.level=t.level-i+e})},PgTreeDataHelper.prototype.insertAfter=function(t,e){var i=this.removeIfAlreadyInData(e,t.idx);this.updateLevels(e,t.level),this.data.splice.apply(this.data,[i+this.getNumberOfDescendants(i,this.data)+1,0].concat(e))},PgTreeDataHelper.prototype.insertBefore=function(t,e){var i=this.removeIfAlreadyInData(e,t.idx);this.updateLevels(e,t.level),this.data.splice.apply(this.data,[i,0].concat(e))},PgTreeDataHelper.prototype.findIndexOfChild=function(t,e,i){for(var a=-1,s=t.idx+1;s<this.data.length;s++)if(i&&i[0]===this.data[s])s+=i.length-1;else if(this.data[s].level===t.level+1){if(++a===e)return s}else if(this.data[s].level<=t.level)return s;return this.data.length},PgTreeDataHelper.prototype.insertAtIndex=function(t,e,i){var a=this.findIndexOfChild(t,i,e),a=this.removeIfAlreadyInData(e,a);this.updateLevels(e,t.level+1),this.data.splice.apply(this.data,[a,0].concat(e))},PgTreeDataHelper.prototype.append=function(t,e){var i=this.removeIfAlreadyInData(e,t.idx);this.updateLevels(e,t.level+1),this.data.splice.apply(this.data,[i+this.getNumberOfDescendants(i,this.data)+1,0].concat(e))},PgTreeDataHelper.prototype.prepend=function(t,e){var i=this.removeIfAlreadyInData(e,t.idx);this.updateLevels(e,t.level+1),this.data.splice.apply(this.data,[i+1,0].concat(e))},PgTreeDataHelper.prototype.removeDescendants=function(t){this.data.splice(t.idx+1,this.getNumberOfDescendants(t.idx,this.data))},PgTreeDataHelper.prototype.delevel=function(t){for(var e=this.getNumberOfDescendants(t.idx,this.data),i=t.idx+1;i<=t.idx+e;i++)this.data[i].level--;this.data.splice(t.idx,1)},PgTreeDataHelper.prototype.peek=function(e){return void 0===e.hidden&&(e.hidden=!1,this.withAllParents(e,function(t){if(t.collapsed||t.hidden)return e.hidden=!0,!1})),!!e.hidden&&(e.peeked=!0,this.withAllParents(e,function(t){if(t.collapsed&&(t.collapsed=!1,t.peek_in=!0),!t.hidden)return!1}),!0)},PgTreeDataHelper.prototype.unpeek=function(t){return!!t.peeked&&(t.peeked=!1,this.withAllParents(t,function(t){t.peek_in&&(t.peek_in=!1,t.collapsed=!0)}),!0)},PgTreeDataHelper.prototype.withAllParents=function(t,e){for(var i=t.level-1,a=t.idx-1;0<=a;a--)if(this.data[a].level===i){if(!1===e(this.data[a]))break;i--}},PgTreeDataHelper.prototype.withChildren=function(t,e){for(var i=t.idx+1;i<this.data.length&&!(this.data[i].level<=t.level)&&!1!==e(this.data[i]);i++);},PgTreeDataHelper.prototype.withDataAndChildren=function(t,e){!1!==e(t)&&this.withChildren(t,e)},PgTreeDataHelper.prototype.forEachWithParents=function(t){for(var e=[],i=null,a=0;a<this.data.length;a++){var s=this.data[a];if(i&&(i.level<s.level?e.push(i):i.level>s.level&&e.splice(e.length-(i.level-s.level),i.level-s.level)),!1===t(s,e))break;i=s}},PgTreeDataHelper.prototype.replaceContentWith=function(t,e){var i=this.getNumberOfDescendants(t.idx),a=this.removeIfAlreadyInData(e,t.idx+1);this.updateLevels(e,t.level+1),this.data.splice.apply(this.data,[a,i].concat(e))},PgTreeDataHelper.prototype.replaceWith=function(t,e){var i=this.getNumberOfDescendants(t.idx),a=this.removeIfAlreadyInData(e,t.idx);this.updateLevels(e,t.level),this.data.splice.apply(this.data,[a,1+i].concat(e))},PgTreeDataHelper.prototype.reindexData=function(t,e){if(void 0===t&&(t=0),e)for(var i=0,a=t;a<this.data.length;a++){this.data[a].idx=a;var s=!1,l=(0<i&&(this.data[a].level>=i?s=!0:i=0),0===i&&this.data[a].collapsed&&(i=this.data[a].level+1),this.data[a].search||1);this.data[a].hidden=s=3===l?!0:s}else for(var a=t;a<this.data.length;a++)this.data[a].idx=a},PgTreeDataHelper.prototype.destroy=function(){this.data=null},0),PgDragHelper=function(t,e,i,a){var s=GoldenLayout.__lm;s.utils.EventEmitter.call(this),i=i||document,isApp()||"force"===a||(a=!1),this.use_dd=a,this.object_id=pgDragHelperObjectId++,this.$container=t,this.selector=e,this._oDocument=$(i),this._eBody=$(i.body),this._oAnotherDocument=null,this.onGetDragImage=null,this.onSetDragData=null,this.onBefore=null,this._nDelay=200,this._nDistance=10,this._nX=0,this._nY=0,this._nOriginalX=0,this._nOriginalY=0,this._prevX=-999999,this._prevY=-999999,this._bDragging=!1,this._fMove=s.utils.fnBind(this.onMouseMove,this),this._fUp=s.utils.fnBind(this.onMouseUp,this),this._fDown=s.utils.fnBind(this.onMouseDown,this),this._fDragStart=s.utils.fnBind(this.onDragStart,this),this._fDragOver=s.utils.fnBind(this.onDragOver,this),this.movedElement=null,this.currentWindow=null,this.debug=!1,a?this.$container.on("dragstart",this.selector,this._fDragStart):this.selector?this.$container.on("mousedown touchstart",this.selector,this._fDown):this.$container.on("mousedown touchstart",this._fDown)},pg_empty_drag_img=document.createElement("img"),PgTreeNodeMenu=(pg_empty_drag_img.src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=",GoldenLayout.__lm.utils.copy(PgDragHelper.prototype,{setDocument:function(){var t=this.$container.get(0).ownerDocument||document;this._oDocument=$(t),this._eBody=$(t.body)},destroy:function(){this.use_dd?this.$container.off("dragstart",this.selector,this._fDragStart):this.selector?this.$container.off("mousedown touchstart",this.selector,this._fDown):this.$container.off("mousedown touchstart",this._fDown)},onDragStart:function(e){if(this.setDocument(),this.movedElement=$(e.currentTarget),this.onBefore&&!this.onBefore(this.movedElement))return!1;this.debug&&console.log("DD onDragStart",e),e.stopPropagation();var i=this,t=this._getCoordinates(e),a=(this._nOriginalX=t.x,this._nOriginalY=t.y,this._oDocument.one("dragend",this._fUp),this.currentWindow=e.view,0),s=(this.currentFrameId=a,this.processedFrameId=-1,this.currentWindow),l=function(){i.currentFrameId=a++,s.requestAnimationFrame(l)};s.requestAnimationFrame(l),pgGetAppWindows().forEach(function(t){t.window===e.view&&!1||$(t.window).on("dragover",i._fDragOver)}),this.lastEvent=e,this.dragTarget=$(e.currentTarget),this.onGetDragImage&&(t="none"===(t=this.onGetDragImage(this.dragTarget))?pg_empty_drag_img:t)&&e.originalEvent.dataTransfer.setDragImage(t,0,0),e.originalEvent.dataTransfer.effectAllowed="copyMove",this.onGetDropEffect&&(e.originalEvent.dataTransfer.dropEffect=this.onGetDropEffect(this.dragTarget)),setTimeout(function(){i._startDrag(e),i.onSetDragData&&i.onSetDragData(e.originalEvent.dataTransfer)},1)},onDragOver:function(t){this.debug&&console.log("DD onDragOver",t),pinegrow.keyState.keyChanged(t),this.processedFrameId!==this.currentFrameId&&(this.processedFrameId=this.currentFrameId,this._fMove(t))},onMouseDown:function(t){var e;this.setDocument(),this.movedElement=$(t.currentTarget),this.onBefore&&!this.onBefore(this.movedElement)||(t.preventDefault(),t.stopPropagation(),e=this._getCoordinates(t),this._nOriginalX=e.x,this._nOriginalY=e.y,this._oDocument.on("mousemove touchmove",this._fMove),this._oDocument.one("mouseup touchend",this._fUp),this._oAnotherDocument&&(this._oAnotherDocument.one("mouseup touchend",this._fUp),this._oAnotherDocument.on("mousemove touchmove",this._fMove)),this.lastEvent=t,this.dragTarget=$(t.currentTarget),clearTimeout(this._timeout),this._timeout=setTimeout(GoldenLayout.__lm.utils.fnBind(this._startDrag,this),this._nDelay))},onMouseMove:function(t){t.preventDefault(),this.lastEvent=t;var e=this._getCoordinates(t);this._nX=e.x-this._nOriginalX,this._nY=e.y-this._nOriginalY,!1===this._bDragging&&(Math.abs(this._nX)>this._nDistance||Math.abs(this._nY)>this._nDistance)&&(clearTimeout(this._timeout),this._startDrag(t)),this.currentWindow=t.view,!this._bDragging||this._nX===this._prevX&&this._nY===this._prevY||(this._prevX=this._nX,this._prevY=this._nY,t.originalEvent.dataTransfer={dropEffect:pinegrow.keyState.alt?"move":"copy"},this.emit("drag",this._nX,this._nY,t))},onMouseUp:function(e){this.debug&&console.log("DD onMouseUp (dragend)"),clearTimeout(this._timeout),this._eBody.removeClass("lm_dragging"),this._oDocument.unbind("mousemove touchmove",this._fMove),this._oDocument.unbind("drag",this._fMove),this._oAnotherDocument&&this._oAnotherDocument.unbind("mousemove touchmove",this._fMove);var i=this;pgGetAppWindows().forEach(function(t){t.window===e.view&&!1||$(t.window).off("dragover",i._fDragOver)}),!0===this._bDragging&&(this._bDragging=!1,e.originalEvent.dataTransfer={dropEffect:pinegrow.keyState.alt?"move":"copy"},this.emit("dragStop",e,this._nOriginalX+this._nX)),this.dragGhost&&($(this.dragGhost).remove(),this.dragGhost=null)},_startDrag:function(t){this.debug&&console.log("DD _startDrag",t),this._bDragging=!0,this._eBody.addClass("lm_dragging"),this.emit("dragStart",this._nOriginalX,this._nOriginalY,this.lastEvent)},_getCoordinates:function(t){var e={};return"touch"===t.type.substr(0,5)?(e.x=t.originalEvent.targetTouches[0].pageX,e.y=t.originalEvent.targetTouches[0].pageY):(e.x=t.pageX,e.y=t.pageY),e}}),function(r){var d,e=$('<div class="pg-tree-menu-container"></div>'),c=$('<div class="pg-tree-menu"></div>'),u=($('<div class="pg-tree-menu-door"></div>').appendTo(e),this.$element=c,this.$menu=c,!1),g=(this.width=32,0);this.isYAlignedWithMenu=function(t,e){return g-(e=void 0===e?0:e)<=t&&t<=g+v+e};for(var t=0;t<r.length;t++){var i=r[t].icon.startsWith("<")?r[t].icon:'<i class="'+r[t].icon+'"></i>',i=$('<div data-menu-id="'+t+'">'+i+"</div>").data("menu-item",r[t]);c.append(i),r[t].name&&addTooltip(i,r[t].name,{placement:"left"}),r[t].$item=i}c.on("click",">div",function(t){r[parseInt($(t.currentTarget).attr("data-menu-id"))].func(d,$(this))});var a,v=null,p=null,s=null;this.find=function(t){for(var e=0;e<r.length;e++)if(r[e].key&&r[e].key==t)return c.find('> [data-menu-id="'+e+'"]');return null},this.hide=function(){u||(c.hide(),u=!0)},this.show=function(){u&&(c.show(),u=!1)},this.isHidden=function(){return u},this.updateLayout=function(){p=c.parent().height(),a=c.width(),s=c.parent().width()-a},this.showFor=function(t,e,i,a){d=a;for(var s={},l=0;l<r.length;l++){var n=!0;((n=r[l].show?r[l].show(a,s):n)?pg$Show:pg$Hide)(r[l].$item)}v=c.height(),u&&this.show();var o=38,h=(t+e)/2+(o=pgf.kids?-8:o),h=Math.round(h-v/2);p-o<(h=h<o?o:h)+v&&(h=p-o-v),c.css({top:h+"px"}),g=h,this.setSelected(i)},this.showForVert=function(t,e,i){d=e,v=v||c.height(),u&&this.show();var a=t-v+4;c.css({top:(a=a<i?i:a)+"px"}),g=a},this.showInCell=function(t){d=t.data,v=v||c.height(),t.$element.append(c),u&&this.show();var e=-v+4;c.css({top:e+"px"}),g=e},this.isOverMenu=function(t){return!u&&t.left>=s&&t.top>=g&&t.top<=g+v},this.setSelected=function(t){t?(c.addClass("for-selected"),e.addClass("for-selected")):(c.removeClass("for-selected"),e.removeClass("for-selected"))},this.setBottom=function(t){},this.setRight=function(t){c.css("right",t+"px")}});