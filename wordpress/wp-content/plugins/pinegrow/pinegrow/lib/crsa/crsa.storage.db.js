!function(i){i.fn.crsastorage=function(o){return r[o]?r[o].apply(this,Array.prototype.slice.call(arguments,1)):"object"!=typeof o&&o?void i.error("Method "+o+" does not exist on jQuery.crsastorage"):r.init.apply(this,arguments)};var s,a=[],l=0,r={init:function(o){i.extend({},i.fn.crsastorage.defaults,o)},auth:function(){(s=new Dropbox.Client({key:"iz3y3vk51f3xtza"})).authDriver(new Dropbox.AuthDriver.Popup({receiverUrl:"http://localhost/dropbox.html"})),s.isAuthenticated()?r.authDone():s.authenticate(function(o,e){o?c(o):r.authDone()})},authDone:function(){o()},createProject:function(o){s.mkdir("/"+o,function(o,e){o?c(o):(a.push(e),s.makeUrl(e.path,{long:!0},function(o,e){o?c(o):console.log(e)}))})},openProject:function(a){l=0;function c(){r.openProjectBrowser(t)}var t=null;s.readFile("/"+a+"/pinegrow.json",{},function(o,e,r,n){(t=!o&&e?JSON.parse(e):t)?(console.log("Project loaded from cache"),console.log(t),c()):u("/"+a,t={crsa_project_name:a,crsa_files:[]},function(){p(t),alert("load finished"),console.log(t),c()})})},openProjectBrowser:function(o){void 0!==o&&o||(o=project);function a(o,e){var r,n=i("<li/>").html("<div>"+(o.crsa_project_name||o.name)+"</div>").appendTo(e);n.data("crsa-node",o),o.crsa_files&&(r=i("<ul/>").appendTo(n),i.each(o.crsa_files,function(o,e){e.isFolder&&a(e,r)}))}var e=i("<div/>",{class:"crsa-project-browser"}).appendTo(i("body")),r=(i("<h2/>").html(o.crsa_project_name).appendTo(e),i("<div/>",{class:"crsa-project-tree"}).appendTo(e)),n=i("<div/>",{class:"crsa-project-grid"}).appendTo(e),c=null,r=i("<ul/>").appendTo(r);return a(o,r),r.find("li").on("click",function(o){var e=i(o.delegateTarget),r=e.data("crsa-node");return o=r,n.html(""),o.crsa_files&&i.each(o.crsa_files,function(o,e){i("<div/>").html(e.name)}),c&&c.removeClass("active"),e.addClass("active"),c=e,!1}),e}},p=function(o){var r=null,e=(i.each(o.crsa_files,function(o,e){if("pinegrow.json"==e.name)return r=e,!0}),o.crsa_project_name);s.writeFile("/"+e+"/pinegrow.json",JSON.stringify(o),{lastVersionTag:r?r.versionTag:null},function(o,e){o?c(o):console.log("Project cache saved")})},u=function(o,c,t){l++,s.readdir(o,{},function(o,e,r,n){o||i.each(n,function(o,e){var r,n,a;c.crsa_files.push(e),e.isFolder&&(e.crsa_files=[],u(e.path,e,t)),e.isFile&&!e.crsa_share&&(r=e.path,n=function(o){e.crsa_share=o},a=t,l++,s.makeUrl(r,{downloadHack:!0},function(o,e){o||n(e),l--,a&&l<=0&&a()}))}),--l<=0&&t()})},o=function(){a=[],s.readdir("/",{},function(o,e,r,n){o?c(o):(console.log(n),i.each(n,function(o,e){var r;e.isFolder&&(a.push(r=e),console.log("Project "+r.name))}))})},c=function(o){switch(alert(o),o.status){case Dropbox.ApiError.INVALID_TOKEN:case Dropbox.ApiError.NOT_FOUND:case Dropbox.ApiError.OVER_QUOTA:case Dropbox.ApiError.RATE_LIMITED:case Dropbox.ApiError.NETWORK_ERROR:break;case Dropbox.ApiError.INVALID_PARAM:case Dropbox.ApiError.OAUTH_ERROR:case Dropbox.ApiError.INVALID_METHOD:}};i.fn.crsastorage.defaults={}}(jQuery);