var CrsaBrowserStorage=function(){function i(t){return"localSave_"+t}this.save=function(t,e){var r=i(t);localStorage[r]=e},this.exists=function(t){return i(t)in localStorage},this.load=function(t){var e=i(t);return e in localStorage?localStorage[e]:null},this.saveProject=function(){var r={pages:[],css:[]};if($.each($.fn.crsapages("getAllPages"),function(t,e){r.pages.push({url:e.url,html:e.getSource(!1),name:e.name}),e.setPageChanged(!1)}),0==r.pages.length)return null;$.each(pinegrow.stylesheets.getAllCrsaStylesheets(),function(t,e){!e.inline&&e.loaded&&(r.css.push({url:e.url,less:e.getSource()}),e.setChanged(!1))});var t=JSON.stringify(r);return 2e6<t.length?pinegrow.alert("Sorry, the project is too big to save. Use File -> Save."):localStorage.savedProject=t,r},this.hasSavedProject=function(){return"savedProject"in localStorage},this.restoreProject=function(r){if(!this.hasSavedProject())return null;try{var t=localStorage.savedProject,i=JSON.parse(t),n=0,o=0,s=function(){var e,t;o>=i.css.length?($("body").trigger("crsa-stylesheets-changed"),r&&r()):(e=i.css[o],(t=pinegrow.stylesheets.findCrsaStylesheetForUrl(e.url))&&0<t.length?t[0].genSetSource(e.less,function(){o++,s()}):$.fn.crsacss("addStylesheetFromUrl",e.url,function(t){t.genSetSource(e.less,function(){o++,s()})}))},a=function(){var e=i.pages[n];$.fn.crsa("openPage",e.url,function(){},function(t){setPageSource(t.$iframe,e.html,null,!0),t.runScripts(function(){t.callFrameworkHandler("on_page_loaded"),$.fn.crsa("updateIfNeeded"),t.addCrsaStyles()}),e.name&&(t.name=e.name,t.updateNameDisplay())},null,function(t){(++n<i.pages.length?a:s)()})};return 0<i.pages.length&&a(),i}catch(t){return null}}},CrsaFileTag=function(t,e,r,i,n){this.text=t,this.type=e,this.desc=r,this.icon=i,this.class=n,this.show=!0},CrsaFile=function(t){this.isFile=!0,this.name=null,this.path=null,this.url=null,this.children=[],this.entity=null,this.image=null,this.required=!1,this.tag=null,this.tags=[],this.parent=null,this.entityMap=t},CrsaStore=(CrsaFile.prototype.addChild=function(t){this.children.push(t),t.parent=this},CrsaFile.prototype.withParents=function(t){for(var e=this.parent;e;)t(e),e=e.parent},CrsaFile.prototype.fromEntity=function(t){return this.isFile=t.isFile,this.name=t.name,this.path=t.fullPath,this.entityMap&&(this.entityMap[this.path]=t),this},CrsaFile.prototype.fromFile=function(t){var e=require("fs"),r=require("path"),e=e.statSync(t);this.isFile=e.isFile(),this.name=r.basename(t),this.url=crsaMakeUrlFromFile(t),this.path=t},CrsaFile.prototype.fromURL=function(t){this.isFile=!0,this.name=crsaGetNameFromUrl(t),this.url=t},CrsaFile.prototype.getEntity=function(){return this.entityMap&&this.path&&this.path in this.entityMap?this.entityMap[this.path]:null},CrsaFile.prototype.walkThroughFiles=function(t){for(var e=0;e<this.children.length;e++){var r=this.children[e];t(r),r.walkThroughFiles(t)}},CrsaFile.prototype.getMappedUrl=function(){return this.content&&this.content.startsWith("@mapurl:")?this.content.replace("@mapurl:","").trim():null},CrsaFile.prototype.getMappedUrlOrUrl=function(){return this.getMappedUrl()||this.url},CrsaFile.prototype.addTag=function(t,e){for(var r=0;r<this.tags.length;r++)if(this.tags[r].text==t.text)return;void 0===e?this.tags.push(t):(e>this.tags.length&&(e=this.tags.length),this.tags.splice(e,0,t))},CrsaFile.prototype.hasTag=function(t){for(var e=0;e<this.tags.length;e++)if(this.tags[e].text==t)return!0;return!1},CrsaFile.prototype.getTagByType=function(t){for(var e=0;e<this.tags.length;e++)if(this.tags[e].type===t)return this.tags[e];return null},CrsaFile.prototype.removeTag=function(t){for(var e=0;e<this.tags.length;e++)if(this.tags[e].text==t)return void this.tags.splice(e,1)},CrsaFile.prototype.removeTagByType=function(t){for(var e=0;e<this.tags.length;e++)if(this.tags[e].type===t)return void this.tags.splice(e,1)},CrsaFile.prototype.removeTags=function(){this.tags=[]},CrsaFile.prototype.updateTags=function(){var t=pinegrow.getCurrentProject();t&&t.updateTagsForFile(this)},CrsaFile.prototype.copyFile=function(t,e,r){require("path");var i=require("fs"),n=this;if(!crsaIsRemoteUrl(this.url))return crsaCopyFileSync(i,t,e),(i=new CrsaFile).fromFile(e),i.parent=n.parent,r&&r(i),i;pgCopyRemoteUrlToLocalPath(this.url,e,function(){var t=new CrsaFile;t.fromFile(e),t.parent=n.parent,r&&r(t)})},CrsaFile.prototype.duplicate=function(t,e){var r=require("path"),i=require("fs"),r=r.join(r.dirname(this.path),t),n=!1;try{i.statSync(r),n=!0}catch(t){}if(n&&!e)throw"File "+t+" already exists.";return this.copyFile(this.path,r)},CrsaFile.prototype.copyFileToNewPath=function(t,e){var r=require("fs"),i=!1;try{r.statSync(t),i=!0}catch(t){}if(i)throw"File "+t+" already exists.";return this.copyFile(this.path,t,e)},CrsaFile.prototype.deleteFileAndFolder=function(i){var n=require("path"),o=require("fs"),s=this;o.lstatSync(i).isDirectory()?(o.readdirSync(i).forEach(function(t,e){var r=n.join(i,t);o.lstatSync(r).isDirectory()?s.deleteFileAndFolder(r):o.unlinkSync(r)}),o.rmdirSync(i)):o.unlinkSync(i)},CrsaFile.prototype.delete=function(){try{this.deleteFileAndFolder(this.path)}catch(t){return!1}return!0},CrsaFile.prototype.rename=function(t){var e=require("path"),r=require("fs"),e=e.join(e.dirname(this.path),t);return r.renameSync(this.path,e),r.lstatSync(e).isDirectory()?null:((r=new CrsaFile).fromFile(e),r.parent=this.parent,r)},CrsaFile.prototype.doesFileExistInSameDir=function(t){var e,r;return isApp()?(e=require("path"),r=require("fs"),e=e.join(e.dirname(this.path),t),r.existsSync(e)):(r=crsaGetBaseForUrl(this.path)+"/"+t,pinegrow.getCurrentProject().getFileForUrl(r))},CrsaFile.prototype.isDirectoryInTheSameDir=function(t){var e,r;return!!isApp()&&(r=require("path"),e=require("fs"),r=r.join(r.dirname(this.path),t),e.lstatSync(r).isDirectory())},CrsaFile.prototype.isImage=function(){var t=pinegrow.getMimeType(this.name);return t&&t.startsWith("image/")},CrsaFile.prototype.getSimpleType=function(){return pinegrow.getSimpleMimeType(this.name)},CrsaFile.prototype.addScriptToPage=function(t,e){var r=t.makeRelativeUrl(this.url);t.addScript(r,e)},CrsaFile.prototype.hasScriptOnPage=function(t){var e=t.makeRelativeUrl(this.url);return t.hasScriptInHeaderOrFooter(e)?"head":!!t.hasScriptInHeaderOrFooter(e,!0)&&"body"},CrsaFile.prototype.addStylesheetToPage=function(t){var e=t.makeRelativeUrl(this.url);t.addStylesheet(e,!0)},CrsaFile.prototype.hasStylesheetOnPage=function(t){var e=t.makeRelativeUrl(this.url);return t.hasLinkedStylesheet(e)},function(){this.type="AbstractStore",this.listProjects=function(t){},this.getProject=function(t,e){},this.createProjectFromTemplate=function(t){},this.saveProject=function(t){},this.deleteProject=function(t){},this.createProjectFile=function(t,e,r){},this.saveProjectFile=function(t,e,r){},this.deleteProjectFile=function(t,e){},this.copyProjectFile=function(t,e,r){},this.getProjectFileUrl=function(t,e){}}),CrsaFileStore=function(){this.name="FileStore",this.app="chrome-extension:"==location.protocol;var n=this;this.listProjects=function(t){},this.getProject=function(t,e){chrome.fileSystem.chooseEntry({type:"openDirectory"},function(t){console.log(t),n.loadProject(t,e)})},this.loadProject=function(r,i){var c=new CrsaProject;c.root=new CrsaFile(c.entityMap).fromEntity(r),chrome.fileSystem.getDisplayPath(r,function(t){c.name=c.root.name,c.localPath=t;var e=r.createReader(),a=0,l=function(n,o,s){a++,n.readEntries(function(t){if(a--,t.length){for(var e=0;e<t.length;e++){var r,i=new CrsaFile(c.entityMap);i.fromEntity(t[e]),o.children.push(i),i.isFile||(r=t[e].createReader(),l(r,i,s))}l(n,o,s)}else a<=0&&s()},function(t){a--,console.log(t),a<=0&&s()})};l(e,c.root,function(){i(c)})})},this.saveProject=function(t){},this.createProjectFromTemplate=function(h,i){var t=chrome.runtime.getURL("/templates/"+h+"/pinegrow.json");console.log(t),$.ajax({url:t,data:null,dataType:"json"}).done(function(r){console.log(r),chrome.fileSystem.chooseEntry({type:"openDirectory"},function(e){chrome.fileSystem.isWritableEntry(e,function(t){var a,l,c;t?(a=0,l=function(){--a<=0&&n.loadProject(e,function(t){i(t)})},(c=function(t,i,r){console.log("copying dir "+t.name);for(var e=0;e<t.children.length;e++){var n,o,s=t.children[e];console.log(s.path),s.isFile?(a++,n=chrome.runtime.getURL("/templates/"+h+s.path.replace("/"+h,"")),(o=new XMLHttpRequest).open("GET",n,!0),o.responseType="blob",o.crsaNode=s,o.onload=function(t){var e=this.crsaNode,r=this.response;i.getFile(e.name,{create:!0},function(t){t.createWriter(function(t){t.onwriteend=function(t){console.log("Write completed."),l()},t.onerror=function(t){console.log("Write failed: "+t.toString()),l()},t.write(r)},function(t){l(),console.log(t)})},function(t){l(),console.log(t)})},o.send()):(a++,function(e){i.getDirectory(e.name,{create:!0},function(t){c(e,t,r),l()},function(t){l(),console(t)})}(s))}})(r.root,e,function(){console.log("template copied to project.")})):console.log(e+" is not writable.")}),console.log(e)})}).fail(function(t){console.log(t)})},this.deleteProject=function(t){},this.createProjectFile=function(t,e,r){},this.saveProjectFile=function(t,e,r){},this.deleteProjectFile=function(t,e){},this.copyProjectFile=function(t,e,r){},this.getProjectFileUrl=function(t,e){}};CrsaFileStore.prototype=new CrsaStore;