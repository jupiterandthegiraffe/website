class PgAction{static key;static action_name;static description;static allowed_parents=[];static history=[];static accepts_subactions=!1;static subactions_label="";static add_subaction_button_label="";constructor(e,t){this.target_pgel=e,this.arguments={"action.scope":"page"},this.argument_fields={},this.stop=!1,this.requires_refs_update=!1,this.refs=[],this.old_refs_checked={},this.sub_actions=[],this.parent_action=t||null,this.win=null,this.unique_field_id=0,this.delayed_tasks=new PgDelayedTasks,this.addFieldSection(this.constructor.key,this.constructor.action_name),this.onUndoRedoBind=this.onUndoRedo.bind(this),this.onPageSelectedBind=this.onPageSelected.bind(this),this.onElementsSelectedBind=this.onElementsSelected.bind(this),t||(pinegrow.addEventHandler("on_undo_redo",this.onUndoRedoBind),pinegrow.addEventHandler("on_page_selected",this.onPageSelectedBind),pinegrow.addEventHandler("on_selected_elements_changed",this.onElementsSelectedBind),this.constructor.history.length&&this.fromData(this.constructor.history[this.constructor.history.length-1]))}destroy(){this.delayed_tasks.destroy(),this.parent_action||(pinegrow.removeEventHandler("on_undo_redo",this.onUndoRedoBind),pinegrow.removeEventHandler("on_page_selected",this.onPageSelectedBind),pinegrow.removeEventHandler("on_selected_elements_changed",this.onElementsSelectedBind),this.constructor.history.push(this.toData()))}toData(){return{arguments:{...this.arguments},subactions:this.sub_actions.map(function(e){return e.constructor.name})}}fromData(e){const n=this;$.each(e.arguments,function(e,t){n.arguments[e]=t}),e.subactions.forEach(function(e){var t=pinegrow.actionsManager.getActionByClassName(e);t&&n.addSubAction(new t(null,n))})}onUndoRedo(){this.parent_action||this.getPgelRefsAndUpdateDisplay(!0)}onPageSelected(){"page"!==this.arguments["action.scope"]||this.parent_action||this.getPgelRefsAndUpdateDisplay(!0)}onElementsSelected(e,t,n){"element"!==this.arguments["action.scope"]||this.parent_action||n?.source===this||this.getPgelRefsAndUpdateDisplay(!0)}addFieldSection(e,t){this.argument_fields[e]={name:t,is_closable:!1,fields:{}}}addFieldToSection(c,e,t,n,s){const l=this;var i=this.constructor.key;(s=s||{}).required||s.validate||(s.validate=function(e,t,n,s,i,a){for(var o=0;o<l.sub_actions.length;o++){var r=l.sub_actions[o].doesSubActionRequireParentField(c,n);if(r)return r}return null}),this.argument_fields[i].fields[this.getFullArgKey(c)]={name:e,type:t,helptext:n,...s,on_changed:async function(e,t,n){l.onArgumentValueChanged(t.replace(l.constructor.key+".",""),n),s.is_filter&&l.delayed_tasks.run("update",function(){(l.parent_action||l).getPgelRefsAndUpdateDisplay(!0)},n&&n.length<3?300:0)}}}doesSubActionRequireParentField(e,t){return null}getFullArgKey(e){return this.constructor.key+"."+e}getArg(e,t){var n=this.arguments[this.getFullArgKey(e)]||null;return n=t&&null!==n?n.split(/[ ,]/).map(e=>e.trim()).filter(e=>!!e):n}editArgumentsAndRunAction(e){const t=this;var n=this.getSections(),n=(this.win=pinegrow.quickEditProperties(n,this.constructor.action_name,this.arguments,{target:e||pinegrow.selectedElements.getLastSelected()?.get$DOMElement()}),this.win.onDestroy=function(){t.destroy()},this.sub_actions.forEach(function(e){e.win=t.win}),$(`<button class="pg-button" style="margin-right:10px;padding: 0 8px;
    position: relative;
    top: -1px;">Clear</button>`)),n=(this.win.$element.find(".pg-quick-win-header-icons").prepend(n),n.on("click",function(e){e.preventDefault(),t.reset()}),this.win.autoSize(40),this.win.$element.find(".crsa-field:visible input"));n.length&&n.get(0).focus(),this.wireRefs(),this.getPgelRefsAndUpdateDisplay(!0)}getSections(){const o=this;var n,s,e={...this.argument_fields};return this.constructor.accepts_subactions&&(n={},s=0,this.sub_actions.forEach(function(e){var t={};t[e.constructor.key+".label"+o.unique_field_id++]={type:"displayhtml",name:`<div class="name">${e.constructor.action_name}<a href="#" class="remove-subaction" data-subaction-idx="${s++}"><i class="icon icon-bin"></i></a></div><!--<p>${e.constructor.description}</p>-->`,wrapper_class:"pg-action-subaction-info "+(1<s?"pg-action-subaction-info-not-first":"")},n={...n,...t,...e.argument_fields[e.constructor.key].fields}}),e.subactions={name:this.constructor.subactions_label,is_closable:!1,fields:{...n}},this.hasSubActions()||(e.subactions.fields["button.add.label"]={type:"displayhtml",name:`<div class="pg-action-subaction-add-info">Add one or more actions that will be run on targeted elements.</div>`,wrapper_class:"pg-action-subaction-add"}),e.subactions.fields["button.add"]={name:this.constructor.add_subaction_button_label,type:"button",helptext:"Add action that will be run on targeted elements.",func:async function(e,t,n,s,i){i.stopPropagation(),i.stopImmediatePropagation();var a=[];pinegrow.actionsManager.getActions().forEach(function(t){t===o.constructor||o.hasSubAction(t)||0<=t.allowed_parents.indexOf(o.constructor)&&a.push({label:t.action_name,helptext:t.description,action:function(){var e=new t(o.target_pgel,o);o.addSubAction(e)}})}),new CrsaContextMenu(a,t).showForElement(t)}}),e.buttons={name:"Run action",is_closable:!1,fields:{"action.scope":{name:"Run action on",type:"select",value:"element",options:[{key:"element",name:"Selected elements"},{key:"page",name:"Page"},{key:"open-pages",name:"All open pages"},{key:"project",name:"Project"}],on_changed:async function(e,t,n){await o.getPgelRefsAndUpdateDisplay(!1,n)}},"button.refs":{name:"Run on matched elements",type:"button",button_class:"pg-button-primary",helptext:"Run the action on all checked matched elements. Use Undo to revert.",func:async function(){o.validateArguments(!1,!0)&&(await o.runOnPgelRefs(o.refs),pinegrow.showQuickMessage(`Done!`))},show_if:function(){return o.hasActionToRun()}},"button.stop":{name:"Stop running the actions",type:"button",helptext:"Stop the actions.",func:async function(e,t){o.stop=!0,t.html("Stopping...")},show_if:function(){return!1}}}},e.affected={name:"Matched elements",is_closable:!1,fields:{"action.refs":{type:"displayhtml",name:`<div class="pg-action-refs"></div>`}},on_created:function(e){var t=$('<a href="#" class="pg-actions-refs-refresh"><i class="icon icon-refresh"></i></a>').appendTo(e.$element);addTooltip(t,"Refresh matched elements"),t.on("click",function(e){e.preventDefault(),o.getPgelRefsAndUpdateDisplay(!1)})}},e}onArgumentValueChanged(t,n){this.sub_actions.forEach(function(e){e.onArgumentValueChanged(t,n)})}addSubAction(e){this.sub_actions.push(e),e.parent_action=this,e.arguments=this.arguments,this.win&&(e.win=this.win,this.updateSubActions(),this.getPgelRefsAndUpdateDisplay(!0))}hasSubAction(e){for(var t=0;t<this.sub_actions.length;t++)if(this.sub_actions[t]instanceof e)return this.sub_actions[t];return!1}reset(){const n=this;$.each(this.arguments,function(e,t){"action.scope"!==e&&delete n.arguments[e]}),this.sub_actions=[],this.updateSubActions(),this.getPgelRefsAndUpdateDisplay(!0)}updateSubActions(){this.win.setSections(this.getSections()),this.win.autoSize(40)}async getPgelRefsAndUpdateDisplay(e,t,n){if(this.requires_refs_update=!1,e||this.validateArguments(e,n))switch(t||this.arguments["action.scope"]){case"element":await this.getRefsOnPgel(pinegrow.getCollection(),!0);break;case"page":await this.getRefsOnPage(pinegrow.getSelectedPage());break;case"open-pages":await this.getRefsOnOpenPages();break;case"project":e?(this.resetRefs(),this.requires_refs_update=!0):await this.getRefsOnProject()}else this.resetRefs(),this.requires_refs_update=!0;this.keepCheckedOnRefs(),this.showRefs(),this.win.autoSize(40)}validateArguments(e,n){const s=this;return!!pinegrow.validateAllFields(this.win.$element,{},this.arguments,function(e,t){return!(!n&&!e.startsWith(s.constructor.key+"."))})||(e||pinegrow.showQuickError("Invalid arguments. Please check and try again."),!1)}resetRefs(){const n=this;this.old_refs_checked={},this.refs.forEach(function(e){var t=e.getGlobalId();t&&(n.old_refs_checked[t]=e.checked)}),this.refs=[]}async internalRunOnPgel(e,t,n){var s=[],i=!1;t?e.walkSelfAndChildren(function(e){return e.isElement&&s.push(e),!0}):s.push(e);for(var a=0;a<s.length;a++)await this.doActionOnPgel(s[a])&&(n.add(s[a]),i=!0);return i}async runOnPgel(e,t){for(var n=pinegrow.getCollectionForElement(e),s=new PgCollection,i=n.getList(),a=!1,o=0;o<i.length;o++)a=a||await this.internalRunOnPgel(i[o],t,s);return a&&pinegrow.changeManager.didChange(s,this.constructor.action_name),a}async getRefsOnPgel(e,t){this.resetRefs();for(var n=e.getList(),s=0;s<n.length;s++)this.refs=this.refs.concat(await this.getPgelRefsForAction(n[s],n[s].getPage(),t))}async runOnPage(e){var t=new PgCollection,n=await this.internalRunOnPgel(e.sourceNode,!0,t);return n&&pinegrow.changeManager.didChange(t,this.constructor.action_name),n}async getRefsOnPage(e){this.resetRefs(),e&&(this.refs=await this.getPgelRefsForAction(e.sourceNode,e,!0))}async getRefsOnOpenPages(){this.resetRefs();for(var e=pinegrow.getSelectedPage(),t=(this.refs=await this.getPgelRefsForAction(e.sourceNode,e,!0),pinegrow.getAllPages()),n=0;n<t.length;n++){var s=t[n];s!==e&&(this.refs=this.refs.concat(await this.getPgelRefsForAction(s.sourceNode,s,!0)))}}async runOnProject(){const s=this;var t=pinegrow.getCurrentProject();return new Promise(function(e){t.forEachEditableFile(async function(e,t,n){n.changed=await s.runOnPage(e),t(e,n)},function(){e()},"Doing action "+s.constructor.action_name+"...")})}async getRefsOnProject(){const s=this;this.resetRefs();var t=pinegrow.getCurrentProject();return new Promise(function(e){t.forEachEditableFile(async function(e,t,n){s.refs=s.refs.concat(await s.getPgelRefsForAction(e.sourceNode,e,!0)),t(e,n)},function(){e()},"Inspecting project for action "+s.constructor.action_name+"...")})}keepCheckedOnRefs(){const n=this;this.refs.forEach(function(e){var t=e.getGlobalId();t&&t in n.old_refs_checked&&(e.checked=n.old_refs_checked[t])})}async runOnPgelRefs(t,e){this.stop=!1;for(var n=this.win.$element.find(".crsa-field-button-stop"),s=(n.find("button").html("Stop the action"),pg$Show(n,"flex"),pg$Hide(this.win.$element.find(".crsa-field-button-refs")),new PgCollection),i=!1,a=0;a<t.length&&!this.stop;a++)if(t[a].checked||e){var o=await t[a].toPgel(this.refs);if(o){t[a].setStatus(PgActionPgelReference.Status_InProgress);try{await this.doActionOnPgel(o)&&(i=!0,s.add(o)),t[a].setStatus(PgActionPgelReference.Status_Done)}catch(e){t[a].setStatus(PgActionPgelReference.Status_Error,e.toString())}}}return pg$Hide(n),pg$Show(this.win.$element.find(".crsa-field-button-refs"),"flex"),i&&pinegrow.changeManager.didChange(s,this.constructor.action_name),i}async getPgelRefsForAction(e,t,n){var s=[];const i=this;return e.walkSelfAndChildren(function(e){return e.isElement&&i.willActionBeDoneOnPgel(e)&&s.push(new PgActionPgelReference(e,t)),!!n}),s}showRefs(){const t=this;var n,s,i=this.win.$element.find(".pg-action-refs");this.refs.length?(n=`<table><thead><tr>
    <td><input type="checkbox" checked class="toggle-all"></td>
    <td></td>
    <td></td>
    <td></td>
</tr></thead>
<tbody>`,s=0,this.refs.forEach(function(e){e.idx=s,n+=`<tr data-idx="${s++}">${t.getHtmlForRef(e)}</tr>`,e.onStatusChanged=function(){i.find(`[data-idx="${this.idx}"]`).get(0).innerHTML=t.getHtmlForRef(this)}}),n+=`</tbody></table>`):n=this.requires_refs_update?`<div class="alert alert-info alert-panel-notice" style=""><content><p>Refresh to see the affected elements.</p><button class="refresh pg-button">Refresh</button></content></div>`:`<div class="alert alert-info alert-panel-notice" style=""><content>No elements will be affected.</content></div>`,i.get(0).innerHTML=n}getHtmlForRef(e){var t="unknown",n="";switch(e.status_info&&(n+=` title="${e.status_info.replace(/"/g,"&quot;")}"`),e.status){case PgActionPgelReference.Status_Pending:t=`<span class="pending" ${n}><i class="icon icon-minus"></i></span>`;break;case PgActionPgelReference.Status_InProgress:t=`<span class="in-progress" ${n}><i class="icon icon-Delay"></i></span>`;break;case PgActionPgelReference.Status_Done:t=`<span class="done" ${n}><i class="icon icon-check"></i></span>`;break;case PgActionPgelReference.Status_Error:t='<span class="error" ${title}><i class="icon icon-274"></i></span>'}this.onRefDisplayed(e);var s=this.hasActionToRun()?`<a href="#" class="run">Run</a>`:"",i="",a=this.arguments["action.scope"];return"project"!==a&&"open-pages"!==a||(i=`<span class="page-name">${crsaGetNameFromUrl(e.page_url)}</span>`),`<td><input type="checkbox" ${e.checked?"checked":""} class="toggle"></td>
    <td><span class="ref">${i}<span class="name">${e.name}</span></span></td>
    <td>${t}</td>
    <td>${s}</td>`}wireRefs(){const n=this;function s(e){return n.refs[parseInt(e.closest("[data-idx]").getAttribute("data-idx"))]}var i=this.win.$element.find(".pg-action-refs");i.on("change",".toggle-all",function(e){var t=this.checked;i.find("[data-idx]").each(function(e){this.querySelector(".toggle").checked=t,s(this).checked=t})}),i.on("change",".toggle",function(e){var t=this.checked;s(this).checked=t}),i.on("click",".run",function(e){e.preventDefault(),n.runOnPgelRefs([s(this)],!0)}),i.on("click",".name",async function(e){e.preventDefault(),await s(this).select(n)}),i.on("click",".refresh",async function(e){e.preventDefault(),await n.getPgelRefsAndUpdateDisplay()}),this.win.$element.on("click",".remove-subaction",function(e){e.preventDefault();var t=parseInt(this.getAttribute("data-subaction-idx"));n.sub_actions.splice(t,1),n.updateSubActions()})}onRefDisplayed(e){}willActionBeDoneOnPgel(e){return!1}hasSubActions(){return 0<this.sub_actions.length}willAnySubActionBeDoneOnPgel(e){for(var t=0;t<this.sub_actions.length;t++)if(this.sub_actions[t].willActionBeDoneOnPgel(e))return!0;return!1}async doActionOnPgel(e){return!1}async doSubActionsOnPgel(e){for(var t=!1,n=0;n<this.sub_actions.length;n++)e=e.makeSurePgelIsOK(),t=t||await this.sub_actions[n].doActionOnPgel(e);return t}hasActionToRun(){return!0}}class PgActionPgelReference{static Status_Pending="pending";static Status_InProgress="in-progress";static Status_Done="done";static Status_Error="error";constructor(e,t){this.pgid=e.getId(),this.name=e.getName({short:!1,num_classes:1}),this.page=t||e.getPage(),this.path=e.getPath(),this.page_url=this.page.url,this.pgel=e,this.checked=!0,this.status=this.constructor.Status_Pending,this.status_info=null}update(){this.pgel=this.pgel.makeSurePgelIsOK(),this.pgid=this.pgel.getId(),this.path=pgel.getPath()}setStatus(e,t){this.status=e,this.status_info=t,this.onStatusChanged()}getGlobalId(){return this.pgid?this.pgid.toString():null}onStatusChanged(){}async toPgel(s){const i=this;return new Promise(function(n){function e(e){var t;(t=(t=i.pgid?getPgNodeByPgId(i.pgid):t)||e.sourceNode.getNodeFromPath(i.path))||i.setStatus(i.constructor.Status_Error,"Element not found on the page"),n(t)}var t=pinegrow.getCrsaPageByUrl(i.page_url);t?e(t):pinegrow.openPage(i.page_url,function(t){s&&s.forEach(function(e){e.page_url!==i.page_url||e===i||e.pgid||(e.pgel=t.sourceNode.getNodeFromPath(e.path),e.pgid=e.pgel.getId())}),e(t)})})}async select(e){var t=await this.toPgel();t?(pinegrow.showPage(t.getPage()),t.scrollTo(),pinegrow.selectElement(t,null,!1,null,null,{source:e}),pinegrow.showQuickMessage(t.getName({short:!0})+" was selected.")):pinegrow.showQuickError("The element is no longer on the page.")}isSameAs(e){return this.pgel===e.pgel||this.page_url===e.pgel.getPage()?.url&&pgAreArraysEqual(this.path,e.pgel.getPath())}}class PgActionExample extends PgAction{static key="example";static action_name="Add greeting [Example action]";static description="Adds a greeting to every heading and paragraph.";constructor(e){super(e),this.addFieldToSection("greeting","Greeting type","select","Select the greeting you wish to display",{options:[{key:"Good morning!",name:"Good morning!"},{key:"Hello!",name:"Hello!"},{key:"Good night!",name:"Good night!"},{key:"custom",name:"Custom greeting text"},{key:"image",name:"Image"}],required:!0}),this.addFieldToSection("custom_greeting","Custom greeting","text","Set custom greeting",{show_if:"greeting==custom",options:function(){return[{key:"Dober dan",name:"Dober dan"},{key:"Lahko noc",name:"Lahko noc"}]},required:this.getFullArgKey("greeting")+`==custom`}),this.addFieldToSection("image","Image greeting","image","Use image as a greeting",{show_if:this.getFullArgKey("greeting")+`==image`,required:this.getFullArgKey("greeting")+`==image`}),this.addFieldToSection("add_space","Add space","checkbox","Add space before the greeting",{value:"1"}),this.addFieldToSection("tag_names","Where to show?","select","Elements where the greeting should be shown. Default is headings and paragraphs.",{placeholder:"h1, h2, h3, h4 and p",multiple:!0,options:function(){var t=["body","script","html"],n=[],e=pinegrow.getSelectedPage();return e&&e.sourceNode.walk(function(e){if(e.isElement){if("head"===e.tagName)return"skip_children";t.indexOf(e.tagName)<0&&e.canHaveChildren()&&n.indexOf(e.tagName)<0&&n.push(e.tagName)}return!0}),n.sort(),n.map(function(e){return{key:e,name:e}})}})}getGreeting(){var e=this.getArg("greeting");return"custom"===e?e=this.getArg("custom_greeting"):"image"===e&&(e=`<img src="${this.getArg("image")}">`),e}willActionBeDoneOnPgel(e){var t=this.getGreeting();return 0<=(this.getArg("tag_names")||"h1,h2,h3,h4,p").split(",").indexOf(e.tagName)&&e.text().indexOf(t)<0}async doActionOnPgel(e){const t=this;var n=!1,s=this.getGreeting(),i=(this.getArg("tag_names")||"h1,h2,h3,h4,p").split(",");return e.walkSelfAndChildren(function(e){0<=i.indexOf(e.tagName)&&e.text().indexOf(s)<0&&(t.getArg("add_space")&&e.append(pgCreate(" ")),e.append(pgCreate(s)),n=!0)}),n}}withPinegrow(function(){pinegrow.addEventHandler("on_register_actions",function(e,t){t.registerAction(PgActionExample)})});class PgActionsManager{constructor(){this.actions=[]}init(){pinegrow.dispatchEvent("on_register_actions",null,this)}registerAction(e){this.actions.push(e)}getActionByClassName(e){for(var t=0;t<this.actions.length;t++)if(this.actions[t].name===e)return this.actions[t];return null}getActionsMenu(t,e,n){var s=[];return this.actions.forEach(function(e){s.push({label:e.action_name,helptext:e.description,action:function(){new e(t).editArgumentsAndRunAction(n)}})}),s}getActions(){return this.actions}}