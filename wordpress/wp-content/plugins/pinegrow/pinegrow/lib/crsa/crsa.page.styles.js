var PagePgStylesheet=function(e,t,s,n){this.page=e,this.pgStylesheet=t,this.parentPgStylesheet=s,this.compiledStylesheet=n},CrsaPageStyles=function(w){var n={},l=(this.stylesheets=[],this.default_ignore=[/fonts\.googl/i],this.default_ignore_checked=!1,this.framework_ignore_checked={},null),_=this,e=(this.getStylesheetInfo=function(e){return n[e.url]?{parentPgStylesheet:n[e.url].parentPgStylesheet,compiledStylesheet:n[e.url].compiledStylesheet}:null},this.isStylesheetUsed=function(e,t){return e?!!n[e.url]:!!this.has(t)},this.addStylesheetAs=function(e,t,s){n[e.url]=new PagePgStylesheet(w,e.pgStylesheet,t,s)},this.updateStylesheetUrl=function(e,t,s){if(n[e]){if(n[e].pgStylesheet!=s)throw"Error: same url with different stylesheet";n[t]=n[e],delete n[e]}},this.removeUsedStylesheet=function(){n={}},this.getByRegExp=function(e){for(var t=0;t<this.stylesheets.length;t++)if(this.stylesheets[t].url&&this.stylesheets[t].url.match(e))return this.stylesheets[t];return null},this.getSourceStylesheets=function(){for(var e=[],t=0;t<this.stylesheets.length;t++){var s=this.stylesheets[t];s.sourceStylesheet&&(s=s.sourceStylesheet),e.push(s),s.getImportedStylesheets(e)}return e},this.getList=function(e){return pgcssh.filterStylesheetsList(this.getSourceStylesheets(),e)},this.destroy=function(){this.stylesheets=[],n={},pinegrow.removeEventHandler("on_page_frameworks_changed",e)},this.attachTo=function(e,t,s,n,l){0<=this.stylesheets.indexOf(e)?s&&s():(this.stylesheets.push(e),e.attachTo(w,t,function(){s&&s()},n,l))},this.has=function(e){return 0<=this.stylesheets.indexOf(e)},this.detachFrom=function(e){e.detachFrom(w);var t=this.stylesheets.indexOf(e);0<=t&&(this.removeStylesheetByKey(e),this.stylesheets.splice(t,1))},this.removeStylesheetByKey=function(e){var s=function(e){delete n[e.url],e.forEachStylesheet(function(e){s(e)},!0);var t=e.sourceStylesheet;t&&s(t)};s(e)},this.removeAllInlineSheets=function(){for(var e=0;e<this.stylesheets.length;e++){var t=this.stylesheets[e];t.inline&&(this.stylesheets.splice(e,1),e--,pinegrow.stylesheets.removeCrsaStylesheet(t),t.unload())}},this.removeAllExclusiveSheets=function(){n={};for(var e=0;e<this.stylesheets.length;e++){var t=this.stylesheets[e];pinegrow.stylesheets.getAllSheetsForPages(t).length<=1&&!t.usedByDesignPanel&&(this.stylesheets.splice(e,1),e--,pinegrow.stylesheets.removeCrsaStylesheet(t),t.unload())}},this.updateIgnoreStatuses=function(){function t(e){var s=null;e?_.framework_ignore_checked[e.key]||(s=e.lock_css_files||e.ignore_css_files,_.framework_ignore_checked[e.key]=!0):_.default_ignore_checked||(s=_.default_ignore,_.default_ignore_checked=!0),s&&s.length&&_.stylesheets.forEach(function(e){for(var t=0;t<s.length;t++)if(e.url&&e.url.match(s[t])){e.setIgnore(!0),e.setLocked(!0,"Stylesheet is a framework resource.",!0);break}})}t(),w.frameworks.forEach(function(e){t(e)})},this.loadAllStylesheets=function(e,t,s){var n=function(){t&&t(),pinegrow.dispatchEvent("on_page_stylesheets_loaded",w,e)};if(pgf.edit_css){for(var l=0,h=e.get(0).contentDocument||e.get(0).contentWindow.document,i=0;i<h.styleSheets.length;i++){var r=h.styleSheets[i],o=!1,a=null;if(r.ownerNode){if("crsa-inline-styles"==r.ownerNode.id)continue;if(a=getElementPgNode($(r.ownerNode),!0),!s&&!a)continue}for(var c=r.href,u=r.ownerNode.getAttribute("data-pg-style-url"),g=(u&&(c=u),function(){var s=_.default_ignore;return $.each(w.frameworks,function(e,t){s=s.concat(t.ignore_css_files)}),s}()),f=0;f<g.length;f++)if(c&&c.match(g[f])){o=!0;break}if(c){if(0!==c.indexOf("data:")){var u=pinegrow.getOriginalUrl(c),y=pinegrow.stylesheets.getStylesheetByKey(u);if(y){console.log("PS: ss found, reusing "+y.name),this.attachTo(y,a),pinegrow.stylesheets.addCrsaStylesheet(y),pinegrow.stylesheets.stylsheetUsed({url:u,pgStylesheet:y});var d=y.sourceStylesheet;d&&pinegrow.stylesheets.stylsheetUsed({url:d.url,pgStylesheet:d},"source",y)}else if(isApp()||a){console.log("PS: loading "+c),y=PgCSSStylesheet(),this.attachTo(y,a),pinegrow.stylesheets.addCrsaStylesheet(y),y.ignore=o;for(var S=function(e,t,s){e.load(t,function(e){s&&s(e),l--,console.log("done "+e.url+" "+l),pgIsDev()&&0&&e.url.endsWith("theme.min.css")&&new PgDmCssVariablesFinder(e).findVariables(),0==l&&(n(),l--)},!0)},p=(pinegrow.stylesheets.stylsheetUsed({url:u,pgStylesheet:y}),m=v=void 0,[{cs:y,href:c}]),v=0;v<p.length;v++){l++;var m=p[v].cs;S(m,p[v].href,function(e){})}}}}else(isApp()||a)&&(console.log("loading inline css"),l++,y=PgCSSStylesheet(),this.attachTo(y,a),pinegrow.stylesheets.addCrsaStylesheet(y),y.loadInline(r,function(){0==--l&&(n(),l--)}))}0==l&&n()}else n()},this.getAllActiveRules=function(e){if(null==l||1){l=[];for(var t=0;t<this.stylesheets.length;t++){var s=this.stylesheets[t];e&&0<=e.indexOf(s)||s.isEnabledForPage(w)&&(l=l.concat(s.getAllRules()))}}return l},this.getAllCrsaStylesheets=function(){return this.stylesheets},this.reorder=function(e,t){if(0<e.length)for(var s=0,n=0;n<e.length;n++){var l=e[n];l.detachFrom(w),s++,l.attachTo(w,null,function(){--s<=0&&(this.stylesheets=e,t)&&t()})}else t&&t()},function(e){e==w&&_.updateIgnoreStatuses()});pinegrow.addEventHandler("on_page_frameworks_changed",e)};