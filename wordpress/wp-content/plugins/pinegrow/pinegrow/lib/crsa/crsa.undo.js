var PgEmulatePageForUndo=function(){var e=this;this.url=null,this.sourceNode=null,this.emulate_undo=!0,this.name="Emulated page",this.getName=function(){return this.name},this.destroy=function(){this.sourceNode&&this.sourceNode.withoutEvents(function(){e.sourceNode.remove()})}},PgUndoCSSHelper=function(){},PgUndoManager=(PgUndoCSSHelper.prototype.cssNodeToString=function(e){return e.toString()},PgUndoCSSHelper.prototype.cssGetId=function(e){return e["pg-node-id"]||null},PgUndoCSSHelper.prototype.cssGetPosition=function(e){var t={};return e.parent&&(t.parentId=this.cssGetId(e.parent)),t.index=e.parent.nodes.indexOf(e),t.indices=pinegrow.pgPostCSSHelper.getNodeIndices(e),t},function(){function e(e,t){var n=a.getHistoryForPage(e);n.isUndoOperationInProgress()||n.isIgnore()||n.changeDone(t.action||"change",t.undoCombineKey||null,t.undoSourceId||null,t.undoData||null)}function s(e,n){var o,t,s=a.getCssHistory();s.isUndoOperationInProgress()||s.isIgnore()||n&&n.undoIgnore||e.elementStyle||(0&&n&&n.node&&"decl"==n.node.type&&n.oldValue&&!e.inline?(t=n.oldValue,o=!0,$.each(t,function(e,t){if(n.node[e]!=t)return o=!1}),o||(e=n.stylesheet,t=new PgCSSUndoEvent({cs:e,operation:"nodeUpdated",oldValue:t,position:r.cssGetPosition(n.node)}),s.addEvent(t),s.changeDone(n.action||"Style update",n.undoCombineKey||null,n.undoSourceId||null,n.undoData||null,n.undoRuleName||null),c(e),p(e))):g(e,n))}var n="1"==pinegrow.getSetting("combined-undo","1"),a=(n||(pinegrow.setSetting("combined-undo","1"),pinegrow.showAlert(`<p>Please note that <b>Separate undo histories for pages and CSS</b> are no longer supported. We had to remove the feature in order to be able to improve the Undo/Redo experience.</p><p>The combined Undo history will be used from now on.</p>`,"A note about the Undo History",null,"OK")),n=!0,this),t=new PgEventHandler,o=!1,i=new PgUndoHistory,d=(this.setUseCombined=function(e){i.destroy(),i=new PgUndoHistory,d.destroy(),(d=new PgUndoHistory).css=!0,pinegrow.getAllPages().forEach(function(e){e.undoHistory.destroy(),e.undoHistory=new PgUndoHistory(e)}),n=e,pinegrow.setSetting("combined-undo",e?"1":"0"),pinegrow.dispatchEvent("on_undo_state_added",null)},this.getUseCombined=function(){return n},pinegrow.addEventHandler("on_undo_state_added",function(e){o=null==e}),this.setCssActive=function(e){o=e},this.getCssActive=function(){return o},this.getActiveHistory=function(){var e;return n?i:(e=pinegrow.getSelectedPage(),o||!e?d:e.undoHistory)},this.getHistoryForEvent=function(e){return n?i:e.page.undoHistory},this.getHistoryForPage=function(e){return n?i:e.undoHistory},this.undo=function(){return this.getActiveHistory().undo()},this.redo=function(){return this.getActiveHistory().redo()},t.handle_dom_events=!1,t.on_event=function(e){var t,n=a.getHistoryForEvent(e);n.isUndoOperationInProgress()||n.isIgnore()||(t=new PgUndoEvent(e)).operation&&n.addEvent(t)},pinegrow.addEventHandler("on_page_changes_done",e),pinegrow.addEventHandler("on_emulated_page_changed",e),new PgUndoHistory),r=(d.css=!0,this.getCssHistory=function(){return n?i:d},new PgUndoCSSHelper),l=new WeakMap,u=new WeakMap,h=null,c=(this.purgeCs=function(t){l.delete(t),u.has(t)&&(clearTimeout(u.get(t)),u.delete(t)),this.getCssHistory().purge(function(e){return!(!e.events.length||!e.events[0].event.cs||e.events[0].event.cs!==t)}),h&&clearTimeout(h),h=setTimeout(function(){pinegrow.dispatchEvent("on_undo_state_added",null),h=null},500)},this.purgePage=function(t){n&&(this.getHistoryForPage(t).purge(function(e){return!(!e.events.length||!e.events[0].event.page||e.events[0].event.page!==t)}),h&&clearTimeout(h),h=setTimeout(function(){pinegrow.dispatchEvent("on_undo_state_added",null),h=null},500))},function(e){var t,n;e.getRootNode()&&!e.elementStyle&&(t=new CrsaProfile,n=e.getSource(),l.set(e,n),t.show("rememberCSSSource"))}),g=function(e,t){var n,o,s,i=new CrsaProfile,d=e.getSource();t&&t.editor instanceof PgInternalCodeEditor&&(d=t.editor.getCode()),l.has(e)&&(n=l.get(e))!=d&&(e.inline&&e.inlineSheetPgel?(s=e.inlineSheetPgel.getPage())&&(o=a.getHistoryForPage(s),s=new PgNodeEvent(e.inlineSheetPgel,"updateInner",null,{domValue:d,oldValue:n},s),o.addEvent(new PgUndoEvent(s)),o.changeDone(t.action||"Style update",t.undoCombineKey||null,t.undoSourceId||null,t.undoData||null,t.undoRuleName||null)):(o=a.getCssHistory(),s=new PgCSSUndoEvent({cs:e,operation:"codeUpdated",oldValue:n,newValue:d}),o.addEvent(s),o.changeDone(t.action||"Style update",t.undoCombineKey||null,t.undoSourceId||null,t.undoData||null,t.undoRuleName||null)),p(e)),l.set(e,d),u.delete(e),i.show("handleCSSCodeChange")},p=(pinegrow.addEventHandler("on_undo_redo",function(e,t){t.cs_col&&t.cs_col.forEachElement(function(e){c(e)})}),function(e){pinegrow.dispatchEvent("on_css_stylesheet_changed",null,e)});pinegrow.addEventHandler("on_css_source_changed",function(e,t){t&&t.list&&("undo"===t.edited_by||t.ignore_in_undo||t.list.forEach(function(e){t.action||(t.action="Edit"),s(e,t)}))}),pinegrow.addEventHandler("on_css_loaded",function(e,t){c(t)}),pinegrow.addEventHandler("on_css_node_added",function(e,t){t.action||(t.action="Added"),t.undoRuleName||(t.undoRuleName=pgcssh.getNodeDisplayName(t.node)),s(t.stylesheet,t)}),pinegrow.addEventHandler("on_css_node_deleted",function(e,t){t.action||(t.action="Deleted"),t.undoRuleName||(t.undoRuleName=pgcssh.getNodeDisplayName(t.node)),s(t.stylesheet,t)}),pinegrow.addEventHandler("on_css_node_deleted_finished",function(e,t){t.action||(t.action="Deleted"),t.undoRuleName||(t.undoRuleName=pgcssh.getNodeDisplayName(t.node)),s(t.stylesheet,t)}),pinegrow.addEventHandler("on_css_node_updated",function(e,t){t.action="Set",t.undoRuleName||(t.undoRuleName=pgcssh.getNodeDisplayName(t.node)),s(t.stylesheet,t)}),pinegrow.addEventHandler("on_css_updated",function(e,t){t.action="Set",t.undoRuleName||(t.undoRuleName="Style"),s(t.stylesheet,t)}),pinegrow.addEventHandler("on_css_rule_changed_in_code_editor",function(e,t){var n=t.list[0],o=t.node;s(n,{action:"Edit rule",undoRuleName:pgcssh.getNodeDisplayName(o)})}),pinegrow.addEventHandler("on_stylesheet_closed",function(e,t){l.has(t)&&l.delete(t),u.has(t)&&u.delete(t),a.getCssHistory().purge(function(e){return!(!e.events.length||!e.events[0].event.cs||e.events[0].event.cs!=t)})}),t.start()}),PgUndoHistory=function(a){function r(e){return f=f||new PgUndoState(a)}function i(e,t){var n;0<=u&&l.length>u?(v=l[u],p=l[n=u].selectedElementsAtStart,u--,l[n].undo(e,t)):(pinegrow.showQuickMessage("Nothing to undo."),t&&t(!0))}function d(e,t){u<l.length-1?(v=l[++u],p=l[u].selectedElementsAtEnd,l[u].redo(e,t)):(pinegrow.showQuickMessage("Nothing to redo."),t&&t(!0))}var l=[],u=-1,h=this,c=40,g=(this.startState=null,null),p=null,v=null,f=null,m=(this.css=!1,this.getCurrentStateId=function(e){return u<0?-1:e?l[u].stateId:u+1<l.length?l[u+1].stateId:-1},this.purge=function(e){for(var t=u,n=[],o=0;o<l.length;o++)e(l[o])?o<=u&&t--:n.push(l[o]);f=t<0?(t=-1,null):(u=t,f&&l[u]),l=n},this.getInfo=function(e){return{combined:[],states:l,current_idx:u,current_state:0<=u&&u<l.length?l[u]:null,start_state:this.startState}},this.addEvent=function(e){var t,n=r();e instanceof PgUndoEvent?(n.element_names||(t=e.getElement())&&(n.element_names=t.getName({short:!0})),n.page_name||(n.page_name=e.event.page.getName())):n.cs_name||(n.cs_name=e.event.cs.name),n.add(e)},this.changeDone=function(e,t,n,o,s){var i,d;r().name=e,f.events.length&&(pgIsDev()&&1e3<f.events.length&&console.error("Undo stack is huge.",f),0===f.events.length&&pgIsDev()&&console.warn("Empty list of Undo state events!",f),f.combineKey=t,f.sourceId=n,f.undoData=o,s&&(f.element_names=s),null===f.selectedElementsAtEnd&&(f.selectedElementsAtEnd=pinegrow.selectedElements.getIds()),i=!1,u<l.length-1?u<0?l=[]:l.splice(u,l.length-u):0<=u&&u<l.length&&(d=l[u]).combineKey&&t&&d.combineKey==t&&d.sourceId==n&&(new Date).getTime()-d.lastChanged<2e3&&(f.events.forEach(function(e){d.add(e)}),d.selectedElementsAtEnd=f.selectedElementsAtEnd,i=!0),i||(l.push(f),l.length>c&&(this.startState=l[l.length-c-1],this.startState.events=[],l.splice(0,l.length-c),changed=!0),u=l.length-1,pinegrow.dispatchEvent("on_undo_state_added",a,f))),f=null},this.setSelectedElementsAtEnd=function(e){f&&(f.selectedElementsAtEnd=e)},this.setSelectedElementsAtStart=function(e){f&&(f.selectedElementsAtStart=e)},this.undo=function(){g=new PgCollection,this.undoOrRedo="undo",this.start();try{i(g,this.done)}catch(e){if(this.done(!0),pinegrow.showQuickMessage("Oops... Error during undo."),console.error("Error during undo",e),pgIsDev()&&pgTestMode)throw e}},this.redo=function(){g=new PgCollection,this.undoOrRedo="redo",this.start();try{d(g,this.done)}catch(e){this.done(!0),pinegrow.showQuickMessage("Oops... Error during redo."),console.error("Error during redo",e)}},this.restoreState=function(e,t){var n,o,s=-1;e&&(s=l.indexOf(e))<0?pinegrow.showQuickMessage("Invalid undo state"):s!=u&&(g=new PgCollection,this.start(),n=s<u?i:d,(o=function(){s!=u?n(g,o):(h.done(),t&&t())})())},!1),n=(this.start=function(){p=null,m=!0},this.done=function(e){var o,s,t,n,i,d;e||(o={source:this,sourceType:"undo",undoOrRedo:h.undoOrRedo},s=[],t=null,v&&(o.undoSourceId=v.sourceId,o.undoData=v.undoData,v.events.forEach(function(e){e.event&&e.event.page&&s.indexOf(e.event.page)<0&&(s.push(e.event.page),t=e.event.page)})),n=new PgCollection,i=new PgCollection,g.forEachElement(function(e){e instanceof pgParserNode?n.add(e):i.add(e.cs)}),d=s.slice(0),n.forEachPage(function(e,t){pinegrow.changeManager.didChange(t,"Undo / redo op",o,e);var n=s.indexOf(e);0<=n&&s.splice(n,1)}),s.forEach(function(e){pinegrow.changeManager.didChangePage(e,"Undo / redo op",o)}),i.getLength()&&(o.cs_col=i),o.pages=d,o.pgel_col=n,pinegrow.dispatchEvent("on_undo_redo",a||t,o),i.forEachElement(function(e){pinegrow.stylesheets.applyToPages(e)}),p?(pinegrow.selectedElements.selectIds(p,o),p=null):pinegrow.selectedElements.repositionMenus()),g=v=null,m=!1},this.isUndoOperationInProgress=function(){return m},!1);this.isIgnore=function(){return n},this.ignore=function(e){var t=n;n=!0,e(),n=t},this.destroy=function(){l=[],u=-1,f=v=p=g=null}},pgUndoStateId=0,PgUndoState=function(e){this.element_names=null,this.name=null,this.page=e,this.events=[],this.selectedElementsAtStart=pinegrow.selectedElements.getIds(),this.selectedElementsAtEnd=null,this.lastChanged=null,this.combineKey=null,this.sourceId=null,this.undoData=null,this.stateId=pgUndoStateId++,this.pages=[]},PgCSSUndoEvent=(PgUndoState.prototype.add=function(e){this.events.length&&this.events[this.events.length-1].combine&&this.events[this.events.length-1].combine(e)||this.events.push(e),this.lastChanged=(new Date).getTime(),e?.event?.page&&this.pages.indexOf(e.event.page)<0&&this.pages.push(e.event.page)},PgUndoState.prototype.undo=function(e,t){function n(){0<=--o?s.events[o].undo(e,n):t()}var o=this.events.length,s=this;n()},PgUndoState.prototype.redo=function(e,t){function n(){++o<s.events.length?s.events[o].redo(e,n):t()}var o=-1,s=this;n()},function(e){this.event=e,this.data={},this.operation=this.operations[e.operation]||null,this.operation||console.log("UNSUPPORTED UNDO OP: "+e.operation)}),PgUndoEvent=(PgCSSUndoEvent.prototype.getElement=function(e){return(e=e||(this.event.position?this.event.position.indices:null))?pinegrow.pgPostCSSHelper.getNodeByIndices(this.event.cs.getRootNode(),e):null},PgCSSUndoEvent.prototype.isSameRule=function(e){if(!this.event.position||!e.event.position)return!1;var t=this.event.position.indices,n=e.event.position.indices;if(t.length!=n.length)return!1;for(var o=0;o<t.length;o++)if(t[o]!=n[o])return!1;return!0},PgCSSUndoEvent.prototype.combine=function(e){return this.operation==e.operation&&this.event.cs===e.event.cs&&(this.event.newValue=e.event.newValue,!0)},PgCSSUndoEvent.prototype.undo=function(e,t){try{var n=this.getElement();e&&e.add(this.event),this.operation.undo.call(this,n,t)}catch(e){console.log("CSS Undo error "+e),t()}},PgCSSUndoEvent.prototype.redo=function(e,t){try{var n=this.getElement();e&&e.add(this.event),this.operation.redo.call(this,n,t)}catch(e){console.log("CSS Redo error "+e),t()}},PgCSSUndoEvent.prototype.operations={nodeUpdated:{undo:function(n,e){this.data.originalValue={value:n.value,prop:n.prop},$.each(this.event.oldValue,function(e,t){n[e]=t}),pinegrow.dispatchEvent("on_css_node_updated",null,{node:n,stylesheet:this.event.cs,edited_by:"undo",source_type:"undo"}),e()},redo:function(n,e){$.each(this.data.originalValue,function(e,t){n[e]=t}),pinegrow.dispatchEvent("on_css_node_updated",null,{node:n,stylesheet:this.event.cs,edited_by:"undo",source_type:"undo"}),e()}},codeUpdated:{undo:function(e,t){var n=this;this.event.cs.setSource(this.event.oldValue,function(){pinegrow.dispatchEvent("on_css_source_changed",null,{list:[n.event.cs]}),t()})},redo:function(e,t){var n=this;this.event.cs.setSource(this.event.newValue,function(){pinegrow.dispatchEvent("on_css_source_changed",null,{list:[n.event.cs]}),t()})}},ruleUpdated:{undo:function(o,s){var i=this;this.data.code=pinegrow.pgPostCSSHelper.getSource(o),this.event.cs.parseSource(this.event.oldValue,function(e,t,n){e?console.log("CSS Undo - "+e):(pinegrow.pgPostCSSHelper.replaceNodeWithAndUpdatePgId(o,n.nodes[0]),pinegrow.dispatchEvent("on_css_node_updated",null,{node:n.nodes[0],stylesheet:i.event.cs,edited_by:"undo",source_type:"undo"})),s()})},redo:function(o,s){var i=this;this.event.cs.parseSource(this.data.code,function(e,t,n){e?console.log("CSS Undo - "+e):(pinegrow.pgPostCSSHelper.replaceNodeWithAndUpdatePgId(o,n.nodes[0]),pinegrow.dispatchEvent("on_css_node_updated",null,{node:n.nodes[0],stylesheet:i.event.cs,edited_by:"undo"})),s()})}}},function(e){this.event=e,this.data={},this.operation=this.operations[e.operation]||null,this.operation}),CrsaUndoState=(PgUndoEvent.prototype.getElement=function(e){return(e=void 0===e?this.event.pgId:e)?pgParserNodeCatalogueInstance.get(e):this.event.text?pgCreateNodeFromHtml(this.event.text):null},PgUndoEvent.prototype.combine=function(e){return!(this.operation!=e.operation||this.event.pgId!==e.event.pgId||!this.operation.combine||!this.operation.combine.call(this,e))},PgUndoEvent.prototype.undo=function(e,t){try{var n=this.getElement();n&&e&&e.add(n),this.operation.undo.call(this,n,this.event.objectId?this.getElement(this.event.objectId):null,e)}catch(e){if(console.log("Undo error "+e),pgIsDev()&&pgTestMode)throw e}t()},PgUndoEvent.prototype.redo=function(e,t){try{var n=this.getElement();n&&e&&e.add(n),this.operation.redo.call(this,n,this.event.objectId?this.getElement(this.event.objectId):null,e)}catch(e){console.log("Redo error "+e)}t()},PgUndoEvent.prototype.operations={addClass:{undo:function(e){e.removeClass(this.event.data.class)},redo:function(e){e.addClass(this.event.data.class)}},removeClass:{undo:function(e){this.event.data.hadClass&&e.addClass(this.event.data.class)},redo:function(e){e.removeClass(this.event.data.class)}},html:{undo:function(e){e.html(this.event.data.oldValue)},redo:function(e){e.html(this.event.data.html)},combine:function(e){return this.event.data.html=e.event.data.html,!0}},setAttr:{undo:function(e){this.event.data.oldValue?e.setAttr(this.event.data.oldValue.name,this.event.data.oldValue.value,null,this.event.data.oldValue.quote||null):e.removeAttr(this.event.data.attr)},redo:function(e){e.setAttr(this.event.data.attr,this.event.data.value,null,this.event.data.quote)},combine:function(e){return this.event.data.attr==e.event.data.attr&&(this.event.data.value=e.event.data.value,this.event.data.quote=e.event.data.quote,!0)}},removeAttr:{undo:function(e){this.event.data.oldValue&&e.setAttr(this.event.data.oldValue.name,this.event.data.oldValue.value)},redo:function(e){e.removeAttr(this.event.data.attr)}},remove:{undo:function(e,t,n){var o=getPgNodeByPgId(this.event.data.oldValue.parentId),s=pgCreateNodeFromHtml(this.event.data.oldValue.html);s.insertAtIndex(o,this.event.data.oldValue.position),n&&n.add(s)},redo:function(e){e.remove()}},appendPrepend:{undo:function(e){var t;this.data.html=e.toStringWithIds(),this.data.positionBeforeUndo=e.getPositionInfo(),e.isElement?this.event.data.oldValue.position?e.placeAtPositionInfo(this.event.data.oldValue.position):e.remove():(this.event.data.oldValue.parent&&(t=this.getElement(this.event.data.oldValue.parent),this.data.parentHtmlBeforeUndo=t.html(null,!0),t.html(this.event.data.oldValue.parentHtml)),t=this.getElement(this.event.objectId),this.data.destHtmlBeforeUndo=t.html(null,!0),t.html(this.event.data.oldValue.destHtml),e.remove())},redo:function(e,t,n){!e&&this.data.html&&(e=pgCreateNodeFromHtml(this.data.html),n)&&n.add(e),e.isElement?(this.event.data.oldValue.position||(e=pgCreateNodeFromHtml(this.data.html),n&&n.add(e)),e.placeAtPositionInfo(this.data.positionBeforeUndo)):(this.event.data.oldValue.parent&&this.getElement(this.event.data.oldValue.parent).html(this.data.parentHtmlBeforeUndo),this.getElement(this.event.objectId).html(this.data.destHtmlBeforeUndo))}},updateInner:{undo:function(e){var t;this.data.html=e.html(null,!0),e.html(this.event.data.oldValue),"style"===e.tagName&&(t=pinegrow.stylesheets.findCrsaInlineStylesheet(e))&&t.setSource(this.event.data.oldValue,function(){pinegrow.dispatchEvent("on_css_source_changed",null,{list:[t],edited_by:"undo"})})},redo:function(e){var t;e.html(this.data.html),"style"===e.tagName&&(t=pinegrow.stylesheets.findCrsaInlineStylesheet(e))&&t.setSource(this.data.html,function(){pinegrow.dispatchEvent("on_css_source_changed",null,{list:[t],edited_by:"undo"})})}},update:{undo:function(e,t,n){this.data.html=e.toStringWithIds();var o=pgCreateNodeFromHtml(this.event.data.oldValue);e.replaceWith(o),this.event.pgId=o.getId(),n&&n.add(o)},redo:function(e,t,n){var o=pgCreateNodeFromHtml(this.data.html);e.replaceWith(o),this.event.pgId=o.getId(),n&&n.add(o)}},removeAllChildren:{undo:function(e){this.data.html=e.html(null,!0),e.html(this.event.data.oldValue)},redo:function(e){e.html(this.data.html)}},replaceWith:{undo:function(e,t,n){this.data.html=(e=t).toStringWithIds();var o=pgCreateNodeFromHtml(this.event.data.oldValue);e.replaceWith(o),this.event.pgId=o.getId(),n&&n.add(t)},redo:function(e,t,n){var o=pgCreateNodeFromHtml(this.data.html);e.replaceWith(o),this.event.pgId=o.getId(),n&&n.add(o)}},detag:{undo:function(e){var t=getPgNodeByPgId(this.event.data.oldValue.parentId);this.data.parentHtml=t.html(null,!0),t.html(this.event.data.oldValue.parentHtml)},redo:function(e){getPgNodeByPgId(this.event.data.oldValue.parentId).html(this.data.parentHtml)}},setCode:{undo:function(e){var t=this,n=(this.data.html=this.event.page.sourceNode.toStringWithIds(!0),new pgParser);n.assignIds=!0,n.parse(this.event.data.oldValue),this.event.page.sourceNode&&this.event.page.sourceNode.withoutEvents(function(){t.event.page.sourceNode.remove()}),this.event.page.sourceNode=n.rootNode,this.event.page.refresh(null,!0)},redo:function(e){var t=this,n=new pgParser;n.assignIds=!0,n.parse(this.data.html),this.event.page.sourceNode&&this.event.page.sourceNode.withoutEvents(function(){t.event.page.sourceNode.remove()}),this.event.page.sourceNode=n.rootNode,this.event.page.refresh(null,!0)},combine:function(e){return!0}}},PgUndoEvent.prototype.operations.insertBefore=PgUndoEvent.prototype.operations.insertAfter=PgUndoEvent.prototype.operations.appendPrepend,function(e,t,n){n&&n.url;var o=[],d=(o.push({obj:e,data:e.sourceNode.toStringWithIds(!0,pinegrow.getFormatHtmlOptions())}),getCrsaPageStylesForPage(e.$iframe),n&&o.push({obj:n,data:n.getSource()}),o.push({obj:"breakpoints",data:e.breakpoints.slice(0)}),this.page=e,this.data=o,this.name=t,this.active=!0,this);this.apply=function(t){for(var e,n=0,o=null,s=0;s<this.data.length;s++){var i=this.data[s];"breakpoints"===i.obj?o.obj.breakpoints=i.data:i.obj instanceof CrsaPage?o=i:i.obj instanceof PgStylesheet&&(n++,i.obj.setSource(i.data,function(){var e;0==--n&&(e=new pgParser).parse(o.data,function(){o.obj.sourceNode=e.rootNode,t&&t(d)})}))}0==n&&o&&(e=new pgParser).parse(o.data,function(){o.obj.sourceNode=e.rootNode,t&&t(d)})}}),CrsaPageUndoStack=function(e){var i=[],d=-1,n="undo";this.page=e;this.add=function(e,t,n){t&&!n&&(n=function(){if(0!=i.length)for(var e=i[i.length-1].data,t=0;t<e.length;t++)if(e[t].obj instanceof PgStylesheet)return e[t].obj;return null}());var o,s=new CrsaUndoState(this.page,e,n);return i.length>d+1&&i.splice(d+1,i.length-(d+1)),i.push(s),t||(o=20)<++d&&(o=d-o,i.splice(0,o),d-=o),s},this.isAtTheTip=function(){return 0<=d&&i.length==d+1},this.remove=function(){if(d<0)return null;d--,i.splice(d+1,1)},this.undo=function(e){if(d<0+("undo"==n?0:1))return e&&e(null),null;"undo"!=n&&--d;var t=i[d];return--d,t.apply(e),n="undo",t},this.redo=function(e){var t="undo"==n?2:1;return d+t>=i.length?(e&&e(null),null):((t=i[d+=t]).apply(e),n="redo",t)}},CrsaUndo=function(){};