var CrsaProjectBrowser=function(e){var P=this,F=(this.options=null,this.crsaProjects=null,this.onFileSelected=null,this.title=null,this.intro=null,this.selectedProject=null,this.opts=$.extend({},{modal:!0},e),this.setProjects=function(e){this.crsaProjects=e},{"bootstrap 4":"Based on Bootstrap 4.","bootstrap 5":"Based on Bootstrap 5.","tailwind 2":"Based on Tailwind CSS 2.x.","multi-page":"Includes multiple templates for different types of sub-pages.","design panel":"Design can be customized with the Design panel.","pg 6.1":"Requires Pinegrow 6.1 or higher."});this.show=function(e){e=e||!1;function i(e,t){if(t.framework&&(!t.show_only_master_pages||!$.isEmptyObject(t.framework.master_pages))){var i=!t?.not_popular,a="project-browser-tab-"+e,i=$(`<li data-popular="${i}"><a href="#`+a+'" data-toggle="pill">'+t.name+(t.info_badge?' <span class="info-badge">'+t.info_badge+"</span>":"")+"</a></li>").appendTo(y),a=$('<div class="tab-pane aafade" id="'+a+'"><div class="project-info"></div><ul></ul></div>').appendTo(T),s=a.find("ul"),l=[];if(t.show_only_master_pages){P.selectedProject||(P.selectedProject=t);var n,r=t.framework.master_pages;for(n in r){var o=jQuery.extend(!0,{},r[n]);o.tag="master_page",l.push(o)}}else{for(var d=0;d<t.root.children.length;d++)void 0===t.root.children[d].order&&(t.root.children[d].order=d);l=t.root.children.sort(function(e,t){return e.order>t.order?1:e.order<t.order||void 0===t.order?-1:void 0===e.order?1:void 0})}for(d=0;d<l.length;d++){var p,c,h,u,f,g,m,v=l[d],b=null;"master_page"==v.tag?(p=v.image+"?v="+pinegrow.cache_breaker,(v=v.file)?(b=$("<li/>",{class:"item"}).html("<h3>"+(v.desc_name||v.name)+"</h3>").data("file",v).data("project",t).appendTo(s),$("<img/>",{src:v.image_direct||p}).prependTo(b)):b=$("<li/>",{class:"item reload-master-page"}).html("<h3>Master Page</h3><p>Reload & update components first</p>").data("file","").data("project",t).appendTo(s)):v.isFile&&"page"==v.tag&&(b=$("<li/>",{class:"item"}).html("<h3>"+(v.desc_name||v.name)+"</h3>").data("file",v).data("project",t).appendTo(s),v.subpages&&!1||(v.video&&0?function(i){b.on("mouseenter",function(e){var t=i.get(0);t&&t.play&&t.play()}),b.on("mouseleave",function(e){var t=i.get(0);t&&t.pause&&(t.currentTime=0,t.pause())})}($(`<video poster="${v.image_direct}" muted="false" loop="true" src="${v.video}">`).appendTo(b)):(v.image_direct||v.image)&&(p=$("<img/>",{src:v.image_direct||v.image,class:"thumb"}).prependTo(b),v.image_class)&&p.addClass(v.image_class)),v.description&&(c=$('<div class="description">'+v.description+"</div>").appendTo(b),b.addClass("with-description"),h=$(`<div class="buttons"></div>`).appendTo(c),u=null,v.subpages?(u=$(`<button class="pg-button pg-button-primary">Select a page</button>`).appendTo(h),addTooltip(u,"This template has multiple pages. Click to show all and then select one.")):(u=$(`<button class="pg-button pg-button-primary">Open</button>`).appendTo(h),addTooltip(u,"Open the template in Pinegrow.")),s.addClass("grid"),v.template_data&&v.template_data.description_tags&&v.template_data.description_tags.length&&(f=$(`<ul class="tags"></ul>`),c.prepend(f),v.template_data.description_tags.forEach(function(e){var t=F[e.toLowerCase()]||null,i=$(`<li>${e}</li>`).appendTo(f);t&&addTooltip(i,t)})),crsaIsRemoteUrl(v.url)&&addTooltip($(`<a href="${v.url}" class="external preview-link pg-button">Preview</a>`).appendTo(h),"Preview the template in the browser."),v.template_data&&v.template_data.helplink&&(g=$(`<a href="${v.template_data.helplink}" class="external help-link pg-button">Guide</a>`),u?g.insertAfter(u):h.append(g),addTooltip(g,"Learn how to use and customize this template.")),v.subpages)&&(b.addClass("with-subpages"),m=$(`<div class="subpages" style="overflow:hidden;"></div>`).appendTo(c),v.subpages_open?m.addClass("open"):m.css({}),v.subpages.forEach(function(e){var t=$(`<div data-url="${e.url}" data-name="${e.name}"><img src="${e.image_direct}"><p>${e.name}</p></div>`).appendTo(m);t.data("file",e),addTooltip(t.find(".preview-icon"),"Preview the template in the browser.")})),_==v)&&(b.addClass("selected"),j=b),b&&crsaHandleExternalLinks(b)}var w,k="";t.description&&(k+=t.description),t.author&&(k+=(k.length?" | ":"")+'By <a href="'+t.author_link+'">'+t.author+"</a>"),k.length&&((w=a.find(".project-info")).html("<p>"+k+"</p>"),w.find("a").addClass("external"),crsaHandleExternalLinks(w)),(P.selectedProject?P.selectedProject===t:C)&&(i.addClass("active"),a.addClass("active in"),i.attr("data-popular","true")),i.tab(),C=!1}}function r(e,t){e.addClass("open"),t.subpages_open=!0,pinegrow.showQuickMessage("Select a page template from the list.")}var _=null,j=null,t=$("<div/>",{class:"project-browser"}).html('<div class="container-fluid">'+'<div class="row">'+'<div class="col-md-4 col-lg-3 col-xl-2 pills"></div>'+'<div class="col-md-8 col-lg-9 col-xl-10 tabs"></div>'+"</div>"+"</div>"),y=$('<ul class="nav nav-pills nav-stacked"></ul>').appendTo(t.find(".pills")),T=$('<div class="tab-content"></div>').appendTo(t.find(".tabs")),a=`padding: 10px;
    display: block;
    background-color: #ffffff;
    margin-top: 5px;
    padding-left: 0;`,s=$(`<a class="show-all" href="#" style="${a}">Some older frameworks are hidden. Show all...</a>`),l=$(`<a class="show-popular" style="${a}" href="#">Show only the most used frameworks...</a>`),C=(t.find(".pills").append([s,l]),l.on("click",function(e){e.preventDefault(),y.find('[data-popular="false"]').hide(),l.hide(),s.show()}),s.on("click",function(e){e.preventDefault(),y.find('[data-popular="false"]').show(),l.show(),s.hide()}),!0),o=(e?i(0,this.selectedProject):(this.crsaProjects.sort(function(e,t){return(void 0===e.templateBrowserIndex?10:e.templateBrowserIndex)-(void 0===t.templateBrowserIndex?10:t.templateBrowserIndex)}),$.each(this.crsaProjects,function(e,t){i(e,t)})),l.trigger("click"),this.intro&&(a=$(this.intro).prependTo(t),isApp())&&a.find("a").on("click",function(e){e.preventDefault();var t=require("nw.gui"),i=$(e.delegateTarget).attr("href");t.Shell.openExternal(i)}),makeModalDialog(this.title||"Select item","Close",null,t,function(){},function(){},function(e){e.addClass("project-browser-modal")}));T.find("li.item").not(".reload-master-page").not(".with-subpages").on("click",function(e){var t=$(e.delegateTarget),i=t.data("file");j&&(j.removeClass("selected"),j=null),_==i?_=null:(_=i,(j=t).addClass("selected")),P.onFileSelected&&P.onFileSelected(i,t.data("project")),o.modal("hide"),e.preventDefault()});T.find("li.item.with-subpages").on("click",function(e){var t=$(this),i=t.data("file"),t=t.find(".subpages",i);t.hasClass("open")?(t.removeClass("open"),i.subpages_open=!1):r(t,i),e.preventDefault()}),T.find("li.item .subpages > div").on("click",function(e){e.preventDefault(),e.stopPropagation();var t,i,a=$(this),s=a.attr("data-url"),l=a.attr("data-name"),n=a.closest(".subpages");n.hasClass("open")?(t=a.data("file"),(i=new CrsaFile).isFile=!0,i.name=l,i.url=s,t.remove_components&&(i.remove_components=!0),t.remove_local_links&&(i.remove_local_links=!0),P.onFileSelected&&P.onFileSelected(i,a.closest("li.item").data("project")),o.modal("hide")):r(n,a.closest(".item").data("file"))})}},CrsaMultiChooser=function(d){d=d||[];var p=[];this.addItem=function(e,t,i){d.push({question:e,key:t,choices:i})};this.show=function(e,t){if(d.length){e=e||"Please choose files";for(var i=$("<div><p>"+e+"</p></div>"),a=$('<table class="file-writer table table-striped table-condensed table-hover"><tbody></tbody></table>').appendTo(i).find("tbody"),s=0;s<d.length;s++)for(var l=d[s].choices,n=($("<tr><td><b>&nbsp;"+d[s].question+"</b></td></tr>").appendTo(a),0);n<l.length;n++){var r=crsaGetSummaryStr(l[n],100);$('<tr data-index="'+s+'" data-chosen-item="'+n+'"><td><label title="'+l[n]+'"><input type="radio" value="1" name="file-'+s+'" />&nbsp;'+r+"</label></td></tr>").appendTo(a)}makeModalDialog("Choose Files","Cancel","Ok",i,function(){t&&t()},function(){o.each(function(e,t){var i=$(t),a=i.closest("tr"),s=parseInt(a.attr("data-index")),a=parseInt(a.attr("data-chosen-item")),a=d[s].choices[a];i.is(":checked")&&(t=d[s].key,p[t]=a)}),t&&t(p)});var o=a.find('input[type="radio"]')}else t&&t()}},pgRecentFiles=function(){this.list=[];function s(e){for(var t=0;t<d.list.length;t++)if(d.list[t].file==e)return t;return-1}function r(e){var t,i,a,s=$(e.target).parent();s.hasClass("menu-file-recent")&&((t=$(".submenu-file-recent")).is(":visible")?t.css("display","none"):(t.css("display","block"),t.css("height","auto"),t.css({display:"block",height:"auto",top:s.offset().top-3,left:s.width()}),s=t.offset().top,i=t.height()+s,(a=$(window).height())<i&&(0<(s=s+(a-i)-10)?t.css({top:s}):t.css({top:0,height:a})))),e.preventDefault()}function o(e){var t,i=(s=$(e.delegateTarget)).attr("href")||s.attr("data-file"),a=!!s.attr("data-project"),s=!0;a?canOpenProject()&&(isApp()&&"dir"!=crsaIsFileOrDir(i)?pinegrow.showAlert("Project folder may be deleted or moved to another directory.","Project folder not found"):($("body").trigger("crsa-recent-files-item-clicked"),t=new CrsaProject,isApp()?t.fromFolder(i,function(e){pinegrow.setCurrentProject(e),crsaQuickMessage("Project was loaded."),pinegrow.showTab("project")},!0):t.fromServer(i,function(e){pinegrow.setCurrentProject(e)}),pinegrow.stats.using("app.openproject"))):i.startsWith("internal:")?(t=i.replace("internal:",""),pinegrow.openExample(t),s=!1):crsaIsFileUrl(i)&&"file"!=crsaIsFileOrDir(crsaMakeFileFromUrl(i))?pinegrow.showAlert("File may be deleted or moved to another directory.","File not found"):($("body").trigger("crsa-recent-files-item-clicked"),crsaIsFileUrl(i)||!pinegrow.isPRO()&&!pinegrow.isProTrialActive()||pinegrow.getCurrentProject()?pinegrow.openOrShowPage(i):pinegrow.showOpenUrlDialogAndOpenPage(null,i),pinegrow.stats.using("app.openfile")),s&&setTimeout(function(){d.add(i,a)},100),e.preventDefault()}var d=this,p=100,c=(this.add=function(e,t){if(void 0===t&&(t=!1),!e.startsWith("internal:")){if(!t)for(var i,a=crsaMakeFileFromUrl(e),s=0;s<this.list.length;s++)if(this.list[s].project&&a.startsWith(this.list[s].file))return i=this.list[s],this.list.splice(s,1),this.list.unshift(i),this.remove(e,!0),h(),void c();var l=this.remove(e,!0);if(this.list.unshift({file:e,project:t,sticky:l&&l.sticky||!1}),t)for(var n=crsaMakeUrlFromFile(e),s=1;s<this.list.length;s++)!this.list[s].project&&this.list[s].file.startsWith(n)&&this.list.splice(s,1);if(this.list.length>p){for(var r=[],o=0,s=0;s<this.list.length;s++)this.list[s].sticky?r.push(this.list[s]):o<p&&(r.push(this.list[s]),o++);this.list=r}h(),c()}},this.isEmpty=function(){return 0===this.list.length},this.remove=function(e,t){var i=null,a=s(e);return 0<=(a=a<0?s(crsaMakeFileFromUrl(e)):a)&&(i=this.list[a],this.list.splice(a,1)),t||(c(),h()),i},this.removeAll=function(){for(var e=[],t=0;t<this.list.length;t++)this.list[t].sticky&&e.push(this.list[t]);this.list=e,c(),h()},function(){var e=JSON.stringify(d.list);localStorage.pgRecentFiles=e}),h=function(){for(var e=$(".menu-file-recent"),t=$(".submenu-file-recent").html(""),i=($(".recent-files"),$(".recent-files ul").html("")),a=(!pinegrow.thumbnailMaker.enabled||pinegrow.hasInternalServer()||pgf.use_server,t.css("display","none"),closeAllTooltips(),d.list.map(function(e){return e.project?crsaMakeUrlFromFile(e.file):e.file})),a=(pgGetUniqueShortNamesForUrls(a),!1),s=0;s<d.list.length;s++){var l=pgUrlToDisplayString(d.list[s].file),l=(50<l.length&&(l="&hellip;"+l.substr(l.length-50)),d.list[s].project&&(l+="<small>prj</small>"),'<li><a href="'+d.list[s].file+'"'+(d.list[s].project?' data-project="true"':"")+' class="menu-file-recent-item">'+l+"</a></li>");t.append(l)}a?i.addClass("with-thumbnails"):i.removeClass("with-thumbnails"),e.find("> a").off("click",r).on("click",r);function n(){$(".submenu-file-recent").css("display","none")}$(".menu-file").off("hidden.bs.dropdown",n),$(".menu-file").on("hidden.bs.dropdown",n),t.find("li > a").on("click",o),i.find("li.recent-item").on("click",o),0&&isApp()&&(a=$('<li class="clear-recent">Options</li>'),i.append(a),a.on("click",function(e){return e.preventDefault(),new CrsaContextMenu([{label:"Clear the recent list",action:function(){d.removeAll()}},{label:"Show thumbnails",check:function(){return pinegrow.thumbnailMaker.enabled},action:function(){pinegrow.thumbnailMaker.setEnabled(!pinegrow.thumbnailMaker.enabled),pinegrow.showMode("Show and save thumbnails",pinegrow.thumbnailMaker.enabled),h()}}]).showForElement($(this),$("#pg-start-screen-container")),!1})),$(".menu-file-parent").on("hide.bs.dropdown",function(){$(".submenu-file-recent").css("display","none")}),isApp()&&pinegrow.updateStartScreen()};if(isApp()&&localStorage.pgRecentFiles){this.list=JSON.parse(localStorage.pgRecentFiles);for(var e=[],t=0;t<this.list.length;t++)"string"==typeof this.list[t]?e.push({file:this.list[t],project:!1}):e.push(this.list[t]);this.list=e}this.update=h,this.populate=function(){pinegrow.dispatchEvent("on_recent_list_populate",null,this.list),this.update()},this.populate();var i=new PgDelayedTasks;pinegrow.addEventHandler("on_server_created",function(){h()}),pinegrow.addEventHandler("on_thumbnail_generated",function(){i.run("updateOnThumbnailGenerated",h,1e3)})};