var PgProjectDB=function(t){function r(){return t.getAbsolutePath(d)}function n(e){return t.getRelativeUrl(e)}function i(){var e=new PgEmulatePageForUndo;((e.sourceNode=s).emulatedPage=e).name="Project",h=e}function e(e,t){if(h&&t&&t.pages)for(var n=0;n<t.pages.length;n++)if(t.pages[n]===h){u.changed(t.pgel_col,{source:"undo",undo_info:t});break}}function o(){var e=pinegrow.getCurrentProject();e&&e.db&&e.db.is_changed&&e.db.save()}var a,s,u=this,d="projectdb.pgml",c=!0,l=(this.is_loaded=!1,this.is_changed=!1,null),g=new Map,f=(this.isInitialized=function(){return null!==l},this.init=function(e){if(this.load())this.is_loaded=!0,0;else{if(e)return!1;this.create()}return!0},{}),h=null,p=(this.load=function(e){try{if(e&&e.loaded_from_backend){if(!(t=e?e.getContentOfUrl(d):t))throw"Project DB does not exist."}else var t=require("fs").readFileSync(r(),{encoding:"utf8"});var n=new pgParser;return n.assignIds=c,n.parse(t),g.clear(),s=n.rootNode,l=n.rootNode.findOne("project"),(a=l.findOne("documents")).find(">document").forEach(function(e){var t=e.getAttribute("url");g.set(t,e),f[t]=e.html()}),i(),!0}catch(e){}return!1},this.restoreSavedDocument=function(e){var t;e=n(e),f[e]&&((t=g.get(e))&&t.html(f[e],null,null,!0),this.changed())},this.rememberSavedDocument=function(e){e=n(e);var t=g.get(e);t&&(f[e]=t.html())},this.create=function(){var e=new pgParser;e.assignIds=c,e.parse("<project></project>"),s=e.rootNode,l=s.findOne("project"),a=v("documents"),l.append(a),i()},this.getProjectNode=function(){return l},this.findOne=function(e){return l?l.findOne(e):null},this.getOrCreateNode=function(e,t){var n=(t=t||l).findOne("> "+e);return n||(n=v(e),t.append(n)),n},this.getDocumentNode=function(e){e=n(e);var t=g.get(e);return t||(t=v("document",{url:e}),a.append(t),g.set(e,t),t.append(v("elements"))),t},this.getElementNodeForPgel=function(e,t){t=t||e.getPage();var n=e.getAttr("data-pg-sel");return this.getElementNodeForSelector(n,t)},this.getElementNodeForSelector=function(e,t){if(!e)return null;var n=null;if(!n)for(var r=this.getDocumentNode(t.url).findOne("elements").children,i=0;i<r.length;i++)if(r[i].getAttr("selector")===e){n=r[i];break}return n},this.getElementsWithIssues=function(){return l.find("element").filter(function(e){var t=e.getAttr("status");return"ok"!==t&&"unused"!==t})},this.createElementNode=function(e){return v("element",e)},this.createActionNode=function(e,t){var n=v("action",t);return n.attrList.unshift({name:"id",value:e,quote:'"'}),n},this.save=function(){t.loaded_from_backend?pinegrow.backend.saveDelayed():(crsaWriteFileWithBackup(null,r(),l.toStringOriginal(!0),"utf8"),this.is_changed=!1)},this.getHTMLSource=function(){return l.toStringOriginal(!0)},this.saveAsBackup=function(){var e=require("fs");crsaCopyFileSync(e,r(),r()+".backup"),e.unlinkSync(r())},null),m=(this.startBatchUpdates=function(){p&&this.endBatchUpdates("Project DB update"),p=new PgCollection,m=0},this.endBatchUpdates=function(e,t){p&&p.getLength()&&(pinegrow.makeChanges(p,e,function(){}),this.changed(null,{source:t})),p=null,m=0},0),v=(this.makeChanges=function(e,t,n,r){e=e||s,p?(p.add(e),n()):(1===++m?pinegrow.makeChanges(s.getPage(),t,n):n(),0===--m&&this.changed(null,{source:r}))},this.changed=function(e,t){this.is_changed=!0,pinegrow.dispatchEvent("on_projectdb_changed",null,e,t||{})},this.createNode=function(e,t,n){return v(e,t,n)},function(e,t,n){var r=new pgParserNode;if(r.tagName=r.tagNameOriginal=e,r.selfClosed=n||!1,r.closed=!0,r.closingTag=e,r.isElement=r.isElementOrScript=!0,r.attrListChanged=!0,r.attrList=[],t)for(const o in t)if(t.hasOwnProperty(o)){let e=t[o];var i='"';null!==e&&0<=e.indexOf('"')&&(0<=e.indexOf("'")?e=pgEncodeAttribute(e):i="'"),r.attrList.push({name:o,value:e,quote:i,name_lc:o.toLowerCase()})}return c&&(r.assignId(),r.nodeCatalogue.add(r)),r});pinegrow.addEventHandler("on_undo_redo",e);pinegrow.addEventHandler("on_page_saved",o),this.getDBNode=function(e,t,n){var r=(t=t||l).findOne(">"+e);return r||(r=v(e),t.append(r)),r},this.destroy=function(){pinegrow.removeEventHandler("on_undo_redo",e),pinegrow.removeEventHandler("on_page_saved",o),g.clear(),g=null}};