var PgThumbnailMaker=function(){var w,p,e,o=this,t=null,r=[],a=4e3,l=180*2,i=this.host="http://pinegrowthumbnails.com/",m=3*l,f=140*2*3,b=l/m,n="use-recent-thumbnails",u="1",v=(is_linux&&(u="0"),is_mac,this.enabled="1"==pinegrow.getSetting(n,u),this.setEnabled=function(e){this.enabled=e,pinegrow.setSetting(n,e?"1":"0"),e&&P()},isApp()&&(w=require("path"),p=w.join(nw.App.dataPath,"pg_pageimg"),crsaCreateDirs(p),(e=require("nw.gui")).Window.get().on("close",function(){t&&(t.close(!0),t=null)})),function(e){return is_windows&&(e=e.toLowerCase()),"pg_pageimg_"+md5(e)+".png"}),T=(this.getStoredThumbnailUrl=function(e){var n,t;return isApp()&&(n=v(e),t=w.join(p,n),crsaIsFileExist(t))?pgf.use_server?pinegrow.getProxyUrl(i+n):crsaMakeUrlFromFile(t):null},this.getStoredThumbnailFilePath=function(e){var n;return pgf.use_server?(n=e.replace(i,""),w.join(p,n)):crsaMakeFileFromUrl(e)},this.setProjectThumbnail=function(e,n){var t=v(e.getDir()),t=w.join(p,t);crsaCopyFileSync(null,n,t)},this.makeThumbnail=function(e,n,t){console.log("makeThumbnail - add to list "+e),function(e){for(var n=0;n<r.length;n++)if(r[n].url==e)return n;return-1}(e)<0&&r.unshift({url:e,project_url:n,force:t}),T||P()},!1),s=!0,_=null,y=null,g=function(n){t?n(t):e.Window.open("empty.html",{focus:!1,always_on_top:!1,title:"Say Cheese! This window is used for taking page screenshots for the start screen. Disable if needed.",width:m,height:f,show:!1},function(e){(t=e).on("loaded",function(){console.log("Thumb win loaded"),s&&_&&(s=!1,setTimeout(c,a))}),n(t),t.on("closed",function(){t=null})})},c=function(){try{$(t.window.document.body).css("overflow","hidden")}catch(e){}setTimeout(function(){try{var d=new CrsaProfile(!0,"makeThumbnail ["+_+"] - "),e=pgGetMainAppWindow(),n=(t.x=e.x,t.y=e.y,t.width=Math.min(m,e.width),t.height=Math.min(f,e.height),e.isAlwaysOnTop);e.setAlwaysOnTop(!0),t.show(),e.setAlwaysOnTop(n),t.capturePage(function(e){d.show("capturePage");var u=document.createElement("canvas"),s=Math.round(m),g=Math.round(f),c=(u.setAttribute("width",s),u.setAttribute("height",g),u.getContext("2d")),h=new window.Image;h.addEventListener("load",function(){try{d.show("imageLoaded");function t(){d.show("imageSaved"),pinegrow.dispatchEvent("on_thumbnail_generated",null,_),T=!1,P()}var e=Math.round(h.width/(1*m)),n=(console.log("makeThumbnail Info: img_w: "+h.width+", win_w: "+m+", retina: "+e),h),i=(c.drawImage(n,0,0,s,g),b<1?downScaleCanvas(u,b):u),o=v(_),r=w.join(p,o),a=(d.show("imageScale"),(a=i.toDataURL("image/png")).replace("data:image/png;base64,","")),l=new Buffer(a,"base64");require("fs").writeFile(r,l,function(e){var n;!e&&y?(n=v(y),n=w.join(p,n),require("fs").writeFile(n,l,function(e){t()})):(e?(console.log("Error saving thumbnail to "+r,e),T=!1,P):t)()})}catch(e){console.log("Thumbnail error: "+e),T=!1,P()}},!1),h.src=e},{format:"png",datatype:"datauri"})}catch(e){console.log("Thumbnail error: "+e),T=!1,setTimeout(P,1e3)}},100)},P=function(){var i;t&&t.hide(),0==r.length||T||!o.enabled?_&&t&&(_=null,t.window.location.href=pinegrow.httpServer.url+"/pginternal/thumbfactory"):(T=!0,i=r.pop(),g(function(e){s=!0,_=i.url,y=i.project_url;var n=_,t=pinegrow.getCrsaPageByUrl(_);crsaIsRemoteUrl(_)&&!t&&!i.force&&o.getStoredThumbnailUrl(_)?(T=!1,setTimeout(P,10)):(a=t||crsaIsFileUrl(_)?(n=pinegrow.getProxyUrl(_),2e3):4e3,e.window.location.href=n,console.log("makeThumbnail - loading "+_))}))},h={};pinegrow.addEventHandler("on_project_loaded",function(e){h={}}),pinegrow.addEventHandler("on_page_saved",function(e){var n,t,i,o;T||(n=null,(i=pinegrow.getCurrentProject())&&i.isPageInProject(e)&&(n=i.getDir()),pinegrow.getSelectedPage()===e&&(i=h[e.url]||0,5*60*1e3<(o=(new Date).getTime())-i)&&(h[e.url]=o,e.activeView)&&(t=n||e.url,i=v(t),o=w.join(p,i),T=!0,pinegrow.takePhotoOfPage(e,o,function(){T=!1,pinegrow.dispatchEvent("on_thumbnail_generated",null,t)},l)))}),0&&pinegrow.addEventHandler("on_page_loaded",function(e){var n=null,t=pinegrow.getCurrentProject();t&&t.isPageInProject(e)&&(n=t.getDir()),o.getStoredThumbnailUrl(n||e.url)||setTimeout(function(){o.makeThumbnail(e.url,n)},100)})};