var PgPaintToolManager=function(){var i,l=null;const s=$('<div class="pg-paint-tool-icon"></div>');function n(e){var t,o;"paint"===c&&(t=e.pageX,o=e.pageY,a.create(r).mutate(function(){i.css({top:o+"px",left:t+"px"})}))}var a=pgFastdomTasks,r="paintToolCursor",c=pinegrow.getSetting("paint-tools-mode","set");this.getMode=function(){return c},this.setMode=function(e){c=e,pinegrow.setSetting("paint-tools-mode",e),pinegrow.showMode("set"===e?"Set mode":"Paint mode",!0)};this.onMouseMoveOverPage=function(t){var e,o,s,n;l&&"paint"===c&&(e=$(t.target),o=getIframeOfElement(e))&&(s=getCrsaPageForIframe(o).getPageViewOf$DOMElement(e,o))&&(n=a.create(r)).measure(function(){var e=s.pageRectToGlobalRect({left:t.pageX,top:t.pageY,width:0,height:0});n.mutate(function(){i&&i.css({top:e.top+"px",left:e.left+"px"})})})},this.setTool=function(t,e){var o=$("body");this.clear(),"paint"===c?(l=t,s.append(l.onGetIcon()),o.addClass("pg-dm-paint-text"),o.on("mousemove",n),i=t.getCursor(),o.append(i),pinegrow.dispatchEvent("on_paint_tool_changed",null,l),e||(e={pageX:(o=pinegrow.mousePosition.getPosition()).left,pageY:o.top}),n(e)):0===(o=pinegrow.getCollection()).getLength()?pinegrow.showQuickMessage("Select an element first."):o.forEachElement(function(e){t.onClick(e)})},this.clear=function(){s.empty(),$("body").removeClass("pg-dm-paint-text"),l&&(l.onDestroy(),l=null),$("body").off("mousemove",n),i&&i.remove(),pinegrow.dispatchEvent("on_paint_tool_changed",null,null)},this.getTool=function(){return l},pinegrow.addEventHandler("on_element_clicked",function(e,t,o,s){l&&(s.stop=!0,l.onClick.call(l,t,o))})},PgPaintTool=function(){var a=this;this.action="class",this.action_name=null,this.class=null,this.all_classes=[],this.svg_support=!1,this.icon=null,this.icon_color,this.background_color,this.cursor_html,this.on_before_set,this.toggle_class=!1,this.prev_pgel=null,this.prev_class=null,this.getCursor=function(){return $(`<div class="pg-paint-tool-cursor">${this.cursor_html}</div>`)},this.onGetIcon=function(){},this.setClasses=function(t,o){var s=!1,e=t.closest("svg"),e=e&&t!==e,n=(a.svg_support&&e&&o.length&&"currentColor"!==t.getAttribute("stroke")&&"currentColor"!==t.getAttribute("fill")&&(s=!0),this.all_classes),i=(e&&this.on_filter_svg&&this.on_filter_svg(o,n),new PgApi),l=a.action_name||(o.length?"Set class "+o[0]:"Clear");pinegrow.changeManager.batchChanges(function(){pinegrow.makeChanges(t,l,function(){var e=!1;(e=a.on_before_set&&!1===a.on_before_set(t,o)?!0:e)||(a.toggle_class?0===o.length?n.forEach(function(e){i.hasClass(t,e,"inline")&&i.removeClass(t,e,null,"inline")}):i.hasClass(t,o[0],"inline")?i.removeClass(t,o[0],null,"inline"):i.addClass(t,o[0],null,null,"inline"):(n.forEach(function(e){i.hasClass(t,e,"inline")&&i.removeClass(t,e,null,"inline")}),o.forEach(function(e){e.length&&i.addClass(t,e,null,null,"inline")}),s&&t.setAttribute(a.svg_support,"currentColor")))})},l)},this.onClick=function(e){var t=this.class?this.class.split(" "):[];this.setClasses(e,t),this.on_after_set&&this.on_after_set(e)},this.onDestroy=function(){}};class PgFloatingToolsManager{constructor(){this.quick_win=null;var t=this;this.timer=null,pgQuickWindowManager.setRememberInSettings("quickFloatingTools"),pinegrow.panelManager.registerPanel({panel_category:"Tools",panel_key:"floatingTools",title:"Floating tools",panel_description:'Floating palette of tools that let you "paint" elements on the page.',panel_on_show:function(){t.show(),t.showAtMousePosition()},panel_on_hide:function(){t.hide()},panel_on_is_visible:function(){return t.quick_win&&t.quick_win.visible},panel_kbd:"&#8679; &#8679;",icon:""}),pinegrow.addEventHandler("on_page_loaded",function(e){1===pinegrow.getAllPages().length&&"visible"===pinegrow.getSetting("floating-tools","visible")&&setTimeout(function(){var e;t.quick_win&&t.quick_win.visible||(e=[],pinegrow.dispatchEvent("on_get_floating_tools_sections",pinegrow.getSelectedPage(),e),e.length&&(t.show(),(e=pgQuickWindowManager.getPosition("quickFloatingTools"))?t.quick_win.showAtPosition(e.x,e.y,null,!0):t.showAtMousePosition()))},1500)})}show(){var e=!1,t=(this.quick_win||(e=!0,this.quick_win=PgQuickFloatingToolsWindow(),(t=this).quick_win.$element.on("transitionend",function(e){e.target===t.quick_win.$element.get(0)&&t.quick_win.$element.removeClass("animate-move")})),this.timer&&clearTimeout(this.timer),this.quick_win.show(),this);e&&setTimeout(function(){addTooltip(t.quick_win.$element,`Press ${pgShowKbd("SHIFT")} ${pgShowKbd("SHIFT")} (the SHIFT key twice) to display the toole palette at the current mouse position.`,{trigger:"manual"}),t.quick_win.$element.tooltip("show")},2e3)}hide(){this.quick_win&&this.quick_win.hide()}showAtMousePosition(){this.show();var e=pinegrow.mousePosition.getPosition();this.quick_win.$element.addClass("animate-move"),this.quick_win.$element.css({top:e.top+"px",left:e.left+"px"})}}var PgQuickFloatingToolsWindow=function(e){var t=new PgFloatingToolsView,o=new PgQuickWindow("Paint mode",t,"quickFloatingTools",400,80,null,!1);return o.$element.addClass("pg-floating-tools-win"),(t.quick_win=o).hideOnClose=!0,o.isClosable=!1,o.onHide=function(e){pinegrow.paintToolManager.clear(),e||(pinegrow.setSetting("floating-tools","hidden"),pinegrow.showNotice(`<p>To show the floating tools:</p>
<ul>
<li>Press ${pgShowKbd("SHIFT")} ${pgShowKbd("SHIFT")} (the SHIFT key twice) to show or move the tools to the current mouse position.</li>
<li>Use Window -&gt; Show / Hide panels -&gt; Floating tools.</li>
</ul>`,"How to show the floating tools?","floating-tools-show",null,!0))},o.onShow=function(){pinegrow.setSetting("floating-tools","visible"),t.updateSize()},o.onMove=function(){},o.noRightEdge(),e=e||$("body"),o.showAtRandomPosition(),t.update(),o.onDestroy=function(){},o};class PgFloatingToolsView{constructor(){this.$element=$('<div class="pg-floating-tools"><i class="icon icon-Pin6 mover"></i></div>'),this.$sections=$('<div class="pg-floating-tools-sections"></div>').appendTo(this.$element),this.$bin=$('<div class="pg-floating-tools-bin"><i class="icon icon-bin"></i></div>').appendTo(this.$element),addTooltip(this.$bin,`Drop the paint tool in the bin to stop using it or press the ${pgShowKbd("ESC")} key.`),this.$no_tools=$('<div class="pg-floating-tools-no-sections">No tools are defined.</div>').appendTo(this.$element),this.view=new PgUIView(this.$element);function e(e){var t,o;"set"===pinegrow.paintToolManager.getMode()&&(t=pinegrow.selectedElements.getLastSelected(),o={classes:t?i.getClasses(t):[]},s.sections.forEach(function(e){e.onElementSelected(t,o)}))}var s=this,o=(this.displayed_sections=[],this.sections=[],!0),n=(this.more_section=new PgFloatingToolsSection("more","More tools"),new PgFloatingToolsControl({type:"button",name:'<i class="icon icon-settings"></i>',helptext:"Click to open the Properties panel where you can edit properties of the selected element.",func:function(){var e,t=n.$element,o=[{type:"header",label:"Mode"},{label:"Paint mode",action:function(){pinegrow.paintToolManager.setMode("paint")},check:"paint"===pinegrow.paintToolManager.getMode(),submenu_icon:"icon-none",submenu:[{type:"html",html:`<p style="color:rgba(255,255,255,0.75);margin-bottom:0;padding:10px 15px;">In Paint mode you click on the tool to pick it up and then click on elements on the page to apply the tool.</p>`}]},{label:"Set mode",action:function(){pinegrow.paintToolManager.setMode("set")},check:"set"===pinegrow.paintToolManager.getMode(),submenu_icon:"icon-none",submenu:[{type:"html",html:`<p style="color:rgba(255,255,255,0.75);margin-bottom:0;padding:10px 15px;">In Set mode you click on the tool to apply it to one or more selected elements.</p>`}]},{type:"divider"},{label:"More tools &amp; controls...",action:function(){var e=pinegrow.selectedElements.getLastSelected();PgQuickProperties(null,e,t)}}];return t.data("pg-menu")||((e=new CrsaContextMenu(o,t)).showForElement(t,null,4),setTimeout(function(){e.closeOnMouseOut=!0},300)),!1}})),i=(this.more_section.addControl(n),pinegrow.addEventHandler("on_page_frameworks_changed",function(e){s.update()}),pinegrow.addEventHandler("on_page_selected",function(e){s.update()}),new PgApi);pinegrow.addEventHandler("on_selected_elements_changed",e),pinegrow.addEventHandler("on_current_pseudo_state_changed",e),pinegrow.addEventHandler("on_current_device_size_changed",e),pinegrow.addEventHandler("on_paint_tool_changed",function(e,t){t?(s.$bin.addClass("active"),o&&(s.$bin.tooltip("show"),o=!1)):s.$bin.removeClass("active")}),this.$bin.on("click",function(e){e.preventDefault(),pinegrow.paintToolManager.clear()})}update(){var t=this;this.view.whenVisible(function(){t.getSections(),pgAreArraysEqual(t.displayed_sections,t.sections)||(t.displayed_sections.forEach(function(e){e.detach()}),t.displayed_sections=t.sections,t.displayed_sections.forEach(function(e){e.attach(t.$sections)}),0===t.displayed_sections.length?pg$Show(t.$no_tools,"flex"):pg$Hide(t.$no_tools),t.updateSize())},"update")}updateSize(){var e;this.quick_win&&(this.quick_win.$element.css("width","1000px"),e=this.quick_win.$element.find(".pg-quick-win-content").width(),this.quick_win.$element.css("width",e+60+"px"))}onPageSelected(e){}getSections(){var e=[];pinegrow.dispatchEvent("on_get_floating_tools_sections",pinegrow.getSelectedPage(),e),e.length&&e.push(this.more_section),this.sections=e}}class PgFloatingToolsSection{constructor(e,t){this.$element=$(`<div class="pg-floating-tools-section"><sectionname>${t}</sectionname></div>`),this.$controls=$(`<div class="controls"></div>`).prependTo(this.$element),this.controls=[]}addControl(e){this.controls.push(e),e.attach(this.$controls)}attach(e){this.$element.appendTo(e)}detach(){this.$element.detach()}onElementSelected(t,o){this.controls.forEach(function(e){e.onElementSelected(t,o)})}}class PgFloatingToolsControl{constructor(t,e){var n=this,o=(this.options=$.extend({},{buttons:!0,toggle_class:!1},e||{}),t.compact_select=!0,t.without_text=!0,this.options.compact_current_html&&(t.compact_current_html=this.options.compact_current_html),this.classPreview=null,this.classPreviewValues=null,new PgToggleButtonMaker),o=(this.def=t,this.field=null,"checkbox"===t.type&&(t.type="select",t.toggle_buttons=!0,t.options=[{key:t.value,name:t.name,html:o.makeText(t.name)}]),this.options.label||t.name);this.$element=$(`<div class="pg-floating-tools-control pg-floating-tools-control-${t.type}">${o}</div>`),t.colors&&(this.$color_input=$('<input type="hidden" />').appendTo(this.$element),this.color_picker=new PgColorPicker(this.$color_input,t.colors,t.name,function(){return{}},{on_color_highlighted:function(e){n.classPreview||n.getClassPreview(t),n.classPreview&&(e?n.classPreview.setClass(e,n.classPreviewValues):n.classPreview.restore())},on_show:function(){n.getClassPreview(t)},on_value_set:function(){n.destroyClassPreview()},on_hide:function(){n.destroyClassPreview()}}),this.$color_input.on("change",function(e){var t,o="function"==typeof n.def.options?n.def.options():n.def.options,s=n.$color_input.val();s?(t=(t=n.options.cursor||s).replace("$COLOR",n.color_picker.getColorValue()),n.setTool({key:n.makeResponsiveClasses(s),all_classes:n.makeResponsiveClasses(o.map(function(e){return e.key})),cursor:t})):n.setTool({key:null,all_classes:n.makeResponsiveClasses(o.map(function(e){return e.key})),cursor:"Clear "+n.options.label||n.def.name})})),"apply_class_multiple"===t.action&&(t.action="apply_class",t.multiple=!1),this.$element.on("mouseenter",this.onMouseEnter.bind(this)),this.$element.on("mouseleave",this.onMouseLeave.bind(this)),this.$element.on("click",this.onClick.bind(this)),this.def.helptext&&addTooltip(this.$element,this.def.helptext)}getClassPreviewObj(){return pinegrow.selectedElements.getLastSelected()}getClassPreviewResponsiveClass(e,t,o){return t.responsive_class?t.responsive_class(e,o):e}getClassPreview(e){var t,o;if("set"===pinegrow.paintToolManager.getMode())return this.classPreview&&!this.classPreview.destroyed||(t=this.getClassPreviewObj())&&(o="function"==typeof e.options?e.options(e):e.options,this.classPreviewValues=o.filter(function(e){return!!e.key}),o="___dummy___",this.classPreview=new PgFastDOMClassPreviewForPgel(t,this.getClassPreviewResponsiveClass(o,e,t).replace(o,""))),this.classPreview}destroyClassPreview(){this.classPreview&&(this.classPreview.destroy(),this.classPreview=null)}onClick(e){e&&(e.preventDefault(),e.stopImmediatePropagation(),e.stopPropagation()),pinegrow.paintToolManager.clear(),"button"===this.def.type&&this.def.func()}getClassesMap(){var o={},s=this;return this.def.options&&("function"==typeof this.def.options?this.def.options():this.def.options).forEach(function(e){var t=s.makeResponsiveClasses(e.key);o[t]=e,s.options.submenu&&("function"==typeof s.options.submenu?s.options.submenu(e.key):s.options.submenu).items.forEach(function(e){o[s.makeResponsiveClasses(e.key)]=e})}),o}onToolApplied(e){var t={classes:(new PgApi).getClasses(e)};this.onElementSelected(e,t)}onElementSelected(e,t){let o=!1;for(var s=this.getClassesMap(),n=0;n<t.classes.length;n++)if(s[t.classes[n]]){o=s[t.classes[n]];break}var i=this.options.label||this.def.name;this.options.on_get_current_value_label&&(i=this.options.on_get_current_value_label.call(this,t,s)),!1!==o?(this.$element.addClass("has-value"),this.options.on_get_current_value_label||(this.color_picker?(i=this.options.cursor.replace(/\$COLOR/,o.color),this.color_picker.get$Input().val(o.key)):this.def.toggle_buttons&&(i=this.options.label||o.html))):this.$element.removeClass("has-value"),null!==(i="function"==typeof i?i():i)&&this.$element.get(0).innerHTML!==i&&(this.$element.get(0).innerHTML=i)}setTool(e){var t=new PgPaintTool,o=(t.class=e.key||"",t.all_classes=e.all_classes,t.toggle_class=this.options.toggle_class,t.cursor_html=e.cursor,this.options.svg_support&&(t.svg_support=this.options.svg_support),this.options.on_filter_svg&&(t.on_filter_svg=this.options.on_filter_svg),e.on_before_set&&(t.on_before_set=e.on_before_set),this);"set"===pinegrow.paintToolManager.getMode()&&(t.on_after_set=function(e){o.onToolApplied(e)}),pinegrow.paintToolManager.setTool(t)}makeResponsiveClasses(e){var t=this;return e&&this.def.responsive_class?"string"==typeof e?this.def.responsive_class(e):e.map(function(e){return t.def.responsive_class(e)}):e}onMouseEnter(e){if(!this.$element.closest(".pg-quick-win").hasClass("animate-move")){this.mouse_is_over=!0,this.show_timer&&clearTimeout(this.show_timer),this.show_timer=null;var t=this.$element.data("pg-menu");if(e&&!t&&pgCurrentContextMenu){var o=pinegrow.mousePosition.getYVelocity();if(10<o)return void(this.show_timer=setTimeout(this.onMouseEnter.bind(this),10<o?250:50))}var c,s,p,u,h,g,n,d=this,i=pinegrow.selectedElements.getLastSelected(),_="set"===pinegrow.paintToolManager.getMode(),l=_?new PgApi:null,m=function(e){return!(!_||!i)&&l.hasClass(i,e)};"button"===this.def.type?this.onClick(e):this.color_picker?(pgCloseContextMenus(),this.color_picker.isOpen()||(this.color_picker.close_on_mouseleave=!1,this.color_picker.showWithPosition(this.$element),this.color_picker.keepOpenOnClick="set"===pinegrow.paintToolManager.getMode(),setTimeout(function(){d.color_picker.close_on_mouseleave=!0},300))):(c=function(e,t,o){d.options.buttons||s.push({type:"divider"}),e.push({label:d.options.buttons?'<i class="pg-tb-button pg-tb-button-icon icon icon-close" style="font-size:13px !important;top:3px;"></i>':'<i class="icon icon-close" style="color:white;margin-right:8px;"></i> Clear',class:"pg-floating-tool-menu-item",data:{key:null,all_classes:t,on_before_set:d.options.on_before_set||null,cursor:"Clear "+o},action:p})},s=[],p=function(){d.destroyClassPreview(),this.require_submenu_selection&&this.submenu||d.setTool(this.data)},u=this.makeResponsiveClasses.bind(this),this.def.options&&(o="function"==typeof this.def.options?this.def.options():this.def.options,h=[],g=[],o.forEach(function(e){g.push(e.key)}),g=u(g),o.forEach(function(s){var n,i,e,l=s.html?"function"==typeof s.html?s.html():s.html:s.name,a=null,r=!1,t=(d.options.submenu&&(a=[],o=(n="function"==typeof d.options.submenu?d.options.submenu(s.key):d.options.submenu).require_submenu_selection||!1,i=n.all_classes,i=u(i),e={options:(i=n.combine_with_parent?i.concat(g):i).map(function(e){return{key:e}})},n.items.forEach(function(e){var t,o;n.filter&&!n.filter(s.key)||(t=u(e.key),n.combine_with_parent&&(t=u(s.key)+" "+t),(o={label:o=e.html||`<span>${e.name}</span>`,class:"pg-floating-tool-menu-item",data:{key:t,all_classes:i,cursor:n.combine_with_parent?l+" "+o:o,on_before_set:d.options.on_before_set||null},action:p}).on_mouseenter=function(){d.classPreview||d.getClassPreview(d.def),d.classPreview&&d.classPreview.setClass(this.data.key,d.classPreviewValues)},o.on_mouseleave=function(e){d.classPreview&&d.classPreview.restore()},_&&(o.check=m(t)&&(r=!0)),a.push(o))}),a.push({type:"divider"}),c(a,i,n.name),a.length)&&a.unshift({type:"header",label:n.name}),u(s.key)),o={label:l,class:"pg-floating-tool-menu-item",data:{key:t,all_classes:g,on_before_set:d.options.on_before_set||null,cursor:l},action:p,submenu:a&&a.length?a:null,require_submenu_selection:o};_&&(d.options.buttons?m(t)&&(o.class+=" active"):o.check=m(t)||r),o.submenu?(o.on_submenu_open=function(){d.getClassPreview(e)},o.on_submenu_close=function(){d.destroyClassPreview()}):(o.on_mouseenter=function(){d.classPreview||d.getClassPreview(d.def),d.classPreview&&d.classPreview.setClass(this.data.key,d.classPreviewValues)},o.on_mouseleave=function(e){d.classPreview&&d.classPreview.restore()}),h.push(o)})),this.options.buttons?s.push({buttons:h}):s=h,s.unshift({type:"header",label:this.options.name||this.def.name}),this.options.no_clear_on_first_level||c(h,g,this.options.name||this.def.name),t||(d.$element.addClass("active"),(n=new CrsaContextMenu(s,this.$element)).showForElement(this.$element,null,4,-60),n.onClosed=function(){d.$element.removeClass("active"),d.destroyClassPreview()},n.keepOpenOnClick="set"===pinegrow.paintToolManager.getMode(),setTimeout(function(){n.closeOnMouseOut=!0},300),this.options.buttons&&this.getClassPreview(this.def)))}}onMouseLeave(e){this.mouse_is_over=!1,this.show_timer&&clearTimeout(this.show_timer),this.show_timer=null,this.mouseout_timer&&clearTimeout(this.mouseout_timer);var t=this;this.mouseout_timer=setTimeout(function(){var e;t.color_picker?t.color_picker.isOpen()&&!t.color_picker.isMouseOver()&&t.color_picker.close():(e=t.$element.data("pg-menu"))&&!t.mouse_is_over&&(e.isMouseOverOrSubmenuOpen()||e.close(),t.mouseout_timer=null)},200)}onGetObj(){return{}}onGetValues(){return{}}onValueChanged(e,t,o){var s,n;"apply_class"===this.def.action&&(s=o.map(function(e){return e.key}),s=this.makeResponsiveClasses(s),(n=new PgPaintTool).class=this.makeResponsiveClasses(e),n.all_classes=s,n.cursor_html=t,this.options.svg_support&&(n.svg_support=this.options.svg_support),this.options.on_filter_svg&&(n.on_filter_svg=this.options.on_filter_svg),this.options.on_before_set&&(n.on_before_set=this.options.on_before_set),pinegrow.paintToolManager.setTool(n))}getField(){var n;return this.field||((n=this).field=new PgPropertyField(this.$element,this.onGetObj,this.def.key,this.def,this.onGetValues),this.field.on("change",function(e){var t,o=n.field.getCurrentValueQuick(),s=n.field.$field.find(".pg-tb-compact-current").html()||o;n.def.options&&(t="function"==typeof n.def.options?n.def.options():n.def.options),n.onValueChanged(o,s,t)})),this.field}attach(e){e.append(this.$element)}}