class PgImageBrowserProvider{constructor(e){this.name=e,this.custom_dim=null,this.default_size="regular",this.supports_custom_dimensions=!0,this.supports_add_image=!isApp(),this.supports_delete=!0,this.parameter=null}onError(e){}setParameter(e){this.parameter=e}getSearchOnInput(){return!1}registerCustomDimensions=function(e){this.custom_dim=e};getDefaultSize=function(){return this.custom_dim?"custom":this.default_size};getImageUrlForInsertingToPage(e,t,r){var a=this.getImageUrl(e,t,null,r),s=pinegrow.getCurrentProject();return a=s&&!r?s.mapDOMUrlToSourceUrl(a):a}getImageUrl(e,t,r){}getImageSrcset(e){}getImageTag(e,t,r){var a=(a=this.getImageSrcset(e)||"")&&r?` srcset="${a}"`:"";return`<img src="${this.getImageUrl(e,t)}"${a}>`}getImageTagForInsertingToPage(e,t,r){var a=(a=this.getImageSrcset(e)||"")&&r?` srcset="${a}"`:"";return`<img src="${this.getImageUrlForInsertingToPage(e,t)}"${a}>`}getLink(e){return e}triggerDownload(e){}getImageDimensions(e,t){return{w:0,h:0}}getImageSizes(e){}getRandomPhoto(e,t,r){}search(e,t,r,a){}withCurrentResults(e){return!1}}var PgSafeUnsplashImages=function(){function i(e){return e.substring(0,1).toUpperCase()+e.substring(1)}var o={},a=[],n={small:{w:400,h:300},square:{w:800,h:800},regular:{w:1024,h:0},large:{w:1600,h:0}};this.load=function(e,r){fetch(e).then(function(e){return e.json()}).then(function(e){o=e;var s=function(e,t){var r={key:e,sizes:n},a={};return t.has_images?($.each(t,function(e,t){"has_images"!==e&&(a[e]=t)}),r.images=a):(r.subcats={},$.each(t,function(e,t){t.has_images=!0,r.subcats[e]=s(e,t)})),r},t=($.each(e,function(e,t){o[e]=s(e,t),a.push(o[e])}),[]);pinegrow.dispatchEvent("on_image_categories_loaded",null,t),t.forEach(function(e){a.unshift(e),o[e.key]=e}),r&&r()}).catch(function(e){console.log("GetSafeImages error: ",e.message)})};this.getCategoriesMenu=function(s){var n=[],t=[];return a.forEach(function(e){var r,a=e.key;e.top?(n.push({type:"header",label:e.header}),$.each(e.subcats,function(e,t){n.push({label:i(e),key:a+"."+e,action:s})}),n.push({type:"divider"}),n.push({label:"Photos",submenu:t})):e.images?t.push({label:i(e.key),key:a,action:s}):(r=[],$.each(e.subcats,function(e,t){r.push({label:i(e),key:a+"."+e,action:s})}),t.push({label:i(e.key),submenu:r}))}),n},this.getDefaultCategory=function(){var e,r;return a.length?(e=a[0]).subcats?(r=null,$.each(e.subcats,function(e,t){r=r||e}),e.key+"."+r):e.key:null},this.getImagesForCategory=function(e){for(var t=e.split("."),r=o,a=0;a<t.length;a++)r=(0==a?r:r.subcats)[t[a]];var n=[];return $.each(r.images,function(e,a){var t=r.sizes,s={id:e,urls:{raw:a},links:null};t?$.each(t,function(e,t){var r=a+"q=85&fm=jpg&crop=entropy&cs=srgb";t.w&&(r+="&w="+t.w),t.h&&(r+="&h="+t.h),s.urls[e]=r}):(s.urls.regular=a,s.name=crsaGetNameFromUrl(a)),n.push(s)}),n}};class PgUnsplashImageProvider extends PgImageBrowserProvider{constructor(){super("Unsplash"),this.appId=pinegrow.defaults.unsplashAppId,this.api="https://api.unsplash.com/",this.random_list=[],this.supports_add_image=!1,this.supports_delete=!1,this.current_params_hash=null,this.current_params_max_pages=1,this.current_params_max_pages_hash=null,this.featured=null,this.in_search_call={}}createUrl(e,t){var r=this.api+e+"?client_id="+this.appId;return t&&$.each(t,function(e,t){r+="&"+e+"="+encodeURIComponent(t)}),r}call(e,t,r){var a=this;fetch(e).then(function(e){return e.json()}).then(function(e){t&&t(e)}).catch(function(e){console.log("Unsplash API error: ",e.message),a.onError(e.message),r&&r()})}getImageUrl(e,t,r){var a;return t=t||this.getDefaultSize(),r=r||this.custom_dim,"custom"==t&&r?(a=e.urls.raw+"q=85&fm=jpg&crop=faces&cs=srgb",r.w&&(a+="&w="+r.w),r.h&&(a+="&h="+r.h),a+("&fit="+(0<r.w*r.h?"crop":"max"))):e.urls[t]||e.urls.regular}getLink(e){return e+"?utm_source=Pinegrow&utm_medium=referral"}triggerDownload(e){var t;e.links&&e.links.download_location&&(t=e.links.download_location+"?client_id="+this.appId,fetch(t))}getImageDimensions(e,t){var r=this.getImageUrl(e,t),a="full"==t?{w:e.width,h:e.height}:{w:0,h:0},s=r.match(/&w=([0-9]+)/);return s&&(a.w=parseInt(s[1])),(s=r.match(/&h=([0-9]+)/))&&(a.h=parseInt(s[1])),a}getImageSizes(e){for(var t=["full","large","square","regular","small","thumb"],r={},a=0;a<t.length;a++)e.urls[t[a]]&&(r[t[a]]=this.getImageDimensions(e,t[a]));return this.custom_dim&&(r.custom=this.getImageDimensions(e,"custom")),r}getRandomPhoto(t,r,e,a,s){const n=this;(t=$.extend({count:30},t)).query;function i(e){var t=Math.floor(Math.random()*(e.length-1)),r=e[t];return e.splice(t,1),r}var o,l,c,g,u=JSON.stringify(t);!this.random_list.length||this.current_params_hash&&this.current_params_hash!==u?(this.current_params_hash=u,this.random_list=[],o=1,l=a?20:1,this.current_params_max_pages_hash===u&&(8<(c=this.current_params_max_pages)&&(c=Math.min(Math.round(.1*this.current_params_max_pages),8)),1<(c=s?2:c)&&(o=Math.floor(Math.random()*c)+1),l=20),g=t.query||"",this.in_search_call[g]?this.in_search_call[g].push({done:r,error:e}):(this.in_search_call[g]=[],this.search(g,{per_page:l,page:o,featured:!0},function(e){n.random_list=e.results.slice(0),n.current_params_max_pages=e.total_pages,n.current_params_max_pages_hash=u,r&&r(i(n.random_list)),n.in_search_call[g].forEach(function(e){0===n.random_list.length?setTimeout(function(){n.getRandomPhoto(t,e.done,e.error,!0)},1):e.done&&e.done(i(n.random_list))}),n.in_search_call[g]=null},function(t){e&&e(),n.in_search_call[g].forEach(function(e){e.error&&e.error(t)}),n.in_search_call[g]=null}))):r&&r(i(this.random_list))}search(e,t,r,a){(t=$.extend({page:1,per_page:40},t)).query=(e||"").toLowerCase(),this.call(this.createUrl("search/photos",t),function(e){r&&r(e)},function(e){a&&a(e)})}searchFeatured(t){const r=this;this.featured?t(this.featured):this.call(this.createUrl("photos/random",{count:30,featured:!0}),function(e){r.featured={results:e,total_pages:1},t(r.featured)})}}class PgBackendImageProvider extends PgImageBrowserProvider{constructor(){super("Backend"),this.supports_custom_dimensions=!1,this.default_size="full",this.size_map={small:"medium"},this.random_list=[],this.current_params_hash=null,this.current_params_max_pages=1,this.current_params_max_pages_hash=null,this.featured=null,this.results_cache={}}onProjectRefreshed(){this.clearResults()}clearResults(){this.results_cache={}}getSearchOnInput(){return isApp()}getImageUrl(e,t,r,a){t=t||this.getDefaultSize(),this.size_map[t]&&(t=this.size_map[t]),e.sizes&&e.sizes[t]||(t=this.getDefaultSize());var s=e.sizes&&e.sizes[t]?e.url_base+e.sizes[t].file:e.url;return s=a?s:pinegrow.getCurrentProject().mapDOMUrlToSourceUrl(s)}getImageSrcset(e){return e.srcset||null}triggerDownload(e){}getImageSizes(e){var r={};return $.each(e.sizes,function(e,t){r[e]={w:t.width,h:t.height}}),r}getRandomPhoto(e,t,r){const a=this;(e=$.extend({count:30},e)).query;function s(e){var t=Math.floor(Math.random()*(e.length-1)),r=e[t];return e.splice(t,1),r}var n,i,o,l=JSON.stringify(e);!this.random_list.length||this.current_params_hash&&this.current_params_hash!==l?(this.current_params_hash=l,i=n=1,this.current_params_max_pages_hash===l&&(o=this.current_params_max_pages,1<(o=40<this.current_params_max_pages?Math.min(Math.round(.25*this.current_params_max_pages),20):o)&&(n=Math.floor(Math.random()*o)+1),i=20),o=e.query||"",this.search(o,{per_page:i,page:n,featured:!0},function(e){a.random_list=e.results.slice(0),a.current_params_max_pages=e.total_pages,a.current_params_max_pages_hash=l,t&&t(s(a.random_list))},r)):t&&t(s(this.random_list))}getResultsKey(){return"results_"+(this.term||"")+"_"+this.parameter+""}search(n,i,r,t){this.term=n,(i=$.extend({term:n,page:1,per_page:40,project_id:this.parameter||null},i)).query=n;const a=this;function o(e){var t=a.getResultsKey();1!==i.page&&a.results_cache[t]||(a.results_cache[t]=[]),a.results_cache[t]=a.results_cache[t].concat(e.results),r&&r(e)}var l=pinegrow.getCurrentProject();isApp()&&l?l.getAllImageFiles().then(function(e){var t=[];if(n){n=n.toLowerCase();for(var r=0;r<e.length;r++)0<=l.getRelativeUrl(e[r].url).toLowerCase().indexOf(n)&&t.push(e[r])}else t=e;var a=(i.page-1)*i.per_page,s=a+i.per_page;o({results:t.slice(a,s),total_pages:Math.ceil(1*t.length/i.per_page)})}).catch(function(e){t&&t(e)}):pinegrow.backend.getImages(i,o,t)}searchFeatured(e){this.search(null,{},e)}deleteImage(e,t){const r=this;pinegrow.backend.deleteImage(e.id,t,function(e){r.onError&&r.onError(e)})}withCurrentResults(e){var t=this.getResultsKey();return!!this.results_cache[t]&&(e({results:this.results_cache[t]}),!0)}}class PgImageBrowserProvidersManager{constructor(){this.list=[];const t=this;$("body").one("pinegrow-ready",function(){var e=new PgBackendImageProvider,e=(t.list.push(e),new PgUnsplashImageProvider);t.list.push(e)})}getProviders(){return this.list}}var pgQuickImageBrowserSearchTerm=null,PgImageBrowserView=function(){var l=!1,c={};let t=new PgBackendImageProvider,r=new PgUnsplashImageProvider;this.dont_map_to_source_url=!1,l&&(e=localStorage.getItem("markedImages"))&&(c=JSON.parse(e));var a,g=function(e){var t=w;return!(!c[t]||!c[t][e])},e=((pgf.kids||!1)&&(a=window.PgSafeUnsplashImages),!pgf.kids),u=t||r,i=(this.setImageProvider=function(e,t){(u=e).setParameter(t),e.supports_custom_dimensions?(S.show(),P.show()):(S.hide(),P.hide()),C(!0)},$('<div class="pg-image-browser"></div>')),s=new PgUIView(i),p=(this.view=s,this.images_shown=!1,this),n=(this.drag_enabled=!0,this.show_sizes=!0,this.enable_unsplash=!0,1),o=0,h={results:[],total_pages:1},d={placeholder:"Search",placeholder_active:null,toolbar_on:!1,delay:!1,delay_time:800,search_on_input:function(){return u.getSearchOnInput()}},m=(a&&(d.input_type="menu",d.input_get_menu_options=a.getCategoriesMenu,d.search_on_input=!0,d.no_search_icon=!0,d.input_menu_no_not_set_option=!0),new PgInputField("provider_selector",{type:"menu",without_text:!0,name:"Select",menu_no_not_set_option:!0,get_menu_options:function(){var t,e=[];return pinegrow.currentUser&&pinegrow.currentUser.canUploadImages()&&(pinegrow.getCurrentProject()&&e.push({key:"backend:"+(isApp()?"current":pinegrow.backend.getProjectId(pinegrow.getCurrentProject())),label:"Current project"}),isApp()||(e.push({key:"backend:",label:"All my images"}),t=[],pinegrow.backend.list_of_loaded_projects&&pinegrow.backend.list_of_loaded_projects.forEach(function(e){t.push({label:e.name,key:"backend:"+e.project_id})}),t.length&&e.push({key:"",label:"Projects",submenu:t}))),p.enable_unsplash&&(e.push({type:"divider"}),e.push({key:"unsplash",label:"Unsplash"})),e}})),_=(m.$field.css({width:"calc(100% - 10px)",margin:"0px 0 5px"}),m.appendTo(i),m.on("change",function(){var e=m.getValue();e.startsWith("backend:")?(e=e.replace("backend:",""),p.setImageProvider(t,e)):p.setImageProvider(r)}),new PgSearchBox(d)),w=(_.getToolbar(),_.$element.appendTo(i),null);_.onSearch=function(e){try{pgQuickImageBrowserSearchTerm=w=e,C()}catch(e){}},this.onShown=function(){var e;_.focus(),isApp()||pinegrow.currentUser.canUploadImages()?(e="",pinegrow.getCurrentProject()&&(e=isApp()?"current":pinegrow.backend.getProjectId(pinegrow.getCurrentProject())),m.setValue("backend:"+e),this.setImageProvider(t,e)):(m.setValue("unsplash"),this.setImageProvider(r))},this.getSearchTerm=function(){return w};function f(e){var t={w:P.getValue()||null,h:S.getValue()||null};null!==t.w&&(t.w=parseInt(t.w)),null!==t.h&&(t.h=parseInt(t.h)),t=0<t.w+t.h?t:null,u.registerCustomDimensions(t),e||(j(),pinegrow.setSetting(y+"w",t?t.w:""),pinegrow.setSetting(y+"h",t?t.h:""))}function v(e){u.triggerDownload(e)}function I(){D&&(D.popover("destroy"),D=null)}function b(){a&&!w&&setTimeout(function(){var e=a.getDefaultCategory();e&&_.setValue(e)},20)}function k(){p.images_shown=!1,t&&t.clearResults()}(new PgSearchBoxSpacer).$element.appendTo(i);var y="unsplash-dim-",P=new PgInputField("custom_w",{type:"slider",name:"W"}),d=pinegrow.getSetting(y+"w",""),S=(P.setValue(d=0!=d&&e?d:""),P.on("change",function(){pinegrow.showQuickMessage("Dimensions updated."),f()}),e&&P.appendTo(_.$element),new PgInputField("custom_h",{type:"slider",name:"H"})),d=pinegrow.getSetting(y+"h",""),d=(S.setValue(d=0!=d&&e?d:""),S.on("change",function(){pinegrow.showQuickMessage("Dimensions updated."),f()}),e&&S.appendTo(_.$element),f(!0),$('<button class="pg-button pg-button-primary">Search</button>')),C=(a||d.appendTo(_.$element),function(e){p.images_shown=!0,w=_.getValue(),E.empty(),h.results=[],n=1,a?w&&j({results:a.getImagesForCategory(w),total_pages:1}):e&&u.withCurrentResults(j)||(w?u.search(w,{},j):u.searchFeatured(j))}),e=(d.on("click",function(e){e.preventDefault(),C()}),u.onError=function(e){A(),pinegrow.showQuickError("Oops... API call failed.")},$('<div class="pg-image-browser-c"></div>').appendTo(i)),E=$('<div class="pg-image-browser-items"></div>').appendTo(e),x=$('<button class="pg-button more-button"></button>').appendTo(e),D=($more_pages=x.find("span"),pg$Hide(x),x.on("click",function(e){e.preventDefault(),A(!0),n++,u.search(w,{page:n},j)}),crsaHandleExternalLinks(e),null),T=(e.on("click",".pg-image-browser-upload",function(e){e.preventDefault(),e.stopPropagation(),pinegrow.getCurrentProject()?pinegrow.backend.uploadFilesWithDialog({},function(e){h.results.unshift(e.image),M(e.image).insertAfter(E.find(".pg-image-browser-upload"))}):pinegrow.showAlert(`<p>Uploading images is only possible when a project is open in the editor.</p><p>To upload images, first open the project where you want images to be stored and then repeat this operation.</p>`,"Open the project to upload images",null,"Ok")}),e.on("click",".pg-image-browser-item, .pg-image-browser-item-size",function(e){if(!$(e.target).is("a.external")){e.preventDefault(),e.stopPropagation(),pgCloseContextMenus();var t,r=$(this),a=r.data("picdata"),s=r.data("picsize"),n=u.getImageUrlForInsertingToPage(a,s,p.dont_map_to_source_url),i=u.getImageSrcset(a),o=new PgCollection;if(pinegrow.selectedElements.forEachElement(function(e){"img"===e.tagName&&o.add(e)}),I(),l)e=a.id,t=a.urls.raw,c[s=w]||(c[s]={}),c[s][e]?delete c[s][e]:c[s][e]=t,localStorage.setItem("markedImages",JSON.stringify(c)),console.log(c),s=r.closest(".pg-image-browser-item"),g(a.id)?s.css({outline:"4px solid yellow","outline-offset":"-4px"}):s.css({outline:"none"});else if(p.onImageClicked)p.onImageClicked(n,a,i);else{if(0!==o.getLength())return pinegrow.makeChanges(o,"Set image",function(){o.forEachElement(function(e){e.setAttribute("src",n),i?e.setAttribute("srcset",i):e.hasAttribute("srcset")&&e.removeAttribute("srcset")})}),pinegrow.selectedElements.reselect(),pinegrow.showQuickMessage("Replacing image...",null,!0),v(a),pinegrow.dispatchEvent("on_image_browser_image_selected",null,n,a),!1;D=r,pinegrow.showQuickError("Drag the image to the page. Click to replace the selected image. No image is selected.")}}}),e.on("contextmenu",".pg-image-browser-item,.pg-image-browser-item-size",function(e){e.preventDefault();var t,r,a,s=$(this),n=s.data("picdata"),i=s.data("picsize"),o=!1,l=(i.endsWith("_r")&&(o=!0,i=i.replace("_r","")),u.getImageUrlForInsertingToPage(n,i)),c=(o&&(t=u.getImageSrcset(n)),new CrsaContextMenu(null,s)),g=pinegrow.selectedElements.getLastSelected();return I(),g?(r=pinegrow.selectedElements.getName({short:!0,num_classes:0}),"img"==g.tagName?(c.add({type:"divider"}),c.add({type:"header",label:"Replace"}),c.add("Replace image "+r,null,function(){pinegrow.makeChanges(pinegrow.selectedElements.getCollection(),"Set image",function(){pinegrow.selectedElements.forEachElement(function(e){"img"==e.tagName&&e.setAttribute("src",l),t?e.setAttribute("srcset",t):e.hasAttribute("srcset")&&e.removeAttribute("srcset")})}),v(n)})):(c.add({type:"divider"}),c.add({type:"header",label:"Background"}),c.add("Set background for "+r,null,function(){pinegrow.makeChanges(pinegrow.selectedElements.getCollection(),"Set background image",function(){pinegrow.selectedElements.forEachElement(function(e){"img"!==e.tagName&&(e.setInlineStylePropertyValue("background-image",l,!0),pinegrow.dispatchEvent("on_css_active_rule_changed",null))})}),v(n)})),c.add({type:"divider"}),c.add({type:"header",label:"Insert"}),a=function(e){(new PgApi).insertElements(u.getImageTagForInsertingToPage(n,i,o),null,e,{repeater:!0}).getLength()&&pinegrow.showQuickMessage("Image inserted.")},g.canHaveChildren()&&(c.add("Prepend to "+r,null,function(){a("prepend")}),c.add("Append to "+r,null,function(){a("append")})),c.add("Insert before "+r,null,function(){a("insertBefore")}),c.add("Insert after "+r,null,function(){a("insertAfter")}),c.add({type:"divider"}),c.add({type:"header",label:"Clipboard"}),c.add("Copy image URL",null,function(){copyCodeToClipboard(l,!0)})):c.add("Select one or more elements on the page first.",null,function(){}),u.supports_delete&&(c.add({type:"divider"}),c.add({label:"Delete...",action:function(){pinegrow.showAlert(`<p>Do you want to delete this image? Deleting the image will remove the image from all your projects, and it can not be undone.</p>`,"Are you sure about deleting this image?","Cancel","Yes, delete it",null,function(){var e;pinegrow.showQuickMessage("Deleting the image..."),isApp()?(pgDeleteFileOrFolder(n.path),pinegrow.refreshCurrentProjectDelayed(!0),pinegrow.showQuickMessage("Deleted."),s.remove(),0<=(e=h.results.indexOf(n))&&h.results.splice(e,1)):pinegrow.backend.deleteFile(n.id,function(){pinegrow.showQuickMessage("Deleted."),s.remove();var e=h.results.indexOf(n);0<=e&&h.results.splice(e,1)},function(e){pinegrow.showQuickError("Oops... could not delete it.")})})}})),pgf.use_project_featured_images&&n.id&&u.supports_delete&&(c.add({type:"divider"}),c.add({label:"Set as project featured image",action:function(){pinegrow.backend.setProjectFeaturedImage(pinegrow.getCurrentProject(),n.id,function(){pinegrow.showQuickMessage("Featured image set.")})}})),c.showAt(e.pageX,e.pageY),!1}),null),U=null,z=new PgDragHelper(e,".pg-image-browser-item,.pg-image-browser-item-size",null,!0),M=(z.onBefore=function(){return p.drag_enabled},z.on("dragStart",function(e,t,r){$.fn.crsapages("showOverlays");var a=z.dragTarget,s=a.data("picdata"),a=a.data("picsize"),n=!1,s=(a.endsWith("_r")&&(n=!0,a=a.replace("_r","")),U=s,I(),pgCreate(u.getImageTagForInsertingToPage(s,a,n))),a=null,n=pinegrow.getSelectedPage();n&&(a=n.getMainType(null,s)),(T=new PgDragMenu(a,!1,!0)).pgel=s,T.selectNew=!0,T.handleMoveEvent(r,T),i.trigger("pg-drag-start")},this),z.on("drag",function(e,t,r){T.handleMoveEvent(r,T)},this),z.on("dragStop",async function(e,t){$.fn.crsapages("showOverlays",!0),await T.insertAsync()&&v(U),T.destroy(),U=T=null,crsaFuncs.showInsertionLine(null),pinegrow.highlightElement(null),i.trigger("pg-drag-stop")},this),function(a){var e=u.getDefaultSize(),t="",t=(a.user?t=`<p><a href="${u.getLink(a.user.links.html)}" class="external" target="_blank">${a.user.name}</a> on <a href="${u.getLink("https://unsplash.com/")}" class="external" target="_blank">Unsplash</a>.</p>`:a.name&&(t=`<p style="text-align: left;padding-left: 8px;background: rgba(0,0,0,0.6);">${a.name}</p>`),$('<div draggable class="pg-image-browser-item"><img src="'+u.getImageUrl(a,"small",null,!0)+'">'+t+"</div>")),s=(t.data("picdata",a),t.data("picsize",e),$('<div class="pg-image-browser-item-sizes"></div>').appendTo(t)),e=u.getImageSizes(a),n=0;return p.show_sizes&&($.each(e,function(e,t){var r=$(`<div draggable class="pg-image-browser-item-size">${e} ${0<t.w?t.w:"0"}&times;${0<t.h?t.h:"0"}</div>`).appendTo(s);r.data("picdata",a),r.data("picsize",e),n++}),u.getImageSrcset(a))&&((e=$(`<div draggable class="pg-image-browser-item-size">Responsive</div>`).appendTo(s)).data("picdata",a),e.data("picsize",u.getDefaultSize()+"_r"),n++),n<=1&&pg$Hide(s),l&&(g(a.id)?t.css({outline:"4px solid yellow","outline-offset":"-4px"}):t.css({outline:"none"})),t}),j=function(e){if(e)h.results=h.results.concat(e.results),h.total_pages=e.total_pages;else{if(!h)return;e=h,E.empty()}u.supports_add_image&&0===E.get(0).children.length&&$(`<div class="pg-image-browser-upload"><i class="icon icon-plus"></i>Upload images</div>`).appendTo(E),e.results.forEach(function(e){M(e).appendTo(E)}),o=e.total_pages,A()},A=function(e){e?(x.attr("disabled","disabled"),x.html("Loading...")):(x.removeAttr("disabled"),0<o?o<=n?pg$Hide(x):(pg$Show(x),x.html(`Show more - <span>${o-n}</span> pages to go`)):(pg$Show(x),x.html(`Show more`)))};s.onResize=function(){},s.onShow=function(){isApp()&&!p.images_shown&&t},pinegrow.addEventHandler("on_image_categories_loaded",b);pinegrow.addEventHandler("on_project_closed",k),isApp()&&pinegrow.addEventHandler("on_project_refreshed",k),s.onDestroy=function(){pinegrow.removeEventHandler("on_image_categories_loaded",b),pinegrow.removeEventHandler("on_project_closed",k),isApp()&&pinegrow.removeEventHandler("on_project_refreshed",k),I()},b()},PgQuickImageBrowser=function(e,t){function r(){a.with_focus_rect&&n.hide()}var a=this,s=this.imageBrowser=new PgImageBrowserView,n=this.win=new PgQuickWindow(t||"Image browser",s,"quickImageBrowser",440,600,null,!0);n.noRightEdge(),n.hideOnClose=!0,(e=e||$("body"))&&n.showFor$El(e),s.onShown(),n.onHide=function(){a.with_focus_rect&&pinegrow.focusRect.hide(),a.onHide&&a.onHide()};pinegrow.addEventHandler("on_focus_rect_closed",r),n.onDestroy=function(){pinegrow.removeEventHandler("on_focus_rect_closed",r)},this.setOnSelected=function(e){s.onImageClicked=e},this.show=function(e){n.show(!0),e&&n.showFor$El(e),pgQuickWindowManager.focus(n)},this.getSearchTerm=function(){return s.getSearchTerm()},this.openCategoryDropdown=function(){setTimeout(function(){s.view.get$Element().find(".pg-search-box .value-holder").trigger("click")},200)}},pgQuickImageBrowser=null,pgShowQuickImageBrowser=function(e,t,r,a){return pgQuickImageBrowser?pgQuickImageBrowser.show(e):pgQuickImageBrowser=new PgQuickImageBrowser(e),pgQuickImageBrowser.imageBrowser.onImageClicked=null,pgQuickImageBrowser.setOnSelected(r),pgQuickImageBrowser.with_focus_rect=t,pgQuickImageBrowser.imageBrowser.dont_map_to_source_url=a||!1,pgQuickImageBrowser};class PgRandomLocalImage{constructor(){this.cache={}}getRandomImageFromFolder(t,e){if(!this.cache[t]){var r=require("fs");try{var a=r.readdirSync(t,{withFileTypes:!0})}catch(e){pinegrow.showQuickError(`Could not read content of the folder ${t}.`)}r=a.filter(function(e){return e.isFile()&&"image"===pinegrow.getSimpleMimeType(e.name)}).map(function(e){return e.name});this.cache[t]={all:r,current:[]}}0===this.cache[t].current.length&&(this.cache[t].current=this.cache[t].all.slice(0)),0===this.cache[t].current.length?(pinegrow.showQuickError(`No images were found in ${t}.`),e&&e(null)):(a=Math.floor(Math.random()*(this.cache[t].current.length-1)),r=this.cache[t].current[a],this.cache[t].current.splice(a,1),r=crsaMakeUrlFromFile(require("path").join(t,r)),e&&e(r))}refresh(){this.cache={}}}