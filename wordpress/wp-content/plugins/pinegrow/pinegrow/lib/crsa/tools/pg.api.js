class PgApi{constructor(){this.preview_elements={}}previewCodeInPage(e,n,t,r){this.clearPreviewCodeInPage(e);var a=r?getPgNodeByPgId(r):pinegrow.getSelectedElement();if(a){var o=a.get$DOMElement();if(o){var l=$(n).attr("data-pg-preview-ref",e);switch(t){case"append":o.append(l);break;case"prepend":o.prepend(l);break;case"insertAfter":l.insertAfter(o);break;case"insertBefore":l.insertBefore(l)}this.preview_elements[e]=l}}}clearPreviewCodeInPage(e){this.preview_elements[e]&&(this.preview_elements[e].remove(),delete this.preview_elements[e])}async includeSVGImageInline(e){var n=pinegrow.getCollection(e),t=new PgCollection,r=!0;if(n.forEachElement(function(e,n,t){canMakeChange(e,"delete_element")||(r=!1)}),r){for(var a=n.getList(),o=0;o<a.length;o++){var l=a[o];if((s=l.getAttribute("src"))&&"image/svg+xml"===pinegrow.getMimeType(s))try{var s,i=await async function(o){return new Promise(function(r,a){pgFetchRemoteContent(o).catch(function(e){a(e)}).then(function(e){var n,t;void 0===e?a("Error getting remote file "+o):(t=(new TextDecoder).decode(e),(n=new pgParser).parse(t),(t=n.rootNode.findOne("svg"))?r(t):a("No SVG element found."))})})}(l.getPage().makeAbsoluteUrl(s));l.getAttrList().slice(0).forEach(function(e){"src"!==e.name&&"srcset"!==e.name&&i.setAttribute(e.name,e.value,!1,e.quote)}),l.replaceWith(i),t.add(i)}catch(e){pinegrow.showQuickError(`Unable to inline SVG. `+e)}}pinegrow.changeManager.didChange(n,"Inline SVG"),pinegrow.selectedElements.reselect()}return t}duplicateElements(e,c,g){var p,d=pinegrow.getCollection(e),u=new PgCollection,h=null,r=(g&&d.orderByDocumentPosition(),!0);if(d.forEachElement(function(e,n,t){e.canDuplicate()||(pinegrow.showQuickError(`Can't duplicate ${e.tagName} element.`),r=!1)}),!r)return u;pinegrow.repeater.repeat(function(s,i){d.forEachElement(function(n,t,e){p=pinegrow.selectedElements.isSelectedElement(n);var r,a,o,l=new pgParserSourceProblem(n);n||l.add("element",n.getName(),"duplicate"),l.ok()?canMakeChange(n,"duplicate_element")&&(r=pinegrow.getCrsaPageOfPgParserNode(n),willMakeChange(n.getPage(),"Duplicate element / "+n.getName()),a=t==e-1&&s==i-1,o=n.clone(),pinegrow.dispatchEvent("on_duplicate_element_async",r,o,function(e){h=h||n,g&&0==t&&(h=d.getLast()),e.insertAfter(h),u.add(e),h=e,a&&(c&&c(u),pinegrow.repeater.done(),pinegrow.changeManager.didInsert(u,null,null,{insert_operation:"duplicate"}),p&&(u.getLength()<=12?pinegrow.selectedElements.selectMany(u,!0):pinegrow.selectElement(h)),pgf.kids)&&pinegrow.showQuickMessage("Element duplicated and selected.")})):showAlert(l.toString(),"Can't duplicate this element")})})}removeElements(e){var i=pinegrow.getCollection(e);i.forEachElement(function(r,a,o){var l,s=pinegrow.selectedElements.isSelectedElement(r),e=new pgParserSourceProblem(r);r||e.add("element","Element","remove"),e.ok()?canMakeChange(r,"delete_element")&&(l=r.getPage(),pinegrow.dispatchEvent("on_before_delete_element_async",l,r,function(e){var n,t;e&&(willMakeChange(l,"Delete element / "+r.getName(),r,"delete"),t=null,(n=a==o-1)&&s&&(t=(t=(t=r.next())||r.prev())||r.parent),r.remove(),n)&&(t&&pinegrow.selectElement(t),pinegrow.changeManager.didDelete(i),pinegrow.highlightElement(null))})):showAlert(e.toString(),"Can't remove this element")})}mergeElements(e,r){var n=pinegrow.getCollection(e),a=(n.normalize(),n.orderByDocumentPosition(),new PgCollection),o=r.getPositionInDocument();canMakeChange(r,"insert_element")&&(n.forEachElement(function(e,n,t){e!=r&&canMakeChange(e,"delete_element")&&(e.positionInDocument<o?e.moveChildrenToElement(r,!0):e.moveChildrenToElement(r,!1),e.remove(),a.add(e))}),pinegrow.changeManager.batchChanges(function(){pinegrow.changeManager.didDelete(a),pinegrow.changeManager.didChange(r,"Merge elements")},"Merge elements"),pinegrow.selectElement(r))}splitParent(e){var n=pinegrow.getCollection(e),s=new PgCollection,i=new PgCollection;n.normalize(),n.forEachElement(function(e,n,t){if(e.parent&&e.parent.parent&&canMakeChange(e.parent,"edit_content")&&canMakeChange(e.parent.parent,"insert_element")){for(var r=e.parent.clone(!1,!1,!0),a=(r.insertAfter(e.parent),e.parent.children.indexOf(e)),o=e.parent.children;0<=a&&a<o.length;){var l=o[a];r.append(l)}s.add(r),i.add(e.parent.parent)}}),pinegrow.changeManager.batchChanges(function(){pinegrow.changeManager.didInsert(s,null,null,{insert_operation:"split_element"}),pinegrow.changeManager.didChange(i,"Split element")},"Split element")}insertElements(e,n,i,a){a=a||{},a=$.extend({insert_operation:"api_insert",select:!1,scroll:!1,highlight:!1,repeater:!1,format_html:!1,fix_placement:!1,before_body_scripts:!1,append_before_selector:null,skip_event:!1},a),i=i||"append";var t=a.repeater?pinegrow.repeater.getCount():1,r=pinegrow.getCollection(n),c=new PgCollection,g="append"==i||"prepend"==i,o=!1;if("string"==typeof e){var p=[],l=new pgParser;l.parse(e);for(var s=0;s<t;s++)for(var d=0;d<l.rootNode.children.length;d++)p.push(0==s?l.rootNode.children[d]:l.rootNode.children[d].clone())}else{p=pinegrow.getCollection(e).getList().slice();for(s=1;s<t;s++)pinegrow.getCollection(e).getList().forEach(function(e){p.push(e.clone())})}for(d=0;d<p.length;d++)if(!p[d].isElementOrScript){o=!0;break}function u(e,n){if(("append"==n||"prepend"==n)&&!e.canHaveChildren()){if(!a.fix_placement)return void pinegrow.showQuickError(e.getName({short:!0})+` can't have sub-elements.`);n="insertAfter"}var t,r;return!a.fix_placement||"html"!==e.tagName||"head"===p[0].tagName&&"body"===p[0].tagName||(r=e.findOne("body"))&&(e=r),a.fix_placement&&0<=["body","head","html"].indexOf(e.tagName)&&("insertAfter"==n||"insertBefore"==n)&&(n="append"),"body"==e.tagName&&"append"==n&&a.before_body_scripts&&(t=!1,p.forEach(function(e){"script"==e.tagName&&(t=!0)}),t||(n=(r=e.findLastNonScriptChild())?(e=r,"insertAfter"):"prepend")),a.append_before_selector&&(r=e.findOne(a.append_before_selector))&&(e=r,n="insertBefore"),{pgel:e,placement:n}}function h(){r.forEachElement(function(e,n,t){for(var r=i,n=0;n<p.length;n++)if(p[n].isElementOrScript&&!canMakeChange(g?e:e.parent,"insert_element",{inserted:p[n]}))return c;for(var a=u(e,r),o=(e=a.pgel,r=a.placement,p.slice());o.length;){var l="insertAfter"==r||"prepend"==r?o.length-1:0,s=1<t?o[l].clone():o[l];switch(c.add(s),!v&&s.isElementOrScript&&(v=s),r){case"append":e.append(s);break;case"prepend":e.prepend(s);break;case"insertAfter":s.insertAfter(e);break;case"insertBefore":s.insertBefore(e)}o.splice(l,1)}})}var f,m,v=null,w=new PgCollection,C=(r.forEachElement(function(e,n,t){var r=u(e,i);"insertAfter"===r.placement||"insertBefore"===r.placement?w.add(r.pgel.parent):w.add(r.pgel)}),w.normalize(),null);o&&(f=new Map,w.forEachElement(function(e){f.set(e,e.html(null,!0)),C=C||e}));return o?(C.withoutEvents(function(){h()}),w.forEachElement(function(e){e.updateInner(f.get(e))}),a.skip_event||pinegrow.changeManager.didChange(w,"Insert elements",{insert_operation:a.insert_operation,inserted_into_text:!0})):(h(),a.skip_event||pinegrow.changeManager.didInsert(c,null,a.format_html,{insert_operation:a.insert_operation})),a.repeater&&pinegrow.repeater.done(),v&&(m=v.get$DOMElement())&&(a.select?pinegrow.selectElement(m):a.scroll&&v.scrollTo(),a.highlight)&&setTimeout(function(){pinegrow.highlightElement(m)},250),c}pasteAttributes(e,n){for(var t=pinegrow.getCollection(e),r=[],a=$("<span "+n+"></span>"),o=0,l=a[0].attributes,s=l.length;o<s;o++)r.push({name:l[o].nodeName,value:a.attr(l[o].nodeName)});var i=!0;t.forEachElement(function(e){for(var n=0;n<r.length;n++)if(!canMakeChange(e,"attr",r[n].name)){i=!1;break}}),i&&(t.forEachElement(function(e){for(var n=0;n<r.length;n++)e.setAttr(r[n].name,r[n].value)}),pinegrow.changeManager.didChange(t,"Paste attributes"))}setImageUrl(e,t,r,a){var n,o,l,s=pinegrow.getCollection(e);0!==s.getLength()&&(n=!0,s.forEachElement(function(e){canMakeChange(e,"attr",r?"style":"src")||(n=!1)}),n)&&(o=pinegrow.getCurrentProject(),s.forEachElement(function(e){var n=e.getPage().makeRelativeUrl(t);o&&(n=o.mapDOMUrlToSourceUrl(n)),r?e.setInlineBackgroundImage(n):"img"===e.tagName&&e.setAttr("src",n,!1,null,a&&a.event_info?a.event_info:null)}),a&&a.no_change_event||(l=a&&a.event_name?a.event_name:"Set image",pinegrow.changeManager.didChange(s,l,a)))}setAttribute(e,n,t,r){var a,o,l,s=pinegrow.getCollection(e);0!=s.getLength()&&(a="string"==typeof n?[{name:n,value:t}]:n,o=!0,s.forEachElement(function(n){a.forEach(function(e){canMakeChange(n,"attr",e.name)||(o=!1)})}),o)&&(s.forEachElement(function(t){a.forEach(function(e){var n=null;"string"==typeof e.value&&(0<=e.value.indexOf(`"`)&&(n=`'`),0<=e.value.indexOf(`'`))&&(n=`"`),t.setAttr(e.name,e.value,!1,n,r&&r.event_info?r.event_info:null)})}),r&&r.no_change_event||(l=r&&r.event_name?r.event_name:(1==a.length?"Set attribute ":"Set attributes ")+a.map(function(e){return e.name}).join(", "),pinegrow.changeManager.didChange(s,l,r)))}removeAttribute(e,n,t){var r,a,o=pinegrow.getCollection(e);0!=o.getLength()&&(r="string"==typeof n?[n]:n,a=!0,o.forEachElement(function(n){r.forEach(function(e){canMakeChange(n,"attr",e)||(a=!1)})}),a)&&(o.forEachElement(function(n){r.forEach(function(e){n.removeAttr(e)})}),pinegrow.changeManager.didChange(o,(1==r.length?"Remove attribute ":"Remove attributes ")+r.join(", "),t))}getClassSorter(e){var n=e.getPage();return n&&n.classSorter||null}async canAddClass(e,n,t){var r=(e=e||pinegrow.selectedElements.getLastSelected())?.getPage()||pinegrow.getSelectedPage();return!r||r.classSetter.canAddClass(e,n,t)}addClass(e,r,n,o,l,t){var s=this,a=pinegrow.getCollection(e),i=a.getFirst(),c=!1,g=[];if("inline"===(l="auto"===l?pinegrow.classStyles.getCurrentStyleForPgel(i):l)&&(c=!0,l=null),!i&&!l)return!1;if(l&&l.locked)return pinegrow.showQuickError("The style is locked."),!1;"string"==typeof r&&(r=[r]);function p(e,n,t){return"function"==typeof r?r(e,n,t):r}var d,u=!0;a.forEachElement(function(e){for(var n=p(null,null,e),t=0;t<n.length;t++)if(!canMakeChange(e,"add_class",n[t])){u=!1;break}}),u&&(0===a.getLength()&&l&&a.add(pinegrow.getSelectedPage().sourceNode),a.forEachElement(function(n){var e,t,r=n.getPage(),a=p(l,r&&!c?r.classSetter:null,n);o&&("function"==typeof(t=o)&&(e=l?l.getClasses():r&&!c?r.classSetter.getClasses(n):n.getClasses(),t=o(n,e)),t.forEach(function(e){l?l.removeClass(e):r&&!c?r.classSetter.removeClass(n,e,s.getClassSorter(n)):n.removeClass(e,s.getClassSorter(n)),g.indexOf(e)<0&&g.push(e)})),a.forEach(function(e){l?l.addClass(e):r&&!c?r.classSetter.addClass(n,e,s.getClassSorter(n)):n.addClass(e,s.getClassSorter(n)),pinegrow.recentClasses.add(e,!0)}),l&&pinegrow.classStyles.applyStylesOnPgel(n)}),t||(d="Add class "+(1==r.length?r[0]:r[0]+" + "+(r.length-1)+" more"),0===r.length&&g.length&&(d=`Remove class `+(1==g.length?g[0]:g[0]+" + "+(g.length-1)+" more")),0===r.length&&0===g.length&&(d="Add class"),n?.action&&(d=n.action),l&&pinegrow.classStyles.styleWasChanged(i,!1,l,n),pinegrow.changeManager.didChange(a,d,n),pinegrow.dispatchEventDelayed("on_element_classes_changed",null,a,n)))}getFlexSettings(e){var n,t={flex:!1,inline:!1,direction:!1,grid:!1},r=e.get$DOMElement();return r&&("flex"===(n=r.css("display"))?t.flex=!0:"inline-flex"===n?(t.flex=!0,t.inline=!0):(t.inline=0<=n.indexOf("inline"),t.grid=0<=n.indexOf("grid")),n=r.css("flex-direction"))&&(0<=n.indexOf("row")?t.direction="row":t.direction="column"),t}hasClass(e,n,t){var r,a=!1;return"inline"===(t="auto"===t?pinegrow.classStyles.getCurrentStyleForPgel(e):t)&&(a=!0,t=null),t?t.hasClass(n):(r=e.getPage(),a||!r?e.hasClass(n):r.classSetter.hasClass(e,n))}getClasses(e){var n=e.getPage();return n?n.classSetter.getClasses(e):e.getClasses()}removeClass(e,r,n,a){var o=this,t=pinegrow.getCollection(e),l=t.getFirst(),s=!1;if("inline"===(a="auto"===a?pinegrow.classStyles.getCurrentStyleForPgel(l):a)&&(s=!0,a=null),!l&&!a)return!1;if(a&&a.locked)return pinegrow.showQuickError("The style is locked."),!1;"string"==typeof r&&(r=[r]);var i=!0;t.forEachElement(function(e){for(var n=0;n<r.length;n++)if(!canMakeChange(e,"remove_class",r[n])){i=!1;break}}),i&&(0===t.getLength()&&a&&t.add(pinegrow.getSelectedPage().sourceNode),t.forEachElement(function(n){var t=n.getPage();r.forEach(function(e){a?a.removeClass(e):t&&!s?(pinegrow.classStyles&&pinegrow.classStyles.ensureStyleWithClassIsSelected(n,e),t.classSetter.removeClass(n,e,o.getClassSorter(n))):n.removeClass(e,o.getClassSorter(n))})}),a&&pinegrow.classStyles.styleWasChanged(l,!1,a,n),l=1==r.length?r[0]:r[0]+" + "+(r.length-1)+" more",pinegrow.changeManager.didChange(t,"Remove class "+l,n),pinegrow.dispatchEventDelayed("on_element_classes_changed",null,t,n))}setClassProperty(e,n,r,t,a){var o=pinegrow.getCollection(e),l=o.getFirst();if("auto"===t&&(t=pinegrow.classStyles.getCurrentStyleForPgel(l)),!l&&!t)return!1;function s(e){for(var n={},t=0;t<e.length;t++)n[e[t]]=!0;for(t=0;t<r.length;t++){if(n[r[t].key])return r[t].key;if(n["!"+r[t].key])return"!"+r[t].key}return null}var i=t,c=null,g=!0;if(o.forEachElement(function(e){canMakeChange(e,"add_class",n)||(g=!1)}),g){if(i){if(i.locked)return pinegrow.showQuickError("The style is locked."),!1;c=s(i.getClasses()),pinegrow.makeChanges(l||pinegrow.getSelectedPage(),"Set "+n,function(){pinegrow.classStyles.addClassToStyle(l,i,n,c)},a)}else pinegrow.classStyles.getStylesForPgel(l).length?pinegrow.makeChanges(o,"Set "+n,function(){o.forEachElement(function(e){c=s(pinegrow.classStyles.getInlineClassesForPgel(e)),pinegrow.classStyles.addClassToStyle(e,null,n,c)})},a):this.addClass(o,[n],a,function(e){var n=s(e.getClasses());return n?[n]:[]});return!0}}addAction(e,t,n,r){var a,o=pinegrow.getCollection(e),l=!0;o.forEachElement(function(e){canMakeChange(e,"add_action",t)||(l=!1)}),l&&(a="Add action / "+t.name,o.forEachElement(function(e){var n=!0;(n=!t.on_can_add_action||t.on_can_add_action(e,e.getPage(),t)?n:!1)&&$.fn.crsa("addActionToElement",e,t,e.getPage(),r)}),n&&n.no_change_event||pinegrow.changeManager.didChange(o,a,n))}removeAction(e,n,t){var r,a=pinegrow.getCollection(e),o=!0;a.forEachElement(function(e){canMakeChange(e,"add_action",n)||(o=!1)}),o&&(r="Remove action / "+n.name,a.forEachElement(function(e){$.fn.crsa("removeActionFromElement",e,n,e.getPage())}),t&&t.no_change_event||pinegrow.changeManager.didChange(a,r,t))}changeTag(e,n){var t,r=pinegrow.getCollection(e),a="string"==typeof n?{tag:n}:n,o=(a.change_parent=a.change_parent||[],!0);r.forEachElement(function(e){canMakeChange(e,"delete_element")||(o=!1),e.parent&&a.parent_tag&&e.parent.tagName!=a.parent_tag&&(canMakeChange(e.parent,"insert_element")||(o=!1))}),o&&(t=new PgCollection,r.orderByDocumentPosition(),r.forEachElement(function(e){var n;e=e.replaceTag(a.tag),a.parent_tag&&e.parent&&e.parent.tagName!=a.parent_tag&&((n=e.prev())&&n.tagName==a.parent_tag?e.appendTo(n):0<=a.change_parent.indexOf(e.parent.tagName)?t.add(e.parent):((n=pgCreate("<"+a.parent_tag+"></"+a.parent_tag+">")).insertBefore(e),e.appendTo(n)))}),t.forEachElement(function(e){e.replaceTag(a.parent_tag)}),pinegrow.changeManager.didChange(r,"Change to "+a.tag))}wrapWithElement(e,r,a,o,l){function s(e){var n,t=new pgParserSourceProblem(e);return e||t.add("element",e,"wrap with element"),t.ok()?!(!canMakeChange(e.parent,"insert_element")||(n=!!a&&a(e))&&(pinegrow.showQuickMessage(n,4e3,!1,"error"),1)):(showAlert(t.toString(),"Can't create the element"),!1)}var n=pinegrow.getCollection(e).clone(),i=new PgCollection,c=n.areContinuosSiblings()&&1<n.getLength(),g=null;if(c){var g=pgCreateNodeFromHtml(r),t=n.getFirst();if(!s(t))return;g.insertBefore(t),i.add(g)}n.forEachElement(function(e,n,t){s(e)&&(c||((g=pgCreateNodeFromHtml(r)).insertBefore(e),i.add(g)),g.append(e),o&&o(g,e),l||pinegrow.selectedElements.replace(e,g),n===t-1)&&(pinegrow.changeManager.didInsert(i,null,null,{insert_operation:"wrap_with_element"}),pinegrow.selectedElements.reselect())})}wrapContentWithElement(e,o,l,s){var n=pinegrow.getCollection(e).clone(),i=new PgCollection;n.forEachElement(function(e,n,t){var r,a=new pgParserSourceProblem(e);e||a.add("element",e,"wrap with element"),a.ok()?canMakeChange(e,"insert_element")&&((r=!!l&&l(e))?pinegrow.showQuickMessage(r,4e3,!1,"error"):(r=pgCreateNodeFromHtml(o),e.moveChildrenToElement(r,!1,!0),e.append(r),s&&s(r,e),i.add(r),n==t-1&&(pinegrow.changeManager.didInsert(i,null,null,{insert_operation:"wrap_with_element"}),pinegrow.selectedElements.reselect()))):showAlert(a.toString(),"Can't create the element")})}setInlineStyle(e,n,t){var r,a=pinegrow.getCollection(e);0===a.getLength()||(r="",n.nodes.forEach(function(e){"decl"===e.type&&e.prop.length&&e.value.length?r+=`${e.prop}: ${e.value+(e.important?" !important":"")};`:"comment"===e.type&&(r+=`/* ${e.text} */`)}),this.setAttribute(a,"style",r,t),a=a.getFirst(),t&&t.skip_change_event)||pinegrow.dispatchEvent("on_css_attribute_style_changed",a.getPage(),a,t)}addCSSRuleToStylesheet(e,o,l,s,i,c,g){"object"==typeof e&&(e=o.getSourceForRules(e),e=o.filterSource(e,!0)),o.parseSource(e,function(e,n,r){if(e)i&&i(e),pinegrow.showAlert("<p>Could not insert the CSS rule.</p><p>"+e+"</p>","Error");else{var t=0;if("object"==typeof l){var t=-1,a=l;r.nodes.forEach(function(e){g?pgcssh.insertNodeBefore(e,a):(pgcssh.insertNodeAfter(e,a),a=e),t<0&&(t=e.parent.nodes.indexOf(e))})}else{switch(l){case"append":t=o.getRootNode().nodes.length;break;case"prepend":t=0;break;default:t=l}pgcssh.insertNodesAt(r.nodes,o.getRootNode(),t)}o.regenerateAndSetCssSource(function(){o.getRootNode();for(var e=[],n=0;n<r.nodes.length;n++)e.push(r.nodes[n]);var t="object"==typeof s?s:{action:s||"Add CSS rule"};t.list=[o],pinegrow.dispatchEvent("on_css_source_changed",null,t),i&&i(null,e,c)})}},!1)}overrideCSSVariableOLD(e,n,t,i){var r,a,d=function(e,n,r,a){var t=n.parent.nodes.indexOf(n),o=[];a=a||{};for(var l=t-1;0<=l;l--)u(n.parent.nodes[l])&&(o.push(n.parent.nodes[l].prop),a[n.parent.nodes[l].prop]=n.parent.nodes[l]);function s(e){var n=e.match(/\$[a-z0-9_\-]+/gi);n&&n.forEach(function(e){var n=[],t=!1;r.indexOf(e)<0&&e in a&&(n.push(e),t=!0),n.forEach(function(e){s(a[e].value)}),t&&r.push(e)})}return s(i||n.value),o},u=pgcssh.isVariable,o=pgcssh.getStylesheetForNode(e),l=null,h=[],s=(o==n?(l="append",r="Duplicate"):(r="Override",l=function(e,n,t,r){for(var a,o=[],l={},s=(r=r||{},d(e,t,o,l)),i=n.getRootNode(),c=null,g=null,p=i.nodes.length-1;0<=p;p--)u(i.nodes[p])?(g||(c=i.nodes[p],0<=s.indexOf(i.nodes[p].prop)&&(g=i.nodes[p])),0<=(a=o.indexOf(i.nodes[p].value))&&o.splice(a,1)):"atrule"==i.nodes[p].type&&"import"==i.nodes[p].name&&(c=null);r.used_vars=o,r.used_vars_code="";for(p=o.length-1;0<=p;p--)h.unshift(l[o[p]]),r.used_vars_code=`${o[p]}: ${l[o[p]].value.replace(/ !global/g,"")};`+r.used_vars_code;if(g)return g;if(!c)for(p=0;p<i.nodes.length&&"comment"==i.nodes[p].type;p++)c=i.nodes[p];return c||"prepend"}(o,n,e,a={})),o.getSourceForRules(e)),s=o.filterSource(s,!0);i&&(s=e.prop+`: ${i};`),a&&a.used_vars_code&&(s=a.used_vars_code+s),o!==n&&u(e)&&(s=s.replace(/ !default/g,"")),h.push(e),this.addCSSRuleToStylesheet(s,n,l,{action:r+" "+pgcssh.getNodeDisplayName(e)},t,h)}async overrideCSSVariable(e,s,r,i){function n(e,n,r,a){var t=n.parent.nodes.indexOf(n),o=[];a=a||{};for(var l=t-1;0<=l;l--)p(n.parent.nodes[l])&&(o.push(n.parent.nodes[l].prop),a[n.parent.nodes[l].prop]=n.parent.nodes[l]);function s(e){var n=e.match(c);n&&n.forEach(function(e){var n=[],t=!1;r.indexOf(e)<0&&e in a&&(n.push(e),t=!0),n.forEach(function(e){s(a[e].value)}),t&&r.push(e)})}return s(i||n.value),o}function a(e){for(var n=0;n<d.length;n++)if(d[n].prop==e.prop)return d[n]}function t(e){return e.replace(/ !global/g,"").replace(/ !default/g,"")}async function o(t,e,n){for(var r=0;r<e.length;r++){var a=e[r],o=a.value;if(function(e){if(-1<e.indexOf("(")){var n=getCSSFunctionNameAndParams(e)["name"];if(!t.isBuitInFunction(n))return!0}return!1}(o)){try{o=await async function(a){return new Promise(function(e,n){var t=pinegrow.showAlert("<p><b>"+a.prop+"</b> is using a custom function. Using this function in the value of the custom variable will most likely cause compilation errors.</p><p>Please input the custom value here:</p><p><div class='node-value'></div></p>","Set the variable value","Cancel","Ok",function(){n("delete")},function(){e(r.getValue())}).find(".node-value"),r=new PgInputField("node-value",{type:"text",name:"Value",without_text:!1});r.setValue(a.value),r.appendTo(t)})}(a)}catch(e){if("delete"==e)return!1}a.value=o}n(a)}return!0}var c=new RegExp("\\"+s.getDeclCharachter()+"[a-z0-9_\\-]*","ig"),g=pinegrow.pgPostCSSHelper,p=pgcssh.isVariable,l=pgcssh.getStylesheetForNode(e),d=[],u=[],h=[],f=null;if(l==s&&(f=e.value),l!=s)for(var f=t(e.value),m=s,v=[],w={},C=(n(0,e,v,w),v.length-1);0<=C;C--){var E=w[v[C]];d.unshift(E),u.unshift(g.createNode("decl",v[C],t(E.value),null,m))}var f=g.createNode("decl",e.prop,f,null,s),S=(i&&(f.value=i),u.push(f),d.push(e),[]);if(l==s?await o(s,u,function(e,n){var t=a(e);g.insertNodeInside(e,t.parent),S.push(e),n&&n()}):await o(s,u,function(e,n){var t=a(e),r=g.getNodeLevel(t),t=function(e,n,t){var r=s.getRootNode(),a=r.last;if(!a)return{node:r,fun:g.insertNodeInside};for(var o=null;a;)if("decl"==a.type){var l=g.findNodeInside("decl","prop",a.prop,e.parent);if(!l)return{node:a,fun:g.insertNodeAfter};if(e.prop==a.prop)return null;if(g.getNodeIndices(l)[t]-n<0)return{node:a,fun:g.insertNodeAfter};a=(o=a).prev()}else"import"==g.getNodeType(a)&&(o=a),a=a.prev();return o?{node:o,fun:g.insertNodeBefore}:{fun:g.insertNodeAt,node:r,index:0}}(t,g.getNodeIndices(t)[r],r);null!=t&&(S.push(e),t.fun(e,t.node,t.index)),n&&n()})){for(var _=0;_<S.length;_++)h.push(g.getNodeIndices(S[_]));s.setSourceForRules(s.rootNode,function(){for(var e=[],n=0;n<h.length;n++){var t=g.getNodeByIndices(s.rootNode,h[n]);e.push(t),pinegrow.dispatchEvent("on_css_node_added",null,{node:t,stylesheet:s})}r&&r(e,d)})}}editCSSRule(e){pinegrow.selectRule(e)}extractCSSForElementAndSelector(e,n,t){function r(e,n){e.rootNode&&d(e,e.rootNode,n),e.importedFiles&&e.importedFiles.forEach(r)}var a=e.getPage(),s="",i=new RegExp(`^${escapeRegExp(n)}($|[\\s>])`,"gm"),c=[],g=[],p=function(e){for(var n="",t=e;t<c.length;t++)n+=c[t]+" {\n";return n},d=function(n,e,t){if("rule"!==e.type||e.selector!==t&&!e.selector.match(i))e.nodes&&("atrule"===e.type&&c.push(`@${e.name} `+e.params),e.nodes.forEach(function(e){d(n,e,t)}),"atrule"===e.type)&&c.pop();else{for(var r=0,r=0;r<c.length&&g[r]===c[r];r++);for(var a=r;a<g.length;a++)s+="}\n";g=c.slice(0);var o=p(r),l=n.getSourceForRules(e);s+=o+"\n"+l}};a.stylesheets.stylesheets.forEach(function(e){(e=e.sourceStylesheet?e.sourceStylesheet:e).loaded&&(console.log(e.rootNode),r(e,n))});for(var o=0;o<g.length;o++)s+="}\n";var l=require("postcss");(0,l.postcss)().process(s,{syntax:l.postcssSCSS,parser:l.postcssSCSS,stringifier:l.postcssSCSS.stringify}).then(function(e){var n=e.root,n=(pgcssf.updateNodeRaws(n,!1,{},!0,null),pinegrow.pgPostCSSHelper.getSource(n,l.postcssSCSS.stringify));t(n)})}extractComponent(e,n){function t(){n&&n(l)}var r=e.getAttr("data-pgc-define"),a=e.getAttr("data-pgc-define-extract-css"),o=e.getPage(),l={html:e.toStringOriginal(!0)},o=o.sourceNode.findOne(`script[data-pgc-define-script="${r}"]`);o&&(l.js=o.html());a?this.extractCSSForElementAndSelector(e,a,function(e){l.css=e,t()}):t()}transformElement(e,r){var n=pinegrow.getCollectionForElement(e);pinegrow.makeChanges(n,"Transform element",function(){n.forEachElement(function(n){var t;n&&("svg"===(t=r.clone()).tagName&&["id","class","style","width","height"].forEach(function(e){n.hasAttribute(e)&&t.setAttribute(e,n.getAttribute(e))}),n.replaceWith(t),pinegrow.selectedElements.replace(n,t))})}),0<n.getLength()&&pinegrow.changeManager.didChange(n,"Replace")}moveUpOrDown(e,a){var o=pinegrow.getCollection(e),l=new PgCollection,n=a?"Move up":"Move down";o.normalize(),a||o.reverse(),o.forEachElement(function(e,n,t){var r;e.parent&&e.parent.parent&&canMakeChange(e.parent,"edit_content")&&(a?(r=e.prev())?(o.contains(r)?e.insertAfter(r):e.insertBefore(r),l.add(e.parent)):pinegrow.showQuickError("The element is already at the top."):(r=e.next())?(o.contains(r)?e.insertBefore(r):e.insertAfter(r),l.add(e.parent)):pinegrow.showQuickError("The element is already at the bottom."),n===t-1)&&e.scrollTo()}),0<l.getLength()&&pinegrow.changeManager.didChange(l,n)}moveUp(e){return this.moveUpOrDown(e,!0)}moveDown(e){return this.moveUpOrDown(e,!1)}twChangeClassPrefix(e,n,i,c,g){var p,d=pinegrow.findFrameworkByType("tailwind");d?("all"===c&&(c=""),this.addClass(e,function(e,n,t){p=[],r=e?e.getClasses():n?n.getClasses(t):t.getClasses(),a="string"==typeof i?r.filter(function(e){return d.twGetClassInfo(e,null,!0).whole_pseudo===i}):i;var r,a,o={},l=r.slice(0),s=(r.forEach(function(e){!g&&0<=a.indexOf(e)||pinegrow.classStyles.addClassToListHelper(l,e,o,null,p)}),l=r.slice(0),[]);return a.forEach(function(e){var n=d.twGetClassInfo(e,null,!0),n=c?c+":"+n.class:n.class;s.push(n),pinegrow.classStyles.addClassToListHelper(l,n,o,null,p),g||p.push(e)}),s},{action:`Change variant to `+(c||"all")},function(){return p},n),pinegrow.selectedElements.reselect()):pinegrow.showQuickError("Tailwind CSS is required.")}async twMoveClassesToParent(n,t,r,a,o,l){var s="";if(n!==a){var e=n.getUniqueSelector(a,r);if(!e)return pinegrow.showQuickError("Unable to get the selector for the custom variant."),!1;s=pinegrow.classStyles.getCustomVariantForSelector(e)+":"}if(t&&!l&&t.locked)return pinegrow.showQuickError(`Style ${t.getDisplayName()} is locked.`),!1;if(o&&o.locked)return pinegrow.showQuickError(`Style ${o.getDisplayName()} is locked.`),!1;if(o&&o.component){var i=await pinegrow.classStyles.classValidator.validateClasses(r),c=[];if(r.forEach(function(e){i[e]||c.push(e)}),c.length)return pinegrow.showQuickError(`Unable to add classes to the component style because they are not valid Tailwind classes: ${c.join(", ")}.`),!1}var g=new PgActiveClassesForPgel_State,p=r.map(function(e){return e=s+e,e=g.moveRelevantStatesToSubelementStateForClass(e)}),e=new PgCollection;!n||l||t||e.add(n),t&&!l&&e.add(t.db_node),a&&!o&&e.add(a),o&&e.add(o.db_node),pinegrow.makeChanges(e,l?"Duplicate classes":"Move classes",function(){p.forEach(function(e){o?o.addClass(e):pinegrow.classStyles.addInlineClass(a,e)}),l||r.forEach(function(e){t?t.removeClass(e):pinegrow.classStyles.removeInlineClass(n,e)});var e=[];t&&e.push(t),o&&e.push(o)})}twMoveSubElementClassesToDirectElements(e,a,n){var o=new PgActiveClassesForPgel_State,t=pinegrow.getCollection(e),l=new PgCollection,s=!1;if(a&&a.locked)return pinegrow.showQuickError("The style is locked."),!1;t.forEachElement(function(r){n.forEach(function(t){var e;s||(o.state=t,(e=o.containsSubelement())&&(e=o.getSubelementSelector(o.makeSureSubelementStateHasBrackets(e),!0))&&(e=r.find(e)).length&&e.forEach(function(e){var n;s||(n=o.moveClassFromSubElementToDirectElement(t),canMakeChange(e,"add_class",n)&&(a||canMakeChange(r,"remove_class",t))?(pinegrow.classStyles.addInlineClass(e,n),a?a.removeClass(t):(pinegrow.classStyles.removeInlineClass(r,t),l.add(r)),l.add(e)):s=!0)}))})}),l.getLength()&&(a&&pinegrow.classStyles.styleWasChanged(null,!1,a),pinegrow.changeManager.didChange(l,"Move classes to sub-elements"))}twGetMenuActionsFor(o,l,s,r){const i=this;var c,g,t,a,n,e,p,d,u,h=[],f=!0,m=pinegrow.findFrameworkByType("tailwind");return m&&((s="string"==typeof s?[s]:s)&&0!==s.length||(f=!1,l&&l instanceof PgClassStyle?s=l.getClasses():o&&(s=pinegrow.classStyles.getInlineClassesForPgel(o))),r&&(s=s&&s.filter(function(e){return e.startsWith(r+":")})),c=new PgActiveClassesForPgel_State,t=g=!1,a=null,r&&(c.state=r,g=c.containsSubelement()),s&&s.forEach(function(e){var n=m.twGetClassInfo(e,null,!0);g||(c.state=n.whole_pseudo,g=c.containsSubelement()),!t&&n.whole_pseudo&&(t=n.whole_pseudo,a=e)}),n=function(e,n){var t=e.getValue();i.twChangeClassPrefix(o?pinegrow.getCollectionForElement(o):null,l,s||r||"",t,n)},h.push({label:"Move to variant",submenu:function(){var e=new PgClassStateComposerDropdown;return e.handle_building=!1,t&&e.setValue(t),e.onChanged=function(){n(e,!1)},e.getActions()}}),h.push({label:"Duplicate to variant",submenu:function(){var e=new PgClassStateComposerDropdown;return e.handle_building=!1,t&&e.setValue(t),e.onChanged=function(){n(e,!0)},e.getActions()}}),o&&s&&s.length&&!l&&(g&&(u=c.getSubelementSelector(c.makeSureSubelementStateHasBrackets(g),!0))&&(e=o.findOne(u),h.push({label:`Move to ${escapeHtmlCode(u)} sub-elements`,action:function(){e?(new PgApi).twMoveSubElementClassesToDirectElements(o,l,s):pinegrow.showQuickError("No elements match the selector.")}})),h.push({label:"Move to parent",submenu:function(){if(g)return[{type:"header",label:`One or more classes contain custom sub-element selector variant (${c.formatStateWithSubelementForDisplay(c.makeSureSubelementStateHasBrackets(g))}) and can not be moved to a parent element.`}];for(var n=[],e=[],t=5,r=o.parent;r&&0<t;)0===n.length&&pinegrow.classStyles.getStylesForPgel(r).forEach(function(e){n.push({dest_pgel:r,dest_style:e})}),e.push({dest_pgel:r}),r=r.parent,t--;var a=[{type:"header",label:`Move ${s&&1===s.length?"this class":"these classes"} to a parent element or style and scope them with sub-element selector:`}];return e.forEach(function(e){a.push({label:e.dest_pgel.getName({short:!0}),action:function(){i.twMoveClassesToParent(o,l,s,e.dest_pgel,null,!1)},on_mouseenter:function(){pinegrow.highlightElement(e.dest_pgel)},on_mouseleave:function(){pinegrow.highlightElement(null)}}),n.length&&n.dest_pgel===e.dest_pgel&&a.push({label:`<span class="pg-css-grid-tw-style-in-menu">${n[0].dest_style.getDisplayName()}</span> on `+n[0].dest_pgel.getName({short:!0}),action:function(){i.twMoveClassesToParent(o,l,s,n[0].dest_pgel,n[0].dest_style,!1)},on_mouseenter:function(){pinegrow.highlightElement(n[0].dest_pgel)},on_mouseleave:function(){pinegrow.highlightElement(null)}})}),a}})),(o||l)&&h.push({label:"Swap colors",submenu:function(){return m.twGetMenuActionsForColorChange(l?.db_node||o,r?r+":":null)}}),u=!1,(p=pinegrow.clipboard.getCurrentItem())&&"classes"===p.type&&(h.push({type:"divider"}),u=!0,h.push({label:"Paste classes",action:function(){var e=new PgApi,n=p.data;r&&(n=n.map(function(e){return e=m.twGetClassInfo(e,null,!0).class,r+":"+e})),e.addClass(o,n,null,null,l)}})),s)&&s.length&&(h.push({type:"divider"}),h.push({label:"Create a new style",helptext:"Create a new style with selected classes",action:function(){new PgClassStyleCreator(null,null,!0).createWithDialog(o,s)}}),d=function(e){var n=s;e&&(n=n.map(function(e){return m.twGetClassInfo(e,null,!0).class})),pinegrow.clipboard.copySpecial("classes",n),copyCodeToClipboard(n.join(" "),!0,"Classes copied to clipboard.")},u||h.push({type:"divider"}),(t=r||f?t:!1)?(u=m.twGetClassInfo(s[0],null,!0),h.push({label:"Copy classes",submenu:[{label:`Without variants (${u.class}...)`,action:function(){d(!0)}},{label:`With variants (${a}...)`,action:function(){d(!1)}}]})):h.push({label:"Copy classes",action:function(){d()}})),h}}