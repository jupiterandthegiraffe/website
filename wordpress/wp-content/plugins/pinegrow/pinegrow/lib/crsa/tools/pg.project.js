class PgProjectMenuHelper{constructor(e){this.project=e||pinegrow.getCurrentProject()}askToRename(e,t,r){var n=this;pinegrow.backend.askToRenameProject(this.project,function(){e&&e(n.project)},t,r)}close(e,t,r){this.project.ask_to_rename_on_close?(this.project.ask_to_rename_on_close=!1,this.askToRename(function(){pinegrow.backend.saveAndCloseCurrentProject(e)},t,r)):pinegrow.backend.saveAndCloseCurrentProject(e)}download(e){pinegrow.currentUser.isPro()?(new PgProjectDownloader).createAndDownloadZIP(e):pinegrow.currentUser.onlyForProNotice("Project download")}async saveToLocalFolder(e){return pinegrow.backend.getManagerForProject("local--").saveProjectAsLocal(null,e)}exploreFiles(){pinegrow.showUIPanel("project",!1,!1,!0)}duplicate(){var r=this.project;pinegrow.backend.canCreateProject()&&pinegrow.showPrompt(`<p>Enter the name of the new project:</p>`,"Duplicate project",r.name,"",null,function(e){e=escapeHtmlCode(e);var t="project_"+pgMakeSlug(e);r.name=e,pinegrow.backend.saveAsNewProject(r,t,function(){pinegrow.showQuickMessage("The project was duplicated. Open it from the Start screen.")})})}delete(e){var t=this.project;pinegrow.showAlert(`<p>Are you sure you want to delete the project? You won't be able to get it back!</p>`,"Delete project?","Cancel","Yes, delete it!",null,function(){pinegrow.backend.deleteProject(t,function(){pinegrow.getCurrentProject()?pinegrow.closeCurrentProject(null,!0,function(){e&&e()}):e&&e()})})}getShareMenuActions(){function e(e){r.access_view=e,o=e,pinegrow.backend.saveDelayed()}function t(e){r.view_mode=a=e,pinegrow.backend.saveDelayed()}var r=this.project,n=!isApp()&&(pgf.use_browser_storage||!1),o=r.access_view,i=r.access_clone,a=r.view_mode,l=r.category,s=r.meta||{},c=[],u=(c.push({type:"header",label:"Get the link"}),pinegrow.browserPreview.getPublicUrlForProject());return c.push({link_url:u,label:`Open in browser`,dont_handle_click:!0}),c.push({label:"Copy the link to clipboard",action:function(){copyCodeToClipboard(u)}}),c.push({label:"Copy the embed code",action:function(){copyCodeToClipboard(`<iframe src="${u}"></iframe>`)}}),c.push({type:"divider"}),c.push({type:"header",label:n?"Who can view the project?":"Who can edit this project?"}),c.push({label:"Just me",action:function(){e("private")},check:"private"===o}),pgf.kids&&c.push({label:"Everybody in my group",action:function(){e("group")},check:"group"===o}),pinegrow.currentUser.canPublishPublicProjects()&&(c.push({label:n?"Everybody":"Other users",action:function(){e("public")},check:"public"===o}),n)&&(c.push({type:"divider"}),c.push({label:"Edit project info...",action:function(){var e={category:{type:"select",name:"Category",show_empty:!1,options:[{key:"none",name:"None"},{key:"featured",name:"Featured"},{key:"dailydiv",name:"Dailydiv"},{key:"styleguide",name:"Style guide"},{key:"design",name:"Design"},{key:"library",name:"Component library"}],value:l||"none"},description:{type:"text",name:"Description",textarea:!0,value:s.description||""},video_url:{type:"text",name:"Video url",value:s.video_url}};pinegrow.showQuickDialog("Edit project info","Info","Add useful information to public projects.",e,"Cancel","Save",null,function(e){var t;t=e.category||"none",r.category=t,l=t,pinegrow.backend.saveDelayed(),delete e.category,t=e,r.meta=t,s=t,pinegrow.backend.saveDelayed()})}}),c.push({type:"divider"}),c.push({label:"View in iframe",submenu:[{label:"No iframe for me (default)",helptext:"Project will be displayed without iframes for you, with iframes for others.",action:function(){t(null)},check:!a||"normal_if_viewed_by_author"===a},{label:"Iframe",helptext:"Project will be displayed with iframes for everybody.",action:function(){t("iframe")},check:"iframe"===a},{label:"Without iframe",helptext:"Project will be displayed without iframes for everybody.",action:function(){t("normal")},check:"normal"===a}]})),n&&(c.push({type:"divider"}),c.push({type:"header",label:"Can people copy the project?"}),c.push({label:"Allow copying",action:function(){var e;e="clone"===i?"":"clone",r.access_clone=i=e,pinegrow.backend.saveDelayed()},check:"clone"===i})),c}getTagsMenuAction(){var r=this.project;return{label:"Tags",submenu:["bootstrap 5","tailwind css","plain html","interactions","tutorial"].map(function(t){return{label:t,check:0<=r.project_tags?.indexOf(t),action:function(){var e=r.project_tags.indexOf(t);e<0?r.project_tags.push(t):r.project_tags.splice(e,1),r.project_tags_changed=!0,pinegrow.backend.saveDelayed()}}})}}getComponentsMenuActions(){var e=pinegrow.findFrameworkByType("pg.components");if(e)return e.pcGetComponentsMenuActions()}getRevisionsMenuActions(){var t,r=this,n=this.project,o=[];return n.revisions&&0!==n.revisions.length?(o.push({type:"header",label:"Project revisions<br>Click on the revision to preview it."}),t=function(){var e=this.key,t=r.project;0===e&&!t.loaded_revision_info||t.loaded_revision_info&&t.loaded_revision_info.id==e?pinegrow.showQuickError("This revision is already loaded."):r.close(function(){pinegrow.tutorialsManager.openProject(t.url,null,t.isLoadedFromAnotherUser,null,e)})},o.push({type:"divider"}),o.push({label:"Current",key:0,action:t,check:!n.loaded_revision_info,submenu:[{label:"Open",key:0,action:t},{label:"Open in new window",key:0,dont_handle_click:!0,link_url:pinegrow.backend.getProjectEditUrl(n)}]}),o.push({type:"divider"}),n.revisions.forEach(function(e){o.push({label:e.user+` at `+new Date(1e3*e.time).toLocaleString(),key:e.id,action:t,check:n.loaded_revision_info&&n.loaded_revision_info.id==e.id,submenu:[{label:"Open",key:e.id,action:t},{label:"Open in new window",key:e.id,dont_handle_click:!0,link_url:pinegrow.backend.getProjectEditUrl(n,e.id)},{label:"Delete...",action:function(){pinegrow.showAlert(`<p>Are you sure you want to delete the revision created by <code>${e.user}</code>on <code>${new Date(1e3*e.time).toLocaleString()}</code>?</p>`,"Delete the revision?","Cancel","Yes, delete the revision",null,function(){pinegrow.backend.deleteProjectRevision(n,e.id)})}}]})}),o.push({type:"divider"}),o.push({label:"Delete all revisions...",action:function(){pinegrow.showAlert(`<p>Are you sure you want to delete all saved project revisions?</p>`,"Delete the revisions?","Cancel","Yes, delete all revisions",null,function(){pinegrow.backend.deleteAllProjectRevisions(n)})}})):o.push({type:"header",label:"The project has no revisions."}),o}createNewPage(i,e,a,l){function s(e){return l||e.endsWith(".html")||(e+=".html"),e}var c=this.project,u=((a=a||"")&&!a.endsWith("/")&&(a+="/"),i?a+"index.html":"index.html"),p=l?"file":"page",t={name:{name:l?"File name":"Page name",type:"text",value:e,placeholder:l?"for example: my_code.js":"for example: my_page.html",validate:function(e,t,r,n,o,i){return r?r.match(/^[a-z0-9\.\-\_\/\(\)\[\]]+(\.html|\.php)?$/i)?(r=s(r),c.getFileForUrl(c.getAbsoluteUrl(r))?`A page with the name <code>${r}</code> already exists.`:null):`The ${p} name should contain only letters, numbers and characters <code>-</code>, <code>_</code> and <code>.</code>.`+(l?"":" The name should end with <code>.html</code> or <code>.php</code>."):`The ${p} name is required.`}}},r=[];if(c&&c.framework&&c.framework.master_pages)for(var n in c.framework.master_pages)r.push({key:c.framework.master_pages[n].name,name:c.framework.master_pages[n].name});r.length&&(t.master_page={name:"Master page",type:"select",show_empty:!0,options:r,helptext:"Select a master page if you wish to create a page that depends on the selected master page."}),pinegrow.showQuickDialog(`Create a new `+p,"Information",`<p>Enter the name of the new ${p}.</p> <p>Include a folder name (for example, <code>folder/mypage.html</code>) if you wish to create the ${p} in a new folder.</p>`,t,"Cancel","Create",null,function(e){var t,r=e.name,n=e?.master_page,r=escapeHtmlCode(r),r=a+s(r),o=c.getAbsoluteUrl(r);i||l||(i=c.getContentOfUrl("_new.html",function(e){i=e}))||(t=c.getProjectInfo(),(t=c.source_project_id||t.getSetting("source-project-url"))&&(t=pinegrow.tutorialsManager.getLessonByKey(t.replace("https://tutorial_","")))&&(i=t.getHiddenFileContent("_new.html"))),l||(i=i||`<!doctype html><html><head><link href="style.css" rel="stylesheet"></head><body></body></html>`,(t=new pgParser).assignIds=!1,t.parse(i),t.rootNode.mapLinksToNewLocation(c.getAbsoluteUrl(u),c.getAbsoluteUrl(r),!1,!0),i=t.rootNode.toStringOriginal(!0)),c.setContentOfUrl(r,i,function(){l?(pinegrow.backend.saveDelayed(),pinegrow.refreshCurrentProjectDelayed(!0)):pinegrow.openOrShowPage(o,function(e){var t;e.setPageChanged(!0),c.pageWasOpenedOrClosed(e,!0),n&&(e.crsaProjectTemplate=c,(t=pinegrow.findFrameworkByKey("pg.components")).useMasterPage(e,c,{name:n},!0),t.updateEditableAreas(e)),pinegrow.backend.saveDelayed(),pinegrow.refreshCurrentProjectDelayed(!0)},!0)})})}renameFile(t){var r=this.project,e=r.getFileForUrl(t),n=e.isFile?"file":"folder";pinegrow.showPrompt(`Enter the new ${n} name:`,"Rename the "+n+" "+e.name,e.name,`New ${n} name`,null,function(e){e=escapeHtmlCode(e),r.renameProjectFileUrl(t,e),pinegrow.refreshCurrentProjectDelayed(!0),pinegrow.backend.saveCurrentProject(function(){pinegrow.showQuickMessage("Done.")}),pinegrow.showQuickMessage("Renaming...")})}restartLesson(){function e(){pinegrow.backend.cancelSaveDelayed(),pinegrow.showQuickMessage("Restarting... Please wait."),pinegrow.backend.deleteProjects(n.map(function(e){return e.getProjectId()}),function(){pinegrow.backend.setLessonStatusMultiple(n,"none",function(){n.forEach(function(e){e.setStatus("none")}),pinegrow.closeCurrentProject(null,!0,function(){r.openLesson(n[0].key)})})})}var t=this.project,r=this.project.lesson.tutorial,n=r.getAllLessonParts(t.lesson),o=n.indexOf(t.lesson);1<n.length?(t=(t=n[0]).main_lesson_project_name||t.name.split(" - ")[0],0===o?pinegrow.showAlert(`<p>This ${pgf.lesson_name} is the first part of the project <code>${t}</code>.</p>
<p>Restarting the first ${pgf.lesson_name} will restart all ${pgf.lesson_name}s in the project and erase what you did so far.</p>
<p>What would you like to do?</p>`,`Do you want to restart?`,`No, go back`,null,null,null,"Restart the whole tutorial",function(){e()}):pinegrow.showAlert(`<p>This ${pgf.lesson_name} is a part of the project <code>${t}</code>.</p>
<p>You can:</p>
<ul>
<li>Restart the project from this ${pgf.lesson_name} onward.</li>
<li>Restart the whole project. You will go back to the first ${pgf.lesson_name} in the project.</li>
</ul>
<p>Restarting the ${pgf.lesson_name} will erase what you did so far. What would you like to do?</p>`,`Do you want to restart?`,`No, go back`,`Restart from this ${pgf.lesson_name} onward`,null,function(){n.splice(0,o),e()},"Restart the whole project",function(){e()})):pinegrow.showAlert(`<p>Restarting the ${pgf.lesson_name} will erase what you did so far. Do you want to restart?</p>`,`Do you want to restart?`,`No, let's go back`,`Yes, restart the `+pgf.lesson_name,null,function(){e()})}}var PgQuickNiceProjectView=function(e){var t,r,n,o,i,a=!isApp()&&(pgf.use_browser_storage||!1);pgf.use_nice_project_menu?(n=new PgNiceProjectView,o=new PgQuickWindow("Project",n,"quickProject",500,500),this.win=o,(n.win=o).showFor$El(e,!1,0,"down"),n.show(pinegrow.getCurrentProject()),pinegrow.focusRect.coverAll(),i=function(){o.close()},pinegrow.addEventHandler("on_focus_rect_closed",i),o.onDestroy=function(){pinegrow.focusRect.hide(),pinegrow.removeEventHandler("on_focus_rect_closed",i)}):(t=new PgProjectMenuHelper,(n=[]).push({label:"Close project",action:function(){t.close()}}),n.push({type:"divider"}),n.push({label:"Explore files",action:function(){t.exploreFiles()}}),pgf.components&&(r=t.getComponentsMenuActions())&&n.push({label:"Components",submenu:r}),n.push({type:"divider"}),n.push({label:"Revisions",submenu:t.getRevisionsMenuActions()}),n.push({type:"divider"}),t.project.isTutorialLesson()?(n.push({type:"header",label:"Tutorial lesson"}),n.push({label:"Save as a normal project...",action:function(){t.duplicate()}}),n.push({label:"Restart the lesson...",action:function(){t.restartLesson()}}),n.push({label:"Copy the link to clipboard",action:function(){var e=pgwpdata.edit_link+"/tutorial/"+t.project.lesson.key;copyCodeToClipboard(e)}})):(t.project.fsHandle||n.push({label:"Rename...",action:function(){t.askToRename()}}),n.push({label:"Duplicate...",action:function(){t.duplicate()}})),n.push({type:"divider"}),r=[{label:"ZIP",action:function(){t.download()}}],pgf.use_filesystem_api&&(r.push({label:"Save to local folder",action:function(){t.saveToLocalFolder()}}),r.push({label:"Save to local folder &amp; open",action:function(){t.saveToLocalFolder(!0)}})),n.push({label:"Download",submenu:r}),pinegrow.currentUser.isLoggedInAndActive()&&pinegrow.currentUser.canPublishPublicProjects()&&(n.push({type:"divider"}),n.push({label:"Share",submenu:t.getShareMenuActions()}),a&&n.push(t.getTagsMenuAction()),"undefined"!=typeof PgPublishProvider)&&(n.push({type:"divider"}),n.push({label:"Publish...",action:function(){(new PgPublishProviderNetlify).showProjectSettings()},helptext:"Publish the project as a static HTML site on Netlify."})),n.push({type:"divider"}),n.push({type:"header",label:"Danger zone"}),pgf.block_untrusted_js&&!t.project.fsHandle&&(n.push({label:"Security",submenu:[{label:"Block untrusted JavaScript",check:pinegrow.shouldBlockUntrustedJS(),action:function(){var e=pinegrow.getCurrentProject();pinegrow.shouldBlockUntrustedJS()?pinegrow.showAlert(`<p>Are you sure you want to run all JavaScript code on all pages in this project?</p><p>Malicious code in the edited project can interfere with the editor or even gain access to your information on ${pgf.product_name_short}. </p>`,"Do you want to run all JavaScript code?","No, keep it blocked","Yes, I trust this project 100%",null,function(){e.block_untrusted_js=!1,pinegrow.showMode("Block untrusted JavaScript",!1),pinegrow.refreshAllPages()}):(e.block_untrusted_js=!0,pinegrow.showMode("Block untrusted JavaScript",!0),pinegrow.refreshAllPages())}}]}),n.push({type:"divider"})),n.push({label:"Delete project...",action:function(){t.delete()}}),new CrsaContextMenu(n,e).showForElement(e,null,8))},PgNiceProjectView=function(){function a(){c.win.close()}var o=new PgProjectMenuHelper,e=$(`<div class="pg-nice-project-view">
<div class="pg-nice-project-commands"></div>
<div class="pg-nice-project-name rename"><span></span><i class="icon icon-Editable" style="margin-left:5px;"></i></div>
<div class="pg-nice-project-pages"></div>
</div>`),i=e.find(".pg-nice-project-name span"),l=e.find(".pg-nice-project-pages"),s=e.find(".pg-nice-project-commands"),e=(e.find(".rename").on("click",function(e){var t,r;e.preventDefault(),o.askToRename(function(){c.show(u)},t,r)}),addTooltip(i.parent(),"Click to rename the project."),new PgUIView(e,"nice_project","Project")),c=(this.view=e,this),u=null,p=(this.show=function(n){var e={title:"The Project menu",pages:!0,buttons:{close:{label:"Close project",classes:"",tooltip:"Close the project and go back to the start screen. Your project is saved automatically."},extras:[{label:"Share",tooltip:"Decide who can view and clone the project.",action:function(e,t){var r=o.getShareMenuActions();return new CrsaContextMenu(r,e).showForElement(e),!0}},{label:"More",tooltip:"Download, duplicate, delete and other project commands.",action:function(e,t){var r=[];r.push({label:"Download...",action:function(){o.download()}}),r.push({type:"divider"}),r.push({label:"Explore files...",action:function(){a(),o.exploreFiles()}});return r.push({label:"Tags",submenu:["bootstrap 5","tailwind css","plain html","interactions","tutorial"].map(function(t){return{label:t,check:0<=n.project_tags.indexOf(t),action:function(){var e=n.project_tags.indexOf(t);e<0?n.project_tags.push(t):n.project_tags.splice(e,1),n.project_tags_changed=!0,pinegrow.backend.saveDelayed()}}})}),r.push({type:"divider"}),r.push({label:"Duplicate project...",action:function(){o.duplicate()}}),r.push({type:"divider"}),r.push({type:"header",label:"Danger zone"}),r.push({label:"Delete project...",action:function(){o.delete()}}),new CrsaContextMenu(r,e).showForElement(e),!0}}]}},t=(u=n,`<`),r=(s.html(""),pinegrow.dispatchEvent("on_show_nice_project_view",null,n,e,a),$(`<button class="pg-button ${e.buttons.close.classes||""}">${e.buttons.close.label}</button>`).appendTo(s));e.buttons.close.tooltip&&addTooltip(r,e.buttons.close.tooltip),r.on("click",function(e){e.preventDefault(),o.close(a,`<p>Why not give your project a proper name?</p>`,`Name the project`)}),e.buttons.extras.forEach(function(t){var r=$(`<button class="pg-button ${t.classes||""}">${t.label}</button>`).appendTo(s);t.tooltip&&addTooltip(r,t.tooltip),r.on("click",function(e){return e.preventDefault(),!0!==t.action(r,a)&&a(),!1})}),e.pages?(i.html(n.name||n.url),pg$Show(i.parent()),t=`<div class="pg-nice-project-new-page" data-page=""><i class="icon icon-plus"></i>Add new page</div>`,n.getEditableFiles({},n).filter(function(e){return!crsaGetNameFromUrl(e.url).startsWith("_")||pinegrow.currentUser.isAdmin()}).forEach(function(e){t+=`<div data-page="${e.url}">`,e.thumb&&(t+=`<div class="image-wrapper-4x3"><img src="${e.thumb}"></div>`),t+=`<span>${e.name}</span><div class="commands">
<i class="icon icon-duplicate duplicate" title="Duplicate the page."></i>
<i class="icon icon-bin delete" title="Delete the page."></i>
</div></div>`}),l.html(t),addTooltip(l.find(".commands i"),""),pg$Show(l,"grid")):(pg$Hide(l),pg$Hide(i.parent())),this.win.setTitle(e.title)},l.on("click","div.commands i",function(e){e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation();var t=$(this),r=t.closest("[data-page]").attr("data-page"),n=crsaGetNameFromUrl(r),o=pinegrow.getCrsaPageByUrl(r),i=u.getFileForUrl(r);t.hasClass("delete")?pinegrow.showAlert(`<p>Do you want to delete the page <code>${n}</code>? You can't undo this operation.`,"Are you sure?","Cancel","Yes, delete it!",null,function(){o&&(o.close(),o.view.closeTab()),u.removeFileNodeFromList(i),c.show(u),pinegrow.backend.deletePage(u,r,function(){pinegrow.showQuickMessage(`The page ${n} was deleted!`)})}):t.hasClass("duplicate")&&(o?(t=o.getCodeForSave(),p(t)):u.getContentOfUrl(r,function(e){p(e)}),a())}),l.on("click","div[data-page]",function(e){var t=this.getAttribute("data-page");t?pinegrow.openOrShowPage(t,function(e,t){t&&u.pageWasOpenedOrClosed(e,!0)},!0):u.source_project_id?pinegrow.backend.withSourceProject(u,function(n){var e,t,o;n?(e=n.getEditableFiles(),t=`<div class="pg-nice-project-templates">`,e.forEach(function(e){t+=`<div data-name="${e.name}"><div class="image-wrapper-4x3">`,e.thumb&&(t+=`<img src="${e.thumb}">`),t+=`</div><span>${e.name}</span></div>`}),t+=`</div>`,(o=pinegrow.showAlert(t,"Select a template for the new page","Cancel")).find("[data-name]").on("click",function(e){var t=$(this).attr("data-name"),r=n.getContentOfUrl(t);o.modal("hide"),p(r,t)})):pinegrow.showQuickError("Could not load the source project "+u.source_project_id+".")}):p(),a()}),function(e,t){return new PgProjectMenuHelper(u).createNewPage(e,t)})},PgProjectView=function(){pinegrow.projectView=this;var e,t=$('<div class="pg-project-view crsa-panel"></div>'),g=new PgUIView(t,"project","Project"),f=(this.view=g,this),m=(g.tabIcon="icon-project",{}),r=new PgSearchBox({placeholder:"Search project",placeholder_active:null,toolbar_on:!0}),n=r.getToolbar();isApp()&&(n.addSection("settings"),e=new PgButtonToolbarItem("icon-tools","Manage libraries and plugins."),n.addItem("settings",e),e.onClick=function(){$.fn.crsacss("showFrameworkManager",pinegrow.getSelectedPage())}),r.$element.appendTo(t),r.onSearch=function(e){o(e)};function w(e){for(var t=e.split(","),r=j.root,n=1;n<t.length;n++){var o=parseInt(t[n]);if(r.children.length<=o)return null;r=r.children[o]}return r}function v(){var e=pinegrow.getSelectedPage(),t="<p>Open a folder as Project to show it here.</p>";e?e.localFile?t+='<p class="buttons"><button class="pg-button open-current">Open '+e.name+" as project</button></p>":t='<p>Please save the page first, then open its folder as project.</p><p class="buttons"><button class="pg-button save-current">Save the page</button></p>':t+='<p class="buttons"><button class="pg-button open-folder">Open a folder</button></p>',b.show(t)}(new PgSearchBoxSpacer).$element.appendTo(t);var b=new PgPanelNotice,_=(b.$element.appendTo(t),b.$element.on("click",".open-folder",function(e){e.preventDefault(),canOpenProject()&&pinegrow.openProjectBySelectingFolder()}),b.$element.on("click",".open-current",function(e){e.preventDefault();var t,r=pinegrow.getSelectedPage();r&&canOpenProject()&&(r.localFile?(t=require("path").dirname(r.localFile),pinegrow.openProject(t,r)):pinegrow.showQuickError("Please, save the page first."))}),b.$element.on("click",".save-current",function(e){e.preventDefault(),pinegrow.getSelectedPage()&&$(".menu-file-save").trigger("click")}),$('<div class="pg-project-view-content crsa-project-list"></div>').appendTo(t)),j=null,o=function(e){var i=0<e.length?new RegExp(escapeRegExp(e),"i"):null,t=_.find("li.project-item");i&&(t.removeClass("has-found"),t.each(function(e,t){var r=$(t),n=r.attr("data-file-name");if(i&&n.match(i)){r.addClass("found").removeClass("not-found");for(var o=r.parent().closest("li.project-item");o.length&&(o.hasClass("folder-closed")&&(o.removeClass("folder-closed"),o.find("> .folder-icon").removeClass("icon-right").addClass("icon-down"),o.addClass("search-expanded")),!o.hasClass("has-found")||o.hasClass("folder-closed"));)o.addClass("has-found"),o=o.parent().closest("li.project-item")}else r.removeClass("found").addClass("not-found")})),i||t.removeClass("found not-found has-found"),_.find("li.search-expanded:not(.found,.has-found)").each(function(e,t){var r=$(t);r.addClass("folder-closed"),r.removeClass("search-expanded"),r.find("> .folder-icon").removeClass("icon-down").addClass("icon-right")})},y=(this.show=function(h){g.whenVisible(function(){function o(e,t,r,n){for(var o=pinegrow.getSelectedPage(),i=[],a=0;a<s[e].length;a++){var l=s[e][a](o,t,r,n);l&&i.push(l)}return i}function n(e,t,r){for(var n=new CrsaContextMenu(null,r),o=0;o<e.length;o++)for(var i,a=0;a<e[o].length;a++)e[o][a].divider?(n.add("",null,null,"divider"),e[o][a].header&&n.add(e[o][a].header,null,null,"header")):((i=n.add(e[o][a].label,e[o][a].key||null,e[o][a].func)).submenu=e[o][a].submenu||null,i.check=e[o][a].check||null);n.showAt(t.pageX,t.pageY,l),n.updatePosition()}function c(e,t){for(var r=0;r<e.children.length;r++){var n,o,i,a,l,s=e.children[r];d[s.name]||(n=t+","+r,i=o="",s.isFile||(m[s.url]?o='<i class="folder-icon icon icon-down"></i>':(o='<i class="folder-icon icon icon-right"></i>',i="folder-closed")),a=s.isEditable?"editable":"",l=s.getSimpleType(),0<=p.indexOf(l)&&pgf.edit_html&&("css"===l&&"text/css"!==pinegrow.getMimeType(s.url)||(i+=" draggable",s.addTag({icon:"Pin6",desc:"You can drag the item to the page or to the tree.",text:"draggable"}))),u+='<li draggable class="project-item '+(s.isFile?"file":"folder ")+i+'" data-path="'+n+'" data-file-name="'+s.name+'" data-url="'+s.url+'">'+o+'<name class="'+a+'">'+s.name+"<tags>"+y(s)+"</tags></name>",s.children.length&&(u+="<ul>",c(s,n),u+="</ul>"),u+="</li>")}}var e,t,r,i,s,l,a,u,p,d;(j=h)?(b.show(),_.show(),j.sortItems(),e=null,t=($currentContainer=_).find(">.header").html(""),t=$("<input/>",{class:"form-control filter-form",placeholder:"search"}).appendTo(t),crsaAddCancelSearch(t,"top: 16px;right: 46px;"),_.html(""),r=$("<ul/>").appendTo(_),i=null,g.on("crsa-page-selected.project",function(e,t){var r;t=t,i&&(r=f.find$liForUrl(i.url))&&r.removeClass("selected-page"),(i=t)&&(r=f.find$liForUrl(t.url))&&r.addClass("selected-page")}),s={on_project_menu:[],on_project_item_get_tags:[],on_project_item_get_context_menu:[],on_project_item_preview:[]},$.each(pinegrow.getFrameworks(),function(e,r){$.each(s,function(e,t){e in r&&r[e]&&t.push(r[e])})}),l=_,r.html(""),_.find(">h2").remove(),a=$('<h2 class="project-name" style="display:inline-block;"></h2>').prependTo(_),a.html(j.name+'&nbsp;<i class="icon icon-down" style="position:relative;top:3px;"></i>'),a.on("click contextmenu",function(e){e.preventDefault(),e.stopPropagation();var t=o("on_project_menu",j);t.length&&n(t,e,$(this))}),isApp()?addTooltip(a,`<code>${j.getDir()}</code><br>Click for project options.`):addTooltip(a,`Click for project options.`),$(`<div class="pg-project-urls"><h4>Remote URLs <i class="help icon icon-271" title="Learn about editing remote projects..."></i></h4><div class="pg-project-urls-list"></div><h4 style="margin-top:20px;">Local files</h4></div>`).appendTo(_),(e=t.val())&&0<e.length&&new RegExp(escapeRegExp(e),"i"),u="",p=["image","css","script"],d={},isApp()||(d["_pginfo"]=!0,d["pinegrow.json"]=!0,d["projectdb.pgml"]=!0),c(j.root,""),r.html(u),r.on("contextmenu.project","li.project-item name, li.project-item i.folder-icon",function(e){e.stopPropagation(),e.preventDefault();var t=$(this).closest("li"),t=w(t.attr("data-path")),r=o("on_project_item_get_context_menu",t,j);return pinegrow.dispatchEvent("on_project_item_get_context_menu_regular",null,t,j,r),r.length&&n(r,e,$(this)),!1}),r.on("click.project","li.project-item name, li.project-item i.folder-icon",function(e){var t=$(this),r=(e.preventDefault(),t.closest("li")),n=w(r.attr("data-path"));if(n)if(n.isFile)if(n.isEditable){var o=pinegrow.findFrameworkByKey("pg.components"),i=null;if(i=o?o.pgcGetPartialOpeningOptions(n.url,null,n.name):i)return i.unshift({type:"header",label:"Open"}),new CrsaContextMenu(i,r).showForElement(r),!1;o=pgGetOpenPartialInContainerInfo(n.path),0&&o&&o.auto_open?(new pgOpenPartialInContainer(n.url),pinegrow.stats.using("prj.openpartial")):((i=!e.ctrlKey&&!e.metaKey)&&pinegrow.pageTabs.hideAll(),(o=pinegrow.getRemoteUrlFromMappedUrl(n.url))?(pinegrow.openOrShowPage(o),pinegrow.showQuickMessage("Opening the saved remote file as URL...")):pinegrow.openOrShowPage(n.url,function(e){},i,!0),pinegrow.stats.using("prj.openfile"))}else pinegrow.openFileInCodeEditor(n.path)&&"css"!=n.getSimpleType()&&pinegrow.showQuickMessage("This file can be only opened in code editor.");else n.isFile||(o=(r=t.closest("li")).find("> .folder-icon"),r.hasClass("folder-closed")?(r.removeClass("folder-closed"),o.removeClass("icon-right").addClass("icon-down"),m[n.url]=!0):(r.addClass("folder-closed"),o.removeClass("icon-down").addClass("icon-right"),m[n.url]=!1))}),r.on("mouseenter.project","li.project-item name, li.project-item i.folder-icon",function(e){var t=$(this),t=(e.preventDefault(),t.closest("li")),r=w(t.attr("data-path")),n=o("on_project_item_preview",r);n.length&&(r=$(n[0].code)).length&&t.get(0).ownerDocument.defaultView===window&&(pgPreview.show(t,r,r.is("img")?"with-image":null,null),n[0].onLoaded)&&r.one("load",function(e){var t=n[0].onLoaded(this);pgPreview.setDescription(t)})}),r.on("mouseleave.project","li.project-item name, li.project-item i.folder-icon",function(e){pgPreview.hide()})):(v(),_.hide())})},this.show(),this.close=function(e){this.show(null)},this.find$liForUrl=function(e){var t=_[0].querySelector('li[data-url="'+e+'"]');return t?$(t):null},function(e){for(var t,r,n="",o=0;o<e.tags.length;o++)"show"in e.tags[o]&&!e.tags[o].show||(t="tag-type-"+(e.tags[o].type||"info"),e.tags[o].class&&(t+=" "+e.tags[o].class),r=e.tags[o].icon?'<i class="icon-'+e.tags[o].icon+'"></i>':e.tags[o].text,n+='<tag class="'+t+'"'+(e.tags[o].desc?' title="'+e.tags[o].desc+'"':"")+">"+r+"</tag>");return n}),F=(this.updateTagsForFile=function(e,t){(t=t||this.find$liForUrl(e.url))&&t.find(">name tags").html(y(e))},null),k=new PgDragHelper(_,".project-item.file",null,!0);k.onBefore=function(e){var t;return!!pgf.edit_html&&(t=e.closest("li"),t=w(t.attr("data-path")).getSimpleType(),0<=["image","css","script"].indexOf(t))},k.on("dragStart",function(e,t,r){$.fn.crsapages("showOverlays");var n=k.dragTarget.closest("li"),o=w(n.attr("data-path")),i=o.getSimpleType(),a={name:"Element",parent_selector:null},l=null,s=null,c=null,u=null,p=null,d=null;switch(i){case"image":var h=o.url,g='<img src="'+h+'" />',l=pgCreate(g);a.name="Image "+o.name,s=function(){var e;return this.positionPgel&&(e=this.positionPgel.getPage(),l.setAttribute("src",e.makeRelativeUrl(h))),!1};break;case"script":case"css":g="css"===i?`<link rel="stylesheet" href="${o.url}">`:`<script src="${o.url}"></script>`;l=pgCreate(g),a.name=o.name,a.parent_selector="html",c="Add to the page",u="top",p={disableClone:!0,disableGrid:!0,disableRepeater:!0,disableDisableParentSelector:!0,disableText:!0},s=function(){var e;return"page"===this.getOver()&&(this.positionPgel&&(e=this.positionPgel.getPage(),pinegrow.makeChanges(e,"Add "+o.name,function(){"css"===i?e.addStylesheet(o.url,!0,function(){})?pinegrow.showQuickMessage(`<b>${o.name}</b> was added to <b>${e.name}</b>.`):pinegrow.showQuickError(`<b>${o.name}</b> is already included on <b>${e.name}</b>.`):"script"===i&&(e.addScript(o.url,!0)?pinegrow.showQuickMessage(`<b>${o.name}</b> was added to the footer of <b>${e.name}</b>. Refresh the page view to re-run the Javascript code.`):pinegrow.showQuickError(`<b>${o.name}</b> is already included on <b>${e.name}</b>.`))})),!0)},d=function(e){var r=!1;e.forEachElement(function(e){var t="css"===i?"href":"src";r=e.getPage(),e.setAttribute(t,r.makeRelativeUrl(o.url))})}}l&&((F=new PgDragMenu(a,!1,!0,a.parent_selector,null,p)).formatHtml=!0,F.onInsert=s,F.onInsertedElements=d,F.parentSelector=a.parent_selector,F.forcePositionLabel=c,F.forcePosition=u,F.pgel=l,F.handleMoveEvent(r,F))},this),k.on("drag",function(e,t,r){F&&F.handleMoveEvent(r,F)},this),k.on("dragStop",async function(e,t){$.fn.crsapages("showOverlays",!0),F&&(await F.insertAsync(),F.destroy(),F=null,crsaFuncs.setDraggedMenu(null),crsaFuncs.showInsertionLine(null),pinegrow.highlightElement(null))},this),pinegrow.addEventHandler("on_page_selected",function(e){j||v()}),pinegrow.addEventHandler("on_page_saved",function(e,t,r){j&&r&&pinegrow.refreshCurrentProject()}),pinegrow.addEventHandler("on_project_remote_urls_updated",function(e){})};class PgProjectBlobManager{constructor(){this.blob_to_content_map=[]}makeURL(e){var t=URL.createObjectURL(e);return this.blob_to_content_map[t]=e,t}hasContent(e){return e in this.blob_to_content_map}async getContent(e){return this.blob_to_content_map[e].arrayBuffer()}destroy(){$.each(this.blob_to_content_map,function(e,t){URL.revokeObjectURL(e)}),this.blob_to_content_map={}}}var CrsaProject=function(){this.name="",this.root=null,this.localPath=null,this.url=null,this.entityMap={},this.frameworks=[],this.db=null,this.block_untrusted_js=pgf.block_untrusted_js;function s(e){!(e=e||!1)&&0!==Object.keys(t).length||(t={},v.root.walkThroughFiles(function(e){t[e.name]||(t[e.name]=[]),t[e.name].push(e)}))}function n(i,a){var l,o,s,r,n,c;pinegrow.getCurrentProject()&&(l=function(e,t,r){var n=new RegExp(`^(${pgParserEscapeRegExp(t)})($|\\/)`);return e.replace(n,r+"$2")},m={},v.walkThroughFiles(function(e,t){var r;t&&(r=v.getRelativeUrl(e.url),e.url=t.url+"/"+e.name,e.path=t.path+"/"+e.name,m[e.url]=e,v.getRelativeUrl(e.url)!==r)&&(e.renamedFromOriginalUrl=r)}),i&&(o=[],s=v.getProjectInfo(),pinegrow.getAllPages().forEach(function(e){var t,r,n=l(e.url,i,a);n!==e.url&&((t=v.getRelativeUrl(n))!==(r=v.getRelativeUrl(e.url))&&(s.renameSettingsForUrl(r,t),s.renameSettingsForFile(r,t),o.push(e),e.renamedFromOriginalUrl=r),e.rename(n))}),o.length&&($.fn.crsapages("updateFilesName"),o.forEach(function(e){e.view.updateTitle(e.tab_name)}),s.save()),pinegrow.getStylesheets().forEach(function(e){var r,n,t,o;e.url&&(r=l(e.url,i,a),n=e.url,r!==n)&&(t=v.getRelativeUrl(r),o=v.getRelativeUrl(e.url),e.setUrl(r),t!==o&&(e.renamedFromOriginalUrl=o),pinegrow.getAllPages().forEach(function(e){e.getPageViews().forEach(function(e){var t=e.get$Html().find(`style[data-pg-style-url="${n}"]`);t.length&&t.attr("data-pg-style-url",r)})}))})),r=v.getRelativeUrl(i),n=v.getRelativeUrl(a),r!==n)&&(c={},$.each(u,function(e,t){c[l(e,r,n)]=t}),u=c,c={},$.each(p,function(e,t){c[e]=l(t,r,n)}),p=c)}var w={},v=(this.path_separator=require("path").sep,this),m={},t={},e=0,r=0,o=(this.blobs=new PgProjectBlobManager,this.wasChanged=function(){e++},this.hasUnsavedChanges=function(){return r<e},this.getRevision=function(){return e},this.revisionWasSaved=function(e){r=e},this.forgetUnsavedChanges=function(){e=r},this.isTutorialLesson=function(){return!(this.lesson&&this.lesson.tutorial&&this.lesson.tutorial.startProjects||!this.lesson)},this.getSettingsForNewFileDialog=function(){this.master_page=!0,this.show_only_master_pages=!0;var t=this.getProjectInfo().getSetting("template_framework_id"),e=(0<(e=pinegrow.projectTemplates.filter(function(e){return e.framework.type==t})).length?e:pinegrow.projectTemplates)[0],r=[this];if(!pinegrow.isContributorMode())for(var r=r.concat(pinegrow.projectTemplates),n=0;n<r.length;n++)if(r[n].show_only_master_pages&&!$.isEmptyObject(this.framework.master_pages)){e=r[n];break}return{projects:r,selected:e}},this.createFromMasterPage=function(n,o,i,e){var a=this;e||i.master_page||(e=o.name),pinegrow.showPrompt("Name of the new page","New page",e,"Page name",null,function(e){if(e.length){e=escapeHtmlCode(e);crsaGetExtFromUrl(e)||(e+=".html");var t=crsaCombineCurrentUrlWith(n,e);if(a.getFileForUrl(t))e&&pinegrow.showAlert("The page <b>"+e+"</b> already exists. Please choose a different name.","File with Same Name Found",null,"Ok",null,function(){v.createFromMasterPage(n,o,i,e)});else try{var r=crsaMakeFileFromUrl(t);o.copyFileToNewPath(r,function(t){var e=a.getProjectInfo(),r=e.getSettingsForFile(o.path);r&&r.frameworks&&(e.setSettingForFile(t.path,"frameworks",r.frameworks),e.save()),pinegrow.openPage(t.url,function(e){var t;i==a?(e.crsaProjectTemplate=a,(t=pinegrow.findFrameworkByKey("pg.components")).useMasterPage(e,a,o,!0),t.updateEditableAreas(e)):e.crsaProjectTemplate=i,e.pageIsRemoteTemplate=crsaIsRemoteUrl(o.url)||i.framework.page_is_remote_template||!1,e.source_framework=i.framework,e.pageIsRemoteTemplate&&(e.remote_template_url=o.url),e.detectAndAddFrameworks(function(){e.save(function(){pinegrow.refreshCurrentProject(function(){setTimeout(function(){e.refresh()},50)})},!0,!1,!1,!0,!0)})},!0,null,{on_source_parsed:function(e){o.remove_components&&e.sourceNode.withoutEvents(function(){e.sourceNode.removeAttrIfStartsWith("data-pgc",!0)}),o.remove_local_links&&e.sourceNode.withoutEvents(function(){e.sourceNode.goThroughAllUrls(function(e,t){return"href"===t&&e.endsWith(".html")&&!crsaIsAbsoluteUrl(e)?"#":e})}),pinegrow.copyMissingExternalFiles(e,o.url,t.url,i.master_page&&i===a?o.url:a.getAbsoluteUrl("index.html"))}})})}catch(e){pinegrow.showAlert(e,"Error")}}else pinegrow.showAlert("The page name should not be blank.","The page needs a name",null,"Ok",null,function(){v.createFromMasterPage(n,o,i,"")})})},this.addBackgroundPage=function(e){(w[e.url]=e).isBackgroundPage=!0},this.getBackgroundPageForUrl=function(e){return w[e]||null},this.removeBackgroundPageForUrl=function(e){e in w&&(w[e].isBackgroundPage=!1,delete w[e])},this.getAllBackgroundPages=function(){return Object.keys(w).map(function(e){return w[e]})},this.closeAllBackgroundPages=function(){this.getAllBackgroundPages().forEach(function(e){e.codeEditor&&(e.codeEditor.closeTab(),e.codeEditor=null),v.removeBackgroundPageForUrl(e.url)})},this.destroy=function(){this.closeAllBackgroundPages(),this.db&&this.db.destroy(),this.blobs.destroy()},this.getFilesWithName=function(t){var r=[];return this.root.walkThroughFiles(function(e){e.name===t&&r.push(e)}),r},this.getFile=function(e){for(var t=e.split("/"),r=this.root,n=0;n<t.length;n++){var o=t[n];if(0!==o.length){for(var i=!1,a=0;a<r.children.length;a++){var l=r.children[a];if(l.name===o){if(n===t.length-1)return l;r=l,i=!0;break}}if(!i)return null}}return null},this.toJSON=function(){var e={};return e.name=this.name,e.root=this.root,e.localPath=this.localPath,e.url=this.url,JSON.stringify(e)},this.getDocuments=function(){var r=[];return $.each(this.root.children,function(e,t){t.name.match(/\.html$/i)&&r.push(t)}),r},this.fromSimpleTemplate=function(e){this.url=e.url,this.name=e.name,this.description=e.description||null,this.author=e.author||null,this.author_link=e.author_link||null,this.info_badge=e.info_badge||null,this.templateBrowserIndex=e.templateBrowserIndex||null,this.not_popular=e.not_popular||!1,e.frameworks&&(this.frameworks=e.frameworks),this.root=new CrsaFile,this.root.isFile=!1,this.root.name=e.name,this.root.url=e.url;var i=crsaGetAppDir(),a=(this.root.path=i+crsaMakeFileFromUrl(e.url),isApp()?require("path").sep:"/"),l=(e.url&&crsaIsFileUrl(e.url)&&((i=crsaMakeFileFromUrl(e.url)).endsWith(a)||(i+=a),this.root.path=i),function(e,n,o){$.each(e,function(e,t){var r;t.children?((r=new CrsaFile).name=t.src,r.isFile=!1,r.url=o+r.name,t.tag&&(r.tag=t.tag),t.required&&(r.required=!0),i&&(r.path=n.path+r.name+a),n.addChild(r),l(t.children,r,r.url+a)):((r=new CrsaFile).name=t.name||t.src,r.desc_name=t.desc_name||null,r.isFile=!0,r.url=t.url||o+r.name,i&&(r.path=n.path+r.name),r.tag=t.tag||"page",t.required&&(r.required=!0),r.image=t.image?o+t.image:o+"screenshots"+a+r.name.replace("html","jpg"),r.image_direct=t.image_direct||null,r.template_data=t,r.video=t.video||null,r.description=t.description||null,r.subpages=t.subpages||null,r.remove_components=t.remove_components||!1,r.remove_local_links=t.remove_local_links||!1,n.addChild(r))})});l(e.pages,v.root,e.url),s(!0)},this.openProjectBySelectingFolder=function(r){crsaChooseFile(function(e,t){v.fromFolder(t,r,!0)},!1,!1,null,!0)},this.reload=function(e,t){isApp()?this.fromFolder(this.getDir(),e,this.show_pg_files||t||!1):e&&e()},this.reloadAsync=function(t){const r=this;return new Promise(function(e){r.reload(e,t)})},this.fromFolder=function(e,t,n,u){this.url=crsaMakeUrlFromFile(e),this.name=this.name||decodeURIComponent(crsaGetNameFromUrl(this.url)),this.show_pg_files=n,this.root=new CrsaFile,this.root.isFile=!1,this.root.name=this.name,this.root.url=this.url,this.file_count=0,this.file_size_count=0,this.too_many_files=!1;this.root.path=e;var p=require("fs"),d=require("path"),h=d.sep,r=(m={},[]),o=pinegrow.getSetting("ignore-folders","node_modules");try{for(var r=o.split(","),i=0;i<r.length;i++)r[i]=$.trim(r[i])}catch(e){}var g=function(e){return 0<=r.indexOf(e)},f=function(l,r,s){var c=[];p.readdir(r,function(e,t){var a;return e?(console.log("Error reading folder "+r,e),s(e)):(a=t.length)?void t.forEach(function(o){if("."==o.charAt(0)||g(o)||!n&&("_pgbackup"==o||"pinegrow.json"==o||"_pgexport"==o))return--a||s(null,c),!0;var i=d.resolve(r,o);p.stat(i,function(e,t){var r,n;v.file_count++,t&&t.size&&(v.file_size_count+=t.size),u&&(1e3<v.file_count||v.file_size_count>1024*1024*100)?(v.too_many_files=!0,--a||s(null,c)):t&&t.isDirectory()?((r=new CrsaFile).name=o,r.isFile=!1,r.url=l.url+"/"+encodeURIComponent(r.name),r.path=i+h,l.addChild(r),n=r.url,is_windows&&(n=n.toLocaleLowerCase()),m[n]=r,f(r,i,function(e,t){c=c.concat(t),--a||s(null,c)})):((r=new CrsaFile).name=o,r.isFile=!0,r.url=l.url+"/"+encodeURIComponent(r.name),r.path=i,r.isEditable=pinegrow.isFileEditable(i),l.addChild(r),n=r.url,is_windows&&(n=n.toLocaleLowerCase()),m[n]=r,c.push(i),--a||s(null,c))})}):s(null,c)})};f(v.root,e,function(e){s(!0),pgf.project_db&&v.requireDB(),t(v)})},this.addFile=function(e,t){var n="/",r=e.split(n),o=r.pop(),i=new CrsaFile,a=(i.name=o,i.isFile=!0,i.url=v.root.url+n+e,i.path=i.url,i.isEditable=pinegrow.isFileEditable(o),i.content=t,v.root);r.forEach(function(e){var t,r=a.url+n+e;m[r]||((t=new CrsaFile).name=e,t.isFile=!1,t.url=r,t.path=r,a.addChild(t),m[r]=t),a=m[r]}),a.addChild(i),m[i.url]=i},this.setUrl=function(e){var t=this.url;this.url=e,this.root.url=this.url,this.root.path=this.loaded_from_backend?e:crsaMakeFileFromUrl(e),n(t,e)},this.renameProjectFileUrl=function(e,t){this.loaded_from_backend||console.error("Only for projects loaded from backend.");var r=this.getFileForUrl(e);r&&(r.name,r.name=t,r.path=r.parent.path+"/"+r.name,r.url=r.parent.url+"/"+r.name,n(e,r.url))},this.fromServer=function(e,t,r,n){this.url=e,this.name=decodeURIComponent(crsaGetNameFromUrl(e)),this.root=new CrsaFile,this.root.isFile=!1,this.root.name=this.name,this.root.url=this.url;var o=this.url,i=(this.root.path=o,this.loaded_from_backend=!0,m={},this.addFile,function(){v.lesson||v.sortItems(),v.db&&v.db.load(v),c(),t(v)});pinegrow.dispatchEvent("on_before_load_project_from_server",null,this,function(){s(!0),pgf.project_db&&v.requireDB(),v.lesson&&v.lesson.tutorial.startProjects?i():pinegrow.backend?pinegrow.backend.loadProject(v,function(){i()},r,null,n):t(v)})},this.requireDB=function(e,t){return this.db?this.db.isInitialized()||this.db.create():(this.db=new PgProjectDB(this),this.db.init(t)),e&&e(this.db),this.db},this.walkThroughFiles=function(e,t,r){var n=e(t=t||this.root,r);if(!1!==n)for(var o=0;o<t.children.length;o++)this.walkThroughFiles(e,t.children[o],t)},{}),i=(this.storeTags=function(){o={},this.walkThroughFiles(function(e){o[e.url]={tag:e.tag,tags:e.tags}})},this.restoreTags=function(){this.walkThroughFiles(function(e){var t=o[e.url]||null;t&&(e.tag=t.tag,e.tags=t.tags.slice(0))})},this.setVersionForUrl=function(e,t){var r=this.getFileForUrl(e);r&&(r.version=t)},this.getVersionForUrl=function(e){var t=this.getFileForUrl(e);return t&&t.version?t.version:0},this.getContentOfUrlWithLookup=function(e){e=this.getRelativeUrl(this.getRelativeUrlFromInternalUrl(e));var t=this.url+"/"+e;if("css"===pinegrow.getSimpleMimeType(e)){var r=pinegrow.stylesheets.findCrsaStylesheetForUrl(t,!1,!0),r=0<r.length?r[0]:null;if(r&&r.loaded){var n=null;if(r.sourceBeingCurrentlyParsed?n=r.sourceBeingCurrentlyParsed:r.getCssSource(function(e){n=e=e||""},!1),null!==n)return n}}r=pinegrow.getCrsaPageByUrl(t);return(r=r||this.getBackgroundPageForUrl(t))?r.getSource():this.getContentOfUrl(e)},this.getContentOfUrl=function(e,t){if(e=this.getRelativeUrl(this.getRelativeUrlFromInternalUrl(e)),!crsaIsAbsoluteUrl(e)){if(this.loaded_from_backend)return r=this.getFileForUrl(this.url+"/"+e),t&&t(r?r.content:""),r?r.content:null;var r=require("fs"),n=null;try{n=r.readFileSync(this.getAbsolutePath(e),{encoding:"utf8"})}catch(e){}return t&&t(n),n}t&&t("Remote file "+e)},this.hasContentForUrl=function(e){var t;return e=this.getRelativeUrl(this.getRelativeUrlFromInternalUrl(e)),this.loaded_from_backend?!(!(t=this.getFileForUrl(this.url+"/"+e))||void 0===t.content||null===t.content):require("fs").existsSync(this.getAbsolutePath(e))},this.getViewCodeForSave=function(e,n){e=this.getAbsoluteUrl(e);function t(e){e.withoutEvents(function(){e.goThroughAllUrls(function(e,t,r){return n?n(e,t,r):v.mapSourceUrlToDOMUrl(e)}),e.walkSelfAndChildren(function(e){var t,r;return e.isElement&&(t=e.getAttribute("style"))&&(r=pgAddProxyLinksToStyleAttribute(t))!==t&&e.setAttribute("style",r),!0})})}var r=pinegrow.getCrsaPageByUrl(e),o="1"==pinegrow.getSetting("keep-collapsed","0");if(r)return t(a=r.sourceNode.clone(!0)),a.toStringForCodeEditorOrSave(r,!0,o,!0);var i,a=pinegrow.stylesheets.findCrsaStylesheetForUrl(e,!1,!0),r=0<a.length?a[0]:null;if(r&&r.loaded)return r.getCssSource(function(e){e=e||"",i=pgAddProxyLinksToStyleAttribute(e)},!1),i;var l=this.getFileForUrl(e);if(l.content)switch(l.getSimpleType()){case"html":var s=new pgParser;return s.assignIds=!1,s.parse(l.content),s.rootNode?(t(s.rootNode),s.rootNode.toStringForCodeEditorOrSave(null,!0,o,!0)):null;case"css":return pgAddProxyLinksToStyleAttribute(l.content);default:return null}return null},this.getAllImageFiles=async function(){const e=this;return new Promise(function(t,r){var n;isApp()?(n=[],e.walkThroughFiles(function(e){if(e.name.startsWith("_pg"))return!1;"image"===pinegrow.getSimpleMimeType(e.name)&&n.push(e)}),t(n)):pinegrow.backend.getImages({term:null,page:1,per_page:1e3,project_id:pinegrow.backend.getProjectId(e)},function(e){t(e.results)},function(e){r(e)})})},[]),a=(this.pageWasOpenedOrClosed=function(e,t){var r,n;pinegrow.appIsShuttingDown||(n=this.getRelativeUrl(e.url),r=i.indexOf(n),t?r<0&&i.push(n):0<=r&&i.splice(r,1),(n=pinegrow.getCurrentProjectInfo()).setSetting("open-pages",i),n.save())},this.getListOfOpenPages=function(){var e=pinegrow.getCurrentProjectInfo();return i=e.getSetting("open-pages")||[]},this.changed_setting_files=[],this.settingsFileIsChanged=function(e){this.changed_setting_files.indexOf(e)<0&&this.changed_setting_files.push(e),pinegrow.backend.saveDelayed()},this.setContentOfUrlWithLookup=function(e,t,r,n){e=this.getRelativeUrl(this.getRelativeUrlFromInternalUrl(e));var o=this.url+"/"+e,i=pinegrow.getCrsaPageByUrl(o);if(i=i||this.getBackgroundPageForUrl(o)){if(i.setCode(t,n),pinegrow.dispatchEvent("on_page_changes_done",i,{}),!r)return!0;i.lastSavedAt=(new Date).getTime()}if("css"===pinegrow.getSimpleMimeType(e)){var i=pinegrow.stylesheets.findCrsaStylesheetForUrl(o,!1,!0),a=0<i.length?i[0]:null;if(a&&a.loaded){if(a.setSource(t,function(){pinegrow.dispatchEvent("on_css_source_changed",null,{list:[a]})}),!r)return!0;a.lastSavedAt=(new Date).getTime()}}return this.setContentOfUrl(e,t)},this.setContentOfUrl=function(e,t,r){var n=!0;if(e=this.getRelativeUrl(this.getRelativeUrlFromInternalUrl(e)),crsaIsAbsoluteUrl(e))r&&r("Remote file "+e);else{if(!this.loaded_from_backend){var o=require("fs");try{crsaWriteFileWithBackup(o,this.getAbsolutePath(e),t,"utf8")}catch(e){}return r&&r(!0),!0}o=this.getFileForUrl(this.url+"/"+e);o?(o.content===t&&(n=!1),o.content=t):this.addFile(e,t),r&&r(n)}return n},this.setThumbnailOfUrl=function(e,t){e=this.getRelativeUrl(this.getRelativeUrlFromInternalUrl(e));var r=this.getFileForUrl(this.url+"/"+e);r&&(r.thumb=t)},this.getInternalUrl=function(e){return new URL(e,this.url+"/").toString()},this.getRelativeUrlFromInternalUrl=function(e){return e.replace(this.url+"/","")},this.findFilesByName=function(t){var r=[];return this.walkThroughFiles(function(e){e.name===t&&r.push(e)}),r},function(e){e.children.sort(function(e,t){return((e.isFile?"b":"a")+e.name).localeCompare((t.isFile?"b":"a")+t.name)});for(var t=0;t<e.children.length;t++)a(e.children[t])}),u=(this.sortItems=function(){a(this.root)},this.removeFileNodeFromList=function(e){delete m[e.url],e.walkThroughFiles(function(e){delete m[e.url]});var t=e.parent.children.indexOf(e);0<=t&&e.parent.children.splice(t,1)},this.getFileForUrl=function(e){return crsaIsAbsoluteUrl(e)||(e=this.url+"/"+e),is_windows&&(e=e.toLocaleLowerCase()),m[e]||null},this.closeProjectExplorer=function(e){pinegrow.projectView&&pinegrow.projectView.close()},this.showProjectExplorer=function(){pinegrow.projectView&&pinegrow.projectView.show(this)},this.copyRequiredFilesTo=function(e,i,a,l){var s,c,u=isApp(),p=(c=u?(s=require("fs"),require("path").sep):"/",function(e,o){$.each(e,function(e,t){if(!(t.required||i&&i(t)))return!0;var r=o+t.name,n=u?crsaIsFileOrDir(r,s):t.isFile&&a.fileExists(r);(n=n&&t.isFile&&!l&&a?!1:n)||(t.isFile?l||(a?a.copyFile(r,t.path):crsaCopyFileSync(s,t.path,r)):u&&s.mkdirSync(r)),t.children&&p(t.children,r+c)})});p(this.root.children,e=null===e?"":e)},this.copyRequiredFilesToZip=function(e,i){var a=0,l=function(e,n,o){$.each(e,function(e,t){if(!t.required)return!0;var r;t.isFile?(console.log("copy "+t.url+" to "+o),a++,$.ajax({url:t.url,data:null,dataType:"text"}).done(function(e){setTimeout(function(){n.file(t.name,e),0==--a&&i()},0)}).fail(function(){setTimeout(function(){a--,console.log("can not read "+t.url),0==a&&i()},0)})):(r=n.folder(t.name),t.children&&l(t.children,r,o+"/"+t.name))})};l(this.root.children,e,"/"),0==a&&i()},this.getDir=function(){return this.root.path},this.getUrl=function(){return this.root.url},this.getName=function(){return this.root.name},this.isFileInProject=function(e){return e.startsWith(this.getDir())},this.isUrlInProject=function(e){return e.startsWith(this.getUrl())},this.isPageInProject=function(e){return!!this.loaded_from_backend||e.localFile&&this.isFileInProject(e.localFile)},this.getProjectInfo=function(){return new pgProjectInfo(this.getDir())},this.getRelativeUrl=function(e){var t=e.replace(this.getUrl(),"");return t="/"===t[0]?t.substr(1,t.length):t},this.getRelativePath=function(e){return e.replace(this.getDir()+this.path_separator,"")},this.getAbsolutePath=function(e){return crsaIsFileUrl(e)?crsaMakeFileFromUrl(e):path.join(this.getDir(),e)},this.getAbsoluteUrl=function(e){if(crsaIsAbsoluteUrl(e))return e;e.startsWith("/")&&(e=e.substr(1));var t=this.getUrl();return t.endsWith("/")||(t+="/"),new URL(e,t).toString()},this.forEachOpenPage=function(e,t){if(!t||this.isPageInProject(t))for(var r=pinegrow.getAllPages(),n=0;n<r.length;n++)!this.isPageInProject(r[n])||t&&t==r[n]||e(r[n])},this.getEditableFiles=function(o,i){i=i||this;var a=[],l=function(e){if(e.isEditable&&a.push(e),!e.name.startsWith("_pg")){for(var t=[],r=0;r<e.children.length;r++){if(o){var n=i.getRelativeUrl(e.children[r].url);if(o[n])continue}e.children[r].isFile?l(e.children[r]):t.push(e.children[r])}t.forEach(function(e){l(e)})}};return l(this.root),a},this.getFilesWithContent=function(){var n=[],o=function(e){if("content"in e&&null!==e.content&&n.push(e),!e.name.startsWith("_pg")){for(var t=[],r=0;r<e.children.length;r++)e.children[r].isFile?o(e.children[r]):t.push(e.children[r]);t.forEach(function(e){o(e)})}};return o(this.root),n},this.getThumbnailForUrl=function(e){var t=this.getRelativeUrl(this.getRelativeUrlFromInternalUrl(e)),t=this.getFileForUrl(this.url+"/"+t);return t&&t.thumb||null},this.forEachEditableFile=function(r,n,a,o,e,i){a=a||"Processing files...";var l,s=[],c=[],u=this.getEditableFiles(e,this),p=function(){if(pinegrow.callGlobalFrameworkHandler("on_project_scan_end",v,o),h&&(clearTimeout(h),h=null),i)n&&n(s);else if(u?l.update("Done!",u.length,u.length):l.update("Done!",100,100),u=null,c.length){l.hide();for(var e='<table class="table table-striped table-condensed table-hover"><thead><tr><td>File</td><td>Messages</td></tr></thead><tbody>',t=0;t<c.length;t++){e+="<tr><td><b>"+v.getRelativePath(c[t].file.path)+"</b></td><td>";for(var r=0;r<c[t].status.errors.length;r++)e+='<p class="error">'+c[t].status.errors[r]+"</p>";for(r=0;r<c[t].status.warnings.length;r++)e+='<p class="warning">'+c[t].status.warnings[r]+"</p>";for(r=0;r<c[t].status.messages.length;r++)e+='<p class="message">'+c[t].status.messages[r]+"</p>";e+="</td></tr>"}e+="</tbody></table>",pinegrow.showAlert("<p>The following happened during processing:</p>"+e,"Status report",null,"OK",function(){n&&n(s)},function(){n&&n(s)})}else setTimeout(function(){l.hide()},500),n&&n(s)},d=0,h=null,g=function(){h&&clearTimeout(h),h=null,d=u?.length,p()},f=(pinegrow.callGlobalFrameworkHandler("on_project_scan_begin",this,o),function(){if(h=null,u&&d<u.length){var n=u[d];l&&l.update(n.name,d+1,u.length);try{var t,e=pinegrow.getCrsaPageForUrl(n.url);e.sourceNode?(t=new pgProjectItemIteratorStatus,r(e,function(e,t){t&&t.changed&&(e.openedInEditor?t.skip_refresh||e.refresh():w[e.url]=e,e.setPageChanged(!0,!0)),t.save&&e.save(null,!0),t&&(t.errors.length||t.warnings.length||t.messages.length)&&c.push({file:n,status:t}),d++;var r=(new Date).getTime();r-m<50?f():(m=r,h=setTimeout(f,1))},t,n),pinegrow.callGlobalFrameworkHandler("on_project_scan_page",v,e,o,n)):(d++,h=setTimeout(f,1)),0}catch(e){(t=new pgProjectItemIteratorStatus).errors.push(e.toString()),s.push({file:n,error:e.toString()}),(t.errors.length||t.warnings.length||t.messages.length)&&c.push({file:n,status:t}),d++,h=setTimeout(f,1),console.log("FOR EACH ERROR "+e)}}else p()}),m=(i||(l=new function(){var e=$('<div><p>index.html(90 of 100)</p>            <div class="progress">                <div class="progress-bar" style="width: 0%;">                </div>            </div></div>'),o=(e.find("h3"),e.find("p")),i=e.find(".progress-bar"),t=makeAndShowDialog(a,null,"Stop",e,function(){t=null},function(){t=null,g()});t.css("z-index",2e3),this.hide=function(){t&&(t.remove(),t=null)},this.update=function(e,t,r){var n=parseInt(100*t/r);i.attr("style","width:"+n+"%;"),o.html(e+" ("+t+" of "+r+")")}}),(new Date).getTime());f()},this.getFrameworks=function(){var e=[],t=new pgProjectInfo(this.getDir()).getSetting("frameworks");if(t)for(var r=0;r<t.length;r++){var n=pinegrow.findFrameworkByKey(t[r]);n&&e.push(n)}return e},this.updateTagsForFile=function(e,t){return pinegrow.projectView?pinegrow.projectView.updateTagsForFile(e,t):null},this.getRemoteUrls=function(){return this.getProjectInfo().getSetting("remote-urls")||[]},this.addRemoteUrl=function(e){var t=this.getProjectInfo(),r=t.getSetting("remote-urls")||[],n=r.indexOf(e);0<=n&&r.splice(n,1),r.unshift(e),t.setSetting("remote-urls",r),t.save(),pinegrow.dispatchEvent("on_project_remote_urls_updated",null,this)},this.removeRemoteUrl=function(e){var t=this.getProjectInfo(),r=t.getSetting("remote-urls")||[],n=r.indexOf(e);0<=n&&r.splice(n,1),t.setSetting("remote-urls",r),t.save(),pinegrow.dispatchEvent("on_project_remote_urls_updated",null,this)},{}),p={},l=function(e){return e.getMappedUrl()},c=function(){v.walkThroughFiles(function(e){var t=l(e);t&&v.addSourceUrlToDOMUrlMap(v.getRelativeUrl(e.url),t)})};this.mapSourceUrlToDOMUrl=function(e,t){return null===e?e:(void 0===t&&(t=e),u[e]||t)},this.mapDOMUrlToSourceUrl=function(e,t){return null===e?e:(void 0===t&&(t=e),p[e]||t)},this.addSourceUrlToDOMUrlMap=function(e,t){p[t]=e,u[e]=t},this.getMapForSourceToDOMUrls=function(){return u},this.isUrlMappedToDOMOrSource=function(e){return this.mapSourceUrlToDOMUrl(e,!1)||this.mapDOMUrlToSourceUrl(e,!1)},this.isSavedOnTheBackend=function(){return!!isAppForProject(this)||!this.isLoadedFromAnotherUser&&!this.isCreatedWithNewProject}},pgProjectItemIteratorStatus=function(){this.changed=!1,this.skip_refresh=!1,this.viewUpdated=!1,this.errors=[],this.warnings=[],this.messages=[]},pgProjectInfo=function(e,t){function o(e,t){return e=(e=e.replace(t,"")).startsWith("/")?e.replace("/",""):e}function r(e,t){return crsaIsAbsoluteUrl(e)?e:(e.startsWith("/")&&(e=e.replace("/","")),t.endsWith("/")||(t+="/"),t+e)}function n(e){var t,r;l?s.setContentOfUrl("pinegrow.json",JSON.stringify(e.data))&&s.settingsFileIsChanged("pinegrow.json"):e.file&&(t=require("fs"),r=JSON.stringify(e.data),crsaWriteFileWithBackup(t,e.file,r,"utf8"))}var i,a,l=!isApp(),s=pinegrow.getCurrentProject(),c=((l=s&&s.loaded_from_backend?!0:l)&&(e=s.getUrl()),require("path")),u=require("fs"),p=function(e,t){return e.replace(t+c.sep,"")},d=(this.was_just_created=!1,function(e,t){if(l)return(o=s.getContentOfUrl("pinegrow.json"))?{data:JSON.parse(o),file:e,project_dir:s.getUrl(),file_key:""}:null;if(e&&isApp())for(var r=crsaGetDir(e,c,u);r;){var n=c.join(r,"pinegrow.json");try{var o=u.readFileSync(n,{encoding:"utf8"});return{data:JSON.parse(o),file:n,project_dir:r,file_key:p(e,r)}}catch(e){}if(t)break;try{var i=c.join(r,"..");if(i==r)break;r=i}catch(e){break}}return null}(e,"dir"==crsaIsFileOrDir(e)||t));d||(d=!(t=e)||l?{file:t,project_dir:s?s.getUrl():null,data:{files:{}},file_key:null}:((a=pinegrow.getCurrentProject())&&a.isFileInProject(t)&&(i=c.join(a.getDir(),"pinegrow.json")),{file:i=c.join(crsaGetDir(t,c,u),"pinegrow.json"),project_dir:a=c.dirname(i),data:{files:{}},file_key:p(t,a)}),this.was_just_created=!0),this.save=function(){n(d)},this.saveDelayed=function(){delayed.run("save",function(){n(d)},1e3)},this.getSetting=function(e,t){return e in d.data?d.data[e]:t||null},this.setSetting=function(e,t){d.data[e]=t},this.getSettingsForFile=function(e){var t;return e&&(t=p(e,d.project_dir),d.data.files)&&d.data.files[t]?d.data.files[t]:null},this.getSettingForFile=function(e,t){var r;return e&&(r=p(e,d.project_dir),d.data.files)&&d.data.files[r]&&d.data.files[r][t]||null},this.setSettingForFile=function(e,t,r){if(!d)return null;var n=p(e,d.project_dir);d.data.files||(d.data.files={}),d.data.files[n]||(d.data.files[n]={}),d.data.files[n][t]=r},this.getSettingForUrl=function(e,t){var r;return e&&d&&d.project_dir&&(r=o(e,l?d.project_dir:crsaMakeUrlFromFile(d.project_dir)),d.data.urls)&&d.data.urls[r]&&t in d.data.urls[r]?d.data.urls[r][t]:null},this.renameSettingsForUrl=function(e,t){if(!d||!d.project_dir)return null;d.data.urls&&d.data.urls[e]&&(d.data.urls[t]=d.data.urls[e],delete d.data.urls[e])},this.renameSettingsForFile=function(e,t){if(!d||!d.project_dir)return null;d.data.urls&&d.data.files[e]&&(d.data.files[t]=d.data.files[e],delete d.data.files[e])},this.setSettingForUrl=function(e,t,r){if(!e||!d||!d.project_dir)return null;var n=o(e,l?d.project_dir:crsaMakeUrlFromFile(d.project_dir));d.data.urls||(d.data.urls={}),d.data.urls[n]||(d.data.urls[n]={}),d.data.urls[n][t]=r},this.getDir=function(){return d.project_dir},this.makeFileRelative=function(e){return d&&d.project_dir?p(e,d.project_dir):e},this.makeFileAbsolute=function(e){},this.getRelativeUrlFromFile=function(e){var t,r;return d&&d.project_dir?l?o(e,d.project_dir):(t=crsaMakeUrlFromFile(e),r=crsaMakeUrlFromFile(d.project_dir),o(t,r)):e},this.getFileFromRelativeUrl=function(e){var t;return d&&d.project_dir?(t=crsaMakeUrlFromFile(d.project_dir),r(e,t)):e},this.makeUrlRelative=function(e){var t;return d&&d.project_dir?(t=l?d.project_dir:crsaMakeUrlFromFile(d.project_dir),o(e,t)):e},this.makeUrlAbsolute=function(e){var t;return d&&d.project_dir?(t=l?d.project_dir:crsaMakeUrlFromFile(d.project_dir),r(e,t)):e},this.getSourceStylesheetForCSSStylesheet=function(e){return d.data.compiledStylesheet&&d.data.compiledStylesheet[e]?d.data.compiledStylesheet[e]:null},this.getDir=function(){return d.project_dir},this.saveFile=function(e,t){if(l)s.setContentOfUrl("_pginfo/"+e,t)&&s.settingsFileIsChanged("_pginfo/"+e);else{if(!d.file)return null;var r=c.join(this.getDir(),"_pginfo",e);crsaCreateDirs(c.dirname(r),u),u.writeFileSync(r,t,"string"==typeof t?{encoding:"utf8"}:{})}},this.loadFile=function(e){if(l)return s.getContentOfUrl("_pginfo/"+e);if(!d.file)return null;var t=c.join(this.getDir(),"_pginfo",e);try{return u.readFileSync(t,{encoding:"utf8"})}catch(e){return null}},this.deleteFile=function(e){if(d.file){var t=c.join(this.getDir(),"_pginfo",e);try{return u.unlinkSync(t)}catch(e){return null}}}};