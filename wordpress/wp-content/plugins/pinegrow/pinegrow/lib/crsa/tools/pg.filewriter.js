var CrsaOverwriteProtectionFileWriter=function(e,t){function o(e,t,i){var n;return!!a.overwrite_existing_files_without_asking||!s||!r.existsSync(e)||!!a.use_export_cache&&(n=d(e),!!p(n,e))}var r=require("fs"),l=require("path"),s=isApp(),c={},a=this,f=[],u={},h=(this.use_export_cache=s,this.skip_existing_files=!s,this.overwrite_existing_files_without_asking=!s,this.root_source=s?l.join(e,l.sep):"",this.root_dest=s&&t?l.join(t,l.sep):null,this.export_cache=s?l.join(this.root_source,"_pgexport"):null,this.on_before_file_written=null,this.on_should_write_file=null,this.getDestNameFromSource=function(e){var t;return e.indexOf(this.root_source)<0?null:(t=e.replace(this.root_source,""),s?l.join(this.root_dest,t):t)},function(e){if(!a.use_export_cache)return!1;var t=d(e),i=l.dirname(t);c[i]||(mkdirpsync(i),c[i]=!0),crsaCopyFileSync(r,e,t)}),d=(this.copyFileToCache=function(e){h(e)},function(e){var t=y(e);return l.join(a.export_cache,t)}),p=function(e,t,i){try{var n=r.readFileSync(e),o=i?"string"==typeof i?new Buffer(i,"utf8"):i:r.readFileSync(t);return 0===Buffer.compare(n,o)}catch(e){return!1}},_=function(e,t){var i;s&&(i=l.dirname(e),c[i]||(mkdirpsync(i),c[i]=!0)),a.on_before_file_written&&a.on_before_file_written(e,null,t),s?("string"==typeof t?r.writeFileSync(e,t,{encoding:"utf8"}):r.writeFileSync(e,t),h(e)):u[e]=t},g=function(e,t,i){var n;s&&(n=l.dirname(e),c[n]||(mkdirpsync(n),c[n]=!0)),s?(a.on_before_file_written&&a.on_before_file_written(e,t,null),crsaCopyFileSync(r,t,e,i),h(e)):(n=pinegrow.getCurrentProject().getContentOfUrlWithLookup(t),(n=i?i(n):n).startsWith("@mapurl:")||(a.on_before_file_written&&a.on_before_file_written(e,t,n),u[e]=n))},y=function(e){return e.replace(a.root_dest,"")};this.writeFile=function(e,t,i,n){this.on_should_write_file&&!1===this.on_should_write_file(e,t,n)||(o(e)?(_(e,t),i&&i(e,t)):f.push({file:e,content:t,done:i}))},this.copyFile=function(e,t,i,n){o(e)?(g(e,t,n),i&&i(e,null,t)):f.push({file:e,source:t,done:i,filter_func:n})};this.fileExists=function(e){return isApp()?r.existsSync(e):e in u},this.askIfNeeded=function(e){if(f.length&&!this.skip_existing_files){for(var t=$("<div><p>Do you want to overwrite the following files"+(this.root_dest?" in folder <b>"+this.root_dest+"</b>":"")+"?</p>"+(a.use_export_cache?"<p>It looks like these files were modified since you last exported them. Did you use a code editor to edit the files in the exported folder? <b>Exporting the files will overwrite any such changes.</b></p><p>Note, it is best to keep all project files in the source folder (including any custom files) and then export them to the target project. Never edit files directly in the export folder.</p>":"")+"</div>"),i=$('<table class="file-writer table table-striped table-condensed table-hover"><thead><tr><td><label><input type="checkbox" class="check-all" value="1" />&nbsp; Select all</label></td></tr></thead><tbody></tbody></table>').appendTo(t),n=i.find("tbody"),o=i.find("input.check-all"),r=0;r<1;r++)for(var l=0;l<f.length;l++){var s=y(f[l].file);$('<tr data-index="'+l+'"><td><label><input type="checkbox" value="1" />&nbsp;'+s+"</label></td></tr>").appendTo(n)}makeModalDialog("Confirm file overwrite","Cancel","Save selected",t,function(){e&&e(!0,[])},function(){var o=[];c.each(function(e,t){var i=$(t),n=i.closest("tr"),n=f[parseInt(n.attr("data-index"))];i.is(":checked")?(t=n).source?(g(t.file,t.source,t.filter_func||null),t.done&&t.done(t.file,null,t.source)):(_(t.file,t.content),t.done&&t.done(t.file,t.content)):o.push(n)}),e&&e(!1,o)});var c=n.find('input[type="checkbox"]');c.on("change",function(e){var t=$(e.delegateTarget).closest("tr");f[parseInt(t.attr("data-index"))]}),o.on("change",function(e){o.is(":checked")?c.prop("checked",!0):c.prop("checked",!1)})}else e&&e(!1,[])},this.debugFiles=function(){console.log("Exported files:"),$.each(u,function(e,t){console.log("---- "+e+": "+(t&&"string"==typeof t?crsaGetSummaryStr(t,40,!0).replace(/[\n\r]/g," "):""))})},this.getFiles=function(){return u},this.setFile=function(e,t){u[e]=t}};