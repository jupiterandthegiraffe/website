var CrsaClassManager=function(p){function t(){$(".crsa-cm-props").html(""),g.showListPanel(!1)}var g=this,o=null,f=null,e=$("body"),s=$("<div/>",{class:"crsa-cm-main clearfix"}).appendTo(p),n=$("<div/>",{class:"crsa-cm-rules"}).appendTo(s),a=($("<div/>",{class:"crsa-cm-props"}).appendTo(s),null),l=null,r=null,c=[],i=!1,d=!1,u=null,h=null,v=null,m=$('<i class="fa fa-fw fa-eye crsa-cm-enable"></i><i class="fa fa-trash-o crsa-cm-remove"></i><i class="fa fa-code crsa-cm-code"></i><i class="fa fa-bars crsa-cm-move"></i>'),y=$('<div class="crsa-css-var-header"></div').appendTo(n),w=$('<div class="cm-filter-container"></div>').appendTo(n),C=$("<ul/>",{class:"crsa-cm-list"}).appendTo(n),S=(new CrsaSelectBox(C,{itemClass:"crsa-node",overParentClassName:"crsa-stylesheet",selectorToFindChild:"> .rule-list > ul > li.crsa-node",isAllowed:function(e){return!e.hasClass("cm-sslist-addrule")&&!e.is("i")},isDraggableElm:function(e){return!!e.is(".crsa-cm-move")}}),this.refresh=function(){S(),T(),R(),H(),b()},this.setReferenceElement=function(e,t){f=e,t||H(),l&&(f?l.show():l.hide())},this.setShowOnlyClasses=function(e,t){t||this.refresh()},this.setSelectedPage=function(e,t){(r=e)&&r.get(0),t||this.refresh()},this.resizeRulesList=function(){b()},this.setSelectedPage($.fn.crsa("getSelectedPage"),!0),function(){var e=getCrsaPageForIframe(r);e&&N.find("span").html("Visible at "+e.deviceWidth+"px")}),b=function(){var s,e=p.find(".cm-sslist");p.find(".crsa-cm-list").css("top",e.height()+90+15+"px"),r&&(e=getCrsaPageStylesForPage(r))&&(s=function(e){function n(e){for(var t=0;t<e.length;t++){var s=e[t];s.stylePane.updateShownNodes(),0<s.importedFiles.length&&n(s.importedFiles)}}n(e.importedFiles)},$.each(e.getAllCrsaStylesheets(),function(e,t){if(t.ignore||!t.loaded)return!0;(t=t.sourceStylesheet?t.sourceStylesheet:t).stylePane&&t.stylePane.updateShownNodes(),s(t)}))},P=function(c,i,d){var e,u,h;i.getError()?showAlert(i.name+" has syntax errors. Fix the errors before adding new rules.","Notice"):(e=c.offset().left>$(window).width()/2?"left":"right",u=getUniqueId(),c.data("popover-active")?(c.popover("destroy"),c.data("popover-active",null)):(h=function(e){setTimeout(function(){e.closest(".popover").remove()},750)},c.popover({html:!0,placement:e,trigger:"manual",title:"Add new CSS rule",container:"body",content:'<form id="'+u+'"><div class="form-group"><input class="form-control" placeholder=".any-css-selector" style="margin-bottom:8px;"/><p class="help-block"></p></p><button class="ok btn">Create</button><button class="ok assign btn btn-link">Create & Assign class</button><button class="closeit btn btn-link">Cancel</button></div></form>'}).on("shown.bs.popover",function(){function t(t){var s=$.trim(e.val());s&&0!=s.length?$(t.delegateTarget).hasClass("assign")&&!getClassFromSelector(s)?(l.html(s+" is not a class selector. You can only assign classes (for example .BUTTON) to elements.").show(),n.addClass("has-error")):(s+=" {",i.insertRule(pinegrow.pgPostCSSHelper.getNodeFromText(s,null,"rule",i)),i.regenerateAndSetCssSource(function(){pinegrow.dispatchEvent("on_css_source_changed",null,{list:[i]});var e=i.getAllRules();(s=0<e.length?e[e.length-1]:null)&&($(t.delegateTarget).hasClass("assign")&&f&&s.selector&&!f.hasClass(s.selector)&&(p.trigger("crsa-cm-class-add",s.selector),H()),g.editRule(s))}),c.popover("hide"),h(n)):n.addClass("has-error")}var n=$("#"+u),e=n.find("input").focus(),s=(d&&e.val(d),n),o=n.find("button.ok"),a=n.find("button.assign").css("visibility","hidden"),l=n.find("p.help-block").hide(),r=n.find("button.closeit");e.on("input",function(){getClassFromSelector(e.val())?a.css("visibility","visible"):a.css("visibility","hidden")}),f||a.hide();s.on("submit",function(e){e.preventDefault(),t(e)}),o.on("click",function(e){e.preventDefault(),t(e)}),r.on("click",function(e){c.popover("hide"),e.preventDefault(),h(n)})}).on("hidden.bs.popover",function(){setTimeout(function(){c.popover("destroy").data("popover-active",null)},10)}),c.popover("show").data("popover-active",!0)))},T=function(){var e,n,t=new CrsaProfile(!0),s=C.scrollTop();C.html(""),t.show("clean"),c=[],r&&(e=getCrsaPageStylesForPage(r),(n=function(e){$.each(e,function(e,t){!function(t){if(t.ignore)return;c.push(t);var e,s=$("<li/>",{class:"crsa-stylesheet"}).appendTo(C).html('<div class="cs-head"><h3 class="crsa-cm-cs">'+t.name+"</h3></div>").data("cs",t),n=t.fileType,o=("css"!=n&&((e=$('<span class="cs-type">'+n+"</span>")).tooltip({container:"body",placement:"auto top",title:"This stylesheet uses "+n.toUpperCase()+" parser.",trigger:"hover"}),s.find("h3").append(e)),$("<a/>",{class:"cm-sslist-addrule",href:"#"}).html("+ Add rule").appendTo(s.find(">div"))),n=(o.on("click",function(e){return e.preventDefault(),P(o,t,a),!1}),t.getError());n&&(80<(e=n.extract?n.extract.join("\n"):"").length&&(e=e.substr(0,80)),n='<div class="cm-error">'+(""+(n.line?"Line "+n.line+", ":"")+n)+"<pre>"+e+"</pre></div>",$('<div class="alert alert-info">Stylesheet has one or more  '+t.fileType.toUpperCase()+" syntax errors (use <b>Page -&gt; Edit code</b> to fix it): "+n+"</div>").appendTo(s.find(">div"))),$("<div/>",{class:"cs-head-spacer"}).appendTo(s).html('<h3 class="crsa-cm-cs">'+t.name+"</h3>"),C=$("<div/>",{class:"rule-list"}).appendTo(s),t.stylePane&&(t.stylePane.remove(),t.stylePane=null),t.stylePane=new PgStylesPane(t,s),t.stylePane.filter=a,t.stylePane.show(),C=C.parent().closest("ul")}(t=t.compiledFile?t.sourceStylesheet:t);var s=t.importedFiles;0<s.length&&n(s)})})(e.getAllCrsaStylesheets()),t.show("paint css 1"),a?C.find("a.crsa-cm-move").hide():C.find("a.crsa-cm-move").show(),t.show("paint css 3"),o=C.find(".cs-head"),C.trigger("scroll"),C.scrollTop(s))},R=function(){$.fn.crsacss("showVariables")},n=(b(),$("body").on("crsa-window-changed",function(e,t){t==getCrsaPageForIframe(r)&&(S(),d)&&H()}),$("body").on("crsa-stylesheets-changed",function(){var e=new CrsaProfile(!0);e.show("updateStylesheetList"),T(),e.show("updateRules"),R(),e.show("updateRules"),H(),e.show("updateUsedClasses"),t(),e.show("closeAllPropertiyForms"),b()}),$("body").on("crsa-stylesheets-properties-changed",function(){t()}),$("<h2/>").html("CSS Rules").appendTo(y),$("<a/>",{href:"#",class:"crsa-show-var"}).html("Vars").appendTo(y)),x=("1"!=pinegrow.getSetting("use-less","1")&&n.hide(),$("<input/>",{class:"crsa-cm-input form-control filter-form",placeholder:"search"}).appendTo(w)),F=(crsaAddCancelSearch(x,"top: 6px;right: 10px;"),$('<label class="css-opt-label"><input class="control-label" type="checkbox" value="1">&nbsp;<span>Active</span></label>').appendTo(w)),N=$('<label class="css-opt-label"><input class="control-label" type="checkbox" value="1">&nbsp;<span>Visible</span></label>').appendTo(w),E=(F.find("> input").on("change",function(e){i=$(e.delegateTarget).is(":checked"),g.only_active_user_choice=i,H()}),F.tooltip({container:"body",placement:"top",title:"Show only active rules for the selected element.",trigger:"hover"}),this.setOnlyActive=function(e,t){void 0===t&&(t=!0),F.find(">input").prop("checked",e),i=e,t&&H()},N.find("> input").on("change",function(e){d=$(e.delegateTarget).is(":checked"),H()}),N.tooltip({container:"body",placement:"top",title:"Show only rules that match the current window size.",trigger:"hover"}),this.setFilter=function(e,t){void 0===t&&(t=!0),a=e,x.val(e),t&&(T(),H())},C.on("scroll",function(e){var r=C.scrollTop(),t=o,c=(C.height(),C.get(0).getBoundingClientRect());0!=c.width&&t.each(function(e,t){var s=$(t),n=s.next(),o=n.next(),a=s.hasClass("floating"),l=s.outerHeight()+8,o=o.get(0).getBoundingClientRect().top-c.top;a?l<o&&(s.removeClass("floating"),s.css("top","0px"),n.hide(),a=!1):o<l&&(s.addClass("floating"),a=!0,n.show()),a&&s.css("top",r+"px")})}),C.get(0).addEventListener("click",function(e){var t,s,n,o,a,l=!1,r=$(e.target);r.closest(".crsa-cm-code").length?(t=r.closest("li"),s=E(t),k(s),l=!0):r.closest(".crsa-cm-remove").length?(t=r.closest(".has-options"),s=E(t),(o=pinegrow.pgPostCSSHelper.getRootNodeFor(s).pgStylesheet).stylePane.removeNode(t),l=!0):r.closest(".crsa-cm-enable").length&&(o=(n=r.closest(".crsa-cm-enable")).closest(".crsa-stylesheet").data("cs"),a=!1,n.hasClass("fa-eye")&&(a=!0),o.stylePane.toggleCodeIgnoring(n,a,function(e){e&&(a?n.removeClass("fa-eye").addClass("fa-eye-slash"):n.removeClass("fa-eye-slash").addClass("fa-eye"))}),l=!0),l&&(e.preventDefault(),e.stopPropagation())},!0),C.get(0).addEventListener("contextmenu",function(e){var t=$(e.target);return t.closest(".has-options").length&&(t=t.closest(".has-options"),A(t,!1,e),e.stopPropagation()),e.preventDefault(),!1},!0),C.on("mouseenter",".has-options",function(e){var t=$(e.target).closest(".has-options"),s=$(m[0]),n=E(t),o=pinegrow.pgPostCSSHelper.getRootNodeFor(n).pgStylesheet;if(t.hasClass("crsa-rule")&&n&&n.selector)try{var a=$(getIframeBody(r.get(0))).parent().find(o.getRuleSelector(n));$.fn.crsa("highlightElement",a)}catch(e){}t.hasClass("has-options")&&(n&&(pinegrow.pgPostCSSHelper.isCommented(n)?s.removeClass("fa-eye").addClass("fa-eye-slash"):s.removeClass("fa-eye-slash").addClass("fa-eye")),t.find("> div").append(m))}),C.on("mouseleave",".has-options",function(e){$(e.target).closest(".has-options").hasClass("has-options")&&m.detach()}),C.on("mouseover",".crsa-cm-code",function(e){var t,s,n,o=$(e.target).closest(".has-options");o.hasClass("has-options")&&(t=E(o))&&(s=pinegrow.pgPostCSSHelper.getRootNodeFor(t).pgStylesheet,n=$("<div/>"),$("<pre/>").html(s.filterSource(s.getHtmlSourceForRule(t))).appendTo(n),$('<p>Click on <i class="fa fa-code"></i> to edit rule code.<br />Click on <span>.Selector</span> to edit rule properties.</p>').appendTo(n),$.fn.crsa("showPreview",o,n,"cm-preview",function(e){return getPreviewPosition(e,o.closest("#crsa-left-plane, .panel,.lm_content"))}))}),C.on("mouseout",".crsa-cm-code",function(e){$(e.target).closest(".has-options").hasClass("has-options")&&$.fn.crsa("hidePreview")}),s.parent().on("scroll",function(){h&&$(this).parent(0).scrollLeft(0)}),C.get(0).addEventListener("mousedown",function(e){u=$(e.target)}),C.get(0).addEventListener("dragstart",function(e){var t=$(e.target);u.is(".crsa-cm-move")&&(t.closest(".crsa-stylesheet").data("cs"),t.is(".crsa-node")&&(E(t),h=t),setTimeout(function(){h.css("opacity",.4).hide()},100),$.fn.crsa("hidePreview"))},!0),C.get(0).addEventListener("dragover",function(e){var t,s;u&&u.is(".crsa-cm-move")&&((t=$(e.target)).is(".crsa-cm-placeholder")?(s=t.closest(".crsa-atrule")).is(".crsa-atrule")&&t.index()==s.find("> div").children().length-1&&(e.offsetX<25?v.insertAfter(s):v.appendTo(s.find("> div"))):t.closest(".crsa-node").length&&(t=t.closest(".crsa-node")).get(0)!=h.get(0)&&(v=v||$('<div class="crsa-cm-placeholder"></div>'),s=t.height(),e.offsetY<s/2?(v.insertBefore(t),(s=t.prev()).length&&(s.is(".crsa-node")&&E(s))):(v.insertAfter(t),E(t))),e.preventDefault())},!0),C.get(0).addEventListener("dragleave",function(e){var t=$(e.target);t.closest(".crsa-cm-placeholder").length||t.closest(".crsa-node").length},!0),C.get(0).addEventListener("dragend",function(e){var t,s;u&&u.is(".crsa-cm-move")&&((t=$(e.target)).closest(".crsa-node").length&&(null!=v&&(t=t.closest(".crsa-stylesheet").data("cs"),v.prev(),s=v.closest(".crsa-stylesheet").data("cs"),t.stylePane.moveNodeFromTo(h,v,t!=s,s)),h)&&(h.css("opacity",1),h.show()),h=null,v&&v.remove(),v=null),u=null},!0),C.get(0).addEventListener("drop",function(e){$(e.target).closest(".crsa-node").length,e.stopPropagation()},!0),function(e,t){return e.attr("data-node-indices")?(t=t||e.closest("li.crsa-stylesheet").data("cs"),pinegrow.pgPostCSSHelper.getNodeByIndices(t.getRootNode(),e.attr("data-node-indices").split(","))):null}),A=function(t,e,s){var n,o,a,l=E(t),r=new CrsaContextMenu(null,t),c=(e||(l.selector&&r.add("Edit...",null,function(){g.editRule(l)}),r.add("Edit code...",null,function(){k(l)})),pinegrow.getSelectedElement());return l.classes&&(e||r.add("",null,null,"divider"),c?(r.add("Assign class to <b>"+c.getName()+"</b>",null,null,"header"),n=[],$.each(l.classes,function(e,t){var s;t=t.replace(".",""),c.hasClass(t)&&n.push(t),s=t,r.add("+ "+s,null,function(){p.trigger("crsa-cm-class-add",s)})}),o=(c.getAttr("class")||"").split(/\s+/),a=[],o&&$.each(o,function(e,t){n.indexOf(t)<0&&a.push(t)}),(0<n.length||0<a.length)&&(r.add("",null,null,"divider"),r.add("Remove class from <b>"+c.getName()+"</b>",null,null,"header"),$.each(n,function(e,t){var s;s=t,r.add("- "+s,null,function(){p.trigger("crsa-cm-class-remove",s)})}),$.each(a,function(e,t){var s;0!=t.indexOf("crsa-")&&(s=t,r.add("- "+s,null,function(){p.trigger("crsa-cm-class-remove",s)}))}))):r.add("Select element first, then assign class to it.",null,null,"header")),null!=l.nodes&&(r.add("",null,null,"divider"),r.add("Add rule inside...",null,function(){var e=pgStylesheetHelper.getStylesheetFromNode(l);e.stylePane.uncollapseLi(t),e.stylePane.addNewNodePlaceholderTo(t,"rule")}),r.add("Add rule after...",null,function(){pgStylesheetHelper.getStylesheetFromNode(l).stylePane.addNewNodePlaceholderAfter(t,"rule")}),r.add("Add rule before...",null,function(){pgStylesheetHelper.getStylesheetFromNode(l).stylePane.addNewNodePlaceholderBefore(t,"rule")})),r.showAt(s.pageX,s.pageY,t.closest(".crsa-cm-rules"))},k=function(s){function e(e,t){t&&t.list&&t.eventType&&"editor"==t.eventType&&"external_editor"==t.editor&&0<=t.list.indexOf(a)&&(pinegrow.showQuickMessage("Stylesheet was modified in external editor."),n.close())}var t=s,n=(pinegrow.addEventHandler("on_css_source_changed",e),showCodeEditor("text/css","Edit CSS rule code","edit-rule-code",function(){r(o.getDoc().getValue())},function(){$("body").trigger("crsa-stylesheets-changed",{list:[a]})},function(){try{pinegrow.pgPostCSSHelper.replaceNodeWith(s,t),a.forgetCachedSource(),a.setSourceForRules(pinegrow.pgPostCSSHelper.getRootNodeFor(s),function(){$("body").trigger("crsa-stylesheets-changed")})}catch(e){}pinegrow.removeEventHandler("on_css_source_changed",e)})),o=n.mirror,a=pinegrow.pgPostCSSHelper.getRootNodeFor(s).pgStylesheet,l=null,r=function(e){l&&clearTimeout(l),l=setTimeout(function(){a.updateNodeStylesheetWithSource(s,e,function(e){e&&(s=e);var t=a.getError();l=null,t?0:a.setChanged(!0),$("body").trigger("crsa-rule-changed-in-editor",{list:[a]})})},300)},c=a.getSourceForRules(s),c=a.filterSource(c,!0);o.getDoc().setValue(c),o.getDoc().clearHistory()},H=(this.editRule=function(e){$.fn.crsa("selectRule",e)},this.showListPanel=function(e){e?s.animate({left:0},150,function(){s.find("button.back").hide(),s.css("width",300)}):s.css("left",0)},this.reloadStylesheet=function(e,t){function s(){t&&t(),crsaQuickMessage(e.name+" reloaded."),$("body").trigger("crsa-stylesheets-changed")}e.changed?showAlert(e.name+" has unsaved changes. Do you want to reload the stylesheet and loose these changes?","Unsaved changes","Cancel","Reload",null,function(){e.reload(s)}):e.reload(s)},function(){var e=new CrsaProfile(!1),t=!1;if(f&&(t=(s=getElementPgNode(f))&&s.script_info),!f||t?(C.find(".crsa-cm-apply").hide(),C.find("div.crsa-cm-has-rule").removeClass("crsa-cm-has-rule")):C.find(".crsa-cm-apply").show(),e.show("    - 1"),r){var s=getCrsaPageForIframe(r);if(s){s.getWindow();if(d&&C.find(".crsa-atrule").removeClass("hide-rule"),e.show("    - 2"),f){t=f.get(0);if(t.ownerDocument.defaultView&&t.ownerDocument.defaultView.getMatchedCSSRules){var n=t.ownerDocument.defaultView.getMatchedCSSRules(t,"");if(n)for(var o=n.length;o--;)normalizeSelector(n[o].selectorText),!0}C.find(".crsa-stylesheet").each(function(e,t){var s=$(t).data("cs");if(s.ignore)return!0;s.stylePane&&i?(s.stylePane.showAllRules(),s.stylePane.showOnlySelectedRules()):s.stylePane.showAllRules()})}e.show("    - 3")}}}),_=(T(),H(),null);x.on("input",function(e){(a=x.val())&&0==a.length&&(a=null),_&&clearTimeout(_),_=setTimeout(function(){T(),_=null},300)}),pinegrow.addEventHandler("on_css_source_changed",function(e){getCrsaPageStylesForPage(r).getAllActiveRules();T(),H()}),e.on("crsa-element-selected",function(e,t){var s;t?(s=t.get$DOMElement(),g.setReferenceElement(s)):g.setReferenceElement(null)})};