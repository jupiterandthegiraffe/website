function getIframeDocument(e){return e.contentDocument||e.contentWindow.document}function getCrsaPageStylesForPage(e,t){var s;return e&&(s=e.data("crsa-page"))?s.getStylesheets(t):null}function normalizeSelector(e){for(var t=e.split(","),s=0;s<t.length;s++)t[s]=$.trim(t[s].replace("\n","").replace(/\s{2,}/gi," ").replace(/\s*>\s*/,">"));return t.join(",")}function getRuleName(e){return e.selector||(e.raw&&shortenString(e.raw,18),"Rule")}!function(v){v.fn.crsacss=function(e){return f[e]?f[e].apply(this,Array.prototype.slice.call(arguments,1)):"object"!=typeof e&&e?void v.error("Method "+e+" does not exist on jQuery.crsacss"):f.init.apply(this,arguments)};var s=[],f={init:function(e){return v.extend({},v.fn.crsacss.defaults,e),v("body").on("crsa-page-added",function(e,t){s=v("iframe.content-iframe")}),v("div.canvas").on("crsa-page-closed-removed",function(e,t){s=v("iframe.content-iframe")}),this.each(function(e,t){})},addStylesheetFromUrl:function(e,t){var s=pinegrow.stylesheets.getStylesheetByKey(e);s?t&&t(s):(s=PgCSSStylesheet()).load(e,function(){pinegrow.stylesheets.addCrsaStylesheet(s),t&&t(s)}),pinegrow.stylesheets.stylsheetUsed({url:e,pgStylesheet:s})},loadLessStyles:function(e,t,s){var a,l=v(e),n=getCrsaPageStylesForPage(l,!0),n=(n&&(n.removeAllInlineSheets(),n.destroy()),l.data("crsa-page"));n&&(a=new CrsaPageStyles(n),n.setStylesheets(a),a.loadAllStylesheets(l,function(){console.log("all stylesheets loaded"),t&&t()},s))},renameRuleSelector:function(e,t,s,a){pgStylesheetHelper.getStylesheetFromNode(e).renameRuleSelector(e,t,s,a)},addRule:function(a){var l=v();return s.each(function(e,t){var s=v(t).data("crsa-css-ss");s.insertRule(a,s.cssRules?s.cssRules.length:0),l=l.add(s.cssRules[s.cssRules.length-1])}),l},css:function(e,s,a){return e.each(function(e,t){v(t).css(s,a)}),this},find:function(a){var l=[];return s.each(function(e,t){var s=v(t).data("crsa-css-ss");s&&s.cssRules&&(s=n(v(s.cssRules),a),v.each(s,function(e,t){l.push(t)}))}),v(l)},getCss:function(e,t){return 0!=e.length&&e[0].style[t]||null},getClassesForElement:function(e){var t=[];if(s){var s=e.get(0);if("string"!=typeof s.className)return[];for(var a=s.className.split(/\s+/),l=0;l<a.length;l++)0!=a[l].indexOf("crsa-")&&t.push("."+a[l])}return t},getRulesForElement:function(a,e,t){var l=[],n=[],s=a.get(0);if(s.ownerDocument.defaultView&&s.ownerDocument.defaultView.getMatchedCSSRules){var r=s.ownerDocument.defaultView.getMatchedCSSRules(s,""),o={};if(r){for(var i=r.length;i--;)o[normalizeSelector(r[i].selectorText)]=!0;for(i=0;i<pinegrow.stylesheets.crsaStylesheetsLength();i++)(u=pinegrow.stylesheets.getCrsaStylesheetById(i)).ignore||(o=u.filterRuleObjects(o),v.each(u.getAllRules(),function(e,t){var s;t.selector&&(s=pinegrow.pgPostCSSHelper.getSelector(t))in o&&(l.push(t),n.indexOf(s)<0)&&(s=u.filterSource(s),n.indexOf(s)<0)&&n.push(s)}))}if(e)for(var c=f.getClassesForElement(a),i=0;i<c.length;i++){var d=normalizeSelector(c[i]);n.indexOf(d)<0&&n.push(d)}}else for(i=0;i<pinegrow.stylesheets.crsaStylesheetsLength().length;i++){var u=pinegrow.stylesheets.getCrsaStylesheetById(i);if(v.each(u.getAllRules(),function(e,t){try{var s;t.selector&&a.is(t.selector)&&(s=normalizeSelector(t.selector),l.push(t),n.indexOf(s)<0)&&n.push(s)}catch(e){}}),e)for(c=f.getClassesForElement(a),i=0;i<c.length;i++){var d=normalizeSelector("."+c[i]),h=!1;for(j=0;j<l.length;j++){var p=l[j];if("object"==typeof p&&p.selector&&d==normalizeSelector(p.selector)){h=!0;break}}h||n.push(d)}}return t?n:l},updateVarList:function(){v("body").trigger("crsa-var-updated")},showVariables:function(){v("body").trigger("crsa-var-updated")},showStylesheetsManager:function(){var f,g,m,y,s,a,l;0<v(".crsa-sm").length||(f=v("<ul/>",{class:"crsa-man crsa-sm"}),g=function(){showAlert("The stylesheet is not loaded. Load it (press on X in front of the stylesheet name in CSS panel) before renaming.","Notice")},m=function(t,s){t.append('<form class="form-inline" role="form" style="position:relative;">                    <div class="form-group" style="width:65%;">                    <label class="sr-only">Url</label>                    <div class="input-group" style="width:98%;">                    <input type="url" class="form-control url" placeholder="Url of .css file">                    <span class="input-group-addon"><i class="icon-folder" style="color:#757575;"></i></span>                    </div>                    <p class="help-block"></p>                    </div>                    <button type="submit" class="btn btn-primary add" style="position:absolute;top:2px;">Add</button>                    <button class="btn btn-link cancel">Cancel</button>                    </form>'),t.find(">a,>button").hide();var a=t.find("form"),l=a.find("input.url"),e=a.find("span.input-group-addon"),n=l.closest(".form-group"),r=n.find(".help-block").hide(),o=t.data("crsa-cs");o?(l.val(o.url),a.find("button.add").html("Rename")):a.find("button.cancel").hide(),isApp()?e.on("click",function(e){e.preventDefault(),crsaChooseFile(function(e,t){l.val(e)},(null!=o?crsaGetNameFromUrl(o.url):null)||!!s&&"style.css")}):e.remove(),a.find("button.add").on("click",function(e){e.preventDefault();var t,s,a=v(e.target).closest("form").find("input.url"),l=v.trim(a.val());0==l.length?(n.addClass("has-error"),r.html("Enter the url of existing or new stylesheet.").show()):o?0<(t=pinegrow.stylesheets.findCrsaStylesheetForUrl(l,!0)).length&&t[0]!=o?(n.addClass("has-error"),r.html("File with this url is already loaded.").show()):o.loaded?(t=pinegrow.stylesheets.getAllSheetsForPages(o),o.setUrl(l),o.reattachToAll(t,function(){v("body").trigger("crsa-stylesheets-changed"),y()}),isApp()&&showAlert("Save the stylesheet or the page to which this stylesheet is attached to actually save it under this new name.","Notice")):g():(crsaIsAbsoluteUrl(l)||(t=pinegrow.getSelectedPage())&&(l=crsaCombineUrlWith(t.url,l),a.val(l)),pinegrow.stylesheets.getStylesheetByKey(l)?(n.addClass("has-error"),r.html("File with this url is already loaded.").show()):(n.removeClass("has-error"),r.hide(),s=PgCSSStylesheet(),pinegrow.stylesheets.stylsheetUsed({url:l,pgStylesheet:s}),s.load(l,function(){pinegrow.stylesheets.addCrsaStylesheet(s),s.changed&&s.localFile?s.save(s.localFile,function(){y()}):y(),showAlert("Attach the new stylesheet to the page if you want to use it on that page. Btw, one stylesheet can be attached to multiple pages.","A Tip")},!1,!1,!0,!0)))}),a.find("button.cancel").on("click",function(e){t.data("crsa-cs")&&(a.remove(),t.find(">a,>button").show(),e.preventDefault())})},y=function(){f.html("");function h(o,e){var t=o.find(".source-file-url"),s=o.find(".use-scss-and-less");t.html("<b>Source file:</b> "+e).show(),s.data("already-used-file",!0),v('<a href="#">Cancel</>').appendTo(t).on("click",function(e){e.preventDefault();for(var t=o.find(".source-file-url"),s=o.find(".use-scss-and-less"),a=t.closest("li").data("crsa-cs"),l=a.sourceStylesheet,n=(a.resetSourceStylesheet(),pinegrow.stylesheets.getPagesForStylesheet(a)),r=0;r<n.length;r++)pinegrow.stylesheets.removeUsedStylesheet(l,n[r]);l&&l.remove(!0),t.html("").hide(),s.data("already-used-file",!1),a.setSource(a.source,function(){v("body").trigger("crsa-stylesheets-changed")})})}for(var p,e=pinegrow.stylesheets.getAllCrsaStylesheets(),t=0;t<e.length;t++)e[t].inline||(p=e[t],function(){var e,t,s,a,l=null,n=(p.sourceStylesheet&&(l=p.sourceStylesheet),v("<li/>").appendTo(f).data("crsa-cs",p)),r=(v("<span/>",{}).html(p.name+(p.changed?" *":"")).appendTo(n),v("<a/>",{href:"#"}).html("Duplicate").appendTo(n)),o=v("<a/>",{href:"#"}).html("Rename").appendTo(n),i=v("<a/>",{href:"#",class:"use-scss-and-less"}).html("Use SCSS/LESS").appendTo(n),c=v("<a/>",{href:"#"}).html("Unload").appendTo(n),d=null,l=(p.changed&&isApp()&&p.loaded&&(d=v("<a/>",{href:"#"}).html("<b>Save</b>").appendTo(n)),v("<div/>",{}).html("<b>CSS file:</b> "+p.url).appendTo(n),v("<div/>",{class:"source-file-url",style:"display:none;"}).html("").appendTo(n),l&&h(n,l.url),null!=d&&i.data("should-save-file",!0),p.url.startsWith("http")&&i.data("has-absolute-link",!0),v("<div/>",{}).appendTo(n)),r=(r.on("click",function(e){e.preventDefault();var t=v(e.delegateTarget).closest("li").data("crsa-cs");t.loaded?t.duplicate(function(e){pinegrow.stylesheets.addCrsaStylesheet(e),y()}):g()}),o.on("click",function(e){var t;e.preventDefault(),pinegrow.getSelectedPage().localFile?(t=v(e.delegateTarget).closest("li")).data("crsa-cs").loaded?m(t):g():pinegrow.showAlert("<p>Please save the page before renaming the stylesheet.</p><p>After saving the page go to <b>Page -&gt; Manage stylesheets...</b> to rename the stylesheet.</p>","The page is not saved yet")}),c.on("click",function(e){e.preventDefault();var t=v(e.delegateTarget).closest("li").data("crsa-cs");0<pinegrow.stylesheets.getPagesForStylesheet(t).length?showAlert("This stylesheet is attached to at least one open document. Close the document or detach the stylesheet before closing it.","Can't close this stylesheet"):(t.remove(),v("body").trigger("crsa-stylesheets-changed"),y())}),d&&d.on("click",function(e){e.preventDefault();var t=v(e.delegateTarget).closest("li").data("crsa-cs"),s=require("fs");t.localFile?t.save(t.localFile,function(e){e?showAlert(e,"Can't save this stylesheet"):crsaQuickMessage(crsaGetNameFromUrl(t.url)+" saved!"),y()},s):showAlert("This is a remote stylesheet. Rename it first, then save it.","Can't save this stylesheet")}),v(`<form class="form-inline" role="form" style="display:none;">
                            <div class="form-group" style="width:65%;">
                                <label class="sr-only">Url</label>
                                <div class="input-group" style="width:98%;">
                                    <input type="url" class="form-control url less-scss-input" placeholder="Url of scss/less file"> <span class="input-group-addon"><i class="icon-folder"></i></span></div>
                                <p class="help-block" style="display: none;"></p>
                            </div>
                            <button type="submit" class="btn btn-default use">Use</button>
                            <button class="btn btn-link cancel" style="display: none;">Cancel</button>
                        </form>`).appendTo(l)),o=(r.find("input.url"),r.find(".input-group-addon")),c=r.find("button.use"),u=(o.on("click",function(e){e.preventDefault();var s=v(this).closest("li").find("input.url");crsaChooseFile(function(e,t){s.val(e)})}),i.on("click",function(e){var t;e.preventDefault(),u.localFile?(t=v(this)).data("already-used-file")?pinegrow.showQuickError("This file already has source file."):t.data("should-save-file")?pinegrow.showQuickError("You should save the file first."):i.data("has-absolute-link")?pinegrow.showQuickError("This is a remote stylesheet."):t.closest("li").find("form").show():pinegrow.showAlert("<p>Please save the page before using the SCSS/LESS stylesheet.</p><p>After saving the page go to <b>Page -&gt; Manage stylesheets...</b> to use SCSS/LESS stylesheet.</p>","The page is not saved yet")}),c.on("click",function(e){e.preventDefault();var t=v(this).closest("li"),s=t.find("form"),a=t.find("input.url").val(),l=t.data("crsa-cs"),t=crsaGetExtFromUrl(a),n=null;if(crsaIsAbsoluteUrl(a)||(a=crsaCombineUrlWith(l.url,a)),h(v(this).closest("li"),a),s.hide(),n=pinegrow.stylesheets.getStylesheetByKey(a))(l.sourceStylesheet=n).addCompiledStylesheet(l),v("body").trigger("crsa-stylesheets-changed");else{if("scss"==t)n=PgSCSSStylesheet();else{if("less"!=t)return void showAlert("Please select file with <code>.scss</code> or <code>.less</code> extention","Can't use file");n=PgLESSStylesheet()}l.ignore=!1,n.index=l.getIndexForSourceStylesheet();s=crsaMakeFileFromUrl(crsaGetBaseForUrl(a)),t=(crsaCreateDirs(s),crsaMakeFileFromUrl(a));crsaCreateFile(t),n.load(a,function(){pinegrow.dispatchEvent("on_stylesheet_closed",null,l),l.setSourceStylesheet(n),v("body").trigger("crsa-stylesheets-changed")},!1,null,l)}pinegrow.stylesheets.stylsheetUsed({url:a,pgStylesheet:n},"source",l)}),pinegrow.getSelectedPage());u&&(d=v("<div/>",{class:"attach-detach"}).appendTo(n),e=v('<a class="crsa-sm-attach" href="#">Attach to '+u.name+"</a>").appendTo(d),t=v('<a class="crsa-sm-attach" href="#">Detach From '+u.name+"</a>").appendTo(d),s=function(){e.hide(),t.show(),n.addClass("crsa-active")},a=function(){t.hide(),e.show(),n.removeClass("crsa-active")},(pinegrow.stylesheets.isPageHasStylesheet(u,p)?s:a)(),e.on("click",function(e){e.preventDefault();var t=v(e.delegateTarget).closest("li").data("crsa-cs");u.stylesheets.attachTo(t,null,function(e){s(),pinegrow.changeManager.didChange(null,"Attach stylesheet",null,u),setTimeout(function(){v("body").trigger("crsa-stylesheets-changed")},500)})}),t.on("click",function(e){e.preventDefault();var t=v(e.delegateTarget).closest("li").data("crsa-cs");u.stylesheets.detachFrom(t),a(),pinegrow.changeManager.didChange(null,"Detach stylesheet",null,u)}))}());v("<li/>").appendTo(f);s&&s.remove(),a&&a.remove(),a=v("<h4>Add or load a stylesheet:</h4>").appendTo(l),s=v('<ul class="nav nav-tabs" style="margin-top:15px;">                    <li class="active"><a href="#ss-add-new" data-toggle="tab">New...</a></li>                    <li><a href="#ss-add-open" data-toggle="tab">Open file...</a></li>                    <li><a href="#ss-add-url" data-toggle="tab">Open url...</a></li>                </ul>                    <div class="tab-content">                        <div class="tab-pane active" id="ss-add-new"><p class="">Create a new stylesheet (if you select an existing stylesheet it will be loaded instead).</p></div>                        <div class="tab-pane" id="ss-add-open"><p class="">Open an existing stylesheet.</p></div>                        <div class="tab-pane" id="ss-add-url"><p class="">Enter an absolute or relative url of the stylesheet that you want to create or load.</p></div>                    </div>').appendTo(l),m(s.find("#ss-add-new"),!0),m(s.find("#ss-add-open")),m(s.find("#ss-add-url"))},l=v('<div class="manager"/>').append(f),makeModalDialog("Stylesheets Manager","Close",null,l,function(){pgSetDataOfObjsTo(l.find("> .crsa-sm > li"),"crsa-cs",null),v("body").off(".cssman")}),y(),v("body").on("crsa-page-selected.cssman",function(e,t){y()}))},showFrameworkManager:function(r){var e=r?"Select which libraries and plugins you want to use with this page in <b>Lib</b> and <b>Prop</b> panels.":"The list of libraries and plugins. Select Libraries &amp; Plugins Manager for a specific page to manage which plugins are active for that page.",e=v('<div><p class="text-muted">'+e+"</p></div>"),o=v("<ul/>",{class:"crsa-man crsa-fm"}).appendTo(e),i=function(){o.html("");var e,a,t,l,n,s=pinegrow.getFrameworks(),s=(v.each(s,function(e,t){if(!t.show_in_manager)return!0;var s,a=v("<li/>").appendTo(o).data("crsa-fm",t),l=v("<span/>",{}).html(t.name).appendTo(a),l=(v('<i class="icon-check"></i>').appendTo(l),!1);r&&(r.frameworks.indexOf(t)<0?s=v("<a/>",{class:"crsa-sm-attach",href:"#"}).html('<i class="icon-plus"></i> Activate').appendTo(a):(a.addClass("crsa-active"),s=v("<a/>",{class:"crsa-sm-attach",href:"#"}).html('<i class="icon-minus"></i> Deactivate').appendTo(a),l=!0),s.on("click",function(e){function t(e){e.resources.has()&&pinegrow.showUpdateResourcesDialog(r,pinegrow.getCurrentProject(),[e]),i()}var s,a=v(e.delegateTarget).closest("li"),l=a.data("crsa-fm");0<=r.frameworks.indexOf(l)?(r.removeFramework(l),a.removeClass("crsa-active"),i()):r.addFramework(l,!1,t)?(a.addClass("crsa-active"),(a=pinegrow.getCurrentProject())&&(s=!0,a.forEachOpenPage(function(e){e.addFramework(l,!1,s?t:null),s=!1},r))):showAlert("Only one "+l.type+" library or plugin can be added to a page at the same time. Remove the other one first.","Could not add framework"),r.setPageChanged(!0),e.preventDefault()})),l&&t.resources.has()&&v("<a/>",{class:"crsa-sm-attach",href:"#"}).html('<i class="icon-281"></i> Resources').appendTo(a).on("click",function(e){e.preventDefault();var t=v(e.delegateTarget).closest("li").data("crsa-fm");pinegrow.showUpdateResourcesDialog(r,pinegrow.getCurrentProject(),[t])}),t.changed&&v("<a/>",{class:"crsa-sm-attach",href:"#"}).html('<i class="fa fa-save"></i> <b>Save</b>').appendTo(a).on("click",function(e){e.preventDefault();var s=v(e.delegateTarget).closest("li").data("crsa-fm");s.pluginUrl?s.save(s.pluginUrl,function(){crsaQuickMessage("Library saved."),i(),pinegrow.frameworksChanged()}):crsaChooseFile(function(e,t){s.save(t,function(){crsaQuickMessage("Library saved."),i(),pinegrow.frameworksChanged()})},s.getFileName())}),t.pluginUrl&&(v("<a/>",{class:"crsa-sm-attach",href:"#"}).html('<i class="fa fa-times"></i> Unload').appendTo(a).on("click",function(e){e.preventDefault();var t=v(e.delegateTarget).closest("li").data("crsa-fm");t.changed?showAlert("Plugin has unsaved changes. Sure you want to close it?","Unsaved changes","Cancel","Close it",null,function(){pinegrow.unloadFramework(t),i()}):(pinegrow.unloadFramework(t),i())}),v("<div/>",{}).html(t.pluginUrl).appendTo(a))}),v("<li/>").appendTo(o));(e=s).append('<form class="form-inline load-plugin" role="form">                    <h4>Load your own plugins</h4>                    <p><b>PLEASE LOAD ONLY PINEGROW PLUGINS!</b> Loading anything else <b>WILL</b> break the app.</p>                    <div class="form-group" style="width:65%;">                    <label class="sr-only" for="exampleInputEmail2">Url</label>                    <div class="input-group" style="width:98%;">                    <input type="url" class="form-control url" id="exampleInputEmail2" placeholder=".js file">                    <span class="input-group-addon"><i class="icon-folder"></i></span>                    </div>                    <p class="help-block"></p>                    </div>                    <button type="submit" class="btn btn-default add">Add</button>                    <button class="btn btn-link cancel">Cancel</button>                    </form>'),e.find(">a,>button").hide(),s=e.find("form").hide(),a=s.find("input.url"),t=s.find("span.input-group-addon"),l=a.closest(".form-group"),n=l.find(".help-block").hide(),s.find("button.cancel").hide(),isApp()?t.on("click",function(e){e.preventDefault(),crsaChooseFile(function(e,t){a.val(e)})}):t.remove(),s.find("button.add").on("click",function(e){e.preventDefault();var t,s=v.trim(a.val());0==s.length?(l.addClass("has-error"),n.html("Select the file first.").show()):(t=crsaMakeFileFromUrl(s),pinegrow.findFrameworkWithUrl(s)?(l.addClass("has-error"),n.html("This file is already loaded.").show()):(l.removeClass("has-error"),n.hide(),confirm("Are you sure? Only Pinegrow PLUGINS and COMPONENTS can be loaded. Anything else (framework JavaScript files, etc...) WILL break the app.")&&pinegrow.loadFrameworkFromUrl(s,!0,function(e){e&&showAlert("Unable to load "+t+". "+e,"Unable to load plugin."),i()})))})},t=(i(),e.append('<p><a href="#" class="load-lib">Load component library</a> - <a href="#" class="show-load-plugins">Load plugin</a> - <a href="https://pinegrow.com/docs/developers/" target="_blank" class="link">Learn how to create Pinegrow plugins.</a></p>'),e.find("a.load-lib").on("click",function(e){e.preventDefault(),pinegrow.selectAndLoadLibrary(function(e,t){i()})}),e.find("a.show-load-plugins").on("click",function(e){e.preventDefault(),t.find(".load-plugin").show()}),makeModalDialog(r?"Libraries &amp; Plugins Manager for "+r.name:"Libraries &amp; Plugins Manager","Close",null,e));isApp()&&t.find("a.link").on("click",function(e){var t,s=v(e.delegateTarget).attr("href");s&&(e.preventDefault(),t=require("nw.gui"),s=v(e.delegateTarget).attr("href"),t.Shell.openExternal(s))}),v("body").on("crsa-framework-loaded",function(e,t){i()})}},n=function(e,s){var t;return(s=s||/./).split?(t=v.trim(s).toLowerCase().split(/\s*,\s*/),s=function(){return!!this.selectorText&&!!v.grep(this.selectorText.toLowerCase().split(/\s*,\s*/),function(e){return-1!=v.inArray(e,t)}).length}):s.exec&&(t=s,s=function(){return t.test(this.selectorText)}),v([]).pushStack(v.grep(e,function(e,t){return s.call(e,t)}))};v.fn.crsacss.defaults={title:"crsa"}}(jQuery);var _crsaCss_re_class=/^\.(-?[_a-zA-Z]+[_a-zA-Z0-9-]*)$/;function getClassFromSelector(e){var t=e.match(_crsaCss_re_class);return t?t[1]:null}