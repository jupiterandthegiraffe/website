var PgPluginBuilder=function(m){function a(e){return t++,m.type+"."+(e=e||"comp")+"."+t}var w,t=0,s=(this.debug=!1,this.usePreviewIframe=function(e){var t=m.getResourceUrl("preview/index.html"),p=(w=$('<iframe class="pg-preview-frame" src="'+t+'" frameborder="0" scrolling="false"></iframe>').appendTo($("body")).get(0),pgHide(w),1),g=null,h=new PgDelayedTasks,f=function(){w&&$(w).is(":visible")&&!pgPreview.isVisible()?pgHide(w):h.run("isStuck",f,5e3)};m.on_lib_show_preview=function(e,t,n,s){var c,o,d,u,l;return!(!w.contentDocument||!w.contentDocument.documentElement||(c=w.contentDocument.documentElement.querySelector(t.preview_stage_selector||"#preview-stage"),o=0,d=function(e){u=e||c.clientHeight,o!=u&&(w.style.height=u+g+"px",o=u,s.setContentSize(l*p,u*p+g))},s.onShowFirstMutate=function(e){for(e!==w.ownerDocument.defaultView&&$(w).appendTo(e.document.body);c.hasChildNodes();)c.removeChild(c.lastChild);null===g&&(g=w.contentDocument.body.clientHeight),c.insertBefore(n.get(0),null),c.querySelectorAll("img").forEach(function(e){e.addEventListener("load",function(){d()})}),p=t.big_preview?(w.classList.add("pg-preview-frame-big"),.5):(w.classList.remove("pg-preview-frame-big"),1)},u=0,l=400,s.onShowSecondMeasure=function(){},s.onShowThirdMutate=function(e,t,n,o){pgFastdomTasks.stopAll("hidePreview"+m.key),pgShow(w),h.run("isStuck",f,5e3),u=c.clientHeight,l=w.contentDocument.body.clientWidth,d(u);var r=(l||300)*p,i=u*p,a=r+g;return s.setContentSize(r,i+g),o||("left"==n.pos?n.x=Math.max(0,n.target_pos.left-a-0):(n.x=n.target_pos.left+n.container_w,n.x+a>n.win_w&&(n.x=n.win_w-a)),n.y+i+(r=80)>n.win_h&&(n.y=n.win_h-i-r),n.y<0&&(n.y=0)),w.style.left=n.x+8+"px",w.style.top=n.y+8+"px",n},pgPreview.onHide=function(){pgFastdomTasks.create("hidePreview"+m.key).mutate(function(){pgHide(w),h.cancel("isStuck")})},0))}},this.addSection=function(e){var t=new PgFrameworkLibSection(a("section"),e);return m.addLibSection(t),t},this.readFile=function(e){var t=crsaIsAbsoluteUrl(e)?e:m.getResourceUrl(e);return pinegrow.getSourceNodeOfUrl(t,!1,!1)},this.getSourceNode=function(e,n){e=crsaIsAbsoluteUrl(e)?e:m.getResourceUrl(e);crsaIsFileUrl(e)?n(pinegrow.getSourceNodeOfUrl(e,!1,!1)):$.ajax({url:e,data:null,dataType:"text"}).done(function(e){var t=new pgParser;t.assignIds=!1,t.parse(e),n(t.rootNode)}).fail(function(e){n(null)})},this.replaceHolderImages=function(e){e.walkSelfAndChildren(function(e){var t=e.getAttribute("data-src");return t&&0<=t.indexOf("holder.js")?(t=pinegrow.getPlaceholderImage(),e.setAttribute("src",t),e.removeAttribute("data-src")):"svg"===e.tagName&&e.hasClass("bd-placeholder-img")&&e.replaceWith(pgCreate(`<img src="${pinegrow.getPlaceholderImage()}" />`)),!0})},this.add=function(e,t,n,o){var r=a(),i=new PgComponentType(r,e);if(i.code=t,i.preview_image=i.type+".png",i.button_image=i.preview_image,i.no_lib_label=!0,n&&$.each(n,function(e,t){i[e]=t}),this.debug)try{createElementFromDefinition(i)}catch(e){console.log("Invalid definition for "+i.name+" ("+i.type+") "+e)}return m.addComponentType(i),o&&o.addComponentType(i),i},this.addSourceComponent=function(e,t,n,o,r){var i,a=e.find(t);a.sort(function(e,t){return e.startStringIndex>t.startStringIndex?1:e.startStringIndex<t.startStringIndex?-1:0});for(var s=0;s<a.length;s++)i=this.add(n+(1<a.length?" "+(s+1):""),a[s].toStringOriginal(!0),o,r);return i},this.addScriptToComponent=function(e,t){e.add_script_on_insert=t},this.takePhotos=function(e,i){var t=m.getResourceUrl(e),a=require("nw.gui").Window.open(t,{width:1024,height:600,transparent:!1}),n=!1;a.on("loaded",function(){var r;n||(r=n=!0,setTimeout(function(){var e,t=$(a.window.document.body).find("#photo-stage"),n=[];for(e in m.component_types)n.push(m.component_types[e]);var o=function(){var e;0===n.length?i&&i():(e=r?n[0]:n.shift(),r=!1,s(e,a,t,function(){o()}))};o()},500))})},function(n,o,e,u){require("nw.gui");var l,t,r,i,a,p,s=e.closest("body").get(0),g=createElementFromDefinition(n);g?(l=m.getResourceFile("images/"+n.type+".png"),t=100,(r=e).empty(),i=null,n.take_photo&&(n.take_photo.delay&&(t=n.take_photo.delay),n.take_photo.stage_inner&&($(n.take_photo.stage_inner).appendTo(e),r=e.find(".take_photo_inner")),n.take_photo.script?i=n.take_photo.script:n.add_script_on_insert&&0<=(i=n.add_script_on_insert).indexOf("$ELEMENT_ID")&&(a=g.attr("id")||getUniqueId("element"),g.attr("id",a),i=i.replace(/\$ELEMENT\_ID/g,a))),r.append(g),i&&((a=s.ownerDocument.createElement("script")).async=!1,a.text=i,s.appendChild(a)),n.take_photo&&n.take_photo.func&&n.take_photo.func(g),p=1,setTimeout(function(){n.take_photo&&n.take_photo.selector&&(g=g.find(n.take_photo.selector));var e,t=(g=n.take_photo&&n.take_photo.get_subject?n.take_photo.get_subject(g):g).offset();t.width=g.outerWidth(),t.height=g.outerHeight(),t.height>o.window.innerHeight&&(e=o.window.innerHeight/t.height,g.css("transform","scale("+e+", "+e+")").css("transform-origin","top left"),t.width*=e,t.height*=e),setTimeout(function(){var i=t.left*p,a=t.top*p,s=t.width*p,c=t.height*p,d=(0!=s&&0!=c||(console.log("Can not takePhoto, dimensions are 0",g),u&&u()),1),e=400;e&&e<s&&(d=1*e/s),o.capturePage(function(e){var n=document.createElement("canvas"),o=(n.setAttribute("width",s),n.setAttribute("height",c),n.getContext("2d")),r=new window.Image;r.addEventListener("load",function(){o.drawImage(r,i,a,s,c,0,0,s,c);var e,t=d<1?downScaleCanvas(n,d):n;l&&(e=(e=t.toDataURL("image/png")).replace("data:image/png;base64,",""),e=new Buffer(e,"base64"),require("fs").writeFileSync(l,e)),u&&u(t)},!1),r.src=e,g.remove()},{format:"png",datatype:"datauri"})},100)},t)):u()});this.addResource=function(e,t){var n=null,o=null;return crsaIsAbsoluteUrl(e)||(n=e,isApp()&&(o=e=m.getResourceUrl("resources/"+e))),(res=new PgComponentTypeResource(e)).relative_url=n,res.source=o,res.detect=t,res.replace=!0,res.footer="application/javascript"==res.type,m.resources.add(res),res},this.addResourceCode=function(e,t,n,o){return(res=new PgComponentTypeResource("http://dummy/file.js")).code=e,res.detect=t,res.replace=!0,res.footer=n,(o||m.resources).add(res),res}};