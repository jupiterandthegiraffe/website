var PgCodeValidator=function(){function d(e){var t={},o=[];return e.walk(function(e){return e.isElement&&e.tagName&&u(e.tagName)&&!t[e.tagName]&&(o.push(e.tagName),t[e.tagName]=!0),!0}),r[e.getId()]=o}function c(e,t){o.errors.push({pgel:e,error:t})}function h(e,t){return'<b data-tag="'+(t||e)+'">'+e+"</b>"}var o=this,t={},u=(["a","abbr","acronym","address","applet","area","article","aside","audio","b","base","basefont","bdi","bdo","bgsound","big","blink","blockquote","body","br","button","canvas","caption","center","cite","code","col","colgroup","command","content","data","datalist","dd","del","details","dfn","dialog","dir","div","dl","dt","element","em","embed","fieldset","figcaption","figure","font","footer","form","frame","frameset","h1","h2","h3","h4","h5","h6","head","header","hgroup","hr","html","i","iframe","image","img","input","ins","isindex","kbd","keygen","label","legend","li","link","listing","main","map","mark","marquee","menu","menuitem","meta","meter","multicol","nav","nobr","noembed","noframes","noscript","object","ol","optgroup","option","output","p","param","picture","plaintext","pre","progress","q","rp","rt","rtc","ruby","s","samp","script","section","select","shadow","slot","small","source","spacer","span","strike","strong","style","sub","summary","sup","table","tbody","td","template","textarea","tfoot","th","thead","time","title","tr","track","tt","u","ul","var","video","wbr","xmp"].forEach(function(e){t[e]=!0}),function(e){return t[e]||!1}),a=["h1","h2","h3","h4","h5","h6"],n=["div","main","section"].concat(a),g={html:{only_children:["head","body"]},head:{only:["title","base","link","style","meta","script","noscript","template","img"],parents:["html"]},title:{no:!0,parents:["head","svg"]},base:{no:!0,parents:["head"]},meta:{no:!0},body:{parents:["html"]},p:{no:n,no_self:!0},a:{no_self:!0}},r=(["abbr","audio","b","bdo","br","button","canvas","cite","code","command","data","datalist","dfn","em","embed","i","iframe","img","input","kbd","keygen","label","mark","math","meter","object","output","progress","q","ruby","samp","script","select","small","span","strong","sub","sup","svg","textarea","time","var","video","wbr"].forEach(function(e){g[e]={no:n}}),a.forEach(function(e){g[e]={no:a}}),{});this.errors=[];this.validate=function(e){var t=new CrsaProfile;return e.walkSelfAndChildren(function(e){var t,o,a,n=null,r=null;if(e.tagName){var i=e.tagName;if(g[i]){if(g[i].no)if(!0===g[i].no)e.hasChildrenNotIncludingScripts()&&c(e,"should not have children");else for(var n=d(e),s=0;s<g[i].no.length;s++)0<=n.indexOf(g[i].no[s])&&c(e,"should not contain "+h(g[i].no[s])+" elements");if(g[i].no_self&&0<=(n=n||d(e)).indexOf(e.tagName)&&c(e,"should not contain "+h(e.tagName)+" elements."),g[i].only){n=n||d(e);for(var l=[],s=0;s<n.length;s++)g[i].only.indexOf(n[s])<0&&l.push(h(n[s]));l.length&&c(e,"should not contain "+l.join(", ")+" elements.")}if(g[i].only_children){for(r=r||(o={},a=[],(t=e).children&&t.children.forEach(function(e){e.isElement&&e.tagName&&u(e.tagName)&&!o[e.tagName]&&(a.push(e.tagName),o[e.tagName]=!0)}),a),l=[],s=0;s<r.length;s++)g[i].only_children.indexOf(r[s])<0&&l.push(h(r[s],"_"+r[s]));l.length&&c(e,"should not contain "+l.join(", ")+" elements.")}g[i].parents&&e.parent&&g[i].parents.indexOf(e.parent.tagName)<0&&c(e,"should not be a child of "+'<b data-pg-id="'+(t=e.parent).getId()+'">'+t.getName({short:!0})+"</b>"+". Allowed parents are: "+g[i].parents.join(", ")+".")}else e.isSingleTag()?e.hasChildren()&&c(e,"should not have children"):e.isProperlyClosed()||c(e,"is not properly closed"+(e.closingTag?" (closing tag is <b>"+e.closingTag+"</b>)":"."))}return!0}),t.show("Page Validation"),this.errors},this.hasErrors=function(){return 0<this.errors.length},this.describeErrors=function(){var t="";return 0===this.errors.length?t+="<li>No errors found.</li>":this.errors.forEach(function(e){t+='<li data-pg-id="'+e.pgel.getId()+'"><span>'+e.pgel.getName({short:!0})+"</span> - "+e.error+"</li>"}),t}};$(function(){pgf.edit_html&&$("body").one("pinegrow-ready",function(e,i){var s="1"===i.getSetting("auto-validate-code","1"),o=new PgFramework("pg.code-validator","Code validator");i.addFramework(o),o.default=!0,o.show_in_manager=!1,o.validateHTML=function(o,e){var a,n,r=new PgCodeValidator;r.validate(o),!r.hasErrors()&&e||(a=(a="<p>The following HTML elements have problems:</p><ul>")+r.describeErrors()+"</ul>",n=o.getPage(),PgQuickDialog("HTML syntax errors in "+n.getName(),function(t){return a+='<p class="help">Click on the element on the above list to select it. If you can\'t see the element in the tree, switch to Source code <i class="icon icon-KODA"></i> tree mode.',e&&(a+=' Use "Page -&gt; Check for HTML errors" to validate the code at any time.'),a+="</p>",t.addClass("pg-code-validator-results"),t.on("click","[data-tag]",function(e){e.preventDefault(),e.stopPropagation();var t,o,a=$(this).attr("data-tag"),n=$(this).closest("li").attr("data-pg-id"),r=getPgNodeByPgId(n);r&&a&&(n=a.startsWith("_"),a=a.replace("_",""),r.scrollTo(),n=r.find(a,!1,n),t=!1,10<n.length&&(n.splice(10,n.length-10),t=!0),(o=new PgCollection).setList(n),setTimeout(function(){i.selectedElements.clear(),i.selectedElements.selectMany(o),t?i.showQuickMessage("Only the first 10 <b>"+a+"</b> elements in "+r.getName({short:!0})+" were selected."):i.showQuickMessage("<b>"+a+"</b> elements in "+r.getName({short:!0})+" were selected.")},100))}),t.on("click","[data-pg-id]",function(e){e.preventDefault();var t=$(this).attr("data-pg-id"),o=getPgNodeByPgId(t);o&&(o.scrollTo(),setTimeout(function(){i.selectElement(o),i.showQuickMessage(o.getName({short:!0})+" was selected.")},100))}),a+='<button class="pg-button pg-button-primary refresh">Refresh</button>',t.on("click","button.refresh",function(e){e.preventDefault(),(r=new PgCodeValidator).validate(o),t.find("ul").html(r.hasErrors()?r.describeErrors():"<li>No errors found.</li>"),n.refresh()}),a+='<label style="margin-left: 20px;position: relative;top: 2px;" class=" control-label auto-check"><input type="checkbox" '+(s?'checked="checked"':"")+"> Check for errors on page open</label>",t.on("change",'input[type="checkbox"]',function(e){s=$(this).is(":checked"),i.setSetting("auto-validate-code",s?"1":"0"),i.showMode("Check for error on page open",s),s||i.showQuickMessage("Use Page -&gt; Check for HTML errors to check the current page.")}),a+=`<p class="text-muted" style="border-top: 1px solid;
    margin-top: 20px;
    padding-top: 10px;">Please note that Pinegrow requires valid HTML code in order to work correctly. Therefore it is recommended to have the auto check enabled. If you encounter situations where correct code is flagged as invalid, let us know and we will improve the validator.</p>`},{width:480}))},o.on_page_loaded=function(e,t){t&&s&&o.validateHTML(e.sourceNode,!0)},o.on_page_menu=function(e,t){return t.push({label:"Check for HTML errors...",kbd:null,action:function(){o.validateHTML(e.sourceNode)}}),t}})});