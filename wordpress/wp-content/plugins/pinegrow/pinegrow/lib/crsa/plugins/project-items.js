$(function(){$("body").one("pinegrow-ready",function(e,d){function s(e){g.requireSelectedElement(e)}function u(n,e){e=e||"",isAppForProject()?d.showPrompt("Name of the new folder","New folder",e,"Folder name",null,function(e){var t;e.length?(t=require("path").join(n,e),crsaIsFileExist(t)?d.showAlert("Folder or file with the same name (<b>"+e+"</b>) exists. Please choose a different name.","Folder or file already exists",null,"Ok",null,function(){u(n,e)}):(crsaCreateDirs(t),d.refreshCurrentProject())):d.showAlert("Folder name should not be blank","Error",null,"Ok",null,function(){u(n,"")})}):d.showAlert(`<p>At the moment, empty folders can not be created directly. To create a folder include it in the name of the file when creating it with New page or New file command.</p><p>For example, use the new page name <code>subfolder/mypage.html</code> to create the new page and the subfolder <code>subfolder</code>.</p>`,"About creating folders",null,"Got it")}function f(n,e){var t,r,o,a,i=d.getCurrentProject();isAppForProject()?(t=i.getSettingsForNewFileDialog(),r=t.projects,o=t.selected,a=function(e,t){i.createFromMasterPage(n,e,t)},r&&((crsaTemplateBrowser=new CrsaProjectBrowser).title="Add a page to your project",crsaTemplateBrowser.intro="<p>Choose a page to add to your project:</p>",crsaTemplateBrowser.setProjects(r),crsaTemplateBrowser.selectedProject=o,crsaTemplateBrowser.onFileSelected=function(e,t){a(e,t)},crsaTemplateBrowser.show())):new PgProjectMenuHelper(i).createNewPage(null,e,n?i.getRelativeUrl(n):null)}function h(o,e){d.showPrompt("<p>Enter the name of the new file.</p>"+(isAppForProject()?"":"<p>Include a folder name (for example, <code>folder/myfile.js</code>) if you wish to create the page in a new folder.</p>"),"Create new file",e||"","File name",null,function(e){var t,n,r;e.length?(t=d.getCurrentProject(),(isAppForProject()?(n=require("path").join(o,e),crsaIsFileExist(n)):(n=(o?o+"/":"")+e,n=t.getRelativeUrl(n),t.getFileForUrl(n)))?d.showAlert("Folder or file with the same name (<b>"+e+"</b>) exists. Please choose a different name.","File already exists",null,"Ok",null,function(){h(o,e)}):(r=function(){isAppForProject()?require("fs").writeFileSync(n,"",{encoding:"utf8"}):(t.addFile(n,""),t.settingsFileIsChanged(n),d.backend.saveDelayed()),d.refreshCurrentProjectDelayed(!0)},d.isFileEditable(n)?d.showAlert(isAppForProject()?`<p>Would you like to create a new HTML page based on one of the ready-made templates or master pages?</p>`:`<p>Would you like to add the boilerplate HTML code to the new page?</p>`,"Are you creating a new HTML page?","No, just create the file",isAppForProject()?"Yes, show me the templates":"Yes, add the HTML code",function(){r()},function(){f(isAppForProject()?crsaMakeUrlFromFile(o):o,e)}):r())):d.showAlert("File name should not be blank","Error",null,"Ok",null,function(){h(o,"")})},null,null,null,function(e){var t={};if(!d.backend.isFileNameAllowed(e,t))return t.reason})}var g=new PgFramework("pg.project.items","Project items");d.addFramework(g),g.default=!0,g.show_in_manager=!1;g.on_project_menu=function(e,r){var t,n,o,a=[];return isAppForProject()&&a.push({label:"Reload project",func:function(){d.refreshCurrentProject(null,!1,!0)}}),pgf.edit_html&&(a.push({label:"Add new page...",func:function(){f(r.getUrl())}}),a.push({label:"Add new folder...",func:function(){u(r.getDir())}}),a.push({divider:!0}),a.push({label:"Create new file...",func:function(){h(r.getDir())},helptext:"Use this command to create a blank non-HTML file. Use Add new page for HTML files."})),isAppForProject()&&(a.push({label:"Delete backups...",func:function(){d.showAlert("<p>Are you sure you want to delete all <b>_pgbackup</b> folders in the project?</p><p>_pgbackup folders contain backup copies of changed files, if backup is enabled in Settings.</p>","Delete all backups?","No","Yes",null,function(){r.findFilesByName("_pgbackup").forEach(function(e){e.delete()}),d.showQuickMessage("Backups deleted!"),d.refreshCurrentProject()}),d.stats.using("prj.deletebackups")}}),t=[],a.push({divider:!0}),a.push({label:"Remote URLs",submenu:t}),t.push({label:"Open URL...",action:function(){d.showOpenUrlDialogAndOpenPage()}}),n=r.getRemoteUrls(),o=[],n.forEach(function(n){var e=pgUrlToDisplayString(n);50<e.length&&(e="&hellip;"+e.substr(e.length-50)),o.push({label:`<span class="" title="${n}">${e}</span><span class="extracmd pg-project-urls-list-remove" style="opacity:0.7;margin-left:20px;position:absolute;right:8px;" title="Remove from the list."><i class="icon icon-close"></i></span>`,extra_action:function(){r.removeRemoteUrl(n),d.showQuickMessage("URL was removed from the list.")},action:function(){d.openOrShowPage(n,function(e,t){t&&r.addRemoteUrl(n)})}})}),0===o.length&&o.push({type:"header",label:"The list is empty."}),t.push({label:"Recent URLs",submenu:o}),t.push({label:"Learn more...",action:function(){d.openExternalUrl(pgf.docs.remote_url_help)}})),d.dispatchEvent("on_get_project_menu_items",null,a),isApp()&&(a.push({divider:!0}),a.push({label:"Copy path to clipboard",func:function(){crsaCopyToClipboard(r.getDir(),"Project path was copied to clipboard.")}})),a.push({divider:!0}),a.push({label:"Close project",func:function(){d.closeCurrentProject()}}),a},g.on_project_item_preview=function(e,t){if(t&&t.isImage()){var n=require("fs"),r=null;if(isAppForProject())try{r=n.statSync(t.path)["size"]}catch(e){}return isAppForProject()||!t.url.endsWith(".svg")||t.content&&t.content.startsWith("@mapurl")?{code:'<img src="'+t.getMappedUrlOrUrl()+'" />',info:"",onLoaded:function(e){return e.naturalWidth+` x `+e.naturalHeight+(null!==r?`, ${Math.round(r/1024)} KB`:"")}}:t.content?{code:t.content}:void 0}},g.on_project_item_get_context_menu=function(e,c,p){function a(e){var t=d.getCrsaPageByUrl(e);return!(!t||!t.view||(t.view.closeTab(),0))}var t,n,r,o,i=d.getCurrentProjectInfo(),l=[];return(pgf.edit_html||c.isEditable)&&l.push({divider:!0,header:"Page"}),pgf.edit_html&&!c.isFile&&(l.push({label:"Add new folder...",func:function(){u(c.path),d.stats.using("prj.newfolder")}}),l.push({label:"Add new page...",func:function(){f(c.url),d.stats.using("prj.newpage")}}),l.push({label:"Create new file...",func:function(){h(c.path)}})),c.isEditable&&(o=null,(n=d.findFrameworkByKey("pg.components"))&&(o=n.pgcGetPartialOpeningOptions(c.url,i,c.name)),l.push(o?{label:"Open",submenu:o}:{label:"Open",func:function(){var e=d.getCrsaPageByUrl(c.url);pgf.use_page_wrappers&&e&&e.wrapper_node?e.askClose(function(){d.openOrShowPage(c.url)}):d.openOrShowPage(c.url),d.stats.using("prj.openfile")}})),pgf.edit_html&&c.isFile&&l.push({label:"Open in code editor",func:function(){d.openFileInCodeEditor(c.path),d.stats.using("prj.editcode")}}),pgf.use_page_wrappers&&(l.push({divider:!0,header:"Wrapper"}),l.push({label:"Open in wrapper",func:function(){d.displayOldWrapperNotice()}}),l.push({label:"Wrapper settings...",func:function(){d.displayOldWrapperNotice()}})),isAppForProject()&&(t=d.getCrsaPageByUrl(c.url)||p.getBackgroundPageForUrl(c.url))&&(l.push({divider:!0}),l.push({label:"Save",func:function(){canSavePage(t)&&t.save(null,!0,!0,!1,!0)}})),pgf.edit_html&&(l.push({divider:!0}),c.isFile&&(isAppForProject()?l.push({label:"Duplicate...",func:function(){d.stats.using("prj.duplicate"),d.showPrompt("Name of the new file","Duplicate file",c.name,null,null,function(e){if(e.length&&e!=c.name)try{var t,n=p.getProjectInfo(),r=n.getSettingsForFile(c.path),o=c.duplicate(e);for(t in r)n.setSettingForFile(o.path,t,r[t]);n.save();function a(e){o&&!e?d.openOrShowPage(o.url,function(e){d.refreshCurrentProject(),e.callFrameworkHandler("on_page_cloned",d.getCrsaPageForUrl(c.url))}):d.refreshCurrentProject()}if(d.isFileEditable(crsaMakeFileFromUrl(o.url))){var i=d.getCrsaPageForUrl(o.url);if(i){var l=i.sourceNode.find("[data-pgc-define]");if(0<l.length){for(var s=[],u=0;u<l.length;u++)s.push(l[u].getAttr("data-pgc-define"));d.showAlert("<p>The page contains <b>component definitions</b> for components: "+s.join(", ")+".</p><p>Do you want to:<ul><li><b>Keep these definitions in the new page</b> (and have duplicate definitions, which you would need to fix later)<br />- or -</li><li><b>Replace component definitions with component instances in the new page</b>?</li></ul></p>","What to do with component definitions?","Keep definitions","Replace with instances",function(){a()},function(){d.findFrameworkByKey("pg.components").changeComponentDefinitionsToComponentInstances(i.sourceNode),i.save(),a()})}else a()}else a(!0)}else a(!0)}catch(e){d.showAlert(e,"Error")}else d.showQuickMessage("Nothing to do...")})}}):l.push({label:"Duplicate...",func:function(){new PgProjectMenuHelper(p).createNewPage(p.getContentOfUrlWithLookup(c.url),null,crsaGetBaseForUrl(c.url),!d.isFileEditable(c.name))}})),isAppForProject()||l.push({label:"Rename...",func:function(){new PgProjectMenuHelper(p).renameFile(c.url)}}),1&&l.push({label:"Delete...",func:function(){d.showAlert("Are you sure you want to delete <b>"+c.name+"</b>?","Delete file/folder","No","Yes, delete it!",null,function(){var t,n;isAppForProject()?c.delete()?(a(c.url),d.showQuickMessage("<b>"+c.name+"</b> deleted successfully."),d.refreshCurrentProject()):d.showQuickMessage("Failed to delete <b>"+c.name+"</b>."):(t=[],n=[],c.isFile?(t.push(c),n.push(c.url)):c.walkThroughFiles(function(e){e.isFile&&(t.push(e),n.push(e.url))}),d.backend.deletePages(p,n,function(){t.forEach(function(e){a(e.url),p.removeFileNodeFromList(e)}),c.isFile||p.removeFileNodeFromList(c),d.showQuickMessage(`${1<t.length?t.length+" files ":t[0].name} deleted successfully.`),d.refreshCurrentProject()}))}),d.stats.using("prj.delete")}}),isAppForProject()&&(l.push({label:"Rename...",func:function(){d.stats.using("prj.rename"),d.showPrompt("Enter the new file name","Rename file/folder",c.name,"New file name",null,function(o){var e,t;o.length&&o!=c.name?((e=d.getCrsaPageByUrl(c.url))&&e.save(null,!0),t=function(){try{var e,t=p.getProjectInfo(),n=t.getSettingsForFile(c.path),r=c.rename(o);for(e in n)t.setSettingForFile(r.path,e,n[e]);t.save(),d.showQuickMessage("<b>"+c.name+"</b> renamed successfully."),a(c.url)&&r&&d.openOrShowPage(r.url,function(e){e.detectAndAddFrameworks(),d.updatePluginControlsForSelectedPage(e)}),d.refreshCurrentProject()}catch(e){d.showQuickMessage("Failed to rename <b>"+c.name+"</b>.")}},c.doesFileExistInSameDir(o)?c.isDirectoryInTheSameDir(o)?d.showAlert("Are you sure you want to overwrite <b>"+o+"</b>?","overwrite file","No","Yes",null,function(){t()}):d.showQuickMessage("You can't overwrite directory"):t()):d.showQuickMessage("Nothing to do...")})}}),c.isFile)&&l.push({label:"Fix links...",func:function(){d.stats.using("prj.fixlinks"),e?d.fixLinks(p,e,null,e.url,function(){e.updateStylesheetsList(function(){e.detectAndAddFrameworks(function(){e.refresh(),d.changeManager.didChangePage(e,"Fix links")})})}):d.showAlert("Please open the page first.","The page must be open")}}),n=d.getSelectedElementName()||"selected element",i=d.selectedElements.getLastSelected(),o=c.getSimpleType(),i&&"image"==o&&(l.push({divider:!0,header:"Images"}),l.push({label:"Insert image after <b>"+n+"</b>",func:function(){s(function(e,t){var n=e.makeRelativeUrl(c.url),r=pgCreate('<img src="'+n+'" />');d.makeChanges(t,"Insert image",function(){r.insertAfter(t)}),d.showQuickMessage("Image inserted.")})}}),i.canHaveChildren()&&l.push({label:"Append image to <b>"+n+"</b>",func:function(){s(function(e,t){var n=e.makeRelativeUrl(c.url),r=pgCreate('<img src="'+n+'" />');d.makeChanges(t,"Append image",function(){t.append(r)}),d.showQuickMessage("Image appended.")})}}),"img"===i.tagName)&&l.push({label:"Replace image",func:function(){s(function(e,t){e.makeRelativeUrl(c.url);d.makeChanges(t,"Replace image",function(){d.selectedElements.forEachElement(function(e){var t=e.getPage().makeRelativeUrl(c.url);e.setAttribute("src",t)})}),d.showQuickMessage("Image replaced.")})}}),"script"==o&&(l.push({divider:!0,header:"Javascript"}),r=function(n){g.requireSelectedPage(function(e){var t=c.hasScriptOnPage(e);t?d.showQuickError("The script is already included in the "+t+" of the page."):(d.makeChanges(e,"Include script",function(){c.addScriptToPage(e,n)}),d.showQuickMessage("Script included. Refresh the page view to run it (if Javascript is enabled in Pinegrow)."))})},l.push({label:"Include in page Head",func:function(){r()}}),l.push({label:"Include in page Footer",func:function(){r(!0)}})),"css"==o&&"text/css"===d.getMimeType(c.url)&&(l.push({divider:!0,header:"Stylesheet"}),l.push({label:"Link the stylesheet to the page",func:function(){g.requireSelectedPage(function(e){c.hasStylesheetOnPage(e)?d.showQuickError("The stylesheet is already included in the page."):(d.makeChanges(e,"Include stylesheet",function(){c.addStylesheetToPage(e)}),d.showQuickMessage("Stylesheet included."))})}})),l.push({divider:!0,header:"Links"}),o=(i=d.selectedElements.getLastSelected())&&"a"==i.tagName?"Link to":"Set href/src of",l.push({label:o+" <b>"+n+"</b>",func:function(){s(function(e,t){var n=e.makeRelativeUrl(c.url),r=t.is("img,script,iframe")?"src":"href";d.makeChanges(t,"Set "+r,function(){t.attr(r,n)}),d.showQuickMessage("<b>"+r+"</b> set to "+n)})}}),l.push({label:"Append link to <b>"+n+"</b>",func:function(){s(function(e,t){var n='<a href="'+e.makeRelativeUrl(c.url)+'">'+c.name+"</a>",r=pgCreate(n);d.makeChanges(t,"Insert link",function(){t.append(r)}),d.showQuickMessage("Link appended.")})}}),l.push({label:"Insert link after <b>"+n+"</b>",func:function(){s(function(e,t){var n='<a href="'+e.makeRelativeUrl(c.url)+'">'+c.name+"</a>",r=pgCreate(n);d.makeChanges(t.parent,"Insert link",function(){r.insertAfter(t)}),d.showQuickMessage("Link inserted.")})}})),isApp()&&(l.push({divider:!0}),l.push({label:"Copy path to clipboard",func:function(){crsaCopyToClipboard(c.path,"The path was copied to clipboard.")}})),l},g.aaaon_project_loaded=function(e,t){var o=0;t.forEachEditableFile(function(e,t,n){var r=e.sourceNode.find("[href]");o+=r.length,n.errors.push("Oh no!"),t(e,n)},function(){d.showQuickMessage("Found "+o+" links.")},"Just fooling around...")}})});