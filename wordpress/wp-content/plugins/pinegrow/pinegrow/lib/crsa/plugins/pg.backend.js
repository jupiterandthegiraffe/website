var PgRegisterForTrial=function(){this.show=function(){new PgToggleButtonMaker;var e=pinegrow.showQuickDialog("Start your free trial","Your information",`<p></p>`,{name:{type:"text",name:"First name",field_style:"margin-top: 30px;",no_validate_on_show:!0,validate:function(e,t,n){if(!n)return"Please enter your first name."}},email:{type:"text",name:"Email",no_validate_on_show:!0,validate:function(e,t,n){if(!n)return"Please enter your email address."}},age:{type:"select",name:"How old are you?",show_empty:!0,options:[{key:"less_than_13",name:"Less than 13 years old"},{key:"more_than_13",name:"More than 13 years old"}],no_validate_on_show:!0,validate:function(e,t,n){return n?"less_than_13"===n?"Please ask your parent, caretaker or teacher to signup and create an account for you.":void 0:"Please choose one option."}},contact_label:{type:"displayhtmlwithlabel",name:"&nbsp;",html:`Would you like to receive monthly challenges, helpful tips, product updates and promotions?`,field_style:"margin-top: 30px;"},contact:{type:"select",name:`Let's stay in touch`,toggle_buttons:!0,field_style:"",options:[{key:"true",name:'<span><i class="icon icon-check" style="position:relative;top:1px;"></i> Yes</span>'},{key:"false",name:'<span><i class="icon icon-close"></i> No</span>'}],no_validate_on_show:!0,validate:function(e,t,n){if(!n)return"Please choose one option. Not sure? Say Yes, you can unsubscribe at anytime."}},agree:{type:"checkbox",name:'I agree with the <a href="https://htmlplanetforkids.com/privacy-policy.html" target="_blank">privacy policy</a> and <a href="https://htmlplanetforkids.com/terms-of-use.html" target="_blank">terms of use</a>.',value:"true",negvalue:"false",default_value:"false",field_style:"margin-top: 30px;",no_validate_on_show:!0,validate:function(e,t,n){if("true"!==n)return"Please confirm that you agree."}}},"Cancel","Start trial",null,function(e,t,n){var o;return(o=t.get$OKButton()).html("Saving, please wait..."),o.attr("disabled","disabled"),pinegrow.backend.registerTrialUser({name:e.name,email:e.email,contact:e.contact},function(e){n(),pinegrow.showAlert(`<p>Your ${pgf.product_name} account was created. Please check your inbox for email with your username and password.</p>`,"Thank you for registering","Cancel","Got the email. Let's sign in.",null,function(){pinegrow.currentUser.showLoginForm()})},function(e){o.html("Save"),o.get(0).removeAttribute("disabled"),pinegrow.showAlert(`<p>Oops... There was a hiccup during the registration process: `+e,"Mission aborted")}),!1},!0),t=(e.get$Dialog().addClass("pg-register-trial-dialog"),`<div class="pg-trial-info">
<div>No credit card required</div>
<div>10 lessons and 3 projects</div>
<div>No time limit</div>
<div>All information is stored on your computer</div>
</div>`),n=(e.get$Dialog().find(".pg-dialog-fields").append(t),e.get$Dialog().find(".modal-body")),o=1,r=([1,2,4,5,7].forEach(function(e){$(`<img src="images/kids/alien${e}.png" class="alien alien${o++}">`).appendTo(n)}),$(`.alien5`));e.get$Dialog().find('[data-item-id="0"]').on("click",function(e){gsap.to(r.get(0),{duration:.5,bottom:-20,rotateZ:5})}),e.get$Dialog().find('[data-item-id="1"]').on("click",function(e){gsap.to(r.get(0),{duration:1,bottom:-80,rotateZ:0})})}},PgEditUserProfile=function(u,d){var g=this,h=(this.onUserSaved=function(){},"········");this.show=function(){function i(t){pg$Show($check_username),n.html("Checking if the username is available..."),n.removeClass("text-success").removeClass("text-danger"),e.run("checkUsername",function(){c=!1,pinegrow.backend.checkUsername(t,u?u.id:null,function(e){l=t,e.exists?(c=!1,n.removeClass("text-success").addClass("text-danger"),n.html('<i class="icon icon-close"></i> Sorry, this username is not available.')):(c=!0,n.html('<i class="icon icon-check"></i> The username is available.'),n.addClass("text-success").removeClass("text-danger"))})},1e3)}function s(e){return e.length<3?"Username should have at least 3 characters.":e.match(/^[a-z0-9]+$/i)?void 0:"Username should only contain letters and numbers."}var e=new PgDelayedTasks,l=u?u.username:"",c=!!u,n=null,o=!u,r=(generated_username=pgGenerateUsername(),new PgToggleButtonMaker),t={username:{type:"text",name:"Username",value:u?u.username:generated_username,validate:function(e,t,n){var o=(n=null===n?"":n).trim();return s(o)},on_changed:function(e,t,n,o,r,a){s(n=null===n?"":n)||i(n)},on_fields_created:function(){u||i(generated_username)}},check_username:{type:"displayhtmlwithlabel",name:"&nbsp;",html:`<div class="pg-check-username"><span></span></div>`,on_field_updated:function(e,t){$check_username=t,n=t.find(".pg-check-username span"),t.find(".pg-check-username .spin"),pg$Hide($check_username)}},username_label:{type:"displayhtmlwithlabel",name:"&nbsp;",html:pgf.kids?`Although all information and projects are private by default, it is a good idea that the username doesn't contain any personal information, including the name.`:`The username is used in the url of your profile: <code>pinegrowsites.com/@username</code>.`,field_style:"margin-top: 5px;"},generate_username:{type:"button",name:"Generate username",func:function(e,t){p.setFieldValue("username",pgGenerateUsername())}},new_password:{type:"text",name:"Password",value:u?"":pgGeneratePassword(),input_type:pgf.kids?"text":"password",field_style:"margin-top: 30px;",show_if:function(){return!0===o},validate:function(e,t,n){return(n=null===n?"":n).length<6?"Password should have at least six characters. Remember the new password so that you can use it on the login form.":0<=n.indexOf(" ")?"Password should not contain spaces.":void 0}},generate_password:{type:"button",name:"Generate password",func:function(e,t){p.setFieldValue("new_password",pgGeneratePassword())},show_if:function(){return!0===o}},old_password:{type:"text",name:"Password",value:h,disabled:!0,show_if:function(){return!1===o},field_style:"margin-top: 30px;",on_field_updated:function(e,t){t.find("input").attr("disabled","disabled")}},change_password:{type:"button",name:"Change password",func:function(e,t){o=!0,p.setFieldValue("new_password","")},show_if:function(){return!1===o}},name:{type:"text",name:"Name (optional)",value:u?u.name:"",field_style:"margin-top: 30px;"}},a=(pgf.kids&&(t.name_label={type:"displayhtmlwithlabel",name:"&nbsp;",html:`Use the name to identify the user within the family / class group. The name is never displayed publicly.`,field_style:"margin-top: 5px;"},t.avatar={type:"select",name:"Your alien",toggle_buttons:!0,value:u&&u.avatar?u.avatar:null,options:function(){for(var e=[],t=1;t<=15;t++)e.push({key:"alien"+t,name:"Alien "+t,html:r.makeImage("images/kids/alien"+t+".png")});return e}}),pgf.user_bio&&(t.bio={type:"text",name:"Bio",value:u?u.bio:"",textarea:!1,placeholder:"Something about you, displayed on your profile..."}),"pick_url"===pgf?.user_avatar&&(t.avatar={type:"image",name:"Profile image",value:u&&u.avatar?u.avatar:null,file_picker_dont_map_dom_to_source:!0}),d?"Edit your user profile":u?`Edit child account `+u.username:`Create new child account`),p=pinegrow.showQuickDialog(a,"Account information","",t,"Cancel","Save",null,function(n,o,r){var e,t,a;return l!==n.username?pinegrow.showQuickError("Please wait... We are still checking if the username is available."):c?(e=function(){var t=o.get$OKButton(),e=(t.html("Saving, please wait..."),t.attr("disabled","disabled"),pinegrow.backend.createStudent);(e=d?pinegrow.backend.saveUser:e)({username:n.username,password:n.new_password,name:n.name,avatar:n.avatar,id:u?u.id:null,bio:n.bio||null},function(e){r(),g.onUserSaved(e)},function(e){t.html("Save"),t.get(0).removeAttribute("disabled"),"existing_user_login"===e.error?(i(n.username),pinegrow.showQuickError("The username already exists.")):pinegrow.showQuickError("Oops... Something didn't go right: "+e.error)})},u&&u.username!==n.username?(t=`<p>Are you sure you want to change the username from <code>${u.username}</code> to <code>${n.username}</code>?</p><p>Changing the username will change URLs (internet addresses) of all their projects.</p>`,a=`Yes, save it`,d&&(t+=`<p>You will also need to login again after changing the username.</p>`,a="Yes, save it &amp; login again"),pinegrow.showAlert(t,"Change username?","Cancel",a,function(){},function(){e()})):e()):pinegrow.showQuickError("The username is not available. Please choose a different one."),!1})}},PgChildProfileView=function(t){var e=$('<div class="pg-profile-child"></div>'),e=new PgUIView(e);this.view=e;this.show=function(){var e;t&&!e&&(changed_password=`<p class="help-block"><a href="#" class="change-password">Change password</a>`),e&&(changed_password=`<p class="help-block"><a href="#" class="generate-password">Generate password</a>`)},e.onResize=function(){},e.onDestroy=function(){}},PgOnlineSubscribeView=function(e){var t=$('<div class="pg-profile-parent"></div>'),n=new PgUIView(t);this.view=n;this.show=function(){var e;e=``,e=(e+=`<h3 style="margin-top:0px;">Please chose your subscription plan</h3>`)+`<p>${pgf.product_name} is available as a monthly or annual subscription.<br>You can use it as long as your subscription is active.<br>You can cancel the subscription at any time.</p>

<div class="pg-kids-plan-grid">

    <bestvalue class="best-value" style="grid-area: n2;">
        <img src="images/kids/alien7.png">
    </bestvalue>

    <div class="plan-name" style="grid-area: n1;">Monthly plan</div>
    <div class="plan-name" style="grid-area: n2;">Annual plan <span>Best value</span>
    </div>

    <div class="plan-price" style="grid-area: p1;">
        <span class="regular"><price data-product="661354" data-price="full">USD 30</price> / month</span>
        <price data-product="661354">USD 15</price> / month <span class="tax">incl. tax</span>
      </div>
    <div class="plan-price" style="grid-area: p2;">
        <span class="regular"><price data-product="648133" data-price="full">USD 150</price> / year</span>
        <price data-product="648133">USD 75</price> / year <span class="tax">incl. tax</span>
      </div>

    <div style="grid-area: d1;">All lessons<br>Unlimited projects<br>Four children accounts</div>
    <div style="grid-area: d2;">All lessons<br>Unlimited projects<br>Four children accounts</div>

    <div class="plan-button" style="grid-area: b1;">
        <a href="#" class="btn subscribe-button pg-button pg-button-primary" data-product="661354">Subscribe!</a>
    </div>
    <div class="plan-button" style="grid-area: b2;">
        <a href="#" class="btn subscribe-button pg-button pg-button-primary" data-product="648133">Subscribe!</a>
    </div>
    
    <section class="promo">
        <h4>Special offer</h4>
        <ul>
            <li>Get 50% off your plan - forever!</li>
            <li>Includes 4 children accounts instead of just 2.</li>
        </ul>
    </section>

</div>
<p class="pg-kids-paddle-notice">Our order process is conducted by our online reseller Paddle.com. Paddle.com is the Merchant of Record for all our orders. Paddle provides all customer service inquiries and handles returns.</p>

`,t.html(e),t.on("click",".subscribe-button",function(e){e.preventDefault(),window.pgPaddleOnCheckoutComplete=function(e){pinegrow.showAlert(`<p>Please check your mailbox for email from ${pgf.product_name} with your account information.</p>`,`Thank you for subscribing to ${pgf.product_name}!`,null,"OK")},Paddle.Checkout.open({product:this.getAttribute("data-product")})})},n.onDestroy=function(){}},PgParentProfileView=function(o,i){function r(e){pinegrow.showAlert(`<p>Do you want to save lessons and projects that were completed in this browser before you created the account, to this user?</p><p>The local data can only be saved to one user.</p>`,"Save local data?","Cancel","Yes, save it",null,function(){pinegrow.backend.saveLocalUserDataToBackend(e,function(){pinegrow.showQuickMessage("User data saved."),pinegrow.backend.getProjects(),a()})})}var s=$('<div class="pg-profile-parent"></div>'),e=new PgUIView(s),l=(this.view=e,function(e){return e.avatar?pgf.kids?`<img class="pg-profile-table-avatar" src="images/kids/${e.avatar}.png">`:`<img class="pg-profile-table-avatar" src="${e.avatar}">`:""}),a=function(){var o=pinegrow.currentUser,r=(s.html("Getting information..."),pinegrow.backend.hasLocalUserData()),a=o.getMaxStudents();o.getStudents(function(e){var t=o.getUserData(),n=``;i?n+=`<div class="pg-dialog-notice"><p style="margin-bottom: 0;">Please complete the registration process by subscribing to a monthly or annual ${pgf.product_name} plan.</p></div>`:(n+=`<h3 style="margin-top:10px;">${__get("user.profile.main.h")}</h3>
<p>${__get("user.profile.main.desc")}</p>`,t.username,t.name&&(t.name,t.username),n+=`<table class="table table-striped"><thead><tr>
<td>Name</td>
<td>Email</td>
<td>Username</td>
<td>Password</td>
<td style="text-align:center;">Actions</td>
</tr></thead><tbody>`,[t].forEach(function(e){n+=`<tr data-user="${e.id}">
<td>${l(e)}${e.name}</td>
<td>${e.email}</td>
<td>${e.username}</td>
<td>${c[e.id]||'<span style="opacity:0.5;font-style:italic;">not shown</span>'}</td> 
<td style="text-align:center;"><a href="#" class="actions"><i class="icon icon-Editable"></i></a></td>
</tr>`}),n+=`</tbody></table>`,r&&(n+=`<div class="pg-dialog-notice"><p>${__get("user.profile.local.data.notice")}</p><p>
<button class="btn pg-button pg-button-primary" data-save-local="${t.id}">Save local data</button>
<button class="btn pg-button" style="margin-left:10px;" data-delete-local>Delete local data</button>
</p></div>`)),pgf.kids&&(n+=`<h3 style="margin-top:30px;">Children accounts</h3>`,"none"===t.product.plan?n+=`<p>After you subscribe to a subscription plan, you will be able to create accounts for up to ${a} children.<br><a href="mailto:kids@pinegrow.com" target="_blank">Get in touch</a> if you need more accounts for your family or school.</p>`:(n+=`<p>You can add accounts for up to ${a} children from your family.</p>`,e.length&&(n+=`<table class="table table-striped pg-profile-parent-children"><thead><tr>
<td>Name</td>
<td>Username</td>
<td>Password</td>
<td style="text-align:center;">Actions</td>
</tr></thead><tbody>`,e.forEach(function(e){e.username;e.name&&(e.name,e.username),n+=`<tr data-child-id="${e.id}">
<td>${l(e)}${e.name}</td>
<td>${e.username}</td>
<td>${c[e.id]||'<span style="opacity:0.5;font-style:italic;">not shown</span>'}</td> 
<td style="text-align:center;"><a href="#" class="actions"><i class="icon icon-down"></i></a></td>
</tr>`}),n+=`</tbody></table>`),a>e.length?n+=`<p><button class="btn pg-button pg-button-primary add-child">Add a new child</button></p>`:n+=`<p>0 children accounts are left.</p>`,n+=`<p><a href="mailto:kids@pinegrow.com" target="_blank">Get in touch</a> if you need more accounts for your family or school.</p>`)),n+=`<h3 style="margin-top:30px;">Your subscription plan</h3>`,"active"===t.product.plan&&(t.product.will_delete_on?n+=`<p>Your plan is <b>canceled</b>. The account and all its data will be deleted on <code>${new Date(1e3*t.product.will_delete_on).toLocaleDateString()}</code>.</p>`:(n+=`<p>Your subscription plan is <b>active</b>.</p>`,t.product.next_bill_date&&t.product.next_bill_amount&&(n+=`<p>Next payment: ${t.product.next_bill_amount} on ${new Date(1e3*t.product.next_bill_date).toLocaleDateString()}.</p>`),t.product.update_url&&(n+=`<p><a href="${t.product.update_url}" target="_blank" class="btn pg-button update-plan">Update payment method</a></p>`),t.product.cancel_url&&(n+=`<p><a class="btn pg-button cancel-plan">Cancel your plan</a></p>`))),s.html(n)})},c={};this.show=function(){a(),s.on("click","[data-save-local]",function(e){e.preventDefault();var t=$(this).attr("data-save-local");r(t)}),s.on("click","[data-delete-local]",function(e){e.preventDefault(),pinegrow.showAlert(`<p>Do you want to delete lessons and projects that were completed in this browser before you created the account?</p>`,"Delete local data?","Cancel","Yes, delete it",null,function(){delete localStorage["saved_projects"],delete localStorage["lessons"],pinegrow.showQuickMessage("Local data deleted."),a()})}),s.on("click",".subscribe-button",function(e){e.preventDefault(),window.pgPaddleOnCheckoutComplete=function(e){pinegrow.showAlert(`<p>Thank you for subscribing to ${pgf.product_name}!</p>`,"Thanks!",null,"OK"),pinegrow.backend.getProjects(function(){a()})};var t=pinegrow.currentUser.getUserData();Paddle.Checkout.open({product:648133,email:t.email})}),s.on("click",".cancel-plan",function(e){e.preventDefault();var t=pinegrow.currentUser.getUserData();pinegrow.showAlert(`<p>If you cancel the subscription your account will remain active until ${new Date(1e3*t.product.next_bill_date).toLocaleDateString()}.</p><p>After this day your account and all its data will be deleted.</p><p>Do you really want to cancel your ${pgf.product_name} subscription?</p><p><a href="${t.product.cancel_url}" class="btn pg-button pg-button-primary" target="_blank">Yes, I want to cancel my plan</a></p>`,"Are you sure you want to cancel your account?","Cancel",null)}),s.on("click","[data-user]",function(e){e.preventDefault();function t(){var e=new PgEditUserProfile(pinegrow.currentUser.getUserData(),!0);e.onUserSaved=function(e){e.reload_required?(pinegrow.currentUser.setUser(null),o.modal("hide"),pinegrow.getCurrentProject()?.forgetUnsavedChanges(),window.location.href=pgwpdata.edit_link+"?login=auto"):e.login_required?(pinegrow.currentUser.setUser(null),o.modal("hide"),pinegrow.getCurrentProject()?.forgetUnsavedChanges(),window.location.href="/wp-login.php?redirect_to="+encodeURIComponent(pgwpdata.edit_link)):a()},e.show()}var n=pinegrow.getCurrentProject();n&&n.hasUnsavedChanges()?pinegrow.showAlert(`<p>In some cases, the editor needs to be reloaded after changing the user settings. The current project has unsaved changes that would be lost. What would you like to do?</p>`,"The project has unsaved changes","Cancel","Save and continue",null,function(){pinegrow.backend.saveCurrentProject(function(){t()})},"Continue without saving",function(){t()}):t()}),s.on("click","[data-child-id] .actions",function(e){e.preventDefault();var o=this.closest("tr").getAttribute("data-child-id"),t=pinegrow.backend.hasLocalUserData(),n=[{label:`<a href="${crsaAppendQueryToUrl(location.href,["iuid="+o])}" target="_blank">Visit their planet</a>`,dont_handle_click:!0,action:function(){}},{label:"Edit user...",action:function(){pinegrow.currentUser.getStudentById(o,function(e){pinegrow.currentUser.editChildProfile(e,function(e){c[e.id]=e.password,a()})})}},{label:"Delete...",action:function(){pinegrow.currentUser.getStudentById(o,function(e){var t=e.username,n=(e.name&&(t=t+" / "+e.name),e.name||e.username);pinegrow.showPrompt(`<p>Are you sure you want to delete the child <b>${t}</b>?</p><p>All their projects and lessons will be deleted. This action can't be undone.</p><p>To confirm type <code>${n}</code> in the field and then click on the Delete button:</p>`,"Delete the user "+t+" and all their data?","","",null,function(e){pinegrow.showQuickMessage(`Deleting ${t}...`),pinegrow.backend.deleteStudent(o,function(){pinegrow.showQuickMessage(`User ${t} was deleted!`),a()})},"Cancel","Delete the user &amp; all their data",null,function(e){if(e!==n)return"The name does not match. Click Cancel to abort."})})}}],t=(t&&(n.push({type:"divider"}),n.push({label:"Save local data",action:function(){r(o)}})),$(this)),n=new CrsaContextMenu(n,t);return n.inModal=!0,n.showForElement(t),!1}),s.on("click",".add-child",function(e){e.preventDefault();var t=new PgEditUserProfile(null);t.onUserSaved=function(e){c[e.id]=e.password,a()},t.show()})},e.onResize=function(){},e.onDestroy=function(){}},PgCurrentUser=function(){function i(){var e;n.find("span").html(s.getName()),e=pgf.kids?`images/kids/${c.avatar||"alien1"}.png`:c.avatar||"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgaGVpZ2h0PSIxNiIgZmlsbD0iY3VycmVudENvbG9yIiBjbGFzcz0iYmkgYmktcGVyc29uLWZpbGwiIHZpZXdCb3g9IjAgMCAxNiAxNiI+CiAgPHBhdGggZD0iTTMgMTRzLTEgMC0xLTEgMS00IDYtNCA2IDMgNiA0LTEgMS0xIDFIM3ptNS02YTMgMyAwIDEgMCAwLTYgMyAzIDAgMCAwIDAgNnoiLz4KPC9zdmc+",n.find("img").attr("src",e)}var s=this,l={name:"Guest",level:0,email:"",student:!1,id:0,max_students:0},n=$(`<div class="pg-current-user"><img src="${pgf.kids?"images/kids/alien1.png":"data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw=="}"><span>User name</span><i class="icon icon-down"></i></div>`),c=l,p=(pinegrow.addEventHandler("on_toolbar_created",function(){isApp()||$("#crsa-topbar").append(n)}),pinegrow.addEventHandler("on_project_loaded",function(){s.canSaveProject()||s.showUnableToSaveNotice()}),this.registerForTrial=function(){var e=new PgRegisterForTrial;e.onUserSaved=function(e){},e.show()},this.isId=function(e){return c.id==e},this.isGuest=function(){return 0===c.level},this.isPGUser=function(){return pgf.allow_pg_license&&!!crsaStorage.getValue("crsaBig")},this.canOnlyUseLocalProjects=function(){return!this.isLoggedInAndActive()&&this.isPGUser()},this.canUseLocalProjects=function(){return this.isLoggedInAndActive()||this.isPGUser()},this.isUsername=function(e){return e===c.username},this.isChild=function(){return!0===c.student},this.isParent=function(){return!pgf.manage_account||!1===c.student},this.getMaxStudents=function(){return c.max_students||4},this.isAdmin=function(){return c.admin||!1},this.canPublishPublicProjects=function(){return"can_share"in pgwpdata?pgwpdata.can_share:this.isAdmin()||!pgf.kids},this.canEditProjectWithProjectId=function(e,t){var n=e.split("/");return t=t||c.username,2===n.length&&(t=n[0],e=n[1]),t===c.username},this.getName=function(){var e;return!this.isLoggedIn()&&this.isPGUser()?(e=crsaStorage.getValue("activatedUserEmail"))?e.split("@")[0]:"PG user":c.name||c.username},this.getUserData=function(){return c},this.settingsChanged=function(e){pinegrow.backend.saveUserSettingsDelayed(pgwpdata.user_settings,e)},this.getStudents=function(t){!c.children||1?pinegrow.backend.getStudents(function(e){c.children=e.users,t(c.children)}):t(c.children)},this.getStudentById=function(n,o){this.getStudents(function(e){for(var t=0;t<e.length;t++)if(e[t].id==n){o(e[t]);break}})},this.onlyForProNotice=function(e,t){"Pinegrow Online"===pgf.product_name?t?pinegrow.showAlert(`<p><b>Working with local projects</b> is not supported in the free version of Pinegrow Online.</p><p>Subscribe to a paid Pinegrow Online plan to unlock all features - or - activate the app with your <b>existing desktop Pinegrow Web Editor license</b> to edit local projects.</p>`,`Subscribe or activate with Pinegrow license to use this feature`,"Close","Subscribe to Pinegrow Online",null,pgf.buy_url,"Activate with Pinegrow license...",function(){showBuyScreen()}):pinegrow.showAlert(`<p><b>${e}</b> ${e.endsWith("s")?"are":"is"} not supported in the free version.</p><p>Login or signup to the paid plan to unlock all features, including ${e}.</p>`,`Please login or subscribe to Pinegrow Online to use this feature`,"Close","Subscribe to Pinegrow Online",null,pgf.buy_url):pinegrow.showAlert(`<p><b>${e}</b> ${e.endsWith("s")?"are":"is"} not supported in the free version of the Pinegrow plugin.</p><p>Upgrade to the Pro edition to unlock all features, including ${e}.</p><p>Do you already have the PRO license? <a href="${pgwpdata.settings_url}" target="_blank">Activate it here.</a></p>`,`Please upgrade to Pinegrow PRO to use this feature`,"Close","Buy Pinegrow PRO license",null,pgf.buy_url)},this.onlyForMembersNotice=function(e,t,n){var o=null,r=null,a=(t=t||`Sorry, only for ${pgf.product_name_short} subscribers`,n=n||"",this.isLoggedIn()||(o="Login",r=function(){s.showLoginForm()}),e);pgf.kids&&(a=`<p>Please subscribe to ${pgf.product_name_short} to ${e}.</p><p>Only the first <b>ten adventures</b> and up to <b>three projects</b> are available to visitors.</p>`),pinegrow.showAlert(n+a,t,"Cancel","Subscribe",null,function(){s.isLoggedIn()?s.editProfile(!0):s.showRegistrationForm()},o,r)},this.editProfile=function(e){var t=pinegrow.showAlert(`<div class="view"></div>`,e?"Choose your subscription plan":"Edit profile","Close",null,function(){n.view.destroy()}),n=new PgParentProfileView(t,e);t.find(".view").append(n.view.get$Element()),n.show()},this.editChildProfile=function(e,t){var n=new PgEditUserProfile(e);n.onUserSaved=t,n.show()},!1),u=!1,e=new URLSearchParams(window.location.search),d=e.get("login"),g=e.get("edit")||pgwpdata.edit_project||null,h=e.get("licenseEmail"),f=e.get("licenseSerial"),w="#logout-notice"===window.location.hash,o=(this.setUser=function(e,t){var n,o,r,a=c;if(e=e||l,t?$.each(e,function(e,t){c[e]=t}):c=e||l,i(),w)w=!1,history.pushState({},"",pgf.home_history_state),pinegrow.showAlert(`<p style="margin-bottom:180px;">Thank you for visiting ${pgf.product_name}!<br>Have a great day and see you soon!</p><img src="images/kids/alien13.png" style="width: 200px;
    position: absolute;
    right: 80px;
    bottom: 10px;">`,"You are signed out","Use as a guest","Sign back in",null,function(){v()});else{if(d){if(history.pushState({},"",pgf.home_history_state),"1"===d||"auto"===d&&!s.isLoggedIn())return v(),void(d=!1);d=!1}if(pgf.allow_pg_license&&h&&f&&(history.pushState({},"",pgf.home_history_state),showBuyScreen(h,f),f=h=null),g)return n=null,2===(o=(r=g).split("/")).length&&(n=o[0],r=o[1]),"tutorial"===n?void((o=pinegrow.tutorialsManager.getTutorialForLessonKey(r))?o.openLesson(r):pinegrow.showQuickError(`Tutorial lesson ${r} was not found.`)):(o=null,window.location.hash&&(o=window.location.hash.replace("#",""),isNaN(o))&&(o=null),pinegrow.backend.getManagerForProject(r).openProject(r,n,o),void(g=null));this.isLoggedInAndActive()?!u&&pgf.kids&&(r=Math.floor(15*Math.random())+1,pinegrow.showQuickMessage(`<span style="display:block;position:relative;padding: 1px;"><span style="top: 5px;
font-size: 20px;">Hi ${c.name||c.username}! Welcome to ${pgf.product_name}!</span><img src="images/kids/alien${r}.png" style="max-width: 200px; max-height:300px;
display: block;
margin: 0px auto 10px;"></span>`,5e3),u=!0):this.isLoggedIn()?this.isParent()&&this.editProfile(!0):0!==c.level||p?(a.level>c.level||a.id!==c.id)&&v():(m(),p=!0)}},this.isLoggedIn=function(){return 0<c.level},this.isLoggedInAndActive=function(){return pgf.manage_account?0<c.level&&c.product&&"active"===c.product.plan:0<c.level},this.isPro=function(){return pgwpdata.is_pro},this.canUploadImages=function(){return this.isLoggedInAndActive()},window.addEventListener("message",e=>{var t;e.data.action&&"pgUserLoggedIn"===e.data.action&&(pgwpdata.ajaxnonce=e.data.security,pgwpdata.preview_url=e.data.preview_url,pgwpdata.public_url=e.data.public_url,pgwpdata.can_share=e.data.can_share,pgwpdata.user_settings=e.data.user_settings,pgwpdata.pine_cone_tasks_url=e.data.pine_cone_tasks_url,pgwpdata.pine_cone_tasks_url&&pinegrow.pineCone&&pinegrow.pineCone.learnedTasks.library.load(pgwpdata.pine_cone_tasks_url),pinegrow.backend.getProjects(),o&&o.modal("hide"),o=null,t=pinegrow.getCurrentProject())&&t.hasUnsavedChanges()&&pinegrow.backend.saveDelayed(),e.data.action&&"pgUserRegistered"===e.data.action&&(pinegrow.backend.getProjects(function(){s.editProfile()}),o&&o.modal("hide"),o=null)},!1),null),v=this.showLoginForm=function(){var e=pgwpdata.login_url,t=pinegrow.showAlert(`<div class="w" style="height:580px;"></div>`,"Login"),n=t.find(".w");$(`<iframe src="${e}" style="height:100%;width:100%;border: none;"></iframe>`).appendTo(n).on("load",function(){}),t.find(".modal-footer").remove(),o=t},r=this.showRegistrationForm=function(){var e,t;pgf.kids?(t=pinegrow.showAlert(`<div class="view"></div>`,"Subscribe to "+pgf.product_name_short,"Close",null,function(){e.view.destroy()}),e=new PgOnlineSubscribeView(t),t.find(".view").append(e.view.get$Element()),e.show(),$.ajax({url:"https://checkout.paddle.com/api/2.0/prices",dataType:"jsonp",data:{product_ids:"661354, 648133"},success:function(e){e.response.products.forEach(function(o){t.find('price[data-product="'+o.product_id+'"]').each(function(e,t){var n=o.price.gross;t.hasAttribute("data-tax")&&(n=o.price.tax),"full"===t.getAttribute("data-price")&&(n*=2),t.innerHTML=o.currency+" "+n.toFixed(2).replace(".00","")})})}})):pinegrow.showAlert(`<p>${pgf.product_name_short} is currently in closed beta. Please <a href="/#subscribe-form" target="_blank">sign up to the waiting list</a> to get an account as soon as it is available.</p>`,"Not yet available","Close",null)},m=(n.on("click",function(e){e.preventDefault();var t=[];s.isLoggedIn()||(s.isPGUser()?(t.push({type:"header",label:"You are using your Pinegrow license"}),t.push({label:"License &amp; add-ons...",action:function(){showBuyScreen()}})):(t.push({type:"header",label:"You are not logged in"}),pgf.allow_pg_license&&t.push({label:"Activate with Pinegrow license",action:function(){showBuyScreen()}})),pgf.use_browser_storage&&!pgf.manage_account&&t.push({label:"Login...",action:function(){v()}}),pgf.manage_account&&(pgf.allow_pg_license&&(t.push({type:"divider"}),t.push({type:"header",label:"Use Pinegrow Online account"})),t.push({label:"Login...",action:function(){v()}}),t.push({label:"Subscribe...",link_url:pgwpdata?.buy_url||pgf.buy_url||"/#subscribe-form",dont_handle_click:!0,action:function(){r()}}))),pinegrow.getCurrentProject()&&pgf.kids&&(t.push({type:"divider"}),t.push({type:"header",label:"Workspace layout"}),t.push({label:"Large screen (4 columns)",action:function(){var e=pinegrow.isHiddenUIPanel("info");pinegrow.showWorkspace("default"),e&&pinegrow.hideUIPanel("info"),pinegrow.getAllPages().forEach(function(e){e.refresh()})}}),t.push({label:"Small screen (3 columns)",action:function(){var e=pinegrow.isHiddenUIPanel("info");pinegrow.showWorkspace("small"),e&&pinegrow.hideUIPanel("info"),pinegrow.getAllPages().forEach(function(e){e.refresh()})}}));pinegrow.getCurrentProject()&&(t.push({type:"divider"}),t.push({label:"Projects Dashboard",action:function(){pinegrow.backend.saveAndCloseCurrentProject()},link_url:pgf.home_history_state})),s.isLoggedIn()&&(t.push({type:"divider"}),s.isParent()&&pgf.manage_account&&(t.push({label:"View your profile",action:function(){location.href=pgwpdata.public_url},link_url:pgwpdata.public_url,dont_handle_click:!0,open_in_same_win:!1,helptext:"View your profile."}),t.push({label:"Edit your account...",action:function(){s.editProfile()}}),t.push({type:"divider"})),pgf.manage_account?t.push({label:pgf.kids?"Logout and return to Earth":"Logout",action:function(){location.href=pgwpdata.logout_url||"/logout"},link_url:pgwpdata.logout_url||"/logout",dont_handle_click:!0,open_in_same_win:!0}):(t.push({label:"WordPress Dashboard",action:function(){location.href=pgwpdata.admin_url},link_url:pgwpdata.admin_url,dont_handle_click:!0,open_in_same_win:!0,helptext:"Open WordPress dashboard. Right-click for option to open in new tab."}),t.push({label:"Visit site",action:function(){location.href=pgwpdata.public_url},link_url:pgwpdata.public_url,dont_handle_click:!0,open_in_same_win:!0,helptext:"Visit the site. Right-click for option to open in new tab."})));t=new CrsaContextMenu(t,n);return t.allowRightClick=!0,t.showForElement(n,null,8),!1}),function(){});this.canSaveProject=function(){return 0!==c.level},this.showUnableToSaveNotice=function(){},this.wrongUserInBackendCall=function(e){pinegrow.showQuickError("LOGIN NEEDED")},i()},PgBackend=function(t){function b(e,t){var n;return"string"==typeof e?n=e:(n=(e.projectSaveKey||e.getUrl()).replace("https://","")).endsWith("/")&&(n=n.substring(0,n.length-1)),n=t?t+"/"+n:n}function y(){return!pgf.use_browser_storage||pinegrow.currentUser.isLoggedInAndActive()}function n(e){var t=pinegrow.getCurrentProject();isAppForProject(t)||(k("has-changes"),t.wasChanged(),g(t)&&j.run("save",function(){P.saveCurrentProject()},1e4))}var j=new PgDelayedTasks,P=this,S=(this.impersonated_user_id=null,!1),e=new URLSearchParams(window.location.search).get("iuid"),r=(e&&(this.impersonated_user_id=e),this.progressScreen=new PgProgressScreen,$(`<li class="pg-api-progress-indicator">
<span class="saved-lesson">Continued</span>
<span class="has-changes">Save</span>
<span class="doing">Saving...</span>
<span class="done">Saved!</span>
<span class="error">Oops...</span>
<span class="revision">Revision</span>
</li>`)),o=(isApp()||pinegrow.addEventHandler("on_toolbar_created",function(){$("#main-navbar ul.nav").append(r),addTooltip(r.find(".saved-lesson"),`You are continuing a saved ${pgf.lesson_name}. Use Menu → Restart to restart it.`,{placement:"bottom"})}),null),l=function(e){return e&&e.fsHandle?o=o||new PgBackendProviderFileSystem:t||null},a=null,k=this.setIndicatorState=function(e,t){var n=pinegrow.getCurrentProject()||t,o=(!n||!n.loaded_revision_info||"has-changes"!==e&&"none"!==e||(e="revision"),r.find(`span:not(.${e})`).hide(),r.find(`span.`+e));"has-changes"===e&&(g(n)?o.addClass("auto-save-on"):o.removeClass("auto-save-on")),o.show(),n&&"revision"===e&&o.html("Restore revision "+new Date(1e3*n.loaded_revision_info.time).toLocaleString()),"none"===a&&a!==e&&arrangeTopBarSizes(),"done"===(a=e)&&(gsap.set(o.get(0),{opacity:1}),gsap.to(o.get(0),{opacity:0,duration:2,delay:2}))},i=(k("none"),r.find(".has-changes,.error").on("click",function(e){e.preventDefault(),P.saveCurrentProject()}).on("contextmenu",function(e){var t=[{label:"Auto save",check:u,action:function(){d(!u)}}],n=$(this);return new CrsaContextMenu(t,n).showForElement(n,null,8),!1}),r.find(".revision").on("click",function(e){e.preventDefault();var t=pinegrow.getCurrentProject(),n=t.url,o=t.isLoadedFromAnotherUser;t.loaded_revision_info&&pinegrow.showAlert(`<p>Are you sure you want to restore this project revision, created by <code>${t.loaded_revision_info.user}</code>on <code>${new Date(1e3*t.loaded_revision_info.time).toLocaleString()}</code>?</p><p>The current version of the project will be overwriten by this project revision. There is no undo.</p>`,"Restore the revision?","Cancel","Yes, restore the revision",null,function(){P.restoreProjectRevision(t.loaded_revision_info.id,function(){pinegrow.closeCurrentProject(null,!0,function(){pinegrow.tutorialsManager.openProject(n,null,o)})})})}),this.getProjectId=b,this.saveAsNewProject=function(e,t,n){S=!0,this.saveProject(e,n,t,!0,"project")},this.getProjectInfoByUrl=function(e,t){t(JSON.parse(localStorage.getItem("project_list")||"{}")[e]||null)},this.registerTrialUser=function(e,t,n){U("apiRegisterTrialUser",e,function(e){e.status&&"ok"===e.status?t&&t():n&&n("Something went wrong")},function(e){n&&n(e.error)})},{getPurePid:function(e){return e},canRemoveFromStartScreen:function(e){return!1},removeFromStartScreen:function(e){},canSetImage:function(e){return!0},canRename:function(e){return!0},canDelete:function(e){return!0},canAlwaysEditProject:function(e){return!1},canSaveToLocal:function(e){return!0},openProject:async function(t,n,o){return new Promise(function(e){pinegrow.tutorialsManager.openProject("https://"+t,e,n,null,o)})}}),s=(this.getManagerForProject=function(e){var t={manager:i};return pinegrow.dispatchEvent("on_get_manager_for_project",null,e,t),t.manager},0),c=(this.shouldRefreshProjects=function(){return S||(new Date).getTime()-s>30*60*1e3},this.getProjects=function(o,e){U("apiGetProjects",{project_type:"project"},function(e){S=!1,s=(new Date).getTime(),pinegrow.currentUser.setUser(e.user),pinegrow.dispatchEvent("on_user_projects_received_from_backend_async",null,e,function(e){pinegrow.dispatchEvent("on_user_projects_received_from_backend",null,e),P.list_of_loaded_projects=e.projects,o&&o(e.projects)})},function(e){var n,t;400!==e.status&&e.status||y()||(S=!1,n={projects:[]},localStorage["saved_projects"]&&(t=JSON.parse(localStorage["saved_projects"]),$.each(t,function(e,t){"project"===t.project_type&&n.projects.push(t)})),t={},localStorage["lessons"]&&(t=JSON.parse(localStorage["lessons"])),n.lessons||(n.lessons={}),$.each(t,function(e,t){e in n.lessons||(n.lessons[e]=t)}),pinegrow.dispatchEvent("on_user_projects_received_from_backend_async",null,n,function(e){pinegrow.dispatchEvent("on_user_projects_received_from_backend",null,e),o&&o(e.projects)}))})},this.getPublicProjects=function(t){this.list_of_public_projects?t&&t(this.list_of_public_projects):U("apiGetPublicProjects",{},function(e){pinegrow.dispatchEvent("on_public_projects_received_from_backend",null,e.projects),P.list_of_public_projects=e.projects,t&&t(e.projects)},function(e){t&&t([])})},this.hasLocalUserData=function(){return localStorage["saved_projects"]||localStorage["lessons"]},this.saveLocalUserDataToBackend=function(e,t){var n={},o={},n={projects:n=localStorage["saved_projects"]?JSON.parse(localStorage["saved_projects"]):n,lessons:o=localStorage["lessons"]?JSON.parse(localStorage["lessons"]):o};S=!0,pinegrow.currentUser.isId(e)&&(e=null),U("apiSaveLocalUserData",n,function(e){delete localStorage["saved_projects"],delete localStorage["lessons"],t&&t()},null,e)},this.importProject=function(e,t,n){U("apiSaveLocalUserData",{lessons:[],projects:[e],is_upload:!0},function(e){t&&t(e)},n)},this.getNewProjectId=function(t,e,n){if(S=!0,y())var o=!1,r=(P.progressScreen.show(`Creating a new project...`,function(){o=!0,r&&r.abort()}),U("apiCreateProject",{name:e,source_project_id:n},function(e){P.progressScreen.hide(),o&&pinegrow.showAlert("Even though you cancelled the operation in the browser, a new project was created on the back-end. Delete the project if you do not wish to keep it.","The project was created."),t("https://"+e.project_id,e.project_id,e.project_name,e.export_nonce||null)},function(){P.progressScreen.hide()}));else{for(var a={},i=(localStorage["saved_projects"]&&(a=JSON.parse(localStorage["saved_projects"])),1);a["local_project_"+i];)i++;var s="local_project_"+i;this.progressScreen.hide(),t&&t("https://"+s,s,e+" "+i)}},this.loadProject=function(n,t,o,e,r){function a(e){$.each(e.urls,function(e,t){crsaIsAbsoluteUrl(e)||(n.setContentOfUrl(e,t.content),t.thumb&&n.setThumbnailOfUrl(e,t.thumb),n.setVersionForUrl(e,t.version))}),n.isLoadedFromServer=l,o&&pinegrow.currentUser.isUsername(o)&&!n.isCreatedWithNewProject&&(o=null),n.isLoadedFromAnotherUser=o,n.isLoadedFromBackupId=n.projectLoadKeyIfNotFound&&e.loaded_project_id===n.projectLoadKeyIfNotFound,n.inject_css=e.inject_css||null,n.name=e.name||l,n.source_project_id||(n.source_project_id=e.source_project_id||null),pgf.kids&&!pinegrow.currentUser.isAdmin()&&"public"===e.access_view&&(e.access_view="private"),n.access_view=e.access_view||"private",n.access_clone=e.access_clone||"",n.view_mode=e.view_mode||"",n.project_tags=e.tags||[],n.project_tags_changed=!1,n.category=e.category||null,n.meta=e.meta||{},n.loaded_revision_info=e.loaded_revision_info||null,n.revisions=e.revisions||null,n.project_current_version=e.current_version||0,n.loaded_revision_info&&k("revision",n),n.export_nonce=e.export_nonce||null,n.project_lib_url=e.project_lib_url||null}var i,s=!1,l=b(n);y()||o||n.fsHandle?(this.progressScreen.show(e||`Loading project ${n.name}...`,function(){s=!0,window.parent&&window.parent.postMessage({action:"pgProjectClosed"},"*")}),U("apiLoadProject",{project_id:l,project_id_if_not_found:n.projectLoadKeyIfNotFound||null,project_user_slug:o||null,load_optional:!n.isCreatedWithNewProject,revision_id:r||null},function(e){s||(P.progressScreen.hide(),e&&a(e),t&&t())},function(e){P.progressScreen.hide(),s||(404===e.status&&n.lesson?t&&t():(pinegrow.showQuickError(e.error),window.parent&&window.parent.postMessage({action:"pgProjectClosed"},"*")))},null,n)):(l=l.replace("https://","").replace("/",""),i={},(i=localStorage["saved_projects"]?JSON.parse(localStorage["saved_projects"]):i)[l]&&(i=i[l],a(i)),t&&t())},this.loadSourceProject=function(e,t){var n=new CrsaProject;n.url=e,n.root=new CrsaFile,n.root.isFile=!1,n.root.name=e,n.root.url=e,this.loadProject(n,function(){t(n)},null,`Loading templates...`)},this.withSourceProject=function(t,n){t.source_project?n(t.source_project):t.source_project_id?this.loadSourceProject(t.source_project_id,function(e){t.source_project=e,n(e)}):n(null)},this.deleteFile=function(e,t,n){U("apiDeleteFile",{id:e},t,n)},this.uploadFile=function(e,t,n,o,r,a){var i=new FormData;i.append("file",e),i.append("action","pinegrow_apiUploadFile"),i.append("security",pgwpdata.ajaxnonce),i.append("project_id",a?null:b(pinegrow.getCurrentProject())),P.impersonated_user_id&&i.append("iuid",P.impersonated_user_id),r&&i.append("folder",r),$.ajax({xhr:function(){var e=new window.XMLHttpRequest;return e.upload.addEventListener("progress",function(e){var t;e.lengthComputable&&(t=e.loaded/e.total*100,o)&&o(t)},!1),e},url:pgwpdata.ajaxurl,type:"post",contentType:!1,processData:!1,data:i,success:t,error:n})},this.uploadProjectLib=function(e,t,n,o){var r=new FormData;return r.append("action","pinegrow_apiSaveProjectLib"),r.append("security",pgwpdata.ajaxnonce),r.append("project_id",b(pinegrow.getCurrentProject())),r.append("lib",e),P.impersonated_user_id&&r.append("iuid",P.impersonated_user_id),$.ajax({xhr:function(){var e=new window.XMLHttpRequest;return e.upload.addEventListener("progress",function(e){var t;e.lengthComputable&&(t=e.loaded/e.total*100,o)&&o(t)},!1),e},url:pgwpdata.ajaxurl,type:"post",contentType:!1,processData:!1,data:r,success:t,error:n})},this.uploadFilesWithDialog=function(p,u,d){var o=["image/jpeg","image/png","image/jpg","image/gif"],e=(pinegrow.currentUser.isAdmin()&&(o.push("image/svg"),o.push("image/svg+xml")),p=$.extend({},{global:!1,folder:null,allowed_types:o,text:`<p>Choose one or more #ALLOWED files and click Upload. Images will be uploaded into the WordPress media library.</p>`,button_label:"Upload images",text_no_files:"Please select one or more files.",file_control:null},p||{}),(o=p.allowed_types).map(function(e){var t=e.split("/")[1];return 0<=t.indexOf("+")?null:t}).filter(function(e){return null!==e})),r=(pgCloseContextMenus(),"<code>"+e.join("</code>, <code>")+"</code>"),g=pinegrow.showAlert(p.text.replace("#ALLOWED",r)+`<form enctype="multipart/form-data" style="margin-bottom: 30px;"><input type="file" class="file" name="file" multiple /></form>`,p.button_label,"Close","Upload",null,function(){var i=p.file_control||g.find("input.file").get(0);if(g.find(".error").remove(),i.files.length<1)pinegrow.showQuickError(p.text_no_files);else{function s(e,t){t?g.find(`[data-file="${n.name}"]`).append(" "+e).removeClass("alert-info").addClass("alert-error"):g.find(".modal-body").prepend($(`<div class="error alert alert-danger">${e}</div>`))}for(var l=0,c=!1,e=0;e<i.files.length;e++){var n=i.files[e],t=n.type;if(o.indexOf(t)<0)return s(`Only ${r} can be uploaded.`),!1}g.find("button.ok").attr("disabled","disabled").html("Uploading...");for(e=0;e<i.files.length;e++)!function(n){function o(e,t,n){a.css("width",e+"%"),t&&r.find("span").html(`<b> ${t}</b>`),n&&r.removeClass("alert-info").addClass("alert-success")}var r=$(`<div data-file="${n.name}" class="pg-upload-file-item error alert alert-info" style="margin-top:10px;margin-bottom: 10px;"><div class="upload-progress"></div><p>Uploading ${n.name}....<span></span></p></div>`),a=(g.find(".modal-body").append(r),r.find(".upload-progress"));o(0),pinegrow.backend.uploadFile(n,function(e){var t;l++,e.data.error?(s(`The file could not be uploaded. `+e.data.error,n.name),c=!0):(u&&u(e.data),g.find(`[data-file="${n.name}"]`),o(100,"Done.",!0),l>=i.files.length&&!c&&(g.modal("hide"),d)&&d(),p.global||(t=pinegrow.getCurrentProject(),e.data.file&&(t.setContentOfUrl(e.data.file.source_url,e.data.file.content),t.addSourceUrlToDOMUrlMap(e.data.file.source_url,e.data.file.mapped_url),pinegrow.refreshCurrentProjectDelayed(!0))))},function(e){l++,s(`The file could not be uploaded. `+e,n.name),c=!0},function(e){o(e,100===e?"Processing...":"")},p.folder,p.global)}(i.files[e])}return!1});p.file_control&&(g.find("input.file").hide(),g.find("button.ok").trigger("click"))},!1),U=function(t,e,n,o,r,a){e.project_id&&e.project_id.startsWith("http")&&console.error("Wrong project id",e.project_id);var i={action:"pinegrow_"+t,pinegrow_api_call:!0,security:pgwpdata.ajaxnonce,data:e,iuid:r||P.impersonated_user_id},s=(pgIsDev()&&console.log(`callApi `+t,i),l(a));return s?s.callApi(t,e,n,o,a):$.post(pgwpdata.ajaxurl,i,function(e){pgIsDev()&&console.log(`callApi ${t} response`,e),e.success?(e.data.security&&(pgwpdata.ajaxnonce=e.data.security),e.data.preview_url&&(pgwpdata.preview_url=e.data.preview_url),console.log(e.data),n&&n(e.data)):(e.data?console.log(e.data.error):console.log("AJAX ERROR: no response"),o&&o(e.data||{})),c=!1}).fail(function(e){403!==e.status&&400===e.status&&(t=pinegrow.currentUser.isLoggedIn(),pinegrow.currentUser.setUser(null),t||c)&&pinegrow.currentUser.showLoginForm(),c=!1;var t={};(t=e&&e.responseJSON&&e.responseJSON.data?e.responseJSON.data:t).status=e.status,o&&o(t)})},p=(this.isFileNameAllowed=function(e,t){var n,o;return!(!isApp()&&(n=["html","css","scss","json","jpg","jpeg","gif","png"],(pinegrow.currentUser.isAdmin()||1)&&n.push("svg","js"),pgf.allow_php_files&&n.push("php"),!(o=crsaGetExtFromUrl(e))||n.indexOf(o.toLowerCase())<0))||(t&&(t.reason=`Only files of types ${n.join(", ")} are allowed.`),!1)},this.saveProject=function(o,t,e,r,n,a,i){a||j.cancel("save"),S=!0,pinegrow.dispatchEvent("on_before_save_backend_project",null,o);function s(e,t,n){return e=o.mapSourceUrlToDOMUrl(e),"a"===n.tagName&&"href"===t&&pgf.kids?!crsaIsAbsoluteUrl(e)&&e.indexOf(".html")&&(e="__PROJECTBASE__"+(e=(e=e.replace(".html","")).startsWith("/")?e:"/"+e)):"link"===n.tagName&&"stylesheet"===n.getAttribute("rel")?crsaIsAbsoluteUrl(e)||(e+="?ver=__PROJECT_VERSION__"):"script"!==n.tagName||crsaIsAbsoluteUrl(e)||(e+="?ver=__PROJECT_VERSION__"),e}var l,c,p,u,d,g,h,f,w=o.page_set_changed||!1,v={name:escapeHtmlCode(o.name||o.url),urls:{},inject_css:o.inject_css||null,access_view:o.access_view||"private",access_clone:o.access_clone||!1,category:o.category||null,meta:o.meta||{},view_mode:o.view_mode||null,delete_other_pages:w||null,restore_to_revision_id:i||null},m=(w&&(r=!0),[]),_=[];pinegrow.getAllPages().forEach(function(e){var t;e.changed&&(t=o.getRelativeUrl(e.url),v.urls[t]={name:e.name,content:e.getCodeForSave(),view_content:function(){return o.getViewCodeForSave(e.url,s)},old_url:e.renamedFromOriginalUrl||null},_.push(e),e.savedRevision=o.getRevision(),m.push(function(){e.savedRevision===o.getRevision()&&e.setPageChanged(!1)}))}),pinegrow.getStylesheets().forEach(function(e){var t,n;e.loaded&&e.url&&(e.changed||r)&&(t=o.getRelativeUrl(e.url),crsaIsAbsoluteUrl(t)||(e.getCssSource(function(e){n=e}),v.urls[t]={name:e.url,content:n,view_content:function(){return o.getViewCodeForSave(e.url)},old_url:e.renamedFromOriginalUrl||null},_.push(e),e.savedRevision=o.getRevision(),m.push(function(){e.savedRevision===o.getRevision()&&(e.changed=!1)})))}),o.db&&(o.db.is_changed||r)&&(v.urls[c="projectdb.pgml"]={name:c,content:o.db.getHTMLSource(),view_content:null}),o.changed_setting_files.length&&(o.changed_setting_files.forEach(function(t){o.getContentOfUrl(t,function(e){v.urls[t]={name:t,content:e}})}),o.changed_setting_files=[]),o.getFilesWithContent().forEach(function(t){var n=o.getRelativeUrl(t.url);crsaIsAbsoluteUrl(n)||(r||t.old_url)&&(o.getContentOfUrl(t.url,function(e){v.urls[n]||(v.urls[n]={name:t.name,content:e,view_content:function(){return o.getViewCodeForSave(t.url,s)},old_url:t.renamedFromOriginalUrl||null})},!0),_.push(t))}),$.each(v.urls,function(e,t){var n=o.getVersionForUrl(e);t.save_if_version_leq=n,t.version=++n,o.setVersionForUrl(e,n)}),$.each(v.urls,function(e,t){"function"==typeof t.view_content&&(t.view_content=t.view_content())}),v.urls["_info.html"]&&((c=new pgParser).assignIds=!1,c.parse(v.urls["_info.html"].content),l={},p=(c=c.rootNode.findOne("body")).findOne("h1"),u=c.findOne("p.lead"),p&&(l.title=p.html(),p.remove()),u&&(l.excerpt=u.html(),u.remove()),l.content=c.html(),v.urls["_info.html"].info=l),!o.getContentOfUrl("index.html")&&0&&pinegrow.showAlert(`<p>Please note that every project needs a page named <code>index.html</code>. This page represents the main page of the project. Without it the project link will not work.</p><p>Use the project menu to create a new page called index.html.</p>`,"Warning - index.html is missing",null,"Got it!"),a?t&&t(v):(d=e||b(o),v.project_id=escapeHtmlCode(d),v.project_type=n||(o.isTutorialLesson()?"lesson":"project"),v.request_thumbs=o.requestThumbsOnNextSave||[],o.requestThumbsOnNextSave=[],v.delete_pages=o.deletePagesOnNextSave||[],o.project_tags_changed&&(v.tags=o.project_tags),v.current_version=o.project_current_version||0,v.force_version_overwrite=o.force_version_overwrite?1:0,k("doing"),g=o.getRevision(),h=function(){_.forEach(function(e){delete e.old_url})},y()||o.fsHandle?U("apiSaveProject",v,function(e){e.thumbs&&$.each(e.thumbs,function(e,t){o.setThumbnailOfUrl(e,t)}),e.generating_thumbs&&(o.requestThumbsOnNextSave||(o.requestThumbsOnNextSave=[]),e.generating_thumbs.forEach(function(e){o.requestThumbsOnNextSave.indexOf(e)<0&&o.requestThumbsOnNextSave.push(e)})),v.delete_pages.length&&pinegrow.refreshCurrentProjectDelayed(!0),o.deletePagesOnNextSave=[],o.project_tags_changed=!1,pinegrow.dispatchEvent("on_project_saved",null,o),k("done"),o.revisionWasSaved(g),o.isSavedToServer=!0,w&&(o.page_set_changed=!1),o.db&&(o.db.is_changed=!1),o.revisions||(o.revisions=[]),e.revision_info?o.revisions.unshift(e.revision_info):e.revisions&&(o.revisions=e.revisions),o.project_current_version=e.current_version,o.auto_save_off_because_invalid_version=!1,o.export_nonce=e.export_nonce||null,h(),o.hasUnsavedChanges()?k("has-changes"):k("done"),t&&t()},function(e){"OTHER_VERSION_SAVED"===e.error?(o.auto_save_off_because_invalid_version=!0,k("has-changes"),o.skip_asking_about_other_version_saved?o.skip_asking_about_other_version_saved=!1:setTimeout(function(){pinegrow.showAlert(`<p>The changes were not saved, because a newer version of the project was already saved.</p><p>Are you editing the project in multiple editing sessions?</p><p>Is somebody else editing the project right now?</p><p>You have two options:</p><ul>
    <li>Close the project, lose all unsaved changes and reopen the newer version.</li>
    <li>Force saving the changes and overwriting the project that was saved in another editing session.</li>
    </ul>`,"A newer version was already saved elsewhere","Force save","Close this notice",function(){o.force_version_overwrite=!0,P.saveCurrentProject(function(){o.force_version_overwrite=!1})},function(){})},10)):e.error&&pinegrow.showQuickError(e.error),k("error"),t&&t(e.error||"error")},null,o):(f={},(f=localStorage["saved_projects"]?JSON.parse(localStorage["saved_projects"]):f)[d]||(f[d]={}),$.each(v,function(e,t){"urls"===e?(f[d].urls||(f[d].urls={}),$.each(t,function(e,t){f[d].urls[e]=t})):f[d][e]=t}),o.db&&(o.db.is_changed=!1),o.deletePagesOnNextSave=[],o.project_tags_changed=!1,localStorage["saved_projects"]=JSON.stringify(f),h(),k("done"),t&&t()))},this.exportProject=function(e,t,n,o,r,a,i,s){var l,c,p,u;pgf.use_browser_storage&&!y()?(pinegrow.showAlert(`<p>Use WordPress menu -&gt; Download to download the ZIP with the exported project.</p><p>Install the Pinegrow WordPress Plugin to your WordPress site to export themes and plugins directly to your WordPress site.</p>`,"Exporting projects is disabled on Pinegrow Online"),s&&s()):(l={slug:t,project_type:n,files:{},loopback:r,export_nonce:e.export_nonce||null,with_log:a||!1,no_pg_check:i||!1},$.each(o,function(e,t){l.files[e]="string"==typeof t?{content:t,type:"text"}:{content:window.btoa(pgByteArrayToString(new Uint8Array(t))),type:"base64"}}),c=b(e),l.project_id=c,e.getRevision(),p=!1,r&&this.progressScreen.show(`<p>Exporting project ${e.name}...</p><div class="details">${r?`<p>If the plugin or theme is activate, we will try to load the site in order to see if the export did not accidentally break the site. This can take a while.</p><p>You can turn off this feature by disabling "Try loading the site after export" in the WordPress menu.</p>`:`<p>Note, test loading the site after export is disabled.`}</div>`,function(){p=!0,u&&u.abort()}),u=U("apiExportProject",l,function(e){r&&(P.progressScreen.hide(),p)&&pinegrow.showAlert("Even though you cancelled the operation in the browser, the project was still exported to the back-end.","The project was exported."),s&&s()},function(e){P.progressScreen.hide(),p&&!e.error&&(e.error="The export was cancelled"),s&&s(e.error||"Unknown error",e.loopback_not_working||!1)}))},this.getExportedProjectLog=function(e,t,n,o){var r={slug:t,project_type:n,files:{}},a=b(e);r.project_id=a,U("apiGetExportedProjectLog",r,function(e){o&&o(e)},function(e){pinegrow.showQuickError("Unable to fetch the log.")})},this.getExportLog=function(t){U("apiGetExportLog",{},function(e){t&&t(e)},function(e){pinegrow.showQuickError("Unable to fetch the log.")})},this.saveRemoteImage=function(e,t,n,o,r){var a={project_id:b(e),remote_url:t,local_url:n};U("apiSaveRemoteImage",a,function(e){o&&o(e)},function(e){r&&r(e)})},this.setProjectFeaturedImage=function(e,t,n){var o={image_id:t},r=b(e);o.project_id=r,S=!0,U("apiSetProjectFeaturedImage",o,function(e){n&&n()},function(e){n&&n("error")})},this.deleteProjectRevision=function(t,e,n){var o={project_id:b(t),revision_id:e};pinegrow.showQuickMessage("Deleting revision..."),U("apiDeleteProjectRevision",o,function(e){n&&n(),t.revisions=e.revisions,pinegrow.showQuickMessage("Revision deleted.")},function(e){n&&n("error"),pinegrow.showQuickError("Unable to delete revision.")})},this.deleteAllProjectRevisions=function(t,n){var e={project_id:b(t)};pinegrow.showQuickMessage("Deleting revisions..."),U("apiDeleteAllProjectRevisions",e,function(e){n&&n(),t.revisions=e.revisions,pinegrow.showQuickMessage("Revisions deleted.")},function(e){n&&n("error"),pinegrow.showQuickError("Unable to delete revisions.")})},this.getProjectEditUrl=function(e,t,n){var o=pgf.home_history_state;return o.endsWith(".php")||0<=o.indexOf("?")?o=crsaAppendQueryToUrl(o,[`edit=`+b(e,n)]):(o.endsWith("/")||(o+="/"),o+=b(e,n)),t&&(o+="#"+t),o},this.deletePages=function(t,e,n){t.deletePagesOnNextSave||(t.deletePagesOnNextSave=[]),e.forEach(function(e){e=t.getRelativeUrl(e),t.deletePagesOnNextSave.indexOf(e)<0&&t.deletePagesOnNextSave.push(e)}),this.cancelSaveDelayed(),this.saveProject(t,n)},this.getImages=function(t,n,e){U("apiGetImages",t,function(e){pinegrow.dispatchEvent("on_got_images_from_backend",null,t,e),n&&n(e)},e)},this.checkUsername=function(e,t,n){U("apiCheckUsername",{username:e,id:t},n)},this.getStudents=function(e){U("apiGetStudents",{},e)},this.createStudent=function(e,t,n){U("apiCreateStudent",e,function(e){t&&t(e)},n)},this.deleteStudent=function(e,t){U("apiDeleteStudent",{id:e},function(e){t&&t(e)})},this.saveUser=function(e,t,n){U("apiSaveUser",e,function(e){pinegrow.currentUser.setUser(e,!0),t&&t(e)},n)},this.saveCurrentProject=function(e,t){var n,o,r,a=!1,i=pinegrow.getCurrentProject();i.isSavedToServer&&!i.isLoadedFromBackupId&&!t||(a=!0),i.fsHandle&&!t&&(a=!1),h&&h.close(),isApp()?e&&e():i.isLoadedFromAnotherUser||i.isCreatedWithNewProject?(n=[],o=async function(){return new Promise(function(r){P.getNewProjectId(function(e,t,n,o){i.setUrl(e),i.isLoadedFromAnotherUser=!1,i.isCreatedWithNewProject=!1,i.name=n,i.export_nonce=o,$(".menu-current-project span").html(n),pinegrow.browserPreview.update(),pinegrow.dispatchEvent("on_project_renamed",null,i),P.saveProject(i,function(){pinegrow.showMode("Auto save",!0),P.askToRenameProject(i,function(){r(!0)},null,null,!1)},null,a)},i.name||"Project",i.source_project_id||null)})},pinegrow.currentUser.canUseLocalProjects()&&pgf.use_filesystem_api&&n.push({key:"local",name:pgf.project_destination.local.name,helptext:pgf.project_destination.local.description,order:pgf.project_destination.local.order,save:async function(){return await pinegrow.backend.getManagerForProject("local--").saveProjectAsLocal(null,!0)},icon:`<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-folder" viewBox="0 0 16 16">
  <path d="M.54 3.87.5 3a2 2 0 0 1 2-2h3.672a2 2 0 0 1 1.414.586l.828.828A2 2 0 0 0 9.828 3h3.982a2 2 0 0 1 1.992 2.181l-.637 7A2 2 0 0 1 13.174 14H2.826a2 2 0 0 1-1.991-1.819l-.637-7a2 2 0 0 1 .342-1.31zM2.19 4a1 1 0 0 0-.996 1.09l.637 7a1 1 0 0 0 .995.91h10.348a1 1 0 0 0 .995-.91l.637-7A1 1 0 0 0 13.81 4zm4.69-1.707A1 1 0 0 0 6.172 2H2.5a1 1 0 0 0-1 .981l.006.139q.323-.119.684-.12h5.396z"/>
</svg>`}),y()?n.push({key:"server",name:pgf.project_destination.server.name,helptext:pgf.project_destination.server.description,order:pgf.project_destination.server.order,save:o,icon:`<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-cloud" viewBox="0 0 16 16">
  <path d="M4.406 3.342A5.53 5.53 0 0 1 8 2c2.69 0 4.923 2 5.166 4.579C14.758 6.804 16 8.137 16 9.773 16 11.569 14.502 13 12.687 13H3.781C1.708 13 0 11.366 0 9.318c0-1.763 1.266-3.223 2.942-3.593.143-.863.698-1.723 1.464-2.383m.653.757c-.757.653-1.153 1.44-1.153 2.056v.448l-.445.049C2.064 6.805 1 7.952 1 9.318 1 10.785 2.23 12 3.781 12h8.906C13.98 12 15 10.988 15 9.773c0-1.216-1.02-2.228-2.313-2.228h-.5v-.5C12.188 4.825 10.328 3 8 3a4.53 4.53 0 0 0-2.941 1.1z"/>
</svg>`}):n.push({key:"browserStorage",name:"Browser storage",helptext:`Project will be saved in browser storage on this device. You will only be able to access it in this browser. Only use for quick prototyping and testing Pinegrow Online.`,order:3,save:o,icon:`<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-database" viewBox="0 0 16 16">
  <path d="M4.318 2.687C5.234 2.271 6.536 2 8 2s2.766.27 3.682.687C12.644 3.125 13 3.627 13 4c0 .374-.356.875-1.318 1.313C10.766 5.729 9.464 6 8 6s-2.766-.27-3.682-.687C3.356 4.875 3 4.373 3 4c0-.374.356-.875 1.318-1.313M13 5.698V7c0 .374-.356.875-1.318 1.313C10.766 8.729 9.464 9 8 9s-2.766-.27-3.682-.687C3.356 7.875 3 7.373 3 7V5.698c.271.202.58.378.904.525C4.978 6.711 6.427 7 8 7s3.022-.289 4.096-.777A5 5 0 0 0 13 5.698M14 4c0-1.007-.875-1.755-1.904-2.223C11.022 1.289 9.573 1 8 1s-3.022.289-4.096.777C2.875 2.245 2 2.993 2 4v9c0 1.007.875 1.755 1.904 2.223C4.978 15.71 6.427 16 8 16s3.022-.289 4.096-.777C13.125 14.755 14 14.007 14 13zm-1 4.698V10c0 .374-.356.875-1.318 1.313C10.766 11.729 9.464 12 8 12s-2.766-.27-3.682-.687C3.356 10.875 3 10.373 3 10V8.698c.271.202.58.378.904.525C4.978 9.71 6.427 10 8 10s3.022-.289 4.096-.777A5 5 0 0 0 13 8.698m0 3V13c0 .374-.356.875-1.318 1.313C10.766 14.729 9.464 15 8 15s-2.766-.27-3.682-.687C3.356 13.875 3 13.373 3 13v-1.302c.271.202.58.378.904.525C4.978 12.71 6.427 13 8 13s3.022-.289 4.096-.777c.324-.147.633-.323.904-.525"/>
</svg>`}),n.sort(function(e,t){return e.order-t.order}),r=async function(e){var t;return i.source_project_id&&((t=i.getProjectInfo()).setSetting("source-project-url",i.source_project_id),t.save()),pinegrow.showQuickMessage(`Saving to ${e.name}...`),e.save()},1===n.length?r(n[0]):pinegrow.showDialogMenu("Save the new project",`Where would you like to save the project?`,n.map(function(t){return{action:function(e){r(t),e()},label:t.name,desc:t.helptext,icon:t.icon}}))):this.saveProject(i,e,null,a)},null),u=(this.saveUserSettingsDelayed=function(e,t){p=e,j.run("settings",function(){P.saveUserSettings(e)},t?4e3:6e4)},this.saveUserSettings=function(e){pinegrow.saveSettingsOnBackend()&&U("apiSaveUserSettings",{settings:e},function(){p=null},function(){})},this.savePendingUserSettings=function(){p&&this.saveUserSettings(p),j.cancel("settings")},this.savePineConeTasks=async function(n){return new Promise(function(e,t){y()?U("apiSavePineConeTasks",{tasks:JSON.stringify(n)},e,t):(localStorage["pine_cone_tasks"]=JSON.stringify(n),pinegrow.showAlert(`<p>Learned tasks are stored in your browser's local storage because you are not logged in.</p><p>Subscribe to ${pgf.product_name_short} and log in to keep your saved tasks.</p>`,"You are not signed in - using local storage",null,"OK"),e())})},this.loadPineConeTasks=async function(e){var t;return e?e?(t=await pgFetchRemoteContent(e+"?z="+Date.now()),t=(new TextDecoder).decode(t),JSON.parse(t)):null:localStorage["pine_cone_tasks"]?JSON.parse(localStorage["pine_cone_tasks"]):null},this.restoreProjectRevision=function(e,t){this.saveProject(pinegrow.getCurrentProject(),t,null,!1,null,!1,e)},this.canCreateProject=function(){if(!y()){var e={},n=(localStorage["saved_projects"]&&(e=JSON.parse(localStorage["saved_projects"])),0);if($.each(e,function(e,t){e.startsWith("tutorial_")||n++}),pgf.kids&&3<=n)return pinegrow.currentUser.onlyForMembersNotice("create a new project"),!1}return!0},this.makePlaceholderProjectFromProjectId=function(e,t,n){return{root:{url:"https://"+e},isLoadedFromAnotherUser:t,name:n,getUrl:function(){return this.root.url},setUrl:function(e){this.root.url=e},is_placeholder:!0,setContentOfUrl:function(e,t,n){n&&n()},mapDOMUrlToSourceUrl:function(e){return e},addSourceUrlToDOMUrlMap:function(){}}},this.askToRenameProject=function(t,n,e,o,r){var a,i;e=e||`<p>Enter the new name for the project:</p>`,o=o||"Rename the project",(r=void 0===r?pgf.use_filesystem_api||!1:r)&&pinegrow.currentUser.canUseLocalProjects()&&(a="Save to local folder...",i=async function(){var e=await pinegrow.backend.getManagerForProject("local--").saveProjectAsLocal(null,!0);n&&n(!e)}),t.ask_to_rename_on_close=!1,r&&pinegrow.currentUser.canOnlyUseLocalProjects()?pinegrow.showAlert(`<p>Click on the ${a} button to save the project into a local folder on your computer.</p><p>Pinegrow Online account is required to save the project to the cloud.</p>`,"Save to a local folder","Cancel",a,function(){n&&n(!0)},i):pinegrow.showPrompt(e,o,t.name,"My Awesome Project",n,function(e){pinegrow.backend.renameProject(t,e,function(){$(".menu-current-project").show().find("span").html(t.name),n&&n(!1)})},"Keep the current name","Rename it",null,function(e){if(e!==t.name&&0===e.trim().length)return"Please enter a new name."},a,i)},this.renameProject=function(r,a,i){function e(){var n,e,t={},o=b(r);t.project_id=o,t.project_name=a,r.getUrl(),S=!0,y()||r.fsHandle?(r.ask_to_rename_on_close=!1,n=!1,P.progressScreen.show(`Renaming the project ${r.name} to ${a}...`,function(){n=!0,e&&e.abort()}),e=U("apiRenameProject",t,function(e){n&&pinegrow.showAlert("Even though you cancelled the operation in the browser, the project was renamed on the back-end. Rename the project back to the old name, if you do not wish to keep the new name.","The project was renamed.");var t="https://"+e.project_id;P.progressScreen.hide(),r.setUrl(t),r.name=e.project_name,r.export_nonce=e.export_nonce||null,r.is_placeholder||(pinegrow.browserPreview.update(),pinegrow.dispatchEvent("on_project_renamed",null,r)),i&&i(e)},function(e){P.progressScreen.hide(),i&&i("error")},null,r)):(t={},(t=localStorage["saved_projects"]?JSON.parse(localStorage["saved_projects"]):t)[o]&&(t[o].name=a),localStorage["saved_projects"]=JSON.stringify(t),r.name=a,i&&i())}!r.isLoadedFromAnotherUser&&!r.isCreatedWithNewProject||r.fsHandle?e():this.saveCurrentProject(e)},this.deleteProject=function(e,t){var n,o=b(e);S=!0,pinegrow.backend.cancelSaveDelayed(),y()?U("apiDeleteProject",{project_id:o},t):(n={},(n=localStorage["saved_projects"]?JSON.parse(localStorage["saved_projects"]):n)[o]&&delete n[o],localStorage["saved_projects"]=JSON.stringify(n),t&&t())},this.deleteProjects=function(e,t){var n;S=!0,y()?(e=e.map(function(e){return e.replace("https://","").replace("/","")}),U("apiDeleteProjects",{project_ids:e},t)):(n={},localStorage["saved_projects"]&&(n=JSON.parse(localStorage["saved_projects"])),e.forEach(function(e){n[e]&&delete n[e]}),localStorage["saved_projects"]=JSON.stringify(n),t&&t())},this.setLessonStatus=function(e,t,n){var o;y()?U("apiSetLessonStatus",{lesson_id:e.key,status:t},n):(o={},(o=localStorage["lessons"]?JSON.parse(localStorage["lessons"]):o)[e.key]=t,localStorage["lessons"]=JSON.stringify(o),n&&n())},this.setLessonStatusMultiple=function(e,t,n){var o;y()?U("apiSetLessonStatusMultiple",{lesson_ids:e.map(function(e){return e.key}),status:t},n):(o={},localStorage["lessons"]&&(o=JSON.parse(localStorage["lessons"])),e.forEach(function(e){o[e.key]=t}),localStorage["lessons"]=JSON.stringify(o),n&&n())},this.hasSavedProject=function(e,t){var n=b(e);t&&t(null!==localStorage.getItem(`project:`+n))},this.saveAndCloseCurrentProject=function(e,t,n){function o(){isApp()||window.location.pathname===pgf.home_history_state||history.pushState({},"",pgf.home_history_state),pinegrow.closeCurrentProject(null,!0,e),k("none")}var r,a,i=pinegrow.getCurrentProject();i?isAppForProject(i)?(n||pinegrow.saveAll(),pinegrow.closeCurrentProject(!1,!0,function(){e&&e()})):(r=!1,pinegrow.dispatchEvent("on_before_save_and_close_backend_project",null,i),a=(function(){this.progressScreen.show(`Saving project ${i.name}...`,function(){r=!0}),i.skip_asking_about_other_version_saved=i.auto_save_off_because_invalid_version||!1,this.saveCurrentProject(function(e){P.progressScreen.hide(),r||(e?pinegrow.showAlert(`<p>The project could not be saved.</p><p>Do you want to close it anyway? You will loose any unsaved changes.</p>`,"Could not save changes","Cancel","Yes, close the project",function(){},function(){o()}):o())})}).bind(this),!i.hasUnsavedChanges()||i.loaded_revision_info||n?o():!i.isLoadedFromAnotherUser&&!i.isCreatedWithNewProject&&u||t?a():pinegrow.showAlert(`<p>Do you want to save this project?</p>`,i.isLoadedFromAnotherUser||i.isCreatedWithNewProject?"Do you want to keep this project?":"Do you want to save changes","Cancel","Yes, save the project",function(){},function(){a()},"Don't save it",function(){pinegrow.backend.cancelSaveDelayed(),o()})):e&&e()},"1"===pinegrow.getSetting("auto-save-on","1")),d=function(e){u=e,pinegrow.setSetting("auto-save-on",e?"1":"0");var t=a;pinegrow.showMode("Auto save",u),u||P.cancelSaveDelayed(),k(t)},g=function(e){return!(!u||!(e=e||pinegrow.getCurrentProject())||e.auto_save_off_because_invalid_version||e.isLoadedFromAnotherUser||e.isCreatedWithNewProject||e.loaded_revision_info)},h=(this.isAutoSaveEnabled=g,null);this.saveDelayed=function(){n()},this.cancelSaveDelayed=function(){k("none"),j.cancel("save")},pinegrow.addEventHandler("on_page_changes_done",function(e){n(e.url)}),pinegrow.addEventHandler("on_css_stylesheet_changed",function(e,t){t.url&&n(t.url)}),pinegrow.addEventHandler("on_projectdb_changed",function(e){n()}),pinegrow.addEventHandler("on_project_loaded",function(e,t){(t.isLoadedFromAnotherUser||t.isCreatedWithNewProject)&&(n(),u)&&(h=new PgUIElementExplainer($(".pg-api-progress-indicator span:visible"),"Click Save to keep this project and turn on the auto save.",{show_delay:5e3,close_delay:1e4,focus:!1,position:"down",scroll_container:null,button:"Got it!",aaon_button_clicked:function(){pinegrow.backend.setLessonStatus({key:"intro.video.kids"},"done")},on_close:function(){h=null}}))}),pinegrow.addEventHandler("on_project_closed",function(e,t){h&&h.close(),P.savePendingUserSettings()}),this.collectMappedResources=function(n,o,e,r,t){function a(){e&&e()}var i,s={},l=0,c=pinegrow.getCurrentProject(),p=cloneObject(c.getMapForSourceToDOMUrls());t&&$.each(t,function(e,t){p[e]=t}),$.each(p,function(e,t){(!n||0<=n.indexOf(e))&&(s[e]=t,l++)}),0<l?(i=(new Date).getTime()+1e6*Math.random(),$.each(s,function(t,n){isApp()||(n=crsaAppendQueryToUrl(n,["z="+i])),pgFetchRemoteContent(n).then(function(e){l--;try{if(void 0===e)throw"Error getting remote file "+n;"image"===pinegrow.getSimpleMimeType(n)?o(t,e):o(t,(new TextDecoder).decode(e))}catch(e){console.log("Error getting remote file "+n,e),r&&r(n,e)}l<=0&&a()}).catch(function(e){console.log("Error getting file "+n,e),r&&r(n,e),--l<=0&&a()})})):a()}},PgBrowserPreview=function(){function n(e){var t=o(e);a[t]&&(e.sourceNode.findOne("body").toStringOriginal(),a[t].forEach(function(e){e.postMessage({action:"pgPageChanged"},"*")}))}var t,o=function(e,t){var n,o;return e?(o=(n=pinegrow.getCurrentProject()).getUrl().replace("https://",""),o=""+(t?pgwpdata.preview_url:pgwpdata.public_url)+o+`/`+n.getRelativeUrl(e.url),t&&(o+=`?z=`+Math.round(1e6*Math.random())),o):"/"},r=(this.getPreviewUrl=function(e){return o(e||pinegrow.getSelectedPage())},this.getPublicUrl=function(e){return e=e||pinegrow.getSelectedPage(),o(e).replace(pgwpdata.preview_url,pgwpdata.public_url)},this.getPublicUrlForProject=function(){var e=pinegrow.getCurrentProject().getUrl().replace("https://","");return""+pgwpdata.public_url+e+`/`},pinegrow.addEventHandler("on_toolbar_created",function(){t=$(".commands-toolbar .preview-link"),pgf.block_untrusted_js&&t.attr("rel","noopener"),t.on("click",function(e){var t=pinegrow.getCurrentProject();if(t.fsHandle)return e.preventDefault(),pinegrow.showAlert(`<p>To preview this local project locate the project folder on your computer and then open the HTML file in the browser.</p>`,"Previewing a local project",null,"OK"),!1;if(pgwpdata.preview_enabled)if(pinegrow.currentUser.isLoggedInAndActive()){if(t.isCreatedWithNewProject||t.isLoadedFromAnotherUser)return pinegrow.showAlert(`<p>Save the project and then preview it in the browser.</p>`,"The project is not saved yet"),!1;t.hasUnsavedChanges()&&(pinegrow.backend.isAutoSaveEnabled()?pinegrow.backend.saveCurrentProject():pinegrow.showQuickMessage("The project has unsaved changes. Save changes to preview the latest version."))}else e.preventDefault(),pinegrow.showAlert(`<p>You need to be signed in into your ${pgf.product_name_short} account to preview the page in the browser.</p>`,"Please subscribe to preview pages",null,"OK");else e.preventDefault(),pinegrow.showAlert(`<p>Previews require pretty permalinks structure. Currently, the permalink structure is set to plain. You can change this in the WordPress admin - Settings - Permalinks.</p>`,"Pretty permalinks are required",null,"OK")})}),this.update=function(e){(e=e||pinegrow.getSelectedPage())?pgwpdata&&pgwpdata.preview_url&&t.attr("href",o(e,!0)):t.attr("href","javascript:void(0);")}),a=(pinegrow.addEventHandler("on_page_selected",r),pinegrow.addEventHandler("on_project_renamed",function(e,t){r(pinegrow.getSelectedPage())}),pinegrow.addEventHandler("on_page_changes_done",r),{});window.addEventListener("message",e=>{"pgPageViewOpened"===e.data.action&&(a[e.data.url]||(a[e.data.url]=[]),a[e.data.url].push(e.source))},!1);pinegrow.addEventHandler("on_project_saved",function(e,t){pinegrow.getAllPages().forEach(n)}),pinegrow.addEventHandler("on_css_stylesheet_changed",function(e,t){})},PgProgressScreen=function(){var n,t=this,o=$(`<div class="pg-progress-screen">
<div class="name"></div>
<div class="buttons"><button class="pg-button cancel">Cancel</button></div>
<div class="animation"></div>
</div>`),r=o.get(0),a=(gsap.set(r,{opacity:0}),!1),i=null,s=null;o.find("button.cancel").on("click",function(e){e.preventDefault(),a||(i&&i(),t.hide())}),this.show=function(e,t){s&&clearTimeout(s),s=setTimeout(function(){s=null,i=t,o.find(".name").html(e),o.appendTo($("body")),n&&n.kill(),n=gsap.to(r,{opacity:1,duration:.5,onComplete:function(){n=null}})},750)},this.hide=function(){s?(clearTimeout(s),s=null):(i=null,n&&n.kill(),a=!0,n=gsap.to(r,{opacity:0,duration:.25,onComplete:function(){n=null,o.detach(),a=!1}}))}};class PgProjectDownloader{constructor(e){this.project=e||pinegrow.getCurrentProject()}canUserDownloadProject(){return!0}collectFiles(e){var o,r,a=this,i=0;this.files={},isApp()?(o={urls:{}},r=require("fs"),pinegrow.refreshCurrentProject(function(){a.project.walkThroughFiles(function(e){if(e.isFile){var t=a.project.getRelativeUrl(e.url);try{var n=new Blob([r.readFileSync(e.path)]);o.urls[t]={name:t,content:n},i+=n.size}catch(e){}}else if("_pgbackup"===e.name||"_pgexport"===e.name||"_pginfo"===e.name)return!1}),e&&e(o,i)},!0)):pinegrow.backend.saveProject(this.project,function(n){var o="",r=null,a=(pgwpdata.media_url&&(r=new RegExp(`(${escapeRegExp(pgwpdata.media_url)})([^\\s\\'\\"\\?\\#\\,\\)]+)`,"gm")),{});$.each(n.urls,function(e,t){r&&"string"==typeof t.content&&(t.content=t.content.replace(r,function(e,t,n){return a[n]=e,console.log(`MAP ${n} -> `+e),n})),o+=t.content+" ",i+=(t.content||"").length});pinegrow.backend.collectMappedResources(o,function(e,t){n.urls[e]={name:e,content:t,view_content:""},i+=t.size},function(){console.log(n),e&&e(n,i)},function(){},a)},null,!0,"project",!0)}createHeadlessZip(o,r){this.collectFiles(function(e,t){var n;r&&!1===r(t)||(JSZip.support.nodebuffer=!1,n=new JSZip,$.each(e.urls,function(e,t){n.file(decodeURI(e),t.content)}),n.generateAsync({type:"blob"}).then(function(e){o(e)}))})}saveToLocalFolder(i,a){this.collectFiles(async function(e,t){for(var n=Object.keys(e.urls),o=0;o<n.length;o++){var r=await(await async function(e,t){var n=e.split("/"),o=n.pop();let r=i;for(const a of n)r=await r.getDirectoryHandle(a,{create:t});return r.getFileHandle(o,{create:t})}(decodeURI(n[o]),!0)).createWritable();await r.write(e.urls[n[o]].content),await r.close()}a&&a(i)})}createAndDownloadZIP(e){var t,n=this;this.canUserDownloadProject()?(t=$("<p>Preparing the Zip file. Please wait...</p>"),showAlert(t,"Download project","Close",null),n.createHeadlessZip(function(e){t.html('<p>Project download is ready.</p><p><a class="pg-button" download="'+n.project.url.replace("https://","")+'.zip">Download the project ZIP file</a></p>'),t.find("a").attr("href",window.URL.createObjectURL(e))})):(pinegrow.currentUser.onlyForMembersNotice(`<p>Only registered users can download projects that use Interactions.</p>`),e&&e())}downloadExportedProject(e,t,n,o){var r,a=$("<p>Preparing the Zip file. Please wait...</p>"),i=(showAlert(a,"Download the exported "+t,"Close",null),JSZip.support.nodebuffer=!1,new JSZip);$.each(e,function(e,t){"string"==typeof t?i.file(e,t):i.file(e,window.btoa(pgByteArrayToString(new Uint8Array(t))),{base64:!0}),i.file(e,t)}),a.html('<p>Project download is ready.</p><p><a class="pg-button" download="'+n+'.zip">Download the ZIP file</a></p>'),r=a.find("a"),i.generateAsync({type:"blob"}).then(function(e){r.attr("href",window.URL.createObjectURL(e))})}uploadProject(c,p){var u=["html","js","css","pgml","json","svg","less","scss"],d=(pgf.allow_php_files&&u.push("php"),["jpg","jpeg","png","gif","webp"]),g=["ttf","woff","woff2"],h={"pgia/lib/pgia.js":!0},f=pinegrow.showAlert(`<p>Choose a ZIP file that contains the source HTML &amp; CSS project files (do not import WordPress themes and plugins or non-static HTML projects):</p><input type="file" class="file" name="file" aamultiple /><br><p>Supported file types are: <code>${u.concat(d).join("</code>, <code>")}</code>. Other files will be ignored.</p>
<div class="pg-dialog-notice"><p><b>IMPORTANT</b> - ${pgf.import_project_warning}</p></div>
`,"Import a project","Close","Import",null,function(e){$(e.target).html("Uploading... Please wait.").attr("disabled","disabled");var n=f.find("input.file").get(0);return n.files.length<1?pinegrow.showQuickError("Please select a ZIP file."):(JSZip.support.nodebuffer=!1,JSZip.loadAsync(n.files[0]).then(function(e){function r(e){var t=o.indexOf(e);0<=t&&o.splice(t,1),0===o.length&&(c&&c(),pinegrow.backend.importProject(l,function(e){pinegrow.backend.getProjects(),f.modal("hide"),p&&p(),pinegrow.showQuickMessage("Project imported."),e.projects.length&&pinegrow.tutorialsManager.openProject("https://"+e.projects[0],function(){pinegrow.backend.saveCurrentProject(null,!0)}),i.length&&pinegrow.showAlert(`<p>The project was imported, but some of the files were ignored.</p>${s?'<div class="pg-dialog-notice"><p>A note about using local webfonts: you can upload font files to the Media library and then add them to the project in Design panel -&gt; Manage fonts.</p></div>':""}
<table class="table table-striped"><thead>
<tr>
<td>Ignored file</td>
<td>Reason</td>
</tr>
</thead><tbody>${i.map(function(e){return"<tr><td>"+e.url+"</td><td>"+e.reason+"</td></tr>"}).join("")}</tbody></table>`)},function(e){pinegrow.showAlert(`<p>The project was not imported due to the error on the server:</p><p><code>${e.error}</code></p>`,"Oops... something went wrong")}))}var o=[],a=null,i=[],s=!1,t=(e.forEach(function(e,t){var n;!e.startsWith("__")&&!e.startsWith(".")&&e.indexOf("_pgexport")<0&&e.indexOf("_pgbackup")<0&&(t.dir?null===a&&(a=e):(n=crsaGetExtFromUrl(t.name),0<=u.indexOf(n)||0<=d.indexOf(n)?(t._data.uncompressedSize>4*1024*1024?i.push({url:e,reason:`Size ${(t._data.uncompressedSize/(1024*1024)).toFixed(1)}MB &gt; 4MB`}):o.push(t),a&&!e.startsWith(a)&&(a="")):(i.push({url:e,reason:"Not allowed"}),0<=g.indexOf(n)&&(s=!0))))}),n.files[0].name),l={name:t=t.replace(/(\(.*\)|\.zip)/g,""),project_id:pgMakeSlug(t,!1,"-"),project_type:"project",urls:{},images:{}};o.forEach(function(o){var e=crsaGetExtFromUrl(o.name),e=0<=d.indexOf(e);o.async(e?"base64":"text").then(function(e){var t=crsaGetExtFromUrl(o.name),n=o.name,t=0<=d.indexOf(t);null!==a&&""!==a&&(n=n.replace(a,"")),h[n]||(n=encodeURI(n),t?l.images[n]=e:l.urls[n]={name:n,content:e,view_content:e}),r(o)},function(e){r(o)})})},function(e){pinegrow.showQuickError("Error reading "+e.message)})),!1})}}