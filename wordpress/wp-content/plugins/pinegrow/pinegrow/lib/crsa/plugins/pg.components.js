$(function(){pgf.components&&$("body").one("pinegrow-ready",function(U,w){function n(){return w.isPRO()||w.isProTrialActive()}function N(e,t){return'<i class="icon icon-Editable"></i> '+(E(e.getAttr("data-pgc-field")||e.getAttr("data-pgc-edit")).name||"")}function L(e){var t=e.name,n=e.attrs;return e.content||n.push("no_content"),n.length&&(t+="["+n.join(", ")+"]"),t}function R(e,t,n,a,o){-1===t&&(t=o["data-pgc-edit"]),-1===n&&(n=o["data-pgc-edit-content"]),-1===a&&(a=o["data-pgc-edit-attrs"]);var i={name:t,content:"1"==n,attrs:null};i.attrs=a?a.split(","):[];for(var r=0;r<i.attrs.length;r++)i.attrs[r]=$.trim(i.attrs[r]);var s=L(i);e.attr(k.attribute,s)}function Q(e){return e.getAttr("data-pgc-save-partial-operation")||"save"}function s(d,u,g){var m=[],l={},p=[],f={},h={default:[]},b=["default"],e=d.getName(),_=w.findFrameworkByKey(e),v=!1;_||(_=new PgFramework(e,e),v=!0),_.loading_components=!0,d.forEachEditableFile(function(e,t,n,a){for(var o,i,r,s=ne(e,p,d),c=0;c<s.components.length;c++)s.components[c].type in l?n.warnings.push("Component <b>"+s.components[c].type+"</b> is <b>already defined</b> in "+d.getRelativePath(l[s.components[c].type].sourceFile)+"."):(m.push(s.components[c]),l[s.components[c].type]=s.components[c],o=s.components[c].add_to_section||"default",h[o]||(h[o]=[],b.push(o)),h[o].push(s.components[c]));s.master&&(s.master.file=e.getFileNode(),s.master.image=se(e,d),f[s.master.type]?n.warnings.push("Master page <b>"+s.master.type+"</b> is <b>already defined</b> in "+d.getRelativePath(f[s.master.type].file.path)+"."):f[s.master.type]=s.master),i=s.used_component_types.length,r=a,i?r.addTag(new CrsaFileTag("UseC","info","Components are used on this page","actions")):r.removeTag("UseC"),i=s.components.length,r=a,i?r.addTag(new CrsaFileTag("DefC","primary","Components are defined on this page","actions")):r.removeTag("DefC"),i=s.master,r=a,i?r.addTag(new CrsaFileTag("Master","primary","This is a master page.","24")):r.removeTag("Master"),i=s.use_master,r=a,i?r.addTag(new CrsaFileTag("UseMaster","info","This page uses the master page "+i+".","24")):r.removeTag("UseMaster"),e.setSyntaxErrorIndicator(e.sourceNode&&0<e.sourceNode.validateTree().length,a,d),d.updateTagsForFile(a),t(e,n)},function(){_.loading_components=!1,_.auto_updatable=!0,_.removeAllComponents(),_.master_pages=f,_.preview_images_base="previews";for(var e=0;e<m.length;e++)_.addComponentType(m[e]);for(e=0;e<b.length;e++){var t=new PgFrameworkLibSection(d.getName()+"."+b[e],"default"==b[e]?d.getName():b[e]);t.setComponentTypes(h[b[e]]),_.addLibSection(t)}v&&w.addFramework(_,-1e3);var n=(d.framework=_).project=d;if(n&&n.framework){var a=n.getProjectInfo().getSetting("project_resources"),o=n.framework;if(o.resources.clear(),a)for(var i=0;i<a.length;i++){var r,s=a[i].url,c=s,l=(crsaIsAbsoluteUrl(s)||(c=n.getAbsoluteUrl(s)),a[i].footer||!1),p="auto"==a[i].type?"":a[i].type;!p&&w.isFileEditable(c)&&(p="pinegrow/pagelib"),c&&(p&&"pinegrow/pagelib"==p?o.addPageLib({url:c,name:crsaGetNameFromUrl(c),selector:"*",framework:o}):((r=new PgComponentTypeResource(c)).footer=l,r.relative_url=s,r.source=c,p&&(r.type=p),o.resources.add(r)))}}g||w.frameworksChanged(),_.components_loaded=!0,w.showQuickMessage("Found "+m.length+" components in "+d.getName()+"."),u&&u(d,_)},"Looking for components...",null,Ee(d))}function v(e){if(e.startsWith("/"))try{return new RegExp(e.replace(/\//g,""),"")}catch(e){}return null}function H(e){var t;return w.makeChanges(e,"Clear saved unused edits",function(){e.sourceNode.withoutEvents(function(){t=ae(e.sourceNode)})}),t}function y(e,t){return t.component_fields&&e in t.component_fields?t.component_fields[e]:null}function W(e,t,n){var a;if(isApp()&&t)e?(a=V(e,t),n||!crsaIsFileExist(a)?w.takePhotoOfPage(e,a,function(){w.showQuickMessage("Screenshot updated successfully")}):w.showQuickMessage("Screenshot not updated")):w.showQuickMessage("You have to open the page in order to update the screenshot")}function q(e,t,n,a,o,i){T(e,t,n,a,o)&&(w.changeManager.didChangePage(e,"Apply master page"),i||e.refresh())}function V(e,t){var n=require("path"),a=crsaRemoveExtFromUrl(e.name)+".png",o=n.join(t.getDir(),"screenshots");return n.join(o,a)}function G(e,t){var n=new S;T(e,t,n,!0)&&(w.changeManager.didChangePage(e,"Restore optional areas"),e.refresh()),w.showQuickMessage("Optional areas restored")}function B(n){w.stats.using("components.gotodefinition"),n.sourceUrl?w.openOrShowPage(n.sourceUrl,function(e){w.setSelectedPage(e);var t=e.sourceNode.findOneWithAttrValue("data-pgc-define",n.type);t&&(w.selectElement(t,!0),t.scrollTo())},!1,!0):w.showQuickMessage("Sorry, don't know where the component is defined.",4e3,!1,"error")}function K(o,i){x.requireSelectedElement(function(t,a){function n(e){var t=o.definition_code,n=pgCreate(t);n.attr("data-pgc-define",e),canMakeChange(i?a.parent:a,"insert_element")&&w.makeChanges(a,"Duplicate definition",function(){i?n.insertAfter(a):a.append(n)}),w.selectElement(n,!0),w.showQuickMessage("Component definition duplicated."),u(!0)}w.showPrompt("<p>Enter the new component's id:</p>","Choose the unique id for the component",o.type,"",null,function(e){t.getTypeDefinition(e)?w.showAlert("Component definition with the id <b>"+e+"</b> already exists. Are you sure you want to use this id?","The id is not unique","Cancel","Use it!",function(){},function(){n(e)}):n(e)})})}var l,x=new PgFramework("pg.components","Components"),F=(w.addFramework(x),x.setScriptFileByScriptTagId("plugin-pg-components","lib/crsa/plugins/pg.components.js"),require("path")),Y=require("fs"),e=(x.detect=function(e){return!1},x.default=!0,x.has_actions=!0,x.show_in_manager=!1,x.order=1e3,[]),t=[],_=null,a=(w.insight.addHandler(function(e){a.master_pages=[],a.master_pages_changed=!0,a.component_types_map={},a.component_types_list=[]},function(e,t){return function(e,t,n){"html"==n.tagName&&n.hasAttr("data-pgc-set-master")&&z(t.name)}},function(e){a.master_pages_changed&&(a.master_pages.sort(),a.master_pages_changed=!1)}),{getMasterPages:function(){var t=[];return a.master_pages.forEach(function(e){t.push({key:e,name:e})}),t},getComponents:function(){var a=[],e=w.getSelectedPage();return e&&e.getFrameworks().forEach(function(n){n.components_loaded&&$.each(n.getComponentTypes(),function(e,t){t.is_smart_component&&a.push({key:t.type,name:t.type,html:t.type+(t.type!=t.name?" ("+t.name+")":"")+" <small>"+n.name+"</small>"})})}),w.insight.sortOptionsList(a),a},getEditableFieldsForElement:function(e){function t(n,a){n.component_fields&&$.each(n.component_fields,function(e,t){o.push({key:t.name,name:t.name,html:t.name+" <small>"+(a||"")+n.name+"</small>"})})}var n,a,o=[];return e&&(a=w.getCrsaPageOfPgParserNode(e),(n=Me(e,a))?t(n):(n=w.getCurrentProject())&&((a=P(a,n))?t(a,"master page "):o.push({key:"",name:"",html:"<small>Assign component or master page to see editable fields.</small>"})),w.insight.sortOptionsList(o)),o}}),z=(w.insight.ext.components=a,function(e){a.master_pages.indexOf(e)<0&&(a.master_pages.push(e),a.master_pages_changed=!0)}),g=new PgComponentType("pgc.define","Define component"),J=(g.short_name="Define component",g.selector="[data-pgc-define]",g.attribute="data-pgc-define",g.action=!0,g.not_main_type=!0,g.sections={"pgc.define.parameters":{name:"Options",fields:{"data-pgc-define":{type:"text",name:"Id",action:"element_attribute",attribute:"data-pgc-define",attribute_keep_if_empty:!0,validate:x.fieldIsRequired,placeholder:x.textForExample("my.poster"),options:function(){return w.insight.ext.components.getComponents()}},"data-pgc-define-name":{type:"text",name:"Display name",action:"element_attribute",attribute:"data-pgc-define-name",placeholder:x.textForExample("Poster")},"data-pgc-define-auto-update":{type:"checkbox",name:"Update instances",action:"element_attribute",attribute:"data-pgc-define-auto-update",value:"true",negvalue:"false",default_value:"true",on_changed:function(e,t,n,a,o,i,r,s,c){"false"==n?w.showQuickMessage("Component instances <b>will not</b> be updated when you run Components -&gt; Update.",3e3):w.showQuickMessage("Be careful, running Components -&gt; Update <b>will change</b> component instances.",4e3,!1,!0)}},"data-pgc-define-map-urls":{type:"checkbox",name:"Map urls",action:"element_attribute",attribute:"data-pgc-define-map-urls",value:"true",negvalue:"false",default_value:"true",helptext:`<p>Map urls if the component is used in another project location. For example link to index.html will become ../index.html if the component is used in a subfolder.</p>`},"data-pgc-define-description":{type:"text",name:"Description",action:"element_attribute",attribute:"data-pgc-define-description"},"data-pgc-define-photo-preview-only":{type:"checkbox",name:"Use photo only for preview",action:"element_attribute",attribute:"data-pgc-define-photo-preview-only",empty_attribute:!0,value:"true",helptext:"Use the photo only for preview, not for displaying component in the Insert panel."},"data-pgc-define-take-photo":{type:"button",name:"Take photo",helptext:"Capture the photo of the component and use it in the Insert panel and for preview.",func:async function(e,t,n,a,o,i){ee(e),de(e)}},"data-pgc-define-auto-create":{type:"button",name:'<i class="icon icon-wand"></i> Auto create',helptext:"Use the AI Assistant to automatically create an editable component.",func:async function(e,t,n,a,o,i){ye?(t.html('<i class="icon icon-wand"></i> Please wait...').attr("disabled","disabled"),await ye(e),w.selectedElements.reselect()):w.showQuickError("AI Assistant is not loaded.")}}}}},pgIsDev()&&pgf.smart_blocks&&(g.sections["pgc.define.parameters"].fields["data-pgc-define-extract-css"]={type:"text",name:"Extract CSS for selector",action:"element_attribute",attribute:"data-pgc-define-extract-css"},g.sections["pgc.define.parameters"].fields["data-pgc-define-extract-css-button"]={type:"button",name:"Extract CSS",func:function(e){(new PgApi).extractComponent(e,function(e){console.log(e)})}}),isApp()||delete g.sections["pgc.define.parameters"].fields["data-pgc-define-photo-preview-only"],x.addComponentType(g),e.push(g),g.meta={helptext:"Define Pinegrow component.<span class='more'> Disable <b>Update instances</b> if you do not want component instances to be updated with Components -&gt; Update. In that case you can update them manually with Actions -&gt; Update component.</span>",helplink:"https://pinegrow.com/docs/pinegrow-pro/components/"},1),k=(window.PgEditableAreaExtension=function(o,r,e){this.key=o,this.section={name:r,no_section_label:!0,fields:{}},this.framework=e;var s={},i={},c={},l={},p={},d={},u=(this.getValue=function(e,t){return c[e]?c[e](t):null},this.setValue=function(e,t,n){return i[e]?i[e](t,n):null},this.getProperty=function(e,t,n){return l[e]?l[e](t,n):null},this.canMakeChange=function(e,t,n,a){return p[e]?p[e](t,n,a):null},this.getSection=function(n,a){var o={name:r,no_section_label:!0,fields:{}},i=!1;return $.each(s,function(e,t){a&&d[e]&&!d[e](n,a)||(o.fields[u+e]=t,i||(t.start_section=r),i=!0)}),i?o:null},this.framework=null,"data-pgc-edit-ext-");this.addField=function(e,t){var n=t.fieldDefinition,a=(n.action||(n.action="element_attribute"),u+o+(e?"-"+e:"")),a=(n.attribute||(n.attribute=a),a.replace(u,""));s[a]=n,t.getValue&&(c[a]=t.getValue),t.setValue&&(i[a]=t.setValue),t.getProperty&&(l[a]=t.getProperty),t.canMakeChange&&(p[a]=t.canMakeChange),t.shouldShowField&&(d[a]=t.shouldShowField)},this.addFieldFromProp=function(e,t,o,n){var a;return"apply_class"!=o.action?(console.log("PgEditableAreaExtension.addFromProp - Only apply_class is supported!",o),null):((a={}).fieldDefinition={type:"checkbox",name:t,value:"1",empty_attribute:!0},n&&(a.shouldShowField=function(e,t){return t.isSelector(n)}),a.getValue=function(e){for(var t=0;t<o.options.length;t++)if(e.hasClass(o.options[t].key))return o.options[t].key;return null},a.setValue=function(e,t,n){for(var a=0;a<o.options.length;a++)t.removeClass(o.options[a].key),n&&n.removeClass(o.options[a].key);return t.addClass(e),n&&n.addClass(e),e},a.canMakeChange=function(e,t,n){if("add_class"==t||"remove_class"==t)for(var a=0;a<o.options.length;a++)if(n==o.options[a].key)return!0;return!1},a.getProperty=function(e,n){var t;if(n)return(t=$.extend({},o)).action="custom",t.get_value=function(e){return a.getValue(n)},t.set_value=function(e,t){return a.setValue(t,n,n.get$DOMElement())},t},this.addField(e,a),a)}},pgIsDev()&&pgf.smart_blocks&&((o=new PgComponentType("pgc.define.script","Define component script")).short_name="Define comp. script",o.selector="[data-pgc-define-script]",o.attribute="data-pgc-define-script",o.action=!0,o.not_main_type=!0,o.sections={"pgc.script.parameters":{name:"Options",fields:{"data-pgc-define-script":{type:"text",name:"Component id",action:"element_attribute",attribute:"data-pgc-define-script",attribute_keep_if_empty:!0,validate:x.fieldIsRequired,placeholder:x.textForExample("my.poster"),options:function(){return w.insight.ext.components.getComponents()}}}}},x.addComponentType(o),e.push(o)),new PgComponentType("pgc.edit","Define editable area")),E=(k.short_name="Define Editable",k.selector="[data-pgc-edit]",k.attribute="data-pgc-edit",k.action=!0,k.not_main_type=!0,k.get_action_tag=N,k.pgc_extensions={},k.pgcAddExtension=function(e){this.pgc_extensions[e.key]=e},k.pgcGetExtensionForFieldKey=function(e){var t=e.split("-");return t.length&&(t=t[0],k.pgc_extensions[t])||null},k.on_before_show_fields=function(a,o,i,e){$.each(this.pgc_extensions,function(e,t){var n;t.framework&&!a.hasFramework(t.framework)||t.shouldShowFields&&!t.shouldShowFields(a,i)||(n=t.getSection(a,i))&&o.push(n)})},function(e){var t={name:null,attrs:[],content:!0,repeat:!1};if(e){var n=e.match(/^([^\[]*)(\[.*\]|)$/);if(n&&(t.name=$.trim(n[1]),0<n[2].length))for(var a=n[2].replace("[","").replace("]","").split(","),o=0;o<a.length;o++){var i=$.trim(a[o]).toLowerCase();"no_content"==i?t.content=!1:t.attrs.push(i)}}return t}),o=(x.getFieldDefinitionStringForEditableAttribute=function(e,t,n){var a;return e?((a=E(e)).attrs.indexOf(t)<0&&a.attrs.push(t),L(a)):n+"["+t+",no_content]"},k.sections={"pgc.edit.parameters":{name:"Options",fields:{"data-pgc-edit":{type:"text",name:"Field Id",action:"custom",options:function(){var e=w.insight.getValuesForAttribute("data-pgc-edit");return e.forEach(function(e){var t=E(e.key);t&&(e.name=t.name,e.key=t.name)}),e},get_value:function(e,t,n,a){var o=e.attr(k.attribute);return o?E(o).name:null},set_value:function(e,t,n,a,o,i){return t?R(e,t,-1,-1,n):e.removeAttr(k.attribute),t},validate:x.fieldIsRequired,placeholder:x.textForExample("block_title")},"data-pgc-edit-content":{type:"checkbox",name:"Inner content",action:"custom",value:"1",get_value:function(e,t,n,a){var o=e.getAttr(k.attribute);return!o||E(o).content?"1":null},set_value:function(e,t,n,a,o,i){return R(e,-1,t?"1":null,-1,n),t}},"data-pgc-edit-attrs":{type:"select",multiple:!0,can_add_items:!0,options:function(e,t){var n=[];return $.each(t.getAttrList(),function(e,t){t.name.startsWith("data-pg")||n.push({key:t.name,name:t.name})}),w.insight.sortOptionsList(n),n},name:"Attributes",action:"custom",get_value:function(e,t,n,a){var o=e.getAttr(k.attribute);return o&&(o=E(o)).attrs.length?o.attrs.join(", "):null},set_value:function(e,t,n,a,o,i){return R(e,-1,-1,t,n),t}},"data-pgc-edit-classes":{type:"select",multiple:!0,can_add_items:!0,name:"Classes",action:"element_attribute",attribute:"data-pgc-edit-classes",placeholder:x.textForExample("active, inactive"),options:function(e,t){var n=[];return $.each((t.getAttr("class")||"").split(/\s+/),function(e,t){t.startsWith("crsa-")||n.push({key:t,name:t})}),w.insight.sortOptionsList(n),n}},"data-pgc-edit-bckimage":{type:"checkbox",name:"Bck. image",action:"element_attribute",attribute:"data-pgc-edit-bckimage",value:"1",empty_attribute:!0},"data-pgc-edit-types":{type:"select",multiple:!0,can_add_items:!1,options:function(){return w.insight.ext.components.getComponents()},name:"Components",action:"element_attribute",attribute:"data-pgc-edit-types"}}}},k.meta={helptext:"Make the element editable. Inner content of the element is editable by default.",helplink:"https://pinegrow.com/docs/pinegrow-pro/editable-areas/"},x.addComponentType(k),t.push(k),new PgComponentType("pgc.repeat","Define repeatable area")),o=(o.short_name="Repeat",o.selector="[data-pgc-repeat]",o.attribute="data-pgc-repeat",o.action=!0,o.not_main_type=!0,o.sections={"pgc.repeat.parameters":{name:"Options",fields:{"data-pgc-repeat":{type:"text",name:"Field Id",action:"element_attribute",attribute:"data-pgc-repeat",attribute_keep_if_empty:!0,placeholder:x.textDefaultValue("editable field id")}}}},o.meta={helptext:"The editable area can be repeated by duplicating it as many times as needed.",helplink:"https://pinegrow.com/docs/pinegrow-pro/editable-areas/#repeatable-elements"},x.addComponentType(o),t.push(o),new PgComponentType("pgc.optional","Define optional area")),o=(o.short_name="Optional",o.selector="[data-pgc-optional]",o.attribute="data-pgc-optional",o.action=!0,o.not_main_type=!0,o.sections={"pgc.optional.parameters":{name:"Options",fields:{"data-pgc-optional":{type:"text",name:"Field Id",action:"element_attribute",attribute:"data-pgc-optional",attribute_keep_if_empty:!0,placeholder:x.textDefaultValue("editable field id")},"data-pgc-optional-restore":{type:"checkbox",name:"Restore on update",action:"element_attribute",attribute:"data-pgc-optional-restore",empty_attribute:!0,value:"true"}}}},o.meta={helptext:"The element can be deleted from component instances. <span class='more'>To get back deleted optional areas use <b>Actions -&gt; Restore optional areas</b> on instances / child pages - or - check <b>Restore on update</b>, update and then uncheck it (that will restore that field in all updated instances).</span>",helplink:"https://pinegrow.com/docs/pinegrow-pro/editable-areas/#optional-areas"},x.addComponentType(o),t.push(o),new PgComponentType("pgc.param","Parameter")),m=(o.short_name="Parameter",o.selector="pgcparam",x.addComponentType(o),new PgComponentType("pgc.use","Use component")),o=(m.short_name="Use component",m.selector="[data-pgc]",m.attribute="data-pgc",m.action=!0,m.not_main_type=!0,m.sections={"pgc.parameters":{name:"Options",fields:{"data-pgc":{type:"select",name:"Id",action:"element_attribute",attribute:"data-pgc",attribute_keep_if_empty:!0,validate:x.fieldIsRequired,placeholder:x.textForExample("my.poster"),show_empty:!0,can_add_items:!0,options:function(){return w.insight.ext.components.getComponents()}},"data-pgc-no-update":{type:"checkbox",name:"Don't update",action:"element_attribute",attribute:"data-pgc-no-update",empty_attribute:!0,value:"1",on_changed:function(e,t,n,a,o,i,r,s,c){n?w.showQuickMessage("The component <b>will not</b> be updated when component definition changes.",3e3):ie(e.clone(!0),c)&&w.showQuickMessage("Be careful, updating components <b>will change</b> this component instance.",4e3,!1,!0)}}}}},x.addComponentType(m),e.push(m),m.meta={helptext:"Set element to be an instance of a component."},new PgComponentType("pgc.section","Define section")),o=(o.short_name="Section",o.selector="[data-pgc-section]",o.attribute="data-pgc-section",o.action=!0,o.not_main_type=!0,o.sections={"pgc.section.parameters":{name:"Options",fields:{"data-pgc-section":{type:"text",name:"Name",action:"element_attribute",attribute:"data-pgc-section",attribute_keep_if_empty:!1,validate:x.fieldIsRequired,placeholder:x.textForExample("My section")}}}},o.on_action_added=o.on_action_removed=function(){w.showQuickMessage("Update whole project to activate sections changes.",3e3)},x.addComponentType(o),e.push(o),o.meta={helptext:"Components defined within the section element are listed under this section in LIB panel."},new PgComponentType("pgc.field","Use editable area")),f=(o.short_name="Use Editable",o.selector="[data-pgc-field]",o.attribute="data-pgc-field",o.action=!0,o.not_main_type=!0,o.get_action_tag=N,o.sections={"pgc.field.parameters":{name:"Options",fields:{"data-pgc-field":{type:"select",name:"Field Id",action:"element_attribute",attribute:"data-pgc-field",attribute_keep_if_empty:!1,validate:x.fieldIsRequired,placeholder:x.textForExample("title"),can_add_items:!0,options:function(e,t){return w.insight.ext.components.getEditableFieldsForElement(t)}}}}},x.addComponentType(o),t.push(o),o.meta={helptext:"Use component field. This action is added automatically when components are used. <b>Removing this action will cause edits to be lost.</b>"},new PgComponentType("pgc.lock","Lock area")),o=(f.short_name="Lock",f.selector="[data-pgc-lock]",f.attribute="data-pgc-lock",f.action=!0,f.not_main_type=!0,f.get_action_tag=function(){return'<i class="icon icon-Lock_open"></i>'},x.addComponentType(f),t.push(f),f.meta={helptext:"Lock all elements inside the element, except editable areas. This is similar to CMS mode."},[]),h=new PgComponentType("pgc.master","Set as master page"),X=(h.short_name="Master",h.selector="[data-pgc-set-master]",h.attribute="data-pgc-set-master",h.action=!0,h.not_main_type=!0,h.on_action_added=function(e,t,n,a){var o=t.getFileNode(),i=t.getProject();i?o&&i.updateTagsForFile(o):X()},h.on_action_removed=function(e,t,n,a){var o,i=t.getFileNode();i&&(o=t.getProject())&&o.updateTagsForFile(i)},h.on_before_add_action=function(e,t){var n;"html"!==e.tagName&&(n=e.closest("html"))&&(w.selectElement(n),w.showQuickMessage(`Adding the action to the top HTML element...`))},h.on_can_add_action=function(e,t,n,a){return"html"!=e.tagName?(w.showQuickMessage("<b>Wrong element!</b> Set master page actions on <b>the TOP node of the page</b> in the tree.",5e3,!1,!0),!1):!(n==h&&e.hasAttr("data-pgc-master")||n==b&&e.hasAttr("data-pgc-set-master"))||(w.showQuickMessage("The page can't BE A MASTER and USE A MASTER at the same time.",5e3,!1,!0),!1)},h.meta={helptext:"Define the page as a master page that is used as a template for other pages."},x.addComponentType(h),o.push(h),function(){w.showAlert("<p>Master pages work with Projects. To use Master pages open the folder where your pages are located with <b>File -&gt; Open project</b>.</p>","Master pages and components require projects")}),b=new PgComponentType("pgc.master.use","Use master page"),i=(b.short_name="Use master",b.selector="[data-pgc-master]",b.attribute="data-pgc-master",b.action=!0,b.not_main_type=!0,b.sections={"pgc.master.use.parameters":{name:"Options",fields:{"data-pgc-master":{type:"select",name:"Master page",action:"element_attribute",attribute:"data-pgc-master",attribute_keep_if_empty:!1,validate:x.fieldIsRequired,placeholder:x.textForExample("master.html"),can_add_items:!0,options:function(){return w.insight.ext.components.getMasterPages()}}}}},b.on_action_added=function(e,t,n,a){var o,i=t.getProject();i?(o=t.getFileNode())&&i.updateTagsForFile(o):X(),u(!0)},b.on_action_removed=function(e,t,n,a){var o,i=t.getFileNode();i&&(o=t.getProject())&&o.updateTagsForFile(i),u(!0)},b.on_can_add_action=h.on_can_add_action,b.on_before_add_action=h.on_before_add_action,b.meta={helptext:"Select which master page will be used as the template for this page."},x.addComponentType(b),o.push(b),[]),r=new PgComponentType("pgc.partial.save","Partial"),Z=(r.short_name="Partial",r.selector="[data-pgc-save-partial]",r.attribute="data-pgc-save-partial",r.action=!0,r.not_main_type=!0,r.sections={"pgc.save.partial.parameters":{name:"Options",fields:{"data-pgc-save-partial":{type:"text",name:"File",action:"element_attribute",attribute:"data-pgc-save-partial",attribute_keep_if_empty:!1,validate:x.fieldIsRequired,file_picker:!0,file_picker_save:!0,file_picker_no_url:!0,file_picker_no_proxy:!0,file_picker_on_picked:function(e,t){var n,a=require("path"),o=t.getPage();return e=o.localFile&&(n=a.dirname(o.localFile),e.startsWith(n))?a.relative(a.dirname(o.localFile),e):e},helptext:`<p>The file name where the partial is located. Relative paths are resolved from the page file location. For example, using "mypartial.html" will save the partial in the same folder where its parent page is located.</p>`},"data-pgc-save-partial-operation":{type:"select",name:"Operation",action:"element_attribute",attribute:"data-pgc-save-partial-operation",default_value:"save",options:[{key:"save",name:"Save"},{key:"load",name:"Load"},{key:"save_load",name:"Save & Load"},{key:"none",name:"None"}],helptext:`<p>What should happen with the partial:</p>
<ul>
<li><b>Save</b> - save the partial when the page is saved.</li>
<li><b>Load</b> - load the partial from its file when the page is opened.</li>
<li><b>Save &amp; Load</b> - save and load the partial on page save and load.</li>
<li><b>None</b> - don't do anything.</li>
</ul>`},"data-pgc-save-partial-content":{type:"checkbox",name:"Use only the inner content",action:"element_attribute",attribute:"data-pgc-save-partial-content",empty_attribute:!0,value:"1"},"data-pgc-save-partial-save":{type:"button",name:"Save",func:function(e){Te(e.getPage(),[e],!0)}},"data-pgc-save-partial-reload":{type:"button",name:"Reload",func:function(e){w.makeChanges(e,"Reload partial",function(){Se(e.getPage(),[e],!0,!0)&&w.showQuickMessage("The partial was reloaded.")})}}}}},x.addComponentType(r),i.push(r),r.meta={helptext:"Save or load the element HTML code from a separate file."},(1||n())&&((r=new PgFrameworkLibSection("pg.components.master","Master pages")).setComponentTypes(o),x.addActionsSection(r),(r=new PgFrameworkLibSection("pg.components","Components")).setComponentTypes(e),x.addActionsSection(r),(r=new PgFrameworkLibSection("pg.components.editable","Editable areas")).setComponentTypes(t),x.addActionsSection(r),isApp())&&((r=new PgFrameworkLibSection("pg.components.partials","Partials")).setComponentTypes(i),x.addActionsSection(r)),x.on_project_menu=function(e,t){return[]},function(e,t){return!(e.type!=t.type||e.name!=t.name||e.selector!=t.selector||e.parent_selector!=t.parent_selector||e.preview_image!=t.preview_image||e.button_image!=t.button_image||e.auto_update!=t.auto_update||e.description!=t.description||e.map_urls!=t.map_urls)}),ee=function(e){return te(e.getPage(),w.getCurrentProject(),e)},te=function(e,t,n){var a=t.getName(),o=w.findFrameworkByKey(a);if(!o)throw"No framework!";for(var i,r,s=!1,c=ne(e,[],t,null,n),l=0;l<c.components.length;l++){var p,d=c.components[l],u=o.getComponentType(d.type);u?(r=d,(i=u).definition_code==r.definition_code&&i.code==r.code&&Z(i,r)||(i=d,(r=u).name=i.name,r.selector=i.selector,r.parent_selector=i.parent_selector,r.code=i.code,r.definition_code=i.definition_code,r.definition_attributes=i.definition_attributes,r.preview_image=i.preview_image,r.button_image=i.button_image,r.description=i.description,r.component_fields=i.component_fields,r.component_repeat_fields=i.component_repeat_fields,r.auto_update=i.auto_update,r.map_urls=i.map_urls,s=s||!Z(u,d),w.showQuickMessage("Component "+d.name+" changed."))):(o.addComponentType(d),u=t.getName()+"."+(d.add_to_section||"default"),(p=o.getLibSection(u))||(p=new PgFrameworkLibSection(u,d.add_to_section||t.getName()),o.addLibSection(p)),p.addComponentType(d),s=!0,w.showQuickMessage("Component "+d.name+" added."))}c.master&&(o.master_pages||(o.master_pages={}),o.master_pages[c.master.type]=c.master),s&&w.frameworksChanged()},ne=(x.changeComponentDefinitionsToComponentInstances=function(e){e.walkSelfAndChildren(function(e){var t=e.getAttr("data-pgc-define"),t=(t&&(e.removeAttrIfStartsWith("data-pgc-define"),e.setAttr("data-pgc",t)),e.getAttr("data-pgc-edit")),n=null;return t&&(t=E(t),e.removeAttrIfStartsWith("data-pgc-edit"),e.setAttr("data-pgc-field",t.name),n=t.name),e.hasAttr("data-pgc-repeat")&&(t=e.getAttr("data-pgc-repeat")||n,e.removeAttrIfStartsWith("data-pgc-repeat"),n||e.setAttr("data-pgc-field",t)),e.hasAttr("data-pgc-optional")&&(t=e.getAttr("data-pgc-optional")||n,e.removeAttrIfStartsWith("data-pgc-optional"),n||e.setAttr("data-pgc-field",t)),e.hasAttr("data-pgc-section")&&e.removeAttr("data-pgc-section"),!0})},function(e,t,n,a,o){var i={components:[],master:null,use_master:null,used_component_types:[]};if(e.sourceNode){var r=e.sourceNode.findOne("html"),s=(r&&(i.master=r.hasAttr("data-pgc-set-master"),i.use_master=r.getAttr("data-pgc-master")),[]);!i.master||a||o||s.push(e.sourceNode),e.sourceNode.walk(function(e){if(e.isElement){if(o&&e!==o)return!0;var t=e.getAttr("data-pgc-define"),t=(null===t||a&&a!=t||s.push(e),e.getAttr("data-pgc"));t&&i.used_component_types.indexOf(t)<0&&i.used_component_types.push(t)}return!0});for(var c=0;c<s.length;c++){var l=s[c]===e.sourceNode,p=s[c].clone(!0),d=l?"master."+e.name:p.getAttr("data-pgc-define"),u=l?e.name:p.getAttr("data-pgc-define-name")||d,g=p.getAttr("data-pgc-define-selector"),m=function(e){var t=e.getAttrList(),n={};return t.forEach(function(e){e.name.startsWith("data-pgc-define")&&(n[e.name]=e.value)}),n}(p);if(l){for(var f=p.find("[data-pgc-define]"),h=0;h<f.length;h++)x.changeComponentDefinitionsToComponentInstances(f[h]);p.removeAttrIfStartsWith("data-pgc-section",!0)}p.removeAttrIfStartsWith("data-pgc-define",!1);for(var b=p.find("pgcparam"),h=0;h<b.length;h++)b[h].remove();if(d){function _(e){return e.hasAttr("data-pgc-define")}for(var v=new PgComponentType(d,u),w=(v.definition_code=p.toStringOriginal(!0),v.definition_attributes=m,g||p.setAttr("data-pgc",d),l&&((u=p.findOne("html")).removeAttr("data-pgc-set-master"),u.setAttr("data-pgc-master",e.name),v.master_page_source_node=p,v.master_page_url=e.url),v.sourceFile=e.localFile||e.url,v.sourceUrl=e.url,v.selector=g||'[data-pgc="'+d+'"],[data-pgc-define="'+d+'"]',v.tags="block",v.priority=10,v.is_smart_component=!0,v.auto_update="false"!=s[c].getAttr("data-pgc-define-auto-update"),v.map_urls="false"!=s[c].getAttr("data-pgc-define-map-urls"),v.add_to_section=function(e){var t=e.closest("[data-pgc-section]");if(t)return t.getAttr("data-pgc-section")}(s[c]),isApp()&&(m=F.join(n.getDir(),"previews",d+".png"),"file"==crsaIsFileOrDir(m,Y))&&(v.preview_image=d+".png",s[c].hasAttr("data-pgc-define-photo-preview-only")?v.button_image=null:v.button_image=v.preview_image),v.description=s[c].getAttr("data-pgc-define-description"),v.component_fields={},v.component_repeat_fields={},p.findIncludingSelf("[data-pgc-edit]",!1,_)),y=0;y<w.length;y++){var k=w[y].getAttr("data-pgc-edit"),C=E(k),k=(C.selector=w[y].getAttr("data-pgc-edit-selector"),w[y].getAttr("data-pgc-edit-classes")),k=(C.classes=crsaSplitAndTrimList(k),C.bckimage=w[y].hasAttr("data-pgc-edit-bckimage"),w[y].getAttr("data-pgc-edit-types"));k&&(C.types=crsaSplitAndTrimList(k),C.types.length)&&(C.content=!0),C.extensions={},w[y].findAttributesStartingWith("data-pgc-edit-ext-").forEach(function(e){var t=e.name.replace("data-pgc-edit-ext-","");C.extensions[t]=e.value}),C.name&&(w[y].setAttr("data-pgc-field",C.name),v.component_fields[C.name]=C),w[y].removeAttrIfStartsWith("data-pgc-edit")}for(var A=p.findIncludingSelf("[data-pgc-repeat]",!1,_),y=0;y<A.length;y++)(T=A[y].getAttr("data-pgc-field")||A[y].getAttr("data-pgc-repeat"))&&(A[y].setAttr("data-pgc-field",T),A[y].removeAttrIfStartsWith("data-pgc-repeat"),v.component_repeat_fields[T]=!0,T in v.component_fields?v.component_fields[T].repeat=!0:v.component_fields[T]={name:T,content:!1,attrs:[],classes:[],repeat:!0});for(var P=p.findIncludingSelf("[data-pgc-optional]",!1,_),y=0;y<P.length;y++){var T,S=P[y].hasAttr("data-pgc-optional-restore");(T=P[y].getAttr("data-pgc-field")||P[y].getAttr("data-pgc-optional"))&&(P[y].setAttr("data-pgc-field",T),P[y].removeAttrIfStartsWith("data-pgc-optional"),T in v.component_fields?v.component_fields[T].optional=!S:v.component_fields[T]={name:T,content:!1,attrs:[],classes:[],repeat:!0,optional:!S})}l||x.changeComponentDefinitionsToComponentInstances(p),v.code=p.toStringOriginal(!0),l?i.master=v:i.components.push(v)}}}return i}),ae=function(e){var t=[];e.walkSelfAndChildren(function(e){return e.comment&&0<=e.attributes.indexOf("[Pinegrow components saved data")&&t.push(e),!0});for(var n=0;n<t.length;n++)t[n].remove();return t.length},C=function(t,n,e){t.walkSelfAndChildren(function(e){return e!=t&&(e.hasAttr("data-pgc")||e.hasAttr("data-pgc-define"))?"skip_children":n(e)})},oe=function(e,t,i,r,n,a){var s={},c={},l={},o=0,p=[],d="",u=(n=n||{saved:0,deleted:[]},function(e,t){for(var n=null,a=0;a<e.children.length;a++)e.children[a].comment&&0<=e.children[a].attributes.indexOf("[Pinegrow components saved data")&&(n=(n=$.trim(e.children[a].attributes.replace(/\[Pinegrow components saved data[^\]]*\]/,"").replace(/\-\-$/,""))).replace(/\[\[\[\-\-/g,"\x3c!--").replace(/\-\-\]\]\]/g,"--\x3e"),t)&&e.children[a].remove();return n}(e,!0)),g=[];if(u){var m=new pgParser;m.assignIds=!1,m.parse(u);for(var f=0;f<m.rootNode.children.length;f++){var h=m.rootNode.children[f],b=h.getAttr("data-pgc-field");if(b){b=y(b,i);if(b&&b.optional)continue}g.push(h)}}for(f=0;f<g.length;f++)e.append(g[f]);C(e,function(e){for(var t=0;t<J;t++){var n,a=e.getAttr("data-pgc-field"+(0==t?"":"-"+t));a&&((n=y(a,i))?(function(a,e,t){var n=e.name,o=(t[n]||(t[n]={items:[],count:0}),{restored:!1});e.content&&(o.html_content=a.html());for(var i=0;i<e.attrs.length;i++)o[e.attrs[i]]=a.getAttr(e.attrs[i]);o.classes={};e.classes;for(var r=a.getClasses(),s=0;s<e.classes.length;s++){var c=v(e.classes[s]);if(c)for(var l=0;l<r.length;l++)r[l].match(c)&&(o.classes[r[l]]=!0);else o.classes[e.classes[s]]=a.hasClass(e.classes[s])}e.bckimage&&(o.bckimage=a.getInlineStylePropertyValue("background-image",!0)),$.each(e.extensions,function(e,t){var n=k.pgcGetExtensionForFieldKey(e);n&&null!==(n=n.getValue(e,a))&&(o[e]=n)}),t[n].items.push(o)}(e,n,s),n.optional&&(l[a]=!0)):(d+=e.toStringOriginal(!0),o++,p.push({field_id:a,node:e})),n=i.component_repeat_fields&&i.component_repeat_fields[a]?a:null)&&(c[n]||(c[n]=0),c[n]++)}return!0},i.master_page_url||!1);for(f=0;f<g.length;f++)g[f].remove();var _=[];C(t,function(e){var t=e.getAttr("data-pgc-field");if(t&&c[t]){for(var n=1;n<c[t];n++)e.clone().insertAfter(e);c[t]=0}for(n=0;n<J;n++){var a,o=e.getAttr("data-pgc-field"+(0==n?"":"-"+n));o&&(a=y(o,i))&&(!function(a,e,t){var n=e.name;if(n&&t[n]){var o=t[n].count,i=(o>=t[n].items.length&&(o=0),t[n].items[o]);e.content&&i.html_content&&a.html(i.html_content);for(var r=0;r<e.attrs.length;r++)i[e.attrs[r]]&&a.setAttr(e.attrs[r],i[e.attrs[r]]);e.classes;for(var s=a.getClasses(),c=[],l=0;l<e.classes.length;l++){var p=v(e.classes[l]);if(p){for(var d=0;d<s.length;d++)s[d].match(p)&&a.removeClass(s[d]);c.push(p)}else i.classes[e.classes[l]]?a.addClass(e.classes[l]):a.removeClass(e.classes[l])}if(c.length)for(d=0;d<c.length;d++)$.each(i.classes,function(e,t){e.match(c[d])&&t&&a.addClass(e)});e.bckimage&&i.hasOwnProperty("bckimage")&&a.setInlineStylePropertyValue("background-image",i.bckimage,!0),$.each(e.extensions,function(e,t){var n=k.pgcGetExtensionForFieldKey(e);n&&n.setValue(e,i[e]||null,a)}),i.restored=!0,t[n].count=++o}}(e,a,s),!a.optional||l[o]||r||_.push(e))}return!0},i.master_page_url||!1);for(f=0;f<_.length;f++)_[f].remove();return o&&!a&&(i="\x3c!--"+"[Pinegrow components saved data - this data is no longer used in the component. We're saving it just in case. Clear this with Components -> Clear saved unused edits]"+d.replace(/\<\!\-\-/g,"[[[--").replace(/\-\-\>/g,"--]]]")+"--\x3e",t.append(pgCreateNodeFromHtml(i)),n.saved=o,n.deleted_areas=p),n},A=function(t,n,a,e,o,i,r,s){var c,l,p,d,u={refresh_page:!1,changed:!1,saved:0,new_pgel:null,deleted_areas:null};return(n.auto_update||r)&&(c=w.getCurrentProject(),l=w.getCodeFromDefinition(n),p=pgCreateNodeFromHtml(l),d=t.toStringOriginal(!0),(t=i?t.clone(!0):t).withoutEvents(function(){n.map_urls&&a&&n.sourceUrl&&n.framework&&n.framework.project&&n.framework.project===c&&C(p,function(e){return e.mapLinksToNewLocation(n.sourceUrl,a.url),!0}),oe(t,p,n,o,u,s),a&&a.callFrameworkHandler("on_component_updated",p,n);var e=p.toStringOriginal(!0);(d==e||(u.changed=!0,i)?p:(t.replaceWith(p,!0),0,a&&a.openedInEditor&&(w.isElementSelected(t)&&(_=p),e=w.isElementOrDescendantSelected(t),u.new_pgel=p,e)&&(_=p),t)).remove()}),!i)&&u.changed&&a&&a.openedInEditor&&p.update(d,t.getId()),u},ie=function(e,t){var n=e.getAttr("data-pgc");if(n){n=t.getTypeDefinition(n);if(n)return A(e,n,null,[],!1,!0).changed}return!1},re=function(c,e,t,l,p,n){function d(){u&&c.openedInEditor&&(g?c.refresh():_&&w.selectElement(_)),n&&n(u,b)}function a(){function r(t){var n,a,o,e,i;t<s.length?(n=s[t].node,a=s[t].c,s[t].comp_type,o=function(e){var t=A(n,a,c,f,l,null,null,e);u=u||t.changed,m+=t.saved,p.saved+=m,t.changed&&p.changed_collection&&p.changed_collection.add(n),t.refresh_page&&(g=!0)},(e=A(n,a,c,f,l,!0)).changed?h?(i=!1,p.on_before_update&&(i=!0,p.on_before_update(n,a,e,function(e){switch(e){case"update":case"update-delete":o(!0);break;case"update-save":o();break;case"skip":break;case"stop":return b="stop",void d()}r(t+1)})),i||(o(),r(t+1))):o():h&&r(t+1)):d()}t=t||c.sourceNode;var s=[];if(t.walkSelfAndChildren(function(e){if(e.isElement){var t=null,n=e.getAttr("data-pgc");if(!e.hasAttr("data-pgc-define")&&n){if(e.hasAttr("data-pgc-no-update"))return!0;t=c.getTypeDefinition(n)}t&&s.push({c:t,node:e,comp_type:n})}return!0}),h)r(0);else{for(var e=0;e<s.length;e++)r(e);d()}}function o(){T(c,e,p)&&(g=u=!0)}var i,u=!1,g=!1,m=0,f=(_=null,l||"1"!=w.getSetting("pgc-ignore-optional","0")||(l=!0,w.showQuickMessage("Optional areas are ignored.")),[]),h=(p=p||new S).on_before_update||p.on_before_update_master||!1,b="done";return t?a():h&&p.on_before_update_master?(i=T(c,e,p,!1,!0))?p.on_before_update_master(c,i.master_def,i,function(e){switch(e){case"update":o(),a();break;case"skip":a();break;case"stop":return b="stop",void d()}}):a():(o(),a()),u},P=function(e,t,n){var a=e.sourceNode.findOne("html");if(a){if(!t.framework)return null;var o=t.framework.master_pages||{},a=a.getAttr("data-pgc-master");if(a){var i="master."+a;if(i in o)return o[i];n&&n.addError("Page <b>"+e.name+"</b>: master page <b>"+a+"</b> not found.")}}return null},T=function(t,e,n,a,o){var i=P(t,e,n);if(i){var r,s=i.master_page_source_node.clone();t.sourceNode;if(s.setDocument(s),console.log(`Apply master page ${i.master_page_url} to page ${t.url}...`),t.sourceNode.withoutEvents(function(){s.walk(function(e){return e.mapLinksToNewLocation(i.master_page_url,t.url),!0}),r=oe(t.sourceNode,s,i,a)}),r&&(r.master_def=i),t.sourceNode.toStringOriginal(!0)!=s.toStringOriginal(!0))return o?s.withoutEvents(function(){s.remove()}):(t.setCode(s,{},!0),n.changed_collection.add(s)),r}return!1},se=(x.on_project_loaded=function(e,t){"1"==w.getSetting("pgc-auto-reload","1")?s(t):Ae();var n=w.getCurrentProjectInfo().getSetting("project-ignore-files")||{};t.walkThroughFiles(function(e){je(e,t,n)})},x.on_project_refreshed=function(e,t){"1"==w.getSetting("pgc-auto-reload","1")?s(t):Ae();var n=w.getCurrentProjectInfo().getSetting("project-ignore-files")||{};t.walkThroughFiles(function(e){je(e,t,n)})},x.on_project_closed=function(){u(!1)},x.reloadProjectAndUpdateComponents=function(){w.stats.using("components.updateproject"),u(!1),O(function(r){var t,n;t=function(n){r.reload(function(){r.showProjectExplorer($("#crsa-project")),w.showNotice('<p><b>Update whole project</b> will go through <b>ALL</b> editable files (HTML, HTM, or file types listed in Editable file types in Support -&gt; Settings) in your project and apply changes to these files.</p><p><b>Changed files will not be saved.</b> Changed files will be marked in the <b>Project view</b> with <b><i class="" style="color:#444;">&#x2731;</i></b> icon.<ul><li><b>Click on file</b> in the Project panel to open the changed file</li><li><b>Right-click</b> on the file and choose <b>Save</b></li><li>Use <b>File -&gt; Save all</b> to save all changed files.</li></ul></p><p><b>Be careful:</b> this action can change lots of your files. It is strongly <b>recommended</b> that you use a <b>source versioning system</b> (like Git) for this project.</p>',"About updating project","comps-update-project",function(){s(r,function(){var a,e,t,o,i;a=r,e=null,t=n,o=new S,i=t.getComponentTypesInformation(),a.forEachEditableFile(function(e,t,n){e.openedInEditor||e.setComponentTypesInformation(i),re(e,a,null,!1,o)&&(n.changed=!0),t(e,n)},function(){e&&e(),ce(o),o.show()},"Updating components...",null,Ee(a))});var t=w.getCurrentProjectInfo().getSetting("project-ignore-files")||{};r.walkThroughFiles(function(e){je(e,r,t)})})})},n=null,r.forEachOpenPage(function(e){n=e,t&&t(e),t=null}),n||w.showAlert("<p>Updating the whole project needs at least one page from the project to be open in Pinegrow.</p><p><b>Open any editable page from the project</b> and run this action again.</p>","At least one page needs to be open.")})},(1||n())&&(x.on_key_pressed=function(e,t,n){85==t.which&&t.pgCtrlKey&&(t.shiftKey?x.reloadProjectAndUpdateComponents():c(),n.done=!0)}),function(e,t){var n;return isApp()?crsaMakeUrlFromFile(V(e,t)):(n=e.getFileNode())?n?.thumb:null}),S=function(){this.saved=0,this.errors=[],this.changed_collection=new PgCollection,this.addError=function(e){this.errors.push(e)},this.getErrors=function(){return this.errors.length?"<ul><li>"+this.errors.join("</li><li>")+"</li></ul>":null},this.hasErrors=function(){return 0<this.errors.length},this.show=function(e){this.hasErrors()?w.showAlert("<p>The following problems happened during the "+("stop"==e?"stopped ":"")+"update:</p>"+this.getErrors(),"Oops, the update didn't go smoothly"):"stop"==e?w.showQuickMessage("Components update was stopped."):w.showQuickMessage("Components refreshed and updated.")}},ce=function(t){t.saved&&w.showNotice("<p>Some editable areas were removed from component definitions (or their field ids were changed). To prevent the corresponding edits from being lost, the edits were saved in component instances in the form of special invisible HTML comments.</p><p><b>To show this data again</b> restore editable areas in component definition.</p><p><b>To remove saved data</b> on the selected page use <b>Components -&gt; Clear saved data</b>.</p>","Unused editable areas","pgc-saved-data",function(e){e||w.showQuickMessage(t.saved+" unused edits were saved in components.",3e3)})},c=function(l){w.stats.using("components.quickupdate"),O(function(t){for(var n=w.getAllPages(),e=0;e<n.length;e++)t.isPageInProject(n[e])&&te(n[e],t);var a=new S,s=(a.on_before_update_master=a.on_before_update=function(e,t,n,a){var o,i,r,s,c=e instanceof CrsaPage,l=c?e.sourceNode.findOne("html"):e;n.deleted_areas?(o="<ul>",n.deleted_areas.forEach(function(e){var t=j(l,e.field_id),t=(o+=t?'<li><b><a href="#" data-pg-select-element="'+t.getId()+'">'+e.field_id+"</a></b>":"<li><b>"+e.field_id+"</b>",e.node.html());t.length&&(t=crsaGetSummaryStr(escapeHtmlCode(t),60,!0),o+=" | "+t),o+="</li>"}),o+="</ul>",i=function(e){a(e)},r=c?"<p>Applying master page <b>"+t.name+"</b> to the child page <b>"+e.name+"</b> will delete the information in some of its editable areas because these editable areas don't exist in the master page anymore (did you rename field ids or select a different master page?):</p>"+o+"<p>How would you like to proceed?</p>":"<p>Updating this <b>"+t.name+"</b> component instance (see selected element) will delete the information in some of its editable areas because these editable areas don't exist in the new component definition anymore (did you rename field ids or change component types?):</p>"+o+"<p>How would you like to proceed?</p>",s=null,s=c?[{label:"Do not update",action:"skip",func:i,tooltip:"Don't update this child page.",primary:!0},{label:"Update and discard",action:"update",func:i,tooltip:"Update the page and discard the unused information"},{label:"Stop update",action:"stop",func:i,tooltip:"Stop the process of updating components."}]:[{label:"Do not update",action:"skip",func:i,tooltip:"Don't update this component instance.",primary:!0},{label:"Update and save",action:"update-save",func:i,tooltip:"Deleted areas will be saved as HTML comment inside the instance. The information will be restored if the editable area comes back to the component. Use <b>Components -&gt; Clear saved data</b> to remove saved information.",primary:!0},{label:"Update and discard",action:"update-delete",func:i,tooltip:"Update the component and discard the unused information"},{label:"Stop update",action:"stop",func:i,tooltip:"Stop the process of updating components."}],new PgAskAboutElements([l],r,c?"Master page and Child page have different editable areas":"Some information will be lost after update",s).show()):a("update")},n=w.getAllPages().concat([]),"done"),c=function(){var o,e,i,r;n.length?(o=n.shift(),e=t,r=function(e,t){"stop"==t&&(s="stop",n=[]),c()},(i=a).changed_collection=new PgCollection,re(o,e,null,!1,i,function(e,t,n,a){0<i.changed_collection.getLength()&&o.openedInEditor&&w.changeManager.didChange(status.changed_collection,"Quick components update",{},o),r&&r(e,t,n,a)})):(a.show(s),ce(a),l&&l(s))};c()}),u(!1)},le=(n()&&(x.on_page_changed=function(e,t){(t=t&&(t.isDeleted?t.getRemovedFromPgel():t))&&(t.closest("[data-pgc-define]")||t.closest("[data-pgc-set-master]"))&&u(!0)},x.on_duplicate_element_async=function(e,t,n){var a;(a=pe(t,e))?(a=le(a,e),w.showAlert("<p>This element is the definition of the component <b>"+a+"</b>.</p><p>Would you like to duplicate the component definition - or - make the duplicated element an instance of this component?</p>","Duplicating component definition","Duplicate definition","Create instance",function(){n(t),w.showQuickMessage("Definition duplicated. Change component id if you want to keep both.")},function(){x.changeComponentDefinitionsToComponentInstances(t),n(t)})):n(t)},x.on_before_delete_element_async=function(e,t,n){var a;(a=pe(t,e))?(a=le(a,e),w.showAlert("<p>This element is the definition of the component <b>"+a+"</b>.</p><p>Deleting the component definition will break all instances of this component.</p><p>Would you like to delete it?</p>","Deleting component definition","Do not delete","Delete definition",function(){n(null)},function(){n(t),w.showQuickMessage("Component definition was deleted.")})):n(t)}),function(e,t){var n=t.getTypeDefinition(e);return n?n.name:e}),pe=function(e,t){return e.getAttr("data-pgc-define")};x.on_page_menu=function(e,t){var n=w.getCurrentProject();n&&n.isPageInProject(e)&&P(e,n)&&(t.push({type:"divider"}),t.push({label:"Restore optional areas",action:function(){G(e,n)}}))};async function de(i){return new Promise(function(e){const t=p(i);if(!t)return w.showQuickError("The component is not yet defined."),e(!1),!1;const n=t.type;var a=F.join(t.framework.project.getDir(),"previews"),o=F.join(a,n+".png"),a=(crsaCreateDirs(a,Y),i.get$DOMElement());0==a.outerWidth()&&a.children().length&&(a=$(a.children().get(0))),w.takePhotoOfElement(a,800,o,function(){w.showQuickMessage("&lt;project&gt;/previews/<b>"+n+".png</b> saved."),w.cache_breaker++,require("nw.gui").App.clearCache(),t.preview_image=n+".png",t.button_image=t.preview_image,t.definition_attributes&&"data-pgc-define-photo-preview-only"in t.definition_attributes&&(t.button_image=null),$("body").trigger("crsa-update-lib-display"),e(!0)})})}n()&&(x.on_build_lib_actions_menu=function(e,t,n){n.framework.project&&!I()&&(t.push({label:"Make selected an instance of <b>"+n.name+"</b>",class:"action-make-instance-of",kbd:null,manage_change:!0,action:function(){var d;d=n,x.requireSelectedElement(function(l,e){var p=new PgCollection,t=w.getCollectionForElement(e);w.makeChanges(t,"Make instance of",function(){t.forEachElement(function(e){if(e){for(var t=pgCreateNodeFromHtml(d.code),n=t.findIncludingSelf("[data-pgc-field]"),a=0;a<n.length;a++){var o=n[a].getAttr("data-pgc-field"),i=pgFindUniqueSelectorForElement(n[a],t,{tag:!0,path:!0});if(i)for(var r=e.find(i),s=0;s<r.length;s++)r[s].setAttr("data-pgc-field",o)}e.setAttr("data-pgc",d.type),e.setAttr("data-pgc-dummy","hello");var c=A(e,d,l,[],!1);c.new_pgel?p.add(c.new_pgel):p.add(e)}})}),w.selectedElements.selectMany(p,!0)})}}),t.push({label:"Go to definition",class:"action-go-to-definition",kbd:null,manage_change:!0,action:function(){B(n)}}),t.push({label:"Duplicate definition...",class:"duplicate-definition",kbd:null,manage_change:!0,action:function(){K(n,!0)}}))},x.on_project_item_get_context_menu=function(t,n,a){var e,o,i,r,s,c;if(isApp())return e=[],l&&(!l||l.getProject())||(a=w.getCurrentProject(),l=new PgResourceEditor(a)),e.push({divider:!0,header:"Components"}),e.push({label:"Add to resources...",func:function(){l.requireFileFromUrl(n.url)}}),function(e){var t;if(e)return!!(t=e.sourceNode.findOne("html"))&&!!t.hasAttr("data-pgc-set-master")}(t)&&e.push({label:"Update screenshot",func:function(){var e=w.getCurrentProject();W(t,e,!0),w.cache_breaker++}}),o=w.getCurrentProjectInfo(),i=o.getSetting("project-ignore-files")||{},r=a.getRelativeUrl(n.url),s=i[r]||!1,c=function(e){e?(i[r]=!0,w.showQuickMessage(`<b>${n.name}</b> will <b>not</b> be scanned for components and master pages. Reload project to apply the change.`)):(delete i[r],w.showQuickMessage(`<b>${n.name}</b> will be scanned for components and master pages. Reload project to apply the change.`)),o.setSetting("project-ignore-files",i),o.save(),je(n,a,i)},e.push({label:"Scan for components &amp; master pages",check:!Fe(n,a,i),submenu:[{label:"Yes",check:!s,action:function(){c(!1)}},{label:"No",check:s,action:function(){c(!0)}}]}),e});function ue(){O(function(t){var n=w.showAlert("<p>If editable fields are removed from a component, information stored in those fields is saved in case the editable field is restored in the future.</p><p>Would you like to clear such saved information in <b>the selected page</b> or from <b>the whole project</b></p>?","Where to clear?","Cancel","Selected page only",null,function(){var e=w.getSelectedPage();e&&(H(e),w.showQuickMessage("Saved data cleared!"))}),e=$('<button class="btn btn-primary btn-sm">Whole project</button>');n.find(".modal-footer").append(e),e.on("click",function(e){e.preventDefault(),n.modal("hide"),t.forEachEditableFile(function(e,t,n){H(e)&&(n.changed=!0),t(e,n)},function(){w.showQuickMessage("Saved data cleared!")},"Clearing saved unused edits...",null,Ee(t))})})}function ge(){var e=w.selectedElements.hasSelection()?"selected elements":"page";w.showAlert("Would you like to remove all information about components and editable areas from the <b>"+e+"</b>? All <code>data-pgc-*</code> attributes will be removed.","Are you sure","Cancel","Remove",null,function(){var e=w.getSelectedPage();e&&(w.makeChanges(e,"Remove component info",function(){w.selectedElements.hasSelection()?w.selectedElements.forEachElement(function(e){e.removeAttrIfStartsWith("data-pgc",!0)}):e.sourceNode.findOne("html").removeAttrIfStartsWith("data-pgc",!0)}),w.showQuickMessage("Component information removed!"),w.refreshCurrentProject(null,!1,!0),e.refresh())})}function me(e){e?Ce.show():Ce.hide()}function fe(e,t){e?(Pe.show(),t&&w.showNotice('<p><b>Test CMS mode is now active.</b> To continue editing the page, switch it off in the Components menu.</p><p>In <b>CMS mode</b> only elements marked with Editable area actions can be edited, the rest of the page is locked.</p><p>Learn more about <a href="https://pinegrow.com/docs/pinegrow-pro/cms/" class="external">using Pinegrow as CMS</a>.</p>',"About the CMS mode","pgc-content-contributor",function(e){e||w.showQuickMessage("CMS test mode is ON. Only editable areas can be edited.")})):(t&&w.showQuickMessage("CMS test mode is OFF."),Pe.hide())}function he(e,t,n){var a=e.closest("[data-pgc],[data-pgc-define]");if(a)return n&&(n.element=a),t.getTypeDefinition(a.getAttr("data-pgc")||a.getAttr("data-pgc-define"))}function be(e,n){var t;return e?(t="<p>The following parts of <b>"+e.name+"</b> are editable:</p><ul>",e.content&&(e.types&&e.types.length?t+="<li>Component instances of "+e.types.map(function(e){var t=n.getTypeDefinition(e);return"<b>"+(t?t.name:e)+"</b>"}).join(", ")+" can be added and deleted from the content</li>":t+="<li>The content</li>"),e.attrs.length&&(t+="<li>Attributes: <b>"+e.attrs.join("</b>, <b>")+"</b></li>"),e.classes.length&&(t+="<li>Classes: <b>"+e.classes.join("</b>, <b>")+"</b></li>"),e.bckimage&&(t+="<li>Background image</li>"),t+"</ul>"):""}function _e(e,t){var n,a,o,i=1,r=e;for(t.getPage();n=e,o=void 0,!(0===(o=((a=t)?a.getPage():w.getSelectedPage()).sourceNode.find(`[data-pgc-define="${n}"]`)).length||a&&1===o.length&&o[0]===a);)e=r+"-"+ ++i;return e}var ve,we,ye,p=function(e){var t=e.getAttr("data-pgc")||e.getAttr("data-pgc-define");return t?e.getPage().getTypeDefinition(t):null},j=(n()&&(x.on_build_actions_menu=function(e,t,n,a){var o,i,r=a?null:n;I()||(o=w.getCurrentProject(),"html"==n.tagName&&o&&o.isPageInProject(e)&&P(e,o)&&(t.push({type:"divider"}),t.push({type:"header",label:"Master page"}),t.push({label:"Restore optional areas",manage_change:!0,action:function(){G(e,o)}})),n.getAttr("data-pgc")||n.getAttr("data-pgc-define"),(i=p(n))&&i.framework.project&&(t.push({type:"divider"}),t.push({type:"header",label:"Components"}),!n.getAttr("data-pgc")||i.auto_update&&!n.hasAttr("data-pgc-no-update")||t.push({label:"Update component instance",class:"action-update-component",kbd:null,manage_change:!0,action:function(){var n=[],e=w.getCollection(r),a=new PgCollection;e.forEachElement(function(e){var t=p(e);t&&t.framework.project&&A(e,t,e.getPage(),n,!1,!1,!0)&&a.add(e)}),a.getLength()?(w.changeManager.didChange(a,"Component update"),w.showQuickMessage("Component instance updated!")):w.showQuickMessage("Component was not changed.")}}),t.push({label:"Go to definition",class:"action-go-to-definition",kbd:null,manage_change:!0,action:function(){B(i)}}),t.push({label:"Duplicate definition...",class:"duplicate-definition",kbd:null,manage_change:!0,action:function(){K(i,!0)}}),t.push({label:"Restore optional areas",class:"action-restore-optional",kbd:null,manage_change:!0,action:function(){var e=w.getCollection(r),n=new PgCollection;e.forEachElement(function(e){var t=p(e);t&&t.framework.project&&re(e.getPage(),t.framework.project,e,!0)&&n.add(e)}),n.getLength()?(w.changeManager.didChange(n,"Restore optional area"),w.showQuickMessage("Optional areas were restored!")):w.showQuickMessage("Component was not changed.")}}),isApp())&&t.push({label:"Take component photo",class:"action-take-photo",kbd:null,manage_change:!0,action:function(){de(n)}}))}),w.loadProjectAsLibrary=function(o,e,i){var t,n=isApp()?F.basename(o):crsaGetNameFromUrl(o),r=w.findFrameworkByKey(n),a=crsaMakeUrlFromFile(o);if(!r||r.pluginUrl==a)return(r=r||new PgFramework(n,n)).pluginUrl=a,w.addFramework(r,-1e3),w.frameworksChanged(),r.components_loaded=r.components_loaded||!1,r.on_init_plugin=function(n){var e,t,a;r.components_loaded||r.loading_components?n&&n(r):(w.stats.using("components.loadprojectaslibrary"),t=function(e){s(e,function(e,t){i&&i(e,t),n&&n(t)})},(a=w.getCurrentProject())&&a.getDir()==o?((e=a).framework=r,"1"===w.getSetting("pgc-auto-reload","1")?t(e):(i&&i(e,framework),n&&n(framework))):((e=new CrsaProject).framework=r,e.fromFolder(o,function(e){t(e)},!0)),r.components_loaded=!0)},r.on_plugin_activated=function(e,t){r.on_init_plugin(t)},(t=w.getFrameworksListFromStorage()).indexOf(a)<0&&(t.push(a),crsaStorage.setValue("frameworks",t)),e&&e(r),r;w.showAlert("<p>Library <b>"+n+"</b> is already loaded.</p><p>Note that the library folder name is used as the name of the library. This name must be unique - only one library with a certain name can be loaded.</p>",n+" is already loaded"),e&&e()},w.selectAndLoadLibrary=function(n){crsaChooseFile(function(e,t){w.loadProjectAsLibrary(t,function(e){w.activateFrameworkInCurrentContext(e),n&&n(e)})},!1,!1,null,!0)},function(e,t,n){n=n||0;var a=ke(e,t);return n<a.length?a[n]:null}),ke=function(e,n){var a=[];return C(e,function(e){var t;return e.isElement&&((t=e.getAttr("data-pgc-edit"))?(t=E(t))&&t.name==n&&a.push(e):e.getAttr("data-pgc-field")==n&&a.push(e)),!0}),a},M=!1,I=function(){return!!M||w.isContributorMode()},o=(x.on_show_properties=function(d,e,u,t,n){var a,o,i,r=null,s=((a=Ie(u))&&(r=null===x.on_can_make_change(d,u,"edit")?"The element is fully editable":(e.splice(0,e.length),"cc_mode"==a?"The element is not editable.":"The element is not editable because it is in the locked area.")),[]);if(t)for(var c,l=0;l<t.length;l++)t[l].component_fields&&(c=t[l],m={framework:c.framework,name:c.name,fields:{},component_fields:c.component_fields,default_closed:!1},s.push(m),r=r&&"Only certain properties of this element are editable.");if(s.length||((o=D(u,I()||!0,d))||(w.dispatchEvent("on_cms_get_dynamic_field",d,u,i={pgel:null,info:null,closest:!1}),i.pgel&&i.info&&(o=i.info)),o&&((i={})[o.name]=o,m={framework:x,name:"Editable properties",fields:{},component_fields:i,default_closed:!1},s.push(m),a)&&(r="cc_mode"==a?"Only certain properties of this element are editable.":"Only certain properties of this element are editable because it is in the locked area.")),s.length)for(var g,m,l=0;l<s.length;l++)s[l].component_fields&&(g=!1,m=s[l],$.each(m.component_fields,function(e,l){var p=ke(u,l.name);$.each(p,function(s,e){var a=1==p.length?"":" "+(s+1),o="."+(s+1);l.content&&(l.types&&l.types.length?((i={}).name=l.name+a+" content",i.type="custom",i.control=function(){var i=new PgCustomPropertyControl("pg.components.field.control."+l.name+o+".content");return i.onDefine=function(){},i.onShow=function(){var t=$('<div class="crsa-field"><label class="">Add <nocap>to</nocap> '+l.name+":</label></div>");return l.types.forEach(function(a){var o=le(a,d),e=$('<button class="btn btn-primary btn-sm"><i class="icon icon-plus"></i> '+o+"</button>").on("click",function(e){e.preventDefault();var t=d.getTypeDefinition(a),n=i.obj,n=j(n,l.name,s);n&&(t=getCodeFromDefinition(t),(new PgApi).insertElements(t,n,"append",{scroll:!0,highlight:!0}).getLength())&&w.showQuickMessage(o+" was appended to "+l.name)});t.append(e)}),t},i.onSetValues=function(){},i.onHasData=function(){return!1},i}):((i={}).name=l.name+a+" content",i.type="text",i.action="custom",i.get_value=function(e){var t=j(e,l.name,s);return t?t.html():null},i.set_value=function(e,t,n,a,o){w.willChangeDom();var i=j(e,l.name,s);return i&&i.html(t||""),t}),i.on_can_make_change=function(){return!0},m.fields["pg.components.field."+l.name+o+".content"]=i,g=!0);for(var t=0;t<l.attrs.length;t++){var n=l.attrs[t];"wp-include-template-part-set"!=n&&(!function(r){var e={};e.name=l.name+a+" "+r,e.type="text",e.action="custom",e.options=function(e,t){var n=j(t,l.name,s);return w.insight.getValuesForAttribute(r,0<=["img","script","link","iframe"].indexOf(n.tagName)?n.tagName:null)},e.get_value=function(e){var t=j(e,l.name,s);return t?t.getAttr(r):null},e.set_value=function(e,t,n,a,o){var i=j(e,l.name,s);return i&&i.setAttr(r,t),t},e.on_can_make_change=function(){return!0},"src"!=r&&"href"!=r||(e.file_picker=!0),m.fields["pg.components.field."+l.name+o+"."+r]=e}(n),g=!0)}for(var i,c=[],r=0;r<l.classes.length;r++)v(l.classes[r])||c.push({key:l.classes[r],name:l.classes[r]});c.length&&((i={}).name=l.name+a+" classes",i.type="select",i.options=c,i.show_empty=!0,i.action="custom",i.multiple=1<c.length,i.get_value=function(e){var t=j(e,l.name,s),n=[];if(t){for(var a=0;a<c.length;a++)t.hasClass(c[a].key)&&n.push(c[a].key);if(n.length)return n.join(",")}return null},i.set_value=function(e,t,n,a,o){var i=j(e,l.name,s);if(i){for(var r=0;r<c.length;r++)i.hasClass(c[r].key)&&i.removeClass(c[r].key);t&&t.split(",").forEach(function(e){i.addClass(e)})}return t},i.on_can_make_change=function(){return!0},m.fields["pg.components.field."+l.name+o+".classes"]=i,g=!0),l.bckimage&&((i={}).name=l.name+a+" Bck. Image",i.type="text",i.action="custom",i.get_value=function(e){var t=j(e,l.name,s);return t?t.getInlineStylePropertyValue("background-image",!0):null},i.set_value=function(e,t,n,a,o){var i=j(e,l.name,s);return i&&i.setInlineStylePropertyValue("background-image",t,!0),t},i.on_can_make_change=function(){return!0},i.file_picker=!0,i.file_picker_no_proxy=!0,m.fields["pg.components.field."+l.name+o+".bckimage"]=i,g=!0),$.each(l.extensions,function(e,t){var n=k.pgcGetExtensionForFieldKey(e);n&&n.getProperty&&(n=n.getProperty(e,t,j(u,l.name,s)))&&(n.name=l.name+a+" / "+n.name,n.on_can_make_change=function(){return!0},m.fields["pg.components.field."+l.name+o+"."+e]=n,g=!0)})})}),g)&&e.unshift(m);r&&n.showMessage((M?"CMS mode is ON.<br><br>":"")+r)},x.on_set_inline_style=function(e,t){t.css+="            html.crsa-pgc-mark-areas [data-pgc-define], html.crsa-pgc-mark-areas [data-pgc-save-partial] {            outline: 1px solid rgba(0, 236, 255, 1);            outline-offset:0;            }            html.crsa-pgc-mark-areas [data-pgc] {            outline: 1px solid rgba(255, 214, 0, 1);            outline-offset:0;            }            html.crsa-pgc-mark-areas [data-pgc-field], html.crsa-pgc-mark-areas [data-pgc-edit] {            outline: 1px solid rgba(255, 214, 0, 0.3);            outline-offset:0;            }            html.crsa-pgc-mark-areas[data-pgc-set-master] [data-pgc-edit] {            outline: 1px solid rgba(255, 214, 0, 1);            outline-offset:0;            }            "},$('<li class="dropdown pgc-menu"><a href="#" class="dropdown-toggle" data-toggle="dropdown">Components</a>                        <ul class="dropdown-menu with-checkboxes">                            <li><a href="#" class="pgc-menu-quick-update">Quick update (only open pages)</a></li>                            <li><a href="#" class="pgc-menu-update-project">Update the whole project</a></li>                            <li><a href="#" class="pgc-menu-reload">Reload components from project</a></li>                            <li class="divider"></li>                            <li class="dropdown-header">Libraries</li>                            <li><a href="#" class="pgc-menu-edit-resources">Edit resources...</a></li>                            <li><a href="#" class="pgc-menu-refresh-libs">Refresh loaded libraries</a></li>                            <li><a href="#" class="pgc-menu-resources">Add/update resources from libraries...</a></li>                            <li class="divider"></li>                            <li class="dropdown-header">AI Library</li>                            <li><a href="#" class="pgc-menu-update-ai-library">Update AI Library</a></li>                            <li class="divider"></li>                            <li class="dropdown-header">Tools</li>                            <li><a href="#" class="pgc-menu-auto-reload"><i class="icon icon-check check-icon"></i>Auto reload on project load and refresh</a></li>                            <li><a href="#" class="pgc-menu-mark"><i class="icon icon-check check-icon"></i>Mark components</a></li>                            <li><a href="#" class="pgc-menu-test-cm"><i class="icon icon-check check-icon"></i>Test CMS mode</a></li>                        \x3c!--<li><a href="#" class="pgc-menu-ignore-optional"><i class="icon icon-check check-icon"></i>Ignore optional areas on update</a></li>--\x3e                            <li><a href="#" class="pgc-menu-clear-saved-edits">Clear unused edits...</a></li>                            <li><a href="#" class="pgc-menu-remove">Remove component information...</a></li>                            <li><a href="#" class="pgc-menu-help">Documentation</a></li>            </ul></li>')),e=(crsaAddKbd(o.find(".pgc-menu-quick-update"),"CMD U"),crsaAddKbd(o.find(".pgc-menu-update-project"),"SHIFT CMD U"),o.find(".pgc-menu-quick-update").on("click",function(e){e.preventDefault(),c()}),o.find(".pgc-menu-update-project").on("click",function(e){e.preventDefault(),x.reloadProjectAndUpdateComponents()}),o.find(".pgc-menu-reload").on("click",function(e){e.preventDefault(),O(function(e){s(e,function(){})})}),o.find(".pgc-menu-resources").on("click",function(e){e.preventDefault(),O(function(e){w.showUpdateResourcesDialog(w.getSelectedPage(),e)})}),o.find(".pgc-menu-edit-resources").on("click",function(e){e.preventDefault(),O(function(e){e=e,(l=l&&(!l||l.getProject())?l:new PgResourceEditor(e)).show()})}),o.find(".pgc-menu-update-ai-library").on("click",function(e){e.preventDefault(),O(function(e){e.pineConeLib.updateAllComponentsInProject(!0)})}),o.find(".pgc-menu-refresh-libs").on("click",function(e){e.preventDefault();function t(){n.length?n.shift().project.reload(function(e){s(e,function(){t()},!0)}):w.frameworksChanged()}var n=[],a=w.getCurrentProject();$.each(w.getFrameworks(),function(e,t){t.project&&t.components_loaded&&t.project!=a&&n.push(t)});t()}),o.find(".pgc-menu-help").on("click",function(e){e.preventDefault(),w.openExternalUrl(w.pro_info_url)}),o.find(".pgc-menu-apply-master").on("click",function(e){e.preventDefault();var t=w.getCurrentProject(),n=w.getSelectedPage();t&&n&&q(n,t)}),o.find(".pgc-menu-clear-saved-edits").on("click",function(e){e.preventDefault(),ue()}),o.find(".pgc-menu-remove").on("click",function(e){e.preventDefault(),ge()}),o.find(".pgc-menu-mark")),t=(new PgPageViewHelper("Mark components","pgc-mark-areas","crsa-pgc-mark-areas",e),o.find(".pgc-menu-auto-reload")),Ce=t.find("i"),Ae=function(){w.showQuickMessage("Auto reload components is OFF. Use <b>Components -&gt; Reload components from project</b> to reload components.",4e3)},i=(me("1"==w.getSetting("pgc-auto-reload","1")),t.on("click",function(e){e.preventDefault();var t="1"==w.getSetting("pgc-auto-reload","1");me(t=!t),w.setSetting("pgc-auto-reload",t?"1":"0"),t||Ae()}),o.find(".pgc-menu-test-cm")),Pe=i.find("i"),d=(fe(M),i.on("click",function(e){e.preventDefault();var t;fe(t=!M,!0),M=t,w.reselectElement(),w.repaintTree()}),x.pcGetComponentsMenuActions=function(){var e=[];return e.push({type:"header",label:"After changing components:"}),e.push({label:"Quick update",kbd:"CMD U",action:function(){c()},helptext:"Scan all open pages for components and apply any changes."}),e.push({label:"Update the whole project",action:function(){x.reloadProjectAndUpdateComponents()},helptext:"Scan the whole project for components and apply any changes."}),e.push({type:"divider"}),e.push({type:"header",label:"AI Assistant"}),e.push({label:"Update AI Library",action:function(){O(function(e){e.pineConeLib.updateAllComponentsInProject(!0)})},helptext:"Update the AI library of components that can be used with the Auto component AI action."}),e.push({type:"divider"}),e.push({label:"Remove unused saved data...",action:function(){ue()},helptext:"Clear any unused editable data that is stored in component instances."}),e.push({label:"Remove all component information...",action:function(){ge()},helptext:"Remove all information about components. This removes all component actions from HTML code of the selected element or the whole page if no element is selected."}),e.push({type:"divider"}),e.push({label:"Documentation",link_url:w.pro_info_url,dont_handle_click:!0,action:function(){},helptext:"Learn how to use components."}),e},(1||w.isPRO()||w.isProTrialActive())&&!w.isContributorMode()&&w.addPluginControlToTopbar(x,o,!0),$('<span class="update-components"><i class="icon icon-REFRESH"></i></span>').on("click",function(e){e.preventDefault(),e.stopPropagation(),c()})),u=(addTooltip(d,"Quick update components "+pgShowKbdCombo("CMD+U")),isApp()?d.appendTo(o.find(">a")):d.appendTo($(".menu-project-menu")),function(e){(e=I()?!1:e)?d.removeClass("update-components-hide"):d.addClass("update-components-hide")}),Te=((x.setHasUpdates=u)(!1),x.useMasterPage=function(e,t,n,a){var o=e.sourceNode.findOne("html"),i=(o.withoutEvents(function(){o.removeAttr("data-pgc-set-master"),o.setAttr("data-pgc-master",n.name)}),new S);q(e,t,i,null,null,a)},x.updateEditableAreas=function(e){x.changeComponentDefinitionsToComponentInstances(e.sourceNode)},x.on_page_loaded=function(e){},x.on_page_refreshed=function(e){},x.on_page_saved=function(e,t,n){isApp()&&(Te(e),xe(e))},function(e,t,n){var a=require("path"),o=t||e.sourceNode.find("[data-pgc-save-partial]");if(o.length){for(var i=w.getCurrentProjectInfo(),r=i.getSetting("project-partials")||{},s=i.makeUrlRelative(e.url),c=0;c<o.length;c++){var l=o[c].getAttr("data-pgc-save-partial"),p=Q(o[c]);if(!(p.indexOf("save")<0)||n)try{var d,u=o[c].clone(!0);if(u.removeAttrIfStartsWith("data-pgc-save-partial",!0),d=o[c].hasAttr("data-pgc-save-partial-content")?u.toStringContent(!0,w.getFormatHtmlOptions()):u.toStringOriginal(!0,w.getFormatHtmlOptions()),(l=a.resolve(a.dirname(e.localFile||""),l))===e.localFile)throw`Partial can't overwrite its parent file.`;var g=!crsaIsFileExist(l),m=(crsaWriteFileWithBackup(null,l,d,"utf8"),w.showQuickMessage("Partial <b>"+crsaGetSummaryStr(l,50)+"</b> saved!"),g&&w.refreshCurrentProjectDelayed(!0),crsaMakeUrlFromFile(l));r[i.makeUrlRelative(m)]=s}catch(e){w.showAlert("<p>Partial file "+l+" could not be saved: "+e+"</p>","Error saving partial file")}}i.setSetting("project-partials",r),i.save()}}),Se=(x.pgcGetPartialOpeningOptions=function(s,e,c){var t=(e=e||w.getCurrentProjectInfo()).getSetting("project-partials")||{},n=e.makeUrlRelative(s);return t[n]?[{label:"As partial",action:function(){var o=require("path"),i=!1,r=e.makeUrlAbsolute(t[n]);w.openOrShowPage(r,function(e){for(var t=e.sourceNode.find("[data-pgc-save-partial]"),n=0;n<t.length;n++)if(a=t[n].getAttr("data-pgc-save-partial")){var a=o.resolve(o.dirname(crsaMakeFileFromUrl(r)),a);if(crsaMakeUrlFromFile(a)===s){w.selectElement(t[n]),t[n].scrollTo(),w.showQuickMessage(`Partial ${c} is selected.`),i=!0;break}}i||w.showQuickError(`Partial ${c} was not found in page `+e.name)})}},{label:"Directly",action:function(){w.openOrShowPage(s)}},{label:"Edit code",action:function(){w.openFileInCodeEditor(crsaMakeFileFromUrl(s))}}]:null},function(i,e,t,r,s,c){(c=c||{}).changed=!1,c.col=new PgCollection;var l,n,p=require("path"),d=require("fs"),u=e||i.sourceNode.find("[data-pgc-save-partial]"),g=[];if(crsaIsFileUrl(i.url))return l=crsaMakeFileFromUrl(i.url),n=function(e){for(var t=0;t<u.length;t++){var n=Q(u[t]);if(!(n.indexOf("load")<0)||r){n=u[t].getAttr("data-pgc-save-partial");if(n&&(n=p.resolve(p.dirname(l),n),!s||s(u[t],n)))if(n===i.localFile)g.push(`Partial <code>${n}</code> can't be loaded from its parent file.`);else{try{var a=d.readFileSync(n,{encoding:"utf8"})}catch(e){g.push(`Can't read the file <code>${n}</code>: ${e}.`);continue}if(u[t].hasAttr("data-pgc-save-partial-content"))u[t].html(a);else try{var o=pgCreate(a.trim(),!0);if(o.script_info){g.push(`The top element should not be a ${o.script_info.name} tag. If you need to do this, define a Partial that uses only the inner content.`);continue}o.removeAttrIfStartsWith("data-pgc-save-partial",!1),u[t].getAttrList().forEach(function(e){o.setAttr(e.name,e.value)}),u[t].replaceWith(o)}catch(e){g.push(`Invalid content in file <code>${n}</code>. Only one top HTML element is allowed.`)}c.changed=!0,c.col.add(u[t])}}}},t?n():i.sourceNode.withoutEvents(function(){n()}),!g.length||(w.showAlert(`<p>Could not load all partials in <b>${i.name}</b>:</p><ul><li>${g.join("</li><li>")}</li></ul>`,`Error(s) while loading partials`),!1)}),xe=(w.addEventHandler("on_page_parsed_in_proxy",function(e,t,n,a){e.openedInEditor&&!a&&Se(e)}),function(e){var n,a=e.localFile;a&&(n=!1,w.getAllPages().forEach(function(e){var t={};Se(e,null,!0,!1,function(e,t){return a===t},t),t.changed&&(w.changeManager.didChange(t.col,"Load partials on "+e.name),n=!0)}),n)&&w.showQuickMessage("Saved partial was updated on open pages.")}),Fe=(w.addEventHandler("on_code_page_saved",function(e){xe(e)}),function(e,t,n){return n[t.getRelativeUrl(e.url)]||!1}),Ee=function(e){return w.getCurrentProjectInfo().getSetting("project-ignore-files")||{}},je=function(e,t,n){n||(t=w.getCurrentProject(),n=w.getCurrentProjectInfo().getSetting("project-ignore-files")||{});var a,o,i,r=e.getTagByType("ignorescan"),s=Fe(e,t,n),c=s?(a="hide",o=i=`Don't scan for components &amp; master pages.`,"pg-file-tag-white"):(a="check",o=i=`Scan for components &amp; master pages.`,"pg-file-tag-gray");s?r||(r=new CrsaFileTag(o,"ignorescan",i,a,c),e.addTag(r),e.updateTags()):r&&(e.removeTagByType("ignorescan"),e.updateTags())},Me=(w.addEventHandler("on_project_item_get_context_menu_regular",function(e,t,n,a){}),function(e,t,n){var a=e.closest("[data-pgc]");if(a)return n&&(n.element=a),t.getTypeDefinition(a.getAttr("data-pgc"))}),Ie=function(e){return I()?"cc_mode":!!e.closest("[data-pgc-lock]")&&"locked"},D=(x.on_custom_tree_filter=function(e,o){if(I()){var t=["[data-pgc],[data-pgc-define],[data-pgc-edit],[data-pgc-field]"];w.dispatchEvent("on_cms_get_selectors_for_dynamic_fields",e,t);try{e.get$Html().find(t.join(",")).each(function(e,t){var n,a=t.getAttribute("data-pg-id");a&&(o.selected_ids[a]=!0,o.changed||(o.changed=!0),a=getDomElementPgNode(t),a=D(a,!0))&&a.content&&(n="*",a.types&&a.types.length&&(n=a.types.map(function(e){return'[data-pgc="'+e+'"],[data-pgc-define="'+e+'"]'}).join(",")),$(t).find(n).each(function(e,t){var n=t.getAttribute("data-pg-id");n&&(o.selected_ids[n]=!0)}))})}catch(e){}}},x.on_can_make_change=function(s,c,l,p){if(s.getCurrentFrameworkHandlerReturnValue("on_can_make_change"))return s.getCurrentFrameworkHandlerReturnValue("on_can_make_change");var e=Ie(c),d=!1,t=w.getCurrentProject(),n={},a=null,o=("cc_mode"===e?he:Me)(c,s,n);if(I()&&pe(c)&&"delete_element"==l&&o)return new PgEditException("<p>The element can't be deleted because it is the definition of the <b>"+o.name+"</b> component.</p><p>Deleting the component definition would break all instances of this component.</p>","This element can't be deleted");function i(a,e){var t,n=c==e;if(n&&("add_class"==l||"remove_class"==l))if(0<=a.attrs.indexOf("class"))d=!0;else for(var o=0;o<a.classes.length;o++){var i=v(a.classes[o]);if(i){if(p.match(i)){d=!0;break}}else if(p==a.classes[o]){d=!0;break}}function r(e){for(var t=s.getAllTypes(null,e,!0),n=0;n<t.length;n++)if(0<=a.types.indexOf(t[n].type))return!0;return!1}n&&"attr"==l&&(0<=a.attrs.indexOf(p)?d=!0:1==a.attrs.length?a.attrs[0]:a.attrs.join(", ")),a.content&&(n?a.types&&a.types.length?"insert_element"==l&&p&&p.inserted&&r(p.inserted)&&(d=!0):["insert_element","edit_content"].indexOf(l)<0||(d=!0):(!a.types||c.parent!=e||0<=["delete_element","duplicate_element"].indexOf(l)&&r(c))&&(d=!0)),a.bckimage&&n&&"element_bckimage"==l&&(d=!0),a.repeat&&n&&("duplicate_element"!=l&&"delete_element"!=l&&"move_element"!=l||(d=!0)),a.optional&&n&&"delete_element"==l&&(d=!0),"insert_element"==l&&p&&p.moved&&(n=p.moved,n=D(n))&&n.repeat&&((t=function(e,t){var n;return!!t&&(n=D(t))&&n.name==e})(n.name,p.prev)||t(n.name,p.next))&&(d=!0),$.each(a.extensions,function(e,t){var n=k.pgcGetExtensionForFieldKey(e);n&&n.canMakeChange(e,c,l,p)&&(d=!0)})}o&&n.element==c&&0<=["delete_element","duplicate_element"].indexOf(l)&&(o=(e?he:Me)(c.parent,s,n)),t&&"add_action"==l&&"data-pgc-set-master"==p.attribute&&W(s,t);if(o||t&&(o=P(s,t)),o){var t=n.element||null,r=e?c.closest("[data-pgc-field],[data-pgc-edit]",t):c.closest("[data-pgc-field]",t),n=c==t;if(!o.auto_update||t&&t.hasAttr("data-pgc-no-update")?d=!0:r&&((a=(t=!(t=r.getAttr("data-pgc-field"))&&e&&(u=E(r.getAttr("data-pgc-edit")))?u.name:t)&&o.component_fields&&o.component_fields[t]||null)?i(a,r):d=!0),(d=(d=!d&&n?0<=["delete_element","duplicate_element","move_element"].indexOf(l):d)||"edit_code"!=l?d:!0)||"html"!=c.tagName||("add_action"==l||"remove_action"==l?p!=h&&p!=b||(d=!0):"attr"==l&&p.startsWith("data-pgc-master")&&(d=!0)),!(d=(d=d||!n||"add_action"!=l&&"remove_action"!=l||p!=g&&p!=m?d:!0)||!n||"attr"!=l||"data-pgc-no-update"!=p&&"data-pgc"!=p?d:!0))return I()?new PgEditException("<p>This element is not editable.</p>"+be(a,s),"This element is locked"):new PgEditException("<p>The element can't be changed because it is defined in component <b>"+o.name+"</b>.</p>"+be(a,s)+'<p>Choose "Go to component definition" to edit the component definition.</p>',"This element is locked",function(t){$('<button class="btn btn-default btn-sm" type="button">Go to component definition</button>').on("click",function(e){e.preventDefault(),B(o),t.modal("hide")}).insertBefore(t.find(".btn.ok"))})}else if(e&&("remove_action"!=l||p!=f)){var u=null;if((r=c.closest("[data-pgc-edit]"))&&(u=D(r,!0)),r||(w.dispatchEvent("on_cms_get_dynamic_field",s,c,t={pgel:null,info:null,closest:!0}),t.pgel&&t.info&&(r=t.pgel,u=t.info)),u)return i(u,r),d?null:new PgEditException("<p>This element is not editable.</p>"+be(u,s),"This element is locked")}return!e||a||d||"remove_action"==l&&p==f?null:new PgEditException((M?"<p><b>Test CMS mode is ON</b> (you can switch it off in the Components menu).</p>":"")+'<p>The element is not editable.</p><p>Only elements marked with <i class="icon icon-Editable" style="color:#6cadd6;"></i> in the tree are editable.</p>',"This element is locked")},function(e,t,n){var a=null,o=e.getAttr("data-pgc-field");if(o){var i=Me(e,e.getPage(),{});if(i)if(a=y(o,i))return a}if(t&&(a=(a=E(e.getAttr("data-pgc-edit"))).name?a:null)&&(i=e.getAttr("data-pgc-edit-classes"),a.classes=crsaSplitAndTrimList(i),a.bckimage=e.hasAttr("data-pgc-edit-bckimage"),(i=e.getAttr("data-pgc-edit-types"))&&(a.types=crsaSplitAndTrimList(i),a.types.length)&&(a.content=!0),a.extensions={},e.findAttributesStartingWith("data-pgc-edit-ext-").forEach(function(e){var t=e.name.replace("data-pgc-edit-ext-","");a.extensions[t]=e.value})),o&&n){i=w.getCurrentProject();if(i&&i.isPageInProject(n)){i=P(n,i);if(i)return y(o,i)}}return a}),O=function(e){var t;n()?(t=w.getCurrentProject())?e(t):w.showAlert("<p>Components work with <b>Projects</b>. To use components open the folder where your pages are located with <b>File -&gt; Open project</b>.</p>","Components work with Projects"):w.showProductUpgradeMessage("PRO","Pinegrow PRO","Your edition of Pinegrow does not include Pinegrow PRO features. Please upgrade to the PRO edition to continue using projects, master pages and components.")};withPineCone(function(){class r extends PgPineConeCommand{constructor(e){super(e,`/Your task is to take the component HTML code and create a component by calling the create_component function. Inspect the component code and come up with id, name and description that perfectly fit the purpose of this component. Focus on the general purpose of the component, not on its current content that is just a placeholder. 
                
Use - to separate words in the id. For example: products-grid.                
                
Component code:
#CODE
`,"none"),this.temperature=0}getFunctions(){return[{name:"create_component",description:"Creates a component.",parameters:{type:"object",properties:{id:{type:"string",description:"A unique lowercase component id. Examples: hero, services-cards, product-gallery"},name:{type:"string",description:"A human readable component name. Examples: Hero, Services card, Product gallery"},description:{type:"string",description:"A one sentence short description of the component. Example: Displays product images in a grid."}},required:["id","name","description"]}}]}async callFunction(e,t){if("create_component"===e){if(!(t.id&&t.name&&t.description))return"All function arguments are required. Please repeat the function call!";var n=pgMakeSlug(t.id.replace(/\-/g," "),!1,"-"),a=t.name,o=t.description,i=pgGetUrlNameWithoutExt(this.page.url);n=_e(i+"-"+n,this.pgel),this.ret_component_info={id:n,name:a,description:o}}return"STOP"}}ve=async function(e,t){if(!canMakeChange(e,"attr","data-pgc-define"))return!1;var n=e.getAttribute("data-pgc-define"),a=e.getAttribute("data-pgc-define-name"),o=e.getAttribute("data-pgc-define-description");if(n&&a&&o)w.showQuickError(`Nothing to do with ${e.getName()}. All component settings are already set.`);else{var i=new r(e);if(await i.preparePromptAndRun(),i.ret_component_info)return w.makeChanges(e,"Auto set component",function(){e.setAttribute("data-pgc-define",n||i.ret_component_info.id),e.setAttribute("data-pgc-define-name",a||i.ret_component_info.name),e.setAttribute("data-pgc-define-description",o||i.ret_component_info.description)}),t&&w.selectedElements.isSelectedElement(e)&&w.selectedElements.reselect(),!0;i.cancelled||w.showQuickError("Sorry. Unable to create the component.")}},we=async function(e){for(var t=(e=e||w.getSelectedPage()).sourceNode.find("header,section,main > div, footer").filter(function(e){return!e.getAttribute("data-pgc-define")}),n=0;n<t.length;n++)1<t.length&&w.showQuickMessage(`Creating component ${n+1} of ${t.length}...`),await ve(t[n],!0)},window.aiAutoCreateAllComponentsOnPage=we;const i=`Your task is to transform this element into an editable Pinegrow component. Pinegrow components are defined by placing special data-pgc-* attributes on HTML elements.

If the source code already includes data-pgx-* attributes ask user what changes they wish to make and then adjust the component according to user instructions.

First, create the component by adding the following attributes to the top HTML element:
data-pgc-define="component_id" (no spaces, only lowercase, - and _ are allowed)
data-pgc-define-name="Name"
data-pgc-define-description="Short description"

For example:
<div data-pgc-define="hero" data-pgc-define-name="Hero section" data-pgc-define-description="Large banner that is displayed at the top of a website." style="background-image:url('image.jpg')">
<h1>Hello</h1>
<p>This is a subheading</p>
<img src="poster.jpg" />
<div class="content">
    <p>Text...</p>
    <ul><li>List item 1</li><li>List item 2</li></ul>
</div>
<a href="">Get started</a>
</div>

Next, make elements editable, so that certain aspects of component instances can be customized:

To make the element editable add attribute:
data-pgc-edit="Field Name[options...]" (field name must be unique within the component, short, should be human friendly. Capital letters and spaces are allowed.)

Then, set which aspects of this HTML element should be editable (one or more):
- Inner content is editable by default. To make it non-editable add "no_content" to field options. For example data-pgc-edit="Field Name[no_content]"
- To make certain attributes editable list them in field options, for example data-pgc-edit="Field Name[href,target]"
- To make a background image editable add data-pgc-edit-bckimage="1"

Important:
- Each editable element can have multiple editable parts (content, attributes,...)
- Make images editable with data-pgc-edit="Field Name[no_content,src]". Add srcset,sizes is these are present on the source image.
- Make links (<a> elements) editable with data-pgc-edit="Field Name[href]" so that both the link href and link label can be editable. if the source <a> has a target attribute, list target attribute as well.
- If an element contains a lot of free form content that should be editable it is best to make that whole content of the parent element editable. But, if the content items follow a well-defined template make the sub-elements that contain the variable content directly editable.
- Only make the background image editable if a background image is already set on the element
- The top component element can also be editable
- Do not make any other changes to the HTML code - only add data-pgc-* attributes (unless asked by the user)
- Do not change any existing field names or component id, unless instructed by the user.

The whole code of the example component is now:
<div data-pgc-define="hero" data-pgc-define-name="Hero section" data-pgc-define-description="Large banner that is displayed at the top of a website." style="background-image:url('image.jpg')" data-pgc-edit="Background image" data-pgc-edit-bckimage="1">
<h1 data-pgc-edit="Heading">Hello</h1>
<p data-pgc-edit="Subheading">This is a subheading</p>
<img src="poster.jpg" data-pgc-edit="Image[src,no_content]" />
<img src="responsive.jpg" srcset="image1.jpg 80px, image2.jpg 100w" sizes="..." data-pgc-edit="Image[src,srcset,sizes,no_content]" />
<div class="content" data-pgc-edit="Content">
    <p>Text...</p>
    <ul><li>List item 1</li><li>List item 2</li></ul>
</div>
<a href="page.html" data-pgc-edit="Link[href]">Get started</a>
</div>

Output only the complete HTML code of the component.
`;ye=async function(e){var t=new PgPineConeCommand(e,i,"transform");t.name="Create editable component",t.require_gpt4=!0,await w.pineCone.run(t)},w.addEventHandler("on_pine_cone_get_presets",function(e,t){var n=t.presets||[],a=PgPineConeStoredCommandCategory,o=PgPineConeStoredCommand;n.push(new a("Components","Create and manage Pinegrow static HTML components.").add(new o("Create editable component",i,"transform",``,null,{require_gpt4:!0}))),n.presets=n})})})});