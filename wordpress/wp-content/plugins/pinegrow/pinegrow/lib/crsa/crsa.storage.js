!function(l){l.fn.crsastorage=function(e){return r[e]?r[e].apply(this,Array.prototype.slice.call(arguments,1)):"object"!=typeof e&&e?void l.error("Method "+e+" does not exist on jQuery.crsastorage"):r.init.apply(this,arguments)};var o,t=[],i="service/index.php",s=null,r={init:function(e){l.extend({},l.fn.crsastorage.defaults,e)},auth:function(){},authDone:function(){e()},createProject:function(e){o.mkdir("/"+e,function(e,n){e?showError(e):(t.push(n),o.makeUrl(n.path,{long:!0},function(e,n){e?showError(e):console.log(n)}))})},openProject:function(e){s=null;u("getProject",{pid:e},function(e,n){d(e)||(console.log(n),s=n,r.openProjectBrowser(s))})},openProjectBrowser:function(o){void 0!==o&&o||(o=s);function t(e,n){var o,r=l("<li/>").html("<div>"+e.name+"</div>").appendTo(n);r.data("crsa-node",e),e.children&&(o=l("<ul/>").appendTo(r),l.each(e.children,function(e,n){n.isFolder&&t(n,o)}))}var e=l("<div/>",{class:"crsa-project-browser"}).appendTo(l("body")),n=(l("<h2/>").html(o.name).appendTo(e),l("<div/>",{class:"crsa-project-tree"}).appendTo(e)),r=l("<div/>",{class:"crsa-project-grid"}).appendTo(e);l("<a/>",{href:"#",class:"crsa-project-upload"}).html("Upload").appendTo(e).on("click",function(){var t=c.data("crsa-node");return filepicker.pickAndStore({multiple:!0,services:["COMPUTER"]},{location:"S3",path:t.storagePrefix},function(e){console.log(e),l.each(e,function(e,n){u("addFile",{pid:o.pid,filePickerUrl:n.url,key:n.key,fileName:n.filename,mimeType:n.mimetype},function(e,o){var r;d(e)||(console.log(o.file),r=-1,l.each(t.children,function(e,n){if(n.relativeUrl==o.file.relativeUrl)return r=e,!1}),0<=r?t.children[r]=o.file:(t.children.push(o.file),a(c)))})})},function(e){console.log(e)}),!1});function i(e,n){var o=e.name.toLowerCase(),r=n.name.toLowerCase();return o<r?-1:r<o?1:0}var a=function(e){var n,o=e.data("crsa-node");n=o,r.html(""),n.children&&(n.children.sort(i),l.each(n.children,function(e,n){n.isFile&&l("<div/>").html(n.name).appendTo(r)})),c&&c.removeClass("active"),e.addClass("active"),c=e},c=null,n=l("<ul/>").appendTo(n);return t(o.files,n),a(n.find(">li")),n.find("li").on("click",function(e){var n=l(e.delegateTarget);return a(n),!1}),e}},e=function(){t=[],o.readdir("/",{},function(e,n,o,r){e?showError(e):(console.log(r),l.each(r,function(e,n){var o;n.isFolder&&(t.push(o=n),console.log("Project "+o.name))}))})},d=function(e){return!!e},u=function(e,n,o){var r=l.ajax(i+"?cmd="+e,{data:n,type:"POST"});r.done(function(e){e.status&&"OK"==e.status?o(null,e):o(e.status,e)}),r.fail(function(e,n){o(n=n||"Unknown error")})};l.fn.crsastorage.defaults={}}(jQuery);