var PgActiveRules=function(y){function e(){var e=y||pinegrow.getSelectedElement();S!=e&&f(e,!1,!0)}function t(e,t){t.elementStyle||f()}function n(){f()}function r(){f()}function s(){f()}function o(){f()}function l(){f(!1,!1,!0)}function i(e,t){S&&S.getPage()==e&&e.activeView==t&&f()}function a(e,t){t&&v(t.node,t.stylesheet)}function d(e,t){t&&v(t.node,t.stylesheet,t.oldValue)}function c(e,t){t&&v(t.node,t.stylesheet)}var S=y||null,w=null,h=["active","hover","focus","visited"],g=$("body"),u=this,_=(this.matched_rules=null,this.show_all_rules=!1,this.setShowAllRules=function(e){this.show_all_rules=e,S=null},function(e){for(var t=["hover","active","focus","visited"],n=e,r=0;r<t.length;r++)n=n.replace(new RegExp(":"+t[r],"g"),".pg-state-"+t[r]);return n}),H=function(e,t){for(var n=!0,r=e.split(","),s=0;s<r.length;s++){var o=r[s].trim();">"===(o=o.replace(/&/g,"*"))[0]&&(o=o.substr(1,o.length).trim());for(var l=!1,i=0;i<h.length;i++){var a=":"+h[i];if(-1<o.indexOf(a))if(l=!0,o.length===o.indexOf(a)+a.length){if(":active"==a){if(t.hasClass("pg-state-active"))return!0;n=!1}if(":hover"==a){if(t.hasClass("pg-state-hover"))return!0;n=!1}if(":focus"==a){if(t.hasClass("pg-state-focus"))return!0;n=!1}if(":visited"==a){if(t.hasClass("pg-state-visited"))return!0;n=!1}}else for(var a=o.replace(/>\s*/g,">").replace(/ +(?= )/g,"").trim(),d=(a=_(a)).split(" "),c=t,g=d.length-2;0<=g;g--)if(">"===d[g+1][0]){if(!c.parent().length||!c.parent().is(d[g])){n=!1;break}}else if(0===(c=c.closest(d[g])).length){n=!1;break}}try{if(!l&&t[0].matches(o))return!0}catch(e){}}return!!n},N=function(e,t){return!e.selector||H(e.selector,t)},C=function(r,e){function s(e){return{node:e.getNodeWithPgId(r.id),pgStylesheet:e}}var o;return!r.file||r.file===e.getUniqueName()?s(e):(o=function(e){for(var t=0;t<e.length;t++){var n=e[t];if(n.getUniqueName()===r.file)return s(n);if(0<n.importedFiles.length){n=o(n.importedFiles);if(n)return n}}})(e.importedFiles)||null},p=function(e){for(var t=0;t<h.length;t++)e=e.replace(":"+h[t],".pg-state-"+h[t]);return e},f=function(e,t,n){var r=null==w?!1:!0;u.clear(),S=y||e||pinegrow.getSelectedElement(),u.updateMatchedRules(!0,null,{triggerOnNull:r,varTrigger:t,stylesheetChanged:n})},v=function(e,t,n){if(S){function r(e,t){if(e){var n=S.getDOMElement(),r=p(e.selector);try{if(n.matches(r))return f(null,t),!0}catch(e){}}return!1}var s,o=pinegrow.pgPostCSSHelper;if("rule"===o.getNodeType(e))r(e);else if("atrule"===o.getNodeType(e)){if("media"==e.name)for(var l=e.nodes,i=0;i<l.length;i++){var a=l[i];if("rule"===o.getNodeType(a))if(r(a))break}}else"import"===o.getNodeType(e)?f():"decl"===o.getNodeType(e)&&(t.isVarValue(e.value)||n&&t.isVarValue(n.value))&&(s=e.parent,"rule"===o.getNodeType(s))&&r(s,!0)}},m=null,E=[];function P(e,t,n,r,s,o,l){var i=(o=o||S).getPage();if(e){for(var a=[],d=0;d<t.length;d++){var c=e.indexOf(t[d]);0<=c&&(a.push(t[d]),e.splice(c,1))}for(var g=e.length-1;0<=g;g--)a.unshift(e[g]);t=a}for(var h=[],g=t.length-1;0<=g;g--){var u=pgStylesheetHelper.getParentStylesheetBySelector(t[g],i);if(u||(u=t[g].csurl&&(u=pinegrow.getStylesheetByUrl(t[g].csurl))&&u.sourceStylesheet?u.sourceStylesheet:u))if(u.ignore&&!l)H(t[g].text,o.get$DOMElement())&&(n[_=u.getUniqueName()]||(n[_]={name:u.name,stylesheet:u,nodesNo:0}),h.push({matched_rule:t[g],pgStylesheet:u}),n[_].nodesNo++);else{for(var _,p,f={},v=!1,m=t[g].selectors,y=0;y<m.length;y++){var w=m[y].text;if(!v){var E=w.match(/\.pg-node-id-([0-9]+)/);if(E&&1<E.length){f["id"]=E[1],v=!0;continue}}E=w.match(/\.pg-file-(.*)/);E&&1<E.length&&(f["file"]=E[1])}v&&(f["file"]||(f["file"]=u.getUniqueName()),r[_=f["file"]+"_"+f["id"]]||(r[_]=f["id"],p=(u=C(f,u)).node,u=u.pgStylesheet,p&&N(p,o.get$DOMElement())&&s.push({node:p,pgStylesheet:u})))}}return{nodes_to_show:s,ignored_matched_rules:h,active_states:[],more_nodes:n,matched_rules:t}}this.clearCallbackList=function(){E=[]},this.updateMatchedRules=function(r,s,o){o=o||{},m&&(m!==S?(m=null,E=[]):s&&E.push(s)),m||(m=S,E=[],crsaGetFreshMatchedRules(S,function(e,t,n){u.matched_rules=e,r&&u.updateActiveNodes(o.triggerOnNull,o.varTrigger,o.stylesheetChanged,o.rule_list,t,n),s&&s(!0),E.forEach(function(e){e(!0)}),m=null,E=[]}))},this.getMatchedRules=function(e){this.matched_rules?e(this.getShownNodes()):this.updateMatchedRules(!1,function(){e(u.getShownNodes())})},this.updateActiveNodes=function(e,n,r,t,s,o){function l(){var e,t;v&&!y&&(e=n?"on_css_active_var_changed":"on_css_active_rule_changed",t=null,S&&(t=S.getPage()),pinegrow.dispatchEvent(e,t,{active_nodes:w,stylesheet_changed:r}))}var i,a,d,c,g,h,u,_,p,f,v=!1,m=this.show_all_rules;S||m?(i={},a=t||this.matched_rules||[],d=S?S.get$DOMElement():null,S&&(c=S.getPage()),v=(isApp()?((w=P(null,a,i,{},[])).inline_rules=o,w.inherited=[],s&&s.forEach(function(e){var r=P(e.selectors,a,i,{},[],e.pgel,!0);loadInlineAsStylesheetAndGetRules(e.pgel,function(e,t){for(var n=e.length-1;0<=n;n--)e[n].nodes.length&&r.nodes_to_show.unshift({node:e[n],pgStylesheet:t})}),r.nodes_to_show.length&&w.inherited.push({pgel:e.pgel,data:r})})):(g=[],d&&!m?(h=d.get(0),u=0,_=function(e,n){h&&e.nodes&&e.nodes.forEach(function(e){if("atrule"!==e.type||"import"!==e.name)if("rule"===e.type)try{var t=e.selector.replace(/\:[^\s,$]+/gi,"");h.matches(t)&&g.push({node:e,pgStylesheet:n,idx:u++,spec_array:null})}catch(e){}else"decl"!==e.type&&_(e,n)})},p=function(e){(e=e.compiledStylesheets.length?e.compiledStylesheets[0]:e).getImportedStylesheets().forEach(function(e){e.ignore||p(e)}),e.rootNode&&_(e.rootNode,e)},(c?c.stylesheets.getList({imported:!1}):pinegrow.stylesheets.getAllCrsaStylesheets()).forEach(function(e){var t=e.inlineSheetPgel&&e.inlineSheetPgel.hasAttribute("data-pg-injected");(t=e.ignore?!0:t)||p(e)}),g.sort(function(e,t){e.spec_array||(e.spec_array=SPECIFICITY.calculate(e.node.selector)[0].specificityArray),t.spec_array||(t.spec_array=SPECIFICITY.calculate(t.node.selector)[0].specificityArray);var n=SPECIFICITY.compare(e.spec_array,t.spec_array);return-1*(n=0===n?e.idx>t.idx?1:-1:n)})):m&&(f=function(e,t){e.nodes&&e.nodes.forEach(function(e){"rule"===e.type?g.push({node:e,pgStylesheet:t}):"decl"!==e.type&&f(e,t)})},pinegrow.stylesheets.getAllCrsaStylesheets().forEach(function(e){e.inlineSheetPgel&&e.inlineSheetPgel.hasAttribute("data-pg-injected")||f(e.rootNode,e)})),w={nodes_to_show:g,ignored_matched_rules:[],active_states:[],more_nodes:[],matched_rules:[],inline_rules:[],inherited:[]}),!0),l()):e&&(v=!0,l())},this.getActiveNodes=function(){return w},this.clear=function(){w=null,this.clearCallbackList()},this.getPgel=function(){return S},this.setPgel=function(e){S=e},this.getShownNodes=function(){return w?w.nodes_to_show.map(function(e){return e.node}):[]},this.isRuleShown=function(e){if(w)for(var t=0;t<w.nodes_to_show.length;t++)if(w.nodes_to_show[t].node===e)return!0;return!1},y?f():pgf.edit_css&&(pinegrow.addEventHandler("on_page_stylesheets_loaded",e),pinegrow.addEventHandler("on_stylesheet_closed",t),pinegrow.addEventHandler("on_css_pseudo_updated",n),pinegrow.addEventHandler("on_selected_elements_changed",r),pinegrow.addEventHandler("on_active_page_view_changed",i),pinegrow.addEventHandler("on_page_view_resized",i),pinegrow.addEventHandler("on_page_closed",i),pinegrow.addEventHandler("on_css_node_added",a),pinegrow.addEventHandler("on_css_node_updated",d),pinegrow.addEventHandler("on_css_node_deleted",c),pinegrow.addEventHandler("on_element_classes_changed",o),pinegrow.addEventHandler("on_css_source_changed",s),pinegrow.addEventHandler("on_element_classes_changed",s),g.on("crsa-stylesheets-changed",l)),this.destroy=function(){this.clear(),y||pgf.edit_css&&(pinegrow.removeEventHandler("on_page_stylesheets_loaded",e),pinegrow.removeEventHandler("on_stylesheet_closed",t),pinegrow.removeEventHandler("on_css_pseudo_updated",n),pinegrow.removeEventHandler("on_selected_elements_changed",r),pinegrow.removeEventHandler("on_active_page_view_changed",i),pinegrow.removeEventHandler("on_page_view_resized",i),pinegrow.removeEventHandler("on_page_closed",i),pinegrow.removeEventHandler("on_css_node_added",a),pinegrow.removeEventHandler("on_css_node_updated",d),pinegrow.removeEventHandler("on_css_node_deleted",c),pinegrow.removeEventHandler("on_element_classes_changed",o),pinegrow.removeEventHandler("on_css_source_changed",s),pinegrow.removeEventHandler("on_element_classes_changed",s),g.off("crsa-stylesheets-changed",l))}};