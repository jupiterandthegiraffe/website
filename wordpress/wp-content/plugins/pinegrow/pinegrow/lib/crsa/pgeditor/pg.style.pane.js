"use strict";window.PgStylesPane=function(N,r,a,p,C){this.pgStylesheet=N,this.filter="",this.itemSelector="li[data-node-indices]",this.selectingNextElm=!1;function M(l){function a(e,t){var n,o=!1;t&&(n=$(l).parent().next()).is("ul")&&0<(n=n.find("> li:first-child > div > .crsa-scss-prop").first()).length&&(b.editField(n),o=!0),o||(e.is("li")?0==(n=e.next()).length?b.addNewNodeInsideOrBesideCurrentNode(e):b.editField(n.find(" > div > .crsa-scss-prop").first()):a(e.closest("li"),!1))}S.selectingNextElm=!0;var e=$(l).parent().find("> span.crsa-scss-prop").last();0<e.length&&l!=e[0]?b.editField(e):a($(l),!0)}function q(e){function a(e){var t,n,o,l;e.is("li")?(t=!1,0==(n=e.prev()).length&&0<(l=e.parent("ul")).length&&(0<(o=l.siblings("div").find("> .crsa-scss-prop").last()).length?(b.editField(o),t=!0):e.parent().is("ul.sass-root-node")&&(n=e.parent().find("> li:last-child"),b.editField(n.find(" > div > .crsa-scss-prop").last()))),t||(0<(l=n.find("> ul")).length?b.editField(l.find("> li:last > div > .crsa-scss-prop").last()):b.editField(n.find(" > div > .crsa-scss-prop").last()))):a(e.closest("li"))}S.selectingNextElm=!0;var t=$(e).parent().find("> span.crsa-scss-prop").first();0<t.length&&t[0]!=e?b.editField(t):a($(e))}function j(){pinegrow.showQuickMessage("You can't add <code>@import</code> here",4e3)}function U(e,t){var n,o=0,l=e.text(),a=crsaGetCaretPosition(e[0])[0],r=a,s="";for(r--;0<=r&&r<l.length&&" "!=l[r];)s=l[r]+s,r--;for(n=r+1,r=a;0<=r&&r<l.length&&" "!=l[r];)s+=l[r],r++;var d,i,p,o=r;return!!((a=s.match(/^\-?[0-9]+/))&&0<a.length)&&(d=(p=parseInt(a[0]))+t,i=!1,p=new RegExp("^"+p),p=s.replace(p,d),a[0].length==s.length&&(p+="px",i=!0),e.text(l.substring(0,n)+p+l.substring(o)),i&&(o+=2),a[0].length>(d+"").length?o--:a[0].length<(d+"").length&&o++,crsaSetCaretPosition(e[0],n,o),!0)}function W(e,t,n){function a(e,t){for(var n=e.length,o=0;o<n;o++){var l=e[o];t&&(r[s++]='<li data-node-indices="'+pinegrow.pgPostCSSHelper.getNodeIndices(l)+'" class="'+L(l)+'">'),r[s++]="<div>",r[s++]=G(l,!0),r[s++]="</div>",l.nodes&&0<l.nodes.length&&(r[s++]='<ul class="nested">',a(l.nodes,!0),r[s++]="</ul>"),t&&(r[s++]="</li>")}}var r=[],s=0,o=(a(t,n),e.attr("class",L(t[0])),e[0].innerHTML=r.join(""),e.find("span.decl-value,span.atrule-params"));x(o)}function s(e,t,n){for(var o=e,l=o.length,a=0;a<l;a++){var r,s,d=$(o[a]);d.hasClass("crsa-cm-placeholder")||d.hasClass("placeholder")||d.hasClass("placeholder-node")||(r=S.getNodeFrom(d),(s=d.find("> div")).html(G(r)),"decl"!=r.type&&"atrule"!=r.type||(r=s.find("> span.decl-value, > span.atrule-params"),x(r)),(d.hasClass("uncollapse")||t)&&(s=null,C["uncollapse-all"]&&(s="uncollapse-all"),B(d,s,!1,n)))}}var o=!1,l=["AliceBlue","AntiqueWhite","Aqua","Aquamarine","Azure","Beige","Bisque","Black","BlanchedAlmond","Blue","BlueViolet","Brown","BurlyWood","CadetBlue","Chartreuse","Chocolate","Coral","CornflowerBlue","Cornsilk","Crimson","Cyan","DarkBlue","DarkCyan","DarkGoldenRod","DarkGray","DarkGreen","DarkGrey","DarkKhaki","DarkMagenta","DarkOliveGreen","DarkOrange","DarkOrchid","DarkRed","DarkSalmon","DarkSeaGreen","DarkSlateBlue","DarkSlateGray","DarkSlateGrey","DarkTurquoise","DarkViolet","DeepPink","DeepSkyBlue","DimGray","DimGrey","DodgerBlue","FireBrick","FloralWhite","ForestGreen","Fuchsia","Gainsboro","GhostWhite","Gold","Goldenrod","Gray","Green","GreenYellow","Grey","HoneyDew","HotPink","IndianRed","Indigo","Ivory","Khaki","Lavender","LavenderBlush","LawnGreen","LemonChiffon","LightBlue","LightCoral","LightCyan","LightGoldenRodYellow","LightGray","LightGreen","LightGrey","LightPink","LightSalmon","LightSeaGreen","LightSkyBlue","LightSlateGray","LightSlateGrey","LightSteelBlue","LightYellow","Lime","LimeGreen","Linen","Magenta","Maroon","MediumAquaMarine","MediumBlue","MediumOrchid","MediumPurple","MediumSeaGreen","MediumSlateBlue","MediumSpringGreen","MediumTurquoise","MediumVioletRed","MidnightBlue","MintCream","MistyRose","Moccasin","NavajoWhite","Navy","OldLace","Olive","OliveDrab","Orange","OrangeRed","Orchid","PaleGoldenRod","PaleGreen","PaleTurquoise","PaleVioletRed","PapayaWhip","PeachPuff","Peru","Pink","Plum","PowderBlue","Purple","Red","RosyBrown","RoyalBlue","SaddleBrown","Salmon","SandyBrown","SeaGreen","SeaShell","Sienna","Silver","SkyBlue","SlateBlue","SlateGray","SlateGrey","Snow","SpringGreen","SteelBlue","Tan","Teal","Thistle","Tomato","Turquoise","Violet","Wheat","White","WhiteSmoke","Yellow","YellowGreen"],c=r.find(".rule-list").data("pg-sp",this),V=null,K=pgStylesheetHelper.getSCSSAutocomleteProps(),S=this,d=0,Y=!1,i=null,h="",Q=[],u=N.getUniqueName(),g=((C=C||{})["uncollapse"]=null!=C["uncollapse"]&&C["uncollapse"],C["uncollapse-on-click"]=void 0!==C["uncollapse-on-click"]&&C["uncollapse-on-click"],C["extra-rule-el-id"]=C["extra-rule-el-id"]||"",C["on-node-indices-changed"]=C["on-node-indices-changed"]||null,C["on-node-added"]=C["on-node-added"]||null,C["on-node-changed"]=C["on-node-changed"]||null,C["on-before-node-deleted"]=C["on-before-node-deleted"]||null,C["on-edit-finish"]=C["on-edit-finish"]||null,C["on-node-replaced"]=C["on-node-replaced"]||null,C["on-rule-id-changed"]=C["on-rule-id-changed"]||null,C["on-node-uncollapsed"]=C["on-node-uncollapsed"]||null,C["on-rule-selected"]=C["on-rule-selected"]||null,C["inversed-insert"]=C["inversed-insert"]||!1,C["is-allowed-insert-node"]=C["is-allowed-insert-node"]||null,C["created-by"]=C["created-by"]||"",C["skip-showing-comment"]=C["skip-showing-comment"]||!1,C["skip-showing-decl"]=C["skip-showing-decl"]||!1,C["skip-showing-atrule"]=C["skip-showing-atrule"]||!1,C["skip-showing-rule"]=C["skip-showing-rule"]||!1,C["item-length-to-add-placeholder"]=C["item-length-to-add-placeholder"]||0,C["auth"]=C["auth"]||{},C["auth"]["can_add_rule"]=0!=C["auth"]["can_add_rule"],C["auth"]["can_edit_rule"]=0!=C["auth"]["can_edit_rule"],"handle-element-selected"in C||(C["handle-element-selected"]=!0),C["show-all"]=C["show-all"]||!1,C["uncollapse-all"]=C["uncollapse-all"]||!1,C["read-only"]=C["read-only"]||!1,this.options=C,this.itemLengthToAddPlaceholder=C["item-length-to-add-placeholder"],this.getIndex=function(){return C["extra-rule-el-id"]},$('<ul class="sass-root-node '+N.getUniqueName()+"-container"+C["extra-rule-el-id"]+'"></ul>').appendTo(c)),b=new PgStylePaneHelper(this,g),z=null,X=null,f=function(e,t){z!=e&&(X&&X.removeClass("pg-selected-rule"),e&&t.addClass("pg-selected-rule"),z=e,X=t)},Z=this.selectRule=function(e,t){var n,o=null;null==e?(f(e),$.fn.crsa("selectRule",null,S)):e&&("rule"==e.type?(f(e,t),$.fn.crsa("selectRule",e,S)):"atrule"==e.type&&"media"==e.name?(f(null),$.fn.crsa("selectRule",null,S)):(o=pgcssh.getRuleForNode(e))&&(n=null,"decl"==e.type&&e.prop&&(n=e.prop),f(o,t.closest("li.crsa-rule")),$.fn.crsa("selectRule",o,S,null,n))),C["on-rule-selected"]&&C["on-rule-selected"](o||e,t)},J=function(e){var t=pgStylesheetHelper.getStylesheetFromNode(e);return S.pgStylesheet===t&&(t=`[data-node-indices="${pinegrow.pgPostCSSHelper.getNodeIndices(e)}"]`,(t=c.find("li"+t)).length)?t:null},m=function(e,t,n){var o,l;!t||t.source&&t.source===S||(t.rule&&(l=t.rule,o=J(l))?(f(l,o),n||(l=pgcssh.getMediaNode(l)?-30:0,pgScrollToItemInContainer(o,a,!1,!1,null,l),pgScrollToItemInContainer(o,a,!1,!1,null,l))):f(null))},e=function(v){var w,y,e,t=pinegrow.getSelectedElement(),n=pinegrow.getSelectedPage();t&&(n=n&&t.get$DOMElement())?(w=n.get(0),y=[],(e=function(e){if(e){for(var t=e.nodes_to_show,n=e.ignored_matched_rules,o=t,l=n,a=N.emptyNodes,r=0;r<a.length;r++){var s=a[r],d=s.nodes;try{w.matches(s.selector)&&(g={id:s["pg-node-id"]},"css"!=N.type&&N.imported&&1<d.length&&(g["file"]=d[0].value.replace(/[\'\"]/g,"")),y.push(g))}catch(e){}}if(N.ignore)for(r=0;r<l.length;r++){var i=l[r];if(i.pgStylesheet.getUniqueName()==N.getUniqueName()){for(var p={},c=!1,u=i.matched_rule.selectors,h=0;h<u.length;h++){var g=u[h].text;if(!c){var f=g.match(/\.pg-node-id-([0-9]+)/);if(f&&1<f.length){p["id"]=f[1],c=!0;continue}}f=g.match(/\.pg-file-(.*)/);f&&1<f.length&&(p["file"]=f[1])}c&&y.push(p)}}else for(r=0;r<o.length;r++){var m=o[r];m.pgStylesheet.getUniqueName()==N.getUniqueName()&&(m=m.node,y.push({file:m["pg-file-name"],id:m["pg-node-id"]}))}return v&&v(y),!0}return!1})(pinegrow.pgActiveRules.getActiveNodes())||pinegrow.pgActiveRules.updateMatchedRules(!1,function(){o||e(pinegrow.pgActiveRules.getActiveNodes())})):v&&v([])},_=function(){r.find("li.selected").removeClass("selected"),e(function(e){var t=e.map(function(e){return!(N.imported&&!e["file"])&&"#pg-"+(e["file"]||u)+"-rule-id-"+e["id"]+C["extra-rule-el-id"]}).join(",");g.find(t).addClass("selected")})},ee=function(e){e=(e=(e=e.replace(/(\#[0-9a-fA-F]{3,6})/g,'<span style="margin-top:0;"><input class="color-input" value="$1"><span class="more-text">$1</span></span>')).replace(/(rgb\(\d{1,3}\s*,\s*\d{1,3}\s*,\s*\d{1,3}\s*\))/g,'<span style="margin-top:0;"><input class="color-input" value="$1"><span class="more-text">$1</span></span>')).replace(/(rgba\(\d{1,3}\s*,\s*\d{1,3}\s*,\s*\d{1,3}\s*,\s*[0-1]?(?:\.[0-9]+)*\s*\))/g,'<span style="margin-top:0;"><input class="color-input" value="$1"><span class="more-text">$1</span></span>');var t=new RegExp("(^|\\s|\\(|\\,)("+l.join("|")+")\\b","gi");return e=e.replace(t,'$1<span style="margin-top:0;"><input class="color-input" value="$2"><span class="more-text">$2</span></span>')},v=function(e,t){var n=e.data("connected-node");if(n)for(var o=0;o<n.length;o++){var l=n[o].varName,a=N.getDeclCharachter()+l,l=n[o].el.find(".input-color-for-"+l);l.siblings(".more-text").html()==a&&l.siblings(".color-value-placeholder").css("background-color",t)}},t=function(e){function l(e,t,n){var o,l,a=e.val(),r=e.data("decl"),s=null;r?(r=r.node,pgcssh.setNodeProperty(r,"value",a),(o=(s=l=(r=e.data("decl").el).find(".decl-value")).find(".more-text")).text(a),r.find(".decl-value .color-input").spectrum("set",e.val()),n||y(l[0],!1,!1,function(){g.find(".pg-selected-rule")}),v(s,a)):(r=e.spectrum("get")).isValid()&&(o=e.siblings(".more-text"),l=d(r),o.text(l),s=a=e.closest(".decl-value,.atrule-params"),e.siblings(".color-value-placeholder").css("background-color",l),n||y(a[0],!1,!1,function(){g.find(".pg-selected-rule")},!t),v(s,l))}function t(e){var t=e.closest(".rule-list").data("pgSp"),n=t.pgStylesheet,o=e.closest("li");(t=t.getNodeFrom(o))&&(o=o.data("node-last-value"),pinegrow.dispatchEvent("on_css_node_updated",null,{node:t,stylesheet:n,oldValue:o}))}var n=null,a=null;var d=function(e){return 1==e.toRgb()["a"]?e.toHexString():e.toRgbString()},r=null;function s(o){o.spectrum({clickoutFiresChange:!0,showInitial:!0,allowEmpty:!0,preferredFormat:"hex",appendTo:o.closest("body"),showAlpha:!0,color:o.val(),showInput:!0,change:function(e){var t=$(this).closest("li"),n=S.getNodeFrom(t),t=t.data("node-last-value");$(this).val(d(e)),l($(this),!0),C["on-edit-finish"]&&C["on-edit-finish"](n,N,S),pinegrow.dispatchEvent("on_css_node_updated",null,{node:n,stylesheet:N,oldValue:t,undoCombineKey:"colorPicked_"+n.prop,action:"Set "+n.prop,undoRuleName:null})},move:function(e){var t=this;null!==r&&(l($(t),!1,!0),clearTimeout(r)),r=setTimeout(function(){$(t).val(d(e)),l($(t))},400)},show:function(e){var t,n;Y=!0,o=$(this),a=d((i=o).spectrum("get")),pinegrow.getSelectedPage()&&(g.data("properties-in-edit-mode",!0),t=$(this).closest("li"),n=S.getNodeFrom(t))&&(this.valueBeforeColorPickerChange=n.value,n=pgcssh.getValuesFromNode(n),t.data("node-last-value",n))},hide:function(e){var t;$(this).data("just-opened")?$(this).spectrum("show"):($(this).hasClass("master-color")&&$(this).next().hide(),Y=!1,i=null,d(e)==a&&l($(this))),$(this).data("just-opened",!1),g.data("properties-in-edit-mode",!1),t=o,setTimeout(function(){try{t.siblings(".color-value-placeholder").show(),t.spectrum("destroy"),t.hide()}catch(e){}},10)}}),new PgSpectrumHelper(o,{"mouse-moved":l,"color-picked":t})}e=e.find(".color-input"),$.each(e,function(e,t){(n=$(t)).hide();var o=$('<div class="color-value-placeholder"></div>');o.css("background-color",n.val()),o.insertAfter(n),o.click(function(e){var t,n;return e.preventDefault(),C["read-only"]?(t=$(this).closest("li"),n=S.getNodeFrom(t),Z(n,t)):N.canEdit(!1,!0)&&(o.hide(),(n=o.siblings(".color-input")).val(o.css("background-color")),s(n),n.spectrum("show")),!1})})},te=function(e){e.each(function(e,t){var o=$(t),n=w(o),l=ee(n),a={},n=("scss"!=N.fileType&&"less"!=N.fileType||(a=Pe(o)),(l=l.replace(/(\$[A-Za-z0-9\_\-]*)/g,function(e){var t,n;return a[e]&&1==a[e].el.find(".color-input").length&&w(a[e].el.find(".decl-value")).trim()==a[e].el.find(".more-text").text().trim()?(n=a[e].el.find(".decl-value").data("connected-node"),t=e.substr(1,e.length),(n=n||[]).push({el:o,varName:t}),a[e].el.find(".decl-value").data("connected-node",n),'<span class="color-from-decl-prop"><input class="color-input input-color-for-'+t+'" value="'+a[e].node.value+'"><span class="more-text">'+e+"</span></span>"):e})).length!=n.length&&(o[0].innerHTML=l),o.find(".color-from-decl-prop"));0<n.length&&(n.find("> .color-input"),n=(l=n.find("> .more-text")).text(),l.data("master-color",a[n]))})},x=function(e){te(e),t(e)},k=(this.blurCallback=function(e){var t=e.target,t=$(t),n=(d=0,this.getNodeFrom(t.closest("li")));("decl"==n.type&&"value"==t.data("prop-name")||"atrule"==n.type&&"params"==t.data("prop-name"))&&x(t),t.hasClass("simple-autocomplete-input")&&t.data("simple-autocomplete").close(),k(n)&&"css"==N.fileType&&le(N)},this.editFinishedCallback=function(e){var t=$(e.target),n=t.closest("li");if(!n.data("add-new-node")){var o=this.getNodeFrom(n);if(!o)return;C["on-edit-finish"]&&C["on-edit-finish"](o,N,S);var n=n.data("node-last-value");pinegrow.dispatchEvent("on_css_node_updated",null,{node:o,stylesheet:N,oldValue:n,undoCombineKey:"editFinishedCallback_"+(o.prop||""),action:"Set "+(o.prop||"CSS property")}),t.hasClass("decl-value")&&v(t,o.value)}N&&(n=N.getCascadeError())&&pinegrow.showQuickError(n.message||n)},this.keyupCallback=function(e){var t=$(e.target).closest("li");return!this.getNodeFrom(t)||(y(e.target,!0,!1,null,!0),!1)},function(e){return e&&("atrule"==e.type||"import"==e.type)&&"import"==e.name}),ne=function(e){return e&&"atrule"==e.type&&"media"==e.name},oe=function(e){return e&&"atrule"==e.type&&"supports"==e.name},P=function(e,t,n,o,l){if(N){var a;if(n)if(N.updateSingleRule)return a=null,"delete"===o&&l&&"decl"===l.type&&(a=l.prop),void N.updateSingleRule(n,function(){e&&e(N.getRootNode())},a,null);N.setSourceForRules(N.rootNode,function(){e&&e(N.getRootNode())},!1,!0)}},w=function(e,t){t=t||".sp-replacer";return(e.clone().find(t).remove().end().text()||"").trim()},y=function(e,t,n,o,l,a,r){var s=$(e).closest(".crsa-scss-prop"),d=(s=0==s.length?$(e):s).closest("li"),i=S.getNodeFrom(d);if(i&&"true"!=d.attr("data-removed")){$(e).find("more-text");var p=w(s),c=("atrule"==i.type||"import"==i.type)&&"@"==p[0],u="less"==N.fileType&&"atrule"==i.type&&i.mixin;if((c||u&&"name"==s.data("prop-name"))&&(p=p.substr(1,p.length)),("decl"==i.type||"atrule"==i.type&&"value"==s.data("prop-name"))&&(c=!1,-1<p.indexOf(";")&&(p=p.replace(/\;/g,""),c=!0),":"==p[p.length-1]&&(p=p.substr(0,p.length-1),c=!0),c)&&!t&&(s.text(p),x(s)),"value"==s.data("prop-name")&&i.important&&(i.important=!1),i[s.data("prop-name")]==p)return;i[s.data("prop-name")]=p}1&&(t=a,a=r,h=h||$(e).data("old-text"),u=$(e).data("prop-name"),"true"!=d.attr("data-removed")&&C["on-node-changed"]&&C["on-node-changed"](i,N,h,u,S),u=null,i&&"decl"==i.type&&(u=pgcssh.getRuleForNode(i)),P(function(e){n&&(R(N.rootNode.nodes),"true"!=d.attr("data-removed")&&A(d),_()),o&&o()},l,u,t,a)),h=w(s)},le=(this.keydownCallback=function(e){var t,n=$(e.target),o=n.closest("li"),l=e.keyCode||e.which;return 13==l||9==l?!("value"==n.data("prop-name")&&N.isVarValue(n.html())||(n.is("[contenteditable]")&&(this.getNodeFrom(o),o.data("add-new-node")?(o.data("add-new-node",!1),b.addNewNodeInsideOrBesideCurrentNode(o)):(e.shiftKey?q:M)(e.target)),0)):38==l?(e.preventDefault(),t=1,e.shiftKey&&(t=10),U(n,t)):40==l?(e.preventDefault(),t=-1,e.shiftKey&&(t=-10),U(n,t)):void 0},function(e){for(var t=pinegrow.stylesheets.getPagesForStylesheet(e),n=0;n<t.length;n++)t[n].refresh()}),F=(this.focusCallback=function(e){var t,n;C["read-only"]||(h="",t=$(e.target),n=this.getNodeFrom(t.closest("li")),t.hasClass("simple-autocomplete-input")||("prop"==t.data("prop-name")?Ie(t):"value"==t.data("prop-name")&&Te(t,!0)),n?"rule"!=n.type&&n.parent:(n=t.closest("li").parent().closest("li"),this.getNodeFrom(n)))},this.dblClickCallback=function(e){var t=$(e.target);this.getNodeFrom(t.closest("li"))},function(e){var t=e.parent();pgRemoveSpectrum(e,".color-input"),e.remove(),t.hasClass("sass-root-node")||Oe(t)}),I=(this.removeNode=function(e,t,n,o){var l,a=!1,r=S.getNodeFrom(e);return g.data("properties-in-edit-mode",!0),e.attr("data-removed","true"),pinegrow.dispatchEvent("on_css_before_node_deleted",null,{node:r,stylesheet:N}),C["on-before-node-deleted"]&&C["on-before-node-deleted"](r,N,S),A(e),function(e){var t,n;if(e)return-1<(n=(t=e.parent.nodes).indexOf(e))&&(t.splice(n,1),k(e))&&(N.removeImportedFile(e),"css"==N.fileType)&&le(N),!0}(r)&&(l=e.parent().hasClass("sass-root-node")&&C["inversed-insert"],_e(e,r,-1,l),a=!0),g.data("properties-in-edit-mode",!1),t||y(e,!1,a,function(){a&&(F(e),b.onNodeRemoved()),pinegrow.dispatchEvent("on_css_node_deleted",null,{node:r,stylesheet:N}),o&&o()},null,"delete",r),n&&F(e),a},this.nodeEditDone=function(e,t){var n,o=!1,l=null;""==$(e).text()&&(n=$(e).closest("li"),l=S.getNodeFrom(n),o=this.removeNode(n,!0)),y(e,!1,o,function(){o?(pinegrow.dispatchEvent("on_css_node_deleted",null,{node:l,stylesheet:N}),F(n),b.onListUpdated()):g.find(".pg-selected-rule")})},this.recompileCode=function(e){P(e)},function(e){return $('<li class="placeholder-node crsa-node" draggable="true"></li>').appendTo(e)}),H=function(e){return e.addClass("has-children"),$('<ul class="nested"></ul>').appendTo(e)},ae=function(e){var t=e.closest("ul");t.parent().hasClass("crsa-node")&&0<(t=t.find("> .placeholder-node")).length&&t.remove()},T=(this.addNewNodeUI=function(e,t,n){var o=e.closest("li"),l=(!n&&o.parent().hasClass("sass-root-node")&&(t=this.pgStylesheet.rootNode),pinegrow.pgPostCSSHelper.getNodeFromText(e.text(),t,n,this.pgStylesheet));if(l){var a=null,r=(ae(o),e.addClass("crsa-scss-prop"),o.attr("draggable","true"),o.data("placeholder-item",!1),o.data("add-new-node",!0),o.data("node",l),o.addClass("crsa-node crsa-"+l.type),("rule"!=l.type||"rule"==l.type&&C["auth"]["can_edit_rule"])&&o.addClass("has-options"),function(e){e.prepend('<i class="collapse-icon icon-down"></i>')}),s=function(t,e,n){ke(t);var o=S.getNodeFrom(t),l=t.attr("data-node-indices");E(o,!0,!0);function a(){P(function(e){R(N.rootNode.nodes),"true"!=t.attr("data-removed")&&A(t),_(),o=pinegrow.pgPostCSSHelper.getNodeByIndices(N.rootNode,l.split(",")),C["on-node-added"]&&C["on-node-added"](o,N,S),pinegrow.dispatchEvent("on_css_node_added",null,{node:o,stylesheet:N}),n&&n()})}k(o)?N.addImportedFile(o,function(e){e||a()}):a()},d=function(e,t,n){var o,l,a;$(t).attr("contenteditable")&&(l=(o=$(t).closest("li")).data("node"),"13"!=(a=e.keyCode||e.which)&&9!=a||(e.preventDefault(),$(t).off("keydown",i),l[$(t).data("prop-name")]=$(t).text(),n&&n(o),s(o,$(t),function(){b.addNewNodeInsideOrBesideCurrentNode(o)})),27==a)&&(e.preventDefault(),$(t).closest("li").remove())},i=function(e){d(e,this,a)},p=function(e,t,n){e.removeAttr("contenteditable"),t.attr("contenteditable","true"),crsaSelectText(t[0]),a=n,t.on("keydown",i)};if("decl"==l.type){e.addClass("decl-prop"),e.data("prop-name","prop");var c,u=styleToObject(l.prop),h=Object.keys(u),g=(e.off("keydown").off("blur"),t=e,c=$('<span class="crsa-scss-prop decl-value"></span>').insertAfter(t),$("<span>:&nbsp;</span>").insertBefore(c),c.data("prop-name","value"),e.removeAttr("contenteditable"),Te(c),!1),f=!1;0<h.length&&(u=u[h[0]])&&(f=!0,pgcssh.setNodeProperty(l,"prop",h[0]),g=!0,h=(h=u)&&h.trim(),"css"==N.fileType&&N.isVarValue(h)&&"css"==N.fileType&&(pinegrow.showQuickMessage("You can't use variables on css file"),g=!1),pgcssh.setNodeProperty(l,"value",h),c[0].innerHTML=l.value,x(c)),f||c.data("just-added",!0),c.attr("contenteditable","true"),c.focus(),crsaSelectText(c[0]),e[0].innerHTML=l.prop,s(o,e,function(){g&&b.addNewNodeInsideOrBesideCurrentNode(o)})}else if("rule"==l.type){var o=e.closest("li");e.addClass("rule-selector"),e.data("prop-name","selector"),e[0].innerHTML=l.selector;(w=e.data("simple-autocomplete"))&&w.destroy(),e.off("keydown").off("blur"),r(o.find("> div"));var m=H(o);I(m),s(o,e,function(){}),b.addNewNodeInsideOrBesideCurrentNode(o)}else if("atrule"==l.type){var v,w,o=e.closest("li"),h=(e.addClass("atrule-name"),e.data("prop-name","name"),n=e,u=$('<span class="crsa-scss-prop atrule-params"></span>').insertAfter(n),$("<span>&nbsp;</span>").insertBefore(u),u),y=(h.data("prop-name","params"),l.name.split(" "));if(e[0].innerHTML="@"+y[0],1<y.length)l.name=y[0],y.splice(0,1),"{"==y[v=y.length-1]&&(l.nodes=[],y.splice(v,1),m=H(o),I(m)),l.params=y.join(" "),h[0].innerHTML=l.params,x(h),s(o,h,function(){e.removeAttr("contenteditable"),b.addNewNodeInsideOrBesideCurrentNode(o),"css"==N.fileType&&k(l)&&le(N)});else{if("css"==N.fileType&&"import"==l.name&&N.isImported())return b.addNewNodeInsideOrBesideCurrentNode(o),o.remove(),void j();p(e,h,function(e){var t,n=e.data("node");n.params=n.params.trim(),e.find(".atrule-params");"{"==n.params[n.params.length-1]?(n.params=n.params.substr(0,n.params.length-1).trim(),e.find(".atrule-params")[0].innerHTML=n.params,n.raws.between=" ",n.nodes=[],r(e.find("> div")),t=H(e),I(t)):n.raws.between=""})}(w=e.data("simple-autocomplete"))&&w.destroy(),e.off("keydown").off("blur"),l.nodes&&r(o.find("> div"))}else"import"==l.type?(o=e.closest("li"),e.addClass("import-name"),e.data("prop-name","name"),t=e,f=$('<span class="crsa-scss-prop import-importPath"></span>').insertAfter(t),$("<span>&nbsp;</span>").insertBefore(f),(c=f).data("prop-name","importPath"),y=l.name.split(" "),e[0].innerHTML="@"+y[0],1<y.length?(l.name=y[0],y.splice(0,1),v=y.length-1,l.importPath=y.join(" "),c[0].innerHTML=l.importPath,s(o,c,function(){e.removeAttr("contenteditable"),b.addNewNodeInsideOrBesideCurrentNode(o)})):p(e,c,function(e){var t=e.data("node");t.importPath=t.importPath.trim(),e.find(".import-importPath");t.raws.between=""}),(w=e.data("simple-autocomplete"))&&w.destroy(),e.off("keydown").off("blur")):"comment"==l.type&&((o=e.closest("li")).find("div > input").prop("checked",!1),e[0].innerHTML=l.text,e.addClass("comment-text"),e.off("keydown").off("blur"),s(o,e),b.addNewNodeInsideOrBesideCurrentNode(o),o.data("add-new-node",!1))}},this.addingNewNode=function(e){Ie(e)},this.getStringOfSelectedItems=function(e){for(var t=g.find(".selected-item"),n="",o=0;o<t.length;o++){0!=o&&(n+="\n");var l,a=this.getNodeFrom($(t[o]));n+=N.stringifyNode(a),e&&(a=$(t[o]),l=o+1<t.length,S.removeNode(a,l),a.remove())}return 0<n.length&&(n+="\n"),n},function(e){if(null!=T){var t=e.keyCode||e.which;if(8==t||46==t){var n=g.find(".selected-item");if(0<n.length){for(var o=0;o<n.length;o++){var l=$(n[o]),a=o+1<n.length;S.removeNode(l,a),l.remove()}return $("body").trigger("crsa-stylesheets-changed",{by:C["created-by"]}),!1}}}}),re=function(e){null!=T&&Y&&i&&27==(e.keyCode||e.which)&&i.spectrum("hide")},se=($("#crsa-dummy-field").on("keydown",T).on("keyup",re),this.hasSelectedRules=function(){return 0<g.find(".selected-item").length},this.pasteTriggeredForNewField=function(l){var a=pinegrow.clipboard.getCurrentItem();N.parseSource(a.code,function(e,t,n){var o;e?"css"==a.type&&pinegrow.showAlert("There is an error in the copied text, can't paste it as css code","Can't paste code"):0!=n.nodes&&(o=l.closest("li"),o=xe(o),pinegrow.pgPostCSSHelper.insertNodesAt(n.nodes,o.parent,o.index),P(function(e){pinegrow.dispatchEvent("on_css_source_changed",null,{list:[N]})}))},!1)},function(e){var t=e.parent;return!(("rule"!=e.type||!t||!ne(t)&&!oe(t))&&C["skip-showing-"+e.type])}),de=function(e,t,n){function d(e,t){for(var n=e.length,o=0;o<n;o++){var l,a,r,s=e[o];t&&s["pg-node-id"]!=t["pg-node-id"]||!se(s)||D&&"decl"!=pgcssh.getNodeType(s)&&!pgcssh.searchInNode(s,D,N)||(l=p,a=-1<(r=L(s)).indexOf("uncollapse"),i[p++]='<li draggable="true" data-node-indices="'+pinegrow.pgPostCSSHelper.getNodeIndices(s)+'" class="'+r+'"'+ye(s)+">",i[p++]="<div>",""==(r=G(s,a))?i.splice(l,i.length-l):(i[p++]=r,i[p++]="</div>",a&&s.nodes&&0<s.nodes.length&&(i[p++]='<ul class="nested">',d(s.nodes,null),i[p++]="</ul>"),i[p++]="</li>"))}}var i=[],p=0,o=(d(t,n),e[0].innerHTML=i.join(""),e.find("span.decl-value,span.atrule-params"));x(o)},E=function(e,t,n){t=t||!1,e&&e.nodes&&S.pgStylesheet&&!C["uncollapse"]&&S.pgStylesheet.setCollapsedNode(e["pg-node-id"]||null,t)},ie=function(e){if(e&&e.nodes){if(S.pgStylesheet)return S.pgStylesheet.getCollapsedNode(e["pg-node-id"]||null);if(0<(t=pinegrow.pgPostCSSHelper.getNodesWithRegex("comment","text",/(pg-uncollapsed:(true|false))/,e)).length){var t=(t=t[0]).text.split(":"),n=t[0].trim(),t=t[1].trim();if("pg-uncollapsed"==n){if("true"==t)return!0;if("false"==t)return!1}}}return null},B=function(e,n,t,o){var l=e.find("> div > .collapse-icon");if(l.hasClass("icon-down"))"uncollapse"!=n&&((a=(e=l.closest("li")).find("> ul")).addClass("close"),l.removeClass("icon-down").addClass("icon-right"),s=S.getNodeFrom(e),E(s,!1));else if(l.hasClass("icon-right")&&"collapse"!=n){var a,r=!1,s=((a=(e=l.closest("li")).find("> ul"))&&0!=a.length?a.hasClass("close")&&(a.removeClass("close"),r=!0):a=H(e),S.getNodeFrom(e));if(!r){var d=s.nodes;if(d&&0<d.length){de(a,d,o),"uncollapse-all"==n&&a.find("> li").each(function(e,t){B($(t),n)}),m(null,{rule:pinegrow.getSelectedRule()},!0);for(var i=0;i<d.length;i++)C["on-node-added"]&&C["on-node-added"](d[i],N,S)}0==a.children().length&&I(a)}l.removeClass("icon-right").addClass("icon-down"),E(s,!0),_(),C["on-node-uncollapsed"]&&C["on-node-uncollapsed"](),t&&Z(s,e)}},pe=function(e){var t=e.find("> div > .collapse-icon");return t.hasClass("icon-down")?"uncollapsed":t.hasClass("icon-right")?"collapsed":void 0},ce=(this.toggleCodeIgnoring=function(e,t,r){var s=e.closest("li"),d=S.getNodeFrom(s),n=N.filterSource(pinegrow.pgPostCSSHelper.getSource(d));if(t){g.data("properties-in-edit-mode",!0),s.removeAttr("checked"),s.attr("data-removed","true"),s.addClass("crsa-comment");var o=n.replace(/\/\*/,"||*|").replace(/\*\//,"|*||"),l=pinegrow.pgPostCSSHelper.createNode("comment",o,null,d,N),a=pinegrow.pgPostCSSHelper.getNodeIndices(d);if(pinegrow.dispatchEvent("on_css_before_node_deleted",null,{node:d,stylesheet:N}),C["on-before-node-deleted"]){if(d.nodes&&0<d.nodes.length)for(var i=d.nodes,p=0;p<i.length;p++)C["on-before-node-deleted"](i[p],N,S);C["on-before-node-deleted"](d,N,S)}pinegrow.pgPostCSSHelper.replaceNodeWith(d,l),l["pg-node-id"]=d["pg-node-id"],W(s,[l]),k(d)&&N.ignoreImportedFile(d,!0),P(function(e){R(N.rootNode.nodes),"true"!=s.attr("data-removed")&&A(s),delete l["pg-node-id"],s.removeAttr("id"),s.attr("data-removed","false"),_(),s.attr("data-removed","false");var t=pinegrow.pgPostCSSHelper.getNodeByIndices(N.getRootNode(),a);pinegrow.dispatchEvent("on_css_node_added",null,{node:t,stylesheet:N}),g.data("properties-in-edit-mode",!1),r&&r(!0)})}else{g.data("properties-in-edit-mode",!0);var o=(n="/*"==(n=n.trim()).substr(0,2)&&"*/"==n.substr(n.length-2,n.length)?n.substr(2,n.length-4).trim():n).replace(/\|\|\*\|/,"/*").replace(/\|\*\|\|/,"*/");pinegrow.pgPostCSSHelper.parsedCSSSourceFromText(o,function(e,t,n){var o,l,a;e||0==n.nodes.length?(pinegrow.showQuickMessage("Can't un-comment this line",4e3),r&&r(!1)):(o=pinegrow.pgPostCSSHelper.getNodeIndices(d),l=n.nodes[0],"css"==N.fileType&&k(l)&&N.isImported()?j():(d["ignore"]=!1,s.removeClass("crsa-comment"),pinegrow.pgPostCSSHelper.copyNodeRawsTo(l,d),pinegrow.dispatchEvent("on_css_before_node_deleted",null,{node:d,stylesheet:N,operation:"ignore"}),pinegrow.pgPostCSSHelper.replaceNodeWith(d,l),W(s,[l]),a=r,P(function(e){R(N.rootNode.nodes),"true"!=s.attr("data-removed")&&A(s),_();var t=pinegrow.pgPostCSSHelper.getNodeByIndices(N.getRootNode(),o);E(t,!0),pinegrow.dispatchEvent("on_css_node_added",null,{node:t,stylesheet:N,operation:"ignore"}),C["on-node-added"]&&C["on-node-added"](t,N,S),g.data("properties-in-edit-mode",!1),a&&a(!0)})))})}},function(e){e.preventDefault();var t,n=$(e.target),o=n.closest("li"),l=o.hasClass("hoverd-bottom")||o.hasClass("hoverd-top");C["uncollapse-on-click"]||l?e.metaKey||e.shiftKey||(n.is("div")||n.parent().is("div"))&&(d++,t=(!o.hasClass("hoverd-bottom")&&!o.hasClass("hoverd-top")||o.hasClass("hoverd-middle"))&&!n.is("i"),setTimeout(function(){1<d?d--:(d=0,t&&B(o,null,!0))},170)):(l=S.getNodeFrom(o),Z(l,o))}),ue=function(e){d++},he=(this.isAllowedToAddNewNodeAt=function(e,t,n){var o;return!(C["is-allowed-insert-node"]&&!C["is-allowed-insert-node"](e,S,n,this)||e.data("placeholder-item")||e.hasClass("placeholder")||e.hasClass("new-node-placeholder")||e.hasClass("selected-item")||e.hasClass("placeholder-node")&&!e.hasClass("crsa-node")||t.is("span")||t.is("i")||(o=e.prev()).is(":visible")&&o.is(S.itemSelector)&&n==this.mousePositionVals.TOP||e.hasClass("crsa-rule")&&!C["auth"]["can_add_rule"])},this.isAllowedToEditNode=function(e,t){return!(e.hasClass("ui-helper-hidden-accessible")||e.hasClass("more-text")||t&&""!=w(e))},this.isDblClickEditingAllowed=function(e){var t=e.closest("li");return!((e=t).data("placeholder-item")||e.hasClass("crsa-cm-placeholder")||e.hasClass("placeholder")||e.hasClass("placeholder-node")||e.hasClass("new-node-placeholder")||"rule"==(t=S.getNodeFrom(t)).type&&!C["auth"]["can_edit_rule"]||!Array.isArray(t.nodes))},this.getSelectableObjForEditing=function(e){return e.hasClass("more-text")?e.closest(".editable"):null},function(e,t){for(var n=0;n<e.length;n++)t[n]&&t[n]["pg-node-id"]&&(e[n]["pg-node-id"]=t[n]["pg-node-id"]),e[n].nodes&&0<e[n].nodes.length&&t[n].nodes&&0<t[n].nodes.length&&he(e[n].nodes,t[n].nodes)}),R=function(e){},ge=function(e){for(var t=N.lastNodeId(),n=S.getNodeFrom(e)["pg-node-id"],o=e,l=new RegExp("pg-"+u+"-rule-id-([0-9]*)"+C["extra-rule-el-id"]),a=-1;n<=t;){var r=$("#pg-"+u+"-rule-id-"+n+C["extra-rule-el-id"]);if(0<r.length&&r.closest(".rule-list")[0]==c[0])for(;0<r.length;){n++,(o=$("#pg-"+u+"-rule-id-"+n+C["extra-rule-el-id"])).removeAttr("id");var s,d=S.getNodeFrom(r),i=-1;r.attr("id")?(s=r.attr("id").match(l))&&1<s.length&&(i=parseInt(s[1])):i=a,C["on-rule-id-changed"]&&C["on-rule-id-changed"](d,N,n,i,S),r.attr("id","pg-"+u+"-rule-id-"+n+C["extra-rule-el-id"]),r=o,a=n}else 0<o.length&&(d=S.getNodeFrom(r),C["on-rule-id-changed"]&&C["on-rule-id-changed"](d,N,n,null,S),o.attr("id","pg-"+u+"-rule-id-"+n+C["extra-rule-el-id"]),o=[]);n++}},fe=function(e){function o(e){for(var t=0;t<e.length;t++){var n=e[t];"rule"==n.type&&S.pgStylesheet.canAddRuleIds(n)&&l++,n.nodes&&0<n.nodes.length&&o(n.nodes)}}var l=0;return o(e.nodes||[]),l},me=function(e){var t,n=S.getNodeFrom(e),o=N.lastNodeId(),l=new RegExp("pg-"+u+"-rule-id-([0-9]*)"+C["extra-rule-el-id"]),a=e.attr("id");if(a)for(var r,s,d,a=a.match(l),i=(1<a.length&&(t=parseInt(a[1])),e),p=1+fe(n);t<=o+1;){if(0<(r=$("#pg-"+u+"-rule-id-"+t+C["extra-rule-el-id"])).length&&r.closest(".rule-list")[0]==c[0])for(;0<r.length;)(i=$("#pg-"+u+"-rule-id-"+t+C["extra-rule-el-id"])).removeAttr("id"),0==r.closest('li[data-removed="true"]').length&&(s=t-p,(d=S.getNodeFrom(r))&&(C["on-rule-id-changed"]&&C["on-rule-id-changed"](d,N,s,null,S),d["pg-node-id"]=s),r.attr("id","pg-"+u+"-rule-id-"+s+C["extra-rule-el-id"])),r=i;else 0<i.length&&(i.attr("id","pg-"+u+"-rule-id-"+t+C["extra-rule-el-id"]),i=[]);t++}},ve=function(e){for(var t=e;1;){var n=S.getNodeFrom(t);if(!n["pg-node-id"])break;var o=$("#pg-"+u+"-rule-id-"+n["pg-node-id"]+C["extra-rule-el-id"]);if(o[0]==t[0]){t.attr("id","pg-"+u+"-rule-id-"+n["pg-node-id"]+C["extra-rule-el-id"]);break}o.attr("id",""),t.attr("id","pg-"+u+"-rule-id-"+n["pg-node-id"]+C["extra-rule-el-id"]),t=o}},A=function(e,t){(t?ve:"true"==e.attr("data-removed")?me:ge)(e);var n=S.getNodeFrom(e);n&&n["pg-node-id"]&&e.attr("id","pg-"+u+"-rule-id-"+n["pg-node-id"]+C["extra-rule-el-id"])},we=$("<canvas></canvas>").get(0).getContext("2d"),ye=(we.font='13px -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Oxygen-Sans,Ubuntu,Cantarell,"Helvetica Neue",sans-serif',function(e){var t="";return e["pg-node-id"]&&(t+=' id="pg-'+u+"-rule-id-"+e["pg-node-id"]+C["extra-rule-el-id"]+'"'),t}),L=function(e){var t="crsa-node crsa-"+e.type;return("rule"!=e.type||"rule"==e.type&&C["auth"]["can_edit_rule"])&&(t+=" has-options"),"rule"!=e.type&&"atrule"!=e.type||(t+=" can-has-children"),1==ie(e)&&(t+=" uncollapse"),t},D=null,Ne=function(){S.filter&&(D=new RegExp(escapeRegExp(S.filter),"i"))},G=function(e,t){var n,o,l;return"comment"==e.type?"delete"==(o=N.filter(e)).haveTo?"":'<span class="crsa-scss-prop comment-text editable" data-prop-name="text">'+e.text.replace(/</g,"&lt;","g").replace(/>/g,"&gt;","g")+"</span>":"atrule"!=e.type||e.variable?"import"==e.type?'<span class="crsa-scss-prop import-name" data-prop-name="name">@'+e.name+'</span>&nbsp;<span class="crsa-scss-prop import-importPath" data-prop-name="importPath">'+e.importPath+"</span>":"decl"==e.type||"atrule"==e.type&&e.variable?"delete"==(o=N.filter(e)).haveTo?"":(n="prop",l=e.prop,"atrule"==e.type&&(n="name",l="@"+e.name),'<span class="crsa-scss-prop decl-prop editable" data-prop-name="'+n+'">'+l+'</span>:&nbsp;<span class="crsa-scss-prop decl-value editable" data-prop-name="value">'+e.value+(e.important?" !important":"")+"</span>"):"rule"==e.type?(n=e.selector,l='<span class="crsa-scss-prop rule-selector" data-prop-name="selector">'+(n="update"==(o=N.filter(e)).haveTo?o.newValue:n)+"</span>",e.empty?l:'<i class="collapse-icon '+(t?"icon-down":"icon-right")+'"></i>'+l):null:(n="",e.nodes&&(n='<i class="collapse-icon '+(t?"icon-down":"icon-right")+'"></i>'),l={name:e.name,params:e.params},"less"==N.fileType&&e.mixin?(l.name=`.`+l.name,0==l.params.length&&(l.params="()")):l.name=`@`+l.name,"update"==(o=N.filter(e)).haveTo&&(l[o.type]=o.newValue),n+'<span class="crsa-scss-prop atrule-name" data-prop-name="name">'+l.name+"</span>"+'&nbsp;<span class="crsa-scss-prop atrule-params" data-prop-name="params">'+l.params+"</span>")},O=null,n=!1,Ce=500,Se=(this.updateShownNodes=function(){if(!n)if(O||(O=g.find(" > li").first(),s(O,C["uncollapse"])),0==O.parents("html").length)n=!1;else{if(C["show-all"])(t=O.nextAll()).each(function(e,t){var n=$(t);s(n,C["uncollapse"])}),n=!0;else{var e=r.closest(".lm_content"),o=e.height();if(0==o)return;var t,l=e.offset().top,e=(t=O.nextAll()).length,a=-1;t.each(function(e,t){var n=$(t);if(a=e,!(n.offset().top-l-Ce<=o))return!1;s(O=n,C["uncollapse"])}),a==e-1&&(n=!0)}m(null,{rule:pinegrow.getSelectedRule()},!0)}},this.onlyShowNode=function(e){O||(O=g.find(" > li").first(),s(O,C["uncollapse"],e))},this.addNewNodePlaceholderTo=function(e){var t=e.find("> ul > li:last-child");addNewNodeLiClicked(t,!0,"rule")},this.addNewNodePlaceholderBefore=function(e){addNewNodeLiClicked(e,!1,"rule")},this.addNewNodePlaceholderAfter=function(e){addNewNodeLiClicked(e,!0,"rule")},this.uncollapseLi=function(e){B(e,"uncollapse")},this.collapseLi=function(e){B(e,"collapse")},this.addNewNodeIntoParent=function(t,e){ke(t,e),P(function(e){R(N.rootNode.nodes),A(t),_()})},this.moveNodeFromTo=function(e,t,n,o){for(var l=this.getNodeFrom(e),a=t.next();a.hasClass("crsa-cm-placeholder")||a.hasClass("placeholder");)a=a.next();var r=!1;if(0<a.length)(r=a.hasClass("placeholder-node")?!0:r)||(s=S.getNodeFrom(a),l.raws.before=s.raws.before,pinegrow.dispatchEvent("on_css_before_node_deleted",null,{node:l,stylesheet:N}),pinegrow.pgPostCSSHelper.removeNodeFrom(l),pinegrow.pgPostCSSHelper.insertNodeBefore(l,s));else{for(var s,d=t.prev();d.hasClass("crsa-cm-placeholder")||d.hasClass("placeholder");)d=d.prev();0<d.length&&((r=d.hasClass("placeholder-node")?!0:r)||(s=S.getNodeFrom(d),l.raws.before=s.raws.before,pinegrow.dispatchEvent("on_css_before_node_deleted",null,{node:l,stylesheet:N}),pinegrow.pgPostCSSHelper.removeNodeFrom(l),pinegrow.pgPostCSSHelper.insertNodeAfter(l,s)))}r&&(s=t.closest("li"),r=S.getNodeFrom(s),pinegrow.dispatchEvent("on_css_before_node_deleted",null,{node:l,stylesheet:N}),pinegrow.pgPostCSSHelper.removeNodeFrom(l),pinegrow.pgPostCSSHelper.insertNodeAt(l,r,0));var i=pinegrow.pgPostCSSHelper.getNodeIndices(l);P(function(e){var t=pinegrow.pgPostCSSHelper.getNodeByIndices(N.getRootNode(),i);pinegrow.dispatchEvent("on_css_node_added",null,{node:t,stylesheet:N})})},function(){null!=Se&&S.updateShownNodes()});a.on("scroll",Se),r.get(0).addEventListener("contextmenu",function(e){var t,n=$(e.target),o=n.text();n.hasClass("more-text")&&o[0]==N.getDeclCharachter()&&((t=new CrsaContextMenu(null,n)).add("Go to definition...",null,function(){var e=r.parent(),t=n.data("master-color").el.offset().top-e.offset().top;0!=t&&e.scrollTop(t+e.scrollTop()-30)}),t.add("Edit master color...",null,function(){N.varsPane.updateSearchValue(o)}),t.showAt(e.pageX,e.pageY,r)),e.preventDefault(),e.stopPropagation()},!0),r.find("> .cs-head").click(function(e){e.preventDefault();var t=g.find("> li:first-child");e=t,t=$('<li><div><span class="crsa-scss-prop"></span></div></li>'),0==e.length?g.append(t):t.insertBefore(e),t=t.find("span"),b.addNewNode(t,null)}),this.getNodeFrom=function(e){return e.attr("data-node-indices")?pinegrow.pgPostCSSHelper.getNodeByIndices(N.rootNode,e.attr("data-node-indices").split(",")):null};var be=function(e,t,n){function a(e,t){for(var n,o,l=t;0<l.length;)l.attr("data-node-indices")&&(n=e+","+(n=l.attr("data-node-indices").split(","))[n.length-1],o=pinegrow.pgPostCSSHelper.getNodeByIndices(N.rootNode,n.split(",")),pinegrow.dispatchEvent("on_css_node_indices_changed",null,{node:o,stylesheet:N,oldNodeIndices:l.attr("data-node-indices").split(","),currNodeIndices:n.split(",")}),C["on-node-indices-changed"]&&C["on-node-indices-changed"](o,N,l.attr("data-node-indices").split(","),n.split(","),S),l.attr("data-node-indices",n),o=l.find("> ul > li:first-child"))&&0<o.length&&a(n,o),l=l.next()}a(e,n)},_e=function(e,t,n,o,l){for(var a=-1,r=function(e,t){return t?e.prev():e.next()},s=pinegrow.pgPostCSSHelper.getNodeLevel(t),t=(l&&(a=parseInt(l.split(",")[s])),r(e,o)),d=s,i=n,p=o,c=t;0<c.length;){if(c.attr("data-node-indices")){var u=c.attr("data-node-indices").split(","),h=parseInt(u[d]);if(function(e){if(!(a<0))if(o){if(e<=a)return!0}else if(a+1<=e)return!0;return!1}(h))return;u[d]=h+i;var h=pinegrow.pgPostCSSHelper.getNodeByIndices(N.rootNode,u);pinegrow.dispatchEvent("on_css_node_indices_changed",null,{node:h,stylesheet:N,oldNodeIndices:c.attr("data-node-indices").split(","),currNodeIndices:u}),C["on-node-indices-changed"]&&C["on-node-indices-changed"](h,N,c.attr("data-node-indices").split(","),u,S,0<c.find("> ul > li").length),c.attr("data-node-indices",u.join(",")),(h=S.getNodeFrom(c)).nodes&&0<h.nodes.length&&(h=c.find("> ul > li:first-child"),be(u.join(","),d,h))}for(c=r(c,p);c.hasClass(".ui-sortable-helper");)c=r(c,p)}},xe=function(e,t){var n=0,o=null,l=null,a=e.next(),r=!1;return 0<(a=a.hasClass("crsa-cm-placeholder")||a.hasClass("placeholder")||a.hasClass("placeholder-node")?a.next():a).length?(a.hasClass("placeholder-node")&&(a.insertBefore(e),r=!0),r||(l=(a=S.getNodeFrom(a)).parent,n=a.parent.nodes.indexOf(a))):(o&&(n=o.nodes?o.nodes.length:0),0<(a=(a=e.prev()).hasClass("crsa-cm-placeholder")||a.hasClass("placeholder")||a.hasClass("placeholder-node")?a.prev():a).length&&((r=a.hasClass("placeholder-node")?!0:r)||(n=(o=S.getNodeFrom(a)).parent.nodes.indexOf(o)+1,l=o.parent))),l&&!r||(l=0<(a=e.parent().closest("li")).length?(n=0,S.getNodeFrom(a)):N.rootNode),{index:n,parent:l}},ke=function(e,t){t=t||S.getNodeFrom(e)||e.data("node");var n=!1,o=e.parent(),l=(i=o.hasClass("sass-root-node")?p&&0<p.length?(i=e.parent().find("> li:first-child"),e[0]==i[0]&&(i=e.next()),S.getNodeFrom(i).parent):N.rootNode:(i=e.parent().closest("li"),S.getNodeFrom(i)),0),a=e.next(),r=!1,a=(0<(a=a.hasClass("crsa-cm-placeholder")||a.hasClass("placeholder")||a.hasClass("placeholder-node")?a.next():a).length?(a.hasClass("placeholder-node")&&(a.insertBefore(e),r=!0),r||(n=(s=S.getNodeFrom(a)).parent,l=s.parent.nodes.indexOf(s),t.raws.before=s.raws.before,C["inversed-insert"]&&!a.parent().hasClass("nested")&&l++)):(l=i.nodes?i.nodes.length:0,0<(s=(s=e.prev()).hasClass("crsa-cm-placeholder")||s.hasClass("placeholder")||s.hasClass("placeholder-node")?s.prev():s).length&&((r=s.hasClass("placeholder-node")?!0:r)||(n=(d=S.getNodeFrom(s)).parent,l=d.parent.nodes.indexOf(d),t.raws.before=d.raws.before,C["inversed-insert"]&&!s.parent().hasClass("nested"))||l++)),o.parent().hasClass("active-rule-container")&&(i=n),r&&(n=S.getNodeFrom(e.closest(".nested").parent())),-1),s=(t.parent&&(a=t.parent.nodes.indexOf(t)),1),o=!1;if(t.parent==i){if(a==l-1)return;a<l&&-1!=a&&(s=-1,o=!0,l--)}var r=e.attr("data-node-indices"),n=(t.parent!=i&&V&&(_e(V,t,-1),r=null),t.parent&&(a=(n=t.parent.nodes).indexOf(t),n.splice(a,1)),t.parent!=i&&(t.parent=i),t.parent.nodes.splice(l,0,t),!1),d=t.prev(),a="decl"==t.type&&t.prop.startsWith(N.getDeclCharachter()),i=d&&"comment"==d.type&&d.text.startsWith(N.GROUP_TITLE_MARGIN),l=d&&"decl"==d.type&&d.prop.startsWith(N.getDeclCharachter()),d=(!a||l||i||(n=!0),pinegrow.pgPostCSSHelper.getNodeIndices(t).join(","));return e.attr("data-node-indices",d),C["inversed-insert"]&&!e.parent().hasClass("nested")&&(o=!o),be(d,pinegrow.pgPostCSSHelper.getNodeLevel(t),e.find("> ul > li:first-child")),_e(e,t,s,o,r),n},$e=function(e,t,n,o){o&&(t+=":"),e.text(t),9!=(n.keyCode||n.which)&&(n=jQuery.Event("keydown",{which:$.ui.keyCode.ENTER}),e.trigger(n))},Pe=function(e){for(var t={};1;){for(var n=e.closest("li"),o=n.prev();0<o.length;){var l=S.getNodeFrom(o);l&&("decl"==l.type?l.prop[0]!=N.getDeclCharachter()||t[l.prop]||(t[l.prop]={node:l,el:o}):"atrule"==l.type&&l.variable&&!t[l.name]&&(t[l.name]={node:l,el:o})),o=o.prev()}n=n.parent();if(!(0<n.length))return t;if(n.hasClass("sass-root-node"))return t;e=n}},Fe=function(e){for(var t=[],n=0;n<e.length;n++)for(var o=e[n],l=0;l<o.length;l++){var a=o[l];t.push(a.prop)}return t},Ie=function(e){new SimpleAutoComplete(e,{appendTo:r,focus:function(e,t,n){return n.text(t),crsaSelectText(n[0]),!1},select:function(e,t,n){return"@"==t[0]?$e(n,t,e,!1):$e(n,t,e,!0),!1},source:function(e,t,n,o){0==Q.length&&(Q=Object.keys(K)),o($.map(Q,function(e){return e.startsWith(t)?e:null}).slice(0,6))}})},He=function(e){var t,n;return"css"==N.type?null:(t=null,n=new RegExp("\\"+N.getDeclCharachter()+"[a-z0-9_\\-]*","ig"),(n=e.match(n))&&0<n.length?n[n.length-1]:t)},Te=function(e){new SimpleAutoComplete(e,{appendTo:r,focus:function(e,t,n){var o,l,a=t;return"css"!=N.type&&t.startsWith(N.getDeclCharachter())&&(o=n.text(),l=He(o))&&o.endsWith(l)&&(a=o.substr(0,o.length-l.length),a+=t),n.text(a),crsaSetCaretPlacement(n[0],!1),!1},select:function(e,t,n){return $e(n,t,e),!1},source:function(e,t,n,o){var l=n.siblings(".decl-prop").text(),a=[],r=(a=(a=(a=K[l]?K[l].values:a).concat(N.getAutocompleteArr())).concat(Fe(N.varGroups)),t),l=He(r);l&&r.endsWith(l)&&(r=l),o($.map(a,function(e){return e.startsWith(r)?e:null}).slice(0,6))}})},Ee=function(e){null!=Ee&&_()},Be=function(e,t,n,o,l){var a=0,r=[],s=L(e),d=-1<s.indexOf("uncollapse"),i=(l&&t.hasClass("pg-selected-rule")&&(s+=" pg-selected-rule"),a),s=(r[a++]='<li draggable="true" data-node-indices="'+pinegrow.pgPostCSSHelper.getNodeIndices(e)+'" class="'+s+'"'+ye(e)+">",r[a++]="<div>",G(e,d));if(""!=s)return r[a++]=s,r[a++]="</div>",r[a++]="</li>",s=$(r.join("")),n?(s.appendTo(t),ae(t)):o?s.insertAfter(t):s.insertBefore(t),d&&(a=$('<ul class="nested"></ul>').appendTo(s),de(a,e.nodes)),s;r.splice(i,r.length-i)},Re=function(i,e,p,c){var u=pinegrow.pgPostCSSHelper.getNodeIndices(i),h=pinegrow.pgPostCSSHelper.getNodeLevelFromIndices(u);e.children().each(function(e,t){var n,o,l,a,r,s,d=$(t);d.attr("data-node-indices")&&(n=d.attr("data-node-indices").split(","),a=pinegrow.pgPostCSSHelper.getNodeLevelFromIndices(n),o=parseInt(n[h])||0,l=parseInt(n[h-1])||0,r=u[h]||0,s=u[h-1]||0,h<=a&&r<=o&&s==l&&(c||(n[h]=o+p),a=pinegrow.pgPostCSSHelper.getRootNodeFor(i),r=pinegrow.pgPostCSSHelper.getNodeByIndices(a,n),c&&(n[h]=o+p),pinegrow.dispatchEvent("on_css_node_indices_changed",null,{node:r,stylesheet:N,oldNodeIndices:d.attr("data-node-indices").split(","),currNodeIndices:n}),C["on-node-indices-changed"]&&C["on-node-indices-changed"](r,N,d.attr("data-node-indices").split(","),n,S,0<d.find("> ul > li").length),d.attr("data-node-indices",n.join(","))),0<(s=d.find("> ul")).length)&&Re(i,s,p,c)})},Ae=function(r,e,s,d){var i,p;"rule"==r.type&&(i=new RegExp("pg-"+u+"-rule-id-([0-9]*)"+C["extra-rule-el-id"]),p=parseInt(r["pg-node-id"]),e.children().each(function(e,t){var n,o,l=$(t),a=(l.hasClass("crsa-rule")&&(n=-1,a=l.attr("id").match(i))&&1<a.length&&(n=parseInt(a[1]),p<=n)&&(a=S.getNodeFrom(l),o=parseInt(a["pg-node-id"]),d&&(o+=s),l.attr("id","pg-"+u+"-rule-id-"+o+C["extra-rule-el-id"]),C["on-rule-id-changed"])&&C["on-rule-id-changed"](a,N,o,n,S),l.find("> ul"));0<a.length&&Ae(r,a,s,d)}))},Le=function(e,t){if(null!=Le&&t){var n=t.stylesheet,o=t.node;if(N.getUniqueName()==n.getUniqueName()&&!g.data("properties-in-edit-mode")){Re(o,g,1,!1),Ae(o,g,1,!1);var n=o.parent.nodes.indexOf(o),l=null;if(0<(l="root"==o.parent.type?g:(r=pinegrow.pgPostCSSHelper.getNodeIndices(o.parent),a=pinegrow.pgPostCSSHelper.getNodeIndices(o),pinegrow.pgPostCSSHelper.getNodeByIndices(N.rootNode,a),g.find('[data-node-indices="'+r+'"]').find("> ul"))).length)if(l.closest(".sass-root-node")[0]==g[0]){var a=!1,r=!0,s=$(l.find("> li:not(.placeholder-node)")[n-1]);if(0==s.length)if(0==n){for(r=!1,s=l.find("> li:first-child");s.hasClass("placeholder-node")||s.hasClass("placeholder");)s=s.next();if(0==s.length)s=l,a=!0;else if(S.getNodeFrom(s).prev()!=o)return}else 0==(s=l.find("> li:last-child")).length&&(s=l,a=!0);0==s.length&&(s=l.find("> ul"),a=!0),!a&&(!s.parent().hasClass("nested")||ne(o.parent))&&p&&0<p.length||(n=Be(o,s,a,r),"decl"!=o.type&&"atrule"!=o.type||x(n.find(".decl-value,.atrule-params")),(l=n.prev()).hasClass("add-new-node")&&l.detach(),C["on-node-added"]&&C["on-node-added"](o,N,S,t))}}}},De=function(e,t){var n,o,l,a,r,s;null!=De&&t&&(l=t.stylesheet,n=t.node,s=t.oldValue||{},N.getUniqueName()!=l.getUniqueName()||g.data("properties-in-edit-mode")||(l=pinegrow.pgPostCSSHelper.getNodeIndices(n),o=n,0<(l=g.find('[data-node-indices="'+l+'"]')).length&&(r=a=null,s&&s.prop&&"decl"==o.type&&s.prop!=o.prop&&(a="prop",r=s.prop),C["on-node-changed"]&&C["on-node-changed"](o,N,r,a,S),S.updateNodeViewWith(l,n)),"decl"!=n.type&&"atrule"!=n.type)||(s=l.find(".decl-value,.atrule-params"),v(s,n.value)))},Ge=function(e,t){var n,o,l;null!=Ge&&t&&(l=t.stylesheet,n=t.node,o=t.oldNode,N.getUniqueName()!=l.getUniqueName()||g.data("properties-in-edit-mode")||(l=pinegrow.pgPostCSSHelper.getNodeIndices(n),0<(l=g.find('[data-node-indices="'+l+'"]')).length&&(Be(n,l,!1,!0,!0).attr("class",l.attr("class")),l.remove(),C["on-node-replaced"])&&C["on-node-replaced"](o,n,N,S)))},Oe=function(e){0<e.length&&0==e.find("> .crsa-node").length&&I(e)},Me=function(e,t){if(null!=Me&&t){var n=t.stylesheet,o=t.node;if(N.getUniqueName()==n.getUniqueName()&&!g.data("properties-in-edit-mode")){var n=pinegrow.pgPostCSSHelper.getNodeIndices(o),l=o,n=g.find('[data-node-indices="'+n+'"]');if(0<n.length){n.closest(".sass-root-node");if(n.attr("data-removed",!0),C["on-before-node-deleted"]){if(l.nodes&&0<l.nodes.length)for(var a=l.nodes,r=0;r<a.length;r++)C["on-before-node-deleted"](a[r],N,S);C["on-before-node-deleted"](l,N,S)}F(n);l=o.parent;"root"==l.type&&l.nodes.length<=1&&b.onNodeRemoved()}n=1+fe(o);Ae(o,g,-1*n,!0),Re(o,g,-1,!0)}}},qe=function(e,t){var n,o,l;null!=qe&&t&&(o=t.stylesheet,l=t.node,n=t.oldNodeIndices,N.getUniqueName()!=o.getUniqueName()||g.data("properties-in-edit-mode")||(o=pinegrow.pgPostCSSHelper.getNodeIndices(l),g.find('[data-node-indices="'+n+'"]'),0<(l=$nodeSelector).length&&l.closest(".sass-root-node")[0]==g[0]&&l.attr("data-node-indices",o.join(","))))};this.updateNodeViewWith=function(e,t){var n,o,l,a,r;t&&0!=e.length&&!e.closest(".sass-root-node").data("properties-in-edit-mode")&&(n=e.find("> div"),"rule"==t.type?n.find("span.rule-selector").html(this.pgStylesheet?this.pgStylesheet.filterSource(t.selector):t.selector):"decl"==t.type||"atrule"==t.type&&t.variable?(o=t.prop||N.getDeclCharachter()+t.name,l=t.value.replace("!important","").trim(),r=n.find("span.decl-prop"),a=n.find("span.decl-value"),pgRemoveSpectrum(a,".color-input"),r.html(o),a.html(l+(t.important?" !important":"")),x(a)):"atrule"==t.type?(n.find("span.atrule-name").html("@"+t.name),r=n.find("span.atrule-params").html(t.params),x(r)):"import"==t.type?(n.find("span.import-name").html("@"+t.name),n.find("span.import-importPath").html(t.importPath)):"comment"==t.type&&n.find("span.comment-text").html(t.text))},this.getLengthWithoutPlaceholders=function(e){var t=-1;return t=e.nodes?e.nodes.length:t},this.showOnlySelectedRules=function(){_(),c.find("> ul > li").removeClass("show-rule"),$.each(r.find("li.selected"),function(e,t){for(var n=S.getNodeFrom($(t));n&&n.parent&&"root"!=n.parent.type;){$(t).siblings().not(".selected").addClass("hide-rule"),t=$(t).parent().closest("li");n=n.parent}n&&n.parent&&t&&$(t).removeClass("hide-rule").addClass("show-rule")}),c.find("> ul > li").not(".show-rule").addClass("hide-rule")},this.showAllRules=function(){r.find("li.hide-rule").removeClass("hide-rule")},this.show=function(){if(!N.getError()){for(var e=p||N.rootNode.nodes,t=(g.data("node",N.rootNode),e),n=g,o=void 0,l=[],a=0,r=(D=null,Ne(),t),s=r.length,d=0;d<s;d++){var i=r[d];o&&C["skip-showing-"+i.type]||D&&!pgcssh.searchInNodeAndSubnodes(i,D,N)||(l[a++]='<li draggable="true" data-node-indices="'+pinegrow.pgPostCSSHelper.getNodeIndices(i)+'" class="'+L(i)+'"',i["pg-node-id"]&&(l[a++]=' id="pg-'+u+"-rule-id-"+i["pg-node-id"]+C["extra-rule-el-id"]+'"'),l[a++]="><div></div>",l[a++]="</li>")}n[0].innerHTML=l.join(""),b.setUl(g),b.onListUpdated(),(t=g).off("click","i.collapse-icon").on("click","i.collapse-icon",function(e){e.preventDefault();var t,o,n=$(this).closest("li");return pinegrow.keyState.alt?(t=pe(n),o="","uncollapsed"==t?o="collapse":"collapsed"==t&&(o="uncollapse"),$(this).closest("ul").find("> li.can-has-children").each(function(e,t){var n=$(t);B(n,o)})):B(n),!1}),t.off("click","li",ce).on("click","li",ce),t.off("dblclick","li",ue).on("dblclick","li",ue),b.addTriggers(g),pgf.kids||b.supportInsertBorders(),b.isAllowed=this.isAllowedToEditNode,b.isDblClickAllowed=this.isDblClickEditingAllowed,b.getSelectableObj=this.getSelectableObjForEditing,_()}},this.remove=function(){o=!0,pgRemoveSpectrum(g,".color-input"),g.data("node",null),c.data("pg-sp",null),b&&(b.remove(),b=null),pinegrow.removeEventHandler("on_css_node_added",Le),pinegrow.removeEventHandler("on_css_node_updated",De),pinegrow.removeEventHandler("on_css_node_replaced",Ge),pinegrow.removeEventHandler("on_css_before_node_deleted",Me),pinegrow.removeEventHandler("node-indices-changed",qe),pinegrow.removeEventHandler("on_css_active_rule_changed",Ee),$("body").off("crsa-rule-selected",m),$("#crsa-dummy-field").off("keydown",T).off("keyup",re),a&&a.off("scroll",Se),re=T=Le=Me=Ge=De=Ee=Se=null,this.pgStylesheet.stylePane=N.stylePane=null,this.pgStylesheet=N=null,S=null},$("body").on("crsa-rule-selected",m),pinegrow.addEventHandler("on_css_node_added",Le),pinegrow.addEventHandler("on_css_node_updated",De),pinegrow.addEventHandler("on_css_node_replaced",Ge),pinegrow.addEventHandler("on_css_before_node_deleted",Me),pinegrow.addEventHandler("node-indices-changed",qe),pinegrow.addEventHandler("on_css_active_rule_changed",Ee)};