var PgStylesheetVars=function(y,l,_){(_=_||{}).customStylesheet=_.customStylesheet||null,_.useInsertBorder=null==_.useInsertBorder||_.useInsertBorder,this.filter="",this.showActiveOnly=!1,this.active_vars_name=[];for(var N=this,q=3,e=["default","global"],F=[],t=0;t<e.length;t++){var B=e[t];F.push({key:"!"+e[t],name:B.charAt(0).toUpperCase()+B.slice(1)})}function L(e){m||E()}function O(){m||E()}function D(e){e.preventDefault();var t=$(e.target),n=t.closest("li");return t.hasClass("crsa-remove-node")&&Se(n),!1}var P=$("<div/>",{class:"crsa-vars-main-list"}),a=null,n=null,r=l.closest(".crsa-stylesheet-vars").parent(),i=$('<div class="show-next-page"></div>'),o=$('<div class="rule-menu"><i class="icon icon-bin crsa-remove-node"></i></div>'),d=1,c=10,u=!1,G=500,C=!1,s=0,p=-1,g=0,v=null,f=null,h=[],m=!1,S=[],b=new PgUISectionGrid,w=(P.append(b.$element),function(e,t,n,o,a){var l={prop:"",value:""};l[t]=o,e[t]=n,"value"==t?l.prop=e[t]:l.value=e.value,C=!0,pinegrow.dispatchEvent("on_css_node_updated",null,{node:e,stylesheet:a,oldValue:l,undoCombineKey:"varValueChanged_"+e[t],action:"Set "+e[t],undoRuleName:null}),C=!1,a.setSourceForRules(a.rootNode,function(){})}),H=function(e,t){e.find(".color-value-placeholder").css("background-color",t=t||"black");var n=e.find(".crsa-input-color-picker");0<n.length&&n.spectrum("set",t)},V=function(e,t){C=!0,pinegrow.dispatchEvent("on_css_before_node_deleted",null,{node:e,stylesheet:t}),C=!1,pinegrow.pgPostCSSHelper.removeNodeFrom(e),t.setSourceForRules(t.rootNode,function(){pinegrow.dispatchEvent("on_css_node_deleted",null,{node:e,stylesheet:t})})},j=function(e){var t,n;return"css"==y.type?null:(t=null,n=new RegExp("\\"+y.getDeclCharachter()+"[a-z0-9_\\-]*","ig"),(n=e.match(n))&&0<n.length?n[n.length-1]:t)},W=function(e){for(var t=[],n=0;n<e.length;n++)for(var o=e[n],a=0;a<o.length;a++){var l=o[a],l=pgcssh.getVariableProp(l);t.push(l)}return t},z=function(e,t,n,o,a,l){var r;return"decl"==e?(o(r=pinegrow.pgPostCSSHelper.createNode(e,t,n,null,l),a),l.setSourceForRules(l.rootNode,function(){C=!0,pinegrow.dispatchEvent("on_css_node_added",null,{node:r,stylesheet:l}),C=!1}),r):null},M=function(e){e.$input.autocomplete({appendTo:l,minLength:0,search:function(e,t){var n=e.keyCode||e.which;if(38==n||40==n)return!1},focus:function(e,t){return!1},select:function(e,t){var n,o,a=t.item.value,l=a;return"css"!=y.type&&a.startsWith(y.getDeclCharachter())&&(n=$(this).val(),o=j(n))&&n.endsWith(o)&&(l=n.substr(0,n.length-o.length),l+=a),$(this).val(l).trigger("input"),this.focus(),!1},source:function(e,t){var n=e.term,o=(o=W(y.varGroups)).concat(y.getAutocompleteArr()),a=j(n);a&&n.endsWith(a)&&(n=a),t($.ui.autocomplete.filter(o,n).slice(0,6))}})},K=function(e){var t=e.split(" "),n=t.pop();return n.startsWith("!")?{value:t.join(" "),flag:n}:{value:e,flag:""}},I=function(e,t){return e.attr("data-node-indices")?(t=t||y,pinegrow.pgPostCSSHelper.getNodeByIndices(t.rootNode,e.attr("data-node-indices").split(","))):null},J=function(e,t){for(var n=0;n<t.length;n++){var o=t[n],a=pgcssh.getVariableProp(e),l=pgcssh.getVariableProp(o);if(e.type==o.type&&a==l)return o}},Q=function(e){var t=e.find(".custom-container");return 0<t.length?I(t,_.customStylesheet):null},X=function(e){var t=$(e.target).closest("li"),n=I(t),o=t.data("input-field"),a=t.data("flag-field"),o=o.$input.val()+" "+a.$input.val(),a=t.data("old-value");w(n,"value",o,a.value,y),"change"==e.type&&(o=pgcssh.getVariableProp(n),t.data("old-value",{prop:o,value:n.value}))},Y=function(e){var t,n,o,a=$(e.target),l=a.closest("li"),r=a.closest(".custom-container");r.data("just-added")||(a=_.customStylesheet,t=I(l),n=I(r,a),l=l.data("custom-field").$input.val(),n?l?(o=r.data("old-value"),w(n,"value",l,o.value,a)):(U(n,-1,!0),V(n,a),r.removeAttr("data-node-indices")):l&&((new PgApi).overrideCSSVariable(t,a,function(e,t){var n=e.length;if(n)for(var o,a=0;a<n;a++)a!=n-1?(o=J(e[a],t),o=pinegrow.pgPostCSSHelper.getNodeIndices(o),(o=P.find('[data-node-indices="'+o.join(",")+'"]:not(.custom-container)')).length&&(o.data("custom-field").setValue(e[a].value),o=o.find(".custom-container"),pinegrow.pgPostCSSHelper.getNodeIndices(e[a]),o.attr("data-node-indices",pinegrow.pgPostCSSHelper.getNodeIndices(e[a])))):r.attr("data-node-indices",pinegrow.pgPostCSSHelper.getNodeIndices(e[a]));r.data("just-added",!1)},l),r.data("just-added",!0)),"change"==e.type&&n&&(o=pgcssh.getVariableProp(n),r.data("old-value",{prop:o,value:n.value})))},k=function(e){e.preventDefault();var t=$(e.target);return t.attr("contenteditable",!0),t.focus(),!1},Z=function(e){e.preventDefault();var t,n=$(e.target),o=n.closest("li"),a=I(o);return a?(t=pgcssh.getVariableProp(a),o.data("old-value",{prop:t,value:a.value}),n.removeAttr("contenteditable")):me(o),!1},ee=function(e){var t,n,o,a,l,r,i,s=e.keyCode||e.which;if(13==s||9==s||27==s)return n=(t=$(e.target)).closest("li"),27!=s&&(o=s=!1,a=null,i=t.html(),0<(r=n.next()).length?(l=I(r))&&(a=l,s=!0,o=!1):(n.prev(),(l=I(r))&&(a=l,o=s=!0)),s)?(r=null,r=o?pinegrow.pgPostCSSHelper.insertNodeAfter:pinegrow.pgPostCSSHelper.insertNodeBefore,(l=z("decl",i,"",r,a,y))&&(n.attr("data-node-indices",pinegrow.pgPostCSSHelper.getNodeIndices(l)),s=pgcssh.getVariableProp(l),n.data("old-value",{prop:s,value:l.value}),t.off("click",k).off("blur",Z).off("keydown",ee),t.on("click",k).on("blur",te).on("keydown",ne).on("keyup",le),0<(o=n.find(".custom-container")).length&&(i="prop",r="decl","atrule"==l.type&&(i="name",r="atrule"),(a=pinegrow.pgPostCSSHelper.findNodeInside(r,i,s,_.customStylesheet.getRootNode()))?(o.attr("data-node-indices",pinegrow.pgPostCSSHelper.getNodeIndices(a)),l=n.data("custom-field"),r=a.value,l.setValue(r),H(l.$field,r),i=pgcssh.getVariableProp(a),o.data("old-value",{prop:i,value:a.value})):o.data("old-value",{prop:"",value:""})),t.removeAttr("contenteditable"))):me(n),!1},te=function(e){e.preventDefault();var t=$(e.target),n=t.closest("li"),o=I(n),a=pgcssh.getVariableProp(o);return n.data("old-value",{prop:a,value:o.value}),t.removeAttr("contenteditable"),!1},ne=function(e){var t,n,o,a,l,r=e.keyCode||e.which;if(13==r||9==r||27==r)return n=(t=$(e.target)).closest("li"),o=I(n),27==r?(r=n.data("old-value"),t.html(r.prop),a="prop","atrule"==o.type&&(a="name"),w(o,a,r.prop,r.prop,y),(l=Q(n))&&(n.find(".custom-container").data("old-value"),w(l,a,r.prop,r.prop,_.customStylesheet))):(l=pgcssh.getVariableProp(nodeCustomVar),n.data("old-value",{prop:l,value:o.value})),t.removeAttr("contenteditable"),!1},oe=function(e,t){x(null,e,!1,t)},ae=function(e,t,n){return!!t.hasClass("var-item")},T=null,le=function(l){null!==T&&clearTimeout(T),T=setTimeout(function(){var e=$(l.target),t=e.closest("li"),n=I(t),o=t.data("old-value"),a="prop",n=("atrule"==n.type&&(a="name"),w(n,a,e.html(),o.prop,y),Q(t));n&&(o=t.find(".custom-container").data("old-value"),w(n,a,e.html(),o.prop,_.customStylesheet))},250)},A=function(e,t){t||pinegrow.dispatchEvent("on_css_var_collapsed",null,{})},x=function(e,t,n,o){var a=!1,l="",r="",r=((a=e?a:!0)||(l=pgcssh.getVariableProp(e),r=e.value),K(r)),i="",i=(a||(i=' data-node-indices="'+pinegrow.pgPostCSSHelper.getNodeIndices(e)+'"'),$("<li"+i+' data-type="decl" class="var-item"></li>')),s=(n?i.appendTo(t):o?i.insertAfter(t):i.insertBefore(t),$('<span class="var-name">'+l+"</span>").appendTo(i)),s=(a?s.on("click",k).on("blur",Z).on("keydown",ee):s.on("click",k).on("blur",te).on("keydown",ne).on("keyup",le),a&&s.click(),$('<div class="row var-row"></div>').appendTo(i)),d=$('<div class="col-sm-8 value-container"></div>').appendTo(s),c=new PgInputField("var-value",{type:"color",use_type_features:["slider"],name:"Value",without_text:!0,placeholder:"Value"}),d=(M(c),c.appendTo(d),c.setValue(r.value),H(c.$field,r.value),c.on("input change",X),i.data("input-field",c),$('<div class="col-sm-4 flag-container"></div>').appendTo(s)),c=new PgInputField("var-flag",{type:"select",name:"Flag",show_empty:!0,icon:!1,without_text:!0,placeholder:"Flag",append_new_to_list:!0,default_value:r.flag,options:F});c.appendTo(d),c.setValue(r.flag),c.on("change",X),i.data("flag-field",c),i.data("old-value",{prop:l,value:r.value+" "+r.flag}),_.customStylesheet&&(d=$('<div class="col-sm-12 custom-container"></div>').appendTo(s),c=new PgInputField("var-custom-value",{type:"color",use_type_features:["slider"],name:"Custom value",without_text:!0,placeholder:"Custom value"}),M(c),c.appendTo(d),i.data("custom-field",c),r=null,(r=a?r:pinegrow.pgPostCSSHelper.findNodeInside("decl","prop",l,_.customStylesheet.getRootNode()))?(d.attr("data-node-indices",pinegrow.pgPostCSSHelper.getNodeIndices(r)),s=r.value,c.setValue(s),H(c.$field,s),i=pgcssh.getVariableProp(r),d.data("old-value",{prop:i,value:r.value})):d.data("old-value",{prop:"",value:""}),c.on("input change",Y))},re=function(e,t){var n=p+1,o=p+c,a=(o>=e.length&&(o=e.length-1),!1);m&&(n=0,o=e.length-1),0==n&&(v=$('<ul class="vars-list"></ul>').appendTo(t),_.useInsertBorder)&&((l=new PgInsertBorders(v)).onLiClicked=oe,l.isAllowed=ae,h.push(l));for(var l,r=n;r<=o;r++){var i=e[r],s=!1,i=pgcssh.getVariableProp(i);if(N.filter&&!i.match(f)&&(s=!0),(s=!N.showActiveOnly||N.active_vars_name&&-1!=N.active_vars_name.indexOf(i)?s:!0)&&!m)o<e.length-1&&o++;else if(S.push(pgcssh.getStylesheetForNode(e[r])),x(e[r],v,!0),!m&&(p=r,a=!0,++g==d*c))break}a&&0==(l=t.siblings(".group-comment-container")).length&&(n=se(e[0]),l=$('<div class="group-comment-container"></div>').insertBefore(t),ie(n,l)),m||g==d*c&&(u=!0)},ie=function(e,t){for(var n=$('<ul class="comments-list"></ul>').appendTo(t),o=0;o<e.length;o++)commentNode=e[o],$('<li class="group-comment" data-node-indices="'+pinegrow.pgPostCSSHelper.getNodeIndices(commentNode)+'" data-type="comment">'+commentNode.text+"</li>").appendTo(n)},se=function(e){for(var t=[],n=e.prev(),o=q;n&&"comment"==n.type&&0!=o;)t.unshift(n),n=n.prev(),o--;return t},de=function(e,t){var n=se(e[0]),o=$('<div class="group-comment-container"></div>').appendTo(t),n=(ie(n,o),$('<div class="group-vars-container"></div>').appendTo(t)),a=$('<ul class="vars-list"></ul>').appendTo(n),o=new PgInsertBorders(a);o.onLiClicked=oe,o.isAllowed=ae,h.push(o);for(var l=0;l<e.length;l++)x(e[l],a,!0)},ce=function(e,t){-1==p&&(n=$('<div class="group-vars-container"></div>').appendTo(t)),re(e,n)},ue=function(){for(var e,t=l.find("> .crsa-vars-main-list"),n=(0==t.length?P.appendTo(l):P=t,y.varGroups),o=s;o<n.length&&!u;o++)a&&-1!=p||(e=new PgUISection(y.name,"Group "+(o+1),null,null,null,{onOpenClose:A}),b.addSection(e),b.newSectionAdded(),a=e.$content),ce(n[o],a),0==a.find(".var-item").length&&b.popSection(),s=o,u||(p=-1);u?i.appendTo(l):i.detach()},pe=function(e){for(;0<e.length;){var t=e.prev();e.remove(),e=t}},E=function(){for(var e=r.height(),t=r.offset().top,n=i.parent(),o=0!=l.closest("html").length,a=i.offset().top-t;o&&0!=n.length&&a-G<=e;)u=!1,ue(),d++,n=i.parent(),a=i.offset().top-t;b.updateLayout()},ge=function(e){for(var t=0;t<e.length;t++)if("rule"==e[t].type){r=l=a=o=void 0;for(var n=e[t],o=pinegrow.pgPostCSSHelper.getStylesheetForNode(n),a=n.nodes,l=0;l<a.length;l++){var r=a[l];"decl"==r.type&&o.isVarValue(r.value)&&he(r.value)}}},U=function(e,t,n){var o=pinegrow.pgPostCSSHelper.getNodeLevel(e);if(!(0<o))for(var a=pinegrow.pgPostCSSHelper.getNodeIndices(e)[0],l=P.find(".var-item,.group-comment"),r=l.length-1;0<=r;r--){var i=$(l[r]),s=(i=n?i.find(".custom-container"):i).attr("data-node-indices");if(s){var s=s.split(","),d=parseInt(s[0]);if(!(a<=d))break;s[0]=d+t,i.attr("data-node-indices",s.join(","))}}},R=function(e,t){if(null!=R&&!N.showActiveOnly&&t){var n=t.stylesheet,o=t.node,a=y.isDeclVarNode(o),l=_.customStylesheet,l=l&&l.getUniqueName()==n.getUniqueName();if(y.getUniqueName()==n.getUniqueName()){if(!C&&a){var n=!1,r=(U(o,1),o.next());if(r&&"comment"!=r.type&&(r=pinegrow.pgPostCSSHelper.getNodeIndices(r),0<(r=P.find('[data-node-indices="'+r+'"]:not(.custom-container)')).length)&&(x(o,r,!1,!1),n=!0),n||(r=o.prev())&&(u=pinegrow.pgPostCSSHelper.getNodeIndices(r),u=P.find('[data-node-indices="'+u+'"]:not(.custom-container)'),"comment"==r.type?pe(u):0<u.length&&(x(o,u,!1,!0),n=!0)),!n){for(var i=-1,s=y.varGroups,d=0;d<s.length;d++)if(-1<(c=s[d]).indexOf(o)){i=d;break}if(-1<i){var c,r=null,u=!1,n=(c=s[i])[0],p=pinegrow.pgPostCSSHelper.getNodeIndices(n),p=P.find('[data-node-indices="'+p+'"]:not(.custom-container)');if(0<p.length)if(0<p.closest(".crsa-vars-main-list").siblings(".show-next-page").length)return;if(0<i){var n=s[i-1][0],g=pinegrow.pgPostCSSHelper.getNodeIndices(n);if(0<(v=P.find('[data-node-indices="'+g+'"]:not(.custom-container)')).length){r=v.closest(".pg-ui-section");if(1<c.length)if(0<r.closest(".crsa-vars-main-list").siblings(".show-next-page").length)return;u=!0}}else{n=s[i+1][0],g=pinegrow.pgPostCSSHelper.getNodeIndices(n);0<(v=P.find('[data-node-indices="'+g+'"]:not(.custom-container)')).length&&(r=v.closest(".pg-ui-section"),u=!1)}p=r.index(),n=(u&&p++,new PgUISection(y.name,"New Group",null,null,null,{onOpenClose:A})),g=(b.addSectionAt(n,p),b.newSectionAdded(),n.$content);de(s[i],g),b.updateLayout()}}}}else if(l&&!C&&a){for(var v,i=-1,f=null,h=(U(o,1,!0),y.varGroups),m=!1,d=0;d<h.length;d++){for(var S=h[d],w=0;w<S.length;w++)if(pgcssh.getVariableProp(S[w])==pgcssh.getVariableProp(o)){i=d,f=S[w],m=!0;break}if(m)break}m&&(v=pinegrow.pgPostCSSHelper.getNodeIndices(f),0<(r=P.find('[data-node-indices="'+v+'"]')).length)&&0<(u=r.find(".custom-container")).length&&(u.attr("data-node-indices",pinegrow.pgPostCSSHelper.getNodeIndices(o)),(p=r.data("custom-field")).setValue(o.value),H(p.$field,o.value))}}},ve=function(e,t){var n,o,a,l,r,i;null!=ve&&t&&(n=t.stylesheet,o=t.node,t.oldValue,a=(a=_.customStylesheet)&&a.getUniqueName()==n.getUniqueName(),y.getUniqueName()==n.getUniqueName()?C||(l=pinegrow.pgPostCSSHelper.getNodeIndices(o),0<(r=P.find('[data-node-indices="'+l+'"]:not(.custom-container)')).length&&(r.hasClass("custom-container")?((i=r.closest("li").data("custom-field")).setValue(o.value),H(i.$field,o.value)):"decl"==r.data("type")?N.updateNodeViewWith(r,o):"comment"==r.data("type")&&r.html(o.text))):a&&!C&&(l=pinegrow.pgPostCSSHelper.getNodeIndices(o),0<(r=P.find('.custom-container[data-node-indices="'+l+'"]')).length)&&((i=r.closest("li").data("custom-field")).setValue(o.value),H(i.$field,o.value)))},fe=function(e,t){var n,o,a,l,r;null!=fe&&t&&(r=t.stylesheet,n=t.node,o=(o=_.customStylesheet)&&o.getUniqueName()==r.getUniqueName(),y.getUniqueName()==r.getUniqueName()?C||(a=pinegrow.pgPostCSSHelper.getNodeIndices(n),0<(l=P.find('[data-node-indices="'+a+'"]:not(.custom-container)')).length&&l.remove(),U(n,-1)):o&&!C&&(a=pinegrow.pgPostCSSHelper.getNodeIndices(n),0<(l=P.find('.custom-container[data-node-indices="'+a+'"]')).length)&&(r=l.closest("li").data("custom-field"),H(r.$field),r.setValue(""),l.removeAttr("data-node-indices"),l.closest(".custom-container").data("old-value",{prop:"",value:""}),U(n,-1,!0)))},he=function(e){var t=new RegExp("\\"+y.getDeclCharachter()+"[a-z0-9_\\-]*","ig"),t=e.match(t);t&&t.forEach(function(e){var t=pinegrow.pgPostCSSHelper.findNodeInside("decl","prop",e,y.getRootNode());t&&he(t.value),-1==N.active_vars_name.indexOf(e)&&N.active_vars_name.push(e)})},me=function(e){pgRemoveSpectrum(e),pgRemoveMultiselects(e),o.detach(),e.remove()},Se=function(e){var t=e.find(".custom-container"),n=_.customStylesheet,o=I(e),t=I(t,n);me(e),o&&(U(o,-1),V(o,y)),t&&(U(t,-1,!0),V(t,n))};this.isPgStylesheetExists=function(e){for(var t=0;t<S.length;t++)if(S[t]==e)return!0;return _.customStylesheet==e},this.updateNodeViewWith=function(e,t){var n=pgcssh.getVariableProp(t),n=(e.find("> .var-name").html(n),K(t.value)),o=e.data("input-field");o.setValue(n.value),H(o.$field,n.value),e.data("flag-field").setValue(n.flag)},r.on("scroll",L),this.show=function(e){var t;c=10,G=500,C=u=!(d=1),p=-1,g=s=0,v=n=a=null,f=null,N.filter&&(f=new RegExp(escapeRegExp(N.filter),"i")),this.showActiveOnly&&((t=pinegrow.pgActiveRules.getActiveNodes())?ge(t.shown_nodes):N.active_vars_name=[]),l[0].innerHTML="",e&&0<e.length?(m=!0,e=e,P.appendTo(l),t=new PgUISection(y.name,"Group",null,null,null,{onOpenClose:A}),b.addSection(t),b.newSectionAdded(),t=t.$content,t=$('<div class="group-vars-container"></div>').appendTo(t),re(e,t),b.updateLayout()):(i.appendTo(l),E())},this.updateLayout=function(){b.updateLayout(),E()},this.remove=function(){for(var e=0;e<h.length;e++){var t=h[e];t&&(t.remove(),t=null)}h=[],S=[],r.off("scroll",L),pinegrow.removeEventHandler("on_css_node_added",R),pinegrow.removeEventHandler("on_css_node_updated",ve),pinegrow.removeEventHandler("on_css_before_node_deleted",fe),pinegrow.removeEventHandler("on_css_var_collapsed",O),o.off("click",D)},l.on("mouseenter",".var-item",function(e){var t=$(e.target).closest("li");t.hasClass("var-item")&&(t.addClass("hoverd"),o.appendTo(t))}),l.on("mouseleave",".var-item",function(e){var t=$(e.target).closest("li");t.hasClass("var-item")&&(t.removeClass("hoverd"),o.detach())}),o.on("click",D),pinegrow.addEventHandler("on_css_node_added",R),pinegrow.addEventHandler("on_css_node_updated",ve),pinegrow.addEventHandler("on_css_before_node_deleted",fe),pinegrow.addEventHandler("on_css_var_collapsed",O)};