"use strict";var PgCSSActiveRulesEditor=function(f,n){if(n.html(""),f){this.ready=!0;for(var q=null,F="-active-css",O=["active","hover","focus","visited"],v={},m={},o={},S=this,U=$('<div class="pseudo-container"></div>'),t=(pgf.kids||U.appendTo(n),$('<div class="rules-list"></div>').appendTo(n)),W=0,L=1,r=null,u=!1,i=null,w=[],a=[],j=!1,G=0;G<O.length;G++){var e=O[G],V=(this[e]=!1,$('<div class="pseudo-state" data-css-state="'+e+'"><label> :'+e+'</label><input type="checkbox"></div>').appendTo(U)),B=(V.click(function(e){var t=$(this),n=t.data("cssState");S[n]?(S[n]=!1,t.removeClass("checked")):(S[n]=!0,t.addClass("checked")),S.removeStylesheetObj(),Y(n,S[n]),pinegrow.pgActiveRules.updateMatchedRules(!0)}),f.get$DOMElement());B&&B.hasClass("pg-state-"+e)&&(S[e]=!0,V.addClass("checked")),addTooltip(V,"Show selected element in <b>:"+e+"</b> state.")}var d,y,l=new PgButtonToolbar(!0),g=(l.$element.appendTo(U),l.addSection("tools"),"1"===pinegrow.getSetting("active-uncollapse-all","0")),s=(!pgf.kids&&isApp()||(g=!0),new PgButtonToolbarItem("icon-down","Always expand all rules")),h=(s.setActive(g),pgf.kids&&isApp()||l.addItem("tools",s),s.onClick=function(e){g=!this.getActive(),this.setActive(g),pinegrow.setSetting("active-uncollapse-all",g?"1":"0"),pinegrow.selectedElements.reselect(),pinegrow.showMode("Uncollapse rules",g)},"1"===pinegrow.getSetting("active-remember-for-element","1")),s=new PgButtonToolbarItem("icon-Pin","Remember the selected CSS rule for each element"),Q=(s.setActive(h),pgf.kids&&isApp()||l.addItem("tools",s),s.onClick=function(e){h=!this.getActive(),this.setActive(h),pinegrow.setSetting("active-remember-for-element",h?"1":"0"),pinegrow.showMode("Remember the selected CSS rule for each element",h)},function(e,t,n,o){for(var l=0;l<w.length;l++)if(w[l].url==t){var s=w[l];if(!s.canEdit())return;var r,i=!1,a=s.getRootNode(),d=a,c=pinegrow.pgPostCSSHelper.createNode("rule",e,null,null,s),p=[a.nodes.length],u=[a.nodes.length],g=c;n&&((r=a.last)&&r.params&&r.params==n?(p=[a.nodes.length-1],u=[a.nodes.length-1,(d=r).nodes.length],i=!0):(r=pinegrow.pgPostCSSHelper.createNode("atrule","media",n,null,s),pinegrow.pgPostCSSHelper.insertNodeInside(c,r),g=r,u.push(0))),pinegrow.pgPostCSSHelper.insertNodeAt(g,d,d.nodes.length),s.setSourceForRules(a,function(){o&&o(s,p,u,i)});break}}),K=function(t){function n(){var e;o.length&&(e=pinegrow.getCollectionForElement(f),(new PgApi).addClass(e,o)),Q(g,h,t.getMediaQuery(),function(e,t,n,o){var l=pinegrow.pgPostCSSHelper.getNodeByIndices(e.getRootNode(),t),s=pinegrow.pgPostCSSHelper.getNodeByIndices(e.getRootNode(),n),r=(o?pinegrow.dispatchEvent("on_css_node_added",null,{node:s,stylesheet:e}):pinegrow.dispatchEvent("on_css_node_added",null,{node:l,stylesheet:e}),null),r="atrule"==l.type?l.nodes[l.nodes.length-1]:l;if(v)try{for(var i=$(".style-attribute-style-pane").data("cs").getRootNode().nodes[0],a=r,d=pgcssh.getStylesheetForNode(a),c=0,p=0;p<i.nodes.length;p++)"decl"==i.nodes[p].type&&(c=p);for(p=0;p<i.nodes.length;p++)"decl"==i.nodes[p].type&&d.ruleValueChanged(r,i.nodes[p].prop,i.nodes[p].value,null,!1,"gui",p==c,null);var u=pinegrow.getCollectionForElement(f);u.forEachElement(function(e){e.removeAttr("style")}),pinegrow.changeManager.didChange(u,"Remove style attribute")}catch(e){}I(r),j||(u=(a=Re(e,!1,1)).$stylePaneContainer,He(e,l,a.$currRuleList,!0),Te(e,l,s,u,{uncollapse:!0}),u.find("li.crsa-node").addClass("node-not-active"),pinegrow.pgActiveRules.updateMatchedRules(!1,function(){var e=pinegrow.pgActiveRules.matched_rules;D.length!=e.length&&(M=!0),D=pinegrow.pgActiveRules.matched_rules}),J(),y&&y.setSelector("")),pinegrow.showQuickMessage("Rule <b>"+g+"</b> created in <b>"+crsaGetNameFromUrl(h)+"</b>.")})}var g=t.getSelector(),h=t.getStylesheet(),o=t.getAddClasses(),v=t.getSaveInline();h?n():pinegrow.getDefaultStylesheet(f.getPage(),function(e){e?(h=e.url,n()):pinegrow.showQuickError("Please choose or add stylesheet for the new CSS rule.")},!0)},c=(this.getSelectedElement=function(){return f},this.openCreateNewRuleDialog=function(e,t,n,o,l,s){Pe(),new PgQuickSelectorMaker(f,null,{stylesheets:a,$position:s||d,selector_value:e,stylesheet_value:n,media_value:t,select_class:o,simple:l}).onCreate=K},$('<div class="pg-active-add-rule"></div>').appendTo(t)),z=f.getPage(),l=(this.showCreateCssRule=function(e){y&&(y.setSelector(e),t.scrollTop(0),y.onShown(),addTooltip(y.getInput().$field,"Input the selector and press "+pgShowKbdCombo("Enter"),{trigger:"manual"}))},pinegrow.getDefaultStylesheet(z,function(e,t){var n,o,l;e||1?(y=new PgSelectorMakerView(f,null,{simple:!0,labels:!1,media_query:!1,stylesheets:!1,compact:!0,save_inline:!0}),e||(t=!0),y.view.setAlwaysVisible(!0),y.onCreate=t?function(n){new PgSelectDefaultStylesheet(z,e).show(function(e,t){!t&&e&&K(n)})}:K,y.onEmptySelector=function(){$(".create-dialog").trigger("click")},pgf.kids?$(`<div class="pg-show-properties-name" style="margin-top: -5px;margin-bottom: 10px;"><span>Style for</span> <name>${pinegrow.selectedElements.getName({short:!0,num_classes:3})}</name></div>`).prependTo(c):c.append(y.view.get$Element()),n=c.find("button.create"),l=e?crsaGetNameFromUrl(e.url):"default stylesheet",addTooltip(n,"Create a new CSS rule in <b>"+l+"</b>. Input the selector and press "+pgShowKbdCombo("Enter")+" or click Create. Click on ... to open selector builder and choose media query and stylesheet."),d=$('<button class="pg-button create-dialog">'+(pgf.kids?"Create new CSS rule":"...")+"</button>"),pgf.kids?c.append(d):d.insertAfter(n),pgf.kids&&pgf.kids_with_transitions&&(l=pinegrow.selectedElements.getLastSelected().get$DOMElement())&&(n=new PgCSSGridInfo(l).isGrid(),(o=$(`<button class="pg-button edit-grid" style="margin-left:8px;">${n?"Edit grid":"Create grid"}</button>`).appendTo(c)).on("click",function(e){e.preventDefault(),pinegrow.showCSSGridControl(pinegrow.selectedElements.getLastSelected(),o)}),n?(o.addClass("pg-button-primary"),addTooltip(o,"Edit the CSS grid layout of the selected element.")):addTooltip(o,"Create a CSS grid layout for the selected element.")),0&&pgf.kids&&(l=$('<i class="pg-show-all-rules-checkbox icon icon-267"></i>').appendTo(c),pinegrow.pgActiveRules.show_all_rules||l.addClass("active"),addTooltip(l,"Show only CSS rules that are active for the selected element (otherwise all CSS rules are shown)."),l.on("click",function(e){e.preventDefault(),pinegrow.pgActiveRules.setShowAllRules(!pinegrow.pgActiveRules.show_all_rules),pinegrow.selectedElements.reselect()}))):d=$('<button class="pg-button create-dialog">Create new rule</button>').appendTo(c),d.on("click",function(e){e.preventDefault(),S.openCreateNewRuleDialog(y?y.getSelector():null,null,null,null,!1,$(e.target))}),addTooltip(c.find("button.create-dialog"),"Create new CSS rule with selector builder.")}),$('<div class="classes-whithout-rules"><p>Classes without rules: <classlist></classlist></p></div>')),J=(pgf.kids||l.appendTo(t),l.on("click","a",function(e){e.preventDefault();var t=$(this).attr("data-class");S.openCreateNewRuleDialog("."+t,null,null,null,!0,$(e.target))}),pg$Hide(l),function(){}),C=$('<div class="all-active-rule-list"></div>').appendTo(t),s=$('<div class="more-stylesheet"></div>').appendTo(t),X=$("<ul></ul>").appendTo(s),p=[],I=function(e){$.fn.crsa("selectRule",e),xe(e)},Y=function(e,t){var n=f.get$DOMElement().get(0);t?$(n).addClass("pg-state-"+e):$(n).removeClass("pg-state-"+e)},Z=function(e){return e.getUniqueName()},k=function(e,t,n,o,l){var s;return"rule"!=e.type?"":(s=(o=o||parseInt(t.getNodeId(e)))+(l=l||0),"pg-"+Z(t)+"-rule-id-"+s+n)},ee=function(e,t,n){e.parent.distance;for(var o=e.nodes,l=0;l<o.length;l++){var s,r,i,a,d=o[l];"decl"==d.type&&(s=pinegrow.pgPostCSSHelper.getNodeIndices(d),r=d.important||d.value.endsWith("!important")||!1,i=k(e,t,n),v[d.prop]?(a=v[d.prop],r?a.nodes[a.activeIndex].important?v[d.prop].nodes.push({distance:v[d.prop].nodes.length,important:r,nodeIndices:s,parentElId:i,uniqueName:t.getUniqueName()}):(v[d.prop].nodes.push({distance:v[d.prop].nodes.length,nodeIndices:s,parentElId:i,important:d.important,uniqueName:t.getUniqueName()}),v[d.prop].activeIndex=v[d.prop].nodes.length-1):(v[d.prop].nodes.push({distance:v[d.prop].nodes.length,nodeIndices:s,important:r,parentElId:i,uniqueName:t.getUniqueName()}),i==a.nodes[a.activeIndex].parentElId&&(v[d.prop].activeIndex=v[d.prop].nodes.length-1))):v[d.prop]={activeIndex:0,nodes:[{distance:0,nodeIndices:s,parentElId:i,important:r,uniqueName:t.getUniqueName()}]})}},te=function(e,t,n){var o=k(e,t,n);return N(o)},N=function(e){var t=n.find(e=e&&"#"+e);return 0<t.length?$(t[0]):$()},b=function(e,t){return e.find('[data-node-indices="'+t.join(",")+'"]')},ne=function(e){return pinegrow.pgPostCSSHelper.getNodeIndices(e)},oe=function(e){return N(e).closest(".crsa-stylesheet").data("cs")},le=function(){if(!pgf.kids&&!pinegrow.pgActiveRules.show_all_rules)for(var e in v)for(var t,n=v[e].nodes,o=0;o<n.length;o++)o!=v[e].activeIndex&&(t=n[o]).parentElId&&b(N(t.parentElId),t.nodeIndices).addClass("overriden-node")},se=function(e,t,n){if(e&&t){var o=R(e.parent)-R(t.parent);if(0!=o)return o;for(var l=ne(e),s=ne(t),r=0;r<l.length;r++){var i=l[r]-s[r];if(0!=i)return i}}return 0},re=function(e){for(var t=0;t<e.length;t++)e[t].distance=t},ie=function(e,t){for(var d=R(e.parent),n=t.nodes,o=0;o<n.length;o++){var l=function(e,t){var n=Se(e.uniqueName,e.nodeIndices);if(d<n)return e.distance;if(d==n){var o=e.nodeIndices,l=ne(t),s=l.length;o.length>l.length&&(s=o.length);for(var r=0;r<s;r++){var i=o[r],a=l[r];if(i<a)return e.distance;if(a!=i)break}}return null}(n[o],e);if(null!=l)return l}return n.length},ae=function(e,t,n,o,l,s){if(s){if(0==t||1==n)return _(e,o,l),!0}else if(1!=t&&0!=n)return _(e,o,l),!0;return!1},de=function(e,t,n,o){var l=t.nodes,s=k(e.parent,n,o),r=e.important||e.value.endsWith("!important")||!1,i=ie(e,t),a=(t.activeIndex>=i&&t.activeIndex++,pinegrow.pgPostCSSHelper.getNodeIndices(e));return l.splice(i,0,{important:r,distance:i,nodeIndices:a,parentElId:s}),E(s,a,!1),re(l),i},E=function(e,t,n){var o;pgf.kids||(o=b(N(e),t),n?o.removeClass("overriden-node"):o.addClass("overriden-node"))},_=function(e,t,n){var o=v[e],o=(o.activeIndex=t,o.nodes[t]);E(n.parentElId,n.nodeIndices,!1),E(o.parentElId,o.nodeIndices,!0)},x=function(e,t,n){for(var o=0;o<t.length;o++)if(t[o].nodeIndices.join(",")==e.join(","))return{nodeObj:t[o],index:o};return null},ce=function(e){for(var t=0;t<e.length;t++)if(e[t].important)return t;return 0},pe=function(e,t,n){for(var o=!1,l=e.parent;l&&"root"!=l.type;){var s=k(l,t,n);if(s)if(N(s).hasClass("node-not-active")){o=!0;break}l=l.parent}return o},ue=function(e,t){var n=pinegrow.pgPostCSSHelper.getNodeIndices(e),o=v[e.prop];return!!o&&!!x(n,o.nodes,t)},ge=function(e,t){var n;e.elementStyle&&(n=e.getRootNode().nodes[0].nodes,t?0<n.length&&(i.show(),u=!0,y&&y.setSaveInline(!0),setTimeout(function(){i&&i.is(":visible")&&i.addClass("animate")},500),i.closest(".style-attribute-style-pane").addClass("has-inline-style")):1==n.length&&(i.hide(),i.removeClass("animate"),u=!1,i.closest(".style-attribute-style-pane").removeClass("has-inline-style"),y)&&y.setSaveInline(!1))},he=function(e,t,n,o){var l=k(e,t,n),l=N(l);l&&(l.addClass("node-not-active"),t.filterSource(e.selector).indexOf(","))},A={key:"",val:""},ve={},fe=function(e,t,n,o,l,s){if(e){o=o||pinegrow.pgPostCSSHelper.getNodeIndices(e);var r,i;if("rule"==e.type){var a=k(e,t,l.getIndex()),d=N(a);if(0!==d.length&&!d.hasClass("node-not-active")){var c,p=t.getUniqueName()+"-"+o,u=t.getUniqueName()+"-"+n;if(A.key==n&&(c=A.val,m[p]?(A.key=o,A.val=m[p]):(A.key="",A.val=""),m[p]=c),m[u]&&(m[p]&&(A.key=o,A.val=m[p]),m[p]=m[u],delete m[u]),!s)for(var g=e.nodes,h=0;h<g.length;h++)"decl"==g[h].type&&fe(g[h],t,n.concat(h),o.concat(h),l)}}else"decl"==e.type&&(a=k(e.parent,t,l.getIndex()),0===(d=N(a)).length||d.hasClass("node-not-active")||(c=v[e.prop],ve[e.prop]||(ve[e.prop]={key:"",val:"",parentElId:-1}),u=(p=ve[e.prop]).key.toString()==n.toString()&&p.parentElId==a?p.val:x(n,c.nodes,t),d=x(o,c.nodes,t),s=p,e=u,i=a,(r=d)?(s.key=o,s.val=r,s.parentElId=i):(s.key="",s.val="",s.parentElId=-1),c.nodes[e.index].nodeIndices=o))}},P=function(e,t,n,o){var l,s,r,i,a,d;null!=e&&("rule"==e.type?he(e,t,n.getIndex(),o):"decl"==e.type&&(a=e.parent)&&"rule"==a.type&&(u||ge(t,!0),pe(e,t,n.getIndex())||ue(e,t)||(a=e.important||e.value.endsWith("!important")||!1,(d=v[e.prop])?(i=de(e,d,t,n.getIndex()),d=d.nodes[d.activeIndex],(l=R(e.parent))==(s=Se(d.uniqueName,d.nodeIndices))?(b(N(d.parentElId),d.nodeIndices),r=pinegrow.pgPostCSSHelper.getNodeByIndices(t.rootNode,d.nodeIndices),0!=(r=se(r,e,d.uniqueName))&&ae(e.prop,d.important,a,i,d,r<0)):ae(e.prop,d.important,a,i,d,l<s)):"rule"==(r=pinegrow.pgPostCSSHelper.closestNode(e,"rule")).type&&(i=pinegrow.pgPostCSSHelper.getNodeIndices(e),a=e.important||e.value.endsWith("!important")||!1,d=k(r,t,n.getIndex()),v[e.prop]={activeIndex:0,nodes:[{distance:0,nodeIndices:i,parentElId:d,important:a,uniqueName:t.getUniqueName()}]},E(d,i,!0)))))},me=function(e,t,n){var o;0!=t.nodes.length&&(o=ce(t.nodes),_(e,o,n))},R=function(e){var t=pinegrow.pgPostCSSHelper.getStylesheetForNode(e),n=pinegrow.pgPostCSSHelper.getNodeIndices(e);return m[t.getUniqueName()+"-"+n]},Se=function(e,t){return m[e+"-"+t.slice(0,t.length-1)]},we=function(e,t,n,o,l){if(null!=e&&!e.parent.newNode)if("decl"==e.type){if(!pe(e,t,l.getIndex())){if("prop"==o)if(e[o]!=n!=""&&""!=n)return void(""!=e[o]&&(a=e[o],e[o]=n,T(e,t,l),e[o]=a,P(e,t,l)));void 0!==n&&n!=e[o]&&(e.pgOldValue={},e.pgOldValue[o]=n);var s,r,i,a=v[e.prop];a&&(s=a.nodes[a.activeIndex],u=pinegrow.pgPostCSSHelper.getNodeIndices(e),k(e.parent,t,l.getIndex()),r=x(u,a.nodes,t))&&(g=b(te(e.parent,t,l.getIndex()),u),i=r.nodeObj.important,h=e.important||e.value.endsWith("!important")||!1,r.nodeObj.important=h,g.hasClass("overriden-node")?h&&(s.important?(g=oe(s.parentElId),h=pinegrow.pgPostCSSHelper.getNodeByIndices(g.rootNode,s.nodeIndices),0<se(h,e)&&_(e.prop,r.index,s)):me(e.prop,a,s)):(s.important||i)&&me(e.prop,a,s))}}else if("rule"==e.type){var d=e.nodes;if(d)for(var c=0;c<d.length;c++){var p=d[c];T(p,t,l),P(p,t,l)}he(e,t,l.getIndex(),{operation:"ignore"})}else{var u,g,h;"atrule"!=e.type||"media"!=e.name&&"supports"!=e.name||(u=pinegrow.pgPostCSSHelper.getNodeIndices(e),g="."+t.getUniqueName()+"-container"+l.getIndex(),0<(h=$(g).prev(".parent-path").find('[data-node-indices="'+u+'"]')).length&&h.html(e.params))}},T=function(e,t,n){var o,l,s;null!=e&&"decl"==e.type&&(o=v[e.prop])&&(u&&ge(t,!1),l=o.nodes[o.activeIndex],s=pinegrow.pgPostCSSHelper.getNodeIndices(e),k(e.parent,t,n.getIndex()),s=x(s,o.nodes,t))&&(o.nodes.splice(s.index,1),re(o.nodes),0==o.nodes.length?delete v[e.prop]:me(e.prop,o,l))},ye=function(e,t,n){},Ce=function(e,t,n,o){if(e&&t)if("decl"==e.type){var l,s=v[e.prop];s&&(l=pinegrow.pgPostCSSHelper.getNodeIndices(e),k(e.parent,n,o.getIndex()),x(l,s.nodes,n))&&e.prop!=t.prop&&(T(e,n,o),P(t,n,o))}else if("rule"==e.type){if(e.nodes)for(var r=e.nodes,i=0;i<r.length;i++){var a=r[i];T(a,n,o),P(a,n,o)}he(t,n,o.getIndex(),{operation:"ignore"})}},Ie=function(e,t,n,o,l){if(e&&e.nodes&&0!=e.nodes.length)for(var s=k(e,t,l.getIndex(),n),r=0;r<e.nodes.length;r++){var i,a,d=e.nodes[r];"decl"==d.type&&(i=v[d.prop],a=pinegrow.pgPostCSSHelper.getNodeIndices(d),o||k(d.parent,t,l.getIndex()),i)&&(d=x(a,i.nodes,t))&&(d.nodeObj.parentElId=s)}},ke=function(e,t){return!0},Ne=function(){function e(e){e.preventDefault();var t=$(e.target).attr("data-stylesheet-name");o[t].stylesheet.loadAndShowInActive(function(){pinegrow.selectedElements.reselect(),pinegrow.dispatchEvent("on_css_source_changed")})}for(var t in o)$('<li><a href="#" data-stylesheet-name="'+t+'">Show '+o[t].nodesNo+" more rule"+(1<o[t].nodesNo?"s":"")+" from "+o[t].name+"</a></li>").appendTo(X).find("> a").click(e)},be=function(e){var t=e.target,n=$(t);n.is(":focus")||(n.data("old-text",n.html()),n.attr("contenteditable",!0),crsaSelectText(t))},Ee=function(e){var t=$(e.target),n=e.keyCode||e.which;return 13==n||9==n?(t.blur(),!1):27==n?(t.attr("contenteditable",!1),t.html(t.data("old-text")),!1):void 0},$e=function(e){var t=e.target,t=$(t),n=t.closest(".parent-path").next(".sass-root-node").data("node").pgStylesheet,o=pinegrow.pgPostCSSHelper.getNodeByIndices(n.rootNode,t.attr("data-node-indices").split(","));o.params=t.text(),pinegrow.dispatchEvent("on_css_node_updated",null,{node:o,stylesheet:n}),t.removeAttr("contenteditable"),n.stylePane.recompileCode()},_e=function(){le()},xe=(void 0===pinegrow.activeElementStyleWasSelected&&(pinegrow.activeElementStyleWasSelected=!1),function(e,t){pinegrow.dispatchEvent("on_css_rule_selected_in_active",null,e,t),pinegrow.activeElementStyleWasSelected=e&&e.selector&&"Style attribute"==e.selector}),Ae=function(e){e.preventDefault();function t(){Pe(),0<a.length?new PgQuickSelectorMaker(v,null,{stylesheets:a,$position:l,title:"Save the inline style into a proper CSS rule"}).onCreate=function(e){for(var t,n,o,l,s,r,i,a=e.getSelector(),d=e.getStylesheet(),a=(h.selector=a,pinegrow.getCollectionForElement(v)),c=e.getAddClasses(),p=(c.length&&(new PgApi).addClass(a,c),d),u=e.getMediaQuery(),g=0;g<w.length;g++)w[g].url==p&&(o=n=(t=w[g]).getRootNode(),l=h,pinegrow.pgPostCSSHelper.removeNodeWidthRegexFrom("comment","text",/(pg-uncollapsed:(?:true|false))/,l),s=[n.nodes.length],r=l,u&&((i=n.last).params&&i.params==u?s=[n.nodes.length-1,(o=i).nodes.length]:(i=pinegrow.pgPostCSSHelper.createNode("atrule","media",u,null,t),pinegrow.pgPostCSSHelper.insertNodeInside(l,i),r=i,s.push(0))),t.setNodeNeedFormatting(r,!0,!0),pinegrow.pgPostCSSHelper.insertNodeAt(r,o,o.nodes.length),t.setSourceForRules(n,function(){var e=pinegrow.getCollectionForElement(v);e.forEachElement(function(e){e.removeAttr("style"),e.setData("selectedCssRule",pgcssh.getGlobalNodeId(h))}),pinegrow.changeManager.didChange(e,"Remove style attribute"),pinegrow.dispatchEvent("on_css_node_added",null,{node:h,stylesheet:t}),$.fn.crsa("selectRule",h,S),pinegrow.selectedElements.repositionMenusDelayed()}))}:pinegrow.showQuickError("The page has no active CSS stylesheets.")}var n,o=$(e.target),l=o.closest(".crsa-stylesheet"),s=l.data("cs"),h=s.getRootNode().nodes[0],v=s.element,s=(pinegrow.pgActiveRules.getActiveNodes(),pinegrow.pgActiveRules.getShownNodes().filter(function(e){var t=pgcssh.getStylesheetForNode(e);return!(t&&!t.canEdit(!0))}));return 0===s.length?t():(n=[{label:"Create new rule...",action:function(){t()}},{type:"divider"},{type:"header",label:"Add to existing rule:"}],s.forEach(function(l){var e=pgcssh.getRuleDisplayName(l);e+=" <small>"+pgcssh.getStylesheetForNode(l).name+"</small>",n.push({label:e,action:function(){for(var e=pgcssh.getStylesheetForNode(l),t=0,n=0;n<h.nodes.length;n++)"decl"==h.nodes[n].type&&(t=n);var o=pinegrow.getCollectionForElement(v);o.forEachElement(function(e){e.removeAttr("style")});for(n=0;n<h.nodes.length;n++)"decl"==h.nodes[n].type&&e.ruleValueChanged(l,h.nodes[n].prop,h.nodes[n].value,null,!1,"gui",n==t,null);pinegrow.changeManager.didChange(o,"Remove style attribute"),pinegrow.dispatchEvent("on_css_node_updated",null,{node:l,stylesheet:e}),$.fn.crsa("selectRule",l,S),pinegrow.reselectElement()}})}),new CrsaContextMenu(n,o).showForElement(o)),!1},Pe=function(){var e=pinegrow.getSelectedPage().getStylesheets().getAllCrsaStylesheets();w=[];for(var t=0;t<e.length;t++)w=w.concat(pgStylesheetHelper.getAllStylesheetsFor(e[t]));a=[];for(t=0;t<w.length;t++)w[t].url&&w[t].canEdit(!0)&&a.push(w[t].url)},Re=function(e,t,n){var o=null,o=n?$('<div class="crsa-stylesheet"></div>').insertAfter(C.find("> .crsa-stylesheet:nth-child("+n+")")):t?$('<div class="crsa-stylesheet"></div>').prependTo(C):$('<div class="crsa-stylesheet"></div>').appendTo(C),l=$('<div class="rule-list active-rule-container"></div>').appendTo(o);return o.data("cs",e),{$stylePaneContainer:o,$currRuleList:l}},Te=function(e,t,n,o,l){var s=F+"-"+L,r=(l=l||{},$.extend({},{uncollapse:g,"created-by":"active_css","uncollapse-on-click":!1,"extra-rule-el-id":s,"inversed-insert":!0,"skip-showing-rule":!0,"on-node-indices-changed":fe,"on-node-added":P,"on-node-changed":we,"on-before-node-deleted":T,"on-edit-finish":ye,"on-node-replaced":Ce,"on-rule-id-changed":Ie,"on-node-uncollapsed":_e,"on-rule-selected":xe,"is-allowed-insert-node":ke,"handle-element-selected":!1,"show-all":!0},l)),s=(r["read-only"]=pgf.kids||!1,m[e.getUniqueName()+"-"+pinegrow.pgPostCSSHelper.getNodeIndices(n)]=W,ee(n,e,s),new PgStylesPane(e,o,o.closest(".rules-list"),[t],r));return s.show(),"atrule"==t.type?s.onlyShowNode(n):s.updateShownNodes(),p.push(s),W++,L++,new PgCSSRuleControls(o,s,{withoutDargDrop:!0,"skip-move-item":!0,by:"active_css","skip-enable-item":pgf.kids||!1}),s},He=function(t,e,n,o){for(var l,s,r=e.parent,i=1,a="";r&&"root"!=r.type;)"rule"==r.type&&r.selector?a=r.selector+" / "+a:1==i||"atrule"!=r.type||"media"!=r.name&&"supports"!=r.name||(a='<span class="media-params" data-node-indices="'+pinegrow.pgPostCSSHelper.getNodeIndices(r).join(",")+'">'+r.params+"</span>"+a),r=r.parent,i++;a=t.name+(a.length?" / ":"")+a,q==a&&!o||(l=a,l+='<i class="cmd open icon  icon-align-left"></i>',(t.localFile||!isApp()&&t.url)&&(l+='<i class="cmd edit-code icon icon-KODA"></i>'),l+='<i class="cmd ignore icon icon-hide"></i>',t.inline||(l+='<i class="cmd lock icon icon-Lock_closed"></i>'),l=$('<div class="parent-path">'+l+"</div>"),pgf.kids||l.appendTo(n),l.find("> .media-params").off("click",be).on("click",be).off("keydown",Ee).on("keydown",Ee).off("blur",$e).on("blur",$e),(s=l.find(".edit-code")).on("click",function(e){e.preventDefault(),pinegrow.stylesheets.editCode(t)}),s.length&&addTooltip(s,"Edit stylesheet code."),(s=l.find(".open")).on("click",function(e){e.preventDefault(),S.parentView&&S.parentView.setActiveCs(t)}),addTooltip(s,"Open the stylesheet in a separate tab."),(s=l.find(".ignore")).on("click",function(e){e.preventDefault(),t.ignoreInActive()}),addTooltip(s,"Ignore the stylesheet in Active tab."),t.inline||((s=l.find(".lock")).on("click",function(e){e.preventDefault(),t.canEdit(!0)?(t.setLocked(!0,""),pinegrow.selectedElements.reselect(),pinegrow.showQuickMessage("Stylesheet is locked.")):t.unlockWithAsk()}),t.canEdit(!0)?addTooltip(s,"Click to lock the stylesheet."):(s.addClass("pg-css-locked icon-Lock_open").removeClass("icon-Lock_closed"),addTooltip(s,`The stylesheet is locked. ${t.lockedReason||""} Click to unlock.`))),q=a)},H=(this.updateLayout=function(){for(var e=0;e<p.length;e++)p[e].updateShownNodes()},[]),D=(this.didMatchedRulesChange=function(){t=pinegrow.getSelectedPage().$iframe.contents().get(0).defaultView,e=f.get$DOMElement();var e,t=t&&e?{win:t,el:e.get(0)}:null;if(!t)return o=[],!0;var n=crsaGetFreshMatchedRules(t.win,t.el),n=crsaCombinedTwoCSSList(crsaGetFreshMatchedRules(t.win,t.el,"after"),n);if(n=crsaCombinedTwoCSSList(crsaGetFreshMatchedRules(t.win,t.el,"before"),n),!D)return!0;for(var o=[],l=0;l<D.length;l++)o.push(D[l]);for(l=0;l<n.length;l++){var s=o.indexOf(n[l]);if(s<0)return!0;o.splice(s,1)}return 0!=o.length},[]),M=!1;this.setActiveOutDated=function(){M=!0},this.show=function(d,e,c){var l,p,s,t,n;h||"none"===c||(c=null),C.html(""),X.html(""),q="",H=[],L=1,f&&(l=function(e){return!1},p=null,s=function(){for(var e,t,n=0;n<p.length;n++){var o=p[n],l=o.node,o=o.pgStylesheet,s=(H.push(l),Re(o)),r=(He(o,l,s.$currRuleList),{"uncollapse-all":g,uncollapse:g}),i=l,a=l.parent,a=(!a||"atrule"!==a.type||"media"!==a.name&&"supports"!==a.name||(i=a,r.uncollapse=!0),s.$stylePaneContainer);Te(o,i,l,a,r)}return le(),Ne(),"none"===c||(e=function(){1==H.length||H[0].nodes.length||pinegrow.activeElementStyleWasSelected||H[1].selector&&H[1].selector.startsWith("*")?I(H[0]):I(H[1])},!!H.length&&("inline"===c?I(H[0]):c&&0<=H.indexOf(c)&&!c.selector.startsWith("*")?I(c):d&&(t=d.data||d,0<=H.indexOf(t))?I(t):e(),!0))},v={},M?(M=!1,pinegrow.pgActiveRules.updateMatchedRules(!0,null,{rule_list:e})):(t=pinegrow.pgActiveRules.getActiveNodes())&&(n={more_sheets:t.more_nodes,matched_rules:t.matched_rules,nodes_to_show:t.nodes_to_show},o=n.more_sheets,D=n.matched_rules,p=n.nodes_to_show,Pe(),J(),e?s():loadInlineAsStylesheetAndGetRules(f,function(e,t){var n,o;r=t,f&&((n=Re(r,!0).$stylePaneContainer).addClass("style-attribute-style-pane"),(i=$('<i class="icon icon-plus-square to-rule-icon"></i>')).appendTo(n).hide(),i.on("click",Ae),addTooltip(i,"Save inline style to a proper CSS rule."),o=r.getAllRules())&&o.length&&(o=o[0],H.push(o),o&&o.nodes&&0<o.nodes.length&&(l(o.nodes)||(i.show(),u=!0,i.closest(".style-attribute-style-pane").addClass("has-inline-style"),y.setSaveInline(!0))),Te(r,o,o,n,{uncollapse:(pgf.kids,!0),auth:{can_add_rule:!1,can_edit_rule:!1}}),n.find("li.crsa-rule").addClass("selected"),s()||I(o))})))},this.removeStylesheetObj=function(){r&&(r.remove(),r=null)},this.remove=function(){if(this.removeStylesheetObj(),p){for(var e=0;e<p.length;e++)p[e].remove(),p[e]=null;p=null}y&&(y.view.destroy(),y=null),w=[],p=[],v={},o={},i=S=null,C.html(""),X.html(""),j=!0}}else $('<div class="alert alert-info">There is no element selected</div>').appendTo(n)};