window.PgCompilableStylesheet=function(){function d(e,t,r){var o,s,i=t.getRelativeUrlFromImported(e,r,!0);return t.skipImportFile(i)?{relativeUrl:i,href:i}:(t.onMapImportRelativeUrl&&(i=t.onMapImportRelativeUrl(i)),o=crsaCombineUrlWith(t.url,i),s=crsaMakeFileFromUrl(o),!isApp()||crsaIsRemoteUrl(o)||crsaIsFileExist(s)||(i=t.getRelativeUrlFromImported(e,r),o=crsaCombineUrlWith(t.url,i)),{relativeUrl:i,href:o})}var e=new window.PgStylesheet,n=(e.compiledCssCode=null,e.compilationError=null,e.includeSourceMap=!1,e.sourceFormated=!1,e.ignoredImportedFiles=[],e.dontAddIds=!1,new RegExp(e.GROUP_TITLE_MARGIN+"\\s(.*)\\s"+e.GROUP_TITLE_MARGIN),{}),a=0,r=(e.isCompilableStylesheet=function(){return!0},e.canEditRuleSelector=function(){return!0},e.canAddChangeMediaQuery=function(){return!0},e.resetTreeNodeId=function(){a=0},e.lastNodeId=function(){return a},e.smartGetAllUsedNodes=function(e,o,t){t=t||null;var s=[],i=[],p=pinegrow.pgPostCSSHelper,n=new RegExp("\\"+this.getDeclCharachter()+"[a-z0-9_\\-]*","ig"),g=function(e,t,r,o,s){for(var i=[],n=null,l=(r?(u=o.getRootNode(),n=o,i=u.nodes,u.nodes.length):(h=(i=(u=(h=p.getTopLevelNodeFor(e)).parent).nodes).indexOf(h),n=p.getStylesheetForNode(u),h||i.length))-1;-1<l;l--){var a=i[l];if(p.isVariable(a)){var d="prop",c="";if("atrule"==a.type&&(c="@",d="name"),c+a[d]==t)return a}else if("import"==p.getNodeType(a)){c=n.getImportedStylesheetFromRelativeUrl(a.params);if(n.getUniqueName()!=c.getUniqueName())if("custom.scss"!=c.name)if(a=g(null,t,!0,c,!0))return a}}var u=pinegrow.getSelectedPage();if(!s&&n.isImportedFor(u)){var h=pinegrow.stylesheets.getStylesheetInfo(n,u);if(h&&h.parentPgStylesheet){u=h.parentPgStylesheet;if("_custom.scss"!=u.name)if(a=g(null,t,!0,u))return a}}return null},l=function(e,r){var t=e.match(n);t&&t.forEach(function(e){var t=g(r,e);t&&!o&&l(t.value,t),t&&-1==s.indexOf(e)&&(s.push(e),i.push(t))})},r=p.isVariable(e);return r&&s.push(p.getVariableProp(e)),t||("decl"==p.getNodeType(e)?t=e.value:"atrule"==p.getNodeType(e)&&(t=e.params)),l(t,e),r&&i.push(e),{names:s,nodes:i}},new PgDelayedTasks);return e.updateCompiledCode=function(t,o,s){this.compiledStylesheets.forEach(function(r){var e=new CrsaProfile(!0,"UPDATE COMPILED ");r.setSource(t.toString(),function(){e.show("DONE"),r.getSourceToSave(function(e,t){e&&(t=""),pinegrow.codeEditors.cssCodeChanged(r.url,function(){return t},null,null,r)}),o&&o(),e.show("AFTER DONE")},!1,!1,s)})},e.addIdsToNodes=function(e){var t=this.varGroups;this.processNodes(e),this.varGroups=t},e.processNodes=function(e){function i(e,t){for(var r,o=0;o<e.length;o++){if("auto-detect"==pinegrow.autoFormatCss&&pgcssf.detectFormatting(e[o],t,o,n.formattingOptions),"rule"!=e[o].type||e[o].ruleWithoutBody||e[o].params)"rule"==e[o].type&&e[o].params?e[o].raws.hasOwnProperty("semicolon")?e[o].raws.semicolon=!0:e[o].after=";"+e[o].after:"import"==e[o].type?e[o].raws.semicolon=!0:"decl"==e[o].type&&"root"==e[o].parent.type&&e[o].prop[0]==n.getDeclCharachter()&&l.push(e[o]);else{if(e[o].nodes||e[o].empty||(e[o].nodes=[]),!n.canAddRuleIds(e[o],n.atruleWithNoChild))continue;var s=++a+"";e[o]["pg-node-id"]=s,e[o]["pg-main-file"]=n.getUniqueName(),"less"==n.fileType&&(s=e[o].last)&&s.empty&&"rule"==s.type&&(s.raws.semicolon=!0),n.dontAddIds||n.isImported()&&(e[o]["pg-file"]=n.name,e[o]["pg-file-name"]=n.getUniqueName())}0<l.length&&("decl"!=e[o].type||e[o].prop[0]!=n.getDeclCharachter()||o+1==e.length)&&(r=l,n.varGroups.push(r),l=[]),e[o].nodes&&0<e[o].nodes.length&&i(e[o].nodes,!0)}}var n=this,l=[];return this.formattingOptions={},this.emptyNodes=[],this.varGroups=[],i(e,!1),e},e.addSemicolonToSource=function(e){var t,r,o=(e=e.trim()).length;return 0<o&&";"!=e[o-1]&&"}"!=e[o-1]&&(o=!0,o=!(0<(t=e.match(/(?!\n).*$/)).length&&(r=(t=t[0]).length,"/"==t[0]&&"/"==t[1]||"*"==t[r-2]&&"/"==t[r-1]))&&o)&&(e+=";"),e},e.addCompiledStylesheet=function(e){this.compiledStylesheets.push(e),e.compiledFile=!0},e.importer=function(e,t,r){var o,s,i;return e?(o=null,s="",i=e,"scss"==this.fileType&&(i=i.replace(/\-pg[0-9]+/,"")),(o=("stdin"==t?this:n[t]).getImportedStylesheetFromRelativeUrl(i))&&(s=o.getSourceForRules(null,!this.dontAddIds),n[e]=o),r&&r({contents:s}),{contents:s}):(r&&r(),{contents:""})},e.renderingFinished=function(e,t,r){e?r&&r(e):r&&r(null,t)},e.setSourceForRules=function(e,t,r,o){this.setNeedFormatting(!0);var s=this.getSourceForRules(e);this.setSource(s,t,r,!1,o)},e.removeAllImportFiles=function(){for(var e=this.importedFiles,t=0;t<e.length;t++)e[t].remove(),e[t]=null;this.importedFiles=[]},e.reload=function(e,t){pinegrow.codeEditors.ignoreCodeForUrl(this.url);function r(e){t?e.saveCompiledFile(i):i()}var o,s=0,i=function(){--s<=0&&e&&e()},n=this;this.isImported()?this.loadFromUrl(this.url,function(){n.setChanged(!1),n.getMainParnetStylesheets().forEach(function(e){s++,e.regenerateAndSetCssSource(function(){r(e)})})}):0<this.compiledStylesheets.length&&(o=this.compiledStylesheets,this.removeAllImportFiles(),this.compiledStylesheets=[],o.forEach(function(e,t){0==t?n.load(n.url,function(){n.setChanged(!1),r(n)},!0,!1,e):n.addCompiledStylesheet(e)}))},e.getImportedStylesheetFromRelativeUrl=function(e,t){e=crsaGetUrlAndParamsFromImport(e)[0];var r=t||this.importedFiles,o=[];o.push(this.getFullUrlFor(e),this.getFullUrlFor(e,!0));for(var s=0;s<r.length;s++)if(-1<o.indexOf(r[s].url))return r[s]},e.setSource=function(l,a,d,c,u){var h=this;this.forgetSourceErrors(),this.sourceBeingCurrentlyParsed=l,this.parseSource(l,function(e,t,r){var o,s,i,n;h.sourceBeingCurrentlyParsed=null,e?(h.codeError=e,getTrimed(h.parsedSource)!=getTrimed(l)&&(h.source=h.parsedSource=l,h.loaded)&&h.setChanged(!0),a&&a()):(o=function(){c?a&&a():h.regenerateCssFromCompilableSource(function(e,t){e?(h.compilationError=e,a&&a()):(h.compilationError=null,h.updateCompiledCode(t.css,a,u)),h.ignore=n})},h.codeError=null,getTrimed(h.parsedSource)!=getTrimed(t)&&(h.source=h.parsedSource=t,h.loaded)&&h.setChanged(!0),d||(h.rootNode=r,h.rootNode.pgStylesheet=h),""==h.source?(h.removeAllImportFiles(),h.isImported()?(s=0,i=function(e){--s<=0&&a&&a(e)},c?a&&a():h.forEachParentCS(function(e){s++,e.regenerateAndSetCssSource(i)},!0)):h.updateCompiledCode("",a)):(n=h.ignore,h.ignore=!1,h.loadAllImportedFiles(function(){var t,r;h.getError()?(h.ignore=n,a&&a()):h.isImported()?(t=0,r=function(e){--t<=0&&a&&a(e)},c?a&&a():(0<h.compiledStylesheets.length&&o(),h.forEachParentCS(function(e){t++,e.regenerateAndSetCssSource(r)},!0)),h.ignore=n):o()})))},!0)},e.regenerateAndSetCssSource=function(e,t,r){r=r||this.getRootNode(),this.source=this.getSourceForRules(r),this.setSource(this.source,e)},e.getSource=function(){return this.codeError||!this.rootNode||this.source&&this.sourceFormated||(this.source=this.getSourceForRules(),this.changedOnce&&(this.sourceFormated=!0)),this.source},e.getStylesheetSource=function(e){this.source||(this.source=this.getSourceForRules()),e&&e(this.source)},e.getCssSource=function(r,o){this.isImported()?r(""):null!=this.compiledCssCode?r(this.compiledCssCode):this.regenerateCssFromCompilableSource(function(e,t){e?o(e):r(t.css.toString())})},e.getImportUrlIfExist=function(e){return"atrule"==e.type&&"import"==e.name?e.params:null},e.updateImportedListOrder=function(){},e.ignoreImportedFile=function(e,t){var r=this.getImportedStylesheetFromRelativeUrl(e.params);r&&(this.ignoredImportedFiles.push(r),this.setRecursiveImportsError(null))},e.removeImportedFile=function(e){var t=this.getImportUrlIfExist(e);t&&(t=crsaGetUrlAndParamsFromImport(t)[0],t=this.getImportedStylesheetFromRelativeUrl(t),-1<(t=this.importedFiles.indexOf(t))?(this.importedFiles.splice(t,1),found=!0):this.setRecursiveImportsError(null))},e.addImportedFile=function(e,t){var r,o,s,i,n=this.getImportUrlIfExist(e);this.skipImportFile(n)?t&&t():(i=d(n,this,e),r=i.relativeUrl,o=i.href,(i=this.checkRecursiveImports(o,!0))?t&&t(i):((s=pinegrow.stylesheets.getStylesheetByKey(o))?t&&t():((s=this.getNewStylesheet()).nakedUrl=n.replace(/[\"\']/g,""),s.index=pinegrow.stylesheets.getLastIndex(!0),s.dontAddIds=this.dontAddIds,i=crsaMakeFileFromUrl(o),n=function(){pinegrow.showQuickMessage("Loading "+r+" file..."),s.loadFromUrl(o,function(){console.log("done "+s.url),pinegrow.dispatchEvent("on_css_loaded",null,s),t&&t()})},crsaIsFileExist(i)||(crsaCreateDirs(crsaGetDir(i)),fs.writeFileSync(i,""),console.log("Imported file created!")),n()),s.addParentStylesheet(this),this.importedFiles.indexOf(s)<0&&pinegrow.stylesheets.stylsheetUsed({url:o,pgStylesheet:s},"child",this)))},e.getImportedFileFromIgnoreList=function(e,t){var r=this.getImportedStylesheetFromRelativeUrl(e,this.ignoredImportedFiles);return r?(-1<(r=this.ignoredImportedFiles.indexOf(r))&&t&&this.ignoredImportedFiles.splice(r,1),ignoredStylesheet):null},e.getImportedFiles=function(){var n,l,a;return this.ignore?[]:(l=[],(a=function(e){if(e)for(var t=0;t<e.length;t++){var r=e[t],o=n.getImportUrlIfExist(r);if(o){var s=d(o,n,r),i=s.relativeUrl;if(n.skipImportFile(i))continue;i=s.href;if(n.checkRecursiveImports(i,!0))return;s=pinegrow.stylesheets.getStylesheetByKey(i);s||((s=n.getNewStylesheet()).nakedUrl=o.replace(/[\"\']/g,""),s.index=pinegrow.stylesheets.getLastIndex(!0),s.dontAddIds=n.dontAddIds),s.addParentStylesheet(n),l.push({cs:s,href:i}),n.importedFiles.indexOf(s)<0&&pinegrow.stylesheets.stylsheetUsed({url:i,pgStylesheet:s},"child",n)}r.nodes&&0<r.nodes.length&&a(r.nodes)}})((n=this).rootNode.nodes),l)},e.load=function(e,o,t,r,s){this.resetError();var i=this,n=(this.addCompiledStylesheet(s),this.setNakedUrl(e)),l=function(e,t,r){o&&setTimeout(function(){o&&o(i,e,t,r),pinegrow.dispatchEvent("on_css_loaded",null,i)},1)};if(this.ignore&&!t)l();else{var a=require("fs");if(isApp()&&crsaIsFileUrl(n))try{var d=crsaMakeFileFromUrl(n,!0),c=pinegrow.codeEditors.getCodeForUrl(n);null===c&&(c=a.readFileSync(d,{encoding:"utf8"})),console.log("loaded "+n),this.setSource(c,function(){i.getError()?(console.log("invalid "+i.fileType+" "+n,i.getError()),i.loaded=!0):(i.loaded=!0,console.log("loaded "+i.fileType+" "+n)),l(),i.setLocalFile(d)})}catch(e){this.setSource("",l),r||(this.error=e.message)}else{function u(e){i.setSource(e,function(){i.codeError?console.log("invalid "+i.fileType+" "+n,i.codeError):(i.loaded=!0,console.log("loaded "+i.fileType+" "+n),l())})}a=pinegrow.getCurrentProject();a.hasContentForUrl(n)?a.getContentOfUrl(n,u):$.ajax({url:n,data:null,dataType:"text"}).done(function(e){console.log("loaded "+n),i.setLoadingFailed(!1),u(e)}).fail(function(){var e="Failed loading "+n;console.log(e),i.error=e,i.setLoadingFailed(!0)})}}},e.loadFromUrl=function(e,o,t,r){this.resetError();function s(e,t,r){o&&setTimeout(function(){o(i,e,t,r),pinegrow.dispatchEvent("on_imported_css_loaded",null,i)},1)}var i=this,n=this.setNakedUrl(e);if(this.ignore&&!t)s();else{var l=require("fs");if(isApp()&&crsaIsFileUrl(n))try{var a=crsaMakeFileFromUrl(n,!0),d=l.readFileSync(a,{encoding:"utf8"});console.log("loaded "+n),this.setSource(d,function(){i.getError()?(i.loaded=!0,console.log("invalid "+i.fileType+" "+n)):(i.loaded=!0,console.log("loaded "+i.fileType+" "+n)),s(),i.setLocalFile(a)},!1,this.isImported())}catch(e){this.setSource("",s,!1,this.isImported()),r||(this.error=e.message)}else $.ajax({url:n,data:null,dataType:"text"}).done(function(e){console.log("loaded "+n),i.setLoadingFailed(!1),i.setSource(e,function(){i.codeError?console.log("invalid "+i.fileType+" "+n):(i.loaded=!0,console.log("loaded "+i.fileType+" "+n),s())},!1,i.isImported())}).fail(function(){var e="Failed loading "+n;console.log(e),i.error=e,i.setLoadingFailed(!0)})}},e.getPageStylesheetFrom=function(e){var t=pinegrow.stylesheets.getStylesheetInfo(this,e);if(t&&t.compiledStylesheet){t=t.compiledStylesheet;if(t)return pinegrow.stylesheets.findAttachmentFor(t,e)}return null},e.saveCompiledFile=function(e){var t=pinegrow.getSelectedPage(),t=pinegrow.stylesheets.getStylesheetInfo(this,t);t&&t.compiledStylesheet&&(t=t.compiledStylesheet)&&t.save(t.localFile,e)},e.save=function(e,s,i,r,n){function t(e){var t=e.localFile;crsaIsFileExist(t)||(c=!0),e.save(t,null,i,r,n)}function o(e){function s(e,t){for(var r=0;r<e.length;r++){u++;var o=e[r];p(o,o.localFile),0<o.importedFiles.length&&s(o.importedFiles,o.localFile)}}s(e.importedFiles)}var l,a,d=this,c=(i=i||require("fs"),!1),u=0,h=function(){0==u&&(c&&pinegrow.refreshCurrentProjectDelayed(!0),s)&&s()},p=function(t,r){function o(){setTimeout(function(){try{var e=t.getSource(),e=d.filterSource(e);n?n.writeFile(r,e,function(){t.lastSavedAt=(new Date).getTime(),console.log("saved "+t.fileType+" path "+r),t.setChanged(!1)}):(crsaWriteFileWithBackup(i,r,e,"utf8"),t.lastSavedAt=(new Date).getTime(),console.log("saved "+t.fileType+" file "+r),t.setChanged(!1)),crsaIsFileUrl(t.url)&&t.localFile!=r&&t.setUrl(crsaMakeUrlFromFile(r)),pinegrow.dispatchEvent("on_css_file_saved",null,t),u--,h()}catch(e){s(e)}},10)}var e=require("path");r=e.resolve(r),crsaIsFileExist(r)||(c=!0);t.getCssSource(function(e){o()},function(e){})},g=(u++,p(this,e),0<this.importedFiles.length&&o(this),pinegrow.getSelectedPage());this.isImportedFor(g)?(l=pinegrow.stylesheets.getIncludedPgStylesheetParent(this,g)).length&&(l=l[0],a=pinegrow.stylesheets.getStylesheetInfo(l,g))&&a.compiledStylesheet&&a.compiledStylesheet.changed&&t(a.compiledStylesheet):(a=pinegrow.stylesheets.getStylesheetInfo(this,g))&&a.compiledStylesheet&&t(a.compiledStylesheet)},e.regenerateRules=function(o){this.parseSource(this.source,function(e,t,r){o(e?{nodes:[]}:r)},!0)},e.getRuleById=function(){},e.getRuleSelector=function(e,t){for(var r=e,o="";"root"!=r.type&&"rule"==r.type;)var s=r.selector,o="&"==s[0]?s.replace("&","")+o:" "+s+o,r=r.parent;return o.trim()},e.isVarInUse=function(e){var t,s=new RegExp("(\\"+e.prop+")"),i=function(e){for(var t=0;t<e.length;t++){var r=e[t];if("decl"==r.type){var o=r.value.match(s);if(o&&1<o.length)return!0}if(r.nodes&&0<r.nodes.length&&i(r.nodes))return!0}};e.parent;return e.value.toLowerCase().indexOf("!global")&&this.getRootNode(),!isInUsed&&this.isImported()&&(t=!0,this.forEachParentCS(function(e){if(t)t=!1;else if(!(isInUsed=!!i(currentStylesheet.getRootNode().nodes))&&e.isImported())return!1})),isInUsed},e.forgetCachedSource=function(){this.source=null,this.compilationError=null},e.forgetSourceErrors=function(){this.codeError=null,this.compilationError=null,this.recursiveImports=null},e.updateNodeStylesheetWithSource=function(s,e,i){function n(e){r.setSourceForRules(pinegrow.pgPostCSSHelper.getRootNodeFor(e),function(){i&&i(e)})}var t,r=this;"decl"==s.type?(t=e.split(":"),pgcssh.setNodeProperty(s,"prop",t[0].trim()),pgcssh.setNodeProperty(s,"value",t[1].trim()),n(s)):this.parseSource(e,function(e,t,r){var o;e?i&&i():((o=pinegrow.pgPostCSSHelper.replaceNodeWith(s,r.nodes[0])).raws.before=s.raws.before,n(o))},!0)},e.renameRuleSelector=function(e,t,r,o){this.canEdit(!1,!0)?pinegrow.pgPostCSSHelper.renameRuleSelector(e,t)&&(this.forgetCachedSource(),pinegrow.dispatchEvent("on_css_node_updated",null,{node:e,stylesheet:this,edited_by:o}),this.setSourceForRules(pinegrow.pgPostCSSHelper.getRootNodeFor(e),r,!0)):r&&r()},e.resetError=function(){this.error=null,this.codeError=null,this.compilationError=null,this.recursiveImports=null},e.getError=function(){if(this.compilationError){var e=this.compilationError;try{var t="";return e.file&&(t=e.file.replace(/\-pg[0-9]+/,"")),`${e.message} in file <b>${t}</b> at ${e.line}:`+e.column}catch(e){}}return this.error||this.codeError||this.compilationError||this.recursiveImports},e.filter=function(e){var t=this.superFilter(e);return t||{haveTo:"doNothing"}},e.removeFromCompiledStylesheet=function(e){var t=this.compiledStylesheets.indexOf(e);-1<t&&this.compiledStylesheets.splice(t,1)},e.remove=function(t){if(!pinegrow.stylesheets.isStylesheetUsed(this)){for(var e in this.removeSuper(),n)n[e]=null;n={},this.compiledStylesheets.forEach(function(e){e&&(t||e.remove(),e)&&(e.sourceStylesheet=null)}),this.ignoredImportedFiles=[],this.compiledStylesheets=[],this.parentPgStylesheets=[],this.varsPane&&(this.varsPane.remove(),this.varsPane=null),r.destroy()}},e};