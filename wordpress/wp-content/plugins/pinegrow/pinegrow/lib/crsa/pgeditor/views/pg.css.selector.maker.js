var PgSelectDefaultStylesheet=function(n,a){this.show=function(t){var s,e="<p>Please select the stylesheet to which you wish to add new CSS rules:</p>",e=e+'<div class="cs-selector"></div>'+"<p>Pinegrow will automatically add new CSS rules to this stylesheet when you create new CSS rules in the Active Style panel.</p>"+"<p>A tip: it is not a good idea to directly modify CSS files of plugins and frameworks, for example bootstrap.css. You will lose changes if you update the framework to a newer version. Instead, create a separate stylesheet and define all the custom styling for your website there.</p>",e=pinegrow.showAlert(e,"Choose default stylesheet for new CSS rules","Cancel","OK",function(){t(a,!0)},function(){var e;s&&(e=s.getValue(),(a=pinegrow.stylesheets.getByUrl(e))&&pinegrow.setDefaultStylesheet(n,a),t(a,!a))}).find(".cs-selector"),l=n.getAttachedStylesheets({loaded:!0,ignored:!1,imported:!0,inline:!1,locked:!1});l.length?(l=l.map(function(e){var t=crsaGetNameFromUrl(e.url);return{name:t,key:e.url,html:t+" <small>"+e.url+"</small>"}}),(s=new PgInputField("stylesheet",{type:"select",show_empty:!1,name:"Stylesheet",without_text:!1,default_value:l[0],options:l})).appendTo(e),a&&s.setValue(a.url),s.on("input",function(e){})):e.html("<p><b>No unlocked stylesheets were found.</b> Unlock a local stylesheet or add a new stylesheet in <b>File -&gt; Manage stylesheets</b> first. Note, inline stylesheets can't be used as default stylesheet.</p>")}},PgSelectorControl=function(e){this.$element=$('<div class="pg-selector-control"></div>')},PgSelectorMakerView=function(d,e,t){function s(e,t,s,l){I&&(d=t,pinegrow.highlightElement(s),O(),pinegrow.showQuickMessage("New target element was selected."),l.stop=!0)}var l,i,n,o,a,r,c,u,h,p,g,f=this,m={stylesheets:null,button_label:"Create",add_classes:!0,simple:!1,labels:!0,media_query:!pgf.kids,compact:!1,save_inline:!1},w=!1,v=(this.onCreate=function(e){},this.onCancel=function(e){},this.onCreateWithoutSelector=null,this.getSelector=function(){return S},this.setSelector=function(e){k.setValue(e),k.$input.trigger("input")},this.getStylesheet=function(){return g?g.getValue():null},this.getAddClasses=function(){return a&&a.getValue()?C:[]},this.getMediaQuery=function(){return h?h.getValue():null},this.getSaveInline=function(){var e=w&&u&&u.getValue();return u&&pinegrow.setSetting("create-css-rule-save-inline",u.getValue()?"1":"0"),e},this.setSaveInline=function(e){w=e,S&&(e?c.show():c.hide())},$.extend(m,t)),y=(this.getOptions=function(){return v},$('<div class="pg-selector-maker"></div>')),m=($('<div class="pg-selector-maker-inputs"></div>').appendTo(y),new PgUIView(y)),S=(this.view=m,e||""),C=[],_=!1,k=new PgInputField("selector",{type:"text",show_empty:!1,name:"Selector",without_text:!v.labels,placeholder:".myclass, #id, h1...",slider_def_unit:"",with_clear_icon:!0,validate:function(e,t,s){if(s){if(pgf.kids){var l=["html","body","div","section","a","p","iframe","main","h1","h2","h3","h4","img","header","footer","hr","button"],n=s.match(/^[a-z]+$/i);if(n){n=n[0].toLowerCase();if(l.indexOf(n)<0&&null===pinegrow.getSelectedPage().sourceNode.findOne(n))return`Do you want to create a class? In that case use <code>.${n}</code>.`}for(var a=pgcssh.getClassesFromSelector(s),o=0;o<a.length;o++)if(0<=l.indexOf(a[o]))return`Are you sure you want to create a class <code>.${a[o]}</code>? Remove the dot to target all <code>${a[o]}</code> elements?`}try{y.get(0).querySelector(s)}catch(e){return"This is not a valid CSS selector."}}}}),b=(k.appendTo(y),k.on("input",function(e){S=k.getValue(),V(!0),k.$field.removeClass("error"),D(),i&&i(),c&&w&&(S?c.show():c.hide())}),k.on("keydown",function(e){if(13==e.which)M(e);else{if(27!=e.which||v.compact)return;f.onCancel()}return!1}),k.on("focus",function(){i&&i(!0)}),null),T=(k.on("blur",function(){b=setTimeout(function(){i&&i(),b=null},500)}),this.getInput=function(){return k},null),P=(v.compact&&((l=$('<div class="pg-selector-dest"></div>').appendTo(y)).on("click","a",function(e){e.preventDefault(),new PgSelectDefaultStylesheet(pinegrow.getSelectedPage(),T).show(function(e,t){}),b&&(clearTimeout(b),b=null)}),i=function(e){((S.length||e)&&T?(T?l.html('<p>Rule will be created in <a href="#">'+crsaGetNameFromUrl(T.url)+"</a></p>"):l.html('<p><a href="#">Choose stylesheet</a> for the rule</p>'),pg$Show):pg$Hide)(l)},(n=function(){v.default_cs?(T=v.default_cs,i()):pinegrow.getDefaultStylesheet(pinegrow.getSelectedPage(),function(e){T=e,i()})})(),pinegrow.addEventHandler("on_default_stylesheet_selected",n),pg$Hide(l)),["","hover","active","focus","visited","first-child","first-of-type","last-child","first-letter","last-of-type","only-child","only-of-type","empty","after","before"]),x=(pgf.kids&&(P=["","hover","active","focus"]),$('<ul class="pg-selector-maker-crumbs"></ul>')),E=(pgf.kids||x.appendTo(y),pgf.kids&&$(`<div class="pg-selector-maker-help">
<p>Which HTML elements do you wish to style?</p>
<ul>
<li><code>${d.tagName}</code> - All <b>&lt;${d.tagName}&gt;</b> elements</li>
<li><code>.myclass</code> - All elements with the <b>class</b> myclass.</li>
<li><code>#button1</code> - Element with the <b>id attribute</b> button1.</li>
</ul>
<p>Add <code>:hover</code>, <code>:active</code> or <code>:focus</code> to style states.</p>
</div>`).appendTo(y),x.on("click","a",function(e){e.preventDefault();var t,s,l,n,a=$(this),o=a.closest("li");if(!_)return t=function(){S=H(),k.setValue(S),V(),D(),i&&i(),k.$field.removeClass("error")},a.hasClass("pg-sm-untruncate")?o.removeClass("truncated"):a.hasClass("pg-sm-state-opener")?((s=o.find(".pg-sm-state")).text(),l=new CrsaContextMenu(null,a),P.forEach(function(e){l.add(":"+e,null,function(){s.text(e),t()},null,{},!1)}),l.showForElement(a,null,8)):(n=a.attr("data-pg-sel"),a.toggleClass("selected"),">"==n&&a.hasClass("selected")&&0===(n=o.next()).find(".selected").length&&n.find(".pg-sm-tag").addClass("selected"),0===o.find(".selected").length&&o.prev().find(".pg-sm-lg").removeClass("selected"),t()),!1}),v.simple&&pg$Hide(x),$('<div class="pg-selector-maker-matcher"></div>').appendTo(y)),A=(pg$Hide(E),null),N=!1,V=function(e){A&&(clearTimeout(A),A=null);function t(){try{if(!S.length)return void pg$Hide(E);pg$Show(E);var e,t,s=S.replace(/\:hover|\:active|\:focus|\:visited/g,""),l=d.getPage(),n=$(l.getDocument()).find(s),a=n.length,o=(pinegrow.highlightElement(n),""),i="",r="",c="",u=d.get$DOMElement();u.is(n)?(o="match",i="This rule will style the selected element."):(t=u.attr("class"),f.getAddClasses().forEach(function(e){u.addClass(e)}),i=u.is(s)?(o="match-with-classes","This rule will style the selected element if classes are added to the element."):(o="no-match","This rule will NOT style the selected element."),null===t?u.removeAttr("class"):u.attr("class",t)),c=0<a?(r="match",`This rule will style ${a} elements on the page.`):(r="no-match",`This rule will not style any elements on the page.`),e=`<span class="pg-sel-match ${o}"><i class="icon icon-${pgf.kids?"check":"267"}"></i></span>`,e+='<span class="pg-other-match '+r+'"><i class="icon icon-no-affected"></i>'+a+"</span>",E.html(e),addTooltip(E.find(".pg-sel-match"),i),addTooltip(E.find(".pg-other-match"),c)}catch(e){E.html("Could not count matches on the page. <b>Perhaps the selector is not valid?</b>")}A=null}e?setTimeout(t,500):t()},F=(V(),v.add_classes&&(o=$('<div class="pg-selector-maker-addc"></div>').appendTo(y).hide(),(a=new PgInputField("addclasses",{type:"checkbox",show_empty:!1,name:"Add classes",without_text:!1,default_value:1,value:1})).appendTo(o),r=a.$field.find("label")),v.save_inline&&(c=$('<div class="pg-selector-maker-save-inline"></div>').appendTo(y).hide(),(u=new PgInputField("saveinline",{type:"checkbox",show_empty:!1,name:'Save <span class="pg-text-orange">inline style</span> to this rule',without_text:!1,default_value:pinegrow.getSetting("create-css-rule-save-inline","1"),value:1})).appendTo(c)),v.media_query&&((h=new PgInputField("mq",{type:"text",show_empty:!1,name:"Media query",without_text:!1,slider_def_unit:""})).appendTo(y),v.media_value&&h.setValue(v.media_value),new PgMediaQueryHelperView(h.$input,d.getPage()).view.get$Element().appendTo(y)),v.stylesheets&&(p=pinegrow.getCurrentProject(),F=v.stylesheets.map(function(e){var t=crsaGetNameFromUrl(e);return{name:t,key:e,html:t+" <small>"+(p?p.getRelativeUrl(e):e)+"</small>"}}),g=new PgInputField("stylesheet",{type:"select",show_empty:!1,name:"Stylesheet",without_text:!1,default_value:v.stylesheets[0],options:F}),pgf.kids||g.appendTo(y),v.stylesheet_value&&g.setValue(v.stylesheet_value),g.on("input",function(e){})),$('<button class="pg-button create btn-primary">'+v.button_label+"</button>")),M=(v.compact?(F.appendTo(k.$field),F.removeClass("btn-primary"),y.addClass("pg-selector-maker-compact")):F.appendTo(y),function(e){e.preventDefault(),S?pgf.kids&&N?pinegrow.showQuickError("The value is not a correct CSS selector. Please enter a valid selector."):f.onCreate&&f.onCreate(f):f.onCreateWithoutSelector&&f.onCreateWithoutSelector(f,e)||(k.$field.addClass("error"),f.onEmptySelector?f.onEmptySelector():pinegrow.showQuickError("Please enter the CSS rule selector"))}),H=(F.on("click",M),function(){var l="",n=!1;return x.children().each(function(e,t){var s=$(t),s=(s.find(".selected[data-pg-sel]").each(function(e,t){n&&(l+=" ",n=!1);var s=t.getAttribute("data-pg-sel");l+=s="&gt;"==s?">":s}),s.find(".pg-sm-state").text());s&&(l+=":"+s),n=!0}),$.trim(l)}),O=function(){x.empty();for(var e=d.get$DOMElement(),t=d.getPage();e&&e.length&&1===e.get(0).nodeType&&(x.prepend(U(e.get(0))),e=e.parent(),!pgf.kids);)if(e.length&&1===e.get(0).nodeType){if(t&&t.wrapper_node&&e.get(0).getAttribute("data-pg-wrapper"))break;x.prepend($('<li><a class="pg-sm-lg" href="#" data-pg-sel="&gt;">&gt;</a></li>'))}},U=function(e){for(var t=[],s=$("<li></li>"),l=(t.push($('<a class="pg-sm-tag" href="#" data-pg-sel="'+e.tagName.toLowerCase()+'">'+e.tagName.toLowerCase()+"</a>")),e.getAttribute("id")),n=(l&&!l.startsWith("sizzle")&&t.push($('<a class="pg-sm-id" href="#" data-pg-sel="#'+l+'">#'+l+"</a>")),pgMakeStringArrayUnique(pgGetElementClasses(e))),a=0;a<n.length;a++){var o=n[a],i="";v.select_class&&o==v.select_class&&(v.select_class=null,i=" selected"),t.push($('<a class="pg-sm-class'+i+'" href="#" data-pg-sel=".'+o+'">.'+o+"</a>"))}return 5<n.length&&(s.addClass("truncated"),t.push($('<a class="pg-sm-untruncate" href="#" title="Show all classes.">+</a>'))),t.push($('<a class="pg-sm-state-opener" href="#">:<span class="pg-sm-state"></span></a>')),t.forEach(function(e){s.append(e)}),s},D=(O(),function(){if(C=[],o){var e=$.trim(S).split(/\s/),t=[];if(e.length){var s=e[e.length-1].match(/\.[a-z0-9\-\_]+/gi);if(s)for(var l=d.get$DOMElement(),n=0;n<s.length;n++){var a=s[n].replace(".","");!d.hasClass(a)&&!l.hasClass(a)&&t.indexOf(a)<0&&t.push(a)}}t.length?(r.html("Add "+(1<t.length?"classes":"class")+" <b>"+t.join("</b>, <b>")+"</b> to the selected element."),o.show(),C=t):o.hide()}}),L=(D(),function(e,t,s,l){if(!s&&0<=t.indexOf(",")){for(var n=crsaSplitAndTrimList(t),a=0;a<n.length;a++)if(L(e,n[a],null,l))return!0;return!1}var o=[];if((s=s||d.parseSelector(t)).id){if(e.getAttribute("id")!=s.id[0].replace("#",""))return!1;o.push('[data-pg-sel="'+s.id[0]+'"]')}if(s.tag&&0<s.tag.length&&"*"!=s.tag[0]){if(s.tag.toLowerCase()!=e.tagName.toLowerCase())return!1;o.push('[data-pg-sel="'+s.tag[0]+'"]')}if(s.classes)for(a=0;a<s.classes.length;a++){if(!e.classList.contains(s.classes[a].replace(".","")))return!1;o.push('[data-pg-sel="'+s.classes[a]+'"]')}return l&&o.length&&l.find(o.join(",")).addClass("selected"),!0}),I=(v.selector_value&&(k.setValue(v.selector_value),k.$input.trigger("input")),!1);this.selectTarget=function(){I=!0,pinegrow.showQuickMessage("Click on an element on the page or in the tree to select a new target element.")},this.onShown=function(){k.$input.get(0).focus()},pinegrow.addEventHandler("on_element_clicked",s),m.onDestroy=function(){pinegrow.removeEventHandler("on_element_clicked",s),v.compact&&pinegrow.removeEventHandler("on_default_stylesheet_selected",n),A&&(clearTimeout(A),A=null)}},PgQuickSelectorMaker=function(e,t,s){var l=this,n=((s=s||{}).stylesheet_value||(s.stylesheet_value=pgcssh.getUrlOfStylesheetForOverrides()),this.maker=new PgSelectorMakerView(e,t,s)),a=new PgQuickWindow(s.title||"Create new CSS rule",n,"quickSelectorMaker",pgf.kids?500:570,pgf.kids?200:300);s.$position?a.showFor$El(s.$position,!1,0,"down"):a.showForPgel(e),n.onShown(),a.autoSize(120),pgf.kids||a.addIconToHeader("icon-267","Select another target element",function(){n.selectTarget()}),a.onDestroy=function(){},this.onCreate=function(e){},n.onCreate=function(e){l.onCreate&&l.onCreate(e);var t=e.getStylesheet();t&&pgcssh.setUrlOfStylesheetForOverrides(t),a.destroy()},n.onCancel=function(e){a.destroy()}};