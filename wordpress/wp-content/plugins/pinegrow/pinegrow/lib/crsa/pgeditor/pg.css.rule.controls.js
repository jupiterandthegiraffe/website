var PgCSSRuleControls=function(e,E,n){(n=n||{})["$scrollParent"]=n["$scrollParent"]||null,n["withoutDargDrop"]=1==n["withoutDargDrop"],n["by"]=n["by"]||"",n["skip-move-item"]=n["skip-move-item"]||!1,n["skip-delete-item"]=n["skip-delete-item"]||!1,n["skip-code-edit"]=n["skip-code-edit"]||!1,n["skip-enable-item"]=n["skip-enable-item"]||!1;function t(e){var n=$(e.target);n.closest(".has-options").length&&(n=n.closest(".has-options"),u(n,!1,e),e.stopPropagation()),e.preventDefault()}function s(e){var n,t,s,l,o=!1,i=$(e.target);pgPreview.hide(),i.closest(".crsa-cm-code").length?(t=i.closest("li"),n=b(t),pgf.kids?pinegrow.revealCSSRuleInCodeEditor(n):N(n,t),o=!0):i.closest(".crsa-cm-remove").length?(t=i.closest(".has-options"),E.pgStylesheet.canEdit(!1,!0)&&E.removeNode(t),o=!0):i.closest(".crsa-cm-enable").length&&(s=i.closest(".crsa-cm-enable"),l=!1,s.hasClass("icon-see")&&(l=!0),E.pgStylesheet.canEdit()&&E.toggleCodeIgnoring(s,l,function(e){e&&(l?s.removeClass("icon-see").addClass("icon-hide"):s.removeClass("icon-hide").addClass("icon-see"))}),o=!0),o&&(e.preventDefault(),e.stopPropagation())}function l(e){a=$(e.target)}var o,i='<div class="rule-menu">',r=(n["skip-enable-item"]||(i+='<i class="rule-menu-icon icon icon-see crsa-cm-enable"></i>'),n["skip-code-edit"]||(i+='<i class="rule-menu-icon icon icon-KODA crsa-cm-code"></i>'),n["skip-delete-item"]||(i+='<i class="rule-menu-icon icon icon-bin crsa-cm-remove"></i>'),n["skip-move-item"]||(i+='<i class="rule-menu-icon icon icon-Pin6 crsa-cm-move"></i>'),i+='<i class="rule-menu-icon menuicon icon icon-repeat-Y"></i></div>',$(i)),a=(n.withoutDargDrop&&e.addClass("not-dragable"),null),c=null,d=null,P=function(e){$.fn.crsa("selectRule",e)},b=function(e,n){return e.attr("data-node-indices")?(n=n||e.closest(".crsa-stylesheet").data("cs"),pinegrow.pgPostCSSHelper.getNodeByIndices(n.getRootNode(),e.attr("data-node-indices").split(","))):null},N=function(e,n){e=pgcssh.getRuleForNode(e);new PgQuickCSSRuleCodeEdit(e,n);E.pgStylesheet.canEdit(!0)||pinegrow.showQuickError("Opened in read-only mode because the stylesheet is locked.")},u=function(e,n,t){if(!pgf.kids){function s(e,n){n=n||"";var t,s=pgcssh.getUrlOfStylesheetForOverrides(null,n);s?(t="current"===s?g:pinegrow.stylesheets.getByUrl(s))?t.canEdit()&&(t.ignore=!1,t.loaded?e(t):t.load(t.url,function(){e(t)},!0)):pinegrow.showAlert("Stylesheet with "+s+" not found or not loaded!","Error"):pinegrow.showQuickMessage("Please select the destination stylesheet.",4e3,!1,"error")}function l(s,e,n,t){var l;s.canEdit()&&(n=n||e,pgcssh.isMedia(n.parent)&&(n=n.parent),l=t||(s===g?n:"append"),(new PgApi).addCSSRuleToStylesheet(e,s,l,{action:"Duplicate "+pgcssh.getNodeDisplayName(n)},function(e,n){var t;e||n.length&&(t=m(n[0]),E&&g&&s!==g&&pinegrow.activeCSSView.setActiveCs(s),t)&&P(t)}))}function o(s,e){var n,t,l;s.canEdit()&&(n=e,pgcssh.isMedia(n.parent)&&(n=n.parent),t=new PgApi,l=pgcssh.getSelectorWithoutPgId(e.selector)+" {}",t.addCSSRuleToStylesheet(l,s,s===g?n:"append",{action:"Override "+pgcssh.getNodeDisplayName(e)},function(e,n){var t;e||n.length&&(t=m(n[0]),E&&g&&s!==g&&pinegrow.activeCSSView.setActiveCs(s),t)&&P(t)}))}function i(e,n,t){var s=e.getSourceForRules(n),s=e.filterSource(s,!0);l(e,s,n,t)}function r(e,n,t,s){var l={label:e,kbd:n,action:t};s&&(l.type=s),v.push(l)}var a,c,d,u=b(e),g=pgcssh.getStylesheetForNode(u),p=pgcssh.getRuleForNode(u),h=!g.canEdit(!0),v=[],f=pinegrow.getSelectedElement(),m=function(e){if("rule"===e.type)return e;for(var n=0;n<e.nodes.length;n++){var t=m(e.nodes[n]);if(t)return t}return null},w=(h&&v.push({label:"This stylesheet is locked.",action:function(){}}),!p||n||(p.selector&&!h&&r("Edit...",null,function(){P(p)}),r("Edit code...",null,function(){N(p,e)}),g&&g.url&&r("Reveal in code",null,function(){pinegrow.revealCSSRuleInCodeEditor(p)})),pgcssh.isVariable);if("decl"===pgcssh.getNodeType(u)&&p===u.parent&&(r("",null,null,"divider"),r("!important",null,function(){var n,e;g.canEdit(!1,!1)&&((e=u.value).endsWith("!important")||u.important?(u.value=e.replace(/\s*!important/,""),u.important=!1):u.important=!0,n=pgcssh.getNodeIndices(u),e=pgcssh.getRootNodeFor(u),g.setSourceForRules(e,function(){var e=pgcssh.getNodeByIndices(g.getRootNode(),n);pinegrow.dispatchEvent("on_css_node_updated",null,{node:e,stylesheet:g,edited_by:"context_menu",oldValue:pgcssh.getNodeOldValues(e),undoCombineKey:"ruleValueChanged_"+e.prop})},!1,!0))},null,u.value.endsWith("!important")||u.important)),p?(r("",null,null,"divider"),r("Duplicate the whole rule",null,null,"header"),h||r("Duplicate",null,function(){l(g,p)}),r("<span>Duplicate</span>",null,function(){s(function(e){l(e,p)})},null)):w(u)?(r("",null,null,"divider"),h||r("Duplicate",null,function(){i(g,u)}),w=w(u),a=w?"-vars":"",r("<span>"+(w?"Customize":"Duplicate")+"</span>",null,function(){s(function(n){(new PgApi).overrideCSSVariable(u,n,function(e){e.length&&(E&&n===g||pinegrow.activeCSSView.setActiveCs(n),P(e.pop()))})},a)},null)):(r("",null,null,"divider"),a="-media",r("<span>Duplicate</span>",null,function(){s(function(e){i(e,u)},a)},null)),("decl"===pgcssh.getNodeType(u)||"atrule"===pgcssh.getNodeType(u))&&g.isCompilableStylesheet()&&!h){var C=g.smartGetAllUsedNodes(u,!0).nodes;if(0<C.length){r("",null,null,"divider"),r("Edit variables",null,null,"header");for(var S=0;S<C.length;S++){var y=C[S],y=pgcssh.getVariableProp(y);r("Edit "+y,null,function(e,n,t,s){var l,o,i,r,a,c,d,u,g;s&&s.node&&(l=s.node,o=$('<div class="var-dialog-content"></div>'),i=new PgVarDialogView(o),a=(r=pgcssh.getStylesheetForNode(l)).getMainParnetStylesheets(),c=[],a.forEach(function(e){var n=e.smartGetAllUsedNodes(l);n&&(c=c.concat(n.nodes))}),(d=new PgStylesheetVars(r,o,{useInsertBorder:!1})).show(c),i.setStylesheetVar(d),(u=new PgQuickWindow("Edit "+pgcssh.getVariableProp(l),i,"vars-editor",380,400)).showFor$El(t),g=function(e,n){if(n)for(var t=n.list,s=0;s<t.length;s++){var l=t[s];if(d.isPgStylesheetExists(l)){u.close();break}}},pinegrow.addEventHandler("on_css_source_changed",g),u.onDestroy=function(){pinegrow.removeEventHandler("on_css_source_changed",g)})},null)}}}return p&&p.selector&&(r("",null,null,"divider"),r("Create empty rule with this selector",null,null,"header"),h||r("<span>Override</span>",null,function(){o(g,p)},null),r("<span>Override</span>",null,function(){s(function(e){o(e,p)})},null)),E&&!h&&(r("",null,null,"divider"),r("Delete",null,function(){g.canEdit(!1,!0)&&E.removeNode(e)})),p&&(w=p.selector?pgcssh.getClassesFromSelector(p.selector):[]).length&&(f?(c=[],d=[],$.each(w,function(e,n){(f.hasClass(n)?c:d).push(n)}),d.length&&(r("",null,null,"divider"),r("Add class to&nbsp;&nbsp;<b>"+pinegrow.selectedElements.getName()+"</b>",null,null,"header"),d.forEach(function(e){r("+ "+e,null,function(){(new PgApi).addClass(null,e)})})),f.getClasses(),w=[],(0<c.length||0<w.length)&&(r("",null,null,"divider"),r("Remove class from&nbsp;&nbsp;<b>"+pinegrow.selectedElements.getName()+"</b>",null,null,"header"),$.each(c,function(e,n){r("- "+n,null,function(){(new PgApi).removeClass(null,n)})}),$.each(w,function(e,n){0!==n.indexOf("crsa-")&&r("- "+n,null,function(){(new PgApi).removeClass(null,n)})}))):r("Select element first, then assign class to it.",null,null,"header")),E&&!h&&p&&void 0!==p.nodes&&(r("",null,null,"divider"),r("Add rule inside...",null,function(){E.uncollapseLi(e),E.addNewNodePlaceholderTo(e,"rule")}),r("Add rule after...",null,function(){E.addNewNodePlaceholderAfter(e,"rule")}),r("Add rule before...",null,function(){E.addNewNodePlaceholderBefore(e,"rule")})),new CrsaContextMenu(v,e).showAt(t.pageX,t.pageY,e.closest(".crsa-cm-rules"))}};e.get(0).addEventListener("contextmenu",t,!0),e.get(0).addEventListener("click",s,!0),e.on("mouseenter",".has-options > div",function(e){var n=$(e.target).closest(".has-options"),t=(pgf.kids||(n.closest("li.hoverd").removeClass("hoverd"),n.addClass("hoverd")),r.find(".icon-see, .icon-hide")),s=b(n);if(s){var l=pgStylesheetHelper.getStylesheetFromNode(s);if(n.hasClass("crsa-rule")&&s&&s.selector)try{var o=pinegrow.getSelectedPage().activeView.get$Body().parent().find(l.getRuleSelector(s)).not('[class*="pinegrow-ui-helper"]');$.fn.crsa("highlightElement",o)}catch(e){}n.hasClass("has-options")&&(s&&(pinegrow.pgPostCSSHelper.isCommented(s)?t.removeClass("icon-see").addClass("icon-hide"):t.removeClass("icon-hide").addClass("icon-see")),r.detach(),(l=n.find("> div").not(".pg-tree-quick-insert-line")).length)&&$(l.get(0)).append(r)}}),e.on("mouseleave",".has-options > div",function(e){var n=$(e.target).closest(".has-options");n.removeClass("hoverd"),n.hasClass("has-options")&&r.detach(),$.fn.crsa("highlightElement",null)}),e.on("mouseover",".crsa-cm-code",function(e){}),e.on("mouseout",".crsa-cm-code",function(e){});e.get(0).addEventListener("mousedown",l),n.withoutDargDrop||(e.get(0).addEventListener("dragstart",function(e){var n=$(e.target);a.is(".crsa-cm-move")&&(n.closest(".crsa-stylesheet").data("cs"),n.is(".crsa-node")&&(b(n),c=n),setTimeout(function(){c.css("opacity",.4).hide()},100),$.fn.crsa("hidePreview"))},!0),e.get(0).addEventListener("dragover",function(e){var n,t;a&&a.is(".crsa-cm-move")&&((n=$(e.target)).is(".crsa-cm-placeholder")?(t=n.closest(".crsa-atrule")).is(".crsa-atrule")&&n.index()==t.find("> div").children().length-1&&(e.offsetX<25?d.insertAfter(t):d.appendTo(t.find("> div"))):n.closest(".crsa-node").length&&(n=n.closest(".crsa-node")).get(0)!=c.get(0)&&(d=d||$('<div class="crsa-cm-placeholder"></div>'),t=n.height(),e.offsetY<t/2?(d.insertBefore(n),(t=n.prev()).length&&(t.is(".crsa-node")&&b(t))):(d.insertAfter(n),b(n))),e.preventDefault())},!0),e.get(0).addEventListener("dragleave",function(e){var n=$(e.target);n.closest(".crsa-cm-placeholder").length||n.closest(".crsa-node").length},!0),o=function(e){var n,t;a&&a.is(".crsa-cm-move")&&((n=$(e.target)).closest(".crsa-node").length&&(null!=d&&(n=n.closest(".crsa-stylesheet").data("cs"),d.prev(),t=d.closest(".crsa-stylesheet").data("cs"),E.moveNodeFromTo(c,d,n!=t,t)),c)&&(c.css("opacity",1),c.show()),c=null,d&&d.remove(),d=null),a=null},e.get(0).addEventListener("dragend",o,!0),e.get(0).addEventListener("drop",function(e){$(e.target).closest(".crsa-node").length,e.stopPropagation()},!0)),n.$scrollParent&&n.$scrollParent.on("scroll",function(){c&&$(this).parent(0).scrollLeft(0)}),this.remove=function(){E=null,e.get(0).removeEventListener("contextmenu",t,!0),e.get(0).removeEventListener("click",s,!0),e.get(0).removeEventListener("dragend",o,!0),e.get(0).removeEventListener("mousedown",l)}};