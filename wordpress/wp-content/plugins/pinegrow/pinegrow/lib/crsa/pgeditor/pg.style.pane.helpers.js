var PgStylePaneHelper=function(i,r,e){this.pgInsertBorders=null;function t(e){if(u.isDblClickAllowed&&!u.isDblClickAllowed($(this)))return!1;i.dblClickCallback&&i.dblClickCallback(e);var t,l=$(e.target);l.is("span")&&l.has("crsa-scss-prop")&&(t=l.closest("li"),u.editField(l,t))}function l(e){var t=$(this).closest(".crsa-scss-prop")||$(this),l=(t=0==t.length?$(this):t).closest("li"),l=i.getNodeFrom(l);if((!l||!l.nodes)&&(w($(this))||!u.getSelectableObj||null!=(t=u.getSelectableObj(t))&&0!=t.length))return e.preventDefault(),i.focusCallback&&i.focusCallback(e),l&&(!l||l.nodes)||u.editField(t),!1}function n(e){if(w($(this))){liClicksTime=0;var t=$(this).closest("li"),l=($(this).data("focused",!1),i.getNodeFrom(t));if(!t.data("placeholder-item")&&l)return $(this).text()==$(this).data("old-text")&&t.data("placeholder-item"),$(this).data("focus-added",!1),i.blurCallback&&i.blurCallback(e),t.data("new-added")||m(this),i&&i.editFinishedCallback&&i.editFinishedCallback(e),i.selectingNextElm||r.data("properties-in-edit-mode",!1),i.selectingNextElm=!1,!1}}function a(t){if(w($(this))){function l(e){return!(e.keydownCallback&&e.keydownCallback(t)||g(t,n))&&void 0}var n=this,e=t.keyCode||t.which;if(13==e||9==e||27==e||38==e||40==e)return clearTimeout(k),l(i);null!==k&&clearTimeout(k),k=setTimeout(function(e){l(e)},250,i)}}function s(e){w($(this))&&(null!==v&&clearTimeout(v),v=setTimeout(function(){if(i.keyupCallback&&i.keyupCallback(e))return!1},250))}function o(e){var t=$(this);setTimeout(function(){t.html(t.text())},100)}function d(e){$(e.target).closest("li").hide(),b([]),h()}function c(){this.pgInsertBorders&&(this.pgInsertBorders.remove(),this.pgInsertBorders=null)}var u=this,p=((e=e||{})["add-new-placeholder-text"]=e["add-new-placeholder-text"]||"Add new...",$('<li class="add-new-node placeholder-node">'+e["add-new-placeholder-text"]+"</li>")),f=(p.data("shown",!0),function(e){e&&$(e).removeAttr("contenteditable")}),h=function(e){var t=(e=e||r).find("li.add-new-node");e.find("> li:not(.add-new-node)").length<=i.itemLengthToAddPlaceholder&&(t.length,p.appendTo(e),p.show())},g=(this.setUl=function(e){r=e},this.addNewNode=function(n,a,s,o){i.addingNewNode(n,a);var e=n.closest("li"),d=(e.data("shown",!0),e.data("placeholder-item",!0),n.attr("contenteditable","true"),n.focus(),crsaSelectText(n[0]),function(){r.data("properties-in-edit-mode",!1)});n.blur(function(e){return 0!=$(this).text().length&&$(this).closest("li").data("node")||($(this).closest("li").remove(),h()),d(e),!1}).keydown(function(e){if(function(e,t){var l;if($(t).attr("contenteditable"))return"13"==(l=e.keyCode||e.which)||9==l?(e.preventDefault(),i.addNewNodeUI($(t),a,s,o),h(),!0):27==l&&(e.preventDefault(),n.closest("li").remove(),h(),d(e),!0)}(e,this))return!1}).keyup(function(e){return!1})},this.addNewNodeInsideOrBesideCurrentNode=function(e){var t=$('<li><div><span class="crsa-scss-prop"></span></div></li>'),l=null;if(0==e.length)r.append(t);else{for(var n=null,a=e;e.hasClass("crsa-cm-placeholder")||e.hasClass("placeholder")||e.hasClass("placeholder-node");)e=e.next();if(0<e.length){if(!(l=i.getNodeFrom(e)))return;"import"!=l.type&&l.nodes&&(n=l.nodes.length)}else((e=a).hasClass("crsa-cm-placeholder")||e.hasClass("placeholder")||e.hasClass("placeholder-node"))&&(n=0);0==n?(0==(a=e.find("> ul")).length&&(a=$('<ul class="nested"></ul>').appendTo(e)),t.appendTo(a),l=null):t.insertAfter(e)}n=t.find("span");this.addNewNode(n,l)},function(e,t){if($(t).attr("contenteditable")){var l=e.keyCode||e.which;if("13"!=l&&9!=l)return 27==l?(e.preventDefault(),t.innerHTML=$(t).data("old-text"),f(t),!0):86==l&&(e.ctrlKey||e.metaKey)&&i.pasteTriggeredForNewField?(i.pasteTriggeredForNewField($(t)),!0):void 0;e.preventDefault();l=$(t).data("prop-name");if("value"==l&&i.pgStylesheet.isVarValue($(t).html())&&"css"==i.pgStylesheet.fileType)return pinegrow.showQuickMessage("You can't use variables on css file"),!1;$(t).trigger("blur");l=$(t).closest("li");return!l.data("add-new-node")&&"true"!=l.attr("data-removed")||(u.addNewNodeInsideOrBesideCurrentNode($(t).closest("li")),l.data("add-new-node",!1)),!0}}),m=function(e){i.nodeEditDone(e),f(e)},w=(this.editField=function(e,t){var l;t=t||e.closest("li"),i.options&&i.options["read-only"]?(l=i.getNodeFrom(t),i.selectRule(l,t)):(e.data("focus-added")||t.data("placeholder-item")||e.data("focus-added",!0),e.data("focused")||(e.data("focused",!0),r.data("properties-in-edit-mode",!0),function(e){var t=$(e);if(i.pgStylesheet&&!i.pgStylesheet.canEdit(!1,!0))return(l=t.data("simpleAutocomplete"))&&l.destroy(),!1;t.attr("contenteditable","true"),e.innerHTML=t.text().replace(/â–¼/g,""),t.data("old-text",t.text()),crsaSelectText(e),t.focus(),t.data("focused",!0);var l=t.closest("li"),t=i.getNodeFrom(l);return t&&(t=pgcssh.getValuesFromNode(t),l.data("node-last-value",t)),!0}(e[0]))||(e.data("focused",!1),r.data("properties-in-edit-mode",!1)))},function(e,t){return!u.isAllowed||!!u.isAllowed(e,t)}),k=null,v=null,b=(this.onNodeRemoved=function(){h()},this.addTriggers=function(e){e.off("click","span",l).on("click","span",l).off("focus","span",l).on("focus","span",l).off("blur","span",n).on("blur","span",n).off("keydown","span",a).on("keydown","span",a).off("keyup","span",s).on("keyup","span",s).off("paste","span",o).on("paste","span",o).off("click",".add-new-node",d).on("click",".add-new-node",d).off("dblclick","li",t).on("dblclick","li",t)},function(e,t,l){var n=$("<li><div><span></span></div></li>"),a=null;if(0==e.length)r.append(n);else{for(var s=null,o=!1,d=e;e.hasClass("crsa-cm-placeholder")||e.hasClass("placeholder")||e.hasClass("placeholder-node");)e=e.next();if(0<e.length){if(!(a=i.getNodeFrom(e)))return;"import"!=a.type&&a.nodes&&(s=i.getLengthWithoutPlaceholders(a))}else((e=d).hasClass("crsa-cm-placeholder")||e.hasClass("placeholder")||e.hasClass("placeholder-node"))&&(o=!0,s=0);t?0!=s||o?n.insertAfter(e):(i.uncollapseLi(e),0==(d=e.find("> ul")).length&&(d=$('<ul class="nested"></ul>').appendTo(e)),n.appendTo(d)):n.insertBefore(e)}s=n.find("span");u.addNewNode(s,a,l,t)});this.remove=function(){c(),i=null,r.off("click","span",l).off("focus","span",l).off("blur","span",n).off("keydown","span",a).off("keyup","span",s).off("paste","span",o).off("click",".add-new-node",d).off("dblclick","li",t),u=null},this.supportInsertBorders=function(){c(),this.pgInsertBorders=new PgInsertBorders(r),this.pgInsertBorders.onLiClicked=b,this.pgInsertBorders.isAllowed=i.isAllowedToAddNewNodeAt},this.onListUpdated=function(e){h(e)};p.appendTo(r),i.pgStylesheet&&i.pgStylesheet.getError()&&p.hide()};