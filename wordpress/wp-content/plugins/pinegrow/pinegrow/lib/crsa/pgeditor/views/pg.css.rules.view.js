var PgCSSRulesView=function(l){var e=$('<div class="crsa-rules aacrsa-panel crsa-stylesheets"></div>'),n=$('<div class="crsa-stylesheets-head"><h3></h3></div>').appendTo(e),i=n.find("h3"),H=$("<div/>",{class:"rule-list-container"}).appendTo(e),t=new PgButtonToolbar,n=(t.addSection("setting"),t.addSection("actions"),t.$element.appendTo(n),l.viewInfo||(l.viewInfo={source:!1,top:0,source_pos:{line:0,char:0}}),new PgButtonToolbarItem("icon-check","Show only rules that are active for the current element.")),n=(t.addItem("setting",n),n.onClick=function(){var e=!this.getActive();this.setActive(e),r.setOnlyActive(e,!0)},new PgButtonToolbarItem("icon-see","Show only rules that are visible for the current page view size.")),c=(t.addItem("setting",n),n.onClick=function(){var e=!this.getActive();this.setActive(e),V(e)},null),s=new PgButtonToolbarItem("icon-KODA","Edit stylesheet source."),M=(t.addItem("actions",s),s.onClick=function(){pinegrow.stylesheets.editCode(l)},$("<div/>",{class:"cm-source"}).hide().appendTo(e)),O=$('<div style="display:none;" class="alert alert-info alert-panel-notice">Please exit the code mode to synchronize changes.</div>').appendTo(e),o=new PgUIView(e),a=(o.pgStylesheet=l,this.quitCodeMode=function(){s.getActive()&&(M.hide(),O.show())},null),r=(this.view=o,this),d=function(e,n){null!=d&&(v=(g=n)?n.$iframe:null,v&&v.get(0),o.whenVisible(function(){r.refresh()}))},u=($("body").on("crsa-page-selected",d),o.onDestroy=function(){L(),b&&(b.remove(),b=null),y[0].innerHTML="",o.pgStylesheet=null,pinegrow.removeEventHandler("on_before_save",B),pinegrow.removeEventHandler("on_css_source_changed",k),pinegrow.removeEventHandler("on_panel_moved_in_another_window",W),$("body").off("crsa-page-selected",d).off("crsa-element-selected",U).off("crsa-window-changed",R).off("crsa-stylesheets-changed",A).off("crsa-stylesheets-properties-changed",I),K.off("change",D),j.off("change",V),I=A=R=U=k=d=null},o.onResize=function(){_()},$dest=H,this.filter_set_in_props_mode=!1,this.only_active_user_choice=!1,null),n=$("body"),h=$("<div/>",{class:"crsa-cm-main clearfix"}).appendTo($dest),t=$("<div/>",{class:"crsa-cm-rules"}).appendTo(h),f=null,p=null,v=null,g=null,m=!1,w=!1,y=($('<div class="crsa-css-var-header"></div').appendTo(t),$('<div class="cm-filter-container"></div>').appendTo(t),$("<ul/>",{class:"crsa-cm-list"}).appendTo(t)),b=(y.on("scroll",function(e){l.viewInfo.top=y.scrollTop()}),new CrsaSelectBox(y,{itemClass:"crsa-node",overParentClassName:"crsa-stylesheet",selectorToFindChild:"> .rule-list > ul > li.crsa-node",isAllowed:function(e){return!e.hasClass("cm-sslist-addrule")&&!e.is("i")},isDraggableElm:function(e){return!!e.is(".crsa-cm-move")}})),T=(this.refresh=function(){T(),E(),F(),N(),_()},this.setReferenceElement=function(e,n){u=e,n||N(),p&&(u?p.show():p.hide())},this.setShowOnlyClasses=function(e,n){n||this.refresh()},this.setSelectedPage=function(e,n){(v=e)&&v.get(0),n||this.refresh()},this.resizeRulesList=function(){_()},function(){var e=g;e&&x.find("span").html("Visible at "+e.deviceWidth+"px")}),_=function(){l.ignore||l.loaded||c&&c.updateShownNodes()},z=function(){$(".crsa-cm-props").html(""),r.showListPanel(!1)},S=null,C=null,q=function(e){e&&(l.setSource(e.getDoc().getValue()),pinegrow.dispatchEvent("on_css_source_changed",null,{list:[l]})),C=null},P=function(){C&&(clearTimeout(C),q())},B=(this.showSource=function(e){var n=(S=showCodeEditorUnder(e,getCodeMirrorMode(l.fileType),"edit-code",function(e){e||(C&&clearTimeout(C),C=setTimeout(function(){q(n)},500))},function(){},function(){})).mirror;n.getDoc().setValue(l.filterSource(l.getSource(),!0)),n.getDoc().clearHistory()},function(){P()}),L=(pinegrow.addEventHandler("on_before_save",B),this.closeSource=function(){P(),pinegrow.selectedElements.reselect(),S=null},function(){P(),a&&(a.remove(),a=null),c&&(c.remove(),c=null),y.empty()}),E=(this.onRulesShow=function(){c&&(c.updateShownNodes(),y.scrollTop(l.viewInfo.top)),S&&(S.mirror.refresh(),S.mirror.focus())},function(){var e=new CrsaProfile(!0),n=l.viewInfo.top;e.show("clean");!function(e){if(e.ignore)return;L();var n,t,s=$("<div/>",{class:"crsa-stylesheet"}).appendTo(y).data("cs",e),o=($("<div/>",{class:"rule-list"}).appendTo(s),i.empty().text(e.name),e.fileType),o=("css"!=o&&(n=$('<span class="cs-type">'+o+"</span>"),addTooltip(n,"This stylesheet uses "+o.toUpperCase()+" parser."),i.append(n)),e.getError());o&&(80<(n=o.extract?o.extract.join("\n"):"").length&&(n=n.substr(0,80)),t="",o='<div class="cm-error">'+(t=(t+=o.line?"Line: "+o.line+", ":"")+(o.file?"File: "+o.file+", ":"")+o)+"<pre>"+n+"</pre></div>",$('<div class="alert alert-info">Stylesheet has one or more '+e.fileType.toUpperCase()+' syntax errors (use <b><i class="icon icon-KODA"></i></b> to fix it): '+o+"</div>").appendTo(s.find(">div"))),(c=new PgStylesPane(e,s,s.parent(),null,{"created-by":"css",uncollapse:!!f})).filter=f,c.show(),l.stylePane=c,a=new PgCSSRuleControls(s,c,{$scrollParent:h.parent(),by:"css"})}(l),e.show("paint css 1"),f?y.find("a.crsa-cm-move").hide():y.find("a.crsa-cm-move").show(),y.trigger("scroll"),y.scrollTop(n)}),F=function(){$.fn.crsacss("showVariables")},R=(_(),function(e,n){null!=R&&n==getCrsaPageForIframe(v)&&(T(),w)&&N()}),A=function(e,n){var t;null==A||(t=n&&n.cs?n.cs:null)&&l.getUniqueName()!=t.getUniqueName()||o.whenVisible(function(){r.refresh()})},I=function(){null!=I&&z()},e=($("body").on("crsa-window-changed",R),$("body").on("crsa-stylesheets-changed",A),$("body").on("crsa-stylesheets-properties-changed",I),$('<label class="css-opt-label"><input class="control-label" type="checkbox" value="1">&nbsp;<span>Active</span></label>')),x=$('<label class="css-opt-label"><input class="control-label" type="checkbox" value="1">&nbsp;<span>Visible</span></label>'),D=function(e){null!=D&&(m=$(e.delegateTarget).is(":checked"),r.only_active_user_choice=m,N())},K=e.find("> input"),V=(K.on("change",D),addTooltip(e,"Show only active rules for the selected element.",{placement:"top"}),this.setOnlyActive=function(e,n){m=e,(n=void 0===n?!0:n)&&(N(),c.updateShownNodes())},function(e){null!=V&&(w=e,N())}),j=x.find("> input"),N=(j.on("change",V),addTooltip(x,"Show only rules that match the current window size.",{placement:"top"}),this.setFilter=function(e,n){void 0===n&&(n=!0),f=e,$input.val(e),n&&(E(),N())},this.editRule=function(e){$.fn.crsa("selectRule",e)},this.showListPanel=function(e){e?h.animate({left:0},150,function(){h.find("button.back").hide(),h.css("width",300)}):h.css("left",0)},this.reloadStylesheet=function(e,n){function t(){n&&n(),crsaQuickMessage(e.name+" reloaded."),$("body").trigger("crsa-stylesheets-changed")}e.changed?showAlert(e.name+" has unsaved changes. Do you want to reload the stylesheet and loose these changes?","Unsaved changes","Cancel","Reload",null,function(){e.reload(t)}):e.reload(t)},function(){var e=new CrsaProfile(!1),n=!1;u&&(n=(t=getElementPgNode(u))&&t.script_info),!u||n?(y.find(".crsa-cm-apply").hide(),y.find("div.crsa-cm-has-rule").removeClass("crsa-cm-has-rule")):y.find(".crsa-cm-apply").show(),e.show("    - 1");if(w&&y.find(".crsa-atrule").removeClass("hide-rule"),e.show("    - 2"),u){var t=u.get(0);if(t.ownerDocument.defaultView&&t.ownerDocument.defaultView.getMatchedCSSRules){var s=t.ownerDocument.defaultView.getMatchedCSSRules(t,"");if(s)for(var o=s.length;o--;)normalizeSelector(s[o].selectorText),!0}}y.find(".crsa-stylesheet").each(function(e,n){c&&m?(c.showAllRules(),c.showOnlySelectedRules()):c.showAllRules()}),e.show("    - 3")}),Q=(this.show=function(e){f=e,E(),N()},this.st=function(e){y.scrollTop(e)},null),W=function(){r.show(f)},k=function(e,n){if(null!=k&&(!n||"css"!=n.by)&&n&&n.list){for(var t=n.list,s=!1,o=0;o<t.length;o++)t[o].getUniqueName()==l.getUniqueName()&&(s=!0);!s&&Q==l.getError()||(Q=l.getError(),E(),N())}},U=function(e,n){var t;null!=U&&(n?(t=n.get$DOMElement(),r.setReferenceElement(t)):r.setReferenceElement(null))};this.search=function(e){f=e,E()},this.researchIfNeeded=function(e){e!=f&&this.search(e)};pinegrow.addEventHandler("on_css_source_changed",k),pinegrow.addEventHandler("on_panel_moved_in_another_window",W),n.on("crsa-element-selected",U)};