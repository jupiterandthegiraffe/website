window.PgAllStylesheets=function(){function R(e,t){return t.emulateCSSFeatures(e)}var c={},l=[],P=this,n=1,u=(0||require("postcss"),this.getByUrl=function(e,t){var n=this.findCrsaStylesheetForUrl(e,null,t);return n.length?n[0]:null},this.findCrsaStylesheetForUrl=function(l,i,o){pinegrow.httpServer&&(l=pinegrow.httpServer.getOriginalUrl(l));function u(e){var t;return e&&(1<(t=e.split(".")).length&&t.pop(),t.join("."))}function h(e){t.indexOf(e)<0&&t.push(e)}(i=!1)&&(l=u(l));function a(e){for(var t=0;t<e.length;t++){var n,s,r=e[t];r.url&&(n=i?u(r.url):r.url,s=r.sourceStylesheet,o?n===l?h(r):s&&s.url===l&&h(s):(n===l||s&&s.url===l)&&h(r=s?s:r),(r=s?s:r).importedFiles)&&r.importedFiles.length&&a(r.importedFiles)}}var t=[];return a(Object.values(c)),t},this.findCrsaInlineStylesheet=function(e){for(var t=0;t<l.length;t++)if(l[t].inline&&e==l[t].inlineSheetPgel)return l[t];return null},this.findCrsaInlineStylesheetUsingSelector=function(e){var t="",n=e.match(/\.pg-file-(.*)/);if(t=n&&1<n.length?n[1]:t)for(var s=0;s<l.length;s++)if(t==l[s].getUniqueName())return l[s];return null},this.findCrsaStylesheetForUniqueName=function(t){function s(e){return e.getUniqueName()==t}function r(e){for(var t=0;t<e.length;t++){var n=e[t];if(s(n))return n;if(n.sourceStylesheet&&(n=n.sourceStylesheet,s(n)))return n;if(n.importedFiles&&n.importedFiles.length&&(n=r(n.importedFiles)))return n}return null}return r(Object.values(c))||r(l)},this.getCrsaStylesheetByUniqueName=function(e){for(var t=0;t<l.length;t++){var n=l[t];if((n=n.sourceStylesheet?n.sourceStylesheet:n).getUniqueName()==e)return n}return null},this.editCode=function(e){return isApp()?e.localFile?pinegrow.openFileInCodeEditor(e.localFile,e.url):void pinegrow.showQuickError("Remote and inline stylesheets can't be edited in the code editor."):pinegrow.openFileInCodeEditor(e.url,e.url)},this.getStylesheetForHTMLElement=function(e){if("LINK"==e.tagName){if(e.sheet&&e.sheet.href)return this.getByUrl(e.sheet.href)}else if("STYLE"==e.tagName){var t=e.getAttribute("data-pg-style-url");if(t)return this.getByUrl(t);t=getElementPgNode($(e),!0);if(t)return this.findCrsaInlineStylesheet(t)}return null},this.getAllSheeetsForPage=function(e){for(var t=e.$iframe.get(0).contentDocument||e.$iframe.get(0).contentWindow.document,n=t.styleSheets.length,s=t.styleSheets,r=[],l=0;l<n;l++){var i=s[l];null!=i.cssRules&&((i=this.findCrsaStylesheetForUrl(i.href))&&0<i.length)&&r.push(i[0])}return r},this.recomplileAllSheetsInPage=function(e,t){function n(){0==--i&&t&&t()}for(var s=e.$iframe.get(0).contentDocument||e.$iframe.get(0).contentWindow.document,r=s.styleSheets.length,l=s.styleSheets,i=0,o=0;o<r;o++){var u=l[o];if(null!=u.cssRules)for(var h=this.findCrsaStylesheetForUrl(u.href),a=0;a<h.length;a++){var c=h[a];c&&!c.ignore&&(i++,c.regenerateAndSetCssSource(n))}}},this.isStylesheetUsed=function(e){if(e.usedByDesignPanel)return!0;for(var t=pinegrow.getAllPages(),n=0;n<t.length;n++){var s=t[n];if(this.getStylesheetInfo(e,s))return!0}return!1},this.stylsheetUsed=function(t,e,n){var s=null,r=null;"source"==e?r=n:"child"==e&&(s=n),pinegrow.getAllPages().forEach(function(e){e.stylesheets&&e.stylesheets.isStylesheetUsed(n,t.pgStylesheet)&&e.stylesheets.addStylesheetAs(t,s,r)})},this.updateUsedStylesheet=function(t,n,s){pinegrow.getAllPages().forEach(function(e){e.stylesheets.isStylesheetUsed(s)&&e.stylesheets.updateStylesheetUrl(t,n,s)})},this.removeUsedStylesheet=function(e,t){t&&t.stylesheets.removeStylesheetByKey(e)},this.getStylesheetInfo=function(e,t){return t&&t.stylesheets?t.stylesheets.getStylesheetInfo(e):null},this.addStylesheetByKey=function(e,t){e&&(c[e]=t)},this.getStylesheetByKey=function(e){return c[e]},this.updateStylesheetByKey=function(e,t,n){c[e]&&(c[e]!==n&&console.warn("Unexpected: same url with different stylesheet"),c[t]=n,delete c[e])},this.removeStylesheetByKey=function(e){c[e]&&(this.removeCrsaStylesheet(c[e]),delete c[e])},this.getLastIndex=function(e){var t=n;return e&&n++,t+""},this.addCrsaStylesheet=function(e){l.indexOf(e)<0&&(e.index||(e.index=this.getLastIndex(!0)),l.indexOf(e)<0)&&l.push(e)},this.removeCrsaStylesheet=function(e){var t=l.indexOf(e);-1<t&&(l.splice(t,1),e.remove())},this.isPageHasStylesheet=function(e,t){return!!e.stylesheets&&e.stylesheets.has(t)},this.removeAllUnusedStylesheets=function(){l.filter(function(e){return 0===pinegrow.stylesheets.getPagesForStylesheet(e).length}).forEach(function(e){e.remove()})},this.getAll=function(e){return pgcssh.filterStylesheetsList(l,e)},this.getAllAsSelectOptions=function(e,n){return(e=e||{}).inline=!1,e.ignored=!1,e.loaded=!0,this.getAll(e).map(function(e){var t=crsaGetNameFromUrl(e.url);return{name:t,key:e.url,html:t+n?"":" <small>"+e.url+"</small>"}})},this.getAllCrsaStylesheets=function(e){return l},this.crsaStylesheetsLength=function(){return l.length},this.getCrsaStylesheetById=function(e){return l[e]},this.getAllSheetsForPages=function(i){var o=[];return $.each(pinegrow.getAllPages(),function(e,t){try{for(var n=t.$iframe.get(0).contentDocument||t.$iframe.get(0).contentWindow.document,e=0;e<n.styleSheets.length;e++){var s,r,l=n.styleSheets[e];i.inline?(s=i.inlineSheetPgel.get$DOMElement())&&s[0]==l.ownerNode&&o.push(l):P.isStylesheetUrlEqual(i.url,l.href)?o.push(l):isApp()||(r=l.ownerNode.getAttribute("data-pg-style-url"))&&P.isStylesheetUrlEqual(i.url,r)&&o.push(l)}}catch(e){}}),o},this.getPagesForStylesheet=function(l){var i=[];return $.each(pinegrow.getAllPages(),function(e,t){for(var n=pinegrow.stylesheets.getStylesheetInfo(l,t),s=(n&&n.compiledStylesheet&&(l=n.compiledStylesheet),t.$iframe.get(0).contentDocument||t.$iframe.get(0).contentWindow.document),e=0;e<s.styleSheets.length;e++){var r=s.styleSheets[e];P.isStylesheetUrlEqual(l.url,r.href)?i.push(t):isApp()||(r=r.ownerNode.getAttribute("data-pg-style-url"))&&P.isStylesheetUrlEqual(l.url,r)&&i.push(t)}}),i},this.isStylesheetUrlEqual=function(e,t){return!(!e||!t)&&(pinegrow.httpServer&&(e=pinegrow.httpServer.getOriginalUrl(e),t=pinegrow.httpServer.getOriginalUrl(t)),pgDecodeUrl(e)===pgDecodeUrl(t))},this.findCssRules=function(e,s){"rule"==s.type?sel=normalizeSelector(s.selector):"atrule"==s.type&&(sel=s.params);function r(e,n){e&&$.each(e,function(e,t){"rule"==s.type&&4==t.type?s.parent.params==t.media[0]&&r(t.cssRules,n):"atrule"==s.type&&4==t.type?s.params==t.media[0]&&l.push(t):pgStylesheetHelper.getNormalizedSelectorForStylesheetRule(t)==n&&l.push(t)})}var l=[];return r(e,sel),l},this.updateNodeInStylesheet=function(r,l){var i=pgStylesheetHelper.getStylesheetFromNode(r);$.each(pinegrow.getAllPages(),function(e,t){for(var n=t.$iframe.get(0).contentDocument||t.$iframe.get(0).contentWindow.document,e=0;e<n.styleSheets.length;e++){var s=n.styleSheets[e];P.isStylesheetUrlEqual(i.url,s.href)&&((s=s.cssRules)&&1==s.length&&s[0].media&&(s=s[0].cssRules||[]),1==(s=P.findCssRules(s,r)).length)&&(s[0].style.cssText=l.replace("\n",""),console.log("single rule changed"))}})},this.getIncludedPgStylesheetParent=function(e,t){for(var n=e,s=[];null!=n;){s.unshift(n);var r=pinegrow.stylesheets.getStylesheetInfo(n,t),n=r?r.parentPgStylesheet:null}return s},this.searchForSheet=function(e,t){var n=pinegrow.stylesheets.findCrsaStylesheetForUrl(e.href);if(!(n.length<1)){for(var s=!1;!s;){for(var r=e.cssRules,l=!1,i=0;i<r.length;i++)if(3==r[i].type&&n[0].getFullUrlFor(r[i].href)==t[0].url){e=r[i].styleSheet,l=!0,t.splice(0,1),0==t.length&&(s=!0);break}if(!s&&!l)break}return s?e:null}},this.canInsertRule=function(e){return"import"!=e.name&&"comment"!=e.type},function(e){for(var t=e.split(","),n=t.length,s=["active","hover","focus","visited"],r=0;r<n;r++){var l=t[r];if(-1<l.indexOf(".pg-state-"))t.splice(r,1),n--;else{for(var i=l,o=0;o<s.length;o++){var u=s[o],h=new RegExp(":"+u,"g"),a=i.match(h);a&&0<a.length&&(i=i.replace(h,".pg-state-"+u).trim())}i!=l&&(t.splice(r+1,0,i),n++,r++)}}return t.join(",")}),h=function(e){return pgcssh.shouldAddPlaceholder(e)},a=function(e,t){return pgcssh.addEmptyPlaceholderForEmptyRule(e,t)},A=function(e,t,n){var s,r;if(void 0===n&&(n=!0),"rule"==t.type)return s=h(t),r=e.getSourceForRules(t,n),r=pgAddProxyLinksToStyleAttribute(r),a(r,s);if("atrule"!=t.type||"media"!=t.name&&"supports"!=t.name)return e.getSourceForRules(t,n);var l=t.nodes,i="";if(l)for(var o=0;o<l.length;o++)i+=A(e,l[o],n);return"@"+t.name+" "+t.params+" {"+i+" }"},g=(this.doWithStylesheet=function(u,h){$.each(pinegrow.getAllPageViews(),function(e,t){var n=t.getDocument();if(null!=n){n.styleSheets.length;var s=n.styleSheets;t.ssMap||(t.ssMap=new WeakMap);for(var r=0;r<s.length;r++){i=s[r];try{if(null==i.cssRules)continue}catch(e){continue}var l=t.getPage();if(u.isImportedFor(l)){var i,l=P.getIncludedPgStylesheetParent(u,l);if(!P.isStylesheetUrlEqual(l[0].url,i.href))continue;if(l.splice(0,1),1<l.length&&!u.canHasImportMoreThanOneLevel())break;if(null==(i=P.searchForSheet(i,l)))break}else if(!P.isStylesheetUrlEqual(u.url,i.href))continue;var l=!1,o=t.ssMap.get(i);o||(t.ssMap.set(i,o=[]),l=!0),h(i,t,o,l)}}})},this.applyToPagesSingle=function(e,t){var l=A(e,t),i=".pg-node-id-"+t["pg-node-id"],s=[],o=function(e,t,n,s){if(e)for(var r=0;r<e.length;r++){if(e[r].selectorText&&0<=e[r].selectorText.indexOf(i))return l=R(l,s),t.deleteRule(r),t.insertRule(l,r),n&&(n[r]=l),!0;if(e[r].cssRules&&o(e[r].cssRules,e[r],null,s))return!0}},r=!1;!isApp()&&e.loaded_from_project_content?g(e,function(e,t){e&&(o(e.sheet.cssRules,e.sheet,null,t),s.push(e.sheet))}):this.doWithStylesheet(e,function(e,t,n){e._pg_applied_to_page_with_ids?(o(e.cssRules,e,n,t),s.push(e)):r=!0}),r?this.applyToPages(e,function(){},null):pinegrow.dispatchEvent("on_css_applied_to_pages",null,e,s,!1)},this.applyToPagesQuick=function(e,l){var t,i,o;e.inline?(t=e.getSourceForRules(null,!0),t=pgAddProxyLinksToStyleAttribute(t),e.inlineSheetPgel.get$DOMElements().forEach(function(e){e.get(0).innerHTML=t})):(i=!1,o=[],this.doWithStylesheet(e,function(e,t,n,s){var r;for(l="@supports(display:block) {"+(l=r=(r=l.toString())&&r.replace(/([^\}])([\.\#\:\>\-\_\(\)a-z0-9\s\t\,]*)(\{)/gi,function(e,t,n,s){return"@"===n[0]?e:t+u(n.trim())+s}))+"}";e.cssRules.length;)e.deleteRule(0);try{e.insertRule(l,0)}catch(e){}i=i||s,o.push(e)}),pinegrow.dispatchEvent("on_css_applied_to_pages",null,e,o,i))},function(e,s){var t=e.getMainParnetStylesheets();0===t.length&&t.push(e),t.forEach(function(n){pinegrow.getAllPageViews().forEach(function(e){var t=e.getDocument();null!=t&&n.url&&(t=t.querySelector(`[data-pg-style-url="${n.url}"]`),s(t,e))})})});this.applyToPages=function(d,e,p){var y,s,S=d.ignore_imports_in_apply||!1,m=d.getAllRules(),v=[],_=!1,w=!1;!isApp()&&d.loaded_from_project_content?(s=d.getSourceForRules(null,!0,!0),d.getCssSource(function(e){s=e||""},!0,!0,function(e,t){return pgAddProxyLinksToStyleAttribute(e,t.url)}),g(d,function(e,t){var n=R(s,t);e&&(v.push(e.sheet),e.sheet._pg_get_sheet=function(){var e=t.getDocument();return null!==e&&(e=e.querySelector(`[data-pg-style-url="${d.url}"]`))?e.sheet:null},e.innerHTML=n)}),pinegrow.dispatchEvent("on_css_applied_to_pages",null,d,v,_),e&&e()):(y=!1,d.inline?(s=d.getSourceForRules(null,!0),s=pgAddProxyLinksToStyleAttribute(s),d.inlineSheetPgel.get$DOMElements().forEach(function(e){var t=getPageViewOfElement(e),n=s,t=(t&&(n=R(s,t)),e.get(0));t.innerHTML=n,v.push(t.sheet)}),pinegrow.dispatchEvent("on_css_applied_to_pages",null,d,v,_),e&&e()):(isApp()?pinegrow.devTools.withDisabledCSS:function(e,t){e(),t&&t()})(function(){P.doWithStylesheet(d,function(e,t,n,s){if((!p||t.getPage()===p)&&(!d.ignore||d.changed)){var r=!0,l=(d.ignore&&(r=!1),e._pg_applied_to_page_with_ids=!0,v.push(e),w&&console.log(`Applying styling of ${d.url} to pv `+t.deviceWidth),new CrsaProfile),i=0,o=0;if(_=_||s,0&&w)for(var u=0;u<e.cssRules.length;u++)console.log(u,e.cssRules[u]);if(1){for(var h="",a=0;a<m.length;a++)if("atrule"===m[a].type&&"import"===m[a].name){if(!S){h="@import";break}}else"comment"!==m[a].type&&(g=A(d,m[a],r),h+=R(g,t));if(!(isApp()&&h.indexOf("@import")<0&&pinegrow.devTools.setStylesheetContent(d.url,h,t))){for(a=0;a<m.length;a++){var c,g=A(d,m[a],r);if(g=R(g,t),P.canInsertRule(m[a])){for(;e.cssRules.length>i&&3==e.cssRules[i].type;)i++;0&&w&&console.log(i,g);try{e.cssRules.length>i?(e.cssRules[i],(c=y?n[i]:null)&&c==g?i++:(0&&w&&console.log("Chnaged rule "+g),P.canInsertRule(m[a])&&(e.cssRules[e.insertRule(g,i)],e.removeRule(i+1),y&&(n[i]=g),o++,i++))):(i=e.insertRule(g,e.cssRules.length),e.cssRules[i],y&&(n[i]=g),i++,o++)}catch(e){}}}for(;i<e.cssRules.length;)3!==e.cssRules[i].type?(n.splice(i,1),e.deleteRule(i)):i++,o++;if(0){console.log("sheet.cssRules.length",e.cssRules.length);for(u=0;u<e.cssRules.length&&(console.log(e.cssRules[u]),0!==u);u++);}l.show("CSS APPLY - SMART - Changed "+o)}}else{for(var f="",a=0;a<m.length;a++)f+=A(d,m[a],r);for(f="@supports(display:block) {"+f+"}";e.cssRules.length;)e.deleteRule(0);try{e.insertRule(f,0)}catch(e){console.log(e)}}}}),pinegrow.dispatchEvent("on_css_applied_to_pages",null,d,v,_)},e))},this.findImportedRuleFor=function(e,t){for(var n=e.cssRules,s=0;s<n.length;s++)if(n[s].href==t.relativeUrl)return n[s]},this.findImportedAttachmentFor=function(e,t){return this.findImportedRuleFor(e,t).styleSheet},this.findAttachmentFor=function(e,t){var n=t.$iframe.get(0);if(e.inline)return e.getInlineSheet(n);var s,r=e.isImportedFor(t),l=e;(s=pinegrow.stylesheets.getStylesheetInfo(l,t))&&s.parentPgStylesheet&&(l=s.parentPgStylesheet),(s=pinegrow.stylesheets.getStylesheetInfo(l,t))&&s.compiledStylesheet&&(l=s.compiledStylesheet);for(var i=getIframeDocument(n),o=0;o<i.styleSheets.length;o++){var u=i.styleSheets[o];if(this.isStylesheetUrlEqual(l.url,u.href)&&!r)return u}return null},this.isEnabledForPage=function(e,t){var n=this.findAttachmentFor(e,t);return!!n&&0==n.disabled},this.setEnabledForPage=function(e,t,n){var s=this.findAttachmentFor(e,t);s&&(s.disabled=!n)}},$("body").one("pinegrow-ready",function(){function r(){e&&clearTimeout(e),e=setTimeout(function(){pinegrow.getAllPages().forEach(function(e){e.refreshPageChangedStatus()}),e=null},500)}function n(e,t){r();var n=t&&t.editor?t.editor:null;!e.url||t&&t.editor&&"external_editor"==t.editor||codeEditors.cssCodeChanged(e.url,function(){return e.filterSource(e.getSource())},n,t,e)}function l(e){codeEditors.setCode(e.url,e.source)}var e=null;pinegrow.addEventHandler("on_css_source_changed",function(e,t){t&&t.list&&t.list.forEach(function(e){n(e,t)})});pinegrow.addEventHandler("on_css_loaded_from_external",function(e,t){l(t)}),pinegrow.addEventHandler("on_css_loaded",function(e,t){function s(e){for(var t=0;t<e.length;t++){var n=e[t];l(n),0<n.importedFiles.length&&s(n.importedFiles)}}l(t),s(t.importedFiles),r()}),pinegrow.addEventHandler("on_imported_css_loaded",function(e,t){l(t),r()}),pinegrow.addEventHandler("on_css_node_added",function(e,t){n(t.stylesheet,t)}),pinegrow.addEventHandler("on_css_node_deleted",function(e,t){n(t.stylesheet,t)}),pinegrow.addEventHandler("on_css_node_updated",function(e,t){n(t.stylesheet,t)}),$("body").on("crsa-rule-changed-in-editor",function(e){r()})});