var PgCSSEditorView=function(){function e(e,n){o(n,!0)}function n(e,n){o(n)}var t=$("<div/>",{class:"pg-css-visual crsa-css-gui"}),s=this.view=new PgUIView(t,"css_visual","CSS Visual Editor"),a=new PgDelayedTasks,i=(s.tabIcon="icon-window",new PgCSSEditorNEW(t)),r=(s.onResize=function(){i.updateLayout(t.width(),t.height())},s.on("crsa-rule-selected",function(e,n){s.whenVisible(function(){n?(r(n.rule,n.options),n.rule):selectSameRule()})}),function(e,n){var t={indices:pinegrow.getSelectedRuleIndices(),pgStylesheet:pinegrow.getSelectedRuleStylesheet()};i.editRule(t,n)}),o=function(i,o){s.whenVisible(function(){var e,n,t;"gui"!=i.edited_by&&(e=i.node,n=pinegrow.getSelectedRule(),a.cancel("update"),n)&&pinegrow.pgPostCSSHelper.isNodeEqualOrChildOf(n,e)&&(t=function(){var e,n=i.node;"rule"!=n.type||o?pinegrow.isSelectedRule(n.parent)&&r(e):(e=pinegrow.pgPostCSSHelper.getRuleForNode(n),r(e))},"undo"==i.edited_by?a.run("update",function(){t()},100):t())})};pinegrow.addEventHandler("on_css_node_deleted",e),pinegrow.addEventHandler("on_css_node_updated",n),pinegrow.addEventHandler("on_css_node_added",n),s.onDestroy=function(){i.remove(),i=null,a.destroy(),pinegrow.removeEventHandler("on_css_node_deleted",e),pinegrow.removeEventHandler("on_css_node_updated",n),pinegrow.removeEventHandler("on_css_node_added",n),pinegrow.removeEventHandler("on_current_device_size_changed",onDeviceSizeChanged)}},PgCSSEditorNEW=function(r){function e(e,n,t){t===p&&isApp()&&(n.push({type:"divider"}),n.push({label:"Open CSS Tree [beta]",action:function(){new PgQuickCSSActiveTree}}))}var g,l,h,s=this,d=(r=r||$('<div class="crsa-stylesheets crsa-css-gui"></div>'),this.grid=new PgUISectionGrid),n=(d.minWidth=250,d.maxWidth=500,new PgPanelNotice),u=(n.$element.appendTo(r),new PgCSSApi),p=new PgDeviceSizesControl(!1,void 0,!0),a=(p.in_style_panel=!0,p.setStatesOptions([]),p.onDeviceSizeChanged=function(e,n){var t=pinegrow.selectedElements.getLastSelected();t&&"none"!==t.getData("selectedCssRule")&&t.setData("selectedCssRule",null)},p.onHasTabSizeClassesOrRules=function(e,n){var t,i,o=s.current_rule;return!!o&&!!(t=pgcssh.getStylesheetForNode(o))&&(t.elementStyle?n.w_range&&0===n.w_range[0]&&0<o.nodes.length:(o=o.selector,i=!1,t&&u.getRuleForMediaSize(t,o,0===n.w_range[0]?null:n.w_range[0],function(e){e&&(i=!0)}),i))},pinegrow.addEventHandler("on_device_size_selector_settings",e),r.prepend(p.$element),p.show(),$(`<div class="pg-css-editor-no-rule-overlay"><div class="alert alert-panel-notice"><p></p><button class="pg-button">Create the rule</button></div></div>`).appendTo(r)),c=a.find("p").get(0),f=a.find("button").get(0),_=null,t=(a.find("button").on("click",function(e){e.preventDefault(),_&&_()}),this.showNoRuleNotice=function(e,n,t,i){var o;switch(i=i||"no_rule"){case"no_rule":("Style attribute"!==e?(o=`The rule <span class="rule">${e}</span> for the screen size <span class="size">${n}</span> is not defined.`,pgShow):(o=`Save the <span class="rule">${e}</span> into a CSS rule to make it responsive.`,pgHide))(f),f.innerHTML="Create the rule";break;case"rule_not_visible":o=`The rule <span class="rule">${e}</span> exists, but it is not visible on the <span class="size">${n}</span> display.`,pgShow(f),f.innerHTML="Resize view to "+n}c.innerHTML=o,_=t,pg$Show(a,"flex")},this.hideNoRuleNotice=function(){pg$Hide(a)},this.hideNoRuleNotice(),$('<div class="pg-css-gui-filter"></div>').appendTo(r)),S=[{name:"Text",sections:["text"],icon:"icon-Pin18"},{name:"Margin, padding and size",sections:["margin_and_padding","dimension"],icon:"icon-Pin16"},{name:"Display and position",sections:["display_prop","position_prop"],icon:"icon-Pin17"},{name:"Background",sections:["background"],icon:"icon-Pin21"},{name:"Border and border radius",sections:["border_prop"],icon:"icon-Pin20"},{name:"Flexbox",sections:["flex","flex-child"],icon:"icon-Pin22"},{name:"Shadows",sections:["box-shadow","text-shadow"],icon:"icon-Pin23"},{name:"Transforms",sections:["transforms"],icon:"icon-Pin24"},{name:"Transitions",sections:["transitions"],icon:"icon-graph"},{name:"List",sections:["list"],icon:"icon-Pin25"},{name:"Grid",sections:["grid-container","grid-item"],icon:"icon-grid"}],v=(pgf.kids&&(S=[{name:"Text",sections:["text"],icon:"icon-Pin18"},{name:"Background",sections:["background"],icon:"icon-Pin21"},{name:"Margin, padding and dimension",sections:["margin_and_padding","dimension"],icon:"icon-Pin16"},{name:"Border",sections:["border_prop"],icon:"icon-Pin20"},{name:"Position and display",sections:["position_prop","display_prop"],icon:"icon-Pin17"},{name:"Shadows",sections:["box-shadow","text-shadow"],icon:"icon-Pin23"}],pgf.kids_with_transitions)&&(S.push({name:"Transforms",sections:["transforms"],icon:"icon-Pin24"}),S.push({name:"Transitions",sections:["transitions"],icon:"icon-graph"})),[]),w=!1,i=new PgButtonToolbar(!0),m=(i.$element.appendTo(t),i.addSection("sections"),S.forEach(function(t){var e=new PgButtonToolbarItem(t.icon,t.name,t);t.active=!1,e.setActive(t.active),i.addItem("sections",e),(t.toolbarItem=e).onClick=function(e){var n=t.sections[0];O[n].scrollTo()}}),w?i.hideSection("sections"):i.showSection("sections"),r.append(d.$element),!1),y=(this.ready=!0,{}),P=function(){return g||l},b=(this.editRule=function(e,t){t=t||{};var n=this.getScrollTop(),i=(g=e)||l,o=(null===pinegrow.selectedElements.getLastSelected()&&(i=null),this.current_rule=null,null);if(i&&i.indices&&i.pgStylesheet){if(H(),d.$element.is(":visible")||d.$element.show(),i&&i.hasOwnProperty("indices")){if(!(h=i.pgStylesheet))return;try{if(!(o=pinegrow.pgPostCSSHelper.getNodeByIndices(h.getRootNode(),i.indices)))return d.$element.hide(),void T("CSS rule is not selected.");if("rule"!==o.type)return d.$element.hide(),void T("The selected item is not a CSS rule.");var s=k(o)}catch(e){return d.$element.hide(),void T(e.message)}}else i&&"rule"===i.type?(h=pgStylesheetHelper.getStylesheetFromNode(i.data),o=i.data,s=k()):i&&(h=null,s=N());this.current_rule=o,m?(t.skip_updating_sections||z(),$.each(y,function(n,e){e.forEach(function(e){e instanceof PgCustomPropertyControl?(e.setObject(i),e.setValues(s,null,t.skip_updating_sections)):e.setValue(s[n]||null)})})):(D(i,s),m=!0);var a=!1;if(t.clicked_prop)for(var r=0;r<x.length;r++){var c=x[r];if(c.sec_def&&c.sec_def.get_has_data&&("_"+t.clicked_prop+"_").match(c.sec_def.get_has_data)){c.scrollTo(),a=!0;break}}o=u.getMediaSizeForRule(o),o=pinegrow.getSelectedPage().activeView.getDeviceSizeDefForWidth(o);p.updateOrShow(o),a||this.setScrollTop(n)}else T("CSS Rule is not selected."),$.each(y,function(e,n){n.forEach(function(e){e instanceof PgCustomPropertyControl&&e.setObject(null)})}),h=null,d.$element.hide()},null),b=r,o=[],C=$.fn.crsa.defaults.rulesDefinition,T=($.each(C.sections,function(e,n){o.push(n),n.section_key=e,n.component_definition=C,$.each(n.fields,function(e,n){"custom"==n.type&&n.control&&!n.control_defined&&(n.control().define(C),n.control_defined=!0)})}),function(e){n.show(e),t.hide()}),H=function(){n.show(),t.show()},E=(this.updateLayout=function(e,n){d.updateLayout(e,n)},{}),R=function(l,d){var u={},p=(E={},"");return $.each(C.sections,function(e,n){$.each(n.fields,function(e,n){var t,i,o,s,a,r,c=n.action||"style";n.get_value?u[e]=n.get_value(d,e,l):"style"==c&&l?(t=n.css_property||e,(t=l[t]||null)&&(i=t="object"==typeof t?t.value:t,"image"==n.type&&(i=i.replace(/url\(/g,"").replace(/\"/g,"").replace(/\'/g,"").replace(/\)/g,"")),u[e]=t)):"rule_name"==c?g&&(o=g.pgStylesheet,s=pinegrow.pgPostCSSHelper.getNodeByIndices(o.getRootNode(),g.indices),u[e]=h.filterSource(s.selector)):"rule_media"==c?g&&(o=g.pgStylesheet,s=pinegrow.pgPostCSSHelper.getNodeByIndices(o.getRootNode(),g.indices),a=pinegrow.pgPostCSSHelper.getMediaNode(s),r=pinegrow.pgPostCSSHelper.getAtRuleValue(a),u[e]=r||null):"rule_supports"==c&&g&&(o=g.pgStylesheet,s=pinegrow.pgPostCSSHelper.getNodeByIndices(o.getRootNode(),g.indices),a=pinegrow.pgPostCSSHelper.getSupportsAtruleNode(s),r=pinegrow.pgPostCSSHelper.getAtRuleValue(a),u[e]=r||null),e in u&&null!=u[e]&&""!==u[e]&&(p+="_"+e+"_")})}),$.each(l,function(e,n){p+="_"+e+"_",!(e in u)&&"value"in n&&(u[e]=n.value)}),$.each(C.sections,function(e,n){n.get_has_data&&p.match(n.get_has_data)&&(E[e]=!0)}),u},k=function(e){var n=h.getPropValuePairFor(e);return R(n,g)},N=function(){var e=l.getAttr("style"),e=styleToObject(e);return R(e,l)},x=[],z=function(){d.clear();var e=[],n=[];v=[],S.forEach(function(e){var n=!1;e.sections.forEach(function(e){E[e]&&(n=!0)}),e.toolbarItem.setActive(n)});for(var t=0;t<x.length;t++){var i=x[t],o=i.sec_def.section_key;w?(!i.sec_def.get_has_data||E[o]?(d.addSection(i),e):n).push(i):(!v||0==v.length||0<=v.indexOf(o)||!i.sec_def.get_has_data)&&(d.addSection(i),v.length)&&e.push(i),E[o]?i.setHasData(!0):i.setHasData(!1)}n.forEach(function(e){d.addSection(e)}),d.updateLayout(),e.forEach(function(e){e.forceOpen()}),n.forEach(function(e){})},O={},D=function(s,a){$.each(o,function(e,n){var t=n.section_key;if(n.hasOwnProperty("show")&&!n.show||!n.name)return!0;pgf.kids&&(n.is_closable=!1);var i=new PgUISection(n.name,n.framework?n.framework.name:null,n),o=(x.push(i),O[t]=i,"aaaname"==t&&r.prepend(i.$element.addClass("pg-rule-name")),i.$content);$.each(n.fields,function(e,n){var t,i;y[e]||(y[e]=[]),"custom"==n.type?n.control?((t=n.control()).setObject(s),t.setValues(a),t.show(b),o.append(t.$element),y[e].push(t),t=t.$element):(t=n.show(o,s,e,n,a,b),console.log("fdef.show is not supported anymore. "+e)):(i=new PgPropertyField(o,P,e,n,a,b),y[e].push(i),t=i.$field),n.validate&&pinegrow.validateField(s,e,a.hasOwnProperty(e)?a[e]:null,n,t,a),n.show_if&&(i="function"==typeof n.show_if?n.show_if(a):crsaEvaluateShowIfString(n.show_if,a,n,s),t.is(":visible")!==i)&&(i?t.show():t.hide())})}),z()};this.getScrollTop=function(){return d.$element.scrollTop()},this.setScrollTop=function(e){d.$element.scrollTop(e)},this.remove=function(){O=x=g=null,pgRemoveSpectrum(r),pgRemoveFilePicker(r),pinegrow.removeEventHandler("on_device_size_selector_settings",e)}};