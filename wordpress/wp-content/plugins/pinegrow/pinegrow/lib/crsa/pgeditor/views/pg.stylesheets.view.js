var PgQuickStylesheets=function(e,t){var s=new PgStylesheetsView,n=(s.parentView=t,new PgQuickWindow("Page Stylesheets",s,"quickStylesheets",400,500)),o=e.get(0).getBoundingClientRect();n.showAtPosition(o.left,o.top,400),s.show(),s.onStylesheetSelected=function(){n.wasMoved||n.wasResized||n.destroy()},n.onDestroy=function(){}},PgStylesheetsView=function(){function e(e){e==v&&w.whenVisible(function(){S()})}function t(e){w.whenVisible(function(){e.updateStylesheetsList()})}var s=$('<div class="aacrsa-panel crsa-stylesheets"></div>'),w=new PgUIView(s),y=(this.view=w,this.parentView=null,this),v=null,o=null,n=$("<button/>",{class:"pg-button",href:"#"}).html("Add &amp; Manage"),l=(isApp()&&n.appendTo(s),addTooltip(n,"Create and manage stylesheets."),$("<button/>",{class:"pg-button",href:"#",style:"margin-left:10px;"}).html("Refresh").appendTo(s).on("click",function(e){e.preventDefault();var t=pinegrow.getSelectedPage();t&&t.updateStylesheetsList(),pinegrow.showQuickMessage("Refreshing the stylesheet list...")})),r=(addTooltip(l,"Refresh the list of all stylesheets that are used on the selected page."),$("<ul/>",{class:"cm-sslist"}).appendTo(s)),S=function(){var e,s,p,f,a,i;r.find("li").data("crsa-cs",null),v=pinegrow.getSelectedPage(),r.html(""),v?(o=v.$iframe,o.get(0),(e=getCrsaPageStylesForPage(o))&&(e=e.getAllCrsaStylesheets(),s=pinegrow.getCurrentProject(),p=function(e){var t=e.url,t=crsaMakeLinkRelativeTo(t,s?s.getUrl():v.url);return crsaRemoveUrlParameters(t)},f=pinegrow.getDefaultStylesheet(null,function(){},!1,!0),a=function(t,e,s,n){function r(e,t){var s=e.replace(/\.css$/i,"."+t);return crsaCopyFileSync(require("fs"),crsaMakeFileFromUrl(e),crsaMakeFileFromUrl(s)),s}function c(e,t){new CrsaProfile(!0),e.loadAndShowInActive(function(){window.requestAnimationFrame(function(){S(),y.parentView&&(y.parentView.setActiveCs(e),y.onStylesheetSelected&&y.onStylesheetSelected(e),w.quickWin)&&w.quickWin.close()})})}function d(e){pinegrow.showAlert("<p>After creating a new page, you have to <b>save the page</b> first, before using "+e+". After the page is saved on disk, you can use "+e+" without saving the page.</p>","Page needs a home first")}function g(e,t){var s=t.find("i.ss-enable"),n=e.isEnabledForPage(v);e.setEnabledForPage(v,!n),n?s.addClass("icon-hide").removeClass("icon-see"):s.addClass("icon-see").removeClass("icon-hide")}function o(s,e,t){var n,o=new CrsaContextMenu(null,t),l=!s.canEdit(!0),a=pinegrow.getDefaultStylesheet(null,function(){},!1,!0),i=(s.url&&(i=null,s.importedFiles&&0<s.importedFiles.length&&(n=function(t){s.getAllImportedFiles(function(e){e.setLocked(t,"")})},(i=[]).push({label:"Lock all children",action:function(){n(!0),pinegrow.selectedElements.reselect(),S()}}),i.push({label:"Unlock all children",action:function(){n(!1),pinegrow.selectedElements.reselect(),S()}})),o.add({label:"Locked",check:l,action:function(){l?s.unlockWithAsk(function(){S()}):(s.setLocked(!0,""),pinegrow.selectedElements.reselect(),pinegrow.showQuickMessage("Stylesheet is locked."),S())},submenu:i})),s.url&&!l&&o.add({label:"Set as default for new rules",action:function(){var e;(e=s).url?(pinegrow.setDefaultStylesheet(v,e),pinegrow.showQuickMessage(e.name+` will be used as default destination for new CSS rules.`)):pinegrow.showQuickError("Inline stylesheets can not be used as the default stylesheet."),$("body").trigger("crsa-stylesheets-changed")},check:a===s}),pinegrow.stylesheets.getStylesheetInfo(s,v));!isApp()||s.isImportedFor(v)||i&&i.compiledStylesheet||l||(o.add("Convert to SCSS",null,function(){var e,t;isApp()&&(s.changed?pinegrow.showAlert("Please save the stylesheet first.","Notice"):s.localFile?pinegrow.getSelectedPage().localFile?(e=r(crsaMakeUrlFromFile(s.localFile),"scss"),t=PgSCSSStylesheet(),pinegrow.stylesheets.stylsheetUsed({url:e,pgStylesheet:t},"source",s),s.compiledFile=!0,(s.sourceStylesheet=t).load(e,function(){s.setSourceStylesheet(t),$("body").trigger("crsa-stylesheets-changed")},!1,!1,s),pinegrow.refreshCurrentProjectDelayed(!0)):d("SCSS"):pinegrow.showAlert("<p>This is a remote stylesheet. The stylesheet needs to be local in order to convert it.</p>","Remote stylesheets are not supported."))}),o.add("Convert to LESS",null,function(){var e,t;isApp()&&(s.changed?pinegrow.showAlert("Please save the stylesheet first.","Notice"):s.localFile?pinegrow.getSelectedPage().localFile?(e=r(crsaMakeUrlFromFile(s.localFile),"less"),t=PgLESSStylesheet(),pinegrow.stylesheets.stylsheetUsed({url:e,pgStylesheet:t},"source",s),s.compiledFile=!0,(s.sourceStylesheet=t).load(e,function(){s.setSourceStylesheet(t),$("body").trigger("crsa-stylesheets-changed")},!1,!1,s),pinegrow.refreshCurrentProjectDelayed(!0)):d("LESS"):pinegrow.showAlert("<p>This is a remote stylesheet. The stylesheet needs to be local in order to convert it.</p>","Remote stylesheets are not supported."))})),o.add("Format file",null,function(){isApp()&&s.formatCode(function(){pinegrow.dispatchEvent("on_css_source_changed",null,{list:[s]}),s.inline&&pinegrow.dispatchEvent("on_css_stylesheet_changed",null,s)})}),isApp()&&i&&i.compiledStylesheet&&(o.add("Recompile file",null,function(){isApp()&&s.regenerateAndSetCssSource(function(){$("body").trigger("crsa-stylesheets-changed"),pinegrow.showQuickMessage("File compiled!")})}),o.add("Compile &amp; save",null,function(){isApp()&&s.regenerateAndSetCssSource(function(){var e=crsaMakeFileFromUrl(s.url);s.save(e,function(e){e?showAlert("Error: "+e,"Can't save this file"):(pinegrow.refreshPageChangedStatusForAllPages(!0),pinegrow.showQuickMessage("File compiled and saved!"))}),$("body").trigger("crsa-stylesheets-changed")})})),s.ignore||!s.loaded?o.add("Load &amp; Show in Active",null,function(){s.loadAndShowInActive()}):o.add("Ignore in Active",null,function(){s.ignoreInActive()}),isApp()&&!s.isImportedFor(v)&&(s.isEnabledForPage(v)?o.add("Hide in page view",null,function(){g(s,h)}):o.add("Show in page view",null,function(){g(s,h)})),s.inline||o.add("Reload",null,function(){y.reloadStylesheet(s)}),o.add("Edit",null,function(){c(s)}),o.add("Open in Tree",null,function(){PgQuickDmCssVariablesTree(s)}),e?o.showAt(e.pageX,e.pageY):o.showForElement(t)}var l,a,i=t.loaded&&!t.ignore,h=$("<li/>").appendTo(e).data("crsa-cs",t),i=(i&&h.addClass("loaded"),$("<i/>",{class:"icon glyphicon glyphicon-lock",style:`font-size: 12px;
            opacity: 0.85;
            float: left;
            width: 11px;
            margin: 5px 3px 0px;`}).appendTo(h)),i=(t.locked?addTooltip(i,"The stylesheet is locked. Rigth-click to unlock."):i.css({visibility:"hidden"}),t.locked||pg$Hide(i),s||(l=$("<i/>",{class:"ss-enable"}).appendTo(h).addClass(t.isEnabledForPage(v)?"icon-see":"icon-hide")),$("<a/>",{href:"#"}).html("<span>"+t.name+"</span>").appendTo(h)),u=(t.url?p(t)+"<br>":"")+"Click to open in a separate tab. Right-click for options.";t===f&&(i.addClass("pg-default-cs"),u=`<b>Default stylesheet</b><br>`+u),addTooltip(i,u),t.url&&((u=$("<i/>",{class:"code icon icon-KODA"}).appendTo(h)).on("click",function(e){e.preventDefault(),pinegrow.stylesheets.editCode(t)}),addTooltip(u,"Edit stylesheet code.")),s||(a=$("<i/>",{class:"menu icon icon-down"}).appendTo(h),$("<i/>",{class:"move icon icon-Pin6"}).appendTo(h)),s||(addTooltip(l,"Hide / show in the page view (note, this will not remove the stylesheet from the page).",{placement:"top"}),addTooltip(a,"More actions...")),t.getError()&&i.addClass("has-css-error");return i.on("click",function(e){var t=$(e.delegateTarget).closest("li").data("crsa-cs");new CrsaProfile(!0);c(t),e.preventDefault()}).on("contextmenu",function(e){e.preventDefault();var t=$(e.delegateTarget).closest("li"),s=t.data("crsa-cs");return o(s,e,t),!1}),a&&a.on("click",function(e){e.preventDefault();var t=$(e.delegateTarget).closest("li").data("crsa-cs");return o(t,null,a),!1}),s||l.on("click",function(e){var t=$(e.delegateTarget).closest("li"),s=t.data("crsa-cs");g(s,t),pinegrow.reselectElement(),e.preventDefault()}),h},(i=function(t,o,l){pinegrow.getDefaultStylesheet(pinegrow.getSelectedPage(),function(e){$.each(t,function(e,t){t.sourceStylesheet&&(t=t.sourceStylesheet);var s=a(t,o,l),n=t.importedFiles;0<n.length&&(s=$('<ul class="nested"></ul>').appendTo(s),i(n,s,!0))})},!1,!0)})(e,r,!1),r.sortable("refresh"),$(window).trigger("resize"),w.quickWin)&&w.quickWin.autoResize(300)):r.sortable("refresh")},a=(this.show=this.refresh=function(){a(null,pinegrow.getSelectedPage())},this.reloadStylesheet=function(e,t){function s(){t&&t(),crsaQuickMessage(e.name+" reloaded."),$("body").trigger("crsa-stylesheets-changed")}e.changed?showAlert(e.name+" has unsaved changes. Do you want to reload the stylesheet and loose these changes?","Unsaved changes","Cancel","Reload",null,function(){e.reload(s)}):e.reload(s)},n.on("click",function(e){var t;e.preventDefault(),isApp()&&(null==(t=pinegrow.getSelectedPage())?pinegrow.showAlert("<p>Please open a page to use stylesheet manager</p>","No page is open"):t.localFile||t.isRemote()?$.fn.crsacss("showStylesheetsManager"):pinegrow.showAlert("<p>After creating a new page, you have to <b>save the page</b> first, before using stylesheet manager. After the page is saved on disk, you can use stylesheet manager without saving the page.</p>","Page needs a home first"))}),r.sortable({handle:"i.icon-Pin6",axis:"y",scroll:!1}).on("sortupdate",function(e,t){var n=[];r.find("> li").each(function(e,t){var s=$(t).data("crsa-cs");s&&n.push(s)}),getCrsaPageStylesForPage(o).reorder(n,function(){pinegrow.getSelectedPage().callFrameworkHandler("on_page_changes_done",{action:"Move elements"})})}),w.whenVisible(function(){S()}),function(e,t){o=(v=t)?t.$iframe:null,o&&o.get(0),w.whenVisible(function(){S()})});$("body").on("crsa-page-selected",a),$("body").on("crsa-stylesheets-changed",S),pinegrow.addEventHandler("on_page_changes_done",t),pinegrow.addEventHandler("on_page_stylesheets_loaded",e),w.onDestroy=function(){$("body").off("crsa-page-selected",a).off("crsa-stylesheets-changed",S),pinegrow.removeEventHandler("on_page_changes_done",t),pinegrow.removeEventHandler("on_page_stylesheets_loaded",e)}};