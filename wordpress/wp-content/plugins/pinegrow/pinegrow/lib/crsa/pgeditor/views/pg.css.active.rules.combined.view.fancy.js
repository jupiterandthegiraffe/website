var PgCSSActiveRulesCombinedViewWithFancyTree=function(){function e(e,n){T.has(n)&&(p.removeTab(T.get(n)),T.delete(n))}function t(t,i){b.whenVisible(function(){var e,n;"gui"!=t.edited_by&&(e=t.node,n=pinegrow.getSelectedRule(),k&&(clearTimeout(k),k=null),n)&&pinegrow.pgPostCSSHelper.isNodeEqualOrChildOf(n,e)&&(n=function(){k=null;var e=t.node;"rule"!=e.type||i?pinegrow.isSelectedRule(e.parent)&&O():(e=pinegrow.pgPostCSSHelper.getRuleForNode(e),V(e))},"undo"==t.edited_by?k=setTimeout(n,100):n())})}function n(e,t){var n,i,o,s=pinegrow.getSelectedRule();s&&(n=pgcssh.getStylesheetForNode(s),i=s.selector,(o=function(e){n&&z.getRuleForMediaSize(n,i,0===t.w_range[0]?null:t.w_range[0],function(e){var n;e?pinegrow.selectRule(e):P&&(n=t.name_short||t.name,t.w_range&&(n+=` - ${t.w_range[0]}px and above`),P.showNoRuleNotice(i,n,function(){o(!0)}))},e)})())}function i(e,n){b.whenVisible(function(){H=pinegrow.selectedElements.getLastSelected(),a.updateRulesDisplayOnElementSelect(),pinegrow.getSelectedRule()&&H||V()})}function o(e,n,t){b.whenVisible(function(){a.updateRulesDisplayOnElementSelect()})}function s(){}function l(e){f.css({"min-height":(e=90<e?90:e)+"%","max-height":e+"%"}),C.update()}var a=this,d=(pinegrow.activeCSSView=this,$('<div class="pg-css-active-rules-view"></div>')),c=null,z=new PgCSSApi,r=new PgSearchBox({placeholder:"search",placeholder_active:null,toolbar_on:!0,delay:!0}),u=(pgf.kids||r.$element.appendTo(d),r.onSearch=function(e){c&&E?E.search(e):pinegrow.showQuickMessage("Search is not available in ACTIVE tab.",4e3,!0),R=e},new PgSearchBoxSpacer),g=(u.$element.appendTo(d),new PgButtonToolbar),p=(pgf.kids||d.append(g.$element.addClass("pg-tabs-toolbar")),new PgToolbarTabButtons(g,"tabs")),h=p.addTab("Active","Active rules for the selected element",null,!0),w=(h.$element.addClass("pg-selected-top-border without-close"),new WeakMap,p.onTabSelected=function(e){(c=e.data)?a.showStylesheet(c):M(H,F,R)},p.onTabClosed=function(e){var n=e.data;n&&T.has(n)&&T.delete(n)},g.addSection("icons"),pg$Hide(r.$element),pg$Hide(u.$element),new PgButtonToolbarItem('<span>Stylesheets</span><i class="icon icon-Pin10"></i><i class="icon icon-down"></i>',"Show stylesheets...")),v=new PgButtonToolbarItemWithDropdownView('<span>Stylesheets</span>\x3c!-- <i class="icon icon-Pin10"></i> --\x3e<i class="icon icon-down"></i>',"Show and manage the list of available stylesheets..."),v=(v.toolbarItem.$element.addClass("stylesheets"),pgf.kids||g.addItem("icons",v.toolbarItem),v.onGetView=function(){var e=new PgStylesheetsView;return e.parentView=a,e},w.onClick=function(){PgQuickStylesheets(this.$element,a)},new PgButtonToolbarItem("icon-search","Show / hide search")),_=(pgf.kids||g.addItem("icons",v),v.onClick=function(){var e=!this.getActive();this.setActive(e),e?(pg$Show(r.$element),pg$Show(u.$element),r.focus(),_.addClass("has-search")):(pg$Hide(r.$element),pg$Hide(u.$element),_.removeClass("has-search")),C.update()},this.show=function(e,n){e&&(H=e),c?(R=n,this.setActiveCs(null)):r.setValue(n)},$('<div class="pg-css-active-rules-combined"></div>').appendTo(d)),f=(pgf.kids&&_.css("top","-5px"),$('<div class="pg-rules-container"></div>').appendTo(_)),m=new PgPanelNotice,S=(m.$element.appendTo(f),new PgCSSTreeView(!0)),w=(S.view.get$Element().appendTo(f),S.combinedView=this,$('<div class="pg-css-gui-container"><h1><span class="text">Visual Editor</span><span class="handle"><i class="icon icon225 icon-drag-vert-x225"></i></span><i class="icon icon-ddown hide-gui"></i><i class="icon icon-dup show-gui"></i></h1></div>').appendTo(_)),y=$('<div class="crsa-stylesheets crsa-css-gui"></div>').appendTo(w),g=w.find("> h1"),b=(pgf.kids&&g.find(".hide-gui,.show-gui").detach(),g.find(".hide-gui").on("click",function(e){return e.preventDefault(),x(),!1}),new PgUIView(d,"style","Style")),C=(b.tabIcon="icon-Pin15",new PgComboDividerBox(g,b)),E=null,T=(new Map,new Map),H=(this.setActiveCs=function(e){e?(T.has(e)?p.selectTab(T.get(e)):T.set(e,p.addTab(e.name,"Edit stylesheet "+e.name,e,!0)),m.show(null)):p.select(h)},this.showCreateCssRule=function(e){c&&this.setActiveCs(null)},this.showStylesheet=function(e){D&&(clearTimeout(D),D=null),S.show(e);var n=pinegrow.getSelectedRule();n&&S.scrollToNode(n)},this.view=b,null),R=null,B=null,M=function(e,n,t,i,o){D&&(clearTimeout(D),D=null),e=e||pinegrow.getSelectedElement();B===e&&f.find(".rules-list").scrollTop(),H=B=e,R=t,c?a.showStylesheet(c):e&&pinegrow.getSelectedPage()?(m.show(),S.show(null,function(){var e=pinegrow.getSelectedRule();e&&S.scrollToNode(e)})):m.show("Element is not selected.")},P=(this.openCreateNewRuleDialog=function(e,n,t,i){this.view.whenVisible(function(){},"showNewRuleDialog",1)},null),F=null,V=function(e,n){var t={indices:pinegrow.getSelectedRuleIndices(),pgStylesheet:pinegrow.getSelectedRuleStylesheet()};(P=P||new PgCSSEditorNEW(y)).editRule(t,n),P.hideNoRuleNotice()},O=function(){var e=pinegrow.getSelectedRule();$("body").trigger("crsa-rule-selected",{rule:e})},k=(b.on("crsa-rule-selected",function(e,n){b.whenVisible(function(){n?(V(n.rule,n.options),F=n.rule):O()})}),null),L=(pinegrow.addEventHandler("on_current_device_size_changed",n),pinegrow.addEventHandler("on_css_rule_selected_in_active",function(e,n,t){H&&n&&H.setData("selectedCssRule",pgcssh.getGlobalNodeId(n))}),pinegrow.addEventHandler("on_css_node_deleted",function(e,n){t(n,!0)}),pinegrow.addEventHandler("on_css_node_updated",function(e,n){t(n)}),pinegrow.addEventHandler("on_css_node_added",function(e,n){t(n)}),"cssActiveComboResize"),D=(b.onResize=function(){var e=b.getFastdomTasks().createDummy(L);e.measure(function(){var t,i,o=d.width(),s=d.height(),l=f.height();e.mutate(function(){var e,n;500<o?(e=300,n=Math.max(1,Math.floor((o-200)/e)),n=N?o-n*e:o-24,f.css({"min-width":n,"max-width":n}),t=o-n,i=s,_.addClass("horizontal")):(f.css({"min-width":"","max-width":""}),_.removeClass("horizontal"),N||(_.addClass("gui-hidden"),pg$Hide(y)),t=o,i=s-l),S.updateLayout(),P&&N&&P.updateLayout(t,i),C.update(!0)})})},this.updateRulesDisplayOnElementSelect=function(e){},this.refreshCurrentDisplay=function(e){b.whenVisible(function(){pinegrow.getSelectedRule()||V(),e&&S.refresh()})},null),N=(pinegrow.addEventHandler("on_undo_redo",o),pinegrow.addEventHandler("on_css_stylesheet_locked_changed",s),pinegrow.addEventHandler("on_css_active_rule_changed",i),pinegrow.addEventHandler("on_css_attribute_style_changed",i),pinegrow.addEventHandler("on_panel_moved_in_another_window",i),b.whenVisible(function(){i()}),pinegrow.addEventHandler("on_stylesheet_closed",e),pinegrow.addEventHandler("on_stylesheet_unloaded",e),pinegrow.addEventHandler("on_stylesheet_suspended",e),b.onDestroy=function(){pinegrow.removeEventHandler("on_css_active_rule_changed",i),pinegrow.removeEventHandler("on_css_attribute_style_changed",i),pinegrow.removeEventHandler("on_panel_moved_in_another_window",i),pinegrow.removeEventHandler("on_stylesheet_closed",e),pinegrow.removeEventHandler("on_stylesheet_unloaded",e),pinegrow.removeEventHandler("on_stylesheet_suspended",e),pinegrow.removeEventHandler("on_undo_redo",o),pinegrow.removeEventHandler("on_css_stylesheet_locked_changed",s),pinegrow.removeEventHandler("on_current_device_size_changed",n),r.destroy(),pinegrow.activeCSSView==this&&(pinegrow.activeCSSView=null),k&&(clearTimeout(k),k=null),pgFastdom.stopAll(L)},"1"===pinegrow.getSetting("acss-gui-open","1")),x=function(){_.addClass("gui-hidden"),pg$Hide(y),b.onResize(),pinegrow.setSetting("acss-gui-open","0"),N=!1,C.update()},A=parseFloat(pinegrow.getSetting("css-gui-size-2","37")),v=(l(A),N||x(),g.on("click",function(e){e.preventDefault(),I||pgf.kids||((N=!N)?(_.removeClass("gui-hidden"),pg$Show(y),b.onResize(),pinegrow.setSetting("acss-gui-open","1"),N=!0,C.update()):x())}),new GoldenLayout.__lm.utils.DragListener(g.find(".handle"),0,!1)),W=0,I=!1,G=0;v.on("dragStart",function(e,n){W=f.outerHeight(),G=f.parent().height(),I=!0,$.fn.crsapages("showOverlays")},this),v.on("drag",function(e,n,t){var i=Math.max(0,W+n);l(A=i/G*100)},this),v.on("dragStop",function(e,n){$.fn.crsapages("showOverlays",!0),setTimeout(function(){I=!1},100),pinegrow.setSetting("css-gui-size-2",A)},this)};