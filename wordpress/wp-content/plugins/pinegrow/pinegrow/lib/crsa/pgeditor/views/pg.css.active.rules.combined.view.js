var PgCSSActiveRulesCombinedView=function(){function e(e,n){E.has(n)&&(g.removeTab(E.get(n)),E.delete(n))}function t(t,s){f.whenVisible(function(){var e,n;"gui"!=t.edited_by&&(e=t.node,n=pinegrow.getSelectedRule(),A&&(clearTimeout(A),A=null),n)&&pinegrow.pgPostCSSHelper.isNodeEqualOrChildOf(n,e)&&(n=function(){A=null;var e=t.node;"rule"!=e.type||s?pinegrow.isSelectedRule(e.parent)&&Q():(e=pinegrow.pgPostCSSHelper.getRuleForNode(e),N(e))},"undo"==t.edited_by?A=setTimeout(n,100):n())})}function x(s,i){var n,l,o,e=pinegrow.getSelectedRule();e&&(n=pgcssh.getStylesheetForNode(e),l=e.selector,(o=function(e){var t=pinegrow.selectedElements.getLastSelected();n&&F.getRuleForMediaSize(n,l,0===i.w_range[0]?null:i.w_range[0],function(n){var e;n?s.activeView.deviceWidth<i.w_range[0]?(e=i.name_short||i.name,t&&t.setData("selectedCssRule","none"),D.showNoRuleNotice(l,e,function(){t&&t.setData("selectedCssRule",null);var e=s.view.setActiveViewSizeWithDef(i);s.view.setActiveView(e),pinegrow.selectRule(n)},"rule_not_visible")):pinegrow.selectRule(n):D&&(e=i.name_short||i.name,i.w_range&&(e+=` - ${i.w_range[0]}px and above`),t&&"Style attribute"!==l&&t.setData("selectedCssRule","none"),D.showNoRuleNotice(l,e,function(){t&&t.setData("selectedCssRule",null),o(!0)}))},e)})())}function n(e,n){f.whenVisible(function(){T=pinegrow.selectedElements.getLastSelected(),r.updateRulesDisplayOnElementSelect(),pinegrow.getSelectedRule()&&T||N()})}function z(e,n,t){f.whenVisible(function(){r.updateRulesDisplayOnElementSelect()})}function M(){f.isVisible()&&null==c&&R&&R.ready&&P(T,k,V,null,!1)}function B(e){v.css({"min-height":(e=90<e?90:e)+"%","max-height":e+"%"}),_.update()}var r=this,a=(pinegrow.activeCSSView=this,$('<div class="pg-css-active-rules-view"></div>')),c=null,s="1"===pinegrow.getSetting("css-tree","0"),l=null,i=null,F=new PgCSSApi,o=new PgSearchBox({placeholder:"search",placeholder_active:null,toolbar_on:!0,delay:!1}),d=(pgf.kids||o.$element.appendTo(a),o.onSearch=function(e){c?(C&&C.search(e),i&&i.search(e)):s&&l?l.search(e):pinegrow.showQuickMessage("Search is not available in ACTIVE tab. Switch to TREE tab.",4e3,!0),V=e},new PgSearchBoxSpacer),u=(d.$element.appendTo(a),new PgButtonToolbar),g=(pgf.kids||a.append(u.$element.addClass("pg-tabs-toolbar")),new PgToolbarTabButtons(u,"tabs")),L=g.addTab("Active","Active rules for the selected element",null,!s),W=(L.$element.addClass("pg-selected-top-border without-close"),g.addTab("Tree","CSS Tree with active rules for the selected element and its parents [Beta]","tree",s)),h=(W.$element.addClass("pg-selected-top-border without-close"),new WeakMap,g.onTabSelected=function(e){"tree"===e.data?(c=null,b(),s=!0,G(T,k,V),pinegrow.setSetting("css-tree","1")):(c=e.data)?r.showStylesheet(c):(b(),s=!1,P(T,k,V),pinegrow.setSetting("css-tree","0"))},g.onTabClosed=function(e){var n,t=e.data;t&&(y.has(t)||i)&&((n=y.get(t))&&n.view.destroy(),C==n&&(C=null),y.delete(t),E.delete(t))},u.addSection("icons"),pg$Hide(o.$element),pg$Hide(d.$element),new PgButtonToolbarItem('<span>Stylesheets</span><i class="icon icon-Pin10"></i><i class="icon icon-down"></i>',"Show stylesheets...")),w=new PgButtonToolbarItemWithDropdownView('<span>Stylesheets</span>\x3c!-- <i class="icon icon-Pin10"></i> --\x3e<i class="icon icon-down"></i>',"Show and manage the list of available stylesheets..."),w=(w.toolbarItem.$element.addClass("stylesheets"),pgf.kids||u.addItem("icons",w.toolbarItem),w.onGetView=function(){var e=new PgStylesheetsView;return e.parentView=r,e},h.onClick=function(){PgQuickStylesheets(this.$element,r)},new PgButtonToolbarItem("icon-search","Show / hide search")),p=(pgf.kids||u.addItem("icons",w),w.onClick=function(){var e=!this.getActive();this.setActive(e),e?(pg$Show(o.$element),pg$Show(d.$element),o.focus(),p.addClass("has-search")):(pg$Hide(o.$element),pg$Hide(d.$element),p.removeClass("has-search")),_.update()},this.show=function(e,n){e&&(T=e),c?(V=n,this.setActiveCs(null)):o.setValue(n)},$('<div class="pg-css-active-rules-combined"></div>').appendTo(a)),v=(pgf.kids&&p.css("top","-5px"),$('<div class="pg-rules-container"></div>').appendTo(p)),m=new PgPanelNotice,h=(m.$element.appendTo(v),$('<div class="pg-css-gui-container"><h1><span class="text">Visual Editor</span><span class="handle"><i class="icon icon225 icon-drag-vert-x225"></i></span><i class="icon icon-ddown hide-gui"></i><i class="icon icon-dup show-gui"></i></h1></div>').appendTo(p)),S=$('<div class="crsa-stylesheets crsa-css-gui"></div>').appendTo(h),u=h.find("> h1"),f=(pgf.kids&&u.find(".hide-gui,.show-gui").detach(),u.find(".hide-gui").on("click",function(e){return e.preventDefault(),U(),!1}),new PgUIView(a,"style","Style")),_=(f.tabIcon="icon-Pin15",new PgComboDividerBox(u,f)),C=null,b=function(){C&&(C.quitCodeMode(),C.view.get$Element().detach()),l&&l.view.get$Element().detach(),i&&i.view.get$Element().detach(),v.find("> *").not(".alert").remove(),R&&R.ready&&(R.remove(),R=null),I&&(clearTimeout(I),I=null)},y=new Map,E=new Map,R=(this.setActiveCs=function(e){e?(E.has(e)?g.selectTab(E.get(e)):E.set(e,g.addTab(e.name,"Edit stylesheet "+e.name,e,!0)),m.show(null)):g.select(s?W:L)},this.showCreateCssRule=function(e){c&&this.setActiveCs(null),R?R.showCreateCssRule(e):this.showCreateCssRuleOnVisible=e||!0},this.updateRulesDisplayOnElementSelect=function(e){var n,t;c||(s?l&&0!==l.view.get$Element().parent().length||G(T,k,V,n):(n=null,T&&("none"!==(t=T.getData("selectedCssRule"))?t&&!e&&(n=t.csurl?pgcssh.getNodeFromGlobalId(t):"inline"):(n="none",T.setData("selectedCssRule",null))),P(T,k=e?null:k,V,n)))},this.showStylesheet=function(e){b(),i||((i=new PgCSSTreeView(!1)).combinedView=r),m.show(null),i.view.get$Element().appendTo(v),i.view.updateVisibility(),i.show(e);var n=pinegrow.getSelectedRule();n&&i.scrollToNode(n)},null),T=(this.view=f,null),V=null,H=null,G=function(e,n,t,s,i){I&&(clearTimeout(I),I=null),e=e||pinegrow.getSelectedElement();H===e&&v.find(".rules-list").scrollTop(),T=H=e,V=t,c?r.showStylesheet(c):(l||((l=new PgCSSTreeView(!0)).combinedView=r),e&&pinegrow.getSelectedPage()?(m.show(),l.view.get$Element().appendTo(v),l.view.updateVisibility(),l.show(null,function(){var e=pinegrow.getSelectedRule();e&&l.scrollToNode(e)})):m.show("Element is not selected."))},P=function(e,n,t,s,i){I&&(clearTimeout(I),I=null),e=e||pinegrow.getSelectedElement();var l,o,a=0,d=(H===e&&(a=(l=v.find(".rules-list")).scrollTop()),T=H=e,V=t,!0);(d=R&&R.ready&&R.getSelectedElement()==e?!1:d)&&R&&R.remove(),c?r.showStylesheet(c):(d=null,0&&t&&T&&(o=new CrsaProfile,d=T.getPage().activeView.findCSSRules(t),o.show("SEARCH CSS RULES"),d.length>(o=20))&&(pinegrow.showQuickMessage("Only the first "+o+" matches out of "+d.length+" shown."),d.splice(o,d.length-o)),v.find("> .crsa-cm-rules").remove(),e&&pinegrow.getSelectedPage()?(m.show(),o=$('<div class="crsa-cm-rules"></div>').appendTo(v),R&&R.remove(),(R=new PgCSSActiveRulesEditor(e,o)).parentView=r,R.ready&&(i&&R.setActiveOutDated(),R.show(n,d,s),r.showCreateCssRuleOnVisible)&&(R.showCreateCssRule(!0===r.showCreateCssRuleOnVisible?"":r.showCreateCssRuleOnVisible),r.showCreateCssRuleOnVisible=null),l=v.find(".rules-list"),0!==a?l.scrollTop(a):(o=v.find(".pg-selected-rule > div")).length&&pgScrollToItemInContainer(o,l,!1,!1)):(m.show("Element is not selected."),R&&R.ready&&(R.remove(),R=null)))},D=(this.openCreateNewRuleDialog=function(e,n,t,s){this.view.whenVisible(function(){R?R.openCreateNewRuleDialog(e,n,t,s):pinegrow.showQuickMessage("Element is not selected.")},"showNewRuleDialog",1)},null),k=null,N=function(e,n){var t={indices:pinegrow.getSelectedRuleIndices(),pgStylesheet:pinegrow.getSelectedRuleStylesheet()};(D=D||new PgCSSEditorNEW(S)).editRule(t,n),D.hideNoRuleNotice()},Q=function(){var e=pinegrow.getSelectedRule();$("body").trigger("crsa-rule-selected",{rule:e})},A=(f.on("crsa-rule-selected",function(e,n){f.whenVisible(function(){n?(N(n.rule,n.options),k=n.rule):Q()})}),null),q=(pinegrow.addEventHandler("on_current_device_size_changed",x),pinegrow.addEventHandler("on_css_rule_selected_in_active",function(e,n,t){T&&n&&T.setData("selectedCssRule",pgcssh.getGlobalNodeId(n))}),pinegrow.addEventHandler("on_css_node_deleted",function(e,n){t(n,!0)}),pinegrow.addEventHandler("on_css_node_updated",function(e,n){t(n)}),pinegrow.addEventHandler("on_css_node_added",function(e,n){t(n)}),"cssActiveComboResize"),I=(f.onResize=function(){var e=f.getFastdomTasks().createDummy(q);e.measure(function(){var t,s,i=a.width(),l=a.height(),o=v.height();e.mutate(function(){var e,n;600<i?(e=300,n=Math.max(1,Math.floor((i-200)/e)),t=i-(n=i-n*e),s=l,p.addClass("horizontal"),O||(p.removeClass("gui-hidden"),pg$Show(S)),v.css({"min-width":n,"max-width":n})):(v.css({"min-width":"","max-width":""}),p.removeClass("horizontal"),O||(p.addClass("gui-hidden"),pg$Hide(S)),t=i,s=l-o,_.show()),R&&R.ready&&R.updateLayout(),D&&D.updateLayout(t,s),_.update(!0)})})},this.refreshCurrentDisplay=function(n){f.whenVisible(function(){var e;r.updateRulesDisplayOnElementSelect(),pinegrow.getSelectedRule()||N(),n&&(e=y.get(n))&&e.refresh()})},null),O=(pinegrow.addEventHandler("on_undo_redo",z),pinegrow.addEventHandler("on_css_stylesheet_locked_changed",M),pinegrow.addEventHandler("on_css_active_rule_changed",n),pinegrow.addEventHandler("on_css_attribute_style_changed",n),pinegrow.addEventHandler("on_panel_moved_in_another_window",n),f.whenVisible(function(){n()}),pinegrow.addEventHandler("on_stylesheet_closed",e),pinegrow.addEventHandler("on_stylesheet_unloaded",e),pinegrow.addEventHandler("on_stylesheet_suspended",e),f.onDestroy=function(){pinegrow.removeEventHandler("on_css_active_rule_changed",n),pinegrow.removeEventHandler("on_css_attribute_style_changed",n),pinegrow.removeEventHandler("on_panel_moved_in_another_window",n),pinegrow.removeEventHandler("on_stylesheet_closed",e),pinegrow.removeEventHandler("on_stylesheet_unloaded",e),pinegrow.removeEventHandler("on_stylesheet_suspended",e),pinegrow.removeEventHandler("on_undo_redo",z),pinegrow.removeEventHandler("on_css_stylesheet_locked_changed",M),pinegrow.removeEventHandler("on_current_device_size_changed",x),o.destroy(),pinegrow.activeCSSView==this&&(pinegrow.activeCSSView=null),A&&(clearTimeout(A),A=null),pgFastdom.stopAll(q)},"1"===pinegrow.getSetting("acss-gui-open","1")),U=function(){p.addClass("gui-hidden"),pg$Hide(S),pinegrow.setSetting("acss-gui-open","0"),O=!1,_.update()},j=parseFloat(pinegrow.getSetting("css-gui-size-2","37")),w=(B(j),O||U(),u.on("click",function(e){e.preventDefault(),K||pgf.kids||((O=!O)?(p.removeClass("gui-hidden"),pg$Show(S,"flex"),f.onResize(),pinegrow.setSetting("acss-gui-open","1"),O=!0,_.update()):U(),f.onResize())}),new GoldenLayout.__lm.utils.DragListener(u.find(".handle"),0,!1)),J=0,K=!1,X=0;w.on("dragStart",function(e,n){J=v.outerHeight(),X=v.parent().height(),K=!0,$.fn.crsapages("showOverlays")},this),w.on("drag",function(e,n,t){var s=Math.max(0,J+n);B(j=s/X*100)},this),w.on("dragStop",function(e,n){$.fn.crsapages("showOverlays",!0),setTimeout(function(){K=!1},100),pinegrow.setSetting("css-gui-size-2",j)},this)};