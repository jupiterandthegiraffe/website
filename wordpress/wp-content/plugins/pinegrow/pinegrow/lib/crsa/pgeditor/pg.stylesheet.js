window.PgStylesheet=function(){this.index="",this.localFile=null,this.url=null,this.name=null,this.outFile=null,this.source=null,this.parsedSource=null,this.changed=!1,this.changedOnce=!1,this.appliedToPage=!1,this.usedExistedCompiled=!1,this.loaded=!1,this.error=null,this.codeError=null,this.loadingFailed=!1,this.ignore=!1,this.compiledFile=!1,this.nakedUrl=null,this.parentPgStylesheets=[],this.rootNode=null,this.importedFiles=[],this.recursiveImports=null,this.emptyNodes=[],this.varGroups=[],this.ignoreInSave=!1,this.locked=!1,this.lockedReason=null,this.needFormatting=!1,this.formattingOptions={},this.mappedRemote=!1,this.usedByDesignPanel=!1,this.isDestroyed=!1,this.getEditorMode=function(){return"css"},this.isImported=function(){return 0<this.parentPgStylesheets.length},this.isImportedFor=function(e){var t=pinegrow.stylesheets.getStylesheetInfo(this,e);return!(!t||!t.parentPgStylesheet)},this.setLoadingFailed=function(e){(this.loadingFailed=e)&&pinegrow.showQuickError("Could not load "+this.url)},this.setLocked=function(e,t,s){this.locked=e,this.lockedReason=t,s||(this.setSetting({locked:e,locked_reason:t}),pinegrow.dispatchEvent("on_css_stylesheet_locked_changed",null,this,e))},this.setNeedFormatting=function(e){this.needFormatting=e},this.isLocked=function(){return this.locked},this.unlockWithAsk=function(e){var t=this,s=`<p>Are you sure you want to unlock this stylesheet?</p>`;!this.localFile&&this.url&&(s+=`<p>This is a remote stylesheet that can't be saved.`),this.lockedReason&&(s+=`<p>${this.lockedReason}</p>`),pinegrow.showAlert(s,"Unlock the stylesheet?","Cancel","Yes, unlock it",null,function(){t.setLocked(!1,""),pinegrow.selectedElements.reselect(),e&&e()})};function o(e){var t=null,s=pinegrow.getCurrentProject();return s?(t=s.getProjectInfo()).parent_url=s.getUrl():(s=pinegrow.stylesheets.getPagesForStylesheet(e)).length&&((t=(s=s[0]).getProjectInfo()).parent_url=s.url),t&&t.parent_url&&(t.relative_url=crsaMakeLinkRelativeTo(e.url,t.parent_url)),t}var i=!1,g=(this.canEdit=function(e,t){var s;return this.locked&&!e&&(pinegrow.selectedElements.reselect(),i||(i=!0,s=`<p>${this.lockedReason||"This stylesheet is locked."}</p>`,t&&(s+=`<p><b>Right-click on the CSS rule</b> in the Active Style tab to <b>override</b> or <b>duplicate</b> it in the editable stylesheet.</p>`),pinegrow.showAlert(s,this.name+` is locked`,null,"OK",function(){i=!1},function(){i=!1}))),!this.locked},this.loadAndShowInActive=function(e){this.ignore=!1;function t(){$("body").trigger("crsa-stylesheets-changed"),crsaQuickMessage("CSS rules list updated."),e&&e()}var s=null,i=pinegrow.stylesheets.getStylesheetInfo(this,pinegrow.getSelectedPage());i&&i.compiledStylesheet?(s=i.compiledStylesheet).ignore=this.ignore:s=this;this.loaded?this.regenerateAndSetCssSource(t):s.load(s.url,function(){t()})},this.ignoreInActive=function(){function t(){i(e),$("body").trigger("crsa-stylesheets-changed")}var s,e=this,i=function(t){t.ignore=!0,0<t.compiledStylesheets.length&&t.compiledStylesheets.forEach(function(e){e.ignore=t.ignore}),t.parentPgStylesheets&&t.parentPgStylesheets.forEach(i)};this.changed&&this.localFile?(s=showAlert(`The stylesheet ${e.name} has unsaved changes. Hiding the stylesheet will cause these changes to be lost.`,"The stylesheet has unsaved changes","Cancel","Save &amp; Hide",null,function(){e.save(e.localFile,function(){pinegrow.refreshPageChangedStatusForAllPages(!0),t()})}),$('<a href="#" class="btn pull-left">Don\'t save</a>').appendTo(s.find(".modal-footer")).on("click",function(e){e.preventDefault(),s.modal("hide"),t()})):t()},this.addParentStylesheet=function(e){this.parentPgStylesheets.indexOf(e)<0&&this.parentPgStylesheets.push(e)},this.forEachStylesheet=function(e,t){var s=null;if(0!=(s=t?s:e(this)))for(var i=this.importedFiles,n=0;n<i.length;n++)if(0==(s=i[n].forEachStylesheet(e,!1)))break;return s},this.forEachParentCS=function(t,e){var s=!0;e||0==t(this)&&(s=!1),s&&this.parentPgStylesheets.forEach(function(e){e.forEachParentCS(t,!1)})},this.isRemote=function(){return crsaIsRemoteUrl(this.url)},this.setSetting=function(e,t){var s,i,n=o(this);n&&this.url&&("string"==typeof e&&((s={})[e]=t,e=s),i=this,$.each(e,function(e,t){n.setSettingForUrl(i.url,e,t)}),n.save())},this.getSetting=function(e){var t=o(this);return t&&this.url?t.getSettingForUrl(this.url,e):null},this.fast=!1,this.atruleWithNoChild=["keyframes","-webkit-keyframes","-moz-keyframes","-ms-keyframes","-o-keyframes"],this.sourceStylesheet=null,this.compiledStylesheets=[],this.isWatchingFileForChanges=!1,this.watchReloadDialog=null,this.lastSavedAt=0,this.GROUP_TITLE_MARGIN="====",this),d="(px|em|rem|pt)",s={},F=new PgDelayedTasks,n=(this.canAddRuleIdsSuper=function(e){var t=e.parent;return!(t&&"atrule"==t.type&&-1<this.atruleWithNoChild.indexOf(t.name))},this.canAddRuleIds=function(e){return this.canAddRuleIdsSuper(e)},this.setCollapsedNode=function(e,t){e&&(s[e]=t)},this.setIgnore=function(t){this.ignore=t,this.sourceStylesheet&&(this.sourceStylesheet.ignore=t),0<this.compiledStylesheets.length&&this.compiledStylesheets.forEach(function(e){e.ignore=t})},this.getCollapsedNode=function(e){return e&&s[e]||!1},this.getUniqueName=function(){return"cs"+("-"+this.index)},this.getUniqueId=function(){return this.index},this.getFullUrlFor=function(e,t){var s,i=`.`+this.fileType,n=(e.endsWith(i)&&(i=""),e.split("/"));return t&&(s=n.pop(),n.push("_"+s)),crsaIsAbsoluteUrl(e)?``+n.join("/")+i:crsaCombineUrlWith(this.url,``+n.join("/")+i)},this.setNakedUrl=function(e){if(!e)return"";e=getUrlWithoutProxy(e),this.setUrl(e);var t=crsaRemoveUrlParameters(e);return t=pinegrow.httpServer?pinegrow.httpServer.getOriginalUrl(t):t},this.unload=function(){if(pinegrow.undoManager.purgeCs(this),this.setLocalFile(null),this.watchReloadDialog)try{this.watchReloadDialog.modal("hide")}catch(e){}pinegrow.dispatchEvent("on_stylesheet_unloaded",null,this)},this.setUrl=function(e){e=pgDecodeUrl(e);var t=this.url,s=(t?e!=t&&(pinegrow.stylesheets.updateStylesheetByKey(t,e,this),pinegrow.stylesheets.updateUsedStylesheet(t,e,this)):pinegrow.stylesheets.addStylesheetByKey(e,this),this.url=e,this.name=e.split("/").pop(),crsaIsFileUrl(e)?crsaMakeFileFromUrl(e):null),i=(s!=this.localFile&&this.setLocalFile(s),this.getSetting("locked")),n=this.getSetting("locked_reason");null!==i?(this.locked=i,this.lockedReason=n):e&&t!==e&&!s&&isApp()&&(this.locked=!0,this.lockedReason=`Remote stylesheet can't be saved.`)},this.setLocalFile=function(e){this.isWatchingFileForChanges&&this.localFile&&this.stopWatchingFileForChanges(),e=e&&e.replace(/\.css$/i,"."+this.fileType),this.localFile=e,this.localFile&&this.watchFileForChanges()},this.getLocalFileName=function(){return this.localFile||null},this.getDecodedLocalFileName=function(){var e;return this.localFile?(e=pgDecodeUrl(this.url),crsaMakeFileFromUrl(e)):null},this.isImportedFilesChanged=function(e){var t=this.importedFiles;if(t.length!=e.length)return!0;for(var s=0;s<t.length;s++)if(t[s].url!=e[s].cs.url)return!0;return!1},this.getMainParnetStylesheetFor=function(e){for(var t=this;1;){var s=pinegrow.stylesheets.getStylesheetInfo(t,e);if(!s||!s.parentPgStylesheet)break;t=s.parentPgStylesheet}return t},this.getMainParnetStylesheets=function(){var t=[];return this.forEachParentCS(function(e){0==e.parentPgStylesheets.length&&t.push(e)}),t},this.setRecursiveImportsError=function(t){this.getMainParnetStylesheets().forEach(function(e){e.recursiveImports=t})},this.checkRecursiveImports=function(i,e){function n(e){for(var t=0;t<e.length;t++){var s=e[t];if(i==s.url)return!0;if(0<s.parentPgStylesheets.length)if(n(s.parentPgStylesheets))return!0}return!1}return!!n([this])&&(e&&pinegrow.showQuickError(`Recursive imports: one of <code>${crsaGetNameFromUrl(i)}</code> parents has the same URL.`),this.recursiveImports="Loop of imports",!0)},this.isAlreadyImported=function(e){var t=this;do{if(t.url===e)return t}while(t=t.parentPgStylesheet);return!1},this.loadAllImportedFiles=function(e){var t=this.importedFiles,s=this.getImportedFiles();if(this.isImportedFilesChanged(s)){t=s,this.importedFiles=[];var i=t.length;if(0===i)e&&e();else{function n(){0===--i&&(!isApp()&&o&&g.getMainParnetStylesheets().forEach(function(e){pinegrow.stylesheets.applyToPages(e)}),e)&&e()}for(var o=!1,r=0;r<t.length;r++){var l=t[r],a=this.isAlreadyImported(l.href);a?(console.log(`${l.href} is already imported in ${a.url}!`),n()):(o=!0,this.importedFiles.push(l.cs),l.cs.loaded?n():l.cs.loadFromUrl(l.href,function(){n()}))}}}else e&&e()},this.setChanged=function(e){(this.changed=e)&&(this.changedOnce=!0),0&&pgIsDev()&&(console.log("------"),console.log(this.name+` changed: `+e),console.log("The following is not an error, it's there for debugging purposes"),console.log((new Error).stack),console.log("------"))},0);this.setNodeNeedFormatting=function(e,t,s){0==n&&!t||(s?pgcssh.forAllNodes(e,function(e){(e.need_formatting=t)?n++:n--}):(e.need_formatting=t)?n++:n--)},this.hasNodesNeedFormatting=function(){return 0<n},this.shouldFormatFile=function(){return"off"!=pinegrow.autoFormatCss&&(this.needFormatting||this.inline)},this.updateNodeFormatting=function(e,t){var s=t||this.shouldFormatFile(),i=this.hasNodesNeedFormatting();(s||i)&&(pgcssf.updateNodeRaws(e,this.inline,this.formattingOptions,s,this),this.setNeedFormatting(!1))},this.formatCode=function(e){var t=this.getSourceForRules(null,!1,!0);this.setSource(t,e,!0,!this.inline)},this.filterSource=function(e,t){return this.shouldFormatFile()?e.trim()+(this.inline?"":"\n"):e},this.getImportedStylesheetsByUniqueName=function(t){var s=null;return this.forEachStylesheet(function(e){if(e.getUniqueName()==t)return s=e,!1}),s},this.getImportedStylesheets=function(t){return t=t||[],this.importedFiles.forEach(function(e){t.push(e),e.getImportedStylesheets(t)}),t},this.needsSave=function(e){var i,n;return!(!(e=e||this.localFile)&&!this.url||(i=this.changed,(n=function(e){for(var t=0;t<e.length;t++){var s=e[t],s=(i=i||s.changed,s.importedFiles);0<s.length&&n(s)}})(this.importedFiles),!i&&(!e||crsaIsFileExist(e)||this.mappedRemote)))},this.getNodeId=function(e){return e["pg-node-id"]},this.getHtmlSourceForRule=function(o){function r(e){for(var t=0;t<e.length;t++){var s,i,n=e[t];"comment"==n.type?"delete"!=(i=g.filter(n)).haveTo&&(l=l+n.raws.before+'<span class="cm-cp-raw">',o.raws.inline?l+="//":l+="/*",l+=n.raws.left+n.text+n.raws.right,o.raws.inline||(l+="*/"),l+="</span>"):"decl"==n.type?"delete"!=(i=g.filter(n)).haveTo&&(l=(l+=n.raws.before)+('<span class="cm-cp-prop">'+n.prop+"</span>"+n.raws.between+'<span class="cm-cp-val">'+n.value+(n.important?" !important":""))+"</span>;"):"rule"==n.type?(l+=n.raws.before,s=n.selector,"update"==(i=g.filter(n)).haveTo&&(s=i.newValue),l+='<span class="cm-cp-sel">'+s+"</span>"+n.raws.between,n.ruleWithoutBody||(l+="{")):"atrule"==n.type&&(l+=n.raws.before,n.name=n.name.replace(/@/g,""),l+='<span class="cm-cp-media">@'+n.name+"</span>"+n.raws.afterName+'<span class="cm-cp-params">'+n.params+n.raws.between+"</span>",n.nodes&&!n.ruleWithoutBody?l+="{":l+=";"),n.nodes&&(n.nodes.length&&r(n.nodes),l+=n.raws.after+"}")}}var l="";return r([o]),l.trim()},this.watchFileOnFileChanged=function(e,t){var s=require("fs");if(e.mtime>t.mtime&&"1"==pinegrow.getSetting("auto-reloading","1")){var i,n=(new Date).getTime();if(g&&5e3<n-g.lastSavedAt){try{i=s.readFileSync(g.localFile,{encoding:"utf8"})}catch(e){return}console.log(g.url+" changed"),pinegrow.codeEditors.isCodeForUrlSameInExternalEditor(g.url,i,function(e){if(g.watchReloadDialog)try{g.watchReloadDialog.modal("hide"),g.watchReloadDialog=null}catch(e){}e||(g.changed?g.watchReloadDialog=showAlert("<p><b>"+g.name+"</b> was modified outside Pinegrow. The file in Pinegrow has unsaved changes. Do you want to reload it?</p><p><em>You can disable auto-reloading in Support -&gt; Settings.</em></p>","Unsaved file modified outside of Pinegrow","Don't reload","Reload from disk and lose unsaved changes",function(){g.watchReloadDialog=null},function(){g.watchReloadDialog=null,g.reload(function(){$("body").trigger("crsa-stylesheets-changed",{cs:g}),pinegrow.dispatchEvent("on_css_loaded_from_external",pinegrow.stylesheets.getPagesForStylesheet(g),g)},!0)}):g.reload(function(){$("body").trigger("crsa-stylesheets-changed",{cs:g}),pinegrow.dispatchEvent("on_css_loaded_from_external",pinegrow.stylesheets.getPagesForStylesheet(g),g)},!0))})}}},this.watchFileForChanges=function(){if(this.localFile&&"1"==pinegrow.getSetting("auto-reloading","1")){require("fs");this.nodeFileWatcher&&(g.delayedTasks.cancel("reloadFile"),this.nodeFileWatcher.close(),this.nodeFileWatcher=null);try{this.nodeFileWatcher=require("chokidar").watch(this.localFile,{persistent:!0,ignoreInitial:!0}),this.nodeFileWatcher.on("change",function(e){F.run("reloadFile",function(){g&&g.watchFileOnFileChanged({mtime:1},{mtime:0})},10)}),this.isWatchingFileForChanges=!0}catch(e){}}},this.stopWatchingFileForChanges=function(){this.localFile&&this.isWatchingFileForChanges&&(g.delayedTasks?.cancel("reloadFile"),this.nodeFileWatcher&&(this.nodeFileWatcher.close(),this.nodeFileWatcher=null),this.isWatchingFileForChanges=!1)},this.insertRule=function(e,t,s){t=t||this.getRootNode(),s=s||t.nodes.length,(t.nodes[s]=e).parent=t},this.deleteRule=function(e){var t=e.parent,s=t.nodes.indexOf(e);-1<s&&t.nodes.splice(s,1)},this.getAllRules=function(){return this.rootNode?this.rootNode.nodes:[]},this.getRules=function(t){this.rootNode?t(this.rootNode):this.regenerateRules(function(e){t(e)})},this.getRootNode=function(){return this.rootNode},this.getRuleByIndex=function(e,t){return(t=t||this.getRootNode()).nodes.length>e?t.nodes[e]:null},this.getCascadeError=function(){return this.forEachParentCS(function(e){if(e.getError())return!1}),null},this.getAllImportedFiles=function(n){function o(e){for(let i=0;i<e.length;i++){var t=e[i],s=!0;if(!1===(s=n?n(t):s))break;(s=void 0===s?!0:s)&&(r.push(t),s=t.importedFiles)&&0<s.length&&o(s)}}var r=[];return o(this.importedFiles),r},this.attachAndFill=function(e,t,s,i){var n,o=this;this.inline?PgStylesheetHelper().loadInlineStylesheet(e,function(e){o.inlineSheetPgel=e,o.setAllCssText(o.source),o.loaded?o.getCssSource(function(e){o.getError()?t&&t():pinegrow.stylesheets.applyToPages(o,t)}):t&&t()},s):((n=pinegrow.stylesheets.getStylesheetInfo(o,e))&&n.compiledStylesheet&&(o=n.compiledStylesheet),n=crsaMakeLinkRelativeTo(o.url,e.url),pgStylesheetHelper.loadStyleSheet(e,n,function(e){o.sourceStylesheet&&o.setSourceStylesheet(o.sourceStylesheet),o.loaded?o.getCssSource(function(e){o.getError()?t&&t():pinegrow.stylesheets.applyToPages(o,t)}):t&&t()},s,i))},this.attachTo=function(t,e,s,i,n){e?(g.changed||1)&&g.loaded&&!g.getError()?g.getCssSource(function(e){g.getError()?s&&s():pinegrow.stylesheets.applyToPages(g,function(){for(var e=0;e<g.importedFiles.length;e++)pinegrow.stylesheets.applyToPages(g.importedFiles[0]);g.appliedToPage=!0,s&&s()},t)}):s&&s():(this.attachAndFill(t,s,i,n),t.setPageChanged(!0))},this.reattachToAll=function(e,t){var s=0;if(g.setChanged(!0),0==e.length)t&&t();else for(var i=0;i<e.length;i++){var n=$(e[i].ownerNode),o=getCrsaPageOfElement(n);s++,this.attachTo(o,null,function(){0==--s&&t&&t()},getElementPgNode(n))}},this.detachFrom=function(e){var t=this.getPageStylesheetFrom(e);t&&(t=getElementPgNode($(t.ownerNode)))&&t.remove(),e.setPageChanged(!0)},this.isEnabledForPage=function(e){return pinegrow.stylesheets.isEnabledForPage(this,e)},this.setEnabledForPage=function(e,t){pinegrow.stylesheets.setEnabledForPage(this,e,t)},this.getProjectInfo=function(){return new pgProjectInfo(this.localFile)},this.getPropValuePairFor=function(e){var t,s,i={},n={"background-image":{startsWith:"-webkit"},background:{startsWith:"-webkit"}},o=Object.keys(n);if("rule"==e.type)for(var r=e.nodes,l=0;l<r.length;l++){var a=r[l];if("decl"==a.type){if(s=a.prop,i[s]&&!(i[s]&&-1<o.indexOf(s)))throw new Error("Rule has multiple declarations of the same property. Please use CSS properties editor to edit it.");s=a.prop,t=a.value+(a.important?" !important":""),a=void 0,(!i[s]||n[s]&&(a=n[s].startsWith)&&t.startsWith(a))&&(i[s]={value:t})}}return i},this.getBreakpoints=function(h){function e(){new RegExp(d,"i");var e=new RegExp("([0-9.]+)"+d,"g"),t=[];if(g.rootNode){var s=g.rootNode.nodes;if(s)for(var i=0;i<s.length;i++)if("atrule"==s[i].type&&"media"==s[i].name){var n=s[i].params.match(e);if(n)for(var o=0;o<n.length;o++){var r=crsaSplitCSSValue(n[o]),l=r.value,a=r.unit;"px"==a&&Math.floor(l)!=l||(s[i].params.match(new RegExp("max\\-width\\:\\s*"+l+a))&&crsaOneUpCSSValue(r),l=r.value+r.unit,t.indexOf(l)<0&&t.push(l))}}h&&h(t)}else h(t)}g?g.rootNode?e():g.compiledFileSource?g.setSource(g.compiledFileSource,function(){e()}):h([]):h([])},this.changeBreakpoint=function(e,n,o){function r(e,t){e.setSourceForRules(e.rootNode,function(){t&&t(!0)})}var l,t,s,a,h,d;return l=new RegExp(":\\s*"+escapeRegExp(e),"g"),t=crsaSplitCSSValue(e),t=crsaOneUpCSSValue(t,-1),s=crsaSplitCSSValue(n),a=crsaOneUpCSSValue(s,-1),h=new RegExp(":\\s*"+escapeRegExp(t.value+t.unit),"g"),d=!1,g.forEachStylesheet(function(e){var t=e.rootNode.nodes;if(t)for(var s,i=0;i<t.length;i++)"atrule"==t[i].type&&"media"==t[i].name&&(s=(s=t[i].params.replace(l,": "+n)).replace(h,": "+(a.value+a.unit)))!=t[i].params&&(t[i].params=s,d=!0);d&&"css"==e.fileType&&e!=g&&r(e,o)}),void(d?r(g,o):o&&o(!1))},this.updateSource=function(){this.source=this.getSource()},this.ruleValueChanged=function(e,t,s,i,n,o,r,l,a,h,d,c,u){if(t){var g,p,f=!1,S=!1,m=this;if(this.canEdit(!1,!0)){if(""===s||null==s?s=null:s+="",null!==s&&(0<s.indexOf("!important")&&(s=s.replace("!important",""),S=!0),s=s.trim()),this.forgetCachedSource(),"object"==typeof t?(g=[t],a=!1,t=t.prop):g=pinegrow.pgPostCSSHelper.getChildrenDeclWithPropName(e,t),0<g.length&&!a){if(null!==s||n){var y=g[0];"last"===h&&(y=g[g.length-1]),pgcssh.setNodeProperty(y,"value",s),y.important=S,r&&pinegrow.dispatchEvent("on_css_node_updated",null,{node:y,stylesheet:this,edited_by:o,oldValue:pgcssh.getNodeOldValues(y),undoCombineKey:"ruleValueChanged_"+t,undoRuleName:"string"==typeof r?r:null,undoIgnore:d})}else{function w(e){r&&pinegrow.dispatchEvent("on_css_before_node_deleted",null,{node:e,stylesheet:m,edited_by:o,undoIgnore:d}),pinegrow.pgPostCSSHelper.removeNodeFrom(e,e.parent),pinegrow.dispatchEvent("on_css_node_deleted",null,{node:e,stylesheet:m,edited_by:o,undoIgnore:d})}if("all"===h)for(var v=0;v<g.length;v++)w(g[v]);else w("last"===h?g[g.length-1]:g[0])}f=!0}else null!==s&&((y=pinegrow.pgPostCSSHelper.createNode("decl",t,s,e,this)).important=S,S=void 0===u||u<0?pinegrow.pgPostCSSHelper.getLastDeclIndex(e)+1:u,pinegrow.pgPostCSSHelper.insertNodeAt(y,e,S),r&&pinegrow.dispatchEvent("on_css_node_added",null,{node:y,stylesheet:this,edited_by:o,undoIgnore:d}),f=!0);return"skip"==l&&(f=!1),"do"==l&&(f=!0),!1===c||f&&!c?this.updateSingleRule?this.updateSingleRule(e,i,t,s):(p=pinegrow.pgPostCSSHelper.getRootNodeFor(e),S="setSourceForRules",i?(F.cancel(S),this.setSourceForRules(p,i,!1,!0)):F.run(S,function(){m.setSourceForRules(p,i,!1,!0)},250)):(this.updateSource(),i&&i()),y}i&&i()}},this.ruleMediaChanged=function(e,t,n,o){var r,l,a,h,d,s,i,c,u;this.canEdit(!1,!0)&&this.canAddChangeMediaQuery()?(r=[],l=null,h=a=!1,this.forgetCachedSource(),(d=pinegrow.pgPostCSSHelper.getMediaNode(e))?1==d.nodes.length?(d.params=t)?a=!0:(pinegrow.dispatchEvent("on_css_before_node_deleted",null,{node:e,stylesheet:this,edited_by:o,will_be_added:!0}),pinegrow.dispatchEvent("on_css_before_node_deleted",null,{node:d,stylesheet:this,edited_by:o}),pinegrow.pgPostCSSHelper.replaceNodeWith(d,e),l=pinegrow.pgPostCSSHelper.getNodeIndices(e),r.push(l)):(pinegrow.dispatchEvent("on_css_before_node_deleted",null,{node:e,stylesheet:this,edited_by:o,will_be_added:!0}),t?(u=pinegrow.pgPostCSSHelper.createNode("atrule","media",t,null,this),pinegrow.pgPostCSSHelper.insertNodeAfter(u,d),pinegrow.pgPostCSSHelper.insertNodeInside(e,u),r.push(pinegrow.pgPostCSSHelper.getNodeIndices(u)),r.push(pinegrow.pgPostCSSHelper.getNodeIndices(e)),h=!0):(e.next()?pinegrow.pgPostCSSHelper.insertNodeBefore(e,d):pinegrow.pgPostCSSHelper.insertNodeAfter(e,d),r.push(pinegrow.pgPostCSSHelper.getNodeIndices(e))),l=pinegrow.pgPostCSSHelper.getNodeIndices(e),pinegrow.pgPostCSSHelper.removeNodeFrom(e,d)):t&&(u=function(e){return e?(e||"").replace(/\s/g,""):null},pinegrow.dispatchEvent("on_css_before_node_deleted",null,{node:e,stylesheet:this,edited_by:o,will_be_added:!0}),i=s=!1,(c=e.prev())&&"atrule"==c.type?u(c.params)==t&&(d=c,s=!0):(c=e.next())&&u(c.params)==t&&(d=c,i=s=!0),s?(pinegrow.pgPostCSSHelper.removeNodeFrom(e),i?pinegrow.pgPostCSSHelper.insertNodeAt(e,d,0):pinegrow.pgPostCSSHelper.insertNodeInside(e,d),r.push(pinegrow.pgPostCSSHelper.getNodeIndices(e))):(d=pinegrow.pgPostCSSHelper.createNode("atrule","media",t,null,this),pinegrow.pgPostCSSHelper.replaceNodeWith(e,d),pinegrow.pgPostCSSHelper.insertNodeInside(e,d),r.push(pinegrow.pgPostCSSHelper.getNodeIndices(d))),l=pinegrow.pgPostCSSHelper.getNodeIndices(e)),u=pinegrow.pgPostCSSHelper.getRootNodeFor(e),this.setSourceForRules(u,function(){for(var e,t=g.getRootNode(),s=0;s<r.length;s++){var i=pinegrow.pgPostCSSHelper.getNodeByIndices(t,r[s]);pinegrow.dispatchEvent("on_css_node_added",null,{node:i,stylesheet:g,edited_by:o})}n&&n(h),l&&(e=pinegrow.pgPostCSSHelper.getNodeByIndices(t,l),pinegrow.selectRule(e,{will_be_added:!0})),a&&pinegrow.dispatchEvent("on_css_node_updated",null,{node:d,stylesheet:g,edited_by:o})})):n&&n(!1)},this.ruleSupportsAtruleChanged=function(e,t,s,i){var n,o,r,l,a;this.canAddChangeMediaQuery()?(n=[],o=null,r=!1,this.forgetCachedSource(),(l=pinegrow.pgPostCSSHelper.getSupportsAtruleNode(e))?1==l.nodes.length?(l.params=t)?pinegrow.dispatchEvent("on_css_node_updated",null,{node:l,stylesheet:this,edited_by:i}):(pinegrow.dispatchEvent("on_css_before_node_deleted",null,{node:e,stylesheet:this,edited_by:i,will_be_added:!0}),pinegrow.dispatchEvent("on_css_before_node_deleted",null,{node:l,stylesheet:this,edited_by:i}),pinegrow.pgPostCSSHelper.replaceNodeWith(l,e),o=e,n.push(e)):(pinegrow.dispatchEvent("on_css_before_node_deleted",null,{node:e,stylesheet:this,edited_by:i,will_be_added:!0}),t?(a=pinegrow.pgPostCSSHelper.createNode("atrule","supports",t,null,this),pinegrow.pgPostCSSHelper.insertNodeBefore(a,l),pinegrow.pgPostCSSHelper.insertNodeInside(e,a),n.push(a),n.push(e),r=!0):(pinegrow.pgPostCSSHelper.insertNodeBefore(e,l),n.push(e)),o=e,pinegrow.pgPostCSSHelper.removeNodeFrom(e,l)):t&&(pinegrow.dispatchEvent("on_css_before_node_deleted",null,{node:e,stylesheet:this,edited_by:i,will_be_added:!0}),l=pinegrow.pgPostCSSHelper.createNode("atrule","supports",t,null,this),pinegrow.pgPostCSSHelper.replaceNodeWith(e,l),pinegrow.pgPostCSSHelper.insertNodeInside(e,l),o=e,n.push(l)),a=pinegrow.pgPostCSSHelper.getRootNodeFor(e),this.setSourceForRules(a,function(){for(var e=0;e<n.length;e++)pinegrow.dispatchEvent("on_css_node_added",null,{node:n[e],stylesheet:g,edited_by:i});s&&s(r),o&&pinegrow.selectRule(o,{will_be_added:!0})})):s&&s(!1)},this.genRuleValueChangedByIds=function(e,t,s){var i=pinegrow.pgPostCSSHelper.getNodeByIndices(this.getRootNode(),e);this.ruleValueChanged(i,t,s)},this.getNodeWithPgId=function(n){var o=function(e){for(var t=0;t<e.length;t++){var s=e[t],i=s["pg-node-id"]||-1;if(s.selector&&(i=-1==i&&(matchedId=s.selector.match(/\.pg-node-id-([0-9]+)/))&&0<matchedId.length?matchedId[1]:i)==n)return s;if(s.nodes&&0<s.nodes.length){i=o(s.nodes);if(i)return i}}};return!this.ignore&&o(this.getRootNode().nodes)||null},this.fileSavedInEditor=function(){this.fileSaved()},this.fileSaved=function(){this.setChanged(!1)},this.isVarValue=function(e){return e.startsWith("$")||e.startsWith("@")},this.isDeclVarNode=function(e){return"decl"==e.type&&e.prop[0]==this.getDeclCharachter()},this.filterRuleObjects=function(e){for(var t in e){var s=t.match(/\,\s\.pg-node-id-[0-9]*/);s&&0<s.length&&delete e[t]}return e},this.removeSuper=function(){for(var t,s=this,e=(!isApp()&&this.url&&this.loaded&&(t=pinegrow.getCurrentProject())&&(n=t.getRelativeUrl(this.url),crsaIsAbsoluteUrl(n)||this.getCssSource(function(e){t.setContentOfUrl(s.url,e)})),pinegrow.dispatchEvent("on_stylesheet_closed",null,this),pinegrow.stylesheets.removeStylesheetByKey(this.url),this.ignore&&!this.elementStyle&&pinegrow.undoManager.purgeCs(this),this.importedFiles),i=0;i<e.length;i++)e[i]&&e[i].remove(),e[i]=null;this.importedFiles=[];var n=pinegrow.getSelectedRule(),n=(n&&(n=pinegrow.pgPostCSSHelper.getRootNodeFor(n)).pgStylesheet&&n.pgStylesheet.getUniqueName()===this.getUniqueName()&&!this.elementStyle&&$.fn.crsa("selectRule",null,null),this.stylePane&&(this.stylePane.remove(),this.stylePane=null),this.stopWatchingFileForChanges(),this.getRootNode());n&&(n.pgStylesheet=null),F.destroy(),this.isDestroyed=!0,s=null},this.getFilteredSource=function(){return this.filterSource(this.getSource())},this.forgetSourceErrors=function(){}};