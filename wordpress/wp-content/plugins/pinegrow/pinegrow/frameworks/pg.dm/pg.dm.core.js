class PgDmDesignProvider{constructor(e,t){this.key=e||"generic",this.name=t||"Generic design provider",this.skills=[],this.engine=null,this.colors=null,this.settings={},this.settings_key="design-settings",this.setDefaultSettings()}setDefaultSettings(){this.settings={}}setSettings(e,t){var i=this,n=($.each(e,function(e,t){i.settings[e]=t}),t||pgDmStore.update(),pinegrow.getCurrentProjectInfo());n.setSetting(this.settings_key,this.settings),n.save()}firstActivateInProject(e){e&&e()}onActivated(){}activate(){this.engine&&(this.engine.destroy(),this.engine=null),this.setDefaultSettings();var e=pinegrow.getCurrentProjectInfo().getSetting(this.settings_key,null);e&&(this.settings=$.extend(this.settings,e))}deactivate(){}onProjectLoaded(e){}onColorListChanged(){}getEngine(e){console.error("PgDmDesignProvider.getEngine should be implemented by provider.")}addSkill(e){this.skills.push(e)}getSkills(){return this.skills}getColorsForPicker(){return this.colors.getColorsForPicker()}canEditColors(){return!1}supportsColorShades(){return!1}getActiveFonts(){return[]}getStylesheetUrl(){return this.engine?this.engine.getStylesheetUrl():project.getUrl()}}var PgDmSkill=PgDmAddOn=function(e,t,i){var c=this,n=(this.key=e,this.name=t,this.description=null,this.controls={},this.params={},this.value_sources={},{key:e,name:t,fields:this.controls});pgDmStore.registerSkill(this),this.isSet=function(e){var i=!1;return $.each(e,function(e,t){if(null!==t)return i=!0,!1}),i},this.getParam=function(e,t){return t[e]||null},this.setParam=function(e,t){var i=this.key+"."+e;this.params[i]=t},this.addControl=function(e,t){t.key=this.key+"."+e,(this.controls[t.key]=t).subkey=e,t.action="custom",t.set_value=this.controlSetValue.bind(this),t.get_value=this.controlGetValue.bind(this),t.on_field_updated=function(e,t,i,n){var s=t.get(0),o=!1,r=!0,a=(s.parentNode.classList.contains("crsa-field")&&(o=!0,r=!s.previousSibling||"LABEL"===s.previousSibling.nodeName),s.querySelector("label")),l=null;s.classList.contains("inherited-value")&&(s.classList.remove("inherited-value"),a)&&a.removeAttribute("title"),o&&r&&(s.parentNode.classList.remove("inherited-value"),l=s.parentNode.querySelector("label"))&&l.removeAttribute("title"),(r=c.value_sources[i.subkey])&&"size"===r.type&&(r=`Set for ${r.size.name_short} and up.`,s.classList.add("inherited-value"),a&&a.setAttribute("title",r),o)&&(s.parentNode.classList.add("inherited-value"),l)&&l.setAttribute("title",r)},t.on_changed=function(e,t,i,n,s,o,r,a,l){var c=o.get(0),u=!1;c.parentNode.classList.contains("crsa-field")&&(u=!0),c.classList.contains("inherited-value")&&c.classList.remove("inherited-value"),u&&(c.parentNode.querySelector(".inherited-value")?c.parentNode.classList.add("inherited-value"):c.parentNode.classList.remove("inherited-value"))},"color"==t.type&&(t.palette=function(){return pgDmStore.design.getColorPalette()})},this.getControl=function(e){return this.controls[this.key+"."+e]||null},this.getPropSection=function(e){return n},this.controlSetValue=function(e,t,i,n,s,o){return pgDmStore.setSkillParam(e,this,o,t),t},this.controlGetValue=function(e,t,i,n,s){this.value_sources[n.subkey]=null;var o=pgDmStore.getSkillParam(e,this,n);if(null!==o)return this.value_sources[n.subkey]={type:"own"},o;if(!s)for(var r=pgDmStore.design.getDeviceSizes(),a=!0,l=pgDmStore.getCurrentSize(),c=r.length-1;0<=c;c--)if(r[c].size===l)a=!1;else if(!a&&null!==(o=pgDmStore.getSkillParam(e,this,n,r[c].size)))return this.value_sources[n.subkey]={type:"size",size:r[c]},o;return null},this.getCSS=function(e,t){return this.onGetCSS(e,t)},this.getConfigObject=function(e,t){this.onGetConfigObject&&this.onGetConfigObject(e,t)},this.getHTMLForStyleDisplay=function(e){return""},i&&i.call(this)};class PgDmDesignSkill{constructor(e,t,i){this.node=null,this.key=e,this.name=t,this.description=null,this.controls={},this.params={},this.locked={},this.$locks={},this.fields={},this.value_sources={},this.section={key:e,name:t,fields:this.controls},i&&i.call(this)}load(n){var s=this;this.node=n,$.each(this.controls,function(e,t){var i=pgDmStore.isParamLocked(s,t.subkey,t.dm_locked||!1);s.updateLockedStatusForControl(t.subkey,i)}),this.onLoad?this.onLoad(n):$.each(this.controls,function(e,t){var i=n.getAttribute(t.subkey);null===i&&"default_value"in t&&(i=t.default_value),s.params[t.subkey]=i,pgDmStore.design.setDesignParameter(s,t.subkey,i)})}populateDefaultParams(){}getParam(e,t){var i=this.params[e]||t||null;if(null===(i=this.onGetParam?this.onGetParam(e,i):i)){var n=this.key+"."+e;if(this.controls[n]&&this.controls[n].default_value)return this.controls[n].default_value}return i}setParam(e,t,i){var n=this;this.params[e]=t,pgDmStore.design.setDesignParameter(this,e,t),i||pgDmStore.db.makeChanges(null,"Set design parameter",function(){n.onSetParam?n.onSetParam(e,t):n.node.setAttribute(e,t)},"design_panel")}surpriseMeForRangeControls(e){var i=this;$.each(this.controls,function(e,t){t.dm_no_lock||"placeholder"===t.dm_no_lock||"range"!==t.type||i.isLocked(t.subkey)||i.setParam(t.subkey,getRand("magic_range_min"in t?t.magic_range_min:t.range_min,"magic_range_max"in t?t.magic_range_max:t.range_max))}),e&&e()}surpriseMe(e){return this.onSurpriseMe?this.onSurpriseMe(e):e&&e()}isLocked(e){return this.locked[e]||!1}updateLockedStatusForControl(e,t){this.locked[e]=t,this.$locks[e]&&(t?this.$locks[e].addClass("like"):this.$locks[e].removeClass("like"))}addControl(l,c){var u=this;c.key=this.key+"."+l,(this.controls[c.key]=c).subkey=l,c.action="custom",c.set_value=this.controlSetValue.bind(this),c.get_value=this.controlGetValue.bind(this),c.skip_did_change=!0,c.type,c.dm_locked&&(this.locked[l]=!0);c.on_field_updated=function(e,t,i,n){},c.on_fields_created=function(e,t,i,n,s,o,r,a){!r&&("button"!==n.type||"dm_no_lock"in n&&!1===n.dm_no_lock)&&(n.dm_no_lock?"placeholder"===n.dm_no_lock&&(r=s,$('<div class="pg-dm-like pg-dm-lock-'+l+'"><i class="open icon icon-Lock_closed" style="visibility:hidden;"></i></div>').appendTo(r)):(n=s,u.$locks[l]=$('<div class="pg-dm-like pg-dm-lock-'+l+(u.locked[l]?" like":"")+'"><i class="closed icon icon-Lock_open"></i><i class="open icon icon-Lock_closed"></i></div>').appendTo(n).on("click",function(e){e.preventDefault();var t=!(u.locked[c.subkey]||0);u.locked[c.subkey]=t,pgDmStore.setParamLocked(u,c.subkey,t),t?$(this).addClass("like"):$(this).removeClass("like")}),addTooltip(u.$locks[l],"Lock to keep Surprise Me from changing this design option."))),u.fields[l]=a},c.default_value}getControl(e){return this.controls[this.key+"."+e]||null}getField(e){return this.fields[e]||null}getSection(){return this.section}controlSetValue(e,t,i,n,s,o){return this.setParam(o.subkey,t),pgDmStore.update(),t}controlGetValue(e,t,i,n,s){var o=pgDmStore.design.getDesignParameter(this,n.subkey);return o=null===o&&n.default_value?n.default_value:o}setVar(e,t){return`$${e}: ${t};
`}getCSS(e,t){return this.onGetCSS(e,t)}getHTMLForStyleDisplay(e){return""}onGetCSS(e){return""}onGetConfigObject(e,t){}}var PgDmStyle=function(e){var i;this.items={},this.items_size_map={},this.store=pgDmStore,this.current_state=null,e instanceof pgParserNode?(this.node=e,this.name=this.node.getAttribute("name"),this.selector=this.node.getAttribute("selector"),this.node_items=this.node.findOne("dmitems"),(i=this).node_items.children.forEach(function(e){var t;"dmitem"==e.tagName&&(t=new PgDmSkillItem(e),i.items[t.getKey()]=t)}),this.updateSizeMap()):(this.name=e,this.selector="."+pgDmStore.class_prefix+this.name,this.node=pgCreate(`<dmstyle name="${this.name}" selector="${this.selector}"><dmitems></dmitems></dmstyle>`),this.node_items=this.node.findOne("dmitems"))},PgDmSkillItem=(PgDmStyle.prototype.addSkillItem=function(e){var t=new PgDmSkillItem(e),i=(t.setSize(this.store.getCurrentSize()),t.setState(this.store.getCurrentState()),t.getKey());return this.items[i]=t,this.node_items.append(t.node),this.updateSizeMap(),t},PgDmStyle.prototype.removeSkillItem=function(e){},PgDmStyle.prototype.updateSizeMap=function(){var t=this,n=(this.items_size_map={},pgDmStore.design.getDeviceSizes().forEach(function(e){t.items_size_map[e.size]=[]}),this.items_size_map);$.each(this.items,function(e,t){var i=t.size;t.size&&n[i]&&n[i].push(t)})},PgDmStyle.prototype.getItemsForSize=function(e){return this.items_size_map[e]||[]},PgDmStyle.prototype.setSkillParam=function(e,t,i){(this.getSkillItem(e)||this.addSkillItem(e)).setParam(t,i)},PgDmStyle.prototype.getSkillParam=function(e,t,i){var n=this.getSkillItem(e,i);return n?n.getParam(t):null},PgDmStyle.prototype.getSkillItem=function(e,t){var i=this.store.getSkillItemKey(e,t);return this.items[i]||!1},PgDmStyle.prototype.getStates=function(){var i={};return $.each(this.items,function(e,t){i[t.state]=!0}),i},PgDmStyle.prototype.getCSS=function(){var s=this,o="",r=pgDmStore.default_size,t=["none","hover","active","focus"];return $.each(this.items_size_map,function(i,e){var n={none:"",hover:"",active:"",focus:""};e.length&&e.forEach(function(e){n[e.state]+=e.getCSS(s)}),t.forEach(function(e){var t;n[e].length&&(t=s.selector,"none"!==e&&(t+=":"+e),o+=i==r?t+` {
${n[e]} 
}`:`@include media-breakpoint-up(${i}) {
 ${t} {
${n[e]} 
} 
}`)})}),o},PgDmStyle.prototype.getHTMLForStyleDisplay=function(){var s="",o=(pgDmStore.default_size,["none","hover","active","focus"]);return $.each(this.items_size_map,function(e,t){var i={none:"",hover:"",active:"",focus:""},n=!1;t.length&&t.forEach(function(e){var t=e.getHTMLForStyleDisplay();t.length&&(i[e.state]+=t,n=!0)}),n&&(s+=`<div class="pg-dm-style-list-item-preview-size"><label>${e}</label>`,o.forEach(function(e){i[e].length&&(s=(s+=`<div class="pg-dm-style-list-item-preview-state"><label>${e}</label>`)+i[e]+"</div>")}),s+="</div>")}),s},function(e){var t,i;this.params={},this.size=pgDmStore.default_size,this.state=pgDmStore.default_state,e instanceof pgParserNode?(this.node=e,t=this.node.getAttribute("skill"),this.skill=pgDmStore.getSkillByKey(t),(i=this).node.getAttrList().forEach(function(e){"skill"!==e.name&&"size"!==e.name&&"state"!==e.name&&null!==e.value&&(i.params[e.name]=e.value)}),this.size=this.node.getAttribute("size")||pgDmStore.default_size,this.state=this.node.getAttribute("state")||pgDmStore.default_state,"normal"==this.state&&(this.state="none")):(this.skill=e,this.node=pgCreate(`<dmitem skill="${this.skill.key}"></dmitem>`),this.node.setAttribute("size",this.size),this.node.setAttribute("state",this.state))}),PgDmFont=(PgDmSkillItem.prototype.setSize=function(e){this.size=e,this.node.setAttribute("size",this.size)},PgDmSkillItem.prototype.setState=function(e){this.state=e,this.node.setAttribute("state",this.state)},PgDmSkillItem.prototype.getKey=function(){return pgDmStore.getSkillItemKey(this.skill,this.size,this.state)},PgDmSkillItem.prototype.isSet=function(){return this.skill.isSet(this.params)},PgDmSkillItem.prototype.getParam=function(e){return this.params[e.subkey]||null},PgDmSkillItem.prototype.setParam=function(e,t){null!==(this.params[e.subkey]=t)?this.node.setAttribute(e.subkey,t):this.node.removeAttribute(e.subkey)},PgDmSkillItem.prototype.getSkill=function(){},PgDmSkillItem.prototype.getDeviceSize=function(){},PgDmSkillItem.prototype.getState=function(){},PgDmSkillItem.prototype.getCSS=function(e){return this.skill.isSet(this.params)?this.skill.getCSS(this.params,e):""},PgDmSkillItem.prototype.getHTMLForStyleDisplay=function(){return this.skill.getHTMLForStyleDisplay(this.params)},function(){this.family=null,this.weight=null,this.italic=!1,this.key=null,this.getInitCSS=function(){return""},this.getRuleCSS=function(){return`@include m-font-${this.key};
`}}),PgDmFonts=function(){this.fonts={},this.clear=function(){this.fonts={}},this.setFont=function(e){this.fonts[e.key]=e},this.getFont=function(e){return this.fonts[e]},this.getInitCSS=function(){var i="";return $.each(this.fonts,function(e,t){i+=t.getInitCSS()}),i},this.getGoogleFontsUrl=function(){var n=[];return $.each(this.fonts,function(e,t){var i=pinegrow.fontLibrary.getFontByFamily(t.family);i&&"google"===i.type&&n.push(i.getGoogleFontUrlToken())}),$.each({},function(e,t){}),n.length?"https://fonts.googleapis.com/css?family="+n.join("|")+"&display=swap":null},this.getRemoteFontsUrls=function(){var s=[];return $.each(this.fonts,function(e,t){var i,n=pinegrow.fontLibrary.getFontByFamily(t.family);!n||"remote"!==n.type&&"adobe"!==n.type?n&&"local"===n.type&&(i=n.getUrl(),s.indexOf(i)<0)&&s.push(i):s.indexOf(n.url)<0&&s.push(n.url)}),s},this.getUsedFonts=function(){var n=[];return $.each(this.fonts,function(e,t){var i=pinegrow.fontLibrary.getFontByFamily(t.family);i&&n.indexOf(i)<0&&n.push(i)}),n},this.getFontUrls=function(){var t=[],e=this.getGoogleFontsUrl();return e&&t.push(e),this.getRemoteFontsUrls().forEach(function(e){t.push(e)}),t},this.getImportStatements=function(t){var i=pinegrow.getCurrentProject();return this.getFontUrls().map(function(e){return`@import url('${e=t&&i.isUrlInProject(e)?crsaMakeLinkRelativeTo(e,t):e}');`})},this.getFontFontFaceStatements=function(){var n=[];return $.each(this.fonts,function(e,t){var i=pinegrow.fontLibrary.getFontByFamily(t.family);i&&(i=i.getCode()).css&&n.indexOf(i.css)<0&&n.push(i.css)}),n}},PgDmDesign=function(){this.node=pgCreate(`<dmdesign active></dmdesign>`),this.fonts_node=this.node.findOne("dmfonts"),this.colors_node=this.node.findOne("dmcolors");var s={},n=[];this.palettes=new PgDmPalettes;this.options={default_font_types:["heading","lead","text"],font_sizes:{min:-2,max:6},max_fonts:10,max_colors:10,reserved_colors:[{name:"light",color:"#fff"},{name:"gray",color:"#888"},{name:"dark",color:"#000"}],palette:null,device_sizes:[{size:"xs",name_short:"XS",name:"Extra Small",breakpoint:0,w:320,icon:"icon-Xs"},{size:"sm",name_short:"SM",name:"Small",breakpoint:576,w:640,icon:"icon-IPAD"},{size:"md",name_short:"MD",name:"Medium",breakpoint:768,w:768,icon:"icon-tableta-lezeca"},{size:"lg",name_short:"LG",name:"Large",breakpoint:992,w:1024,icon:"icon-ikone100--copy_laptop"},{size:"xl",name_short:"XL",name:"Extra Large",breakpoint:1200,w:1280,icon:"icon-Lg"}]};for(var e=0;e<this.options.device_sizes.length;e++)e===this.options.device_sizes.length-1?this.options.device_sizes[e].w_range=[this.options.device_sizes[e].breakpoint,99999]:this.options.device_sizes[e].w_range=[this.options.device_sizes[e].breakpoint,this.options.device_sizes[e+1].breakpoint-1];this.getDeviceSizes=function(){return this.options.device_sizes},this.getDeviceSizeDef=function(e){for(var t=0;t<this.options.device_sizes.length;t++)if(this.options.device_sizes[t].size===e)return this.options.device_sizes[t]},this.fonts=new PgDmFonts,this.getFont=function(e){return this.fonts.getFont(e)},this.getFontDeclarationForCSS=function(e){return`    @include m-font-${e};
`},this.getFontTypes=function(){for(var e,t=[],i=1;i<=this.options.max_fonts;i++)i<=this.options.default_font_types.length?t.push(this.options.default_font_types[i-1]):(e=s[`fonts.font_${i}_name`]||null)&&t.push(e);return t},this.getFontSizeForCSS=function(e){var t,i;return("string"!=typeof(t=e)||!t.match(/[a-z\%\$]/))&&(i=parseFloat(e))>=this.options.font_sizes.min&&i<=this.options.font_sizes.max?`map-get($m-sizes, ${i})`:e},this.getDesignParameter=function(e,t){var i=("object"==typeof e?e.key:e)+`.`+t;return i in s?s[i]:null},this.setDesignParameter=function(e,t,i){var n=e.key+`.`+t;s[n]=i},this.getColorForCSS=function(e){var t=e.split("-");return 2===t.length?`m-color(${t[0]}, ${t[1]})`:null},this.findColorByName=function(e){for(var t=0;t<n.length;t++)if(n[t].name===e)return n[t]},this.setColor=function(e,t,i){n.length<=e?n.push({name:t,color:chroma(i),idx:e}):(n[e].color=chroma(i),n[e].name=t)};for(e=0;e<this.options.max_colors;e++)n.push({name:"",color:null,idx:e});this.options.max_custom_colors=this.options.max_colors-this.options.reserved_colors.length;for(var t=this.options.max_custom_colors,e=0;e<this.options.reserved_colors.length;e++){var i=this.options.reserved_colors[e];this.setColor(t,i.name,i.color),this.setDesignParameter("colors",`color`+t,i.color),t++}this.renameColor=function(e,t){var i=this.findColorByName(e);i&&(i.name=t)},this.getColors=function(){for(var e=[],t=0;t<n.length;t++)n[t].name&&e.push(n[t]);return e},this.getColorPalette=function(){return this.options.palette},this.setColorPalette=function(e){this.options.palette=e};var o=.25,r=(this.setColorInterval=function(e){o=e/100},{"-2":"darker","-1":"dark",0:"normal",1:"light",2:"lighter"});this.getColorShade=function(e,t){var i=o*t;return 0==t?e:t<0?e.darken(-i):e.brighten(i)},this.getColorShadeSASSCode=function(e,t){var i=parseInt(o*t*100);return 0==t?e:`scale-color(${e}, $lightness: ${i}%)`},this.getColorShadeDescriptions=function(){return r}},PgDmElementStateManager=function(){var e=!1;this.setState=function(t){e&&pinegrow.getAllPageViews().forEach(function(e){e.getDocument().querySelectorAll(".pg-state-hover,.pg-state-active,.pg-state-focus").forEach(function(e){e.classList.remove("pg-state-hover","pg-state-active","pg-state-focus")})}),e=!1,"none"!=t&&(pinegrow.selectedElements.forEachElement(function(e){e.get$DOMElements().forEach(function(e){e.addClass("pg-state-"+t)})}),e=!0)}},PgDmStore=function(){function i(e,t){var i=pinegrow.getCurrentProjectInfo().getSetting("active-design-provider")||t.lesson?.design_provider_key||null;i&&r.activateDesignProvider(i,!0),pgDmStore.load(),pinegrow.getAllPages().forEach(function(e){p(e)}),r.designPanel.updatePanelDisplay()}function n(){m&&(m.destroyEngine(),m=null),r.designs_node=null,r.design.node=null,r.locked_node=null,r.designPanel.updatePanelDisplay()}function s(){pgDmStore.isDesignEnabled()&&m.getEngine(function(e){e.saveCSS()})}function o(e,i){pgDmStore.isDesignEnabled()&&(i.settings||(i.settings={}),i.settings.color||(i.settings.color={}),i.settings.color.palette=[],m.getColorsForPicker().forEach(function(e){e.forEach(function(e){i.settings.color.palette.push({color:e.color,name:e.name,slug:e.name})})}),i.settings.typography||(i.settings.typography={}),i.settings.typography.fontFamilies=[],m.getActiveFonts().forEach(function(e){var t=pinegrow.fontLibrary.getFontByFamily(e);t&&i.settings.typography.fontFamilies.push(t.getWPFontFamilyDeclaration())}))}var r=this,t={},a=[],l={},c={},u=(this.class_prefix="m-",this.db=null,this.designs_node=null,this.locked_node=null,this.default_size="xs",this.default_state="none",null),g=this.default_size,d=this.default_state,h=(this.design=new PgDmDesign,this.stateManager=new PgDmElementStateManager,this.fontLibrary=new PgDmFontLibrary,this.localImages=new PgRandomLocalImage,{}),m=null,p=(this.registerDesignProvider=function(e,t){h[e]=t},this.activateDesignProvider=function(e,t){var i=m;(m=h[e]||null)&&i!==m&&(m.activate(),c={},m.getSkills().forEach(function(e){r.registerDesignSkill(e)}),i&&i.deactivate(),m.onActivated()),t||((i=pinegrow.getCurrentProjectInfo()).setSetting("active-design-provider",e),i.save())},this.getActiveDesignProvider=function(){return m},this.registerSkill=function(e){t[e.key]=e},this.getSkillByKey=function(e){return t[e]||null},this.registerDesignSkill=function(e){c[e.key]=e},this.getDesignSkill=function(e){return c[e]||!1},this.forEachDesignSkill=function(i){$.each(c,function(e,t){i(t)})},this.save=function(){var e=pinegrow.getCurrentProject();require("path"),require("fs");e.requireDB(function(e){},!1)},this.addNewDesign=function(e){pgDmStore.db.makeChanges(null,e?"Duplicate design":"Add design",function(){var i=(e||pgDmStore.design.node).clone();e?i.insertAfter(e):r.designs_node.append(i),r.forEachDesignSkill(function(e){var t=i.findOne(`dmdesignskill[skill="${e.key}"]`);t?e.load(t):((t=pgCreate(`<dmdesignskill skill="${e.key}"></dmdesignskill>`)).appendTo(i),e.load(t),e.populateDefaultParams())}),r.setActiveDesign(i)},"design_panel")},this.deleteDesign=function(t){1===r.designs_node.find("dmdesign").length?pinegrow.showQuickError("Can not delete the only design. A project needs at least one design."):pgDmStore.db.makeChanges(null,"Delete design",function(){var e=null;t.hasAttribute("active")&&(e=t.next()||t.prev()),t.remove(),e&&r.setActiveDesign(e)},"design_panel")},this.getActiveDesignNode=function(){var e=this.designs_node.findOne("dmdesign[active]");return e||this.designs_node.findOne("dmdesign")},this.setActiveDesign=function(i){var e=this,t=e.designs_node.findOne("dmdesign[active]")!==i;this.designs_node.withoutEvents(function(){e.designs_node.find("dmdesign[active]").forEach(function(e){e.removeAttribute("active")}),i.setAttribute("active",null)}),this.forEachDesignSkill(function(e){var t=i.findOne(`dmdesignskill[skill="${e.key}"]`);t?e.load(t):(t=pgCreate(`<dmdesignskill skill="${e.key}"></dmdesignskill>`),i.append(t),e.load(t),e.populateDefaultParams())}),t&&(pinegrow.getCurrentProject().db.is_changed=!0),this.design.node=i,e.update(),e.designPanel.updatePanelDisplay()},this.isDesignEnabled=function(e){var t=null!==r.designs_node&&null!==m;return t=!e||!t||m instanceof e?t:!1},this.load=function(i){var e=pinegrow.getCurrentProject();require("path"),require("fs");e.requireDB(function(e){var t;r.db=e,r.designs_node=i?e.getOrCreateNode("dmdesigns"):e.findOne("dmdesigns"),r.designs_node?(r.locked_node=e.getOrCreateNode("dmlocked"),(t=r.designs_node.findOne("dmdesign[active]")||r.designs_node.findOne("dmdesign"))||(t=pgCreate(`<dmdesign active></dmdesign>`),r.designs_node.append(t)),r.designPanel.show(),r.setActiveDesign(t),pinegrow.dispatchEvent("on_dm_project_loaded",null)):r.designPanel.show()},!i)},this.addClass=function(e){},this.setParamLocked=function(e,t,i){var n=(e.key+"-"+t).replace(/\./g,"-");this.locked_node&&(i?this.locked_node.setAttribute(n,"true"):this.locked_node.setAttribute(n,"false"),this.db.is_changed=!0)},this.isParamLocked=function(e,t,i){void 0===i&&(i=!1);var n=(e.key+"-"+t).replace(/\./g,"-");return this.locked_node&&this.locked_node.hasAttribute(n)?"true"===this.locked_node.getAttribute(n):i},this.surpriseMe=function(t){this.forEachDesignSkill(function(e){(!t||t.indexOf(e)<0)&&e.surpriseMe()}),this.update(),this.designPanel.updatePanelDisplay()},this.makeDesignFromPhoto=function(t,i){var n=pgDmStore.getDesignSkill("colors"),e=n.getParam("harmony");n.getPaletteFromImage(t,function(){var e=pgDmStore.getDesignSkill("background");e.setParam("image",t),i?pgDmStore.surpriseMe([n,e]):(this.update(),this.designPanel.updatePanelDisplay())},null,e)},this.assignStyle=function(e,t){var i=t.selector.replace(".","");e.hasClass(i)||e.addClass(i)},this.assignStyleToSelectedElements=function(t){var i=this;pinegrow.selectedElements.forEachElement(function(e){i.assignStyle(e,t)})},this.rememberSelectedStyleForSelectedElements=function(t){pinegrow.selectedElements.forEachElement(function(e){e.setData("dm-selected-style",t)})},this.getPropSections=function(n){var s={};return $.each(t,function(e,t){var i=t.getPropSection(n);i&&(s[i.key]=i)}),s},this.getDesignSections=function(){var n={};return $.each(c,function(e,t){var i=t.getSection();i&&(n[i.key]=i)}),n},this.addStyle=function(e){a.push(e),l[e.selector]=e,this.styles_node.append(e.node),pinegrow.dispatchEvent("on_dm_style_added",null,e)},this.getCurrentStyle=function(){return u},this.setCurrentStyle=function(e,t){u=e,f(),this.stateManager.setState(d),pinegrow.dispatchEvent("on_dm_current_style_changed",null,e,t)},this.triggerCurrentStyleChanged=function(){this.setCurrentStyle(u)},this.getSkillItemKey=function(e,t,i){return e.key+"-"+(t||g)+"-"+(i||d)},this.getCurrentSize=function(){return g},this.setCurrentSize=function(e){g=e,this.setCurrentStyle(u)},this.getCurrentState=function(){return d},this.setCurrentState=function(e){d=e,u&&(u.current_state=e),this.setCurrentStyle(u)},this.findStyleByName=function(e){for(var t=0;t<a.length;t++)if(a[t].name==e)return a[t];return null},this.getStylesForPgel=function(e){var i=[];return e.getClasses().forEach(function(e){var t;e.startsWith(r.class_prefix)&&(t=l["."+e]||null)&&(t.idx=a.indexOf(t),i.push(t))}),i.sort(function(e,t){return e.idx-t.idx}),i},this.setSkillParam=function(e,t,i,n){var s=this.getCurrentStyle(),o=!0;s||(s=new PgDmStyle("bubi"+getRand(1,1e4)),this.addStyle(s),this.assignStyleToSelectedElements(s),pgDmStore.rememberSelectedStyleForSelectedElements(s),this.setCurrentStyle(s,!0),o=!1),"string"==typeof i&&(i=t.getControl(i)),s.setSkillParam(t,i,n),o&&pinegrow.dispatchEvent("on_dm_style_changed",null,s),this.update()},this.getSkillParam=function(e,t,i,n){var s=this.getCurrentStyle();return s?("string"==typeof i&&(i=t.getControl(i)),s.getSkillParam(t,i,n)):null},this.getStyles=function(){return a},this.setSASSEngine=function(e){e.onGetCSS=function(e){var t,i="";return"init"!=e&&"import"!=e||(t={css:""},pinegrow.dispatchEvent("on_dm_get_css",null,e,t),i+=t.css),"rules"==e&&(t={css:""},pinegrow.dispatchEvent("on_dm_get_css",null,e,t),i+=t.css,a.forEach(function(e){i+=e.getCSS()})),i}},this.update=function(t){m&&m.getEngine(function(e){e.update(t)})},function(t){pgDmStore.isDesignEnabled()&&m.getEngine(function(e){e.activateOnPage(t)})}),f=function(){d=(u?u.current_state:null)||"none"};this.destroy=function(){pinegrow.removeEventHandler("on_page_saved",s),pinegrow.removeEventHandler("on_page_loaded",p),pinegrow.removeEventHandler("on_project_loaded",i),pinegrow.removeEventHandler("on_project_closed",n),pinegrow.removeEventHandler("on_wp_get_theme_info",o)},$("body").one("pinegrow-ready",function(e,t){t.addEventHandler("on_page_saved",s),t.addEventHandler("on_page_loaded",p),t.addEventHandler("on_project_loaded",i),t.addEventHandler("on_project_closed",n),t.addEventHandler("on_wp_get_theme_info",o)})},PgDmStylePill=(window.pgDmStore=new PgDmStore,function(e){this.$element=$(`<div class="pg-dm-style-pill" data-id="${e.name}">${e.name}</div>`)});PgDmStylePill.prototype.setActive=function(e){e?this.$element.addClass("active"):this.$element.removeClass("active")};