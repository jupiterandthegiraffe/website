var PgDmView=function(){function n(e){var n,t,o=pgDmStore.getActiveDesignProvider(),i='<div class="pg-dm-design-thumb">',a={bck:"",colors:"",fonts:""},s=e.findOne('dmdesignskill[skill="background"]'),r=(s&&(t=s.getAttribute("color"),s=s.getAttribute("image_sm")||s.getAttribute("image"),t||s)&&(s&&!crsaIsRemoteUrl(s)&&(s=pinegrow.getCurrentProject().getAbsoluteUrl(s)),a.bck+=`<div class="pg-dm-design-thumb-bck" style="background-color:${t};background-image:url(${s});"></div>`),a.colors+=`<div class="pg-dm-design-thumb-colors">`,e.find("dmcolor").forEach(function(e){a.colors+=`<div style="background-color: ${e.getAttribute("color")}"></div>`}),a.colors+="</div>",e.findOne('dmdesignskill[skill="fonts"]'));return r&&(n=null,["headings","h1","h2","h3"].forEach(function(e){var t=r.getAttribute(e+`_family`);t&&!n&&(n=t)}),t=r.getAttribute(`text_family`),n&&(a.fonts+=`<h1 style="font-family: ${n}">Heading</h1>`),t)&&(a.fonts+=`<p style="font-family: ${t}">Text</p>`),o&&o.onGetDesignThumbHTML&&o.onGetDesignThumbHTML(e,a),i+(a.bck+a.colors+a.fonts)+"</div>"}function e(e,t,n){u.onGetCSS(t,n)}function t(e,t,n){swatches.setColor(t,n)}function o(e,t,n){if(n.source)switch(n.source){case"design_panel":b.updateActiveDesignInKeepList();break;case"undo":var o=pgDmStore.getActiveDesignNode();o&&(pgDmStore.setActiveDesign(o),pgDmStore.update()),pgDmStore.designPanel.updatePanelDisplay(),pgDmStore.designPanel.updateKeepList()}}function i(e){pgDmStore.isDesignEnabled()||b.show()}var a,c=$('<div class="pg-dm-view"></div>'),s=new PgUIView(c,"pgdm"),u=(s.tabIcon="icon-color",window.pgDmProject=new PgDmProject),v=(pgDmStore.unsplash=new PgUnsplashImageProvider,pgDmStore.designPanel=this,new PgPanelNotice),m=(v.$element.appendTo(c),new PgShowProperties(c)),h=[{sections:pgDmStore.getDesignSections()}],f=(m.onlySections=!1,m.forceDefinitions=h,m.showName=!1,m.view.get$Element().appendTo(c),pgCreate("<div></div>")),w=(new PgToggleButtonMaker,$('<div class="pg-dm-design-controls"></div>').appendTo(c)),D=w,b=(this.view=s,this),S=(u.colors,this.dmAddOns=[],{}),k=(this.updatePanelDisplay=function(){k()},function(){pgKeepScrollPosition(m.view.get$Element().find(".pg-grid"),function(){m.updateShow()})}),P=($('<div class="pg-dm-pallete"></div>').appendTo(D),null),y=(this.updateKeepList=function(){var e;P&&(P.empty(),pgDmStore.designs_node&&pgDmStore.designs_node.find("dmdesign").forEach(function(e){0;var t=$(`<li>${n(e)}</li>`).prependTo(P);t.data("design-node",e),e.hasAttribute("active")&&t.addClass("active")}),e=$(`<li class="add-new"><i class="icon icon-plus"></i></li>`).prependTo(P),addTooltip(e,"Add a new design"),addTooltip(P.find("li:not(.add-new)"),"Click to activate.<br>Right-click for options."),a.updateLayout())},this.updateActiveDesignInKeepList=function(){var e,t;pgDmStore.designs_node&&P&&(e=pgDmStore.designs_node.findOne("dmdesign[active]"))&&(t=P.find("li.active")).length&&t.html(n(e))},{}),A=(v.$element.on("click",".activate",function(e){e.preventDefault();var t=pgDmStore.getActiveDesignProvider();t&&(pgDmStore.load(!0),t.firstActivateInProject(function(){t.getEngine(function(t){var n=pinegrow.getAllPages().slice(0),o=function(){var e;n.length?(e=n.shift(),t.activateOnPage(e,o)):pgDmStore.update()};o()})}))}),null);this.show=function(){s.whenVisible(function(){if(pgDmStore.isDesignEnabled()){var e=pgDmStore.getActiveDesignProvider(),s=(e!==A&&(A=e,m.forgetFields()),v.show(),a&&pg$Show(a.$element,"flex"),pg$Show(m.view.get$Element(),"flex"),pg$Show(w),h[0].sections=pgDmStore.getDesignSections(),m.show(f,null,!0),D.empty(),$('<button class="pg-button">Surprise me!</button>').appendTo(D)),r=(addTooltip(s,"Create a surprise design. Use locks to prevent colors and other properties from being changed. Right-click for options."),0),d=null,o=!1,g=null,l=function(i){i=p;function t(){function e(){setTimeout(function(){d=0,gsap.killTweensOf(a),gsap.to(a,{backgroundImage:`none`,backgroundColor:"transparent",duration:.25}),s.removeClass("surprising"),i&&$.fn.crsapages("showOverlays",!0,"white",!0),r&&(g=setTimeout(function(){l()},1e3*r))},i?1e3:0)}var t,n,o=!1;i&&((t=pinegrow.getSelectedPage())?(t=t.activeView.get$Html().find("body").css("backgroundImage"))&&t.startsWith("url(")&&(t=t.replace(/url\(['"](.*)['"]\)/,"$1"),(n=new Image).onload=function(){e()},n.onerror=function(){e()},n.src=t,o=!0):e()),o||e()}var a=s.get(0);gsap.killTweensOf(a),gsap.set(a,{backgroundImage:`linear-gradient(to right bottom, rgba(255, 255, 255, 0.2) 25%, rgba(0, 0, 0, 0) 25%, rgba(0, 0, 0, 0) 50%, rgba(255, 255, 255, 0.2) 50%, rgba(255, 255, 255, 0.2) 75%, rgba(0, 0, 0, 0) 75%, rgba(0, 0, 0, 0))`,backgroundColor:"#33add6",backgroundSize:"50%",backgroundPosition:"0 0"}),gsap.to(a,{backgroundPosition:"100% 0",duration:2,repeat:-1,ease:"none"}),s.addClass("surprising"),i&&$.fn.crsapages("showOverlays",!1,"white",!0);pgIsDev()&&!1?setTimeout(function(){var e=pgDmStore.getActiveDesignNode().next();e&&pgDmStore.setActiveDesign(e),t()},500):setTimeout(function(){u.magic(S,null,function(){t(),k()})},i?250:0)},p=(s.on("click",function(e){e.preventDefault(),g&&(clearTimeout(g),g=null);var t=(new Date).getTime();(0===d||5e3<t-d)&&(d=(new Date).getTime(),0<r&&o?(r=0,pinegrow.showMode("Auto surprise",!1),o=!1,s.html("Surprise me!")):l(p))}),"1"===pinegrow.getSetting("dm-animate-transitions","0")),t=(s.on("contextmenu",function(e){function t(){0<(r=this.data)?(pinegrow.showQuickMessage(`Auto surprise ON. Will surprise you every ${this.data} seconds.`),o=!0,l(p),s.html("Stop auto surprise")):pinegrow.showMode("Auto surprise",!1)}var n=[{label:"Off",data:0,action:t},{type:"divider"},{type:"header",label:"Surprise me every:"}];return[5,10,20,30,60].forEach(function(e){n.push({label:e+"s",data:e,action:t})}),new CrsaContextMenu([{label:"Animate transitions",check:p,action:function(){p=!p,pinegrow.showMode("Animate transitions",p),pinegrow.setSetting("dm-animate-transitions",p?"1":"0")}},{type:"divider"},{label:"Autoplay",submenu:n}],s).showForElement(s),!1}),$('<button class="pg-button pg-button-svg-icon" style="margin-left:4px;"><i class="icon icon-down" style="position: relative;top:2px;"></button>')),e=(t.appendTo(D),t.on("click",function(e){return e.preventDefault(),new CrsaContextMenu([{label:"Show floating tools",helptext:'Show floating paint tools that let you easily "paint" text color, background and other properties.',action:function(){pinegrow.floatingToolsManager.showAtMousePosition()}},{type:"divider"},{label:"Deactivate the Design panel...",action:function(){!isApp()&&pinegrow.getCurrentProject().loaded_revision_info?pinegrow.showAlert(`<p>The Design panel can not be deactivated on a project revision. Restore the revision first, or deactivate it on the current version of the project.</p>`,"This is a project revision"):pinegrow.showAlert(`<p>Do you want to deactivate the Design panel on this project and delete all its designs?</p><p>This action can not be undone. The project will be reloaded.</p><p>Note, the generated CSS stylesheet will remain in the project.</p>`,"Deactivate the Design panel","Cancel","Yes, deactivate &amp; delete designs",null,function(){try{var e,t=pinegrow.getCurrentProjectInfo(),n=(t.setSetting("active-design-provider",""),t.save(),pinegrow.getCurrentProject()),o=n.db;o.getProjectNode().find("dmdesigns,dmlocked").forEach(function(e){e.removeWithoutEvents()}),o.save(),isApp()?(e=n.getDir(),pinegrow.closeCurrentProject(!1,!1,function(){pinegrow.openProject(e)})):pinegrow.tutorialsManager.reopenProject()}catch(e){pinegrow.showAlert("Unable to deactivate the Design panel. "+e)}})},helptext:"Deactivate the Design panel for this project and delete all its designs."}],t).showForElement(t),!1}),addTooltip(t,"Design panel options..."),a&&a.destroy(),a=new PgUISectionGrid,c.append(a.$element.addClass("pg-dm-keep-list-uigrid")),new PgUISection("Saved designs",null,y));a.addSection(e),(P=$('<ul class="pg-dm-keep-list" style="color:white;"></ul>').appendTo(e.$content)).on("click","li",function(e){e.preventDefault();var t=$(this);t.hasClass("add-new")?(pgDmStore.addNewDesign(),b.updateKeepList()):(P.find("li.active").removeClass("active"),t.addClass("active"),pgDmStore.setActiveDesign(t.data("design-node")))}),P.on("contextmenu","li",function(e){e.preventDefault();var t,n=$(this);return n.hasClass("add-new")||(t=[{label:"Activate",check:n.hasClass("active"),action:function(){P.find("li.active").removeClass("active"),n.addClass("active"),pgDmStore.setActiveDesign(n.data("design-node"))}},{type:"divider"},{label:"Duplicate",action:function(){pgDmStore.addNewDesign(n.data("design-node")),b.updateKeepList()}},{label:"Delete",action:function(){pgDmStore.deleteDesign(n.data("design-node")),b.updateKeepList()}}],new CrsaContextMenu(t,n).showForElement(n)),!1}),b.updateKeepList()}else{var e="",n=pinegrow.getSelectedPage();if(pinegrow.getCurrentProject())if(n){var i=[];if(pinegrow.dispatchEvent("on_dm_detect_design_providers",n,i),0===i.length)e=`<p>Sorry, design panel is not supported in this project.</p><p>At the moment, design panel is supported for Bootstrap 4 &amp; 5, Tailwind CSS and Plain HTML projects. Make sure the appropriate framework is enabled on this page.</p>`;else{if(1<i.length&&(i=i.filter(function(e){return"plainhtml"!==e})),pgDmStore.activateDesignProvider(i[0]),pgDmStore.isDesignEnabled())return pgDmStore.setActiveDesign(pgDmStore.getActiveDesignNode()),void b.show();e=`<p>Activate the design panel to create a design theme for your project.</p>`,e+=`<p><button class="pg-button activate">Activate</button>`}}else e=`<p>Open a page, then activate the design panel.</p>`;else e=n&&n.isNew()?`<p>Design panel works with projects. Save the page and open it as a project.</p>`:`<p>Design panel works with projects. Open a project first.</p>`;pg$Hide(m.view.get$Element()),pg$Hide(w),v.show(e),a&&pg$Hide(a.$element)}})},s.onResize=function(){m&&m.updateLayout()},s.on("crsa-frameworks-changed",function(){b.show()});pinegrow.addEventHandler("on_dm_get_css",e),pinegrow.addEventHandler("on_dm_color_changed",t),pinegrow.addEventHandler("on_projectdb_changed",o),pinegrow.addEventHandler("on_page_loaded",i),pinegrow.addEventHandler("on_project_loaded",i),s.onDestroy=function(){pinegrow.removeEventHandler("on_dm_get_css",e),pinegrow.removeEventHandler("on_dm_color_changed",t),pinegrow.removeEventHandler("on_projectdb_changed",o),pinegrow.removeEventHandler("on_page_loaded",i),pinegrow.removeEventHandler("on_project_loaded",i)},this.show(u)},PgQuicDmView=function(){var e=new PgDmView,t=new PgQuickWindow("Magic",e,"quickDesignMagic",300,520);t.showFor$El($("body")),e.show(p),t.onDestroy=function(){}};