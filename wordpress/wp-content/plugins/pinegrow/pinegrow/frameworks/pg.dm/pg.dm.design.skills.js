var PgDmCSSCodeMaker=function(e){this.indents=["","    ","        "],this.data=e,this.css=""};PgDmCSSCodeMaker.prototype.getParam=function(e){return e in this.data?this.data[e]:null},PgDmCSSCodeMaker.prototype.p=function(e,t,o,a){return null!==(a=void 0===a?this.getParam(e):a)&&""!==a?t+`: ${a}${o?" !important":""};`:null},PgDmCSSCodeMaker.prototype.cssvar=function(e,t,o,a){return null!==(a=void 0===a?this.getParam(e):a)&&""!==a?t+`: var(--${a})${o?" !important":""};`:null},PgDmCSSCodeMaker.prototype.v=function(e,t,o){null!==(o=void 0===o?this.getParam(e):o)&&""!==o&&(this.css+=`$${t}: ${o};
`)},PgDmCSSCodeMaker.prototype.rule=function(e,t,o){void 0===o&&(o=1);for(var a="",r=0;r<t.length;r++)t[r]&&(a+=this.indents[o]+t[r]+"\n");a.length&&(this.css+=`
${e} {
${a}}`)};class PgDmDesignColor{constructor(e,t,o,a){this.name=e,this.value=t,this.shades=o,this.can_rename=a,this.locked=!1}setValue(e,t){t?this.shades[t]=e:this.value=e}getValue(e){return e?this.shades[e]:this.value}copyFromColor(e,t){var o;this.value=e.value,t?this.calculateShades():(this.shades={},o=this,e.forEachShade(function(e,t){o.shades[e]=t}))}isLocked(){return this.locked}setLocked(e){this.locked=e}clone(){return new PgDmDesignColor(this.name,this.value,cloneObject(this.shades))}hasShades(){return this.shades}forEachShade(e){if(this.shades)for(var t in this.shades)e(t,this.shades[t])}setShades(e,t,o){if(e)for(var a in this.shades={},e)this.shades[a]=e[a];else this.shades=null;t&&this.calculateShades(o)}setShadeKeys(e){if(e&&0!==e.length){this.shades={};for(var t=0;t<e.length;t++)this.shades[e[t]]=null;this.calculateShades()}else this.shades=null}calculateShades(e){if(this.shades){var t=Object.keys(this.shades),o=t.length;if(0!==o){var a=Math.floor(o/2),r=this.value,n=.15,s=.35;switch(o){case 2:case 3:s=n=.75;break;case 4:case 5:s=n=.5;break;case 6:case 7:n=.25}if(0<a)for(var i=chroma.bezier([chroma.mix("white",r,n),r]).scale().correctLightness().colors(a+1),l=0;l<a;l++)(!e||0<=e.indexOf(t[l]))&&(this.shades[t[l]]=i[l]),0;if((!e||0<=e.indexOf(t[a]))&&(this.shades[t[a]]=r),a<t.length-1)for(var c=chroma.bezier([r,chroma.mix("black",r,s)]).scale().correctLightness().colors(o-a),l=a+1;l<t.length;l++)(!e||0<=e.indexOf(t[l]))&&(this.shades[t[l]]=c[l-a]),0}}}calculateShades2(){if(this.shades){var e=Object.keys(this.shades),t=e.length;if(0!==t)for(var l=function(e,t,o){for(var a=[];e<t;)a.push(e),e+=o;return a},o=function(e,t){const o=chroma(e).lab();var a=100*(.95-1/t),r=a/(t-1),a=.5*(100-a),n=l(a,a+t*r,r);let s=0;if(1){s=9999;for(let e=0;e<t;e++){var i=o[0]-n[e];Math.abs(i)<Math.abs(s)&&(s=i)}}return n.map(e=>chroma.lab([e+s,o[1],o[2]]))},a=this.value,o=o(a,t),r=chroma.scale(o).correctLightness().colors(t),n=0,s=r.length-1;0<=s;s--)this.shades[e[n++]]=r[s]}}}var PgDmDesignColors=function(){this.can_edit=!1,this.mode="sass_var",this.default_shades=null;var s={},r=this;this.onReplaceWith=null,this.showContextMenu=function(o,e){var a,t=[];this.onReplaceWith&&(a=[],this.forEachColor(function(e,t){e!==o&&a.push({label:e,action:function(){r.onReplaceWith(o,e)}})}),t.push({label:"Replace this color with",submenu:a})),t.length&&new CrsaContextMenu(t,e).showForElement(e)},this.add=function(e,t,o,a,r){var n=new PgDmDesignColor(e,t,a,r);return s[e]=n,void 0!==o&&n.setLocked(o),n},this.deleteColor=function(e){delete s[e.name]},this.renameColor=function(e,t){for(var o=Object.keys(s),a={},r=o.indexOf(e.name),n=0;n<o.length;n++)r===n?a[t]=e:a[o[n]]=s[o[n]];r<0&&(a[t]=e),s=a,e.name=t},this.clear=function(){s={}},this.setColor=function(e,t,o){s[e].setValue(t,o)},this.getColor=function(e,t){return s[e].getValue(t)},this.getColorObject=function(e){return s[e]||null},this.getShades=function(e){return s[e].shades||null},this.copyFromColor=function(e,t,o){s[e].copyFromColor(t,o)},this.moveColorBeforeColor=function(e,t){var o=Object.keys(s),a=o.indexOf(e),r=o.indexOf(t),n=(0<=a&&0<=r&&a!==r&&(o.splice(a,1),a<r&&r--,o.splice(r,0,e)),{});o.forEach(function(e){n[e]=s[e]}),s=n},this.getColorKeyByIndex=function(e,t){var o=Object.keys(s);if(o.length>e)return o[e]},this.setColorByIndex=function(e,t){var o=Object.keys(s);o.length>e&&this.setColor(o[e],t)},this.getNumberOfColors=function(){return Object.keys(s).length},this.forEachColor=function(o){$.each(s,function(e,t){o(e,t.getValue(),t)})},this.isLocked=function(e){return s[e].isLocked()},this.setLocked=function(e,t){s[e].setLocked(t)},this.getNumberOfUnlockedColors=function(){var a=0;return this.forEachColor(function(e,t,o){o.isLocked()||a++}),a},this.setUnlockedColorByIndex=function(a,r){var n=0;this.forEachColor(function(e,t,o){o.isLocked()||(a===n&&s[e].setValue(r),n++)})},this.getUnlockedColorKeyByIndex=function(a){var r=0,n=null;return this.forEachColor(function(e,t,o){o.isLocked()||(a===r&&(n=e),r++)}),n},this.getColorsForPicker=function(n,o){return n=n||("sass_var"===this.mode?"$":""),o=o||[],this.forEachColor(function(a,e,t){var r=[];t.hasShades()?t.forEachShade(function(e,t){var o=n+a+"-"+e;r.push({key:o,name:o,color:t})}):r.push({key:n+a,name:a,color:e}),o.push(r)}),o},this.debug=function(){console.warn(s)}};class PgDmDesignSkillColors extends PgDmDesignSkill{constructor(e,t,o,a){super(e,"Colors"),this.colors=t,this.get_code=o,this.get_code_stage=a||"init",this.colors_control=null;var l=this;this.addControl("colors",{name:"Colors",type:"custom",dm_no_lock:!0,control:function(){var a=l.colors_control=new PgCustomPropertyControl("pg.dm.colors"),r=new PgDmColorSwatches(l.colors,l);return r.onColorChanged=function(e,t,o){o?pgDmStore.update():pgDmStore.db.makeChanges(null,"Set color",function(){l.controlSetValue(a.obj,t,{},null,"change",{subkey:e})}),r.debug()},r.onColorMoved=function(o,a){pgDmStore.db.makeChanges(null,"Move color "+o,function(){var e=l.getColorNode(o),t=l.getColorNode(a);e.insertBefore(t)}),pgDmStore.update()},r.onColorsReordered=function(e){pgDmStore.db.makeChanges(null,"copy"===e?"Copy color":"Swap colors",function(){l.colors.forEachColor(function(e,t){l.updateColorNode(e,t)})}),pgDmStore.update()},r.onColorDeleted=function(e){pgDmStore.db.makeChanges(null,"Delete color",function(){l.deleteColorNode(e.name)}),l.colors.deleteColor(e),pgDmStore.getActiveDesignProvider().onColorListChanged(),r.updateDisplay(!0),pgDmStore.update()},r.onColorRenamed=function(e,t,o){pgDmStore.db.makeChanges(null,"Rename color",function(){l.colors.renameColor(o,t),l.renameColorNode(e,t)}),pgDmStore.getActiveDesignProvider().onColorListChanged(),r.updateDisplay(!0),pgDmStore.update()},a.onDefine=function(){},a.onShow=function(){return r.$element},a.onSetValues=function(){r.updateDisplay(!0)},a.onHasData=function(){return!0},a}}),this.addControl(`button.from_image`,{name:"Get from the selected image",type:"button",add_class:"pg-dm-colors-buttons",dm_no_lock:!1,func:function(){function e(e){function t(){pinegrow.showQuickMessage(i),setTimeout(function(){e()},50)}n.onBeforeSurpriseMe?n.onBeforeSurpriseMe(t):t()}var t,o,a,r,n=pgDmStore.getActiveDesignProvider(),s="The selected element is not an image and it doesn't have a background image.",i="Getting colors from the image...";(r=pinegrow.selectedElements.getLastSelected())?"img"!=r.tagName?(t=r.get$DOMElement().css("background-image"))&&(o=t.match(/url\(["']?([^"'\)]+)["']?\)/))?(t=o[1],e(function(){l.getPaletteFromImage(t,function(){pgDmStore.update(),pgDmStore.designPanel.updatePanelDisplay()},"Get colors from image")})):pinegrow.showQuickError(s):(a=r.get$DOMElement())?e(function(){isApp()?l.setColorsFromImage(a.get(0),function(){pgDmStore.update(),pgDmStore.designPanel.updatePanelDisplay()},"Get colors from image"):l.getPaletteFromImage(a.get(0).src,function(){pgDmStore.update(),pgDmStore.designPanel.updatePanelDisplay()},"Get colors from image")}):pinegrow.showQuickError(s):pinegrow.showQuickError("Please select an element first.")}}),this.addControl("button.more",{type:"button",name:'<i class="icon icon-down" style="position: relative;top: 2px;"></i>',append_to:".pg-dm-colors-buttons",button_class:"pg-button-svg-icon",helptext:"<p>Select the strategy for picking colors and restore defaults.</p>",func:function(e,t,o,a,r){function n(){l.setParam("harmony",this.data);var e=pgDmStore.getDesignSkill("background"),t=e.getParam("image");t&&e.getColorsFromImage(t,function(){pgDmStore.update()})}var s=l.getParam("harmony"),s=[{label:"Strategy for getting colors from images",type:"header"},{label:"Get all colors from the image",data:"",action:n,check:!s},{label:"2 from image + 1 complimentary",data:"complimentary",action:n,check:"complimentary"===s},{label:"2 from image + 2 split",data:"split",action:n,check:"split"===s},{label:"2 from image + 2 triad",data:"triad",action:n,check:"triad"===s},{label:"2 from image + 2 similar",data:"analog",action:n,check:"analog"===s},{type:"divider"},{label:"Restore default colors",action:function(){l.restoreDefaultColors()}}];r.stopPropagation(),r.stopImmediatePropagation(),new CrsaContextMenu(s,t).showForElement(t)}})}restoreDefaultColors(){var a=this;this.populateDefaultParams(!0),pgDmStore.db.makeChanges(null,"Restore colors",function(){a.colors.forEachColor(function(e,t,o){a.updateColorNode(e,t),pgDmStore.setParamLocked(a,e,o.isLocked())})}),pgDmStore.update(),pgDmStore.designPanel.updatePanelDisplay()}updateColorNode(e,t,o){var a=this.node.findOne(`[key="${e}"]`),r=(a||(a=pgCreate(`<dmcolor key="${e}" />`)).appendTo(this.node),a.setAttr("color",t),this.colors.getColorObject(e));a.removeAttrIfStartsWithStringWithEvents("shade-"),r.forEachShade(function(e,t){a.setAttribute("shade-"+e,t)})}getColorNode(e){return this.node.findOne(`[key="${e}"]`)}deleteColorNode(e){var t=this.node.findOne(`[key="${e}"]`);t&&t.remove()}renameColorNode(e,t){var o=this.node.findOne(`[key="${e}"]`);o&&o.setAttribute("key",t)}onLoad(e){var s=this,t=e.find("dmcolor");s.colors.clear(),t.forEach(function(e){var t=e.getAttribute("key"),o=e.getAttribute("color"),a={},r=!1,n=(e.getAttrList().forEach(function(e){e.name.startsWith("shade-")&&(a[e.name.replace("shade-","")]=e.value,r=!0)}),s.colors.getColorObject(t));n?n.setValue(o):n=s.colors.add(t,o,!1,null,!0),n.shades=r?a:null})}onSetParam(e,t){"harmony"===e?this.node.setAttribute("harmony",t):this.updateColorNode(e,t)}onGetParam(e,t){return"harmony"===e?this.node.getAttribute("harmony"):t}setColorsFromImage(e,t,o){var a=this,r=new PgDmPalette([],e,a.colors.getNumberOfUnlockedColors());r.harmony=this.getParam("harmony"),this.setFromPalette(r,function(){a.colors_control&&a.colors_control.onSetValues(),t()},o)}setFromPalette(e,t,o){function a(e){e.forEach(function(e){var t=e.color.css(),o=r.colors.getUnlockedColorKeyByIndex(n);o&&(r.colors.setColor(o,t),r.colors.getColorObject(o).calculateShades(),r.updateColorNode(o,t)),n++}),t&&t()}var r=this,n=0;e.getColorsInfo(function(e){o?pgDmStore.db.makeChanges(null,o,function(){a(e)},"design_panel"):a(e)})}getPaletteFromImage(e,t,o,a){var r=this,n=new Image;n.onload=function(){var e=new PgDmPalette([],n);e.harmony=a,r.setFromPalette(e,t,o)},n.onerror=function(){t&&t()},isApp()||(n.crossOrigin="anonymous"),n.src=e}areAllColorsLocked(){return this.isLocked(`button.from_image`)}onSurpriseMe(e){var t;this.areAllColorsLocked||(t=pgDmStore.getDesignSkill("background"))&&!t.isLocked("image")||(t=pgDmStore.design.palettes.getRandomPalette(),this.setFromPalette(t)),e()}onGetCSS(e){return e===this.get_code_stage?this.get_code():""}populateDefaultParams(e){super.populateDefaultParams(),this.node.find("dmcolor").forEach(function(e){e.remove()});var a=this;this.colors.forEachColor(function(e,t,o){a.updateColorNode(e,t),pgDmStore.setParamLocked(a,e,o.isLocked())})}}class PgDmDesignSkillFonts extends PgDmDesignSkill{constructor(e,n,t){super(e?"headings":"fonts",e?"Finetune headings":"Typography");var s=this,i=(this.mode=t||"sass",this.get_code_stage="css"===t?"rules":"init",this.finetune=e,this.effects={shadow:{name:"Shadow",css:`text-shadow: 0.03em 0.05em 0.05em rgba(0, 0, 0, 0.3);`},shadow_hard:{name:"Hard shadow",css:`text-shadow: 0.08em 0.08em 0px rgba(0,0,0,0.2);`},shadow_distant:{name:"Distant shadow",css:`text-shadow: 0em 0.05em 0em rgba(0,0,0,0.2),0em 0.1em 0.1em rgba(0,0,0,0.15),0em 0.2em 0.03em rgba(0,0,0,0.1),0em 0.45em 0.34em rgba(0,0,0,0.1);`},shadow_heavy:{name:"Heavy shadow",css:`text-shadow: 0em 0.05em 0.04em rgba(0,0,0,0.25),0em 0.1em 0.14em rgba(0,0,0,0.1),0em 0.18em 0.23em rgba(0,0,0,0.1);`}},this.fonts=[{key:"text",name:"Regular text",usage:"text",toCSS:function(e){var t,o,a=new PgDmCSSCodeMaker(s.getFontParams("text")),r=[];return e===s.get_code_stage&&((t=s.getFontParam("text","family"))&&((o=pinegrow.fontLibrary.getFontByFamily(t))&&(t=o.getFamilyWithFallback()),"sass"===s.mode?(a.v("family","font-family-sans-serif",t),a.v("family","font-family-base",t)):r.push(a.p(null,"font-family",!1,t))),"sass"===s.mode?(a.v("weight","font-weight-base"),a.v("height","line-height-base"),a.v("color","body-color")):(r.push(a.p("weight","font-weight")),r.push(a.p("height","line-height")),r.push(a.cssvar("color","color"))),"css"===s.mode)&&a.rule("body",r),"rules"===e&&a.rule("p, li",s.addEffect("text",s.getCSSDetailsProps(a))),a.css},surpriseMe:function(e){var t=e.key,e=pinegrow.fontLibrary.getRandomFont("text");s.isLocked(t,"family")||s.setFontParam(t,"family",e.family),s.resetDetails("text")}},{key:"headings",name:"Headings",usage:"headings",toCSS:function(e){var t,o,a=new PgDmCSSCodeMaker(s.getFontParams("headings")),r=[];return e===s.get_code_stage&&((t=s.getFontParam("headings","family"))&&((o=pinegrow.fontLibrary.getFontByFamily(t))&&(t=o.getFamilyWithFallback()),"sass"===s.mode?a.v("family","headings-font-family",t):r.push(a.p(null,"font-family",!1,t))),"sass"===s.mode?(a.v("weight","headings-font-weight"),a.v("height","headings-line-height"),a.v("color","headings-color")):(r.push(a.p("weight","font-weight")),r.push(a.p("height","line-height")),r.push(a.cssvar("color","color")),r=r.concat(s.addEffect("headings",s.getCSSDetailsProps(a)))),"css"===s.mode)&&a.rule("h1, h2, h3, h4, h5, h6",r),"rules"===e&&"sass"===s.mode&&a.rule("h1, h2, h3, h4, h5, h6",s.addEffect("headings",s.getCSSDetailsProps(a))),a.css},surpriseMe:function(e){var t=e.key,e=pinegrow.fontLibrary.getRandomFont("headings");s.isLocked(t,"family")||s.setFontParam(t,"family",e.family),s.resetDetails("headings")}},{key:"lead",name:"Lead",usage:"text",toCSS:function(e){var t,o,a=new PgDmCSSCodeMaker(s.getFontParams("lead"));return e===s.get_code_stage&&a.v("weight","lead-font-weight"),"rules"===e&&((t=s.getFontParam("lead","family"))&&(o=pinegrow.fontLibrary.getFontByFamily(t))&&(t=o.getFamilyWithFallback()),a.rule(".lead",s.addEffect("lead",s.getCSSDetailsProps(a).concat([a.p("family","font-family",!1,t),a.p("height","line-height"),a.p("color","color")])))),a.css}},{key:"h1",name:"H1",usage:"h1",toCSS:function(e){return s.toCSSForHeadings(e,"h1")},surpriseMe:function(e){var t=e.key;s.isLocked(t,"family")||(Math.random()<.4?(e=pinegrow.fontLibrary.getRandomFont("h1"),s.setFontParam(t,"family",e.family),s.resetDetails("h1"),s.isLocked("h2","family")||(Math.random()<.5?s.setFontParam("h2","family",e.family):s.setFontParam("h2","family",""),s.resetDetails("h2"))):(s.setFontParam(t,"family",""),s.isLocked("h2","family")||s.setFontParam("h2","family",""),s.resetDetails("h1"),s.resetDetails("h2")))}},{key:"h2",name:"H2",usage:"h2",toCSS:function(e){return s.toCSSForHeadings(e,"h2")}},{key:"h3",name:"H3",usage:"headings",toCSS:function(e){return s.toCSSForHeadings(e,"h3")}},{key:"h4",name:"H4",usage:"headings",toCSS:function(e){return s.toCSSForHeadings(e,"h4")}},{key:"h5",name:"H5",usage:"headings",toCSS:function(e){return s.toCSSForHeadings(e,"h5")}}],this.fonts=this.fonts.filter(function(e){var t;return("css"!==s.mode||"lead"!==e.key)&&(t=2===e.key.length,s.finetune?t:!t)}),new PgToggleButtonMaker);this.fonts.forEach(function(e){var t,o,a,r;o=(t=e).key,a=t.name,s.addControl(o+`_name`,{name:"Name",type:"hidden",html:void 0,end_section:!0,aastart_repeat_item:a,aarepeat_item_open:!0,aaadd_repeat_item_label:"Add heading level"}),r={name:a,type:"select",show_empty:!0,fill_list_on_open:!0,can_add_items:!0,options:function(){return pinegrow.fontLibrary.getSelectOptions(t.usage)},dm_no_lock:!t.surpriseMe&&"placeholder"},t.label_before&&(r.start_repeat_item=t.label_before,r.repeat_item_open=!0,r.add_repeat_item_label="none"),s.addControl(o+`_family`,r),s.addControl(o+`_weight`,{name:"Weight",type:"select",start_section:a+" details",show_empty:!0,fill_list_on_open:!0,can_add_items:!0,options:function(){return pinegrow.fontLibrary.getSelectOptionsForWeight(s.getFontParam(o,"family"))},dm_no_lock:!t.surpriseMe&&"placeholder"}),s.addControl(o+`_color`,{name:"Color",type:"color",colors:function(){return n.colors.getColorsForPicker()},dm_no_lock:!t.surpriseMe&&"placeholder"}),s.addControl(o+`_spacing`,{name:"Spacing",type:"slider",slider_def_unit:"px",dm_no_lock:!t.surpriseMe&&"placeholder"}),"h1"!==o&&!1||s.addControl(o+`_effect`,{name:"Effect",type:"select",show_empty:!0,options:function(){var o=[];return $.each(s.effects,function(e,t){o.push({key:e,name:t.name})}),o},dm_no_lock:!t.surpriseMe&&"placeholder"}),s.addControl(`font_${o}_options_container`,{name:"Options",type:"displayhtmlwithlabel",html:"",class:`crsa-field-text-font-options-container crsa-field-text-font-options-container-`+o,dm_no_lock:!t.surpriseMe&&"placeholder"}),s.addControl(o+`_italic`,{name:"Italic",type:"select",toggle_buttons:!0,append_to:`.crsa-field-text-font-options-container-`+o,without_text:!0,show_empty:!0,dm_no_lock:!0,options:[{key:"italic",name:"Italic",html:i.makeIcon("style_italic",{attributes:{title:"Italic"}})}]}),s.addControl(o+`_smallcaps`,{name:"Small caps",type:"select",toggle_buttons:!0,append_to:`.crsa-field-text-font-options-container-`+o,without_text:!0,show_empty:!0,dm_no_lock:!0,options:[{key:"small-caps",name:"Small caps",html:i.makeText("Abc",{styles:{"font-family":"serif","font-size":"15px","font-variant":"small-caps"},attributes:{title:"Small caps"}})}]}),s.addControl(o+`_uppercase`,{name:"Uppercase",type:"select",toggle_buttons:!0,append_to:`.crsa-field-text-font-options-container-`+o,without_text:!0,show_empty:!0,dm_no_lock:!0,options:[{key:"uppercase",name:"Uppercase",html:i.makeIcon("Transform-uppercase",{attributes:{title:"Uppercase"}})}]})}),e||this.addControl(`manage`,{name:"Manage fonts...",type:"button",end_section:!0,func:function(){pinegrow.fontLibrary.showLibrary()}})}onSurpriseMe(e){for(var t=0;t<this.fonts.length;t++)this.fonts[t].surpriseMe&&this.fonts[t].surpriseMe(this.fonts[t]);e()}onGetCSS(e,t){var o=this,a="";switch(e){case"import":var r=pgDmStore.design.fonts;o.finetune||r.clear();for(var n=0;n<o.fonts.length;n++){var s=o.getFontParam(o.fonts[n].key,"family");s&&(s={key:o.fonts[n].key,family:s,weight:o.getFontParam(o.fonts[n].key,"weight"),italic:o.getFontParam(o.fonts[n].key,"italic")},r.setFont(s))}var i,l="";return o.finetune?(l+=(i=r.getImportStatements(t)).length?i.join("\n")+"\n\n":"")+((i=r.getFontFontFaceStatements()).length?i.join("\n\n")+"\n\n":""):"";case"init":case"rules":for(n=0;n<o.fonts.length;n++)a+=o.fonts[n].toCSS(e)}return a}getActiveFonts(e){for(var t=e||[],o=0;o<this.fonts.length;o++){var a=this.getFontParam(this.fonts[o].key,"family");a&&t.indexOf(a)<0&&t.push(a)}return t}getFontParam(e,t){return this.getParam(e+`_`+t)}isLocked(e,t){return super.isLocked(e+`_`+t)}setFontParam(e,t,o){return this.setParam(e+`_`+t,o)}getFontParams(e){var o={},a=e+`_`;return $.each(this.params,function(e,t){e.startsWith(a)&&(o[e.replace(a,"")]=t)}),o}addEffect(e,t){var o=this.getFontParam(e,"effect");return o&&this.effects[o]&&t.push(this.effects[o].css),t}getCSSDetailsProps(e){return[e.p("italic","font-style"),e.p("smallcaps","font-variant"),e.p("uppercase","text-transform"),e.p("spacing","letter-spacing")]}toCSSForHeadings(e,t){var o,a,r,n=new PgDmCSSCodeMaker(this.getFontParams(t));return"init"!==e&&"rules"===e&&(o=!0,(a=this.getFontParam(t,"family"))&&(r=pinegrow.fontLibrary.getFontByFamily(a))&&(a=r.getFamilyWithFallback()),r=[n.p("family","font-family",o,a),n.p("weight","font-weight",o),n.p("height","line-height",o),"sass"===this.mode?n.p("color","color",o):n.cssvar("color","color",o)],this.addEffect(t,r),n.rule(t,r.concat(this.getCSSDetailsProps(n)))),n.css}resetDetails(t){var o=this;["weight","color","spacing","effect","italic","smallcaps","uppercase"].forEach(function(e){o.isLocked(t,e)||o.setFontParam(t,e,"")})}}class PgDmDesignSkillBackground extends PgDmDesignSkill{constructor(e,t){super("background","Background"),this.colors_skill=e;var i=this;this.addControl("color",{name:"Color",type:"color",colors:function(){return e.colors.getColorsForPicker()}});this.addControl("image",{name:"Image",type:"image",live_update:!1,file_picker_use_project_as_parent:!0,file_picker_use_image_menu:!0,on_changed:function(e,t,o,a,r,n,s){"change"===s&&o&&i.getColorsFromImage(o,function(){pgDmStore.update(),pgDmStore.designPanel.updatePanelDisplay()})}}),this.addControl("image_for_colors",{name:"Only use the image for colors",type:"checkbox",value:"true",dm_no_lock:!0,start_section:"Image options",helptext:`<p>Check to let Surprise Me use the random image for getting colors without setting the image as the background of the page.</p>`}),this.addControl("selector",{name:"Selector",type:"text",default_value:"body",placeholder:"body",dm_no_lock:!0,live_update:!1,helptext:`<p>Selector for the HTML element to which to apply the background image. Default is <code>body</code>.</p><p>To set the src attribute of an image element on the current page, use the selector that starts with <code>img</code>, for example <code>img.poster</code>.</p><p>You can list multiple selectors, separated with commas.</p>
<p>Tailwind CSS: background images are also available as Background Image classes. If you do not want to display the image with a selector, enter <code>none</code> as a selector.</p>`,show_if:function(){return"true"!==i.getParam("image_for_colors")}}),this.addControl("advanced",{name:"Support fixed bck. on mobile &amp; filters",type:"checkbox",value:"true",negvalue:"false",default_value:"true",dm_no_lock:!0,helptext:`<p>Set the background image with the <code>:before</code> pseudo element, so that the fixed image on the body works in mobile Safari, and filters can be used. The <code>z-index</code> of the target element is set to <code>0</code> and if the target element is not Body, it must have position relative, absolute or fixed.</p><p>Note, these settings might cause conflicts with the existing CSS styling. If the conflicts can not be resolved, disable this option.</p>`,show_if:function(){return"true"!==i.getParam("image_for_colors")}}),this.addControl("source",{name:"Source",type:"select",default_value:"unsplash",options:function(){var e=[{key:"unsplash",name:"Free online images"}];return isApp()&&e.push({key:"folder",name:"Folder"}),e},dm_no_lock:!0,helptext:`<p>Select the source of the random image.</p>`}),this.addControl("keyword",{name:"Query",type:"text",placeholder:"wallpaper",dm_no_lock:!0,live_update:!1,show_if:function(){return"folder"!==i.getParam("source")},helptext:`<p>Search query for random online images, for example vivid or house. Default is wallpaper.</p>`}),this.addControl("folder",{name:"Folder",type:"text",file_picker:!0,file_picker_no_url:!0,file_picker_folder:!0,dm_no_lock:!0,live_update:!1,show_if:function(){return"folder"===i.getParam("source")},helptext:`<p>Select the local folder on your computer that contains the images.</p>`,on_changed:function(e,t,o,a,r,n,s,i,l){!o||pinegrow.getCurrentProject().isFileInProject(o)||pinegrow.showAlert(`<p>The selected folder is located outside of the project.</p><p>Selected images will show up when editing the project in Pinegrow, but will not work in the browser. To make the images show up, copy the selected images into a subfolder within the project and include them in the design from there.</p>`,"A note about external images",null,"Got it!")}}),this.addControl("image_sm",{name:"Small Image",type:"image",live_update:!1,file_picker_use_project_as_parent:!0,file_picker_use_image_menu:!0,dm_no_lock:!0,helptext:`<p>URL of the image to use on small screens (less than 768px). Use Settings to customize the media query.</p>`,show_if:function(){return"true"!==i.getParam("image_for_colors")}}),this.addControl("image_lg",{name:"Large Image",type:"image",live_update:!1,file_picker_use_project_as_parent:!0,file_picker_use_image_menu:!0,dm_no_lock:!0,helptext:`<p>URL of the image to use on large screens (larger than 1440px). Use Settings to customize the media query.</p>`,show_if:function(){return"true"!==i.getParam("image_for_colors")}}),this.default_mq_small="@media (max-width: 767px)",this.default_mq_large="@media (min-width: 1440px), (min-width: 992px) and (-webkit-min-device-pixel-ratio: 2), (min-width: 992px) and (min-resolution: 192dpi)",this.addControl("button.options",{type:"button",name:"Settings...",button_class:"pg-dm-bck-settings-button",func:function(){var t=pgDmStore.getActiveDesignProvider(),e=t.settings,e={"background.media_small":{name:"Small media query",type:"text",value:e["background.media_small"]||i.default_mq_small,placeholder:i.default_mq_small,helptext:`<p>Media query for displaying the small background image.</p>`},"background.media_large":{name:"Large media query",type:"text",value:e["background.media_large"]||i.default_mq_large,placeholder:i.default_mq_large,helptext:`<p>Media query for displaying the large background image. Default media query for the large size detects the retina screen and uses the large image if pixel size is 992px or larger.</p>`}};pinegrow.showQuickDialog("Background settings",`Media queries`,`<p>Set the media queries for displaying small and large background image.</p><p>Note, these settings are stored in the project settings and therefore apply to all designs in the project.</p>`,e,"Cancel","Save",null,function(e){t.setSettings(e)})}}),this.filters=[{filter:"blur",name:"Blur",min:0,max:20,unit:"px",start_section:"Filters",end_section:!0},{filter:"brightness",name:"Brightness",min:0,max:200,unit:"%",step:20,def:100},{filter:"contrast",name:"Contrast",min:0,max:200,unit:"%",step:20,def:100},{filter:"grayscale",name:"Grayscale",min:0,max:100,unit:"%",step:1,def:0},{filter:"hue-rotate",name:"Hue rotate",min:0,max:360,unit:"deg",step:1,def:0},{filter:"invert",name:"Invert",min:0,max:100,unit:"%",step:1,def:0},{filter:"opacity",name:"Opacity",min:0,max:100,unit:"%",step:1,def:100},{filter:"saturate",name:"Saturate",min:0,max:200,unit:"%",step:20,def:100},{filter:"sepia",name:"Sepia",min:0,max:100,unit:"%",step:1,def:0}],this.addControl("filter_notice",{type:"displayhtml",dm_no_lock:!0,start_section:"Filters",end_section:!0,name:'<p style="text-align: left;">Disable "Use image only for colors" checkbox and enable "Mobile &amp; filters" checkbox in Image options to use the filters.</p>',show_if:function(){return"true"!==i.getParam("advanced")||"true"===i.getParam("image_for_colors")}}),this.filters.forEach(function(e){i.addControl("filter_"+e.filter,{name:e.name,type:e.type||"range",range_min:e.min,range_max:e.max,range_step:e.step||1,slider_def_unit:e.unit||"",dm_no_lock:!0,default_value:e.def||0,helptext:`<p>Apply the filter ${e.filter} to the background image.</p>`,show_if:function(){return"true"===i.getParam("advanced")&&"true"!==i.getParam("image_for_colors")}})}),this.addControl("button.filter_defaults",{type:"button",name:"Reset defaults",button_class:"pg-dm-bck-settings-button",func:function(){pgDmStore.db.makeChanges(null,"Reset image filters",function(){i.filters.forEach(function(e){i.setParam("filter_"+e.filter,"def"in e?e.def:0)})},"design_panel"),pinegrow.showQuickMessage("Image filters were reset."),pgDmStore.update(),pgDmStore.designPanel.updatePanelDisplay()},show_if:function(){return"true"===i.getParam("advanced")&&"true"!==i.getParam("image_for_colors")}})}getSmallMediaQuery(){var e=pgDmStore.getActiveDesignProvider().settings["background.media_small"]||this.default_mq_small;return e=e.startsWith("@media")?e:"@media"+e}getLargeMediaQuery(){var e=pgDmStore.getActiveDesignProvider().settings["background.media_large"]||this.default_mq_large;return e=e.startsWith("@media")?e:"@media"+e}populateDefaultParams(){var t=this;this.setParam("image_for_colors","true"),this.setParam("advanced","true"),this.filters.forEach(function(e){t.setParam("filter_"+e.filter,e.def||0)})}getBackgroundImagesAsObject(){function e(e){var t;return!crsaIsRemoteUrl(e)&&(e=r.getAbsoluteUrl(e),r.isUrlInProject(e))&&(t=pgDmStore.getActiveDesignProvider().getStylesheetUrl())?crsaMakeLinkRelativeTo(e,t):e}var t=this.getParam("image"),o=this.getParam("image_sm"),a=this.getParam("image_lg"),r=pinegrow.getCurrentProject(),n={};return t&&(n["design-image"]=`url('${e(t)}')`,0<=t.indexOf("//images.unsplash.com"))&&(a=a||(a=t.replace(/\&h=[0-9]+/,"")).replace(/\&w=[0-9]+/,"&w=2000")),o&&(n["design-image-small"]=`url('${e(o)}')`),a&&(n["design-image-large"]=`url('${e(a)}')`),n}onSurpriseMe(o){var e,a=this,t=this.getParam("source")||"unsplash";this.isLocked("image")?o():("body"!="element"||pinegrow.selectedElements.getLastSelected()||(pinegrow.showQuickError(`Can't set background image because no element is selected.`),o()),e=this.getParam("keyword")||"wallpaper",this.getParam("image_for_colors"),"unsplash"===t?pgDmStore.unsplash.getRandomPhoto({query:e},function(e){var t=pgDmStore.unsplash.getImageUrl(e,"custom",{w:1200});a.setParam("image",t),a.getColorsFromImage(t,o)},function(){pinegrow.showQuickError("Unable to get a random photo!"),o&&o()}):(t=this.getParam("folder"))&&pgDmStore.localImages.getRandomImageFromFolder(t,function(e){e?(a.setParam("image",e),a.getColorsFromImage(e,o)):o&&o()}))}getColorsFromImage(e,t){var o,a=this;this.colors_skill.areAllColorsLocked()?t():((o=new Image).onload=function(){a.colors_skill.setColorsFromImage(o,function(){t()},null)},o.onerror=function(){t&&t()},isApp()||(o.crossOrigin="anonymous"),o.src=e)}onGetCSS(e,t){var h="";switch(e){case"init":!this.getParam("color")||this.onGetBackgroundColorCSS||(h+=this.setVar("body-bg",this.getParam("color")));break;case"rules":this.getParam("color")&&this.onGetBackgroundColorCSS&&(h=this.onGetBackgroundColorCSS(this.getParam("color")));var o=pinegrow.getCurrentProject(),g=function(e){var t;return!crsaIsRemoteUrl(e)&&(e=o.getAbsoluteUrl(e),o.isUrlInProject(e))&&(t=pgDmStore.getActiveDesignProvider().getStylesheetUrl())?crsaMakeLinkRelativeTo(e,t):e},a=this.getParam("selector")||"body",u="true"===this.getParam("advanced"),p=this;a.split(",").forEach(function(e){var t,o,a,r,n,s,i,l,c,m,d;e=e.trim(),c="body"===e,m="!important",d=[],p.filters.forEach(function(e){var t=p.getParam("filter_"+e.filter);t&&t!=e.def&&d.push(`${e.filter}(${t}${e.unit})`)}),p.getParam("image")&&!p.getParam("image_for_colors")&&(t=p.getParam("image"),a=!1,e.match(/^img($|[^a-z])/)&&(i="Image element mode: ",(l=pinegrow.getSelectedPage())?0===(n=l.sourceNode.find(e)).length?pinegrow.showQuickError(i+`No images with the selector ${e} were found.`):((s=new PgCollection).setList(n),o=l.makeRelativeUrl(t),a=!0,r=!1,s.forEachElement(function(e){e.getAttribute("src")!==o&&(r=!0)}),r&&(new PgApi).setAttribute(s,"src",o)):pinegrow.showQuickError(i+"Page is not open.")),u&&(n=e,a||(e+=":before"),c||a||(l=pinegrow.getSelectedPage())&&(s=l.get$Html()?.find(n))&&0!==s.length&&"static"===s.css("position")&&!s.is("body,html")&&pinegrow.showQuickError(`The background element <code>${n}</code> should have position set to <code>relative</code>, <code>absolute</code> or <code>fixed</code>.`),a||(h+=`
${n} {
    z-index: 0;
`,1||(h+=`    position: relative;
`),h+=`}
`)),a&&!d.length||(h+=`
${e} {`,a||(h+=`
    background-image: url(${g(t)})${m};
    background-size: cover;
    background-position: center center;
    background-repeat: no-repeat;
`,u?h=h+`    content: ' ';
    top:0;
    left:0;
    width:100%;
    height:100%;
    z-index:-1;
`+(c?`    position: fixed;
`:`    position: absolute;
`):c&&(h+=`    background-attachment: fixed;
`)),d.length&&(u||a)&&(h+=`    filter: ${d.join(" ")};
`),h+=`}
`),!a&&!c&&u&&!e.match(/^[a-z]/i)&&e.indexOf(",")<0&&(h+=`
body${e} {
position: fixed;
}                        
`),i=p.getParam("image_sm"),l=p.getParam("image_lg"),0<=t.indexOf("//images.unsplash.com")&&(l=l||(l=t.replace(/\&h=[0-9]+/,"")).replace(/\&w=[0-9]+/,"&w=2000")),a||(i&&(h+=`${p.getSmallMediaQuery()} {
    ${e} {                            
        background-image: url(${g(i)})${m};   
    }                             
}
`),l&&(h+=`${p.getLargeMediaQuery()} {
    ${e} {                        
        background-image: url(${g(l)})${m};         
    }                           
}
`)))}),(1||h)&&(h+=`body, html {
    min-height: 100vh;
}
`)}return h}}