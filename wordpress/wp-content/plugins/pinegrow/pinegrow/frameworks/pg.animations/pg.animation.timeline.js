var PgAnimationEditorTransformQuickView=function(e,t){var n=this,a=new PgAnimationEditorTransformView(t),o=new PgQuickWindow("Edit transition",a,"quickAnimationTransformEditor",300,400);this.win=a.win=o,e=e||$("body"),o.showFor$El(e,null,20,"top"),o.autoSize(),o.showFor$El(e,null,20,"top"),o.$element.removeClass("reposition-on-resize"),o.onChanged=function(e,t){n.onChanged&&n.onChanged(e,t)},o.onDestroy=function(){}},PgAnimationEditorTransformView=function(e){var a=this,t=(this.$element=$(`<div class="pg-ae-t-view"></div>`),new PgUIView(this.$element)),n=(this.view=t,(this.t=e).getDialog(function(e,t,n){t&&a.win.autoSize(),a.win.onChanged&&a.win.onChanged(e,n)}));this.$element.append(n),t.onResize=function(){},t.onDestroy=function(){e.destroyDialog(n),e.$t.removeClass("pg-ae-t-selected")}},PgAnimationEditorTimelineView=function(W){function L(){return E.getPgel()}function g(e,t,n){var a,o=Math.round(b*Math.max(0,e));null===D&&(D=v.width());var i=(o=o+r+A)-w,s=_<e;B.css({left:i}),t||E.seek(e),_=e,n&&0&&(a=null,s&&.9*D<i?a=Math.max(0,o-.1*D):!s&&i<.1*D&&(a=o-.9*D),null!==a)&&(a=Math.round(Math.max(0,Math.min(a,X-D))),4<Math.abs(a-w))&&v.scrollLeft(a)}function h(e,t){E&&(te[E.animation_id]=e),b=parseInt(e),t||u.setValue(b),ne(),ee()}function N(){var e;E&&(e=E.getDescription(),p.attr("title",e?e+" | Click to edit the description.":"Edit the description of the animation."),e?p.addClass("toggle-on"):p.removeClass("toggle-on"))}function Q(e,t){var n=e.addTransform(t);return n.is_dragged=!0,E.onChange(m,!0),m.showAnimation(E),n.is_dragged=!1,pgScrollToItemInContainer(n.$t,v,!1,!0,function(){setTimeout(function(){n.$t.removeClass("dragged")},10)}),n}var m=this,U=pinegrow.findFrameworkByKey("pg.ia"),e=((U.timelineView=this).$element=$(`<div class="pg-ae-timeline-visual"><div class="pg-ae-tv-scrubber-dummy"></div></div>`),$(`<div class="pg-ae-tv-toolbar"></div>`).appendTo(this.$element)),t=$(`<div class="pg-ae-tv-el-actors"><div class="pg-ae-tv-el-actors-list"></div><button class="pg-button add-element">Add timeline</button></div>`).appendTo(this.$element),O=t.find(".pg-ae-tv-el-actors-list"),f=$(`<div class="pg-ae-tv-el-groups"></div>`).appendTo(this.$element),R=$(`<canvas class="pg-ae-tv-bck"></canvas>`).appendTo(f),v=$(`<div class="pg-ae-tv-el-timelines"></div>`).appendTo(f),z=$(`<div class="pg-ae-tv-scrubber"></div>`).appendTo(f),B=$(`<div class="pg-ae-tv-cursor"><div class="head"></div></div>`).appendTo(f),n=$(`<div class="pg-ae-tv-snap"><span></span></div>`).appendTo(f),K=$(`<div class="pg-ae-tv-insert-cursor"><div class="head"><i class="icon icon-plus"></i></div></div>`).appendTo(f),q=$(`<div class="pg-ae-tv-empty"><div>No animation is selected. Use the <b>Interactions panel</b> to add animations to page elements and select animations for editing.<button class="pg-button">Go to the Interactions panel</button></div></div>`).appendTo(this.$element),a=(q.find("button").on("click",function(e){e.preventDefault(),pinegrow.showUIPanel("animations",!1,!1,!0)}),t.find(".add-element").on("click",function(e){e.preventDefault(),E.addElement({t:""}),E.onChange(m,!0),m.showAnimation(E)}),this.getAnimationId=function(){return E?E.animation_id:null},!1),Y=!1,w=(t.on("scroll",function(e){a||(a=!0,Y||(v.get(0).scrollTop=e.target.scrollTop),a=!1)}),v.on("scroll",function(e){var t;w!==e.target.scrollLeft&&(w=e.target.scrollLeft,t=new CrsaProfile,ee(),t.show("update bck"),t=Math.round(b*Math.max(0,_)),B.css({left:t+r-w})),J===e.target.scrollTop||a||(J=e.target.scrollTop,Y=!0,xe(),Y=!1)}),v.on("mousemove",function(e){var t,n;Se||(e.target.classList.contains("pg-ae-el-tl-track")?(t=y(e),n=E.getElements()[parseInt(e.target.getAttribute("data-idx"))],T(t,ie(e),n)):T(-1))}),v.on("mouseout",function(e){Se||T(-1)}),0),J=0,r=0,X=0,b=200,_=0,k=0,j=null,G=function(){pinegrow.isJavascriptEnabled()?E.seek(_,!0):(pinegrow.showQuickError("Javascript is disabled, animations can't run."),pgRevealElement($(".commands-toolbar .icon-JS")))},Z=function(){E.seek(_)},T=function(e,t,n){var a;0<=e&&(e=t?Ie(e,null,k<e):e,a=Math.round(b*Math.max(0,e))),e!==k&&(K.css({left:0<=e?a+r-w+A:-100}),k=e),j=n},o=-1,C=function(e){0<=e&&o<0?pg$Show(n):e<0&&0<=o&&pg$Hide(n);var t=Math.round(b*Math.max(0,e));n.css({left:t+r-w+A}),o=e},i=(pg$Hide(n),z.on("mousedown",function(e){var t=y(e);g(t),i._fDown(e)}),new PgDragHelper(B,".head",null,!1)),y=(i.on("dragStart",function(e,t,n){$.fn.crsapages("showOverlays")},this),i.on("drag",function(e,t,n){var a=y(n);g(a)},this),i.on("dragStop",function(e,t){$.fn.crsapages("showOverlays",!0)},this),function(e){var t=z.get(0).getBoundingClientRect();return Math.max(0,(e.pageX-t.left+w-A)/b)}),ee=function(){for(var e=R.get(0),t=window.devicePixelRatio,n=f.get(0).getBoundingClientRect(),a="light"===pinegrow.getWorkspaceTheme(),o=(w-A)/b,i=(w-A+n.width)/b,s=Math.floor(10*o)/10,i=(Math.ceil(10*i),(s-o)*b*t),r=.1*b*t,l=e.getContext("2d"),c=(l.canvas.width=n.width*t,l.canvas.height=n.height*t,l.clearRect(0,0,e.width,e.height),20*t),d=i,p=(l.beginPath(),l.lineWidth=.5,l.strokeStyle=a?"#777777":"#000000",parseInt(10*s)%10);d<e.width;)p%10!=0&&(l.moveTo(d,c),l.lineTo(d,e.height-1)),p++,d+=r;l.stroke();p=parseInt(10*s)%10,d=i;for(l.beginPath(),l.lineWidth=1,l.strokeStyle=a?"#444444":"#111111";d<e.width;)p%10==0&&(l.moveTo(d,c),l.lineTo(d,e.height-1)),p++,d+=r;l.stroke();var u,g,p=0,h=(d=i,parseInt(10*s)),m=1;for(l.font=12*t+`px Lato`,l.textBaseline="top",l.fillStyle=a?"#333333":"#9a9a9a";d<e.width;)h%10==0&&0<=h&&(g=l.measureText(u=``+h/10),l.fillText(u,d-g.width/2,2*t)),p++,d+=r,h+=m},te={},ne=function(){m.showAnimation(E)},ae=new PgUIView(this.$element,W),E=(this.view=ae,null),s=($(`<div class="pg-ae-t-name"></div>`).appendTo(e).on("click",function(e){e.preventDefault(),pinegrow.selectedElements.selectCollection(E.target_col)}),$(`<button class="pg-button"><i class="icon icon-play"></i></button>`).appendTo(e)),l=$(`<button class="pg-button"><i class="icon icon-pause"></i></button>`).appendTo(e),oe=(addTooltip(s.add(l),`Press ${pgShowKbd("SPACE")} key to play / pause.`),$(`<button class="pg-button pg-ae-ta-b-with-icon"><i class="icon icon-113"></i></button>`).appendTo(e)),c=(addTooltip(oe,"Select the element and show the Interactions panel."),oe.on("click",function(e){e.preventDefault(),pinegrow.selectedElements.selectCollection(E.target_col),E.target_col.scrollTo();var t=pinegrow.showUIPanel("animations",!1,!1);setTimeout(function(){t.combinedActionsView.assignedActionsView.highlightAction(E.action_def)},100)}),$(`<button class="pg-button snap pg-ae-ta-b-with-icon"><i class="icon icon-snap-timeline"></i></button>`).appendTo(e)),d=(addTooltip(c,`Toggle snapping. Use ${pgShowKbd("CMD")} while dragging.`),"1"===pinegrow.getSetting("ae-snap","1")),ie=(c.on("click",function(e){e.preventDefault();var t=!d;d=t,pinegrow.setSetting("ae-snap",t?"1":"0"),t?c.addClass("snap-on"):c.removeClass("snap-on"),pinegrow.showMode("Timeline snap",t)}),d&&c.addClass("snap-on"),function(e){return e&&crsaIsCmdPressed(e)||pinegrow.keyState.cmdCtrl?!d:d}),p=$(`<button class="pg-button toggle pg-ae-ta-b-with-icon"><i class="icon icon-274"></i></button>`).appendTo(e),oe=(addTooltip(p,"Edit the description of the animation.",{use_title_attr:!0}),p.on("click",function(e){e.preventDefault(),pinegrow.showQuickDialog("Describe the animation","What does this animation do?","",{description:{type:"text",textarea:!0,name:"Description",value:E.getDescription()}},"Cancel","OK",null,function(e){E.setDescription(e.description),E.onChange(m,!0),N()})}),N(),$(`<button class="pg-button add-element">Add element</button>`)),se=40,re=1e3,e=$(`<div class="pg-ae-tl-zoom"></div>`).appendTo(e),le=$(`<i class="icon icon-minus"></i>`).appendTo(e),u=new PgInputField("stagger",{type:"range",show_empty:!1,name:"Zoom",without_text:!0,range_min:se,range_max:re}),e=(u.appendTo(e),u.setValue(b),u.on("change input",function(e){var t=parseFloat(u.getValue()||0);h(t,!0)}),$(`<i class="icon icon-plus"></i>`).appendTo(e));le.on("click",function(e){e.preventDefault(),h(b/1.2)}),e.on("click",function(e){e.preventDefault(),h(1.2*b)}),s.on("click",function(e){e.preventDefault(),G()}),l.on("click",function(e){e.preventDefault(),Z()}),oe.on("click",function(e){e.preventDefault(),E.addElement({t:""}),E.onChange(m,!0),m.showAnimation(E)}),this.handlePaste=function(e,t,n){var a,o;E?"pgia.timeline"===e?(E.addElement(t),E.onChange(m,!0),m.showAnimation(E)):"pgia.transform"===e&&(a=n||j||E.getElements()[0],o=cloneObject(t),0<=k&&(o.p=k),Q(a,o)):pinegrow.showQuickError("Timeline editor is not active.")};new function(e,t){this.onChange=null;var v,w=this;e.on("mousedown",t,function(e){if(0===e.button){var n,t,a,o,i,s,r,l,c,d,p=(new Date).getTime(),u=(v=e.clientY,$(this)),g={val:u.html().replace("&nbsp;","")},h=u.parent(),m=h.get(0),f=u;if(!0)return n=m.getAttribute("data-prop")||"prop",t=m.getAttribute("data-slider-unit")||"",a=parseFloat(m.getAttribute("data-slider-step")||1),o=parseFloat(m.getAttribute("data-slider-min")||-9999999),i=parseFloat(m.getAttribute("data-slider-max")||9999999),s=1/a,m=g.val||"0"+t,r=parseFloat(m),l=t,c=r,isNaN(r)?r=0:0===(l=m.replace(r,"")).length&&0===m.length&&(l=t),(d=$('<div style="position:fixed;width:100%;height:100%;top:0;left:0;opacity:0;cursor:row-resize;z-index:999;">').appendTo(f.closest("body"))).get(0).addEventListener("mousemove",function(e){var t;return p=null,c=r+(v-e.clientY)/s*a,a<1&&(c=Math.floor(c*s)/s),i<(c=c<o?o:c)&&(c=i),Math.floor(c),u.text(c+l),w.onChange&&(t=h.text(),w.onChange(n,t=" "===t?"":t,u)),!1},!0),d.get(0).addEventListener("mouseup",function(e){var t;return d.remove(),null!==p&&(new Date).getTime()-p<1e3?u.trigger("click"):w.onChange&&(t=h.text(),w.onChange(n,t=" "!==t&&"&nbsp;"!==t?t:"",u,!0)),!1},!0),!1}})}(v,"span.value num").onChange=function(e,t,n,a){var o=n.closest(".pg-ae-timeline-visual-kf");M(o).setPropertyValue(e,t),E.onChange(m,a)},new function(e,t){this.onChange=null;var s=this;e.on("click",t,function(e){var t,n=$(this),a=n.closest("span.value"),o=n.html().replace("&nbsp;",""),i=a.attr("data-prop");return E&&(a=E.getPropDef(i))&&a.options&&(t=[{label:"Not set",check:!o,action:function(){n.html("&nbsp;"),s.onChange(i,"",n,!0)}},{type:"divider"}],a.options.forEach(function(e){t.push({label:e.name,action:function(){n.html(e.key||"&nbsp;"),s.onChange(i,e.key,n,!0)},check:e.key===o})}),new CrsaContextMenu(t,n).showForElement(n)),!1})}(v,"span.value selval").onChange=function(e,t,n,a){var o=n.closest(".pg-ae-timeline-visual-kf");M(o).setPropertyValue(e,t),E.onChange(m,a)};function x(e,t){e===_e&&!t||((_e=e)?(pg$Hide(s),pg$Show(l,"inline")):(pg$Hide(l),pg$Show(s,"inline")))}function ce(e){var t,n=e.$t;v.find(".pg-ae-t-selected").removeClass("pg-ae-t-selected"),S()===e?pgQuickWindowManager.getWindow("quickAnimationTransformEditor").close():(t=new PgAnimationEditorTransformQuickView(n,e),n.addClass("pg-ae-t-selected"),t.onChanged=function(e,t){t?m.showAnimation(E,!0):(Ee(e),e.$t.find(".middle").html(V(e)))})}function de(e){e.getTransforms().forEach(Ee)}new function(e,t){var l=this;this.onChange=null,this.onChangeDone=null,e.on("click",t,function(e){e.preventDefault();function n(e,t){var n=colorToString(e);s.text(n),o.css("background-color",n),l.onChange&&l.onChange(i,n,t)}var t,a=$(this),o=a,i=a.closest("color"),s=i.find("> span"),r=$("<input/>",{type:"hidden"}).appendTo(o);r.spectrum({showAlpha:!0,clickoutFiresChange:!0,showInitial:!0,showInput:!0,allowEmpty:!0,preferredFormat:"hex",appendTo:r.closest("body"),palette:[],beforeShow:function(e){return t=s.text(),!0},move:function(e){n(e)},show:function(e){},change:function(e){n(e)},hide:function(e){r.spectrum("destroy"),r.remove()}}),r.spectrum("set",t),new PgSpectrumHelper(r,{"mouse-moved":function(e){var t=e.spectrum("get");n(t)},"color-picked":function(e){var t=e.spectrum("get");n(t,!0),0}});return r.spectrum("show"),!1})}(v,"span.value color").onChange=function(e,t,n){var a=e.closest("span.value"),o=e.closest(".pg-ae-timeline-visual-kf");M(o).setPropertyValue(a.attr("data-prop"),t),E.onChange(m,n)},ae.onResize=function(){ne(),ee()},ae.onDestroy=function(){$e.destroy(),pinegrow.removeEventHandler("on_animation_selected",pe),pinegrow.removeEventHandler("on_page_shown_in_live_view",onPageViewShown),pinegrow.removeEventHandler("on_key_pressed",ge),pinegrow.removeEventHandler("on_page_changes_done",me),pinegrow.removeEventHandler("on_before_key_action",he),pinegrow.removeEventHandler("on_page_closed",fe),pinegrow.removeEventHandler("on_key_state_changed",ve),pinegrow.removeEventHandler("on_animation_item_deleted",ue)};var pe=function(e,t){var n=!(!t||E&&E.animation_id===t.animation_id);m.showAnimation(t,!1,n)},ue=(pinegrow.addEventHandler("on_animation_selected",pe),function(e,t){E&&E.animation_id===t&&m.showAnimation(null)}),ge=(pinegrow.addEventHandler("on_animation_item_deleted",ue),function(e,t,n){!E||" "!==n.key||n.input||n.edit||(n.done=!0,(_e?Z:G)())}),he=(pinegrow.addEventHandler("on_key_pressed",ge),function(e,t){var n;"DeleteElementWithKey"===t.action&&(n=S())&&(be(n),t.done=!0)}),me=(pinegrow.addEventHandler("on_before_key_action",he),function(e,t,n){!E||t.source&&t.source===E||(E.edited_pgel.isDeleted?(E.destroy(),m.showAnimation(null)):n&&n.contains(E.edited_pgel)&&E.getUpdatedAnimationData())}),fe=(pinegrow.addEventHandler("on_page_changes_done",me),function(e){E&&E.edited_pgel.isDeleted&&(E.destroy(),m.showAnimation(null))}),ve=(pinegrow.addEventHandler("on_page_closed",fe),function(){ie()?C(o):C(-1)}),we=(pinegrow.addEventHandler("on_key_state_changed",ve),function(e){var t;S()!==e&&e||(t=pgQuickWindowManager.getWindow("quickAnimationTransformEditor"))&&t.close()}),be=function(e){we(e),e.element.removeTransform(e),E.onChange(m,!0),ne()},_e=null,$e=(x(!1,!0),new PgDelayedTasks),M=(pinegrow.pgAnimationPhone.addListener(function(e,t){E&&e===E.animation_id&&(g(t,!0,!0),x(!0),$e.run("animationUpdate",function(){x(!1)},100))}),function(e){var t=e.closest(".pg-ae-el-tl"),t=parseInt(t.attr("data-idx")),n=parseInt(e.attr("data-idx"));return E.getElements()[t].getTransforms()[n]}),ke=40,Te=8,Ce=(ke-22)/2,A=10,ye=function(e,t){var n=8,a=0,o=1/b,i=t.start/o+A,s=(t.end-t.start)/o,r=e.getStagger(),l=0,r=(0<r&&(l=(e.element.number_of_targets-1)*r/o),i),o=s;return"set"===e.getType()&&s<30?(a+=4,e.getProperties().forEach(function(e){a+=pgMeasureTextWidth(e.prop_def.short+` `+e.getValue())+10}),r=i-n,o=s+2*n+a):0==s&&(r=i-n,o=8+2*n),{left:i,w:s,left_b:r,w_b:o,end:i+s,end_b:r+o,stagger_w:l,end_total:r+o+l}},Ee=function(e){var t=e.getTimelinePosition(),t=ye(e,t);e.rect={left:t.left,width:t.w_b,top:e.track_idx*ke+Ce},e.$t.css({left:e.rect.left,width:e.rect.width,top:e.rect.top}),e.$stagger.css({width:t.stagger_w}),t.w<t.w_b?e.$t.addClass("with-bumpers"):e.$t.removeClass("with-bumpers")},xe=function(){t.get(0).scrollTop=J},Me=[],P=[],D=null,S=this.getSelectedTransform=function(){var e=pgQuickWindowManager.getWindow("quickAnimationTransformEditor");return e?e.view.t:null},Ae=function(e){var t=(e=null===e?"":e).toString().replace(/[\-\+]?[0-9\.]+(px|\%|em|rem|pt|vw|vh)?/g,function(e,t,n){return`<num>${e}</num>`});return t=0===t.length?`<num></num>`:t},V=function(e){var n="";return"flip"===e.getType()?"Flip":(e.getProperties().forEach(function(e){var t=e.prop_def.field_def;switch(n+=`<div class="prop" title="${e.prop_def.name}">`,t.type){case"slider":n+=`<span class="prop-label">${e.prop_def.short}</span><span class="value" data-prop="${e.getProperty()}" data-slider-step="${t.slider_step}" data-slider-max="${t.slider_max}" data-slider-min="${t.slider_min}">${Ae(e.getValue())}</span>`;break;case"color":n+=`<span class="prop-label">${e.prop_def.short}</span><span class="value" data-prop="${e.getProperty()}"><color style="background-color:${e.getValue()};"></color></span>`;break;case"select":n+=`<span class="prop-label">${e.prop_def.short}</span><span class="value" data-prop="${e.getProperty()}"><selval>${e.getValue()||""}</selval></span>`;break;default:n+=`<span class="prop-label">${e.prop_def.short}</span><span class="value" data-prop="${e.getProperty()}">${escapeHtmlCode(e.getValue())}</span>`}n+="</div>"}),n)},H=(this.showAnimation=function(e,d,t){E&&E!==e&&(we(),E.destroy());var n=E,a=((E=e)!==n&&pinegrow.dispatchEvent("on_animation_replaced_in_timeline_editor",null,E,n),v.empty(),O.empty(),P=[],0),p=(Me=[],S()),u=0;if(E){if(N(),pg$Hide(q),U.setTimelineTitle(E.target_col.getName({short:!1})+` - `+E.description),E.getElements().forEach(function(s){var e=$(`<div class="pg-ae-el-tl ${s.getMute()?"muted":""}" data-idx="${a}">
    <div class="pg-ae-el-tl-tracks"></div>
</div>`),t=(v.append(e),$(`<div class="pg-ae-tv-el-actor" data-idx="${a}"><i class="icon icon-down options"></i></div>`).appendTo(O)),i=[],n=(P.push({$actor:t,element:s,$element:e,tracks:i}),a++,new PgInputField("target",{type:"selector",show_empty:!1,use_selector_extensions:!0,name:"Target",without_text:!0,placeholder:"this element",get_selector_base:L,selector_info:"Select one or more target elements:",selector_multiple:!0,selector_global:!0,selector_dom:!0,no_has_value:!0})),r=(n.appendTo(t),n.setValue(s.getTarget()||"this"),n.on("change input",function(){var e=n.getValue();s.setTarget(e),E.onChange(m,!0),m.showAnimation(E)}),t.find(".options").on("click",function(e){var t=[{label:"Mute",check:s.getMute(),action:function(){s.setMute(!s.getMute()),E.onChange(m,!0),m.showAnimation(E)}},{type:"divider"},{label:"Copy",action:function(){pinegrow.clipboard.copySpecial("pgia.timeline",s.toData()),pinegrow.showQuickMessage("Timeline was copied to clipboard.")}},{label:"Duplicate",action:function(){E.duplicateElement(s),E.onChange(m,!0),m.showAnimation(E)}},{label:"Move",submenu:[{label:"To the top",action:function(){E.moveElementToTop(s),E.onChange(m,!0),m.showAnimation(E)}},{label:"Up",action:function(){E.moveElementUp(s),E.onChange(m,!0),m.showAnimation(E)}},{label:"Down",action:function(){E.moveElementDown(s),E.onChange(m,!0),m.showAnimation(E)}},{label:"To the bottom",action:function(){E.moveElementToBottom(s),E.onChange(m,!0),m.showAnimation(E)}}]},{type:"divider"},{label:"Delete",action:function(){E.removeElement(s),E.onChange(m,!0),m.showAnimation(E)}}],n=$(this);return new CrsaContextMenu(t,n).showForElement(n),!1}),e.on("click",".pg-ae-timeline-visual-kf",function(e){e.preventDefault();var t,n,a=$(this).closest(".pg-ae-timeline-visual-kf"),o=M(a);if(e.target.closest("span.ease"))return t=$(e.target),n=E.getEaseMenu(function(){o.setEase(this.key),E.onChange(m,!0),a.find(".middle").html(V(o))}),new CrsaContextMenu(n,t).showForElement(t),!1;"COLOR"!==e.target.nodeName&&"SELVAL"!==e.target.nodeName&&ce(o)}),e.on("contextmenu",".pg-ae-timeline-visual-kf",function(e){var n=$(this).closest(".pg-ae-timeline-visual-kf"),a=M(n),t=[{label:"Add property",submenu:a.getAddPropertyMenu(function(){n.find(".middle").html(V(a)),Ee(a)},!0,function(e,t){S()!==e&&t.edit_in_dialog&&ce(e)})}];return a.getProperties().length&&t.push({label:"Remove property",submenu:a.getProperties().map(function(e){var t=e.getValue();return{label:null!==t?e.getName()+` = `+t:e.getName(),action:function(){a.removeProperty(e),n.find(".middle").html(V(a)),Ee(a)}}})}),t.push({label:"Ease",submenu:E.getEaseMenu(function(){a.setEase(this.key),E.onChange(m,!0),n.find(".middle").html(V(a))},{e:a.getEase()})}),(t=t.concat([{type:"divider"},{label:"Edit...",action:function(){ce(a)}},{type:"divider"},{label:"Mute",check:a.getMute(),action:function(){a.setMute(!a.getMute()),E.onChange(m,!0),a.getMute()?n.addClass("muted"):n.removeClass("muted"),we(a)}},{type:"divider"},{label:"Copy",action:function(){pinegrow.clipboard.copySpecial("pgia.transform",a.toData()),pinegrow.showQuickMessage("Tween was copied to clipboard.")}},{type:"divider"}])).push({label:"Delete",action:function(){be(a)}}),new CrsaContextMenu(t,n).showAt(e.pageX,e.pageY),!1}),e.on("click",".pg-ae-el-tl-track",function(e){var t;e.preventDefault(),$(e.target).hasClass("pg-ae-el-tl-track")&&(t=0<=k?k:y(e),t=Q(s,{p:t,d:.5}),ce(t))}),e.on("contextmenu",".pg-ae-el-tl-track",function(e){var t,n,a,o,i=$(e.target);if(i.hasClass("pg-ae-el-tl-track"))return t=0<=k?k:y(e),n=function(e){Q(s,{t:e,p:t,d:"set"===e?0:.5})},a=[{type:"header",label:"Insert"},{label:"Set",action:function(){n("set")}},{label:"Tween",action:function(){n("tween")}}],(o=pinegrow.clipboard.getCurrentItem())&&"pgia.transform"===o.type&&(a.push({type:"divider"}),a.push({label:"Paste here",action:function(){var e=k;k=t,m.handlePaste(o.type,o.data,s),k=e}})),new CrsaContextMenu(a,i).showAt(e.pageX,e.pageY),!1}),e.find(".pg-ae-el-tl-tracks")),o=function(e,t,n){if(e)for(var a=0;a<i.length;a++)if((!(0<=i[a].force_start)||i[a].force_start>n.end_total||i[a].force_end<n.left_b)&&i[a].last<=n.left_b)return i[a].last=n.end_total,e.track_idx=a,i[a];var o={$track:$(`<div class="pg-ae-el-tl-track"></div>`).appendTo(r),last:t?n.end_total:-9999,force_start:-9999,force_end:-9999};return i.push(o),Me.push(o.$track.get(0)),e&&(e.track_idx=i.length-1),o},l=0,c=null;Ve&&(c=function(e){for(var t,n=0;n<=e.track_idx;n++)t=o();var a=e.getTimelinePosition(),a=ye(e,a);return t.last=t.force_end=a.end_b,t.force_start=a.left_b,t}(Ve)),o(),s.number_of_targets=s.getNumberOfTargetElements()||1,s.getTransforms().forEach(function(e){var t=e.getTimelinePosition(),n=ye(e,t),t=(u<n.end_total&&(u=n.end_total),Ve===e?c:o(e,t,n)),n=V(e),a=$(`<div class="pg-ae-timeline-visual-kf ${e.is_dragged?"dragged":""} ${e===p?"pg-ae-t-selected":""} pg-ae-t-kf-${e.getType()} ${e.getMute()?"muted":""}" data-idx="${l++}" style=""><div class="left"></div><div class="arrow"></div><div class="middle">${n}</div><div class="right"></div><div class="stagger"></div></div>`);e.$t=a,e.$stagger=a.find(".stagger"),a.on("transitionend",function(e){a.removeClass("animate-position")}),d?e.rect&&(a.css({left:e.rect.left,top:e.rect.top,width:e.rect.width}),a.addClass("animate-position")):(a.removeClass("animate-position"),delete e.rect),t.$track.append(a)}),d?setTimeout(function(){de(s)},10):de(s)}),t){if(E.animation_id in te)return void h(te[E.animation_id]);var n=u/b,o=.8*v.width(),o=0<n?o/n:200;if(b<o||1)return void h(Math.min(Math.max(se,o),re))}Fe();var i=u+100;D=v.width(),X=i=i<D?D:i,Me.forEach(function(e){e.parentNode.parentNode.style.width=i+`px`});for(var s=0,r=0;r<P.length;r++){var l=P[r],c=l.tracks.length*ke+Te+(r===P.length-1?Te:0);l.$actor.css({height:c+"px"}),l.height=c,l.top=s,s+=c}xe()}else pg$Show(q,"flex"),U.setTimelineTitle(``);x(!1,!0),T(-100),C(-1),g(_,!0)},[]),Pe="",De=0,Se=!1,I=[],Ve=null,He=function(e){return Math.round(100*(e+1e-5))/100},Ie=function(e,t,n){var a=!0,o=I,i=20/b;if(d)for(var s=0;s<o.length;s++)if(n){if(Math.abs(e-o[s])<i&&e>=o[s]){e=o[s],C(e),a=!1;break}if(null!==t&&Math.abs(t-o[s])<i&&t>=o[s]){e-=t-o[s],C(o[s]),a=!1;break}}else{if(Math.abs(e-o[s])<i&&e<=o[s]){e=o[s],C(e),a=!1;break}if(null!==t&&Math.abs(t-o[s])<i&&t<=o[s]){e-=t-o[s],C(o[s]),a=!1;break}}return e=He(e),a&&C(-1),e},Fe=function(n){return I=[_],E.getElements().forEach(function(e){e.getTransforms().forEach(function(e){var t;e!==n&&(t=e.getTimelinePosition(),I.push(t.start),t.end!==t.start)&&I.push(t.end)})}),I},F=(T(-100),C(-1),g(0,!0),new PgDragHelper(v,".middle,.left,.right",null,!1));F.on("dragStart",function(e,t,n){$.fn.crsapages("showOverlays"),H=[];var a=F.dragTarget.closest(".pg-ae-timeline-visual-kf"),o=M(a);H.push({t:o,pos:o.getTimelinePosition()}),o.is_dragged=!0,a.addClass("dragged"),a.removeClass("animate-position"),Fe(o),Se=!0,Pe=F.dragTarget.hasClass("left")?"left":F.dragTarget.hasClass("right")?"right":"move",De=0},this),F.on("drag",function(e,t,n){var a=De<e,o=(De=e)/b,i=[],s=ie(n);H.forEach(function(e){switch(Pe){case"left":var t=Math.max(0,e.pos.start+o);t=s?Ie(t,null,a):t,e.t.moveTo(t,He(e.pos.end-t));break;case"right":var n=Math.max(e.pos.start,e.pos.end+o),n=s?Ie(n,null,a):n;e.t.moveTo(e.pos.start,He(n-e.pos.start));break;default:t=e.pos.start+o;t=s?Ie(t,e.pos.end+o,a):t,e.t.moveTo(t)}i.indexOf(e.t.element)<0&&i.push(e.t.element)}),i.forEach(function(e){de(e)})},this),F.on("dragStop",function(e,t){$.fn.crsapages("showOverlays",!0),Se=!1,C(-1),E.onChange(m,!0),E.onTransformListUpdated(),m.showAnimation(E,!0),H.forEach(function(e){e.t.is_dragged=!1}),setTimeout(function(){H.forEach(function(e){e.t.$t.removeClass("dragged")})},10),Ve=null},this)};